import { Hono } from 'hono'
import { cors } from 'hono/cors'
import { serveStatic } from 'hono/cloudflare-workers'
import type { Bindings, Artwork, ArtworkWithArtist, Artist, ApiResponse } from './types'
import { calculateArtworkValue } from './types'

const app = new Hono<{ Bindings: Bindings }>()

// CORS 설정
app.use('/api/*', cors())

// 정적 파일 서빙
app.use('/static/*', serveStatic({ root: './public' }))

// HTML 페이지 라우트 (Cloudflare Pages 호환)
app.get('/login.html', (c) => {
  return c.redirect('/login')
})

app.get('/signup.html', (c) => {
  return c.redirect('/signup')
})

app.get('/mint-nft.html', (c) => {
  return c.redirect('/mint')
})

app.get('/artist-dashboard.html', (c) => {
  return c.redirect('/artist-dashboard')
})

// ============================================
// 공통 레이아웃 함수 - 블랙 테마
// ============================================

function getLayout(content: string, title: string = '갤러리피아 - NFT Art Museum') {
  return `
<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Outfit', 'system-ui', 'sans-serif'],
            },
            colors: {
              primary: {
                50: '#f0f9ff',
                500: '#0ea5e9',
                600: '#0284c7',
                700: '#0369a1',
              },
              accent: {
                500: '#8b5cf6',
                600: '#7c3aed',
              }
            }
          }
        }
      }
    </script>
    <style>
      * {
        font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
      }
      
      body {
        background: #000000;
        color: #ffffff;
      }
      
      .gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      
      .gradient-gold {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      }
      
      .gradient-cyber {
        background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
      }
      
      .neon-border {
        border: 1px solid rgba(139, 92, 246, 0.3);
        box-shadow: 0 0 20px rgba(139, 92, 246, 0.1);
      }
      
      .neon-glow {
        box-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
      }
      
      .card-nft {
        background: linear-gradient(145deg, #1a1a1a 0%, #0a0a0a 100%);
        border: 1px solid rgba(255, 255, 255, 0.05);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .card-nft:hover {
        transform: translateY(-12px);
        border-color: rgba(139, 92, 246, 0.5);
        box-shadow: 0 25px 50px rgba(139, 92, 246, 0.2);
      }
      
      .img-nft {
        transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .card-nft:hover .img-nft {
        transform: scale(1.08);
      }
      
      .nav-link {
        position: relative;
        transition: color 0.3s ease;
      }
      
      .nav-link::after {
        content: '';
        position: absolute;
        bottom: -4px;
        left: 0;
        width: 0;
        height: 2px;
        background: linear-gradient(90deg, #8b5cf6, #06b6d4);
        transition: width 0.3s ease;
      }
      
      .nav-link:hover::after,
      .nav-link.active::after {
        width: 100%;
      }
      
      .btn-neon {
        background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
        box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
        transition: all 0.3s ease;
      }
      
      .btn-neon:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 30px rgba(139, 92, 246, 0.6);
      }
      
      .stat-card {
        background: linear-gradient(145deg, #1a1a1a 0%, #0f0f0f 100%);
        border: 1px solid rgba(139, 92, 246, 0.2);
        backdrop-filter: blur(10px);
      }
      
      .hero-gradient {
        background: radial-gradient(ellipse at top, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                    radial-gradient(ellipse at bottom, rgba(6, 182, 212, 0.15) 0%, transparent 50%);
      }
      
      @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-20px); }
      }
      
      .float {
        animation: float 6s ease-in-out infinite;
      }
      
      @keyframes glow {
        0%, 100% { opacity: 0.5; }
        50% { opacity: 1; }
      }
      
      .glow-pulse {
        animation: glow 2s ease-in-out infinite;
      }
      
      .text-gradient {
        background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .text-gold {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .bg-grid {
        background-image: 
          linear-gradient(rgba(139, 92, 246, 0.05) 1px, transparent 1px),
          linear-gradient(90deg, rgba(139, 92, 246, 0.05) 1px, transparent 1px);
        background-size: 50px 50px;
      }
      
      .category-badge {
        transition: all 0.3s ease;
        border: 1px solid rgba(139, 92, 246, 0.3);
      }
      
      .category-badge:hover,
      .category-badge.active {
        background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
        border-color: transparent;
        transform: scale(1.05);
      }
      
      .score-bar {
        background: linear-gradient(90deg, #8b5cf6, #06b6d4);
        box-shadow: 0 2px 10px rgba(139, 92, 246, 0.3);
      }
    </style>
</head>
<body class="antialiased bg-black text-white">
    <!-- 네비게이션 -->
    <nav class="fixed top-0 w-full z-50 bg-black bg-opacity-80 backdrop-blur-xl border-b border-white border-opacity-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center space-x-12">
                    <a href="/" class="flex items-center space-x-3 group">
                        <img src="/static/logo.png" alt="GALLERYPIA Logo" class="w-12 h-12 rounded-xl group-hover:scale-110 transition-transform duration-300 group-hover:rotate-6" />
                        <div>
                            <div class="text-xs text-gray-400 font-semibold tracking-wider uppercase">NFT Art Museum</div>
                            <div class="text-xl font-black text-gradient">GALLERYPIA</div>
                        </div>
                    </a>
                    <div class="hidden md:flex items-center space-x-1">
                        <a href="/gallery" class="nav-link px-4 py-2 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all duration-300 font-medium text-sm">
                            갤러리
                        </a>
                        <a href="/leaderboard" class="nav-link px-4 py-2 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all duration-300 font-medium text-sm">
                            랭킹
                        </a>
                        <a href="/mint" class="nav-link px-4 py-2 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all duration-300 font-medium text-sm">
                            민팅
                        </a>
                        <a href="/artists" class="nav-link px-4 py-2 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all duration-300 font-medium text-sm">
                            아티스트
                        </a>
                        <a href="/collections" class="nav-link px-4 py-2 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all duration-300 font-medium text-sm">
                            컬렉션
                        </a>
                        <a href="/nft-academy" class="nav-link px-4 py-2 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all duration-300 font-medium text-sm">
                            아카데미
                        </a>
                        <a href="/about" class="nav-link px-4 py-2 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all duration-300 font-medium text-sm">
                            소개
                        </a>
                    </div>
                </div>
                <div id="authNav" class="flex items-center space-x-4">
                    <a href="/search" class="hidden sm:flex items-center px-4 py-2 text-gray-400 hover:text-white rounded-xl hover:bg-white hover:bg-opacity-5 transition-all">
                        <i class="fas fa-search mr-2"></i>
                        <span class="text-sm font-medium">검색</span>
                    </a>
                    <a href="/mypage" class="flex items-center px-4 py-2 text-gray-400 hover:text-white rounded-xl hover:bg-white hover:bg-opacity-5 transition-all">
                        <i class="fas fa-user mr-2"></i>
                        <span class="text-sm font-medium">마이페이지</span>
                    </a>
                    <a href="/login" class="flex items-center px-4 py-2 text-gray-400 hover:text-white rounded-xl hover:bg-white hover:bg-opacity-5 transition-all">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        <span class="text-sm font-medium">로그인</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- 메인 컨텐츠 -->
    <div class="pt-20">
        ${content}
    </div>

    <!-- 푸터 -->
    <footer class="border-t border-white border-opacity-10 py-16 mt-32">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid md:grid-cols-4 gap-12">
                <div class="col-span-2">
                    <div class="flex items-center space-x-3 mb-6">
                        <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-cyan-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-cube text-white text-lg"></i>
                        </div>
                        <div>
                            <div class="text-xl font-bold text-gradient">GALLERYPIA</div>
                            <div class="text-xs text-gray-500">NFT Art Museum</div>
                        </div>
                    </div>
                    <p class="text-gray-400 mb-4 leading-relaxed text-sm">
                        미술품 가치산정 기반의 투명하고 신뢰할 수 있는 NFT 플랫폼
                    </p>
                    <div class="mb-6 p-4 bg-gradient-to-r from-purple-900/20 to-cyan-900/20 rounded-xl border border-purple-500/20">
                        <p class="text-gray-300 text-sm leading-relaxed">
                            <i class="fas fa-envelope text-purple-400 mr-2"></i>
                            <strong class="text-white">기술이전 문의:</strong><br/>
                            <span class="ml-6">서경대학교 남현우 교수</span><br/>
                            <a href="mailto:gallerypia@gmail.com" class="ml-6 text-cyan-400 hover:text-cyan-300 transition-colors">gallerypia@gmail.com</a>
                        </p>
                    </div>
                </div>
                <div>
                    <h4 class="font-bold mb-4 text-white">플랫폼</h4>
                    <ul class="space-y-3 text-gray-400 text-sm">
                        <li><a href="/gallery" class="hover:text-white transition-colors"><i class="fas fa-images mr-2 text-purple-400"></i>NFT 갤러리</a></li>
                        <li><a href="/artists" class="hover:text-white transition-colors"><i class="fas fa-palette mr-2 text-blue-400"></i>NFT 아티스트</a></li>
                        <li><a href="/leaderboard" class="hover:text-white transition-colors"><i class="fas fa-trophy mr-2 text-yellow-400"></i>NFT 랭킹시스템</a></li>
                        <li><a href="/collections" class="hover:text-white transition-colors"><i class="fas fa-layer-group mr-2 text-cyan-400"></i>NFT 컬렉션</a></li>
                        <li><a href="/search" class="hover:text-white transition-colors"><i class="fas fa-robot mr-2 text-pink-400"></i>NFT AI 추천 시스템</a></li>
                        <li><a href="/valuation-system" class="hover:text-white transition-colors"><i class="fas fa-chart-line mr-2 text-green-400"></i>NFT 미술품 가치산정 시스템</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold mb-4 text-white">지원</h4>
                    <ul class="space-y-3 text-gray-400 text-sm">
                        <li><a href="/support" class="hover:text-white transition-colors">지원</a></li>
                        <li><a href="/help" class="hover:text-white transition-colors">도움말</a></li>
                        <li><a href="/valuation-system" class="hover:text-white transition-colors">가치산정 시스템</a></li>
                        <li><a href="/contact" class="hover:text-white transition-colors">문의하기</a></li>
                        <li><a href="/privacy" class="hover:text-white transition-colors">개인정보보호</a></li>
                        <li><a href="/usage-guide" class="hover:text-white transition-colors">사이트 이용하기</a></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-white border-opacity-10 mt-12 pt-8 text-center text-gray-500 text-sm">
                <p>&copy; 2025 Imageroot All rights reserved. Powered by Hyunwoo Nam Professor.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <script>
      let web3;
      let currentAccount;
      
      // 메타마스크 연결
      async function connectMetaMask() {
        if (typeof window.ethereum !== 'undefined') {
          try {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            currentAccount = accounts[0];
            web3 = new Web3(window.ethereum);
            
            // UI 업데이트
            const walletText = document.getElementById('walletText');
            if (walletText) {
              walletText.textContent = currentAccount.substring(0, 6) + '...' + currentAccount.substring(38);
            }
            
            // 로컬 스토리지에 저장
            localStorage.setItem('walletAddress', currentAccount);
            
            console.log('Connected:', currentAccount);
            
            // 계정 변경 감지
            window.ethereum.on('accountsChanged', function (accounts) {
              currentAccount = accounts[0];
              if (walletText) {
                walletText.textContent = currentAccount ? currentAccount.substring(0, 6) + '...' + currentAccount.substring(38) : '지갑 연결';
              }
              if (currentAccount) {
                localStorage.setItem('walletAddress', currentAccount);
              } else {
                localStorage.removeItem('walletAddress');
              }
            });
            
            return currentAccount;
          } catch (error) {
            console.error('메타마스크 연결 실패:', error);
            alert('메타마스크 연결에 실패했습니다.');
          }
        } else {
          alert('메타마스크를 설치해주세요! https://metamask.io');
        }
      }
      
      // 페이지 로드 시 연결 상태 확인
      window.addEventListener('DOMContentLoaded', async function() {
        const savedAddress = localStorage.getItem('walletAddress');
        if (savedAddress && typeof window.ethereum !== 'undefined') {
          try {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts.length > 0) {
              currentAccount = accounts[0];
              web3 = new Web3(window.ethereum);
              const walletText = document.getElementById('walletText');
              if (walletText) {
                walletText.textContent = currentAccount.substring(0, 6) + '...' + currentAccount.substring(38);
              }
            }
          } catch (error) {
            console.error('계정 확인 실패:', error);
          }
        }
      });
    </script>
</body>
</html>
  `;
}

// ============================================
// 인증 API
// ============================================

// Helper: Generate session token
function generateSessionToken(): string {
  return crypto.randomUUID() + '-' + Date.now().toString(36)
}

// Helper: Verify session
async function verifyUserSession(db: any, token: string) {
  const result = await db.prepare(`
    SELECT us.*, u.* 
    FROM user_sessions us
    JOIN users u ON us.user_id = u.id
    WHERE us.session_token = ? AND us.expires_at > datetime('now')
  `).bind(token).first()
  
  return result
}

// Signup API
app.post('/api/auth/signup', async (c) => {
  const db = c.env.DB
  
  try {
    const { email, password_hash, username, full_name, role, phone, website, bio } = await c.req.json()
    
    // Validation
    if (!email || !password_hash || !username || !full_name) {
      return c.json({ success: false, error: '필수 정보를 모두 입력해주세요' }, 400)
    }
    
    // Check if email/username already exists
    const existing = await db.prepare(`
      SELECT id FROM users WHERE email = ? OR username = ?
    `).bind(email, username).first()
    
    if (existing) {
      return c.json({ success: false, error: '이미 사용 중인 이메일 또는 사용자명입니다' }, 400)
    }
    
    // Insert user
    const result = await db.prepare(`
      INSERT INTO users (email, password_hash, username, full_name, role, phone, website, bio, is_verified, is_active)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, 0, 1)
    `).bind(email, password_hash, username, full_name, role || 'buyer', phone || null, website || null, bio || null).run()
    
    const userId = result.meta.last_row_id
    
    // Add role to user_roles table
    await db.prepare(`
      INSERT INTO user_roles (user_id, role, is_active, granted_at)
      VALUES (?, ?, 1, datetime('now'))
    `).bind(userId, role || 'buyer').run()
    
    // If artist, create artist profile
    if (role === 'artist') {
      await db.prepare(`
        INSERT INTO artist_profiles (user_id, art_style, major_medium, created_at)
        VALUES (?, ?, ?, datetime('now'))
      `).bind(userId, '', '').run()
    }
    
    // If expert, create placeholder (they need to apply separately)
    if (role === 'expert') {
      // Expert role requires application and approval
      // Just mark in user table for now
    }
    
    // Log activity
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, details, created_at)
      VALUES (?, 'signup', 'user', ?, datetime('now'))
    `).bind(userId, JSON.stringify({ role, email })).run()
    
    return c.json({ 
      success: true, 
      message: '회원가입이 완료되었습니다',
      user_id: userId
    })
  } catch (error: any) {
    console.error('Signup error:', error)
    return c.json({ success: false, error: error.message || '회원가입 중 오류가 발생했습니다' }, 500)
  }
})

// Login API
app.post('/api/auth/login', async (c) => {
  const db = c.env.DB
  
  try {
    const { email, password_hash } = await c.req.json()
    
    if (!email || !password_hash) {
      return c.json({ success: false, error: '이메일과 비밀번호를 입력해주세요' }, 400)
    }
    
    // Find user
    const user = await db.prepare(`
      SELECT * FROM users WHERE email = ? AND password_hash = ? AND is_active = 1
    `).bind(email, password_hash).first()
    
    if (!user) {
      return c.json({ success: false, error: '이메일 또는 비밀번호가 올바르지 않습니다' }, 401)
    }
    
    // Generate session token
    const sessionToken = generateSessionToken()
    const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7 days
    
    // Create session
    await db.prepare(`
      INSERT INTO user_sessions (user_id, session_token, expires_at, created_at)
      VALUES (?, ?, ?, datetime('now'))
    `).bind(user.id, sessionToken, expiresAt.toISOString()).run()
    
    // Update last login
    await db.prepare(`
      UPDATE users SET last_login_at = datetime('now') WHERE id = ?
    `).bind(user.id).run()
    
    // Log activity
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, created_at)
      VALUES (?, 'login', 'user', datetime('now'))
    `).bind(user.id).run()
    
    return c.json({ 
      success: true, 
      message: '로그인 성공',
      session_token: sessionToken,
      user: {
        id: user.id,
        email: user.email,
        username: user.username,
        full_name: user.full_name,
        role: user.role,
        profile_image: user.profile_image,
        is_verified: user.is_verified
      }
    })
  } catch (error: any) {
    console.error('Login error:', error)
    return c.json({ success: false, error: '로그인 중 오류가 발생했습니다' }, 500)
  }
})

// Logout API
app.post('/api/auth/logout', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, error: '인증 토큰이 없습니다' }, 401)
  }
  
  try {
    // Delete session
    await db.prepare(`
      DELETE FROM user_sessions WHERE session_token = ?
    `).bind(token).run()
    
    return c.json({ success: true, message: '로그아웃되었습니다' })
  } catch (error: any) {
    return c.json({ success: false, error: '로그아웃 중 오류가 발생했습니다' }, 500)
  }
})

// Get current user info
app.get('/api/auth/me', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, error: '인증 토큰이 없습니다' }, 401)
  }
  
  try {
    const session = await verifyUserSession(db, token)
    
    if (!session) {
      return c.json({ success: false, error: '유효하지 않은 세션입니다' }, 401)
    }
    
    return c.json({ 
      success: true,
      user: {
        id: session.id,
        email: session.email,
        username: session.username,
        full_name: session.full_name,
        role: session.role,
        profile_image: session.profile_image,
        bio: session.bio,
        is_verified: session.is_verified
      }
    })
  } catch (error: any) {
    return c.json({ success: false, error: '사용자 정보 조회 중 오류가 발생했습니다' }, 500)
  }
})

// ============================================
// 전문가 신청 API
// ============================================

// Submit expert application
app.post('/api/expert/apply', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, error: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifyUserSession(db, token)
    if (!session) {
      return c.json({ success: false, error: '유효하지 않은 세션입니다' }, 401)
    }
    
    // Check if already applied
    const existing = await db.prepare(`
      SELECT id, application_status FROM expert_applications WHERE user_id = ?
    `).bind(session.id).first()
    
    if (existing) {
      if (existing.application_status === 'pending') {
        return c.json({ success: false, error: '이미 심사 중인 신청이 있습니다' }, 400)
      } else if (existing.application_status === 'approved') {
        return c.json({ success: false, error: '이미 전문가로 승인되었습니다' }, 400)
      }
    }
    
    const { expert_type, institution, position, years_experience, specialization, 
            resume_url, portfolio_url, motivation, expertise_description } = await c.req.json()
    
    // Validation
    if (!expert_type || !institution || !position || !years_experience || !specialization || !motivation || !expertise_description) {
      return c.json({ success: false, error: '필수 정보를 모두 입력해주세요' }, 400)
    }
    
    if (years_experience < 3) {
      return c.json({ success: false, error: '최소 3년 이상의 경력이 필요합니다' }, 400)
    }
    
    // Insert application
    await db.prepare(`
      INSERT INTO expert_applications (
        user_id, expert_type, institution, position, years_experience,
        specialization, resume_url, portfolio_url, motivation, expertise_description,
        application_status, submitted_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending', datetime('now'))
    `).bind(
      session.id, expert_type, institution, position, years_experience,
      specialization, resume_url, portfolio_url, motivation, expertise_description
    ).run()
    
    // Create notification for admins
    await db.prepare(`
      INSERT INTO notifications (user_id, type, title, message, is_read, created_at)
      SELECT id, 'expert_application', '새로운 전문가 신청', ?, 0, datetime('now')
      FROM admin_users WHERE role = 'super_admin'
    `).bind(`${session.full_name}님이 전문가로 신청했습니다 (${expert_type})`).run()
    
    // Log activity
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, details, created_at)
      VALUES (?, 'expert_application', 'application', ?, datetime('now'))
    `).bind(session.id, JSON.stringify({ expert_type, institution })).run()
    
    return c.json({ 
      success: true, 
      message: '전문가 신청이 완료되었습니다. 심사 결과는 이메일로 안내드립니다.'
    })
  } catch (error: any) {
    console.error('Expert application error:', error)
    return c.json({ success: false, error: '신청 중 오류가 발생했습니다' }, 500)
  }
})

// Get expert application status
app.get('/api/expert/application-status', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, error: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifyUserSession(db, token)
    if (!session) {
      return c.json({ success: false, error: '유효하지 않은 세션입니다' }, 401)
    }
    
    const application = await db.prepare(`
      SELECT * FROM expert_applications WHERE user_id = ? ORDER BY submitted_at DESC LIMIT 1
    `).bind(session.id).first()
    
    return c.json({ 
      success: true,
      application: application || null
    })
  } catch (error: any) {
    return c.json({ success: false, error: '조회 중 오류가 발생했습니다' }, 500)
  }
})

// ============================================
// OpenSea API 연동
// ============================================

// Import NFT from OpenSea by contract address and token ID
app.post('/api/opensea/import-nft', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, error: '로그인이 필요합니다' }, 401)
  }
  
  try {
    // Verify admin session
    const adminSession = await verifySession(db, token)
    if (!adminSession || adminSession.role !== 'super_admin') {
      return c.json({ success: false, error: '관리자 권한이 필요합니다' }, 403)
    }
    
    const { contract_address, token_id } = await c.req.json()
    
    if (!contract_address || !token_id) {
      return c.json({ success: false, error: 'Contract address와 Token ID가 필요합니다' }, 400)
    }
    
    // Check if already imported
    const existing = await db.prepare(`
      SELECT artwork_id FROM opensea_artwork_mapping 
      WHERE contract_address = ? AND token_id = ?
    `).bind(contract_address, token_id).first()
    
    if (existing) {
      return c.json({ success: false, error: '이미 등록된 NFT입니다' }, 400)
    }
    
    // Get OpenSea API key from settings
    const apiKeySetting = await db.prepare(`
      SELECT setting_value FROM system_settings WHERE setting_key = 'opensea_api_key'
    `).first()
    
    const openSeaApiKey = apiKeySetting?.setting_value
    
    if (!openSeaApiKey) {
      return c.json({ success: false, error: 'OpenSea API 키가 설정되지 않았습니다' }, 400)
    }
    
    // Fetch NFT data from OpenSea API
    const openSeaUrl = `https://api.opensea.io/api/v2/chain/ethereum/contract/${contract_address}/nfts/${token_id}`
    
    const openSeaResponse = await fetch(openSeaUrl, {
      headers: {
        'X-API-KEY': openSeaApiKey,
        'Accept': 'application/json'
      }
    })
    
    if (!openSeaResponse.ok) {
      return c.json({ success: false, error: 'OpenSea API 요청 실패: ' + openSeaResponse.statusText }, 500)
    }
    
    const nftData = await openSeaResponse.json()
    const nft = nftData.nft
    
    if (!nft) {
      return c.json({ success: false, error: 'NFT를 찾을 수 없습니다' }, 404)
    }
    
    // Find or create artist
    const artistName = nft.creator || nft.collection?.name || 'Unknown Artist'
    let artistId: any
    
    const existingArtist = await db.prepare(`
      SELECT id FROM artists WHERE name = ?
    `).bind(artistName).first()
    
    if (existingArtist) {
      artistId = existingArtist.id
    } else {
      const artistResult = await db.prepare(`
        INSERT INTO artists (name, bio, profile_image, created_at)
        VALUES (?, ?, ?, datetime('now'))
      `).bind(
        artistName,
        nft.collection?.description || '',
        nft.collection?.image_url || nft.image_url || ''
      ).run()
      
      artistId = artistResult.meta.last_row_id
    }
    
    // Insert artwork
    const artworkResult = await db.prepare(`
      INSERT INTO artworks (
        title, description, artist_id, category, image_url, 
        estimated_value, is_minted, minting_status, blockchain_hash,
        created_at
      ) VALUES (?, ?, ?, ?, ?, ?, 1, 'minted', ?, datetime('now'))
    `).bind(
      nft.name || `Token #${token_id}`,
      nft.description || '',
      artistId,
      'Digital Art',
      nft.image_url || nft.display_image_url || '',
      0, // Will be calculated later
      contract_address
    ).run()
    
    const artworkId = artworkResult.meta.last_row_id
    
    // Create OpenSea mapping
    await db.prepare(`
      INSERT INTO opensea_artwork_mapping (
        artwork_id, contract_address, token_id, collection_slug,
        opensea_url, opensea_metadata, last_synced_at
      ) VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
    `).bind(
      artworkId,
      contract_address,
      token_id,
      nft.collection?.slug || '',
      `https://opensea.io/assets/ethereum/${contract_address}/${token_id}`,
      JSON.stringify(nft)
    ).run()
    
    // Log activity
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, entity_id, details, created_at)
      VALUES (?, 'opensea_import', 'artwork', ?, ?, datetime('now'))
    `).bind(
      adminSession.user_id,
      artworkId,
      JSON.stringify({ contract_address, token_id, name: nft.name })
    ).run()
    
    return c.json({ 
      success: true, 
      message: 'NFT가 성공적으로 등록되었습니다',
      artwork_id: artworkId,
      nft_data: {
        name: nft.name,
        image_url: nft.image_url,
        opensea_url: `https://opensea.io/assets/ethereum/${contract_address}/${token_id}`
      }
    })
  } catch (error: any) {
    console.error('OpenSea import error:', error)
    return c.json({ success: false, error: error.message || 'NFT 등록 중 오류가 발생했습니다' }, 500)
  }
})

// Import multiple NFTs from OpenSea collection
app.post('/api/opensea/import-collection', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, error: '로그인이 필요합니다' }, 401)
  }
  
  try {
    // Verify admin session
    const adminSession = await verifySession(db, token)
    if (!adminSession || adminSession.role !== 'super_admin') {
      return c.json({ success: false, error: '관리자 권한이 필요합니다' }, 403)
    }
    
    const { collection_slug, limit = 10 } = await c.req.json()
    
    if (!collection_slug) {
      return c.json({ success: false, error: 'Collection slug가 필요합니다' }, 400)
    }
    
    // Get OpenSea API key
    const apiKeySetting = await db.prepare(`
      SELECT setting_value FROM system_settings WHERE setting_key = 'opensea_api_key'
    `).first()
    
    const openSeaApiKey = apiKeySetting?.setting_value
    
    if (!openSeaApiKey) {
      return c.json({ success: false, error: 'OpenSea API 키가 설정되지 않았습니다' }, 400)
    }
    
    // Create sync job
    const jobResult = await db.prepare(`
      INSERT INTO opensea_sync_jobs (
        job_type, collection_slug, status, total_items, created_at
      ) VALUES ('collection_import', ?, 'running', ?, datetime('now'))
    `).bind(collection_slug, limit).run()
    
    const jobId = jobResult.meta.last_row_id
    
    // Fetch collection NFTs from OpenSea
    const openSeaUrl = `https://api.opensea.io/api/v2/collection/${collection_slug}/nfts?limit=${limit}`
    
    const openSeaResponse = await fetch(openSeaUrl, {
      headers: {
        'X-API-KEY': openSeaApiKey,
        'Accept': 'application/json'
      }
    })
    
    if (!openSeaResponse.ok) {
      await db.prepare(`
        UPDATE opensea_sync_jobs 
        SET status = 'failed', error_log = ?, completed_at = datetime('now')
        WHERE id = ?
      `).bind('OpenSea API 요청 실패: ' + openSeaResponse.statusText, jobId).run()
      
      return c.json({ success: false, error: 'OpenSea API 요청 실패' }, 500)
    }
    
    const collectionData = await openSeaResponse.json()
    const nfts = collectionData.nfts || []
    
    let imported = 0
    let failed = 0
    const importedIds: number[] = []
    
    for (const nft of nfts) {
      try {
        // Check if already imported
        const existing = await db.prepare(`
          SELECT artwork_id FROM opensea_artwork_mapping 
          WHERE contract_address = ? AND token_id = ?
        `).bind(nft.contract, nft.identifier).first()
        
        if (existing) {
          failed++
          continue
        }
        
        // Find or create artist
        const artistName = nft.creator || collection_slug
        let artistId: any
        
        const existingArtist = await db.prepare(`
          SELECT id FROM artists WHERE name = ?
        `).bind(artistName).first()
        
        if (existingArtist) {
          artistId = existingArtist.id
        } else {
          const artistResult = await db.prepare(`
            INSERT INTO artists (name, bio, profile_image, created_at)
            VALUES (?, ?, ?, datetime('now'))
          `).bind(artistName, collectionData.collection?.description || '', nft.image_url || '').run()
          
          artistId = artistResult.meta.last_row_id
        }
        
        // Insert artwork
        const artworkResult = await db.prepare(`
          INSERT INTO artworks (
            title, description, artist_id, category, image_url, 
            estimated_value, is_minted, minting_status, blockchain_hash,
            created_at
          ) VALUES (?, ?, ?, ?, ?, ?, 1, 'minted', ?, datetime('now'))
        `).bind(
          nft.name || `Token #${nft.identifier}`,
          nft.description || '',
          artistId,
          'Digital Art',
          nft.image_url || nft.display_image_url || '',
          0,
          nft.contract
        ).run()
        
        const artworkId = artworkResult.meta.last_row_id
        
        // Create OpenSea mapping
        await db.prepare(`
          INSERT INTO opensea_artwork_mapping (
            artwork_id, contract_address, token_id, collection_slug,
            opensea_url, opensea_metadata, last_synced_at
          ) VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
        `).bind(
          artworkId,
          nft.contract,
          nft.identifier,
          collection_slug,
          `https://opensea.io/assets/ethereum/${nft.contract}/${nft.identifier}`,
          JSON.stringify(nft)
        ).run()
        
        imported++
        importedIds.push(artworkId)
      } catch (err) {
        console.error('Failed to import NFT:', err)
        failed++
      }
    }
    
    // Update job status
    await db.prepare(`
      UPDATE opensea_sync_jobs 
      SET status = 'completed', processed_items = ?, failed_items = ?,
          imported_artworks = ?, completed_at = datetime('now')
      WHERE id = ?
    `).bind(imported, failed, JSON.stringify(importedIds), jobId).run()
    
    return c.json({ 
      success: true, 
      message: `${imported}개의 NFT가 성공적으로 등록되었습니다`,
      job_id: jobId,
      stats: {
        imported,
        failed,
        total: nfts.length
      }
    })
  } catch (error: any) {
    console.error('OpenSea collection import error:', error)
    return c.json({ success: false, error: error.message || '컬렉션 등록 중 오류가 발생했습니다' }, 500)
  }
})

// Get OpenSea sync job status
app.get('/api/opensea/job/:jobId', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const jobId = c.req.param('jobId')
  
  if (!token) {
    return c.json({ success: false, error: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const adminSession = await verifySession(db, token)
    if (!adminSession) {
      return c.json({ success: false, error: '유효하지 않은 세션입니다' }, 401)
    }
    
    const job = await db.prepare(`
      SELECT * FROM opensea_sync_jobs WHERE id = ?
    `).bind(jobId).first()
    
    if (!job) {
      return c.json({ success: false, error: '작업을 찾을 수 없습니다' }, 404)
    }
    
    return c.json({ success: true, job })
  } catch (error: any) {
    return c.json({ success: false, error: '조회 중 오류가 발생했습니다' }, 500)
  }
})

// Set OpenSea API key (admin only)
app.post('/api/opensea/set-api-key', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, error: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const adminSession = await verifySession(db, token)
    if (!adminSession || adminSession.role !== 'super_admin') {
      return c.json({ success: false, error: '관리자 권한이 필요합니다' }, 403)
    }
    
    const { api_key } = await c.req.json()
    
    if (!api_key) {
      return c.json({ success: false, error: 'API 키를 입력해주세요' }, 400)
    }
    
    // Update or insert API key
    await db.prepare(`
      INSERT INTO system_settings (setting_key, setting_value, is_sensitive, updated_at, updated_by)
      VALUES ('opensea_api_key', ?, 1, datetime('now'), ?)
      ON CONFLICT(setting_key) DO UPDATE SET 
        setting_value = excluded.setting_value,
        updated_at = datetime('now'),
        updated_by = excluded.updated_by
    `).bind(api_key, adminSession.user_id).run()
    
    return c.json({ success: true, message: 'OpenSea API 키가 설정되었습니다' })
  } catch (error: any) {
    return c.json({ success: false, error: 'API 키 설정 중 오류가 발생했습니다' }, 500)
  }
})

// ============================================
// API 라우트
// ============================================

app.get('/api/artworks', async (c) => {
  try {
    const { category, status, sort = 'created_at', order = 'DESC', limit = '50' } = c.req.query()
    
    let query = `
      SELECT 
        a.*,
        ar.name as artist_name,
        ar.profile_image as artist_profile_image
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE 1=1
    `
    
    if (category && category !== 'all') {
      query += ` AND a.category = '${category}'`
    }
    
    if (status) {
      query += ` AND a.status = '${status}'`
    } else {
      query += ` AND a.status IN ('approved', 'minted')`
    }
    
    query += ` ORDER BY a.${sort} ${order} LIMIT ${limit}`
    
    const result = await c.env.DB.prepare(query).all()
    
    return c.json<ApiResponse<ArtworkWithArtist[]>>({
      success: true,
      data: result.results as ArtworkWithArtist[]
    })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

app.get('/api/artworks/:id', async (c) => {
  try {
    const id = c.req.param('id')
    
    const result = await c.env.DB.prepare(`
      SELECT 
        a.*,
        ar.name as artist_name,
        ar.bio as artist_bio,
        ar.profile_image as artist_profile_image,
        ar.career_years,
        ar.exhibitions_count,
        ar.awards_count
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.id = ?
    `).bind(id).first()
    
    if (!result) {
      return c.json<ApiResponse>({ success: false, error: '작품을 찾을 수 없습니다.' }, 404)
    }
    
    await c.env.DB.prepare(`UPDATE artworks SET views_count = views_count + 1 WHERE id = ?`).bind(id).run()
    
    return c.json<ApiResponse>({ success: true, data: result })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

app.get('/api/artists', async (c) => {
  try {
    const result = await c.env.DB.prepare(`SELECT * FROM artists ORDER BY exhibitions_count DESC`).all()
    return c.json<ApiResponse<Artist[]>>({ success: true, data: result.results as Artist[] })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

app.get('/api/collections', async (c) => {
  try {
    const result = await c.env.DB.prepare(`SELECT * FROM collections ORDER BY created_at DESC`).all()
    return c.json<ApiResponse>({ success: true, data: result.results })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

app.get('/api/stats', async (c) => {
  try {
    const totalArtworks = await c.env.DB.prepare('SELECT COUNT(*) as count FROM artworks').first()
    const totalArtists = await c.env.DB.prepare('SELECT COUNT(*) as count FROM artists').first()
    const mintedNFTs = await c.env.DB.prepare('SELECT COUNT(*) as count FROM artworks WHERE is_minted = 1').first()
    const totalValue = await c.env.DB.prepare('SELECT SUM(estimated_value) as total FROM artworks').first()
    
    return c.json<ApiResponse>({
      success: true,
      data: {
        total_artworks: totalArtworks?.count || 0,
        total_artists: totalArtists?.count || 0,
        minted_nfts: mintedNFTs?.count || 0,
        total_value: totalValue?.total || 0
      }
    })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

// 가치평가 이력 조회
app.get('/api/valuation-history/:artworkId', async (c) => {
  try {
    const artworkId = c.req.param('artworkId')
    const history = await c.env.DB.prepare(`
      SELECT * FROM valuation_history 
      WHERE artwork_id = ? 
      ORDER BY evaluated_at DESC
    `).bind(artworkId).all()
    
    return c.json<ApiResponse>({
      success: true,
      data: history.results
    })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

// ============================================
// v6.0 추가 API - 메인 페이지 카테고리
// ============================================

// 추천 작품 (평가 점수가 높은 작품)
app.get('/api/artworks/featured/recommended', async (c) => {
  try {
    const limit = c.req.query('limit') || '8'
    
    const result = await c.env.DB.prepare(`
      SELECT 
        a.*,
        ar.name as artist_name,
        ar.profile_image as artist_profile_image,
        COALESCE(a.average_rating, 0) as rating_score
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.status IN ('approved', 'minted')
        AND a.average_rating >= 4.0
      ORDER BY a.average_rating DESC, a.views_count DESC
      LIMIT ?
    `).bind(limit).all()
    
    return c.json<ApiResponse>({
      success: true,
      data: result.results
    })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

// 인기 작품 (조회수와 좋아요가 많은 작품)
app.get('/api/artworks/featured/popular', async (c) => {
  try {
    const limit = c.req.query('limit') || '8'
    
    const result = await c.env.DB.prepare(`
      SELECT 
        a.*,
        ar.name as artist_name,
        ar.profile_image as artist_profile_image,
        (a.views_count * 1 + a.likes_count * 3) as popularity_score
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.status IN ('approved', 'minted')
      ORDER BY popularity_score DESC, a.created_at DESC
      LIMIT ?
    `).bind(limit).all()
    
    return c.json<ApiResponse>({
      success: true,
      data: result.results
    })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

// 신규 작품 (최근 등록된 작품)
app.get('/api/artworks/featured/recent', async (c) => {
  try {
    const limit = c.req.query('limit') || '8'
    
    const result = await c.env.DB.prepare(`
      SELECT 
        a.*,
        ar.name as artist_name,
        ar.profile_image as artist_profile_image
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.status IN ('approved', 'minted')
      ORDER BY a.created_at DESC
      LIMIT ?
    `).bind(limit).all()
    
    return c.json<ApiResponse>({
      success: true,
      data: result.results
    })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

// v6.0: 리뷰 시스템 API
// 작품 리뷰 조회
app.get('/api/artworks/:id/reviews', async (c) => {
  try {
    const artworkId = c.req.param('id')
    const limit = c.req.query('limit') || '20'
    
    const result = await c.env.DB.prepare(`
      SELECT 
        r.*,
        u.username,
        u.full_name,
        u.profile_image
      FROM artwork_reviews r
      LEFT JOIN users u ON r.user_id = u.id
      WHERE r.artwork_id = ?
      ORDER BY r.created_at DESC
      LIMIT ?
    `).bind(artworkId, limit).all()
    
    return c.json<ApiResponse>({
      success: true,
      data: result.results
    })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

// 리뷰 작성
app.post('/api/artworks/:id/reviews', async (c) => {
  const db = c.env.DB
  const artworkId = c.req.param('id')
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    const {
      rating,
      review_text,
      artistic_value_rating,
      investment_potential_rating
    } = await c.req.json()
    
    if (!rating || rating < 1 || rating > 5) {
      return c.json({ success: false, message: '평점은 1-5 사이여야 합니다' }, 400)
    }
    
    // 중복 리뷰 확인
    const existingReview = await db.prepare(`
      SELECT id FROM artwork_reviews 
      WHERE artwork_id = ? AND user_id = ?
    `).bind(artworkId, session.user_id).first()
    
    if (existingReview) {
      return c.json({ success: false, message: '이미 리뷰를 작성하셨습니다' }, 400)
    }
    
    // 리뷰 삽입
    const result = await db.prepare(`
      INSERT INTO artwork_reviews (
        artwork_id, user_id, rating, review_text,
        artistic_value_rating, investment_potential_rating,
        created_at
      ) VALUES (?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
    `).bind(
      artworkId,
      session.user_id,
      rating,
      review_text || null,
      artistic_value_rating || null,
      investment_potential_rating || null
    ).run()
    
    // 작품의 평균 평점 업데이트
    const avgResult = await db.prepare(`
      SELECT AVG(rating) as avg_rating, COUNT(*) as review_count
      FROM artwork_reviews
      WHERE artwork_id = ?
    `).bind(artworkId).first()
    
    await db.prepare(`
      UPDATE artworks
      SET average_rating = ?, reviews_count = ?
      WHERE id = ?
    `).bind(
      avgResult?.avg_rating || 0,
      avgResult?.review_count || 0,
      artworkId
    ).run()
    
    return c.json({
      success: true,
      message: '리뷰가 등록되었습니다',
      review_id: result.meta.last_row_id
    })
  } catch (error: any) {
    console.error('Review creation error:', error)
    return c.json({ success: false, message: '리뷰 등록 중 오류가 발생했습니다' }, 500)
  }
})

// 소유자 정보 조회 API
app.get('/api/artworks/:id/ownership', async (c) => {
  try {
    const artworkId = c.req.param('id')
    
    const result = await c.env.DB.prepare(`
      SELECT 
        ao.*,
        u.username,
        u.full_name,
        u.profile_image
      FROM artwork_ownership ao
      LEFT JOIN users u ON ao.owner_id = u.id
      WHERE ao.artwork_id = ? AND ao.is_current_owner = 1
      LIMIT 1
    `).bind(artworkId).first()
    
    return c.json<ApiResponse>({
      success: true,
      data: result || null
    })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

// v6.0: 마이페이지 API
// 내 소유 NFT 목록
app.get('/api/my/artworks', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    const result = await db.prepare(`
      SELECT 
        a.*,
        ar.name as artist_name,
        ar.profile_image as artist_profile_image,
        ao.acquired_at as acquired_date,
        ao.acquisition_price as purchase_price
      FROM artwork_ownership ao
      LEFT JOIN artworks a ON ao.artwork_id = a.id
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE ao.owner_id = ? AND ao.is_current_owner = 1
      ORDER BY ao.acquired_at DESC
    `).bind(session.user_id).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    return c.json({ success: false, message: '소유 NFT 조회 중 오류가 발생했습니다' }, 500)
  }
})

// 내 거래 내역
app.get('/api/my/transactions', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    const result = await db.prepare(`
      SELECT 
        t.*,
        a.title as artwork_title,
        a.image_url as artwork_image
      FROM transactions t
      LEFT JOIN artworks a ON t.artwork_id = a.id
      WHERE t.buyer_id = ? OR t.seller_id = ?
      ORDER BY t.transaction_date DESC
      LIMIT 50
    `).bind(session.user_id, session.user_id).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    return c.json({ success: false, message: '거래내역 조회 중 오류가 발생했습니다' }, 500)
  }
})

// 프로필 수정
app.put('/api/my/profile', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    const { full_name, bio, phone, website, profile_image } = await c.req.json()
    
    await db.prepare(`
      UPDATE users
      SET full_name = ?, bio = ?, phone = ?, website = ?, profile_image = ?
      WHERE id = ?
    `).bind(full_name, bio, phone, website, profile_image, session.user_id).run()
    
    return c.json({ success: true, message: '프로필이 업데이트되었습니다' })
  } catch (error: any) {
    return c.json({ success: false, message: '프로필 업데이트 중 오류가 발생했습니다' }, 500)
  }
})

// 고객지원 티켓 생성
app.post('/api/support/tickets', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    const { category, subject, description, priority } = await c.req.json()
    
    if (!category || !subject || !description) {
      return c.json({ success: false, message: '필수 항목을 입력해주세요' }, 400)
    }
    
    const result = await db.prepare(`
      INSERT INTO support_tickets (
        user_id, category, subject, description, priority,
        status, created_at
      ) VALUES (?, ?, ?, ?, ?, 'open', CURRENT_TIMESTAMP)
    `).bind(session.user_id, category, subject, description, priority || 'medium').run()
    
    return c.json({
      success: true,
      message: '문의가 등록되었습니다',
      ticket_id: result.meta.last_row_id
    })
  } catch (error: any) {
    return c.json({ success: false, message: '문의 등록 중 오류가 발생했습니다' }, 500)
  }
})

// 내 티켓 목록
app.get('/api/support/my-tickets', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    const result = await db.prepare(`
      SELECT * FROM support_tickets
      WHERE user_id = ?
      ORDER BY created_at DESC
    `).bind(session.user_id).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    return c.json({ success: false, message: '티켓 조회 중 오류가 발생했습니다' }, 500)
  }
})

// v6.0: KYC/AML API
// KYC 정보 제출
app.post('/api/kyc/submit', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    const {
      legal_name,
      date_of_birth,
      nationality,
      id_type,
      id_number,
      address_line1,
      address_line2,
      city,
      state_province,
      postal_code,
      country,
      id_document_url,
      address_proof_url,
      selfie_url
    } = await c.req.json()
    
    // 필수 항목 검증
    if (!legal_name || !date_of_birth || !nationality || !id_type || !id_number) {
      return c.json({ success: false, message: '필수 KYC 정보를 입력해주세요' }, 400)
    }
    
    // 기존 KYC 확인
    const existing = await db.prepare(`
      SELECT id FROM user_kyc_verification WHERE user_id = ?
    `).bind(session.user_id).first()
    
    if (existing) {
      return c.json({ success: false, message: '이미 KYC 인증을 신청하셨습니다' }, 400)
    }
    
    // KYC 정보 삽입
    await db.prepare(`
      INSERT INTO user_kyc_verification (
        user_id, legal_name, date_of_birth, nationality,
        id_type, id_number, address_line1, address_line2,
        city, state_province, postal_code, country,
        id_document_url, address_proof_url, selfie_url,
        verification_status, risk_level, submitted_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending', 'low', CURRENT_TIMESTAMP)
    `).bind(
      session.user_id, legal_name, date_of_birth, nationality,
      id_type, id_number, address_line1, address_line2 || null,
      city, state_province, postal_code, country,
      id_document_url || null, address_proof_url || null, selfie_url || null
    ).run()
    
    return c.json({ success: true, message: 'KYC 인증이 신청되었습니다' })
  } catch (error: any) {
    console.error('KYC submission error:', error)
    return c.json({ success: false, message: 'KYC 신청 중 오류가 발생했습니다' }, 500)
  }
})

// ============================================
// 페이지 라우트
// ============================================

app.get('/', async (c) => {
  try {
    const db = c.env.DB
    
    // Get stats directly from database
    const statsData = await db.prepare(`
      SELECT 
        COUNT(*) as total_artworks,
        COUNT(DISTINCT artist_id) as total_artists,
        SUM(CASE WHEN is_minted = 1 THEN 1 ELSE 0 END) as minted_nfts,
        SUM(estimated_value) as total_value
      FROM artworks
    `).first()
    
    const stats = { data: statsData }
    
    // Get featured artworks
    const artworksData = await db.prepare(`
      SELECT a.*, ar.name as artist_name, ar.profile_image as artist_profile_image
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.status IN ('approved', 'minted')
      ORDER BY a.created_at DESC
      LIMIT 8
    `).all()
    
    const artworks = { data: artworksData.results }
    
    // v6.0: Get recommended artworks (rating >= 4.0)
    const recommendedData = await db.prepare(`
      SELECT a.*, ar.name as artist_name, ar.profile_image as artist_profile_image
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.status IN ('approved', 'minted') AND a.average_rating >= 4.0
      ORDER BY a.average_rating DESC, a.views_count DESC
      LIMIT 8
    `).all()
    
    const recommended = { data: recommendedData.results }
    
    // v6.0: Get popular artworks
    const popularData = await db.prepare(`
      SELECT a.*, ar.name as artist_name, ar.profile_image as artist_profile_image,
             (a.views_count * 1 + a.likes_count * 3) as popularity_score
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.status IN ('approved', 'minted')
      ORDER BY popularity_score DESC
      LIMIT 8
    `).all()
    
    const popular = { data: popularData.results }
    
    // v6.0: Get recent artworks
    const recentData = await db.prepare(`
      SELECT a.*, ar.name as artist_name, ar.profile_image as artist_profile_image
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.status IN ('approved', 'minted')
      ORDER BY a.created_at DESC
      LIMIT 8
    `).all()
    
    const recent = { data: recentData.results }
    
    const content = `
    <!-- 히어로 섹션 -->
    <section class="relative overflow-hidden bg-grid">
        <div class="hero-gradient absolute inset-0"></div>
        <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-32">
            <div class="text-center max-w-5xl mx-auto">
                <div class="inline-block mb-6 px-6 py-2 bg-white bg-opacity-5 backdrop-blur-sm rounded-full border border-white border-opacity-10">
                    <span class="text-gradient font-bold text-sm">🎨 NFT Art Museum Platform</span>
                </div>
                
                <h1 class="text-6xl md:text-8xl font-black mb-8 leading-tight">
                    <span class="text-white">Discover</span><br/>
                    <span class="text-gradient">Premium NFTs</span>
                </h1>
                
                <p class="text-xl md:text-2xl text-gray-400 mb-12 font-light leading-relaxed max-w-3xl mx-auto">
                    객관적인 가치산정 시스템으로 검증된<br class="hidden sm:block"/>
                    프리미엄 NFT 아트 컬렉션
                </p>
                
                <!-- 주요 액션 버튼 그룹 -->
                <div class="max-w-4xl mx-auto mb-12">
                    <!-- 첫 번째 줄: 주요 탐색 버튼 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <a href="/gallery" class="group relative px-8 py-5 bg-gradient-to-br from-purple-600/20 to-cyan-600/20 hover:from-purple-600/30 hover:to-cyan-600/30 rounded-2xl font-bold text-base inline-flex flex-col items-center justify-center border border-purple-500/30 hover:border-purple-500/60 transition-all duration-300 hover:scale-105">
                            <i class="fas fa-compass text-3xl mb-2 text-purple-400 group-hover:text-purple-300 transition-colors"></i>
                            <span class="text-white">NFT 컬렉션 탐색</span>
                        </a>
                        <a href="/valuation" class="group relative px-8 py-5 bg-gradient-to-br from-blue-600/20 to-cyan-600/20 hover:from-blue-600/30 hover:to-cyan-600/30 rounded-2xl font-bold text-base inline-flex flex-col items-center justify-center border border-blue-500/30 hover:border-blue-500/60 transition-all duration-300 hover:scale-105">
                            <i class="fas fa-chart-line text-3xl mb-2 text-blue-400 group-hover:text-blue-300 transition-colors"></i>
                            <span class="text-white">가치산정 시스템</span>
                        </a>
                        <a href="/expert/apply" class="group relative px-8 py-5 bg-gradient-to-br from-amber-600/20 to-orange-600/20 hover:from-amber-600/30 hover:to-orange-600/30 rounded-2xl font-bold text-base inline-flex flex-col items-center justify-center border border-amber-500/30 hover:border-amber-500/60 transition-all duration-300 hover:scale-105">
                            <i class="fas fa-user-tie text-3xl mb-2 text-amber-400 group-hover:text-amber-300 transition-colors"></i>
                            <span class="text-white">전문가 신청/평가</span>
                        </a>
                    </div>
                    
                    <!-- 두 번째 줄: 회원 액션 버튼 -->
                    <div class="flex flex-col sm:flex-row justify-center gap-4">
                        <a href="/signup" class="group px-10 py-4 bg-gradient-to-r from-purple-600 to-cyan-500 hover:from-purple-700 hover:to-cyan-600 text-white rounded-xl font-bold text-base inline-flex items-center justify-center shadow-lg shadow-purple-500/30 hover:shadow-purple-500/50 transition-all duration-300 hover:scale-105">
                            <i class="fas fa-user-plus mr-2 text-lg group-hover:rotate-12 transition-transform"></i>
                            <span>회원가입</span>
                        </a>
                        <button onclick="connectMetaMask()" class="group px-10 py-4 bg-gradient-to-r from-gray-800 to-gray-900 hover:from-gray-700 hover:to-gray-800 text-white rounded-xl font-bold text-base inline-flex items-center justify-center border border-gray-700 hover:border-gray-600 shadow-lg shadow-gray-900/50 transition-all duration-300 hover:scale-105">
                            <i class="fas fa-wallet mr-2 text-lg group-hover:scale-110 transition-transform"></i>
                            <span id="walletTextMain">지갑 연결</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 통계 카드 - 각각 다른 배경색 -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-5xl mx-auto">
                <div class="rounded-2xl p-6 text-center bg-gradient-to-br from-purple-900/30 to-purple-800/20 border border-purple-700/30 hover:border-purple-600/50 transition-all duration-300 hover:scale-105">
                    <div class="text-4xl font-black text-gradient mb-2">${stats.data?.total_artworks || 0}</div>
                    <div class="text-gray-400 font-semibold text-sm">NFT 작품</div>
                </div>
                <div class="rounded-2xl p-6 text-center bg-gradient-to-br from-amber-900/30 to-amber-800/20 border border-amber-700/30 hover:border-amber-600/50 transition-all duration-300 hover:scale-105">
                    <div class="text-4xl font-black text-gold mb-2">${stats.data?.total_artists || 0}</div>
                    <div class="text-gray-400 font-semibold text-sm">아티스트</div>
                </div>
                <div class="rounded-2xl p-6 text-center bg-gradient-to-br from-cyan-900/30 to-cyan-800/20 border border-cyan-700/30 hover:border-cyan-600/50 transition-all duration-300 hover:scale-105">
                    <div class="text-4xl font-black text-gradient mb-2">${stats.data?.minted_nfts || 0}</div>
                    <div class="text-gray-400 font-semibold text-sm">민팅 완료</div>
                </div>
                <div class="rounded-2xl p-6 text-center bg-gradient-to-br from-emerald-900/30 to-emerald-800/20 border border-emerald-700/30 hover:border-emerald-600/50 transition-all duration-300 hover:scale-105">
                    <div class="text-4xl font-black text-gold mb-2">${((stats.data?.total_value || 0) / 100000000).toFixed(0)}억</div>
                    <div class="text-gray-400 font-semibold text-sm">총 가치</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Featured NFTs -->
    <section class="py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center mb-12">
                <div>
                    <h2 class="text-5xl font-black mb-3">
                        <span class="text-gradient">Featured</span> <span class="text-white">NFTs</span>
                    </h2>
                    <p class="text-gray-500">가장 가치있는 프리미엄 컬렉션</p>
                </div>
                <a href="/gallery" class="text-gradient hover:opacity-80 font-bold flex items-center group">
                    전체 보기
                    <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                </a>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                ${artworks.data?.map((artwork: any) => `
                    <a href="/artwork/${artwork.id}" class="card-nft rounded-3xl overflow-hidden group">
                        <div class="relative aspect-square bg-gray-900 overflow-hidden">
                            <img src="${artwork.image_url}" alt="${artwork.title}" 
                                 class="w-full h-full object-cover img-nft">
                            <div class="absolute top-4 right-4">
                                <span class="px-3 py-1.5 bg-black bg-opacity-80 backdrop-blur-sm text-white text-xs font-bold rounded-full border border-white border-opacity-20">
                                    ${artwork.category}
                                </span>
                            </div>
                            <div class="absolute top-4 left-4">
                                <span class="px-3 py-1.5 bg-gradient-to-r from-purple-600 to-cyan-500 text-white text-xs font-bold rounded-full flex items-center">
                                    <i class="fas fa-cube mr-1.5"></i>NFT
                                </span>
                            </div>
                            <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-60"></div>
                        </div>
                        <div class="p-6">
                            <h3 class="font-bold text-xl text-white mb-3 line-clamp-1">${artwork.title}</h3>
                            <div class="flex items-center mb-4">
                                <img src="${artwork.artist_profile_image}" 
                                     class="w-8 h-8 rounded-full mr-2 object-cover border border-white border-opacity-20"
                                     alt="${artwork.artist_name}">
                                <span class="text-sm text-gray-400 font-medium">${artwork.artist_name}</span>
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">산정가</div>
                                    <div class="font-black text-lg text-gradient">${formatPrice(artwork.estimated_value)}</div>
                                </div>
                                <div class="flex items-center space-x-3 text-gray-500 text-sm">
                                    <span class="flex items-center"><i class="fas fa-eye mr-1"></i>${artwork.views_count}</span>
                                    <span class="flex items-center"><i class="fas fa-heart mr-1"></i>${artwork.likes_count}</span>
                                </div>
                            </div>
                        </div>
                    </a>
                `).join('') || ''}
            </div>
        </div>
    </section>

    <!-- v6.0: 추천 작품 섹션 -->
    <section class="py-20 bg-gradient-to-b from-transparent to-purple-900/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center mb-12">
                <div>
                    <h2 class="text-5xl font-black mb-3">
                        <span class="text-gradient">추천</span> <span class="text-white">작품</span>
                    </h2>
                    <p class="text-gray-500">전문가 평가가 우수한 엄선된 컬렉션</p>
                </div>
                <a href="/gallery?filter=recommended" class="text-gradient hover:opacity-80 font-bold flex items-center group">
                    전체 보기
                    <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                </a>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                ${recommended.data?.map((artwork: any) => `
                    <a href="/artwork/${artwork.id}" class="card-nft rounded-3xl overflow-hidden group">
                        <div class="relative aspect-square bg-gray-900 overflow-hidden">
                            <img src="${artwork.image_url}" alt="${artwork.title}" 
                                 class="w-full h-full object-cover img-nft">
                            <div class="absolute top-4 right-4">
                                <span class="px-3 py-1.5 bg-black bg-opacity-80 backdrop-blur-sm text-white text-xs font-bold rounded-full border border-white border-opacity-20">
                                    ${artwork.category}
                                </span>
                            </div>
                            <div class="absolute top-4 left-4">
                                <span class="px-3 py-1.5 bg-gradient-to-r from-amber-500 to-orange-500 text-white text-xs font-bold rounded-full flex items-center">
                                    <i class="fas fa-star mr-1.5"></i>추천
                                </span>
                            </div>
                            <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-60"></div>
                        </div>
                        <div class="p-6">
                            <h3 class="font-bold text-xl text-white mb-3 line-clamp-1">${artwork.title}</h3>
                            <div class="flex items-center mb-4">
                                <img src="${artwork.artist_profile_image}" 
                                     class="w-8 h-8 rounded-full mr-2 object-cover border border-white border-opacity-20"
                                     alt="${artwork.artist_name}">
                                <span class="text-sm text-gray-400 font-medium">${artwork.artist_name}</span>
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">산정가</div>
                                    <div class="font-black text-lg text-gradient">${formatPrice(artwork.estimated_value)}</div>
                                </div>
                                <div class="flex items-center space-x-3 text-gray-500 text-sm">
                                    <span class="flex items-center"><i class="fas fa-eye mr-1"></i>${artwork.views_count}</span>
                                    <span class="flex items-center"><i class="fas fa-heart mr-1"></i>${artwork.likes_count}</span>
                                </div>
                            </div>
                        </div>
                    </a>
                `).join('') || '<div class="col-span-full text-center text-gray-500 py-12">추천 작품이 없습니다.</div>'}
            </div>
        </div>
    </section>

    <!-- v6.0: 인기 작품 섹션 -->
    <section class="py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center mb-12">
                <div>
                    <h2 class="text-5xl font-black mb-3">
                        <span class="text-gradient">인기</span> <span class="text-white">작품</span>
                    </h2>
                    <p class="text-gray-500">가장 많은 관심을 받고 있는 작품</p>
                </div>
                <a href="/gallery?filter=popular" class="text-gradient hover:opacity-80 font-bold flex items-center group">
                    전체 보기
                    <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                </a>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                ${popular.data?.map((artwork: any) => `
                    <a href="/artwork/${artwork.id}" class="card-nft rounded-3xl overflow-hidden group">
                        <div class="relative aspect-square bg-gray-900 overflow-hidden">
                            <img src="${artwork.image_url}" alt="${artwork.title}" 
                                 class="w-full h-full object-cover img-nft">
                            <div class="absolute top-4 right-4">
                                <span class="px-3 py-1.5 bg-black bg-opacity-80 backdrop-blur-sm text-white text-xs font-bold rounded-full border border-white border-opacity-20">
                                    ${artwork.category}
                                </span>
                            </div>
                            <div class="absolute top-4 left-4">
                                <span class="px-3 py-1.5 bg-gradient-to-r from-red-500 to-pink-500 text-white text-xs font-bold rounded-full flex items-center">
                                    <i class="fas fa-fire mr-1.5"></i>인기
                                </span>
                            </div>
                            <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-60"></div>
                        </div>
                        <div class="p-6">
                            <h3 class="font-bold text-xl text-white mb-3 line-clamp-1">${artwork.title}</h3>
                            <div class="flex items-center mb-4">
                                <img src="${artwork.artist_profile_image}" 
                                     class="w-8 h-8 rounded-full mr-2 object-cover border border-white border-opacity-20"
                                     alt="${artwork.artist_name}">
                                <span class="text-sm text-gray-400 font-medium">${artwork.artist_name}</span>
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">산정가</div>
                                    <div class="font-black text-lg text-gradient">${formatPrice(artwork.estimated_value)}</div>
                                </div>
                                <div class="flex items-center space-x-3 text-gray-500 text-sm">
                                    <span class="flex items-center"><i class="fas fa-eye mr-1"></i>${artwork.views_count}</span>
                                    <span class="flex items-center"><i class="fas fa-heart mr-1"></i>${artwork.likes_count}</span>
                                </div>
                            </div>
                        </div>
                    </a>
                `).join('') || '<div class="col-span-full text-center text-gray-500 py-12">인기 작품이 없습니다.</div>'}
            </div>
        </div>
    </section>

    <!-- v6.0: 신규 작품 섹션 -->
    <section class="py-20 bg-gradient-to-b from-transparent to-cyan-900/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center mb-12">
                <div>
                    <h2 class="text-5xl font-black mb-3">
                        <span class="text-gradient">신규</span> <span class="text-white">작품</span>
                    </h2>
                    <p class="text-gray-500">최근 등록된 따끈따끈한 신작</p>
                </div>
                <a href="/gallery?filter=recent" class="text-gradient hover:opacity-80 font-bold flex items-center group">
                    전체 보기
                    <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                </a>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                ${recent.data?.map((artwork: any) => `
                    <a href="/artwork/${artwork.id}" class="card-nft rounded-3xl overflow-hidden group">
                        <div class="relative aspect-square bg-gray-900 overflow-hidden">
                            <img src="${artwork.image_url}" alt="${artwork.title}" 
                                 class="w-full h-full object-cover img-nft">
                            <div class="absolute top-4 right-4">
                                <span class="px-3 py-1.5 bg-black bg-opacity-80 backdrop-blur-sm text-white text-xs font-bold rounded-full border border-white border-opacity-20">
                                    ${artwork.category}
                                </span>
                            </div>
                            <div class="absolute top-4 left-4">
                                <span class="px-3 py-1.5 bg-gradient-to-r from-green-500 to-cyan-500 text-white text-xs font-bold rounded-full flex items-center">
                                    <i class="fas fa-sparkles mr-1.5"></i>NEW
                                </span>
                            </div>
                            <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-60"></div>
                        </div>
                        <div class="p-6">
                            <h3 class="font-bold text-xl text-white mb-3 line-clamp-1">${artwork.title}</h3>
                            <div class="flex items-center mb-4">
                                <img src="${artwork.artist_profile_image}" 
                                     class="w-8 h-8 rounded-full mr-2 object-cover border border-white border-opacity-20"
                                     alt="${artwork.artist_name}">
                                <span class="text-sm text-gray-400 font-medium">${artwork.artist_name}</span>
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">산정가</div>
                                    <div class="font-black text-lg text-gradient">${formatPrice(artwork.estimated_value)}</div>
                                </div>
                                <div class="flex items-center space-x-3 text-gray-500 text-sm">
                                    <span class="flex items-center"><i class="fas fa-eye mr-1"></i>${artwork.views_count}</span>
                                    <span class="flex items-center"><i class="fas fa-heart mr-1"></i>${artwork.likes_count}</span>
                                </div>
                            </div>
                        </div>
                    </a>
                `).join('') || '<div class="col-span-full text-center text-gray-500 py-12">신규 작품이 없습니다.</div>'}
            </div>
        </div>
    </section>

    <!-- 가치산정 시스템 -->
    <section class="py-20 relative overflow-hidden">
        <div class="hero-gradient absolute inset-0"></div>
        <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <div class="inline-block mb-6 px-6 py-2 bg-gradient-to-r from-blue-600/20 to-cyan-600/20 backdrop-blur-sm rounded-full border border-blue-500/30">
                    <span class="text-gradient font-bold text-sm">🎯 NFT VALUATION SYSTEM</span>
                </div>
                <h2 class="text-4xl md:text-5xl font-black mb-6">
                    <span class="text-white">NFT 미술품</span> <span class="text-gradient">가치산정 시스템</span>
                </h2>
                <p class="text-gray-300 text-base md:text-lg font-light leading-relaxed max-w-2xl mx-auto">
                    전문가 패널의 <span class="text-purple-400 font-semibold">정성평가</span>와 
                    데이터 기반의 <span class="text-cyan-400 font-semibold">정량평가</span>를 결합하여<br/>
                    투명하고 객관적인 미술품 가치를 산정합니다
                </p>
            </div>
            
            <div class="grid md:grid-cols-2 gap-10">
                <!-- 정량적 평가 카드 -->
                <div class="group rounded-3xl p-10 bg-gradient-to-br from-blue-900/40 to-cyan-900/30 border border-blue-500/30 hover:border-blue-400/60 transition-all duration-500 hover:scale-105 hover:shadow-2xl hover:shadow-blue-500/20">
                    <div class="flex items-center mb-8">
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center mr-5 group-hover:scale-110 group-hover:rotate-6 transition-transform duration-500">
                            <i class="fas fa-chart-line text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="text-3xl font-black text-white mb-1">정량적 평가</h3>
                            <div class="text-blue-400 text-sm font-semibold">Quantitative Analysis</div>
                        </div>
                    </div>
                    <ul class="space-y-5">
                        <li class="flex items-start group/item">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0 mt-0.5 group-hover/item:scale-110 transition-transform">
                                <i class="fas fa-fire text-white text-base"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white mb-2 text-lg">시장 수요도</div>
                                <div class="text-gray-300 text-sm leading-relaxed">NFT 마켓 트렌드 및 거래량 분석</div>
                                <div class="mt-2 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full" style="width: 85%"></div>
                                </div>
                            </div>
                        </li>
                        <li class="flex items-start group/item">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0 mt-0.5 group-hover/item:scale-110 transition-transform">
                                <i class="fas fa-gem text-white text-base"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white mb-2 text-lg">희소성</div>
                                <div class="text-gray-300 text-sm leading-relaxed">에디션 수 및 유사 NFT 비교 분석</div>
                                <div class="mt-2 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full" style="width: 92%"></div>
                                </div>
                            </div>
                        </li>
                        <li class="flex items-start group/item">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0 mt-0.5 group-hover/item:scale-110 transition-transform">
                                <i class="fas fa-history text-white text-base"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white mb-2 text-lg">거래 이력</div>
                                <div class="text-gray-300 text-sm leading-relaxed">과거 거래 내역 및 가격 변동 추이</div>
                                <div class="mt-2 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full" style="width: 78%"></div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
                
                <!-- 정성적 평가 카드 -->
                <div class="group rounded-3xl p-10 bg-gradient-to-br from-purple-900/40 to-pink-900/30 border border-purple-500/30 hover:border-purple-400/60 transition-all duration-500 hover:scale-105 hover:shadow-2xl hover:shadow-purple-500/20">
                    <div class="flex items-center mb-8">
                        <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center mr-5 group-hover:scale-110 group-hover:rotate-6 transition-transform duration-500">
                            <i class="fas fa-star text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="text-3xl font-black text-white mb-1">정성적 평가</h3>
                            <div class="text-purple-400 text-sm font-semibold">Qualitative Analysis</div>
                        </div>
                    </div>
                    <ul class="space-y-5">
                        <li class="flex items-start group/item">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0 mt-0.5 group-hover/item:scale-110 transition-transform">
                                <i class="fas fa-palette text-white text-base"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white mb-2 text-lg">예술적 완성도</div>
                                <div class="text-gray-300 text-sm leading-relaxed">디자인 품질 및 미적 완성도 평가</div>
                                <div class="mt-2 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full" style="width: 95%"></div>
                                </div>
                            </div>
                        </li>
                        <li class="flex items-start group/item">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0 mt-0.5 group-hover/item:scale-110 transition-transform">
                                <i class="fas fa-lightbulb text-white text-base"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white mb-2 text-lg">독창성</div>
                                <div class="text-gray-300 text-sm leading-relaxed">아티스트의 고유한 스타일과 창의성</div>
                                <div class="mt-2 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full" style="width: 88%"></div>
                                </div>
                            </div>
                        </li>
                        <li class="flex items-start group/item">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0 mt-0.5 group-hover/item:scale-110 transition-transform">
                                <i class="fas fa-user-tie text-white text-base"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white mb-2 text-lg">전문가 평점</div>
                                <div class="text-gray-300 text-sm leading-relaxed">검증된 전문가 패널의 종합 평가</div>
                                <div class="mt-2 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full" style="width: 91%"></div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </section>
    
    <script>
      function formatPrice(price) {
        if (price >= 100000000) return (price / 100000000).toFixed(1) + '억원';
        else if (price >= 10000) return (price / 10000).toFixed(0) + '만원';
        return price.toLocaleString() + '원';
      }
    </script>
    `;
    
    return c.html(getLayout(content))
  } catch (error: any) {
    return c.html(getLayout('<div class="py-20 text-center text-red-500">데이터를 불러오는데 실패했습니다.</div>'))
  }
})

// 갤러리 페이지 (계속...)

app.get('/gallery', async (c) => {
  try {
    const db = c.env.DB
    
    // 전시 정보 가져오기 (최신 3개)
    const exhibitionsResult = await db.prepare(`
      SELECT * FROM exhibitions 
      WHERE status = 'active' 
      ORDER BY start_date DESC 
      LIMIT 3
    `).all()
    const exhibitions = exhibitionsResult.results || []
    
    // 모든 작품 가져오기
    const artworksResult = await db.prepare(`
      SELECT 
        a.*,
        ar.name as artist_name,
        ar.profile_image as artist_profile_image,
        ar.wallet_address as artist_wallet,
        ar.rank_score as artist_rank_score
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.status IN ('approved', 'minted', 'sold')
      ORDER BY a.created_at DESC
    `).all()
    
    const artworks = artworksResult.results || []
    
    // 작품 카테고리 분류
    const now = new Date()
    const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000)
    
    const newArtworks = artworks.filter((a: any) => new Date(a.created_at) > sevenDaysAgo).slice(0, 8)
    const popularArtworks = artworks.sort((a: any, b: any) => (b.views_count || 0) - (a.views_count || 0)).slice(0, 8)
    const curatedArtworks = artworks.filter((a: any) => (a.valuation_score || 0) >= 80).slice(0, 8)
    const premiumArtworks = artworks.filter((a: any) => (a.estimated_value || 0) >= 50000000).slice(0, 8)
    const exhibitionArtworks = artworks.filter((a: any) => a.exhibition_id).slice(0, 8)
    
    // 통계 정보
    const stats = {
      total: artworks.length,
      exhibitions: exhibitions.length,
      minted: artworks.filter((a: any) => a.is_minted).length,
      totalValue: artworks.reduce((sum: number, a: any) => sum + (a.estimated_value || 0), 0),
      avgScore: artworks.length > 0 ? artworks.reduce((sum: number, a: any) => sum + (a.valuation_score || 0), 0) / artworks.length : 0
    }
    
    <section class="py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Hero Header -->
            <div class="text-center mb-16">
                <div class="inline-block mb-6 px-6 py-2 bg-gradient-to-r from-purple-600/20 to-cyan-600/20 backdrop-blur-sm rounded-full border border-purple-500/30">
                    <span class="text-gradient font-bold text-sm">🎨 NFT ART GALLERY</span>
                </div>
                <h1 class="text-6xl md:text-7xl font-black mb-6">
                    <span class="text-white">NFT 미술품</span><br/>
                    <span class="text-gradient">갤러리</span>
                </h1>
                <p class="text-gray-300 text-xl max-w-3xl mx-auto leading-relaxed">
                    뮤지엄과 갤러리의 전시 정보를 블록체인으로 인증하고,<br/>
                    가치산정 시스템과 연동된 프리미엄 NFT 작품을 만나보세요
                </p>
            </div>

            <!-- 통계 대시보드 -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-16">
                <div class="card-nft rounded-2xl p-6 text-center bg-gradient-to-br from-purple-900/30 to-pink-900/20 border border-purple-500/30">
                    <div class="text-4xl font-black text-gradient mb-2">${stats.total}</div>
                    <div class="text-xs text-gray-400 uppercase font-semibold">전체 작품</div>
                </div>
                <div class="card-nft rounded-2xl p-6 text-center bg-gradient-to-br from-blue-900/30 to-cyan-900/20 border border-blue-500/30">
                    <div class="text-4xl font-black text-gradient mb-2">${stats.exhibitions}</div>
                    <div class="text-xs text-gray-400 uppercase font-semibold">진행 중 전시</div>
                </div>
                <div class="card-nft rounded-2xl p-6 text-center bg-gradient-to-br from-cyan-900/30 to-emerald-900/20 border border-cyan-500/30">
                    <div class="text-4xl font-black text-gradient mb-2">${stats.minted}</div>
                    <div class="text-xs text-gray-400 uppercase font-semibold">NFT 민팅</div>
                </div>
                <div class="card-nft rounded-2xl p-6 text-center bg-gradient-to-br from-amber-900/30 to-orange-900/20 border border-amber-500/30">
                    <div class="text-4xl font-black text-gradient mb-2">${(stats.totalValue / 100000000).toFixed(1)}억</div>
                    <div class="text-xs text-gray-400 uppercase font-semibold">총 가치</div>
                </div>
                <div class="card-nft rounded-2xl p-6 text-center bg-gradient-to-br from-green-900/30 to-emerald-900/20 border border-green-500/30">
                    <div class="text-4xl font-black text-gradient mb-2">${stats.avgScore.toFixed(1)}</div>
                    <div class="text-xs text-gray-400 uppercase font-semibold">평균 점수</div>
                </div>
            </div>

            ${exhibitions.length > 0 ? `
            <!-- 현재 전시 정보 -->
            <div class="mb-16">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-4xl font-black text-white mb-2">🏛️ 현재 전시</h2>
                        <p class="text-gray-400">블록체인으로 인증된 뮤지엄/갤러리 전시 정보</p>
                    </div>
                    <a href="/exhibitions" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 hover:from-purple-500 hover:to-cyan-400 text-white font-bold rounded-xl transition-all">
                        전시 전체보기 →
                    </a>
                </div>
                
                <div class="grid md:grid-cols-3 gap-8">
                    ${exhibitions.map((ex: any) => `
                        <div class="card-nft rounded-3xl overflow-hidden group hover:scale-105 transition-transform duration-300">
                            <div class="relative h-64 bg-gradient-to-br from-purple-900/40 to-cyan-900/30">
                                ${ex.poster_image ? `
                                <img src="${ex.poster_image}" alt="${ex.title}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                                ` : `
                                <div class="w-full h-full flex items-center justify-center">
                                    <i class="fas fa-image text-6xl text-gray-600"></i>
                                </div>
                                `}
                                <div class="absolute top-4 right-4 px-4 py-2 bg-green-500 text-white text-xs font-bold rounded-full">
                                    <i class="fas fa-check-circle mr-1"></i>진행중
                                </div>
                            </div>
                            <div class="p-6">
                                <h3 class="text-2xl font-black text-white mb-3">${ex.title || '전시명 없음'}</h3>
                                <p class="text-gray-400 text-sm mb-4 line-clamp-2">${ex.description || '전시 설명이 없습니다'}</p>
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center text-gray-300">
                                        <i class="fas fa-building w-5 text-purple-400"></i>
                                        <span class="ml-2">${ex.venue_name || '장소 미정'}</span>
                                    </div>
                                    <div class="flex items-center text-gray-300">
                                        <i class="fas fa-calendar w-5 text-cyan-400"></i>
                                        <span class="ml-2">${ex.start_date ? new Date(ex.start_date).toLocaleDateString('ko-KR') : ''} ~ ${ex.end_date ? new Date(ex.end_date).toLocaleDateString('ko-KR') : ''}</span>
                                    </div>
                                    <div class="flex items-center text-gray-300">
                                        <i class="fas fa-link w-5 text-green-400"></i>
                                        <span class="ml-2 text-xs text-gray-500">블록체인 인증됨</span>
                                    </div>
                                </div>
                                <a href="/exhibition/${ex.id}" class="mt-4 block w-full text-center px-4 py-3 bg-gradient-to-r from-purple-600/20 to-cyan-600/20 hover:from-purple-600/30 hover:to-cyan-600/30 text-white font-semibold rounded-xl transition-all border border-purple-500/30">
                                    전시 상세보기
                                </a>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}

            <!-- 작품 카테고리 탭 -->
            <div class="mb-12">
                <div class="flex flex-wrap gap-3 border-b border-white/10 pb-6">
                    <button onclick="showCategory('new')" id="tab-new" class="category-tab active px-6 py-3 rounded-xl font-bold transition-all">
                        <i class="fas fa-sparkles mr-2"></i>신규 작품
                    </button>
                    <button onclick="showCategory('popular')" id="tab-popular" class="category-tab px-6 py-3 rounded-xl font-bold transition-all">
                        <i class="fas fa-fire mr-2"></i>인기 작품
                    </button>
                    <button onclick="showCategory('curated')" id="tab-curated" class="category-tab px-6 py-3 rounded-xl font-bold transition-all">
                        <i class="fas fa-star mr-2"></i>큐레이터 추천
                    </button>
                    <button onclick="showCategory('premium')" id="tab-premium" class="category-tab px-6 py-3 rounded-xl font-bold transition-all">
                        <i class="fas fa-gem mr-2"></i>프리미엄
                    </button>
                    <button onclick="showCategory('exhibition')" id="tab-exhibition" class="category-tab px-6 py-3 rounded-xl font-bold transition-all">
                        <i class="fas fa-building mr-2"></i>전시 중
                    </button>
                    <button onclick="showCategory('all')" id="tab-all" class="category-tab px-6 py-3 rounded-xl font-bold transition-all">
                        <i class="fas fa-th mr-2"></i>전체
                    </button>
                </div>
            </div>

            <!-- 신규 작품 -->
            <div id="category-new" class="category-content">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-3xl font-black text-white flex items-center">
                        <i class="fas fa-sparkles text-purple-400 mr-3"></i>
                        신규 작품 (최근 7일)
                    </h3>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${newArtworks.length > 0 ? newArtworks.map((artwork: any) => `
                        ${renderArtworkCard(artwork)}
                    `).join('') : '<div class="col-span-full text-center py-20 text-gray-400">신규 작품이 없습니다</div>'}
                </div>
            </div>

            <!-- 인기 작품 -->
            <div id="category-popular" class="category-content hidden">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-3xl font-black text-white flex items-center">
                        <i class="fas fa-fire text-orange-400 mr-3"></i>
                        인기 작품 (조회수 기준)
                    </h3>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${popularArtworks.length > 0 ? popularArtworks.map((artwork: any) => `
                        ${renderArtworkCard(artwork)}
                    `).join('') : '<div class="col-span-full text-center py-20 text-gray-400">인기 작품이 없습니다</div>'}
                </div>
            </div>

            <!-- 큐레이터 추천 -->
            <div id="category-curated" class="category-content hidden">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-3xl font-black text-white flex items-center">
                        <i class="fas fa-star text-yellow-400 mr-3"></i>
                        큐레이터 추천 (평가점수 80점 이상)
                    </h3>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${curatedArtworks.length > 0 ? curatedArtworks.map((artwork: any) => `
                        ${renderArtworkCard(artwork)}
                    `).join('') : '<div class="col-span-full text-center py-20 text-gray-400">추천 작품이 없습니다</div>'}
                </div>
            </div>

            <!-- 프리미엄 작품 -->
            <div id="category-premium" class="category-content hidden">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-3xl font-black text-white flex items-center">
                        <i class="fas fa-gem text-cyan-400 mr-3"></i>
                        프리미엄 작품 (5천만원 이상)
                    </h3>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${premiumArtworks.length > 0 ? premiumArtworks.map((artwork: any) => `
                        ${renderArtworkCard(artwork)}
                    `).join('') : '<div class="col-span-full text-center py-20 text-gray-400">프리미엄 작품이 없습니다</div>'}
                </div>
            </div>

            <!-- 전시 중 작품 -->
            <div id="category-exhibition" class="category-content hidden">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-3xl font-black text-white flex items-center">
                        <i class="fas fa-building text-green-400 mr-3"></i>
                        전시 중인 작품
                    </h3>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${exhibitionArtworks.length > 0 ? exhibitionArtworks.map((artwork: any) => `
                        ${renderArtworkCard(artwork)}
                    `).join('') : '<div class="col-span-full text-center py-20 text-gray-400">전시 중인 작품이 없습니다</div>'}
                </div>
            </div>

            <!-- 전체 작품 -->
            <div id="category-all" class="category-content hidden">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-3xl font-black text-white flex items-center">
                        <i class="fas fa-th text-gray-400 mr-3"></i>
                        전체 작품 (${artworks.length}개)
                    </h3>
                </div>
                
                <!-- 검색 및 필터 -->
                <div class="card-nft rounded-2xl p-6 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                        <div class="md:col-span-5">
                            <div class="relative">
                                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                                <input type="text" id="searchInput" placeholder="작품명, 작가명 검색..." 
                                    class="w-full pl-12 pr-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500"
                                    onkeyup="filterGallery()"/>
                            </div>
                        </div>
                        <div class="md:col-span-3">
                            <select id="categoryFilter" onchange="filterGallery()" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white">
                                <option value="">전체 카테고리</option>
                                <option value="디지털아트">디지털아트</option>
                                <option value="회화">회화</option>
                                <option value="조각">조각</option>
                                <option value="사진">사진</option>
                            </select>
                        </div>
                        <div class="md:col-span-4">
                            <select id="sortOrder" onchange="sortGallery()" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white">
                                <option value="newest">최신순</option>
                                <option value="oldest">오래된순</option>
                                <option value="price_high">가격 높은순</option>
                                <option value="price_low">가격 낮은순</option>
                                <option value="score_high">평가 높은순</option>
                                <option value="popular">인기순</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="galleryGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${artworks.map((artwork: any) => `
                        ${renderArtworkCard(artwork)}
                    `).join('')}
                </div>
            </div>
        </div>
    </section>

    <script>
      function showCategory(category) {
        // Hide all categories
        document.querySelectorAll('.category-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.category-tab').forEach(el => el.classList.remove('active'));
        
        // Show selected category
        document.getElementById('category-' + category).classList.remove('hidden');
        document.getElementById('tab-' + category).classList.add('active');
      }

      function filterGallery() {
        const searchValue = document.getElementById('searchInput').value.toLowerCase();
        const categoryValue = document.getElementById('categoryFilter').value;
        const items = document.querySelectorAll('#galleryGrid .gallery-item');
        
        items.forEach(item => {
          const title = item.dataset.title || '';
          const artist = item.dataset.artist || '';
          const category = item.dataset.category || '';
          
          const matchesSearch = title.includes(searchValue) || artist.includes(searchValue);
          const matchesCategory = !categoryValue || category === categoryValue;
          
          if (matchesSearch && matchesCategory) {
            item.style.display = 'block';
          } else {
            item.style.display = 'none';
          }
        });
      }

      function sortGallery() {
        const sortValue = document.getElementById('sortOrder').value;
        const grid = document.getElementById('galleryGrid');
        const items = Array.from(grid.querySelectorAll('.gallery-item'));
        
        items.sort((a, b) => {
          switch(sortValue) {
            case 'newest':
              return new Date(b.dataset.created) - new Date(a.dataset.created);
            case 'oldest':
              return new Date(a.dataset.created) - new Date(b.dataset.created);
            case 'price_high':
              return parseFloat(b.dataset.price || 0) - parseFloat(a.dataset.price || 0);
            case 'price_low':
              return parseFloat(a.dataset.price || 0) - parseFloat(b.dataset.price || 0);
            case 'score_high':
              return parseFloat(b.dataset.score || 0) - parseFloat(a.dataset.score || 0);
            case 'popular':
              return parseFloat(b.dataset.views || 0) - parseFloat(a.dataset.views || 0);
            default:
              return 0;
          }
        });
        
        items.forEach(item => grid.appendChild(item));
      }
    </script>

    <style>
      .category-tab {
        background: rgba(255, 255, 255, 0.03);
        color: #9ca3af;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .category-tab:hover {
        background: rgba(255, 255, 255, 0.08);
        color: white;
      }
      .category-tab.active {
        background: linear-gradient(135deg, rgba(168, 85, 247, 0.2) 0%, rgba(6, 182, 212, 0.2) 100%);
        border-color: rgba(168, 85, 247, 0.5);
        color: white;
      }
      .category-content {
        animation: fadeIn 0.5s ease-in;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
    `
    
    // Helper function to render artwork card
    function renderArtworkCard(artwork: any) {
      return `
        <a href="/artwork/${artwork.id}" 
           class="gallery-item card-nft rounded-3xl overflow-hidden group hover:scale-105 transition-all duration-300"
           data-id="${artwork.id}"
           data-category="${artwork.category || ''}"
           data-price="${artwork.estimated_value || 0}"
           data-score="${artwork.valuation_score || 0}"
           data-minted="${artwork.is_minted ? '1' : '0'}"
           data-artist="${(artwork.artist_name || '').toLowerCase()}"
           data-title="${(artwork.title || '').toLowerCase()}"
           data-views="${artwork.views_count || 0}"
           data-created="${artwork.created_at}">
            <!-- Image -->
            <div class="relative aspect-square bg-gradient-to-br from-gray-900 to-gray-800 overflow-hidden">
                <img src="${artwork.image_url}" alt="${artwork.title}" 
                     class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" 
                     onerror="this.src='https://via.placeholder.com/600x600/1a1a1a/8b5cf6?text=No+Image'">
                
                <!-- Badges -->
                <div class="absolute top-4 right-4 flex flex-col gap-2">
                    ${artwork.is_minted ? `
                    <span class="px-3 py-1.5 bg-gradient-to-r from-purple-600 to-cyan-500 text-white text-xs font-bold rounded-full flex items-center backdrop-blur-sm">
                        <i class="fas fa-cube mr-1.5"></i>NFT
                    </span>
                    ` : ''}
                    ${artwork.exhibition_id ? `
                    <span class="px-3 py-1.5 bg-green-600 text-white text-xs font-bold rounded-full flex items-center backdrop-blur-sm">
                        <i class="fas fa-building mr-1.5"></i>전시중
                    </span>
                    ` : ''}
                    ${(artwork.valuation_score || 0) >= 80 ? `
                    <span class="px-3 py-1.5 bg-yellow-600 text-white text-xs font-bold rounded-full flex items-center backdrop-blur-sm">
                        <i class="fas fa-star mr-1.5"></i>${artwork.valuation_score}점
                    </span>
                    ` : ''}
                </div>

                <!-- Blockchain Verified -->
                ${artwork.blockchain_hash ? `
                <div class="absolute top-4 left-4">
                    <span class="px-3 py-1.5 bg-black/60 text-green-400 text-xs font-bold rounded-full flex items-center backdrop-blur-sm">
                        <i class="fas fa-check-circle mr-1.5"></i>인증됨
                    </span>
                </div>
                ` : ''}

                <!-- Hover Overlay -->
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/0 to-black/0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-6">
                    <div class="space-y-2 w-full">
                        <div class="flex items-center justify-between text-white text-sm">
                            <span class="flex items-center">
                                <i class="fas fa-eye mr-2"></i>${artwork.views_count || 0} 조회
                            </span>
                            <span class="flex items-center">
                                <i class="fas fa-heart mr-2"></i>${artwork.likes_count || 0} 좋아요
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="p-5">
                <!-- Artist Info -->
                <div class="flex items-center mb-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-cyan-500 flex items-center justify-center text-white text-xs font-bold mr-2">
                        ${(artwork.artist_name || 'A')[0].toUpperCase()}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-gray-400 text-xs truncate">${artwork.artist_name || '알 수 없음'}</p>
                    </div>
                </div>

                <!-- Title -->
                <h3 class="text-xl font-black text-white mb-2 line-clamp-2 group-hover:text-gradient transition-all">
                    ${artwork.title || '제목 없음'}
                </h3>

                <!-- Category & Price -->
                <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500 px-2 py-1 bg-white/5 rounded">${artwork.category || '미분류'}</span>
                    <span class="text-sm font-bold text-gradient">
                        ${artwork.estimated_value ? (artwork.estimated_value / 10000).toLocaleString() + '만원' : '가격 미정'}
                    </span>
                </div>

                <!-- Valuation Score -->
                ${artwork.valuation_score ? `
                <div class="mt-3 pt-3 border-t border-white/10">
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-gray-400">가치 평가</span>
                        <span class="font-bold ${artwork.valuation_score >= 80 ? 'text-yellow-400' : artwork.valuation_score >= 60 ? 'text-green-400' : 'text-gray-400'}">
                            ${artwork.valuation_score}점 / 100점
                        </span>
                    </div>
                    <div class="mt-2 h-2 bg-gray-800 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-purple-500 to-cyan-500" style="width: ${artwork.valuation_score}%"></div>
                    </div>
                </div>
                ` : ''}
            </div>
        </a>
      `
    }
    
    return c.html(getLayout(content, 'NFT Gallery - GALLERYPIA'))
  } catch (error: any) {
    return c.html(getLayout('<div class="py-20 text-center text-red-500">데이터를 불러오는데 실패했습니다: ' + error.message + '</div>'))
  }
})                                    <div class="font-bold text-sm text-white">${formatPrice(artwork.current_price)}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </a>
                `).join('')}
            </div>
            
            <!-- 결과 없음 -->
            <div id="noResults" class="hidden text-center py-20">
                <i class="fas fa-search text-6xl text-gray-700 mb-4"></i>
                <p class="text-gray-400 text-lg">검색 결과가 없습니다</p>
                <button onclick="resetFilters()" class="mt-4 px-6 py-3 bg-purple-500 bg-opacity-20 hover:bg-opacity-30 text-purple-400 rounded-lg font-semibold transition">
                    필터 초기화
                </button>
            </div>
        </div>
    </section>
    
    <script src="/static/gallery.js"></script>
    `;
    
    return c.html(getLayout(content, 'NFT Gallery - GALLERYPIA'))
  } catch (error: any) {
    return c.html(getLayout('<div class="py-20 text-center text-red-500">데이터를 불러오는데 실패했습니다: ' + error.message + '</div>'))
  }
})

// 작품 상세 페이지 - 가치평가 정보 포함
app.get('/artwork/:id', async (c) => {
  try {
    const id = c.req.param('id')
    const db = c.env.DB
    
    // Get artwork with artist info
    const art = await db.prepare(`
      SELECT a.*, ar.name as artist_name, ar.profile_image as artist_profile_image, ar.bio as artist_bio
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.id = ?
    `).bind(id).first()
    
    if (!art) {
      return c.html(getLayout('<div class="py-20 text-center text-red-500">작품을 찾을 수 없습니다.</div>'))
    }
    
    // Get valuation history
    const historyData = await db.prepare(`
      SELECT * FROM artwork_final_valuation WHERE artwork_id = ? ORDER BY calculated_at DESC LIMIT 10
    `).bind(id).all()
    const history = { data: historyData.results }
    
    // v6.0: Get ownership info
    const ownershipData = await db.prepare(`
      SELECT ao.*, u.full_name, u.username, u.profile_image
      FROM artwork_ownership ao
      LEFT JOIN users u ON ao.owner_id = u.id
      WHERE ao.artwork_id = ? AND ao.is_current_owner = 1
      ORDER BY ao.acquired_at DESC
      LIMIT 1
    `).bind(id).first()
    const ownership = { data: ownershipData }
    
    // v6.0: Get reviews
    const reviewsData = await db.prepare(`
      SELECT r.*, u.username, u.full_name, u.profile_image
      FROM artwork_reviews r
      LEFT JOIN users u ON r.user_id = u.id
      WHERE r.artwork_id = ?
      ORDER BY r.created_at DESC
      LIMIT 10
    `).bind(id).all()
    const reviews = { data: reviewsData.results }
    
    // Get extended info
    const extendedInfo = await db.prepare(`
      SELECT * FROM artwork_extended_info WHERE artwork_id = ?
    `).bind(id).first()
    
    const content = `
    <section class="py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- 뒤로가기 -->
            <a href="/gallery" class="inline-flex items-center text-gray-400 hover:text-white mb-8 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i> 갤러리로 돌아가기
            </a>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                <!-- 작품 이미지 -->
                <div class="space-y-6">
                    <div class="card-nft rounded-3xl overflow-hidden">
                        <div class="aspect-square bg-gray-900">
                            <img src="${art.image_url}" alt="${art.title}" class="w-full h-full object-cover">
                        </div>
                    </div>
                    
                    ${art.is_minted ? `
                    <div class="card-nft rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                            <i class="fas fa-cube text-gradient mr-2"></i>
                            NFT 정보
                        </h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">블록체인</span>
                                <span class="text-white font-semibold">${art.blockchain_network || 'Ethereum'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">토큰 ID</span>
                                <span class="text-white font-mono text-xs">${art.nft_token_id || 'N/A'}</span>
                            </div>
                            ${art.nft_contract_address ? `
                            <div class="flex justify-between items-start">
                                <span class="text-gray-400">컨트랙트</span>
                                <span class="text-white font-mono text-xs break-all text-right ml-4">${art.nft_contract_address.substring(0, 10)}...${art.nft_contract_address.substring(art.nft_contract_address.length - 8)}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <!-- 작품 정보 및 가치평가 -->
                <div class="space-y-8">
                    <!-- 기본 정보 -->
                    <div>
                        <div class="flex items-center gap-3 mb-4">
                            ${art.is_minted ? '<span class="px-3 py-1.5 bg-gradient-to-r from-purple-600 to-cyan-500 text-white text-xs font-bold rounded-full flex items-center w-fit"><i class="fas fa-cube mr-1.5"></i>NFT</span>' : ''}
                            <span class="px-3 py-1.5 bg-white bg-opacity-5 text-gray-300 text-xs font-semibold rounded-full">${art.category}</span>
                        </div>
                        <h1 class="text-5xl font-black text-white mb-4">${art.title}</h1>
                        <p class="text-gray-400 text-lg leading-relaxed mb-6">${art.description || '작품 설명이 없습니다.'}</p>
                        
                        <!-- 아티스트 정보 -->
                        <div class="flex items-center gap-4 p-4 rounded-2xl bg-white bg-opacity-5 neon-border">
                            <img src="${art.artist_profile_image}" class="w-14 h-14 rounded-full object-cover" alt="${art.artist_name}">
                            <div>
                                <div class="text-xs text-gray-500 mb-1">Artist</div>
                                <div class="text-white font-bold text-lg">${art.artist_name}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 가치평가 시스템 -->
                    <div class="card-nft rounded-3xl p-8 space-y-8">
                        <div class="text-center border-b border-white border-opacity-10 pb-6">
                            <div class="text-sm text-gray-400 mb-2">AI 기반 작품 가치 산정</div>
                            <div class="text-5xl font-black text-gradient mb-2">${formatPrice(art.estimated_value)}</div>
                            <div class="text-xs text-gray-500">Based on quantitative and qualitative analysis</div>
                        </div>
                        
                        <!-- 정량적 평가 (30%) -->
                        <div>
                            <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                                <i class="fas fa-chart-line text-cyan-400 mr-2"></i>
                                정량적 평가 <span class="text-gray-500 text-sm ml-2">(30%)</span>
                            </h3>
                            <div class="space-y-4">
                                <!-- 시장 수요 -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-gray-400">시장 수요 (50%)</span>
                                        <span class="text-sm font-bold text-white">${art.market_demand_score}/100</span>
                                    </div>
                                    <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-cyan-500 to-blue-500" style="width: ${art.market_demand_score}%"></div>
                                    </div>
                                </div>
                                
                                <!-- 희소성 -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-gray-400">희소성 (50%)</span>
                                        <span class="text-sm font-bold text-white">${art.rarity_score}/100</span>
                                    </div>
                                    <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500" style="width: ${art.rarity_score}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 정성적 평가 (70%) -->
                        <div>
                            <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                                <i class="fas fa-palette text-purple-400 mr-2"></i>
                                정성적 평가 <span class="text-gray-500 text-sm ml-2">(70%)</span>
                            </h3>
                            <div class="space-y-4">
                                <!-- 예술적 완성도 -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-gray-400">예술적 완성도 (35%)</span>
                                        <span class="text-sm font-bold text-white">${art.artistic_quality_score}/100</span>
                                    </div>
                                    <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-yellow-500 to-orange-500" style="width: ${art.artistic_quality_score}%"></div>
                                    </div>
                                </div>
                                
                                <!-- 독창성 -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-gray-400">독창성 (30%)</span>
                                        <span class="text-sm font-bold text-white">${art.originality_score}/100</span>
                                    </div>
                                    <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-green-500 to-emerald-500" style="width: ${art.originality_score}%"></div>
                                    </div>
                                </div>
                                
                                <!-- 문화적 의의 -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-gray-400">문화적 의의 (20%)</span>
                                        <span class="text-sm font-bold text-white">${art.cultural_significance_score}/100</span>
                                    </div>
                                    <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-pink-500 to-rose-500" style="width: ${art.cultural_significance_score}%"></div>
                                    </div>
                                </div>
                                
                                <!-- 기술적 우수성 -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-gray-400">기술적 우수성 (15%)</span>
                                        <span class="text-sm font-bold text-white">${art.technical_excellence_score}/100</span>
                                    </div>
                                    <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500" style="width: ${art.technical_excellence_score}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 평가 공식 설명 -->
                        <div class="bg-white bg-opacity-5 rounded-2xl p-6">
                            <h4 class="text-sm font-bold text-white mb-3 flex items-center">
                                <i class="fas fa-calculator text-gold mr-2"></i>
                                가치 산출 공식
                            </h4>
                            <div class="text-xs text-gray-400 space-y-2">
                                <div>기본 가치 = 재료비(${formatPrice(art.base_material_cost)}) + 작업시간(${art.labor_hours}h) × 50,000원</div>
                                <div>정량 점수 = (시장수요 × 0.5 + 희소성 × 0.5) × 0.3</div>
                                <div>정성 점수 = (완성도 × 0.35 + 독창성 × 0.3 + 문화의의 × 0.2 + 기술 × 0.15) × 0.7</div>
                                <div class="pt-2 border-t border-white border-opacity-10 mt-2 font-bold text-white">
                                    최종 가치 = 기본 가치 × (1 + 종합점수/10)
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 평가 이력 -->
                    ${history.data && history.data.length > 0 ? `
                    <div class="card-nft rounded-3xl p-8">
                        <h3 class="text-lg font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-history text-gradient mr-2"></i>
                            가치평가 이력
                        </h3>
                        <div class="space-y-4">
                            ${history.data.map((h: any) => `
                            <div class="bg-white bg-opacity-5 rounded-xl p-4">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <div class="text-white font-semibold">${h.evaluator_name || '익명 평가자'}</div>
                                        <div class="text-xs text-gray-500">${h.evaluator_role || '일반'} · ${new Date(h.evaluated_at).toLocaleDateString('ko-KR')}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-gray-400">평가액</div>
                                        <div class="font-bold text-gradient">${formatPrice(h.estimated_value)}</div>
                                    </div>
                                </div>
                                ${h.evaluation_notes ? `<p class="text-sm text-gray-400 italic">&quot;${h.evaluation_notes}&quot;</p>` : ''}
                            </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- 작품 상세 정보 -->
                    <div class="card-nft rounded-3xl p-8">
                        <h3 class="text-lg font-bold text-white mb-6">작품 상세 정보</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <div class="text-gray-500 mb-1">제작 연도</div>
                                <div class="text-white font-semibold">${art.creation_year || 'N/A'}</div>
                            </div>
                            <div>
                                <div class="text-gray-500 mb-1">기법</div>
                                <div class="text-white font-semibold">${art.technique || 'N/A'}</div>
                            </div>
                            ${art.size_width && art.size_height ? `
                            <div>
                                <div class="text-gray-500 mb-1">크기</div>
                                <div class="text-white font-semibold">${art.size_width} × ${art.size_height} cm</div>
                            </div>
                            ` : ''}
                            <div>
                                <div class="text-gray-500 mb-1">상태</div>
                                <div class="text-white font-semibold">${art.status === 'approved' ? '승인됨' : art.status === 'minted' ? 'NFT 발행' : '검토중'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- v6.0: 소유자 정보 -->
                    ${ownership.data ? `
                    <div class="card-nft rounded-3xl p-8">
                        <h3 class="text-lg font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-user-circle text-gradient mr-2"></i>
                            현재 소유자
                        </h3>
                        <div class="flex items-center gap-4 p-4 rounded-2xl bg-white bg-opacity-5">
                            <img src="${ownership.data.profile_image || 'https://via.placeholder.com/80'}" 
                                 class="w-16 h-16 rounded-full object-cover" 
                                 alt="${ownership.data.full_name}">
                            <div class="flex-1">
                                <div class="text-white font-bold text-lg">${ownership.data.full_name || ownership.data.username}</div>
                                <div class="text-xs text-gray-500">소유 시작: ${new Date(ownership.data.acquired_at).toLocaleDateString('ko-KR')}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500 mb-1">획득가</div>
                                <div class="font-bold text-gradient">${formatPrice(ownership.data.acquisition_price)}</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- 액션 버튼 -->
                    <div class="flex gap-4">
                        <button onclick="handlePurchase(${id})" class="flex-1 btn-neon px-8 py-4 rounded-2xl text-white font-bold text-lg">
                            <i class="fas fa-shopping-cart mr-2"></i>
                            구매하기
                        </button>
                        <button onclick="handleBidding(${id})" class="flex-1 px-8 py-4 rounded-2xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold hover:opacity-90 transition-all">
                            <i class="fas fa-gavel mr-2"></i>
                            경매 참여
                        </button>
                        <button onclick="handleLike(${id})" class="px-8 py-4 rounded-2xl bg-white bg-opacity-5 text-white font-bold hover:bg-opacity-10 transition-all neon-border">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- v6.0: 리뷰 & 평가 섹션 -->
            <div class="mt-20">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-black text-white flex items-center">
                        <i class="fas fa-star text-gradient mr-3"></i>
                        사용자 리뷰
                    </h2>
                    <button onclick="openReviewModal()" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 text-white rounded-xl font-semibold hover:opacity-90 transition">
                        <i class="fas fa-edit mr-2"></i>
                        리뷰 작성
                    </button>
                </div>
                
                <!-- 리뷰 통계 -->
                ${reviews.data && reviews.data.length > 0 ? `
                <div class="card-nft rounded-3xl p-8 mb-8">
                    <div class="grid md:grid-cols-3 gap-8">
                        <div class="text-center">
                            <div class="text-5xl font-black text-gradient mb-2">${art.average_rating ? art.average_rating.toFixed(1) : '0.0'}</div>
                            <div class="flex justify-center mb-2">
                                ${[1,2,3,4,5].map(star => `
                                    <i class="fas fa-star ${star <= Math.round(art.average_rating || 0) ? 'text-yellow-400' : 'text-gray-600'}"></i>
                                `).join('')}
                            </div>
                            <div class="text-gray-400 text-sm">${reviews.data.length}개의 리뷰</div>
                        </div>
                        <div class="md:col-span-2">
                            <div class="space-y-2">
                                ${[5,4,3,2,1].map(rating => {
                                  const count = reviews.data.filter((r: any) => r.rating === rating).length
                                  const percentage = reviews.data.length > 0 ? (count / reviews.data.length) * 100 : 0
                                  return `
                                    <div class="flex items-center gap-3">
                                        <div class="text-sm text-gray-400 w-8">${rating}점</div>
                                        <div class="flex-1 h-2 bg-gray-800 rounded-full overflow-hidden">
                                            <div class="h-full bg-gradient-to-r from-yellow-400 to-yellow-600" style="width: ${percentage}%"></div>
                                        </div>
                                        <div class="text-sm text-gray-500 w-12 text-right">${count}개</div>
                                    </div>
                                  `
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 리뷰 목록 -->
                <div class="space-y-6">
                    ${reviews.data.map((review: any) => `
                        <div class="card-nft rounded-2xl p-6">
                            <div class="flex items-start gap-4">
                                <img src="${review.profile_image || 'https://via.placeholder.com/60'}" 
                                     class="w-12 h-12 rounded-full object-cover" 
                                     alt="${review.full_name}">
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-2">
                                        <div>
                                            <div class="text-white font-bold">${review.full_name || review.username}</div>
                                            <div class="flex items-center gap-2 text-sm text-gray-400">
                                                <div class="flex">
                                                    ${[1,2,3,4,5].map(star => `
                                                        <i class="fas fa-star text-xs ${star <= review.rating ? 'text-yellow-400' : 'text-gray-600'}"></i>
                                                    `).join('')}
                                                </div>
                                                <span>·</span>
                                                <span>${new Date(review.created_at).toLocaleDateString('ko-KR')}</span>
                                            </div>
                                        </div>
                                    </div>
                                    ${review.review_text ? `
                                        <p class="text-gray-300 mt-3 leading-relaxed">${review.review_text}</p>
                                    ` : ''}
                                    ${review.artistic_value_rating || review.investment_potential_rating ? `
                                        <div class="flex gap-4 mt-4 pt-4 border-t border-white border-opacity-10">
                                            ${review.artistic_value_rating ? `
                                                <div class="text-sm">
                                                    <span class="text-gray-500">예술성:</span>
                                                    <span class="text-gradient font-bold ml-2">${review.artistic_value_rating}/5</span>
                                                </div>
                                            ` : ''}
                                            ${review.investment_potential_rating ? `
                                                <div class="text-sm">
                                                    <span class="text-gray-500">투자가치:</span>
                                                    <span class="text-gradient font-bold ml-2">${review.investment_potential_rating}/5</span>
                                                </div>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                ` : `
                <div class="card-nft rounded-3xl p-12 text-center">
                    <i class="fas fa-comments text-6xl text-gray-600 mb-4"></i>
                    <p class="text-gray-400 text-lg">아직 리뷰가 없습니다</p>
                    <p class="text-gray-500 text-sm mt-2">첫 번째 리뷰를 작성해보세요!</p>
                </div>
                `}
            </div>
        </div>
    </section>
    
    <!-- 리뷰 작성 모달 -->
    <div id="reviewModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="card-nft rounded-3xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-white">리뷰 작성</h3>
                <button onclick="closeReviewModal()" class="text-gray-400 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="reviewForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-3">전체 평점 *</label>
                    <div class="flex gap-2">
                        ${[1,2,3,4,5].map(star => `
                            <button type="button" onclick="setRating(${star})" 
                                    class="rating-star text-3xl text-gray-600 hover:text-yellow-400 transition">
                                <i class="fas fa-star"></i>
                            </button>
                        `).join('')}
                    </div>
                    <input type="hidden" id="reviewRating" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">리뷰 내용</label>
                    <textarea id="reviewText" rows="5" 
                              class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white resize-none focus:border-purple-500 focus:outline-none"
                              placeholder="작품에 대한 솔직한 의견을 남겨주세요"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">예술적 가치</label>
                        <select id="artisticValue" 
                                class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-purple-500 focus:outline-none">
                            <option value="">선택 안함</option>
                            ${[1,2,3,4,5].map(n => `<option value="${n}">${n}점</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">투자 가치</label>
                        <select id="investmentValue" 
                                class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-purple-500 focus:outline-none">
                            <option value="">선택 안함</option>
                            ${[1,2,3,4,5].map(n => `<option value="${n}">${n}점</option>`).join('')}
                        </select>
                    </div>
                </div>
                
                <div class="flex gap-4">
                    <button type="button" onclick="closeReviewModal()" 
                            class="flex-1 py-3 bg-gray-800 hover:bg-gray-700 text-white rounded-xl transition">
                        취소
                    </button>
                    <button type="submit" 
                            class="flex-1 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 text-white rounded-xl font-semibold hover:opacity-90 transition">
                        리뷰 등록
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 구매하기 모달 -->
    <div id="purchaseModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="card-nft rounded-3xl p-8 max-w-xl w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-white">작품 구매하기</h3>
                <button onclick="closePurchaseModal()" class="text-gray-400 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-6">
                <div class="text-sm text-gray-400 mb-2">작품명</div>
                <div class="text-white font-bold text-lg">${art.title}</div>
            </div>
            
            <div class="mb-6">
                <div class="text-sm text-gray-400 mb-2">예상 가격</div>
                <div class="text-gradient font-black text-3xl">${formatPrice(art.estimated_value || 0)}</div>
            </div>
            
            <form id="purchaseForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">제안 가격 (ETH) *</label>
                    <input type="number" id="offerPrice" step="0.001" min="0.001" required
                           class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-purple-500 focus:outline-none"
                           placeholder="0.000" />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">메시지 (선택)</label>
                    <textarea id="purchaseMessage" rows="3"
                              class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white resize-none focus:border-purple-500 focus:outline-none"
                              placeholder="판매자에게 전달할 메시지를 입력하세요"></textarea>
                </div>
                
                <div class="bg-purple-500 bg-opacity-10 border border-purple-500 border-opacity-30 rounded-xl p-4">
                    <div class="text-sm text-purple-300">
                        <i class="fas fa-info-circle mr-2"></i>
                        구매 제안은 판매자에게 전송되며, 판매자가 수락하면 거래가 진행됩니다.
                    </div>
                </div>
                
                <div class="flex gap-4 pt-2">
                    <button type="button" onclick="closePurchaseModal()" 
                            class="flex-1 py-3 bg-gray-800 hover:bg-gray-700 text-white rounded-xl transition">
                        취소
                    </button>
                    <button type="submit" 
                            class="flex-1 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 text-white rounded-xl font-semibold hover:opacity-90 transition">
                        제안 보내기
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 경매 참여 모달 -->
    <div id="biddingModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="card-nft rounded-3xl p-8 max-w-xl w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-white">경매 입찰</h3>
                <button onclick="closeBiddingModal()" class="text-gray-400 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="auctionInfo" class="space-y-4 mb-6">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin text-3xl text-gray-500"></i>
                    <div class="text-gray-400 mt-2">경매 정보를 불러오는 중...</div>
                </div>
            </div>
            
            <form id="biddingForm" class="hidden space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">입찰 금액 (ETH) *</label>
                    <input type="number" id="bidAmount" step="0.001" min="0.001" required
                           class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-amber-500 focus:outline-none"
                           placeholder="0.000" />
                    <div class="text-xs text-gray-500 mt-1">현재가보다 높은 금액을 입력하세요</div>
                </div>
                
                <div class="bg-amber-500 bg-opacity-10 border border-amber-500 border-opacity-30 rounded-xl p-4">
                    <div class="text-sm text-amber-300">
                        <i class="fas fa-gavel mr-2"></i>
                        입찰은 취소할 수 없으며, 경매 종료 시 최고 입찰자가 낙찰됩니다.
                    </div>
                </div>
                
                <div class="flex gap-4 pt-2">
                    <button type="button" onclick="closeBiddingModal()" 
                            class="flex-1 py-3 bg-gray-800 hover:bg-gray-700 text-white rounded-xl transition">
                        취소
                    </button>
                    <button type="submit" 
                            class="flex-1 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl font-semibold hover:opacity-90 transition">
                        입찰하기
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
      const ARTWORK_ID = ${id};
      
      function formatPrice(price) {
        if (price >= 100000000) return (price / 100000000).toFixed(1) + '억원';
        else if (price >= 10000) return (price / 10000).toFixed(0) + '만원';
        return price.toLocaleString() + '원';
      }
      
      // 리뷰 모달
      let selectedRating = 0;
      
      function openReviewModal() {
        document.getElementById('reviewModal').classList.remove('hidden');
      }
      
      function closeReviewModal() {
        document.getElementById('reviewModal').classList.add('hidden');
        document.getElementById('reviewForm').reset();
        selectedRating = 0;
        updateStarDisplay();
      }
      
      function setRating(rating) {
        selectedRating = rating;
        document.getElementById('reviewRating').value = rating;
        updateStarDisplay();
      }
      
      function updateStarDisplay() {
        const stars = document.querySelectorAll('.rating-star');
        stars.forEach((star, index) => {
          if (index < selectedRating) {
            star.classList.add('text-yellow-400');
            star.classList.remove('text-gray-600');
          } else {
            star.classList.add('text-gray-600');
            star.classList.remove('text-yellow-400');
          }
        });
      }
      
      // 리뷰 제출
      document.getElementById('reviewForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const sessionToken = localStorage.getItem('session_token');
        if (!sessionToken) {
          alert('로그인이 필요합니다.');
          window.location.href = '/login';
          return;
        }
        
        if (!selectedRating) {
          alert('평점을 선택해주세요.');
          return;
        }
        
        try {
          const response = await axios.post('/api/artworks/' + ${id} + '/reviews', {
            rating: selectedRating,
            review_text: document.getElementById('reviewText').value,
            artistic_value_rating: parseInt(document.getElementById('artisticValue').value) || null,
            investment_potential_rating: parseInt(document.getElementById('investmentValue').value) || null
          }, {
            headers: {
              'Authorization': 'Bearer ' + sessionToken
            }
          });
          
          if (response.data.success) {
            alert('리뷰가 등록되었습니다!');
            closeReviewModal();
            location.reload();
          } else {
            alert('리뷰 등록 실패: ' + response.data.message);
          }
        } catch (error) {
          console.error('Review submission error:', error);
          alert('리뷰 등록 중 오류가 발생했습니다: ' + (error.response?.data?.message || error.message));
        }
      });
      
      // 구매/경매/좋아요 핸들러
      function handlePurchase(artworkId) {
        const sessionToken = localStorage.getItem('session_token');
        if (!sessionToken) {
          alert('로그인이 필요합니다.');
          window.location.href = '/login';
          return;
        }
        document.getElementById('purchaseModal').classList.remove('hidden');
      }
      
      function closePurchaseModal() {
        document.getElementById('purchaseModal').classList.add('hidden');
        document.getElementById('purchaseForm').reset();
      }
      
      async function handleBidding(artworkId) {
        const sessionToken = localStorage.getItem('session_token');
        if (!sessionToken) {
          alert('로그인이 필요합니다.');
          window.location.href = '/login';
          return;
        }
        
        document.getElementById('biddingModal').classList.remove('hidden');
        
        // 경매 정보 불러오기
        try {
          const response = await axios.get('/api/artworks/' + artworkId + '/auction');
          
          if (response.data.success && response.data.data) {
            const auction = response.data.data;
            const recentBids = response.data.recent_bids || [];
            
            const endTime = new Date(auction.end_time);
            const now = new Date();
            const timeLeft = endTime - now;
            const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
            const daysLeft = Math.floor(hoursLeft / 24);
            
            let timeLeftText = '';
            if (timeLeft < 0) {
              timeLeftText = '<span class="text-red-400">경매 종료</span>';
            } else if (daysLeft > 0) {
              timeLeftText = daysLeft + '일 ' + (hoursLeft % 24) + '시간 남음';
            } else {
              timeLeftText = hoursLeft + '시간 남음';
            }
            
            document.getElementById('auctionInfo').innerHTML = \`
              <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-900 rounded-xl p-4">
                  <div class="text-xs text-gray-500 mb-1">시작가</div>
                  <div class="text-white font-bold">\${auction.starting_price} ETH</div>
                </div>
                <div class="bg-gray-900 rounded-xl p-4">
                  <div class="text-xs text-gray-500 mb-1">현재가</div>
                  <div class="text-gradient font-bold text-lg">\${auction.current_price} ETH</div>
                </div>
                <div class="bg-gray-900 rounded-xl p-4">
                  <div class="text-xs text-gray-500 mb-1">입찰 수</div>
                  <div class="text-white font-bold">\${auction.total_bids}회</div>
                </div>
                <div class="bg-gray-900 rounded-xl p-4">
                  <div class="text-xs text-gray-500 mb-1">남은 시간</div>
                  <div class="text-white font-bold">\${timeLeftText}</div>
                </div>
              </div>
              \${recentBids.length > 0 ? \`
                <div class="mt-4">
                  <div class="text-sm text-gray-400 mb-2">최근 입찰</div>
                  <div class="space-y-2 max-h-32 overflow-y-auto">
                    \${recentBids.map(bid => \`
                      <div class="flex justify-between items-center text-sm bg-gray-900 rounded-lg p-2">
                        <span class="text-white">\${bid.full_name || bid.username}</span>
                        <span class="text-gradient font-bold">\${bid.bid_amount} ETH</span>
                      </div>
                    \`).join('')}
                  </div>
                </div>
              \` : ''}
            \`;
            
            // 최소 입찰가 설정
            document.getElementById('bidAmount').min = parseFloat(auction.current_price) + 0.001;
            document.getElementById('bidAmount').value = (parseFloat(auction.current_price) + 0.01).toFixed(3);
            
            document.getElementById('biddingForm').classList.remove('hidden');
          } else {
            document.getElementById('auctionInfo').innerHTML = \`
              <div class="text-center py-8">
                <i class="fas fa-gavel text-4xl text-gray-600 mb-3"></i>
                <div class="text-gray-400">진행 중인 경매가 없습니다</div>
                <div class="text-sm text-gray-500 mt-2">판매자가 경매를 시작하면 참여할 수 있습니다</div>
              </div>
            \`;
          }
        } catch (error) {
          console.error('Auction fetch error:', error);
          document.getElementById('auctionInfo').innerHTML = \`
            <div class="text-center py-8 text-red-400">
              <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
              <div>경매 정보를 불러올 수 없습니다</div>
            </div>
          \`;
        }
      }
      
      function closeBiddingModal() {
        document.getElementById('biddingModal').classList.add('hidden');
        document.getElementById('biddingForm').reset();
        document.getElementById('biddingForm').classList.add('hidden');
      }
      
      function handleLike(artworkId) {
        alert('좋아요 기능은 준비 중입니다.');
      }
      
      // 구매 제안 제출
      document.getElementById('purchaseForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const sessionToken = localStorage.getItem('session_token');
        if (!sessionToken) {
          alert('로그인이 필요합니다.');
          window.location.href = '/login';
          return;
        }
        
        const offerPrice = document.getElementById('offerPrice').value;
        const message = document.getElementById('purchaseMessage').value;
        
        if (!offerPrice || offerPrice <= 0) {
          alert('올바른 제안 가격을 입력하세요.');
          return;
        }
        
        try {
          const response = await axios.post('/api/artworks/' + ARTWORK_ID + '/purchase', {
            offer_price: parseFloat(offerPrice),
            message: message
          }, {
            headers: {
              'Authorization': 'Bearer ' + sessionToken
            }
          });
          
          if (response.data.success) {
            alert('구매 제안이 전송되었습니다!\\n판매자의 응답을 기다려주세요.');
            closePurchaseModal();
          } else {
            alert('구매 제안 실패: ' + response.data.message);
          }
        } catch (error) {
          console.error('Purchase offer error:', error);
          alert('구매 제안 중 오류가 발생했습니다: ' + (error.response?.data?.message || error.message));
        }
      });
      
      // 경매 입찰 제출
      document.getElementById('biddingForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const sessionToken = localStorage.getItem('session_token');
        if (!sessionToken) {
          alert('로그인이 필요합니다.');
          window.location.href = '/login';
          return;
        }
        
        const bidAmount = document.getElementById('bidAmount').value;
        
        if (!bidAmount || bidAmount <= 0) {
          alert('올바른 입찰 금액을 입력하세요.');
          return;
        }
        
        try {
          // 먼저 경매 ID를 가져와야 함
          const auctionResponse = await axios.get('/api/artworks/' + ARTWORK_ID + '/auction');
          
          if (!auctionResponse.data.success || !auctionResponse.data.data) {
            alert('경매 정보를 찾을 수 없습니다.');
            return;
          }
          
          const auctionId = auctionResponse.data.data.id;
          
          const response = await axios.post('/api/auctions/' + auctionId + '/bid', {
            bid_amount: parseFloat(bidAmount)
          }, {
            headers: {
              'Authorization': 'Bearer ' + sessionToken
            }
          });
          
          if (response.data.success) {
            alert('입찰이 완료되었습니다!\\n현재 최고 입찰자입니다.');
            closeBiddingModal();
            location.reload();
          } else {
            alert('입찰 실패: ' + response.data.message);
          }
        } catch (error) {
          console.error('Bidding error:', error);
          alert('입찰 중 오류가 발생했습니다: ' + (error.response?.data?.message || error.message));
        }
      });
    </script>
    `;
    
    return c.html(getLayout(content, `${art.title} - GALLERYPIA`))
  } catch (error: any) {
    console.error('Artwork detail error:', error)
    return c.html(getLayout(`<div class="py-20 text-center text-red-500">작품을 불러오는데 실패했습니다.<br/><small>${error.message || String(error)}</small></div>`))
  }
})

// 가치산정 페이지
// 가치산정 페이지 - 5개 모듈 시스템 (작품 이미지 + 전문가 평가 포함)
app.get('/valuation', async (c) => {
  const content = `
  <section class="py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-12">
              <h1 class="text-6xl font-black mb-4">
                  <span class="text-gradient">NFT 가치평가</span> <span class="text-white">시스템</span>
              </h1>
              <p class="text-gray-400 text-lg">작품분석 + AI평가 + 전문가 검증</p>
              
              <!-- 셀프 평가 안내 -->
              <div class="mt-6 bg-gradient-to-r from-cyan-500/10 to-purple-500/10 border border-cyan-500/30 rounded-2xl p-6 max-w-4xl mx-auto">
                  <div class="flex items-start gap-4">
                      <div class="flex-shrink-0">
                          <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-purple-600 rounded-xl flex items-center justify-center">
                              <i class="fas fa-user-edit text-white text-xl"></i>
                          </div>
                      </div>
                      <div class="flex-1">
                          <h3 class="text-xl font-bold text-white mb-2">
                              <i class="fas fa-sparkles text-cyan-400 mr-2"></i>
                              셀프 가치평가 시스템
                          </h3>
                          <p class="text-gray-300 mb-3">
                              작가 본인이 직접 작품의 가치를 평가하고 NFT로 등록할 수 있습니다.
                          </p>
                          <ul class="space-y-2 text-sm text-gray-400">
                              <li class="flex items-center">
                                  <i class="fas fa-check-circle text-green-400 mr-2"></i>
                                  <span>5개 모듈 평가 항목을 직접 입력하여 객관적 가치 산정</span>
                              </li>
                              <li class="flex items-center">
                                  <i class="fas fa-check-circle text-green-400 mr-2"></i>
                                  <span>전문가 검증 전 예상 가격 확인 가능</span>
                              </li>
                              <li class="flex items-center">
                                  <i class="fas fa-check-circle text-green-400 mr-2"></i>
                                  <span>평가 완료 후 즉시 NFT 민팅 및 등록 가능</span>
                              </li>
                              <li class="flex items-center">
                                  <i class="fas fa-coins text-amber-400 mr-2"></i>
                                  <span class="text-amber-300">전문가 평가를 받으면 보상금 (0.01-0.1 ETH) 제공</span>
                              </li>
                          </ul>
                      </div>
                  </div>
              </div>
          </div>

          <!-- 작품 이미지 섹션 -->
          <div class="grid lg:grid-cols-5 gap-8 mb-8">
              <!-- 작품 이미지 (왼쪽 2컬럼) -->
              <div class="lg:col-span-2">
                  <div class="card-nft rounded-3xl overflow-hidden sticky top-24">
                      <div class="aspect-square bg-gray-900 overflow-hidden relative group">
                          <img src="https://picsum.photos/seed/art1/800/800" 
                               alt="Cyber Dreamscape #001" 
                               class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                          <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-60"></div>
                          <div class="absolute bottom-0 left-0 right-0 p-6">
                              <h3 class="text-2xl font-bold text-white mb-2">Cyber Dreamscape #001</h3>
                              <p class="text-gray-300 text-sm mb-3">디지털아트 • 2024</p>
                              <div class="flex items-center">
                                  <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=artist1" 
                                       class="w-8 h-8 rounded-full mr-2 border border-white border-opacity-30">
                                  <span class="text-sm text-gray-300">김민준</span>
                              </div>
                          </div>
                      </div>
                      
                      <!-- 최종 산정가 (작품 이미지 아래) -->
                      <div class="p-6 bg-gradient-to-br from-purple-900/30 to-cyan-900/30">
                          <div class="text-center">
                              <div class="text-sm text-gray-400 mb-2">AI 산정 가치</div>
                              <div class="text-4xl font-black text-gradient mb-2" id="estimatedValueKRW">0.7500 ETH (₩2,250,000)</div>
                              <div class="text-sm text-gray-500 mb-4">최종 점수: <span id="finalScore" class="text-white font-bold">75.0</span>/100</div>
                              <div class="grid grid-cols-2 gap-2 text-xs">
                                  <div class="bg-black/30 rounded-lg p-2">
                                      <div class="text-gray-400">작가 업적</div>
                                      <div class="text-white font-bold" id="module1Score">85</div>
                                  </div>
                                  <div class="bg-black/30 rounded-lg p-2">
                                      <div class="text-gray-400">작품 내용</div>
                                      <div class="text-white font-bold" id="module2Score">50</div>
                                  </div>
                                  <div class="bg-black/30 rounded-lg p-2">
                                      <div class="text-gray-400">인증</div>
                                      <div class="text-white font-bold" id="module3Score">100</div>
                                  </div>
                                  <div class="bg-black/30 rounded-lg p-2">
                                      <div class="text-gray-400">전문가</div>
                                      <div class="text-white font-bold" id="module4Score">87</div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- 평가 시스템 (오른쪽 3컬럼) -->
              <div class="lg:col-span-3 space-y-6">

          <div class="grid lg:grid-cols-2 gap-8">
              
              <!-- 좌측: 모듈 1, 2, 3 -->
              <div class="space-y-6">
                  
                  <!-- 모듈 1: 작가 업적 평가 -->
                  <div class="card-nft rounded-2xl p-6">
                      <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                          <span class="w-8 h-8 bg-gradient-to-br from-purple-600 to-cyan-500 rounded-lg flex items-center justify-center mr-3 text-sm">①</span>
                          작가 업적 평가
                          <span class="ml-auto text-sm text-gray-400">α₁: <input type="number" id="weightArtist" value="0.25" step="0.05" min="0" max="1" class="w-16 px-2 py-1 bg-black border border-white border-opacity-10 rounded text-white text-center" onchange="updateWeight('Artist')"></span>
                      </h3>
                      <div class="space-y-3">
                          <div class="grid grid-cols-2 gap-3">
                              <div>
                                  <label class="text-xs text-gray-400 block mb-1">개인전 횟수</label>
                                  <input type="number" id="soloExhibitions" value="5" min="0" class="w-full px-3 py-2 bg-black border border-white border-opacity-10 rounded text-white" onchange="updateNumberInput('soloExhibitions')">
                              </div>
                              <div>
                                  <label class="text-xs text-gray-400 block mb-1">단체전 횟수</label>
                                  <input type="number" id="groupExhibitions" value="15" min="0" class="w-full px-3 py-2 bg-black border border-white border-opacity-10 rounded text-white" onchange="updateNumberInput('groupExhibitions')">
                              </div>
                              <div>
                                  <label class="text-xs text-gray-400 block mb-1">공모전 수상</label>
                                  <input type="number" id="competitionAwards" value="3" min="0" class="w-full px-3 py-2 bg-black border border-white border-opacity-10 rounded text-white" onchange="updateNumberInput('competitionAwards')">
                              </div>
                              <div>
                                  <label class="text-xs text-gray-400 block mb-1">최근 전시 연도</label>
                                  <input type="number" id="latestExhibitionYear" value="2024" min="2000" max="2025" class="w-full px-3 py-2 bg-black border border-white border-opacity-10 rounded text-white" onchange="updateNumberInput('latestExhibitionYear')">
                              </div>
                          </div>
                          <div class="flex justify-between items-center pt-2">
                              <span class="text-sm text-gray-400">모듈 점수:</span>
                              <span id="module1Score" class="text-2xl font-bold text-gradient">85</span>
                          </div>
                          <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                              <div id="bar1" class="h-full bg-gradient-to-r from-purple-500 to-cyan-500" style="width: 85%"></div>
                          </div>
                      </div>
                  </div>

                  <!-- 모듈 2: 작품 내용 평가 -->
                  <div class="card-nft rounded-2xl p-6">
                      <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                          <span class="w-8 h-8 bg-gradient-to-br from-purple-600 to-cyan-500 rounded-lg flex items-center justify-center mr-3 text-sm">②</span>
                          작품 내용 평가
                          <span class="ml-auto text-sm text-gray-400">α₂: <input type="number" id="weightArtwork" value="0.30" step="0.05" min="0" max="1" class="w-16 px-2 py-1 bg-black border border-white border-opacity-10 rounded text-white text-center" onchange="updateWeight('Artwork')"></span>
                      </h3>
                      <div class="space-y-4">
                          <div>
                              <div class="flex justify-between mb-1">
                                  <span class="text-sm text-gray-300">내용성 (주제의식, 메시지)</span>
                                  <span id="contentDepthDisplay" class="text-sm font-bold">50</span>
                              </div>
                              <input type="range" id="contentDepth" min="0" max="100" value="50" class="w-full" oninput="updateSliderValue('contentDepth', 'contentDepthDisplay')">
                          </div>
                          <div>
                              <div class="flex justify-between mb-1">
                                  <span class="text-sm text-gray-300">표현성 (기법, 시각완성도)</span>
                                  <span id="expressionDisplay" class="text-sm font-bold">50</span>
                              </div>
                              <input type="range" id="expression" min="0" max="100" value="50" class="w-full" oninput="updateSliderValue('expression', 'expressionDisplay')">
                          </div>
                          <div>
                              <div class="flex justify-between mb-1">
                                  <span class="text-sm text-gray-300">독창성 (차별성, 혁신성)</span>
                                  <span id="originalityDisplay" class="text-sm font-bold">50</span>
                              </div>
                              <input type="range" id="originality" min="0" max="100" value="50" class="w-full" oninput="updateSliderValue('originality', 'originalityDisplay')">
                          </div>
                          <div>
                              <div class="flex justify-between mb-1">
                                  <span class="text-sm text-gray-300">소장가치 (시대적의미, 미래전망)</span>
                                  <span id="collectionValueDisplay" class="text-sm font-bold">50</span>
                              </div>
                              <input type="range" id="collectionValue" min="0" max="100" value="50" class="w-full" oninput="updateSliderValue('collectionValue', 'collectionValueDisplay')">
                          </div>
                          <div class="flex justify-between items-center pt-2 border-t border-white border-opacity-10">
                              <span class="text-sm text-gray-400">모듈 점수:</span>
                              <span id="module2Score" class="text-2xl font-bold text-gradient">50</span>
                          </div>
                          <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                              <div id="bar2" class="h-full bg-gradient-to-r from-yellow-500 to-orange-500" style="width: 50%"></div>
                          </div>
                      </div>
                  </div>

                  <!-- 모듈 3: 인증 -->
                  <div class="card-nft rounded-2xl p-6">
                      <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                          <span class="w-8 h-8 bg-gradient-to-br from-purple-600 to-cyan-500 rounded-lg flex items-center justify-center mr-3 text-sm">③</span>
                          저작권/소유권 인증
                          <span class="ml-auto text-sm text-gray-400">α₃: <input type="number" id="weightCertification" value="0.15" step="0.05" min="0" max="1" class="w-16 px-2 py-1 bg-black border border-white border-opacity-10 rounded text-white text-center" onchange="updateWeight('Certification')"></span>
                      </h3>
                      <div class="space-y-3">
                          <label class="flex items-center">
                              <input type="checkbox" id="hasBlockchainHash" checked class="mr-3" onchange="updateCheckbox('hasBlockchainHash')">
                              <span class="text-sm text-gray-300">블록체인 원본 해시 등록 (+40점)</span>
                          </label>
                          <label class="flex items-center">
                              <input type="checkbox" id="hasCopyright" checked class="mr-3" onchange="updateCheckbox('hasCopyright')">
                              <span class="text-sm text-gray-300">저작권 등록번호 보유 (+40점)</span>
                          </label>
                          <label class="flex items-center">
                              <input type="checkbox" id="hasLicense" checked class="mr-3" onchange="updateCheckbox('hasLicense')">
                              <span class="text-sm text-gray-300">라이선스 범위 명시 (+20점)</span>
                          </label>
                          <div class="flex justify-between items-center pt-2 border-t border-white border-opacity-10">
                              <span class="text-sm text-gray-400">모듈 점수:</span>
                              <span id="module3Score" class="text-2xl font-bold text-gradient">100</span>
                          </div>
                          <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                              <div id="bar3" class="h-full bg-gradient-to-r from-green-500 to-emerald-500" style="width: 100%"></div>
                          </div>
                      </div>
                  </div>

              </div>

              <!-- 우측: 모듈 4, 5 및 결과 -->
              <div class="space-y-6">
                  
                  <!-- 모듈 4: 전문가 평가 -->
                  <div class="card-nft rounded-2xl p-6">
                      <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                          <span class="w-8 h-8 bg-gradient-to-br from-purple-600 to-cyan-500 rounded-lg flex items-center justify-center mr-3 text-sm">④</span>
                          전문가 정성 평가
                          <span class="ml-auto text-sm text-gray-400">α₄: <input type="number" id="weightExpert" value="0.20" step="0.05" min="0" max="1" class="w-16 px-2 py-1 bg-black border border-white border-opacity-10 rounded text-white text-center" onchange="updateWeight('Expert')"></span>
                      </h3>
                      <div class="space-y-4">
                          <p class="text-sm text-gray-400 mb-3">학예사, 디렉터, 비평가, 전공자 등의 평가 종합</p>
                          
                          <!-- 기법 완성도 -->
                          <div>
                              <div class="flex justify-between mb-1">
                                  <span class="text-sm text-gray-300">기법 완성도</span>
                                  <span id="techniqueMasteryDisplay" class="text-sm font-bold">85</span>
                              </div>
                              <input type="range" id="techniqueMastery" min="0" max="100" value="85" class="w-full" oninput="updateSliderValue('techniqueMastery', 'techniqueMasteryDisplay')">
                          </div>
                          
                          <!-- 예술사적 의미 -->
                          <div>
                              <div class="flex justify-between mb-1">
                                  <span class="text-sm text-gray-300">예술사적 의미</span>
                                  <span id="artHistoricalSignificanceDisplay" class="text-sm font-bold">90</span>
                              </div>
                              <input type="range" id="artHistoricalSignificance" min="0" max="100" value="90" class="w-full" oninput="updateSliderValue('artHistoricalSignificance', 'artHistoricalSignificanceDisplay')">
                          </div>
                          
                          <!-- 시장성 -->
                          <div>
                              <div class="flex justify-between mb-1">
                                  <span class="text-sm text-gray-300">시장성</span>
                                  <span id="marketabilityDisplay" class="text-sm font-bold">80</span>
                              </div>
                              <input type="range" id="marketability" min="0" max="100" value="80" class="w-full" oninput="updateSliderValue('marketability', 'marketabilityDisplay')">
                          </div>
                          
                          <!-- 발전 가능성 -->
                          <div>
                              <div class="flex justify-between mb-1">
                                  <span class="text-sm text-gray-300">발전 가능성</span>
                                  <span id="developmentPotentialDisplay" class="text-sm font-bold">88</span>
                              </div>
                              <input type="range" id="developmentPotential" min="0" max="100" value="88" class="w-full" oninput="updateSliderValue('developmentPotential', 'developmentPotentialDisplay')">
                          </div>
                          
                          <div class="flex justify-between items-center pt-2 border-t border-white border-opacity-10">
                              <span class="text-sm text-gray-400">모듈 점수 (평균):</span>
                              <span id="module4Score" class="text-2xl font-bold text-gradient">87</span>
                          </div>
                          <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                              <div id="bar4" class="h-full bg-gradient-to-r from-pink-500 to-rose-500" style="width: 87%"></div>
                          </div>
                      </div>
                  </div>

                  <!-- 모듈 5: 인기도 -->
                  <div class="card-nft rounded-2xl p-6">
                      <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                          <span class="w-8 h-8 bg-gradient-to-br from-purple-600 to-cyan-500 rounded-lg flex items-center justify-center mr-3 text-sm">⑤</span>
                          대중 인지도/인기도
                          <span class="ml-auto text-sm text-gray-400">α₅: <input type="number" id="weightPopularity" value="0.10" step="0.05" min="0" max="1" class="w-16 px-2 py-1 bg-black border border-white border-opacity-10 rounded text-white text-center" onchange="updateWeight('Popularity')"></span>
                      </h3>
                      <div class="space-y-3">
                          <div class="grid grid-cols-2 gap-3">
                              <div>
                                  <label class="text-xs text-gray-400 block mb-1">YouTube 조회수</label>
                                  <input type="number" id="youtubeViews" value="50000" min="0" class="w-full px-3 py-2 bg-black border border-white border-opacity-10 rounded text-white text-sm" onchange="updateNumberInput('youtubeViews')">
                              </div>
                              <div>
                                  <label class="text-xs text-gray-400 block mb-1">Instagram 반응</label>
                                  <input type="number" id="instagramEngagement" value="5000" min="0" class="w-full px-3 py-2 bg-black border border-white border-opacity-10 rounded text-white text-sm" onchange="updateNumberInput('instagramEngagement')">
                              </div>
                              <div>
                                  <label class="text-xs text-gray-400 block mb-1">플랫폼 활동</label>
                                  <input type="number" id="platformActivity" value="1000" min="0" class="w-full px-3 py-2 bg-black border border-white border-opacity-10 rounded text-white text-sm" onchange="updateNumberInput('platformActivity')">
                              </div>
                              <div>
                                  <label class="text-xs text-gray-400 block mb-1">언론 보도</label>
                                  <input type="number" id="mediaCoverage" value="5" min="0" class="w-full px-3 py-2 bg-black border border-white border-opacity-10 rounded text-white text-sm" onchange="updateNumberInput('mediaCoverage')">
                              </div>
                          </div>
                          <div>
                              <div class="flex justify-between mb-1">
                                  <span class="text-sm text-gray-300">Google Trends</span>
                                  <span id="googleTrendsDisplay" class="text-sm font-bold">70</span>
                              </div>
                              <input type="range" id="googleTrends" min="0" max="100" value="70" class="w-full" oninput="updateSliderValue('googleTrends', 'googleTrendsDisplay')">
                          </div>
                          <div class="flex justify-between items-center pt-2 border-t border-white border-opacity-10">
                              <span class="text-sm text-gray-400">모듈 점수:</span>
                              <span id="module5Score" class="text-2xl font-bold text-gradient">75</span>
                          </div>
                          <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                              <div id="bar5" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500" style="width: 75%"></div>
                          </div>
                      </div>
                  </div>

                  <!-- 가중치 합계 -->
                  <div class="card-nft rounded-2xl p-6 border-2 border-yellow-500 border-opacity-30">
                      <div class="flex items-center justify-between">
                          <div>
                              <div class="text-sm text-gray-400 mb-1">가중치 합계 (Σα)</div>
                              <div class="text-xs text-gray-500">α₁ + α₂ + α₃ + α₄ + α₅ = 1.0</div>
                          </div>
                          <div class="text-3xl font-black" id="weightSum">1.00</div>
                      </div>
                  </div>

              </div>
          </div>

          <!-- 전문가 평가 및 코멘트 섹션 -->
          <div class="mt-12">
              <h2 class="text-3xl font-black mb-6">
                  <span class="text-gradient">전문가 평가</span> <span class="text-white">& 코멘트</span>
              </h2>
              
              <div class="grid md:grid-cols-3 gap-6">
                  <!-- 큐레이터 평가 -->
                  <div class="card-nft rounded-2xl p-6">
                      <div class="flex items-center mb-4">
                          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center mr-3">
                              <i class="fas fa-palette text-white"></i>
                          </div>
                          <div>
                              <h4 class="text-lg font-bold text-white">큐레이터</h4>
                              <p class="text-xs text-gray-400">Museum Curator</p>
                          </div>
                      </div>
                      <div class="mb-4">
                          <div class="flex justify-between mb-2">
                              <span class="text-sm text-gray-400">평가 점수</span>
                              <span class="text-lg font-bold text-gradient">88/100</span>
                          </div>
                          <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                              <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500" style="width: 88%"></div>
                          </div>
                      </div>
                      <p class="text-sm text-gray-300 leading-relaxed">
                          "작품의 구성과 색채 활용이 매우 뛰어나며, 현대 미술의 새로운 가능성을 제시합니다. 
                          특히 디지털 매체를 활용한 표현 기법이 돋보입니다."
                      </p>
                      <div class="mt-4 pt-4 border-t border-white border-opacity-10 text-xs text-gray-500">
                          <i class="fas fa-calendar mr-1"></i> 2024-01-15
                      </div>
                  </div>

                  <!-- 딜러 평가 -->
                  <div class="card-nft rounded-2xl p-6">
                      <div class="flex items-center mb-4">
                          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-cyan-600 to-blue-600 flex items-center justify-center mr-3">
                              <i class="fas fa-chart-line text-white"></i>
                          </div>
                          <div>
                              <h4 class="text-lg font-bold text-white">아트딜러</h4>
                              <p class="text-xs text-gray-400">Art Dealer</p>
                          </div>
                      </div>
                      <div class="mb-4">
                          <div class="flex justify-between mb-2">
                              <span class="text-sm text-gray-400">평가 점수</span>
                              <span class="text-lg font-bold text-gradient">92/100</span>
                          </div>
                          <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                              <div class="h-full bg-gradient-to-r from-cyan-500 to-blue-500" style="width: 92%"></div>
                          </div>
                      </div>
                      <p class="text-sm text-gray-300 leading-relaxed">
                          "시장성이 매우 높으며, 컬렉터들의 관심도가 뛰어날 것으로 예상됩니다. 
                          작가의 독창적인 시각과 완성도 높은 기법이 투자 가치를 높입니다."
                      </p>
                      <div class="mt-4 pt-4 border-t border-white border-opacity-10 text-xs text-gray-500">
                          <i class="fas fa-calendar mr-1"></i> 2024-01-16
                      </div>
                  </div>

                  <!-- 전문가 평가 -->
                  <div class="card-nft rounded-2xl p-6">
                      <div class="flex items-center mb-4">
                          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-orange-600 to-red-600 flex items-center justify-center mr-3">
                              <i class="fas fa-award text-white"></i>
                          </div>
                          <div>
                              <h4 class="text-lg font-bold text-white">미술 전문가</h4>
                              <p class="text-xs text-gray-400">Art Expert</p>
                          </div>
                      </div>
                      <div class="mb-4">
                          <div class="flex justify-between mb-2">
                              <span class="text-sm text-gray-400">평가 점수</span>
                              <span class="text-lg font-bold text-gradient">85/100</span>
                          </div>
                          <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                              <div class="h-full bg-gradient-to-r from-orange-500 to-red-500" style="width: 85%"></div>
                          </div>
                      </div>
                      <p class="text-sm text-gray-300 leading-relaxed">
                          "예술사적 관점에서 볼 때, 전통과 현대를 조화롭게 융합한 작품입니다. 
                          작가의 철학과 메시지가 명확하게 전달되며, 발전 가능성이 매우 높습니다."
                      </p>
                      <div class="mt-4 pt-4 border-t border-white border-opacity-10 text-xs text-gray-500">
                          <i class="fas fa-calendar mr-1"></i> 2024-01-17
                      </div>
                  </div>
              </div>
          </div>

          <!-- 저장 버튼 -->
          <div class="mt-12 text-center">
              <button onclick="alert('평가 결과가 저장되었습니다!')" class="px-12 py-4 bg-gradient-to-r from-purple-600 to-cyan-500 text-white font-bold text-lg rounded-2xl hover:scale-105 transition-transform">
                  <i class="fas fa-save mr-2"></i>
                  평가 결과 저장
              </button>
          </div>
      </div>
  </section>
  
  <script src="/static/valuation-complete.js"></script>
  `;
  
  return c.html(getLayout(content, 'NFT 가치평가 시스템 - GALLERYPIA'))
})

// 로그인 페이지

// NFT 민팅 - 승인된 작품 목록 페이지
app.get('/mint', (c) => {
  const content = `
  <section class="py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-12">
              <h1 class="text-6xl font-black mb-4">
                  <span class="text-gradient">NFT</span> <span class="text-white">민팅</span>
              </h1>
              <p class="text-gray-400 text-lg mb-6">가치평가가 완료된 작품을 NFT로 발행하세요</p>
              <a href="/mint-upload" class="inline-flex items-center px-8 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 text-white font-semibold rounded-xl hover:shadow-lg hover:shadow-purple-500/50 transition">
                  <i class="fas fa-upload mr-2"></i>
                  새 작품 업로드
              </a>
          </div>
          
          <div id="mintContent" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
              <p class="text-gray-400 text-center col-span-full">로딩 중...</p>
          </div>
      </div>
  </section>
  
  <script>
    async function loadMintableArtworks() {
      try {
        const response = await axios.get('/api/artworks?status=approved&limit=20');
        const artworks = response.data.data || [];
        
        const content = document.getElementById('mintContent');
        if (artworks.length === 0) {
          content.innerHTML = '<p class="text-gray-400 text-center col-span-full">민팅 가능한 작품이 없습니다.</p>';
          return;
        }
        
        content.innerHTML = artworks.map(artwork => \`
          <div class="card-nft rounded-3xl overflow-hidden">
              <div class="relative aspect-square bg-gray-900 overflow-hidden">
                  <img src="\${artwork.image_url}" alt="\${artwork.title}" class="w-full h-full object-cover img-nft">
                  \${artwork.is_minted ? \`
                  <div class="absolute top-4 left-4">
                      <span class="px-3 py-1.5 bg-green-600 text-white text-xs font-bold rounded-full flex items-center">
                          <i class="fas fa-check-circle mr-1.5"></i>민팅 완료
                      </span>
                  </div>
                  \` : \`
                  <div class="absolute top-4 left-4">
                      <span class="px-3 py-1.5 bg-yellow-600 text-white text-xs font-bold rounded-full flex items-center">
                          <i class="fas fa-clock mr-1.5"></i>민팅 가능
                      </span>
                  </div>
                  \`}
              </div>
              <div class="p-6">
                  <h3 class="font-bold text-xl text-white mb-3">\${artwork.title}</h3>
                  <div class="flex items-center mb-4">
                      <img src="\${artwork.artist_profile_image}" class="w-8 h-8 rounded-full mr-2 object-cover border border-white border-opacity-20">
                      <span class="text-sm text-gray-400 font-medium">\${artwork.artist_name}</span>
                  </div>
                  
                  <div class="bg-white bg-opacity-5 rounded-xl p-4 mb-4">
                      <div class="text-xs text-gray-500 mb-2">AI 산정가</div>
                      <div class="font-black text-lg text-gradient mb-3">\${formatPrice(artwork.estimated_value)}</div>
                  </div>
                  
                  \${!artwork.is_minted ? \`
                  <button onclick="mintNFT(\${artwork.id}, '\${artwork.title}', \${artwork.estimated_value})" class="w-full btn-neon px-4 py-3 rounded-xl text-white font-bold text-sm">
                      <i class="fas fa-hammer mr-2"></i>
                      NFT 민팅하기
                  </button>
                  \` : \`
                  <a href="/artwork/\${artwork.id}" class="block w-full text-center px-4 py-3 rounded-xl bg-white bg-opacity-5 text-white font-bold text-sm hover:bg-opacity-10 transition-all neon-border">
                      <i class="fas fa-eye mr-2"></i>
                      상세보기
                  </a>
                  \`}
              </div>
          </div>
        \`).join('');
      } catch (error) {
        document.getElementById('mintContent').innerHTML = '<p class="text-red-500 text-center col-span-full">데이터를 불러오는데 실패했습니다.</p>';
      }
    }
    
    function formatPrice(priceKRW) {
      const ETH_PRICE_KRW = 3000000; // 1 ETH = 3,000,000원
      const priceETH = (priceKRW / ETH_PRICE_KRW).toFixed(4);
      const formattedKRW = priceKRW.toLocaleString();
      return \`\${priceETH} ETH (₩\${formattedKRW})\`;
    }
    
    async function mintNFT(artworkId, title, price) {
      if (!currentAccount) {
        alert('먼저 메타마스크 지갑을 연결해주세요.');
        await connectMetaMask();
        return;
      }
      
      try {
        const confirm = window.confirm(\`"\${title}"을(를) NFT로 민팅하시겠습니까?\\n\\n산정가: \${formatPrice(price)}\\n가스비가 발생할 수 있습니다.\`);
        if (!confirm) return;
        
        alert('NFT 민팅이 시작되었습니다.');
        
        const response = await axios.post('/api/mint-nft', {
          artwork_id: artworkId,
          wallet_address: currentAccount,
          price: price
        });
        
        if (response.data.success) {
          alert('NFT 민팅이 완료되었습니다!');
          location.reload();
        }
      } catch (error) {
        console.error('민팅 실패:', error);
        alert('NFT 민팅에 실패했습니다. 다시 시도해주세요.');
      }
    }
    
    document.addEventListener('DOMContentLoaded', loadMintableArtworks);
  </script>
  `;
  
  return c.html(getLayout(content, 'NFT 민팅 - GALLERYPIA'))
})

// NFT 민팅 - 작품 업로드 페이지
app.get('/mint-upload', (c) => {
  const content = `
  <section class="py-16">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="mb-8">
              <h1 class="text-4xl font-bold mb-2">
                  <span class="text-gradient">NFT 작품 업로드</span>
              </h1>
              <p class="text-gray-400">작품을 업로드하고 NFT로 발행하세요</p>
          </div>

          <form id="mintForm" class="card-nft rounded-3xl p-8 space-y-6">
              <!-- 이미지 업로드 -->
              <div>
                  <label class="block text-lg font-semibold mb-4 text-white">작품 이미지 *</label>
                  <div id="uploadArea" class="upload-area rounded-2xl p-8 text-center cursor-pointer border-2 border-dashed border-purple-500/50 hover:border-purple-500 transition">
                      <input type="file" id="artworkImage" accept="image/*" class="hidden">
                      <div id="uploadPlaceholder">
                          <i class="fas fa-cloud-upload-alt text-6xl text-primary-500 mb-4"></i>
                          <p class="text-gray-300 text-lg font-medium mb-2">이미지를 드래그하거나 클릭하여 업로드</p>
                          <p class="text-gray-500 text-sm">PNG, JPG, GIF (최대 10MB)</p>
                      </div>
                      <div id="imagePreview" class="hidden">
                          <img id="previewImg" class="max-h-96 mx-auto rounded-xl">
                          <button type="button" onclick="removeImage()" class="mt-4 px-4 py-2 bg-red-500 hover:bg-red-600 rounded-xl text-sm">
                              <i class="fas fa-times mr-2"></i>이미지 제거
                          </button>
                      </div>
                  </div>
              </div>

              <!-- 기본 정보 -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div class="md:col-span-2">
                      <label class="block text-sm font-medium mb-2 text-white">작품명 *</label>
                      <input type="text" id="title" required
                             class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                  </div>

                  <div class="md:col-span-2">
                      <label class="block text-sm font-medium mb-2 text-white">작품 설명</label>
                      <textarea id="description" rows="4"
                                class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white resize-none focus:border-primary-500 focus:outline-none"></textarea>
                  </div>

                  <div>
                      <label class="block text-sm font-medium mb-2 text-white">카테고리 *</label>
                      <select id="category" required
                              class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                          <option value="">선택하세요</option>
                          <option value="회화">회화</option>
                          <option value="조각">조각</option>
                          <option value="디지털아트">디지털아트</option>
                          <option value="사진">사진</option>
                          <option value="설치미술">설치미술</option>
                          <option value="미디어아트">미디어아트</option>
                      </select>
                  </div>

                  <div>
                      <label class="block text-sm font-medium mb-2 text-white">기법</label>
                      <input type="text" id="technique"
                             class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none"
                             placeholder="예: 유화, 수채화, Digital Art">
                  </div>

                  <div class="grid grid-cols-3 gap-3">
                      <div>
                          <label class="block text-sm font-medium mb-2 text-white">가로 (cm)</label>
                          <input type="number" id="width"
                                 class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                      </div>
                      <div>
                          <label class="block text-sm font-medium mb-2 text-white">세로 (cm)</label>
                          <input type="number" id="height"
                                 class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                      </div>
                      <div>
                          <label class="block text-sm font-medium mb-2 text-white">깊이 (cm)</label>
                          <input type="number" id="depth"
                                 class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                      </div>
                  </div>

                  <div>
                      <label class="block text-sm font-medium mb-2 text-white">제작 연도</label>
                      <input type="number" id="year" min="1900" max="2025"
                             class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                  </div>

                  <div>
                      <label class="block text-sm font-medium mb-2 text-white">가격 (ETH)</label>
                      <input type="number" id="priceEth" step="0.01" onchange="convertEthToKrw()"
                             class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none"
                             placeholder="0.00">
                  </div>
              </div>

              <!-- 가격 표시 -->
              <div id="priceDisplay" class="hidden card-nft rounded-xl p-4">
                  <div class="flex items-center justify-between">
                      <div>
                          <p class="text-gray-400 text-sm mb-1">판매 가격</p>
                          <p class="text-2xl font-bold text-gradient"><span id="displayEth">0.00</span> ETH</p>
                      </div>
                      <div class="text-right">
                          <p class="text-gray-400 text-sm mb-1">원화 환산</p>
                          <p class="text-xl font-semibold text-gray-300">₩<span id="displayKrw">0</span></p>
                      </div>
                  </div>
              </div>

              <!-- 저작권 정보 -->
              <div class="space-y-4">
                  <h3 class="text-lg font-semibold text-white">저작권 정보 (선택)</h3>
                  
                  <div>
                      <label class="block text-sm font-medium mb-2 text-white">저작권 등록번호</label>
                      <input type="text" id="copyrightReg"
                             class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                  </div>

                  <div>
                      <label class="block text-sm font-medium mb-2 text-white">라이선스 유형</label>
                      <select id="licenseType"
                              class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                          <option value="">선택하세요</option>
                          <option value="exclusive">독점 라이선스</option>
                          <option value="non-exclusive">비독점 라이선스</option>
                          <option value="creative_commons">크리에이티브 커먼즈</option>
                      </select>
                  </div>
              </div>

              <!-- 전시회 정보 (선택) -->
              <div class="space-y-4">
                  <h3 class="text-lg font-semibold text-white flex items-center">
                      <i class="fas fa-building mr-2 text-purple-400"></i>
                      전시회 정보 (선택)
                  </h3>
                  <p class="text-sm text-gray-400">작품이 전시된 경력이 있다면 입력해주세요</p>
                  
                  <div>
                      <label class="block text-sm font-medium mb-2 text-white">전시회 명칭</label>
                      <input type="text" id="exhibitionName"
                             class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none"
                             placeholder="예: 2024 서울 국제 아트페어">
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                          <label class="block text-sm font-medium mb-2 text-white">전시회 시작일</label>
                          <input type="date" id="exhibitionStartDate"
                                 class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                      </div>
                      <div>
                          <label class="block text-sm font-medium mb-2 text-white">전시회 종료일</label>
                          <input type="date" id="exhibitionEndDate"
                                 class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                      </div>
                  </div>
              </div>

              <!-- 작품 가치 설명 (선택) -->
              <div class="space-y-4">
                  <h3 class="text-lg font-semibold text-white flex items-center">
                      <i class="fas fa-gem mr-2 text-cyan-400"></i>
                      작품 가치 설명 (선택)
                  </h3>
                  <p class="text-sm text-gray-400">작품의 독창성과 소장 가치를 설명해주세요</p>
                  
                  <div>
                      <label class="block text-sm font-medium mb-2 text-white">독창성 설명</label>
                      <textarea id="originalityDescription" rows="3"
                                class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white resize-none focus:border-primary-500 focus:outline-none"
                                placeholder="이 작품만의 독특한 점, 예술적 접근 방식, 창작 과정의 특별함 등을 설명해주세요"></textarea>
                  </div>

                  <div>
                      <label class="block text-sm font-medium mb-2 text-white">소장가치 설명</label>
                      <textarea id="collectionValueDescription" rows="3"
                                class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white resize-none focus:border-primary-500 focus:outline-none"
                                placeholder="왜 이 작품이 수집할 가치가 있는지, 투자 가치, 희소성 등을 설명해주세요"></textarea>
                  </div>
              </div>

              <!-- 외부 링크 (선택) -->
              <div class="space-y-4">
                  <h3 class="text-lg font-semibold text-white flex items-center">
                      <i class="fas fa-link mr-2 text-green-400"></i>
                      외부 링크 (선택)
                  </h3>
                  <p class="text-sm text-gray-400">작품 관련 외부 링크를 추가하여 신뢰도를 높이세요</p>
                  
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                          <label class="block text-sm font-medium mb-2 text-white flex items-center">
                              <i class="fab fa-youtube text-red-500 mr-2"></i>
                              YouTube URL
                          </label>
                          <input type="url" id="youtubeUrl"
                                 class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none"
                                 placeholder="https://www.youtube.com/watch?v=...">
                      </div>

                      <div>
                          <label class="block text-sm font-medium mb-2 text-white flex items-center">
                              <i class="fab fa-instagram text-pink-500 mr-2"></i>
                              Instagram URL
                          </label>
                          <input type="url" id="instagramUrl"
                                 class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none"
                                 placeholder="https://www.instagram.com/p/...">
                      </div>

                      <div>
                          <label class="block text-sm font-medium mb-2 text-white flex items-center">
                              <i class="fas fa-store text-blue-400 mr-2"></i>
                              NFT 플랫폼 URL
                          </label>
                          <input type="url" id="nftPlatformUrl"
                                 class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none"
                                 placeholder="https://opensea.io/assets/...">
                      </div>

                      <div>
                          <label class="block text-sm font-medium mb-2 text-white flex items-center">
                              <i class="fas fa-newspaper text-amber-400 mr-2"></i>
                              보도자료 URL
                          </label>
                          <input type="url" id="pressReleaseUrl"
                                 class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none"
                                 placeholder="https://...">
                      </div>
                  </div>
              </div>

              <!-- 제출 버튼 -->
              <div class="flex gap-4">
                  <button type="button" onclick="window.history.back()"
                          class="flex-1 py-4 bg-gray-800 hover:bg-gray-700 text-white rounded-xl transition">
                          <i class="fas fa-arrow-left mr-2"></i>취소
                  </button>
                  <button type="submit"
                          class="flex-1 py-4 bg-gradient-to-r from-purple-600 to-cyan-500 hover:shadow-lg hover:shadow-purple-500/50 text-white font-semibold rounded-xl transition">
                          <i class="fas fa-rocket mr-2"></i>NFT 민팅하기
                  </button>
              </div>
          </form>
      </div>
  </section>

  <style>
    .upload-area {
      transition: all 0.3s ease;
    }
    .upload-area:hover {
      background: rgba(139, 92, 246, 0.05);
    }
    .upload-area.dragover {
      border-color: #8b5cf6;
      background: rgba(139, 92, 246, 0.1);
    }
  </style>

  <script>
    const ETH_TO_KRW = 3000000; // 1 ETH = 3,000,000 KRW

    // 이미지 업로드 처리
    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('previewImg').src = e.target.result;
          document.getElementById('uploadPlaceholder').classList.add('hidden');
          document.getElementById('imagePreview').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    }

    function removeImage() {
      document.getElementById('artworkImage').value = '';
      document.getElementById('uploadPlaceholder').classList.remove('hidden');
      document.getElementById('imagePreview').classList.add('hidden');
    }

    // Drag & Drop
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('artworkImage');
    
    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleImageUpload);
    
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        fileInput.files = e.dataTransfer.files;
        handleImageUpload({ target: { files: [file] } });
      }
    });

    // ETH to KRW 변환
    function convertEthToKrw() {
      const eth = parseFloat(document.getElementById('priceEth').value) || 0;
      const krw = Math.round(eth * ETH_TO_KRW);
      
      document.getElementById('displayEth').textContent = eth.toFixed(2);
      document.getElementById('displayKrw').textContent = krw.toLocaleString();
      document.getElementById('priceDisplay').classList.toggle('hidden', eth === 0);
    }

    // 폼 제출
    document.getElementById('mintForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Get session token
      const sessionToken = localStorage.getItem('session_token');
      if (!sessionToken) {
        alert('로그인이 필요합니다.');
        window.location.href = '/login';
        return;
      }
      
      const formData = {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        category: document.getElementById('category').value,
        technique: document.getElementById('technique').value,
        size_width: parseInt(document.getElementById('width').value) || null,
        size_height: parseInt(document.getElementById('height').value) || null,
        size_depth: parseInt(document.getElementById('depth').value) || null,
        creation_year: parseInt(document.getElementById('year').value) || null,
        price_eth: parseFloat(document.getElementById('priceEth').value) || null,
        image_url: document.getElementById('previewImg').src || 'https://via.placeholder.com/800',
        copyright_registration: document.getElementById('copyrightReg').value,
        license_type: document.getElementById('licenseType').value,
        // 새로 추가된 필드들 (v6.0)
        exhibition_name: document.getElementById('exhibitionName').value || null,
        exhibition_start_date: document.getElementById('exhibitionStartDate').value || null,
        exhibition_end_date: document.getElementById('exhibitionEndDate').value || null,
        originality_description: document.getElementById('originalityDescription').value || null,
        collection_value_description: document.getElementById('collectionValueDescription').value || null,
        youtube_url: document.getElementById('youtubeUrl').value || null,
        instagram_url: document.getElementById('instagramUrl').value || null,
        nft_platform_url: document.getElementById('nftPlatformUrl').value || null,
        press_release_url: document.getElementById('pressReleaseUrl').value || null
      };

      try {
        const response = await axios.post('/api/submissions/create', formData, {
          headers: {
            'Authorization': 'Bearer ' + sessionToken,
            'Content-Type': 'application/json'
          }
        });
        const data = response.data;
        
        if (data.success) {
          alert('작품이 성공적으로 제출되었습니다!\\n\\n관리자 승인 후 갤러리에 표시됩니다.');
          window.location.href = '/mypage';
        } else {
          alert('제출 실패: ' + data.message);
        }
      } catch (error) {
        console.error('Submit error:', error);
        alert('제출 중 오류가 발생했습니다: ' + (error.response?.data?.message || error.message));
      }
    });
  </script>
  `;
  
  return c.html(getLayout(content, 'NFT 작품 업로드 - GALLERYPIA'))
})

// Mypage - 개인화 대시보드
app.get('/mypage', (c) => {
  const content = `
  <section class="py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <!-- 로그인 체크 스크립트 -->
          <script>
            // 페이지 로드 시 로그인 확인
            (function() {
              const sessionToken = localStorage.getItem('session_token');
              if (!sessionToken) {
                alert('로그인이 필요한 페이지입니다.');
                window.location.href = '/login';
                return;
              }
              
              // 세션 검증
              fetch('/api/auth/me', {
                headers: {
                  'Authorization': 'Bearer ' + sessionToken
                }
              })
              .then(res => res.json())
              .then(data => {
                if (!data.success) {
                  alert('세션이 만료되었습니다. 다시 로그인해주세요.');
                  localStorage.removeItem('session_token');
                  window.location.href = '/login';
                }
              })
              .catch(err => {
                console.error('세션 검증 실패:', err);
                window.location.href = '/login';
              });
            })();
          </script>
          
          <!-- 헤더 -->
          <div class="flex justify-between items-center mb-12">
              <div>
                  <h1 class="text-5xl font-black mb-2">
                      <span class="text-gradient">마이</span> <span class="text-white">페이지</span>
                  </h1>
                  <p class="text-gray-400">내 작품과 활동을 한눈에 확인하세요</p>
              </div>
              <a href="/mint-upload" class="flex items-center px-6 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 text-white font-semibold rounded-xl hover:shadow-lg hover:shadow-purple-500/50 transition">
                  <i class="fas fa-plus-circle mr-2"></i>
                  새 작품 업로드
              </a>
          </div>

          <!-- 아티스트 랭크 카드 -->
          <div id="artist-rank-card" class="mb-8">
              <div class="text-center py-8 text-gray-400">
                  <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                  <p>랭크 정보 로딩 중...</p>
              </div>
          </div>

          <!-- 통계 카드 그리드 -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
              <!-- 총 작품 수 -->
              <div class="card-nft rounded-2xl p-6 relative overflow-hidden">
                  <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-purple-600/20 to-transparent rounded-full -mr-16 -mt-16"></div>
                  <div class="relative z-10">
                      <div class="flex items-center justify-between mb-4">
                          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-600 to-purple-800 flex items-center justify-center">
                              <i class="fas fa-images text-white text-xl"></i>
                          </div>
                          <span class="text-xs text-green-400 flex items-center">
                              <i class="fas fa-arrow-up mr-1"></i>12%
                          </span>
                      </div>
                      <div class="text-3xl font-black text-white mb-1">24</div>
                      <div class="text-sm text-gray-400">총 작품 수</div>
                  </div>
              </div>

              <!-- 민팅 완료 -->
              <div class="card-nft rounded-2xl p-6 relative overflow-hidden">
                  <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-cyan-600/20 to-transparent rounded-full -mr-16 -mt-16"></div>
                  <div class="relative z-10">
                      <div class="flex items-center justify-between mb-4">
                          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-600 to-blue-800 flex items-center justify-center">
                              <i class="fas fa-cube text-white text-xl"></i>
                          </div>
                          <span class="text-xs text-green-400 flex items-center">
                              <i class="fas fa-arrow-up mr-1"></i>8%
                          </span>
                      </div>
                      <div class="text-3xl font-black text-white mb-1">18</div>
                      <div class="text-sm text-gray-400">민팅 완료</div>
                  </div>
              </div>

              <!-- 총 판매액 -->
              <div class="card-nft rounded-2xl p-6 relative overflow-hidden">
                  <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-green-600/20 to-transparent rounded-full -mr-16 -mt-16"></div>
                  <div class="relative z-10">
                      <div class="flex items-center justify-between mb-4">
                          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-600 to-emerald-800 flex items-center justify-center">
                              <i class="fas fa-dollar-sign text-white text-xl"></i>
                          </div>
                          <span class="text-xs text-green-400 flex items-center">
                              <i class="fas fa-arrow-up mr-1"></i>24%
                          </span>
                      </div>
                      <div class="text-3xl font-black text-white mb-1">12.5 ETH</div>
                      <div class="text-sm text-gray-400">총 판매액</div>
                  </div>
              </div>

              <!-- 평균 평가 점수 -->
              <div class="card-nft rounded-2xl p-6 relative overflow-hidden">
                  <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-orange-600/20 to-transparent rounded-full -mr-16 -mt-16"></div>
                  <div class="relative z-10">
                      <div class="flex items-center justify-between mb-4">
                          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-600 to-red-800 flex items-center justify-center">
                              <i class="fas fa-star text-white text-xl"></i>
                          </div>
                          <span class="text-xs text-green-400 flex items-center">
                              <i class="fas fa-arrow-up mr-1"></i>5%
                          </span>
                      </div>
                      <div class="text-3xl font-black text-white mb-1">87.5</div>
                      <div class="text-sm text-gray-400">평균 평가 점수</div>
                  </div>
              </div>
          </div>

          <!-- 활동 그래프 & 최근 작품 -->
          <div class="grid lg:grid-cols-3 gap-8 mb-12">
              <!-- 월별 활동 그래프 -->
              <div class="lg:col-span-2 card-nft rounded-2xl p-6">
                  <div class="flex items-center justify-between mb-6">
                      <h3 class="text-xl font-bold text-white">월별 작품 활동</h3>
                      <select class="px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white text-sm">
                          <option>최근 6개월</option>
                          <option>최근 1년</option>
                      </select>
                  </div>
                  <canvas id="activityChart" class="w-full"></canvas>
              </div>

              <!-- 카테고리 분포 -->
              <div class="card-nft rounded-2xl p-6">
                  <h3 class="text-xl font-bold text-white mb-6">작품 카테고리</h3>
                  <canvas id="categoryChart" class="w-full mb-4"></canvas>
                  <div class="space-y-3">
                      <div class="flex items-center justify-between">
                          <div class="flex items-center">
                              <div class="w-3 h-3 rounded-full bg-purple-500 mr-2"></div>
                              <span class="text-sm text-gray-300">디지털아트</span>
                          </div>
                          <span class="text-sm font-bold text-white">42%</span>
                      </div>
                      <div class="flex items-center justify-between">
                          <div class="flex items-center">
                              <div class="w-3 h-3 rounded-full bg-cyan-500 mr-2"></div>
                              <span class="text-sm text-gray-300">회화</span>
                          </div>
                          <span class="text-sm font-bold text-white">28%</span>
                      </div>
                      <div class="flex items-center justify-between">
                          <div class="flex items-center">
                              <div class="w-3 h-3 rounded-full bg-orange-500 mr-2"></div>
                              <span class="text-sm text-gray-300">사진</span>
                          </div>
                          <span class="text-sm font-bold text-white">18%</span>
                      </div>
                      <div class="flex items-center justify-between">
                          <div class="flex items-center">
                              <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                              <span class="text-sm text-gray-300">기타</span>
                          </div>
                          <span class="text-sm font-bold text-white">12%</span>
                      </div>
                  </div>
              </div>
          </div>

          <!-- 경력 입력 섹션 -->
          <div class="mb-12">
              <div class="flex items-center justify-between mb-6">
                  <h2 class="text-3xl font-black">
                      <span class="text-gradient">나의</span> <span class="text-white">경력</span>
                  </h2>
                  <button onclick="toggleCareerForm()" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 text-white font-semibold rounded-xl hover:shadow-lg transition">
                      <i class="fas fa-plus-circle mr-2"></i>
                      경력 추가
                  </button>
              </div>
              
              <div id="artist-career-form" style="display: none;">
                  <!-- 경력 입력 폼이 동적으로 로드됩니다 -->
              </div>
          </div>

          <!-- 내 작품 목록 -->
          <div>
              <div class="flex items-center justify-between mb-6">
                  <h2 class="text-3xl font-black">
                      <span class="text-gradient">내</span> <span class="text-white">작품</span>
                  </h2>
                  <div class="flex gap-2">
                      <button class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium">전체</button>
                      <button class="px-4 py-2 bg-gray-800 text-gray-400 hover:bg-gray-700 rounded-lg text-sm font-medium">승인대기</button>
                      <button class="px-4 py-2 bg-gray-800 text-gray-400 hover:bg-gray-700 rounded-lg text-sm font-medium">민팅완료</button>
                  </div>
              </div>

              <div id="myArtworks" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                  <!-- 작품 카드들이 동적으로 로드됩니다 -->
                  <div class="text-center col-span-full py-12 text-gray-400">
                      <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                      <p>작품을 불러오는 중...</p>
                  </div>
              </div>
          </div>
      </div>
  </section>

  <script>
    // 월별 활동 차트
    const activityCtx = document.getElementById('activityChart').getContext('2d');
    new Chart(activityCtx, {
      type: 'line',
      data: {
        labels: ['1월', '2월', '3월', '4월', '5월', '6월'],
        datasets: [{
          label: '작품 업로드',
          data: [3, 5, 2, 8, 6, 4],
          borderColor: '#8b5cf6',
          backgroundColor: 'rgba(139, 92, 246, 0.1)',
          tension: 0.4,
          fill: true
        }, {
          label: 'NFT 민팅',
          data: [2, 4, 1, 6, 5, 3],
          borderColor: '#06b6d4',
          backgroundColor: 'rgba(6, 182, 212, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 2.5,
        plugins: {
          legend: {
            display: true,
            labels: { color: '#9ca3af' }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(255, 255, 255, 0.05)' },
            ticks: { color: '#9ca3af' }
          },
          x: {
            grid: { color: 'rgba(255, 255, 255, 0.05)' },
            ticks: { color: '#9ca3af' }
          }
        }
      }
    });

    // 카테고리 도넛 차트
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
      type: 'doughnut',
      data: {
        labels: ['디지털아트', '회화', '사진', '기타'],
        datasets: [{
          data: [42, 28, 18, 12],
          backgroundColor: ['#8b5cf6', '#06b6d4', '#f97316', '#10b981'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false }
        }
      }
    });

    // 내 작품 로드
    async function loadMyArtworks() {
      try {
        const response = await axios.get('/api/submissions/my');
        const submissions = response.data.data || [];
        
        const container = document.getElementById('myArtworks');
        if (submissions.length === 0) {
          container.innerHTML = \`
            <div class="text-center col-span-full py-12">
              <i class="fas fa-paint-brush text-6xl text-gray-700 mb-4"></i>
              <p class="text-gray-400 text-lg mb-4">아직 업로드한 작품이 없습니다</p>
              <a href="/mint-upload" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 text-white font-semibold rounded-xl hover:shadow-lg transition">
                <i class="fas fa-plus-circle mr-2"></i>첫 작품 업로드하기
              </a>
            </div>
          \`;
          return;
        }

        container.innerHTML = submissions.map(artwork => \`
          <div class="card-nft rounded-2xl overflow-hidden group cursor-pointer" onclick="viewArtwork(\${artwork.id})">
            <div class="relative aspect-square bg-gray-900 overflow-hidden">
              <img src="\${artwork.image_url}" alt="\${artwork.title}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
              <div class="absolute top-3 right-3">
                \${artwork.submission_status === 'pending' ? 
                  \`<span class="px-3 py-1 bg-yellow-600 text-white text-xs font-bold rounded-full">승인대기</span>\` :
                  artwork.submission_status === 'approved' ?
                  \`<span class="px-3 py-1 bg-green-600 text-white text-xs font-bold rounded-full">승인완료</span>\` :
                  \`<span class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full">반려</span>\`
                }
              </div>
            </div>
            <div class="p-4">
              <h3 class="font-bold text-white mb-2 truncate">\${artwork.title}</h3>
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-400">\${artwork.category || '미분류'}</span>
                <span class="text-gray-500">\${artwork.submitted_at?.split('T')[0] || ''}</span>
              </div>
            </div>
          </div>
        \`).join('');
      } catch (error) {
        console.error('Failed to load artworks:', error);
        document.getElementById('myArtworks').innerHTML = \`
          <div class="text-center col-span-full py-12 text-red-500">
            <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
            <p>작품을 불러오는데 실패했습니다</p>
          </div>
        \`;
      }
    }

    function viewArtwork(id) {
      // 작품 상세 페이지로 이동 또는 모달 표시
      console.log('View artwork:', id);
    }
    
    // 경력 폼 토글
    function toggleCareerForm() {
      const form = document.getElementById('artist-career-form');
      if (form.style.display === 'none') {
        form.style.display = 'block';
        loadArtistCareerForm();
      } else {
        form.style.display = 'none';
      }
    }

    // 페이지 로드 시 작품 목록 및 랭크 로드
    document.addEventListener('DOMContentLoaded', () => {
      loadMyArtworks();
      loadArtistRank();
    });
  </script>
  <script src="/static/artist-rank.js"></script>
  `;
  
  return c.html(getLayout(content, '마이페이지 - GALLERYPIA'))
})

// 리더보드 페이지 - 아티스트 랭킹
app.get('/leaderboard', (c) => {
  const content = `
  <section class="py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <!-- 헤더 -->
          <div class="text-center mb-12">
              <h1 class="text-6xl font-black mb-4">
                  <i class="fas fa-trophy text-yellow-400 mr-4"></i>
                  <span class="text-gradient">아티스트</span> <span class="text-white">랭킹</span>
              </h1>
              <p class="text-gray-400 text-lg">
                  전시회, 수상, 작품 활동 기반의 객관적 아티스트 평가 시스템
              </p>
          </div>
          
          <!-- 카테고리 필터 -->
          <div class="flex flex-wrap justify-center gap-4 mb-12">
              <button onclick="filterLeaderboard('all')" class="leaderboard-filter active">
                  <i class="fas fa-globe mr-2"></i>전체
              </button>
              <button onclick="filterLeaderboard('master')" class="leaderboard-filter">
                  <i class="fas fa-crown text-yellow-400 mr-2"></i>최우수 작가
              </button>
              <button onclick="filterLeaderboard('excellent')" class="leaderboard-filter">
                  <i class="fas fa-star text-blue-400 mr-2"></i>우수 작가
              </button>
              <button onclick="filterLeaderboard('professional')" class="leaderboard-filter">
                  <i class="fas fa-medal text-purple-400 mr-2"></i>전문 작가
              </button>
              <button onclick="filterLeaderboard('emerging')" class="leaderboard-filter">
                  <i class="fas fa-seedling text-green-400 mr-2"></i>신진 작가
              </button>
          </div>
          
          <!-- 랭킹 통계 -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
              <div class="card-nft rounded-2xl p-6 text-center">
                  <div class="text-4xl font-black text-gradient mb-2" id="total-artists">-</div>
                  <div class="text-gray-400 text-sm">총 등록 아티스트</div>
              </div>
              <div class="card-nft rounded-2xl p-6 text-center">
                  <div class="text-4xl font-black text-yellow-400 mb-2" id="master-count">-</div>
                  <div class="text-gray-400 text-sm">최우수 작가</div>
              </div>
              <div class="card-nft rounded-2xl p-6 text-center">
                  <div class="text-4xl font-black text-blue-400 mb-2" id="excellent-count">-</div>
                  <div class="text-gray-400 text-sm">우수 작가</div>
              </div>
              <div class="card-nft rounded-2xl p-6 text-center">
                  <div class="text-4xl font-black text-purple-400 mb-2" id="professional-count">-</div>
                  <div class="text-gray-400 text-sm">전문 작가</div>
              </div>
          </div>
          
          <!-- 리더보드 테이블 -->
          <div class="card-nft rounded-2xl p-8">
              <div class="overflow-x-auto">
                  <table class="w-full">
                      <thead>
                          <tr class="border-b border-gray-800">
                              <th class="text-left py-4 px-4 text-gray-400 font-semibold">순위</th>
                              <th class="text-left py-4 px-4 text-gray-400 font-semibold">아티스트</th>
                              <th class="text-left py-4 px-4 text-gray-400 font-semibold">랭크</th>
                              <th class="text-center py-4 px-4 text-gray-400 font-semibold">정량평가</th>
                              <th class="text-center py-4 px-4 text-gray-400 font-semibold">정성평가</th>
                              <th class="text-center py-4 px-4 text-gray-400 font-semibold">인기도</th>
                              <th class="text-center py-4 px-4 text-gray-400 font-semibold">총점</th>
                          </tr>
                      </thead>
                      <tbody id="leaderboard-body">
                          <tr>
                              <td colspan="7" class="text-center py-12 text-gray-400">
                                  <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                                  <p>랭킹 데이터를 불러오는 중...</p>
                              </td>
                          </tr>
                      </tbody>
                  </table>
              </div>
          </div>
          
          <!-- 평가 기준 안내 -->
          <div class="mt-12 card-nft rounded-2xl p-8">
              <h3 class="text-2xl font-bold text-white mb-6">
                  <i class="fas fa-info-circle text-cyan-400 mr-2"></i>
                  랭크 평가 기준
              </h3>
              <div class="grid md:grid-cols-3 gap-6">
                  <div>
                      <div class="text-purple-400 font-bold mb-2">
                          <i class="fas fa-chart-line mr-2"></i>정량평가 (40%)
                      </div>
                      <ul class="text-sm text-gray-400 space-y-1">
                          <li>• 전시회 경력 (국내외 비엔날레, 개인전 등)</li>
                          <li>• 수상 경력 (공모전, 대회 등)</li>
                          <li>• 저작권 등록</li>
                          <li>• 전시기획 경력</li>
                          <li>• 논문 및 저서</li>
                      </ul>
                  </div>
                  <div>
                      <div class="text-cyan-400 font-bold mb-2">
                          <i class="fas fa-user-check mr-2"></i>정성평가 (30%)
                      </div>
                      <ul class="text-sm text-gray-400 space-y-1">
                          <li>• 작품 내용성 (컨셉, 스토리)</li>
                          <li>• 표현성 (기술, 조형요소)</li>
                          <li>• 독창성 (유일성, 희귀성)</li>
                          <li>• 소장가치 (투자가치, 이력)</li>
                          <li>• 전문가 평가 위원회 심사</li>
                      </ul>
                  </div>
                  <div>
                      <div class="text-pink-400 font-bold mb-2">
                          <i class="fas fa-fire mr-2"></i>인기도 (30%)
                      </div>
                      <ul class="text-sm text-gray-400 space-y-1">
                          <li>• YouTube 조회수</li>
                          <li>• OpenSea 조회수</li>
                          <li>• NFT 플랫폼 조회수</li>
                          <li>• 판매 실적</li>
                          <li>• 소셜 미디어 인지도</li>
                      </ul>
                  </div>
              </div>
          </div>
      </div>
  </section>
  
  <script>
    let currentFilter = 'all';
    
    // 리더보드 데이터 로드
    async function loadLeaderboard(category = null) {
      try {
        let url = '/api/artist/leaderboard?limit=50';
        if (category && category !== 'all') {
          url += \`&category=\${category}\`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          renderLeaderboard(result.data);
          updateStats(result.data);
        } else {
          document.getElementById('leaderboard-body').innerHTML = \`
            <tr>
              <td colspan="7" class="text-center py-12 text-gray-400">
                  <i class="fas fa-inbox text-5xl mb-4"></i>
                  <p>등록된 아티스트가 없습니다</p>
              </td>
            </tr>
          \`;
        }
      } catch (error) {
        console.error('Failed to load leaderboard:', error);
        document.getElementById('leaderboard-body').innerHTML = \`
          <tr>
            <td colspan="7" class="text-center py-12 text-red-400">
                <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                <p>데이터를 불러오는데 실패했습니다</p>
            </td>
          </tr>
        \`;
      }
    }
    
    // 리더보드 렌더링
    function renderLeaderboard(artists) {
      const tbody = document.getElementById('leaderboard-body');
      
      tbody.innerHTML = artists.map((artist, index) => {
        const rankBadge = getRankBadgeHTML(artist.rank_tier, artist.rank_grade, artist.rank_category);
        const rankIcon = index < 3 ? 
          \`<i class="fas fa-trophy text-\${index === 0 ? 'yellow' : index === 1 ? 'gray' : 'orange'}-400 text-xl"></i>\` :
          \`<span class="text-gray-400 font-bold">\${index + 1}</span>\`;
        
        return \`
          <tr class="border-b border-gray-800/50 hover:bg-white/5 transition-colors">
            <td class="py-4 px-4 text-center">\${rankIcon}</td>
            <td class="py-4 px-4">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-600 to-cyan-500 flex items-center justify-center text-white font-bold">
                  \${artist.username ? artist.username.substring(0, 2).toUpperCase() : 'UN'}
                </div>
                <div>
                  <div class="text-white font-bold">\${artist.full_name || artist.username || 'Unknown'}</div>
                  <div class="text-gray-400 text-sm">@\${artist.username || 'unknown'}</div>
                </div>
              </div>
            </td>
            <td class="py-4 px-4">\${rankBadge}</td>
            <td class="py-4 px-4 text-center">
              <div class="text-purple-400 font-bold">\${artist.quantitative_weighted_score.toFixed(1)}</div>
            </td>
            <td class="py-4 px-4 text-center">
              <div class="text-cyan-400 font-bold">\${artist.qualitative_weighted_score.toFixed(1)}</div>
            </td>
            <td class="py-4 px-4 text-center">
              <div class="text-pink-400 font-bold">\${artist.popularity_weighted_score.toFixed(1)}</div>
            </td>
            <td class="py-4 px-4 text-center">
              <div class="text-2xl font-black text-gradient">\${artist.final_score.toFixed(1)}</div>
            </td>
          </tr>
        \`;
      }).join('');
    }
    
    // 통계 업데이트
    function updateStats(artists) {
      document.getElementById('total-artists').textContent = artists.length;
      
      const masterCount = artists.filter(a => a.rank_category === 'master').length;
      const excellentCount = artists.filter(a => a.rank_category === 'excellent').length;
      const professionalCount = artists.filter(a => a.rank_category === 'professional').length;
      
      document.getElementById('master-count').textContent = masterCount;
      document.getElementById('excellent-count').textContent = excellentCount;
      document.getElementById('professional-count').textContent = professionalCount;
    }
    
    // 카테고리 필터
    function filterLeaderboard(category) {
      currentFilter = category;
      
      // 버튼 활성화 상태 업데이트
      document.querySelectorAll('.leaderboard-filter').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.closest('button').classList.add('active');
      
      // 데이터 로드
      loadLeaderboard(category === 'all' ? null : category);
    }
    
    // 페이지 로드 시 리더보드 로드
    document.addEventListener('DOMContentLoaded', () => {
      loadLeaderboard();
    });
  </script>
  <script src="/static/artist-rank.js"></script>
  
  <style>
    .leaderboard-filter {
      padding: 12px 24px;
      background: #1f2937;
      color: #9ca3af;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .leaderboard-filter:hover {
      background: #374151;
      transform: translateY(-2px);
    }
    
    .leaderboard-filter.active {
      background: linear-gradient(135deg, #7c3aed 0%, #06b6d4 100%);
      color: white;
      box-shadow: 0 10px 30px rgba(124, 58, 237, 0.3);
    }
  </style>
  `;
  
  return c.html(getLayout(content, '아티스트 랭킹 - GALLERYPIA'))
})

// 검색 페이지 - 음성검색, AI검색, 전문가 추천
app.get('/search', (c) => {
  const content = `
  <section class="py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-12">
              <h1 class="text-6xl font-black mb-4">
                  <span class="text-gradient">스마트</span> <span class="text-white">검색</span>
              </h1>
              <p class="text-gray-400 text-lg">음성, 텍스트, AI로 원하는 작품을 찾아보세요</p>
          </div>

          <!-- 검색 방법 선택 탭 -->
          <div class="flex justify-center gap-4 mb-12">
              <button onclick="switchSearchMode('text')" id="textTab" class="px-8 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 text-white rounded-xl font-semibold">
                  <i class="fas fa-keyboard mr-2"></i>텍스트 검색
              </button>
              <button onclick="switchSearchMode('voice')" id="voiceTab" class="px-8 py-3 bg-gray-800 text-gray-400 hover:bg-gray-700 rounded-xl font-semibold">
                  <i class="fas fa-microphone mr-2"></i>음성 검색
              </button>
              <button onclick="switchSearchMode('ai')" id="aiTab" class="px-8 py-3 bg-gray-800 text-gray-400 hover:bg-gray-700 rounded-xl font-semibold">
                  <i class="fas fa-brain mr-2"></i>AI 검색
              </button>
          </div>

          <!-- 텍스트 검색 -->
          <div id="textSearch" class="max-w-3xl mx-auto mb-16">
              <div class="card-nft rounded-2xl p-8">
                  <div class="relative">
                      <input type="text" id="searchInput" placeholder="작품명, 작가명, 키워드를 입력하세요..."
                             class="w-full px-6 py-4 bg-gray-900 border border-gray-700 rounded-xl text-white text-lg focus:border-purple-500 focus:outline-none pr-14">
                      <button onclick="performSearch()" class="absolute right-3 top-1/2 -translate-y-1/2 px-4 py-2 bg-gradient-to-r from-purple-600 to-cyan-500 text-white rounded-lg">
                          <i class="fas fa-search"></i>
                      </button>
                  </div>
                  <div class="mt-4 flex flex-wrap gap-2">
                      <span class="text-sm text-gray-400">인기 검색어:</span>
                      <button onclick="quickSearch('디지털아트')" class="px-3 py-1 bg-gray-800 hover:bg-purple-600 text-gray-300 hover:text-white rounded-lg text-sm transition">디지털아트</button>
                      <button onclick="quickSearch('추상화')" class="px-3 py-1 bg-gray-800 hover:bg-purple-600 text-gray-300 hover:text-white rounded-lg text-sm transition">추상화</button>
                      <button onclick="quickSearch('NFT')" class="px-3 py-1 bg-gray-800 hover:bg-purple-600 text-gray-300 hover:text-white rounded-lg text-sm transition">NFT</button>
                  </div>
              </div>
          </div>

          <!-- 음성 검색 -->
          <div id="voiceSearch" class="hidden max-w-3xl mx-auto mb-16">
              <div class="card-nft rounded-2xl p-12 text-center">
                  <div id="voiceStatus" class="mb-8">
                      <div class="w-32 h-32 mx-auto rounded-full bg-gradient-to-br from-purple-600 to-cyan-500 flex items-center justify-center mb-6">
                          <i id="micIcon" class="fas fa-microphone text-white text-6xl"></i>
                      </div>
                      <p id="voiceText" class="text-gray-400 text-lg">마이크 버튼을 클릭하여 음성으로 검색하세요</p>
                  </div>
                  <button onclick="startVoiceSearch()" id="voiceButton" class="px-10 py-4 bg-gradient-to-r from-purple-600 to-cyan-500 text-white rounded-xl font-bold text-lg hover:shadow-lg hover:shadow-purple-500/50 transition">
                      <i class="fas fa-microphone mr-2"></i>음성 검색 시작
                  </button>
                  <p id="recognizedText" class="mt-6 text-white text-xl font-semibold hidden"></p>
              </div>
          </div>

          <!-- AI 검색 -->
          <div id="aiSearch" class="hidden max-w-3xl mx-auto mb-16">
              <div class="card-nft rounded-2xl p-8">
                  <h3 class="text-2xl font-bold text-white mb-4">AI 이미지 검색</h3>
                  <p class="text-gray-400 mb-6">이미지를 업로드하면 AI가 유사한 작품을 찾아드립니다</p>
                  
                  <div id="aiUploadArea" class="border-2 border-dashed border-purple-500/50 hover:border-purple-500 rounded-2xl p-12 text-center cursor-pointer transition">
                      <input type="file" id="aiImageInput" accept="image/*" class="hidden">
                      <i class="fas fa-image text-6xl text-purple-500 mb-4"></i>
                      <p class="text-gray-300 text-lg font-medium mb-2">이미지를 드래그하거나 클릭하여 업로드</p>
                      <p class="text-gray-500 text-sm">PNG, JPG, GIF (최대 10MB)</p>
                  </div>
                  
                  <div id="aiImagePreview" class="hidden mt-6">
                      <img id="aiPreviewImg" class="max-h-64 mx-auto rounded-xl mb-4">
                      <button onclick="performAISearch()" class="w-full py-4 bg-gradient-to-r from-purple-600 to-cyan-500 text-white rounded-xl font-bold">
                          <i class="fas fa-brain mr-2"></i>AI로 유사 작품 찾기
                      </button>
                  </div>
              </div>
          </div>

          <!-- 전문가 추천 작품 -->
          <div class="mb-12">
              <div class="flex items-center justify-between mb-6">
                  <h2 class="text-3xl font-black">
                      <span class="text-gradient">전문가</span> <span class="text-white">추천 작품</span>
                  </h2>
                  <button class="text-purple-500 hover:text-purple-400 font-semibold">
                      전체 보기 <i class="fas fa-arrow-right ml-1"></i>
                  </button>
              </div>
              
              <div id="expertRecommendations" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                  <!-- 추천 작품이 동적으로 로드됩니다 -->
                  <div class="text-center col-span-full py-12 text-gray-400">
                      <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                      <p>전문가 추천 작품을 불러오는 중...</p>
                  </div>
              </div>
          </div>

          <!-- 검색 결과 -->
          <div id="searchResults" class="hidden">
              <h3 class="text-2xl font-bold text-white mb-6">검색 결과</h3>
              <div id="resultsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                  <!-- 검색 결과가 여기에 표시됩니다 -->
              </div>
          </div>
      </div>
  </section>

  <script>
    let currentMode = 'text';
    let recognition = null;

    // 검색 모드 전환
    function switchSearchMode(mode) {
      currentMode = mode;
      
      // 탭 스타일 업데이트
      ['text', 'voice', 'ai'].forEach(m => {
        const tab = document.getElementById(m + 'Tab');
        if (m === mode) {
          tab.className = 'px-8 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 text-white rounded-xl font-semibold';
        } else {
          tab.className = 'px-8 py-3 bg-gray-800 text-gray-400 hover:bg-gray-700 rounded-xl font-semibold';
        }
      });

      // 검색 영역 표시/숨김
      document.getElementById('textSearch').classList.toggle('hidden', mode !== 'text');
      document.getElementById('voiceSearch').classList.toggle('hidden', mode !== 'voice');
      document.getElementById('aiSearch').classList.toggle('hidden', mode !== 'ai');
    }

    // 텍스트 검색
    async function performSearch() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) {
        alert('검색어를 입력해주세요');
        return;
      }
      
      try {
        const response = await axios.get(\`/api/artworks?search=\${encodeURIComponent(query)}\`);
        displaySearchResults(response.data.data || []);
      } catch (error) {
        console.error('Search error:', error);
        alert('검색 중 오류가 발생했습니다');
      }
    }

    // 빠른 검색
    function quickSearch(keyword) {
      document.getElementById('searchInput').value = keyword;
      performSearch();
    }

    // 음성 검색
    function startVoiceSearch() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('이 브라우저는 음성 인식을 지원하지 않습니다');
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'ko-KR';
      recognition.continuous = false;
      recognition.interimResults = false;

      const micIcon = document.getElementById('micIcon');
      const voiceText = document.getElementById('voiceText');
      const recognizedText = document.getElementById('recognizedText');

      recognition.onstart = () => {
        micIcon.className = 'fas fa-microphone-slash text-white text-6xl animate-pulse';
        voiceText.textContent = '듣고 있습니다... 말씀해주세요';
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        recognizedText.textContent = '인식된 내용: "' + transcript + '"';
        recognizedText.classList.remove('hidden');
        
        // 인식된 텍스트로 검색
        setTimeout(() => {
          document.getElementById('searchInput').value = transcript;
          performSearch();
        }, 1000);
      };

      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        voiceText.textContent = '음성 인식 오류가 발생했습니다';
        micIcon.className = 'fas fa-microphone text-white text-6xl';
      };

      recognition.onend = () => {
        micIcon.className = 'fas fa-microphone text-white text-6xl';
        voiceText.textContent = '마이크 버튼을 클릭하여 음성으로 검색하세요';
      };

      recognition.start();
    }

    // AI 이미지 검색 설정
    const aiUploadArea = document.getElementById('aiUploadArea');
    const aiImageInput = document.getElementById('aiImageInput');
    const aiImagePreview = document.getElementById('aiImagePreview');
    const aiPreviewImg = document.getElementById('aiPreviewImg');

    aiUploadArea.addEventListener('click', () => aiImageInput.click());
    
    aiImageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          aiPreviewImg.src = event.target.result;
          aiUploadArea.classList.add('hidden');
          aiImagePreview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    });

    // AI 검색 수행
    async function performAISearch() {
      alert('AI 이미지 검색 기능은 곧 제공될 예정입니다.\\n\\n유사 이미지 분석 AI 모델을 학습 중입니다.');
    }

    // 검색 결과 표시
    function displaySearchResults(artworks) {
      const resultsSection = document.getElementById('searchResults');
      const resultsGrid = document.getElementById('resultsGrid');
      
      if (artworks.length === 0) {
        resultsGrid.innerHTML = '<p class="text-gray-400 col-span-full text-center py-12">검색 결과가 없습니다</p>';
        resultsSection.classList.remove('hidden');
        return;
      }

      resultsGrid.innerHTML = artworks.map(art => \`
        <a href="/artwork/\${art.id}" class="card-nft rounded-2xl overflow-hidden group">
          <div class="relative aspect-square bg-gray-900 overflow-hidden">
            <img src="\${art.image_url}" alt="\${art.title}" class="w-full h-full object-cover img-nft">
          </div>
          <div class="p-4">
            <h3 class="font-bold text-white mb-2 truncate">\${art.title}</h3>
            <p class="text-sm text-gray-400">\${art.artist_name}</p>
          </div>
        </a>
      \`).join('');
      
      resultsSection.classList.remove('hidden');
    }

    // 전문가 추천 작품 로드
    async function loadExpertRecommendations() {
      try {
        const response = await axios.get('/api/artworks?sort=estimated_value&order=DESC&limit=8');
        const artworks = response.data.data || [];
        
        const container = document.getElementById('expertRecommendations');
        if (artworks.length === 0) {
          container.innerHTML = '<p class="text-gray-400 col-span-full text-center py-12">추천 작품이 없습니다</p>';
          return;
        }

        container.innerHTML = artworks.map(art => \`
          <a href="/artwork/\${art.id}" class="card-nft rounded-2xl overflow-hidden group">
            <div class="relative aspect-square bg-gray-900 overflow-hidden">
              <img src="\${art.image_url}" alt="\${art.title}" class="w-full h-full object-cover img-nft">
              <div class="absolute top-3 left-3">
                <span class="px-3 py-1 bg-gradient-to-r from-yellow-600 to-orange-600 text-white text-xs font-bold rounded-full flex items-center">
                  <i class="fas fa-star mr-1"></i>전문가 추천
                </span>
              </div>
            </div>
            <div class="p-4">
              <h3 class="font-bold text-white mb-2 truncate">\${art.title}</h3>
              <div class="flex items-center justify-between">
                <span class="text-sm text-gray-400">\${art.artist_name}</span>
                <span class="text-xs text-gradient font-bold">\${art.category || ''}</span>
              </div>
            </div>
          </a>
        \`).join('');
      } catch (error) {
        console.error('Failed to load recommendations:', error);
        document.getElementById('expertRecommendations').innerHTML = 
          '<p class="text-red-500 col-span-full text-center py-12">추천 작품을 불러오는데 실패했습니다</p>';
      }
    }

    // 엔터키로 검색
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performSearch();
      }
    });

    // 페이지 로드 시 전문가 추천 작품 로드
    document.addEventListener('DOMContentLoaded', loadExpertRecommendations);
  </script>
  `;
  
  return c.html(getLayout(content, '스마트 검색 - GALLERYPIA'))
})

app.get('/artists', (c) => {
  const content = `
  <section class="py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <h1 class="text-6xl font-black mb-4">
              <span class="text-gradient">아티스트</span>
          </h1>
          <p class="text-gray-400 mb-12 text-lg">블록체인 기반 NFT 작품을 창작하는 아티스트들</p>
          
          <div id="artistsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
              <p class="text-gray-400 text-center col-span-full">로딩 중...</p>
          </div>
      </div>
  </section>
  
  <script>
    async function loadArtists() {
      try {
        const response = await axios.get('/api/artists');
        const artists = response.data.data || [];
        
        const list = document.getElementById('artistsList');
        if (artists.length === 0) {
          list.innerHTML = '<p class="text-gray-400 text-center col-span-full">등록된 아티스트가 없습니다.</p>';
          return;
        }
        
        list.innerHTML = artists.map(artist => \`
          <div class="card-nft rounded-3xl overflow-hidden">
              <div class="relative h-48 bg-gradient-to-br from-purple-900 to-cyan-900">
                  <div class="absolute inset-0 bg-gradient-to-t from-black to-transparent"></div>
              </div>
              <div class="p-6 -mt-16 relative z-10">
                  <div class="w-24 h-24 rounded-full border-4 border-black mb-4 overflow-hidden bg-gray-800">
                      <img src="\${artist.profile_image}" alt="\${artist.name}" class="w-full h-full object-cover">
                  </div>
                  <h3 class="font-bold text-2xl text-white mb-2">\${artist.name}</h3>
                  <p class="text-gray-400 text-sm mb-4">\${artist.bio || '아티스트 소개'}</p>
                  
                  <div class="grid grid-cols-3 gap-4 mb-4">
                      <div class="text-center">
                          <div class="text-2xl font-bold text-gradient">\${artist.artwork_count || 0}</div>
                          <div class="text-xs text-gray-500">작품</div>
                      </div>
                      <div class="text-center">
                          <div class="text-2xl font-bold text-gradient">\${artist.exhibitions_count || 0}</div>
                          <div class="text-xs text-gray-500">전시</div>
                      </div>
                      <div class="text-center">
                          <div class="text-2xl font-bold text-gradient">\${artist.awards_count || 0}</div>
                          <div class="text-xs text-gray-500">수상</div>
                      </div>
                  </div>
              </div>
          </div>
        \`).join('');
      } catch (error) {
        document.getElementById('artistsList').innerHTML = '<p class="text-red-500 text-center col-span-full">데이터를 불러오는데 실패했습니다.</p>';
      }
    }
    
    document.addEventListener('DOMContentLoaded', loadArtists);
  </script>
  `;
  
  return c.html(getLayout(content, '아티스트 - GALLERYPIA'))
})

app.get('/collections', (c) => {
  const content = `
  <section class="py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <h1 class="text-6xl font-black mb-4">
              <span class="text-gradient">컬렉션</span>
          </h1>
          <p class="text-gray-400 mb-12 text-lg">큐레이터가 엄선한 NFT 작품 컬렉션</p>
          
          <div id="collectionsList" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <p class="text-gray-400 text-center col-span-full">로딩 중...</p>
          </div>
      </div>
  </section>
  
  <script>
    async function loadCollections() {
      try {
        const response = await axios.get('/api/collections');
        const collections = response.data.data || [];
        
        const list = document.getElementById('collectionsList');
        if (collections.length === 0) {
          list.innerHTML = '<p class="text-gray-400 text-center col-span-full">등록된 컬렉션이 없습니다.</p>';
          return;
        }
        
        list.innerHTML = collections.map(collection => \`
          <div class="card-nft rounded-3xl overflow-hidden">
              <div class="relative h-64 bg-gray-900">
                  <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent"></div>
                  <div class="absolute bottom-4 left-4 right-4">
                      <h3 class="font-bold text-3xl text-white mb-2">\${collection.name}</h3>
                  </div>
              </div>
              <div class="p-6">
                  <p class="text-gray-400 mb-4">\${collection.description || '컬렉션 설명'}</p>
                  
                  <div class="flex items-center justify-between mb-4">
                      <div>
                          <div class="text-xs text-gray-500 mb-1">큐레이터</div>
                          <div class="text-white font-semibold">\${collection.curator_name || '익명'}</div>
                      </div>
                      <div class="text-right">
                          <div class="text-xs text-gray-500 mb-1">작품 수</div>
                          <div class="text-2xl font-black text-gradient">\${collection.artwork_count || 0}</div>
                      </div>
                  </div>
              </div>
          </div>
        \`).join('');
      } catch (error) {
        document.getElementById('collectionsList').innerHTML = '<p class="text-red-500 text-center col-span-full">데이터를 불러오는데 실패했습니다.</p>';
      }
    }
    
    document.addEventListener('DOMContentLoaded', loadCollections);
  </script>
  `;
  
  return c.html(getLayout(content, '컬렉션 - GALLERYPIA'))
})

// ============================================
// 회원가입 페이지
// ============================================
app.get('/signup', (c) => {
  const content = `
  <section class="min-h-screen py-20">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-12">
              <h1 class="text-5xl font-black mb-4">
                  <span class="text-gradient">회원가입</span>
              </h1>
              <p class="text-xl text-gray-400">갤러리피아에 오신 것을 환영합니다</p>
          </div>
          
          <div class="card-nft rounded-3xl p-8 md:p-12">
              <div id="alertMessage" class="hidden mb-6"></div>
              
              <!-- SNS 로그인 우선 -->
              <div class="mb-8">
                  <div class="text-center mb-4">
                      <p class="text-gray-400 text-sm">간편하게 시작하기</p>
                  </div>
                  <div class="grid grid-cols-3 gap-4 mb-6">
                      <button type="button" onclick="alert('Google 로그인 준비 중입니다')" class="py-3 px-4 bg-white hover:bg-gray-100 rounded-lg font-semibold text-gray-800 flex items-center justify-center transition-all">
                          <i class="fab fa-google mr-2 text-red-500"></i>
                          Google
                      </button>
                      <button type="button" onclick="alert('Facebook 로그인 준비 중입니다')" class="py-3 px-4 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold text-white flex items-center justify-center transition-all">
                          <i class="fab fa-facebook-f mr-2"></i>
                          Facebook
                      </button>
                      <button type="button" onclick="alert('Twitter 로그인 준비 중입니다')" class="py-3 px-4 bg-sky-500 hover:bg-sky-600 rounded-lg font-semibold text-white flex items-center justify-center transition-all">
                          <i class="fab fa-twitter mr-2"></i>
                          Twitter
                      </button>
                  </div>
                  <div class="relative">
                      <div class="absolute inset-0 flex items-center">
                          <div class="w-full border-t border-white border-opacity-10"></div>
                      </div>
                      <div class="relative flex justify-center text-sm">
                          <span class="px-4 bg-black text-gray-500">또는 이메일로 가입</span>
                      </div>
                  </div>
              </div>
              
              <form id="signupForm" class="space-y-6">
                  <!-- 기본 정보 -->
                  <div>
                      <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                          <i class="fas fa-user mr-3 text-gradient"></i>
                          기본 정보
                      </h3>
                      
                      <div class="grid md:grid-cols-2 gap-6">
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-envelope mr-2"></i>이메일 *
                              </label>
                              <input type="email" name="email" required
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                                     placeholder="your@email.com">
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-user-tag mr-2"></i>사용자명 *
                              </label>
                              <input type="text" name="username" required
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                                     placeholder="username">
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-id-card mr-2"></i>이름 *
                              </label>
                              <input type="text" name="full_name" required
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                                     placeholder="홍길동">
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-phone mr-2"></i>전화번호
                              </label>
                              <input type="tel" name="phone"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                                     placeholder="010-1234-5678">
                          </div>
                          
                          <div class="md:col-span-2">
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-lock mr-2"></i>비밀번호 *
                              </label>
                              <input type="password" name="password" required minlength="8"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                                     placeholder="최소 8자 이상">
                          </div>
                          
                          <div class="md:col-span-2">
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-lock mr-2"></i>비밀번호 확인 *
                              </label>
                              <input type="password" name="confirm_password" required minlength="8"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                                     placeholder="비밀번호를 다시 입력하세요">
                          </div>
                      </div>
                  </div>
                  
                  <!-- 역할 선택 -->
                  <div>
                      <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                          <i class="fas fa-user-shield mr-3 text-gradient"></i>
                          계정 유형 선택
                      </h3>
                      
                      <div class="grid md:grid-cols-2 gap-4">
                          <label class="relative cursor-pointer">
                              <input type="radio" name="role" value="buyer" checked class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-purple-500 peer-checked:bg-purple-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="flex items-center mb-3">
                                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 flex items-center justify-center mr-4">
                                          <i class="fas fa-shopping-cart text-white text-xl"></i>
                                      </div>
                                      <div class="text-xl font-bold text-white">구매자</div>
                                  </div>
                                  <p class="text-sm text-gray-400">NFT 작품을 구매하고 소장합니다</p>
                              </div>
                          </label>
                          
                          <label class="relative cursor-pointer">
                              <input type="radio" name="role" value="seller" class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-green-500 peer-checked:bg-green-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="flex items-center mb-3">
                                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 flex items-center justify-center mr-4">
                                          <i class="fas fa-store text-white text-xl"></i>
                                      </div>
                                      <div class="text-xl font-bold text-white">판매자</div>
                                  </div>
                                  <p class="text-sm text-gray-400">NFT 작품을 판매하고 거래합니다</p>
                              </div>
                          </label>
                          
                          <label class="relative cursor-pointer">
                              <input type="radio" name="role" value="artist" class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-amber-500 peer-checked:bg-amber-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="flex items-center mb-3">
                                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-amber-500 to-orange-500 flex items-center justify-center mr-4">
                                          <i class="fas fa-palette text-white text-xl"></i>
                                      </div>
                                      <div class="text-xl font-bold text-white">미술작가</div>
                                  </div>
                                  <p class="text-sm text-gray-400">작품을 등록하고 NFT로 민팅합니다</p>
                              </div>
                          </label>
                          
                          <label class="relative cursor-pointer">
                              <input type="radio" name="role" value="expert" class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-purple-500 peer-checked:bg-purple-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="flex items-center mb-3">
                                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center mr-4">
                                          <i class="fas fa-user-tie text-white text-xl"></i>
                                      </div>
                                      <div class="text-xl font-bold text-white">전문가</div>
                                  </div>
                                  <p class="text-sm text-gray-400">작품을 평가하고 ETH 보상을 받습니다</p>
                                  <p class="text-xs text-amber-400 mt-2"><i class="fas fa-coins mr-1"></i>평가당 0.01-0.1 ETH 보상</p>
                              </div>
                          </label>
                          
                          <label class="relative cursor-pointer">
                              <input type="radio" name="role" value="museum" class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-rose-500 peer-checked:bg-rose-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="flex items-center mb-3">
                                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-rose-500 to-red-500 flex items-center justify-center mr-4">
                                          <i class="fas fa-landmark text-white text-xl"></i>
                                      </div>
                                      <div class="text-xl font-bold text-white">뮤지엄</div>
                                  </div>
                                  <p class="text-sm text-gray-400">전시를 기획하고 작품을 큐레이션합니다</p>
                              </div>
                          </label>
                          
                          <label class="relative cursor-pointer">
                              <input type="radio" name="role" value="gallery" class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-teal-500 peer-checked:bg-teal-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="flex items-center mb-3">
                                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-teal-500 to-cyan-500 flex items-center justify-center mr-4">
                                          <i class="fas fa-building-columns text-white text-xl"></i>
                                      </div>
                                      <div class="text-xl font-bold text-white">갤러리</div>
                                  </div>
                                  <p class="text-sm text-gray-400">작품을 전시하고 거래를 중개합니다</p>
                              </div>
                          </label>
                      </div>
                  </div>
                  
                  <!-- 작가 추가 정보 -->
                  <div id="artist-fields" class="role-specific hidden">
                      <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                          <i class="fas fa-palette mr-3 text-gradient"></i>
                          작가 프로필 정보
                      </h3>
                      
                      <div class="grid md:grid-cols-2 gap-6">
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">작품 스타일</label>
                              <input type="text" name="art_style"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="예: 추상화, 사실주의">
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">주요 매체</label>
                              <input type="text" name="major_medium"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="예: 유화, 디지털">
                          </div>
                          
                          <div class="md:col-span-2">
                              <label class="block text-sm font-medium text-gray-300 mb-2">웹사이트/포트폴리오</label>
                              <input type="url" name="website"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="https://your-portfolio.com">
                          </div>
                          
                          <div class="md:col-span-2">
                              <label class="block text-sm font-medium text-gray-300 mb-2">자기소개</label>
                              <textarea name="bio" rows="3"
                                        class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                        placeholder="작가로서의 비전과 철학을 간단히 소개해주세요"></textarea>
                          </div>
                      </div>
                  </div>
                  
                  <!-- 전문가 안내 -->
                  <div id="expert-fields" class="role-specific hidden">
                      <div class="bg-amber-500 bg-opacity-10 border border-amber-500 border-opacity-30 rounded-lg p-6">
                          <h3 class="text-xl font-bold text-amber-400 mb-3 flex items-center">
                              <i class="fas fa-coins mr-3"></i>
                              전문가 평가 보상 시스템
                          </h3>
                          <p class="text-gray-300 mb-4">작품 평가 시 ETH로 보상을 받을 수 있습니다.</p>
                          <ul class="space-y-2 text-sm text-gray-400">
                              <li class="flex items-start">
                                  <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                                  <span>작품 평가당 0.01 ~ 0.1 ETH 보상</span>
                              </li>
                              <li class="flex items-start">
                                  <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                                  <span>정확하고 상세한 평가일수록 높은 보상</span>
                              </li>
                              <li class="flex items-start">
                                  <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                                  <span>평가 완료 후 즉시 지갑으로 지급</span>
                              </li>
                              <li class="flex items-start">
                                  <i class="fas fa-info-circle text-blue-400 mr-2 mt-1"></i>
                                  <span>전문가 등급에 따라 보상금 차등 지급</span>
                              </li>
                          </ul>
                      </div>
                  </div>
                  
                  <!-- Museum/Gallery 추가 정보 -->
                  <div id="museum-gallery-fields" class="role-specific hidden">
                      <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                          <i class="fas fa-building mr-3 text-gradient"></i>
                          기관 정보
                      </h3>
                      
                      <div class="grid md:grid-cols-2 gap-6">
                          <div class="md:col-span-2">
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-building mr-2"></i>기관명 *
                              </label>
                              <input type="text" name="organization_name"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="예: 서울 현대미술관">
                          </div>
                          
                          <div class="md:col-span-2">
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-map-marker-alt mr-2"></i>주소
                              </label>
                              <input type="text" name="organization_address"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="기관 주소">
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-globe mr-2"></i>웹사이트
                              </label>
                              <input type="url" name="organization_website"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="https://museum.example.com">
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-envelope mr-2"></i>기관 이메일
                              </label>
                              <input type="email" name="organization_contact_email"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="contact@museum.com">
                          </div>
                          
                          <div class="md:col-span-2">
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-info-circle mr-2"></i>기관 소개
                              </label>
                              <textarea name="organization_description" rows="3"
                                        class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                        placeholder="기관의 비전과 특징을 간단히 소개해주세요"></textarea>
                          </div>
                      </div>
                  </div>
                  
                  <!-- 약관 동의 -->
                  <div class="space-y-3">
                      <label class="flex items-center">
                          <input type="checkbox" required class="w-5 h-5 rounded bg-white bg-opacity-5 border-white border-opacity-10 text-purple-600 focus:ring-purple-500 mr-3">
                          <span class="text-sm text-gray-300">(필수) 이용약관 및 개인정보 처리방침에 동의합니다</span>
                      </label>
                      <label class="flex items-center">
                          <input type="checkbox" class="w-5 h-5 rounded bg-white bg-opacity-5 border-white border-opacity-10 text-purple-600 focus:ring-purple-500 mr-3">
                          <span class="text-sm text-gray-300">(선택) 마케팅 정보 수신에 동의합니다</span>
                      </label>
                  </div>
                  
                  <!-- 제출 버튼 -->
                  <div class="flex flex-col sm:flex-row gap-4 pt-6">
                      <button type="submit" 
                              class="flex-1 gradient-primary text-white py-4 rounded-xl font-bold text-lg hover:opacity-90 transition transform hover:scale-105">
                          <i class="fas fa-user-plus mr-2"></i>
                          회원가입
                      </button>
                      <a href="/login" 
                         class="flex-1 bg-white bg-opacity-5 text-white py-4 rounded-xl font-bold text-lg hover:bg-opacity-10 transition text-center">
                          <i class="fas fa-sign-in-alt mr-2"></i>
                          로그인하기
                      </a>
                  </div>
              </form>
          </div>
      </div>
  </section>
  
  <script src="/static/auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  `;
  
  return c.html(getLayout(content, '회원가입 - GALLERYPIA'))
})

// ============================================
// 로그인 페이지
// ============================================
app.get('/login', (c) => {
  const content = `
  <section class="min-h-screen flex items-center justify-center py-20">
      <div class="w-full max-w-md px-4">
          <div class="card-nft rounded-3xl p-8 neon-border">
              <div class="text-center mb-8">
                  <div class="inline-block p-4 rounded-full gradient-primary mb-4">
                      <i class="fas fa-sign-in-alt text-4xl text-white"></i>
                  </div>
                  <h1 class="text-3xl font-bold text-white mb-2">로그인</h1>
                  <p class="text-gray-400">갤러리피아에 오신 것을 환영합니다</p>
              </div>
              
              <div id="alertMessage" class="hidden mb-6"></div>
              
              <form id="loginForm" class="space-y-6">
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">
                          <i class="fas fa-envelope mr-2"></i>이메일
                      </label>
                      <input 
                          type="email" 
                          name="email" 
                          required
                          class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                          placeholder="your@email.com"
                      />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">
                          <i class="fas fa-lock mr-2"></i>비밀번호
                      </label>
                      <input 
                          type="password" 
                          name="password" 
                          required
                          class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                          placeholder="비밀번호를 입력하세요"
                      />
                  </div>
                  
                  <div class="flex items-center justify-between">
                      <label class="flex items-center">
                          <input type="checkbox" class="w-4 h-4 rounded bg-white bg-opacity-5 border-white border-opacity-10 text-purple-600 focus:ring-purple-500">
                          <span class="ml-2 text-sm text-gray-400">로그인 상태 유지</span>
                      </label>
                      <a href="#" class="text-sm text-purple-400 hover:text-purple-300">비밀번호 찾기</a>
                  </div>
                  
                  <button 
                      type="submit" 
                      class="w-full gradient-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition transform hover:scale-105">
                      <i class="fas fa-sign-in-alt mr-2"></i>로그인
                  </button>
              </form>
              
              <div class="mt-6 text-center">
                  <p class="text-sm text-gray-400">
                      아직 계정이 없으신가요?
                      <a href="/signup" class="text-purple-400 hover:text-purple-300 font-semibold ml-1">회원가입</a>
                  </p>
              </div>
              
              <div class="mt-8 pt-6 border-t border-white border-opacity-10">
                  <p class="text-xs text-gray-500 text-center mb-4">또는 다른 방법으로 로그인</p>
                  <div class="grid grid-cols-3 gap-3">
                      <button class="py-3 bg-white bg-opacity-5 hover:bg-opacity-10 rounded-lg transition">
                          <i class="fab fa-google text-xl text-gray-400"></i>
                      </button>
                      <button class="py-3 bg-white bg-opacity-5 hover:bg-opacity-10 rounded-lg transition">
                          <i class="fab fa-facebook text-xl text-gray-400"></i>
                      </button>
                      <button onclick="connectMetaMask()" class="py-3 bg-white bg-opacity-5 hover:bg-opacity-10 rounded-lg transition">
                          <i class="fas fa-wallet text-xl text-gray-400"></i>
                      </button>
                  </div>
              </div>
          </div>
      </div>
  </section>
  
  <script src="/static/auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  <script>
  async function connectMetaMask() {
    if (typeof window.ethereum === 'undefined') {
      alert('MetaMask를 설치해주세요');
      return;
    }
    
    try {
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      alert('지갑 연결 성공: ' + accounts[0]);
    } catch (error) {
      console.error('MetaMask connection error:', error);
    }
  }
  </script>
  `;
  
  return c.html(getLayout(content, '로그인 - GALLERYPIA'))
})

// ============================================
// 전문가 신청 페이지
// ============================================
app.get('/expert/apply', (c) => {
  const content = `
  <section class="min-h-screen py-20">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-12">
              <div class="inline-block p-4 rounded-full bg-gradient-to-r from-amber-500 to-orange-500 mb-4">
                  <i class="fas fa-user-tie text-4xl text-white"></i>
              </div>
              <h1 class="text-5xl font-black mb-4">
                  <span class="text-gradient">전문가 신청</span>
              </h1>
              <p class="text-xl text-gray-400">작품 평가 전문가로 활동하시겠습니까?</p>
          </div>
          
          <div class="card-nft rounded-3xl p-8 md:p-12">
              <div id="alertMessage" class="hidden mb-6"></div>
              
              <div class="bg-amber-500 bg-opacity-10 border border-amber-500 border-opacity-30 rounded-lg p-6 mb-8">
                  <h3 class="text-xl font-bold text-amber-400 mb-3 flex items-center">
                      <i class="fas fa-info-circle mr-3"></i>
                      전문가 신청 안내
                  </h3>
                  <ul class="space-y-2 text-sm text-gray-300">
                      <li class="flex items-start">
                          <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                          <span>전문가로 승인되면 작품 평가 및 의견 제공이 가능합니다</span>
                      </li>
                      <li class="flex items-start">
                          <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                          <span>평가 활동에 따라 보상 및 인센티브가 제공됩니다</span>
                      </li>
                      <li class="flex items-start">
                          <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                          <span>최소 3년 이상의 관련 경력이 필요합니다</span>
                      </li>
                      <li class="flex items-start">
                          <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                          <span>심사 기간은 1-3 영업일 소요됩니다</span>
                      </li>
                  </ul>
              </div>
              
              <form id="expertApplicationForm" class="space-y-8">
                  <!-- 전문가 유형 -->
                  <div>
                      <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                          <i class="fas fa-briefcase mr-3 text-gradient"></i>
                          전문가 유형 선택
                      </h3>
                      
                      <div class="grid md:grid-cols-2 gap-4">
                          <label class="relative cursor-pointer">
                              <input type="radio" name="expert_type" value="curator" checked class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-amber-500 peer-checked:bg-amber-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="text-lg font-bold text-white mb-2">큐레이터</div>
                                  <p class="text-sm text-gray-400">미술관 학예사, 전시 기획자</p>
                              </div>
                          </label>
                          
                          <label class="relative cursor-pointer">
                              <input type="radio" name="expert_type" value="dealer" class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-amber-500 peer-checked:bg-amber-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="text-lg font-bold text-white mb-2">딜러</div>
                                  <p class="text-sm text-gray-400">갤러리 디렉터, 아트 딜러</p>
                              </div>
                          </label>
                          
                          <label class="relative cursor-pointer">
                              <input type="radio" name="expert_type" value="critic" class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-amber-500 peer-checked:bg-amber-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="text-lg font-bold text-white mb-2">비평가</div>
                                  <p class="text-sm text-gray-400">미술 비평가, 저널리스트</p>
                              </div>
                          </label>
                          
                          <label class="relative cursor-pointer">
                              <input type="radio" name="expert_type" value="professor" class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-amber-500 peer-checked:bg-amber-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="text-lg font-bold text-white mb-2">교수/학자</div>
                                  <p class="text-sm text-gray-400">대학 교수, 미술사 연구자</p>
                              </div>
                          </label>
                      </div>
                  </div>
                  
                  <!-- 소속 및 경력 -->
                  <div>
                      <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                          <i class="fas fa-building mr-3 text-gradient"></i>
                          소속 및 경력
                      </h3>
                      
                      <div class="grid md:grid-cols-2 gap-6">
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-university mr-2"></i>소속 기관 *
                              </label>
                              <input type="text" name="institution" required
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="예: 서울시립미술관">
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-id-badge mr-2"></i>직책 *
                              </label>
                              <input type="text" name="position" required
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="예: 수석 큐레이터">
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-calendar-alt mr-2"></i>경력 연수 *
                              </label>
                              <input type="number" name="years_experience" required min="3"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="예: 5">
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-tags mr-2"></i>전문 분야 *
                              </label>
                              <input type="text" name="specialization" required
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="예: 현대미술, 한국화">
                          </div>
                      </div>
                  </div>
                  
                  <!-- 자격 및 증빙 -->
                  <div>
                      <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                          <i class="fas fa-certificate mr-3 text-gradient"></i>
                          자격 증빙
                      </h3>
                      
                      <div class="space-y-4">
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-file-pdf mr-2"></i>이력서 URL
                              </label>
                              <input type="url" name="resume_url"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="https://...">
                              <p class="text-xs text-gray-500 mt-1">Google Drive, Dropbox 등의 공개 링크</p>
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-folder-open mr-2"></i>포트폴리오 URL
                              </label>
                              <input type="url" name="portfolio_url"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="https://...">
                          </div>
                      </div>
                  </div>
                  
                  <!-- 지원 동기 -->
                  <div>
                      <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                          <i class="fas fa-pen mr-3 text-gradient"></i>
                          지원 동기 및 전문성
                      </h3>
                      
                      <div class="space-y-4">
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  전문가로 활동하고자 하는 이유 * (최소 100자)
                              </label>
                              <textarea name="motivation" required minlength="100" rows="4"
                                        class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                        placeholder="갤러리피아 전문가로 활동하고자 하는 이유와 기여할 수 있는 부분을 작성해주세요"></textarea>
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  전문 분야 상세 설명 * (최소 100자)
                              </label>
                              <textarea name="expertise_description" required minlength="100" rows="4"
                                        class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                        placeholder="본인의 전문 분야와 평가 능력에 대해 구체적으로 설명해주세요"></textarea>
                          </div>
                      </div>
                  </div>
                  
                  <!-- 약관 동의 -->
                  <div class="space-y-3 pt-4 border-t border-white border-opacity-10">
                      <label class="flex items-center">
                          <input type="checkbox" required class="w-5 h-5 rounded bg-white bg-opacity-5 border-white border-opacity-10 text-amber-600 focus:ring-amber-500 mr-3">
                          <span class="text-sm text-gray-300">(필수) 전문가 활동 약관 및 평가 가이드라인에 동의합니다</span>
                      </label>
                      <label class="flex items-center">
                          <input type="checkbox" required class="w-5 h-5 rounded bg-white bg-opacity-5 border-white border-opacity-10 text-amber-600 focus:ring-amber-500 mr-3">
                          <span class="text-sm text-gray-300">(필수) 제출한 정보가 사실임을 확인하며, 허위 작성 시 자격이 박탈될 수 있음을 인지합니다</span>
                      </label>
                  </div>
                  
                  <!-- 제출 버튼 -->
                  <div class="flex flex-col sm:flex-row gap-4 pt-6">
                      <button type="submit" 
                              class="flex-1 bg-gradient-to-r from-amber-500 to-orange-500 text-white py-4 rounded-xl font-bold text-lg hover:from-amber-600 hover:to-orange-600 transition transform hover:scale-105">
                          <i class="fas fa-paper-plane mr-2"></i>
                          신청서 제출
                      </button>
                      <a href="/" 
                         class="flex-1 bg-white bg-opacity-5 text-white py-4 rounded-xl font-bold text-lg hover:bg-opacity-10 transition text-center">
                          <i class="fas fa-arrow-left mr-2"></i>
                          취소
                      </a>
                  </div>
              </form>
          </div>
      </div>
  </section>
  
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  <script>
  document.getElementById('expertApplicationForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Get user session
    const sessionToken = localStorage.getItem('session_token');
    if (!sessionToken) {
      showError('로그인이 필요합니다');
      setTimeout(() => window.location.href = '/login', 1500);
      return;
    }
    
    const formData = new FormData(e.target);
    const data = {
      expert_type: formData.get('expert_type'),
      institution: formData.get('institution'),
      position: formData.get('position'),
      years_experience: parseInt(formData.get('years_experience')),
      specialization: formData.get('specialization'),
      resume_url: formData.get('resume_url') || null,
      portfolio_url: formData.get('portfolio_url') || null,
      motivation: formData.get('motivation'),
      expertise_description: formData.get('expertise_description')
    };
    
    try {
      const response = await axios.post('/api/expert/apply', data, {
        headers: { 'Authorization': 'Bearer ' + sessionToken }
      });
      
      if (response.data.success) {
        showSuccess('전문가 신청이 완료되었습니다! 심사 결과는 이메일로 안내드립니다.');
        setTimeout(() => window.location.href = '/mypage', 2000);
      } else {
        showError(response.data.error || '신청 중 오류가 발생했습니다');
      }
    } catch (error) {
      console.error('Application error:', error);
      showError(error.response?.data?.error || '신청 중 오류가 발생했습니다');
    }
  });
  
  function showSuccess(message) {
    const alertDiv = document.getElementById('alertMessage');
    alertDiv.className = 'mb-6 p-4 rounded-lg bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30';
    alertDiv.innerHTML = '<p class="text-green-400 text-sm"><i class="fas fa-check-circle mr-2"></i>' + message + '</p>';
    alertDiv.classList.remove('hidden');
  }
  
  function showError(message) {
    const alertDiv = document.getElementById('alertMessage');
    alertDiv.className = 'mb-6 p-4 rounded-lg bg-red-500 bg-opacity-10 border border-red-500 border-opacity-30';
    alertDiv.innerHTML = '<p class="text-red-400 text-sm"><i class="fas fa-exclamation-circle mr-2"></i>' + message + '</p>';
    alertDiv.classList.remove('hidden');
  }
  </script>
  `;
  
  return c.html(getLayout(content, '전문가 신청 - GALLERYPIA'))
})

app.get('/about', (c) => {
  const content = `
  <section class="py-16">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-16">
              <h1 class="text-6xl font-black mb-4">
                  <span class="text-gradient">GALLERYPIA</span>
              </h1>
              <p class="text-xl text-gray-400">NFT Art Museum Platform</p>
          </div>
          
          <div class="card-nft rounded-3xl p-12 mb-12">
              <h2 class="text-3xl font-bold text-white mb-6 text-center">Our Mission</h2>
              <p class="text-gray-300 text-lg leading-relaxed text-center">
                  갤러리피아는 블록체인 기술을 활용하여 미술품의 가치를 정량적, 정성적으로 평가하고<br>
                  투명하고 신뢰할 수 있는 NFT 거래 플랫폼을 제공합니다.
              </p>
          </div>
          
          <div class="mb-16">
              <h2 class="text-3xl font-bold text-white mb-8 text-center">Core Features</h2>
              <div class="grid md:grid-cols-3 gap-8">
                  <div class="card-nft rounded-2xl p-8 text-center">
                      <div class="w-16 h-16 bg-gradient-to-br from-purple-600 to-cyan-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                          <i class="fas fa-calculator text-white text-2xl"></i>
                      </div>
                      <h3 class="text-xl font-bold text-white mb-3">AI 가치산정</h3>
                      <p class="text-gray-400 text-sm">정량적/정성적 평가를 통한 공정한 작품 가치 산정</p>
                  </div>
                  
                  <div class="card-nft rounded-2xl p-8 text-center">
                      <div class="w-16 h-16 bg-gradient-to-br from-purple-600 to-cyan-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                          <i class="fas fa-cube text-white text-2xl"></i>
                      </div>
                      <h3 class="text-xl font-bold text-white mb-3">NFT 민팅</h3>
                      <p class="text-gray-400 text-sm">블록체인 기반의 안전한 NFT 발행 시스템</p>
                  </div>
                  
                  <div class="card-nft rounded-2xl p-8 text-center">
                      <div class="w-16 h-16 bg-gradient-to-br from-purple-600 to-cyan-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                          <i class="fas fa-shield-alt text-white text-2xl"></i>
                      </div>
                      <h3 class="text-xl font-bold text-white mb-3">저작권 보호</h3>
                      <p class="text-gray-400 text-sm">블록체인을 통한 투명한 저작권 관리</p>
                  </div>
              </div>
          </div>
          
          <div class="card-nft rounded-3xl p-12 mb-12">
              <h2 class="text-3xl font-bold text-white mb-6">Research Background</h2>
              <div class="space-y-6 text-gray-300">
                  <p class="leading-relaxed">갤러리피아는 블록체인 기반의 미술품 가치 평가 프레임워크 연구를 기반으로 개발되었습니다.</p>
                  <div class="bg-white bg-opacity-5 rounded-xl p-6 mb-6">
                      <h3 class="text-xl font-bold text-white mb-4"><i class="fas fa-presentation mr-2 text-gradient"></i>Conference Presentations</h3>
                      <ul class="space-y-3 text-sm">
                          <li class="flex items-start"><i class="fas fa-check-circle text-gradient mr-3 mt-1"></i><span>A Study on the Framework Process for Modular Services of Art NFT</span></li>
                          <li class="flex items-start"><i class="fas fa-check-circle text-gradient mr-3 mt-1"></i><span>Research into the valuation and ownership of artworks in the NFT market</span></li>
                          <li class="flex items-start"><i class="fas fa-check-circle text-gradient mr-3 mt-1"></i><span>Approach to NFT Service Framework Based on Art Value Calculation</span></li>
                          <li class="flex items-start"><i class="fas fa-check-circle text-gradient mr-3 mt-1"></i><span>Reflections on the perceived problems with Art NFTs</span></li>
                          <li class="flex items-start"><i class="fas fa-check-circle text-gradient mr-3 mt-1"></i><span>Research on NFT Artwork Ownership/Copyright Service Framework</span></li>
                          <li class="flex items-start"><i class="fas fa-check-circle text-gradient mr-3 mt-1"></i><span>Researching a Framework for Valuing NFT Artwork</span></li>
                      </ul>
                  </div>
                  <div class="bg-white bg-opacity-5 rounded-xl p-6">
                      <h3 class="text-xl font-bold text-white mb-4"><i class="fas fa-file-alt mr-2 text-gradient"></i>Published Papers</h3>
                      <ul class="space-y-3 text-sm">
                          <li class="flex items-start"><i class="fas fa-check-circle text-gradient mr-3 mt-1"></i><span>미술품 NFT 서비스 모듈별 기능 프레임워크 연구</span></li>
                          <li class="flex items-start"><i class="fas fa-check-circle text-gradient mr-3 mt-1"></i><span>NFT 미술품 구매/투자에 따른 문제점 분석과 해결방안 연구</span></li>
                          <li class="flex items-start"><i class="fas fa-check-circle text-gradient mr-3 mt-1"></i><span>NFT 미술작품 가치 평가 기반하의 랭크 프레임워크 연구</span></li>
                      </ul>
                  </div>
              </div>
          </div>
          
          <div class="mb-12">
              <h2 class="text-3xl font-bold text-white mb-8 text-center">Research Team</h2>
              <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                  <div class="card-nft rounded-2xl p-6 text-center">
                      <div class="text-xl font-bold text-gradient mb-2">남현우</div>
                      <div class="text-gray-400 text-sm">서경대학교 교수</div>
                      <div class="text-purple-400 text-xs mt-1">연구책임자</div>
                  </div>
                  <div class="card-nft rounded-2xl p-6 text-center">
                      <div class="text-xl font-bold text-gradient mb-2">남영우</div>
                      <div class="text-gray-400 text-sm">상원미술관 관장</div>
                  </div>
                  <div class="card-nft rounded-2xl p-6 text-center">
                      <div class="text-xl font-bold text-gradient mb-2">고주희</div>
                      <div class="text-gray-400 text-sm">연구원</div>
                  </div>
                  <div class="card-nft rounded-2xl p-6 text-center">
                      <div class="text-xl font-bold text-gradient mb-2">김시윤</div>
                      <div class="text-gray-400 text-sm">연구원</div>
                  </div>
                  <div class="card-nft rounded-2xl p-6 text-center">
                      <div class="text-xl font-bold text-gradient mb-2">안서영</div>
                      <div class="text-gray-400 text-sm">연구원</div>
                  </div>
                  <div class="card-nft rounded-2xl p-6 text-center">
                      <div class="text-xl font-bold text-gradient mb-2">김오윤</div>
                      <div class="text-gray-400 text-sm">연구원</div>
                  </div>
              </div>
              
              <h3 class="text-2xl font-bold text-white mb-6 text-center">Advisory Board</h3>
              <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div class="card-nft rounded-xl p-5 text-center">
                      <div class="text-lg font-semibold text-white mb-1">양연경 교수</div>
                      <div class="text-gray-400 text-xs">상명대학교 크리에이티브콘텐츠연구소 전임연구교수</div>
                  </div>
                  <div class="card-nft rounded-xl p-5 text-center">
                      <div class="text-lg font-semibold text-white mb-1">유해영 명예교수</div>
                      <div class="text-gray-400 text-xs">단국대학교 컴퓨터공학과</div>
                  </div>
                  <div class="card-nft rounded-xl p-5 text-center">
                      <div class="text-lg font-semibold text-white mb-1">김종원 교수</div>
                      <div class="text-gray-400 text-xs">상명대학교 지능 IoT, 블록체인</div>
                  </div>
                  <div class="card-nft rounded-xl p-5 text-center">
                      <div class="text-lg font-semibold text-white mb-1">이종빈 대표</div>
                      <div class="text-gray-400 text-xs">관훈아르테</div>
                  </div>
                  <div class="card-nft rounded-xl p-5 text-center">
                      <div class="text-lg font-semibold text-white mb-1">임영순 대표</div>
                      <div class="text-gray-400 text-xs">(주)코젠홀딩스</div>
                  </div>
                  <div class="card-nft rounded-xl p-5 text-center">
                      <div class="text-lg font-semibold text-white mb-1">육태석 학예사</div>
                      <div class="text-gray-400 text-xs">전쟁과여성인권 박물관</div>
                  </div>
              </div>
          </div>
      </div>
  </section>
  `;
  
  return c.html(getLayout(content, '소개 - GALLERYPIA'))
})

app.get('/collections', (c) => c.html(getLayout('<div class="py-20 text-center"><h1 class="text-4xl font-bold text-white mb-4">컬렉션</h1><p class="text-gray-400">준비 중입니다.</p></div>')))

// ============================================
// 관리자 로그인 페이지
// ============================================
app.get('/admin/login', (c) => {
  const content = `
  <section class="min-h-screen flex items-center justify-center py-20">
      <div class="w-full max-w-md">
          <div class="card-nft rounded-3xl p-8 neon-border">
              <div class="text-center mb-8">
                  <div class="inline-block p-4 rounded-full gradient-primary mb-4">
                      <i class="fas fa-shield-halved text-4xl text-white"></i>
                  </div>
                  <h1 class="text-3xl font-bold text-white mb-2">관리자 로그인</h1>
                  <p class="text-gray-400">GALLERYPIA Admin Portal</p>
              </div>
              
              <div id="loginError" class="hidden mb-4 p-4 rounded-lg bg-red-500 bg-opacity-10 border border-red-500 border-opacity-30">
                  <p class="text-red-400 text-sm"><i class="fas fa-exclamation-circle mr-2"></i><span id="errorMessage"></span></p>
              </div>
              
              <form id="loginForm" class="space-y-6">
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">
                          <i class="fas fa-user mr-2"></i>사용자명
                      </label>
                      <input 
                          type="text" 
                          id="username" 
                          name="username" 
                          required
                          class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                          placeholder="사용자명을 입력하세요"
                      />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">
                          <i class="fas fa-lock mr-2"></i>비밀번호
                      </label>
                      <input 
                          type="password" 
                          id="password" 
                          name="password" 
                          required
                          class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                          placeholder="비밀번호를 입력하세요"
                      />
                  </div>
                  
                  <div class="flex items-center justify-between">
                      <label class="flex items-center">
                          <input type="checkbox" class="w-4 h-4 rounded bg-white bg-opacity-5 border-white border-opacity-10 text-purple-600 focus:ring-purple-500" />
                          <span class="ml-2 text-sm text-gray-400">로그인 상태 유지</span>
                      </label>
                  </div>
                  
                  <button 
                      type="submit" 
                      class="w-full gradient-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition transform hover:scale-105"
                  >
                      <i class="fas fa-sign-in-alt mr-2"></i>로그인
                  </button>
              </form>
              
              <div class="mt-6 text-center">
                  <p class="text-sm text-gray-500">
                      <i class="fas fa-info-circle mr-1"></i>
                      기본 계정: admin / admin123
                  </p>
              </div>
          </div>
          
          <div class="mt-6 text-center">
              <a href="/" class="text-sm text-gray-400 hover:text-white transition">
                  <i class="fas fa-arrow-left mr-2"></i>메인 페이지로 돌아가기
              </a>
          </div>
      </div>
  </section>
  
  <script>
      document.getElementById('loginForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;
          const errorDiv = document.getElementById('loginError');
          const errorMsg = document.getElementById('errorMessage');
          
          try {
              const response = await fetch('/api/admin/login', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ username, password })
              });
              
              const data = await response.json();
              
              if (data.success) {
                  localStorage.setItem('admin_session', data.session_token);
                  window.location.href = '/admin/dashboard';
              } else {
                  errorDiv.classList.remove('hidden');
                  errorMsg.textContent = data.message || '로그인에 실패했습니다.';
              }
          } catch (error) {
              errorDiv.classList.remove('hidden');
              errorMsg.textContent = '서버 오류가 발생했습니다.';
          }
      });
  </script>
  `;
  
  return c.html(getLayout(content, '관리자 로그인 - GALLERYPIA'))
})

// ============================================
// 관리자 대시보드 페이지
// ============================================
app.get('/admin/dashboard', async (c) => {
  const content = `
  <section class="py-8">
      <div class="container mx-auto px-4">
          <!-- 헤더 -->
          <div class="flex justify-between items-center mb-8">
              <div>
                  <h1 class="text-4xl font-bold text-white mb-2">관리자 대시보드</h1>
                  <p class="text-gray-400">GALLERYPIA Admin Portal</p>
              </div>
              <div class="flex items-center gap-4">
                  <!-- 알림 아이콘 -->
                  <div class="relative">
                      <button id="notificationButton" onclick="toggleNotifications()" class="relative px-3 py-2 text-gray-400 hover:text-white transition">
                          <i class="fas fa-bell text-xl"></i>
                          <span id="notificationBadge" class="hidden absolute top-0 right-0 w-5 h-5 bg-red-500 rounded-full text-xs text-white flex items-center justify-center">0</span>
                      </button>
                      
                      <!-- 알림 드롭다운 -->
                      <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-96 bg-black border border-white border-opacity-10 rounded-2xl shadow-2xl z-50 max-h-96 overflow-y-auto">
                          <div class="p-4 border-b border-white border-opacity-10">
                              <div class="flex justify-between items-center">
                                  <h3 class="text-lg font-bold text-white">알림</h3>
                                  <button onclick="markAllNotificationsRead()" class="text-xs text-purple-400 hover:text-purple-300 transition">
                                      모두 읽음 표시
                                  </button>
                              </div>
                          </div>
                          <div id="notificationList" class="divide-y divide-white divide-opacity-5">
                              <!-- 동적으로 채워짐 -->
                          </div>
                      </div>
                  </div>
                  
                  <div class="text-right">
                      <p class="text-sm text-gray-400">로그인: <span id="adminName" class="text-white font-semibold">시스템 관리자</span></p>
                      <p class="text-xs text-gray-500">Role: <span id="adminRole" class="text-purple-400">super_admin</span></p>
                  </div>
                  <button onclick="logout()" class="px-4 py-2 bg-red-500 bg-opacity-20 hover:bg-opacity-30 text-red-400 rounded-lg transition">
                      <i class="fas fa-sign-out-alt mr-2"></i>로그아웃
                  </button>
              </div>
          </div>
          
          <!-- 통계 카드 -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
              <div class="card-nft rounded-2xl p-6 border-l-4 border-purple-500">
                  <div class="flex items-center justify-between mb-2">
                      <h3 class="text-gray-400 text-sm font-medium">총 작품 수</h3>
                      <i class="fas fa-palette text-2xl text-purple-500"></i>
                  </div>
                  <p class="text-3xl font-bold text-white mb-1" id="totalArtworks">0</p>
                  <p class="text-xs text-gray-500"><i class="fas fa-arrow-up text-green-400 mr-1"></i>민팅됨: <span id="mintedCount">0</span></p>
              </div>
              
              <div class="card-nft rounded-2xl p-6 border-l-4 border-cyan-500">
                  <div class="flex items-center justify-between mb-2">
                      <h3 class="text-gray-400 text-sm font-medium">등록 작가 수</h3>
                      <i class="fas fa-users text-2xl text-cyan-500"></i>
                  </div>
                  <p class="text-3xl font-bold text-white mb-1" id="totalArtists">0</p>
                  <p class="text-xs text-gray-500"><i class="fas fa-user-plus text-green-400 mr-1"></i>활동 중</p>
              </div>
              
              <div class="card-nft rounded-2xl p-6 border-l-4 border-yellow-500">
                  <div class="flex items-center justify-between mb-2">
                      <h3 class="text-gray-400 text-sm font-medium">총 거래액</h3>
                      <i class="fas fa-coins text-2xl text-yellow-500"></i>
                  </div>
                  <p class="text-3xl font-bold text-white mb-1" id="totalVolume">0 ETH</p>
                  <p class="text-xs text-gray-500"><i class="fas fa-chart-line text-green-400 mr-1"></i>이번 달</p>
              </div>
              
              <div class="card-nft rounded-2xl p-6 border-l-4 border-green-500">
                  <div class="flex items-center justify-between mb-2">
                      <h3 class="text-gray-400 text-sm font-medium">평가 대기</h3>
                      <i class="fas fa-clock text-2xl text-green-500"></i>
                  </div>
                  <p class="text-3xl font-bold text-white mb-1" id="pendingCount">0</p>
                  <p class="text-xs text-gray-500"><i class="fas fa-exclamation-circle text-yellow-400 mr-1"></i>검토 필요</p>
              </div>
          </div>
          
          <!-- 구매/경매 모니터링 섹션 -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
              <!-- 최근 구매 제안 -->
              <div class="card-nft rounded-2xl p-6">
                  <div class="flex justify-between items-center mb-4">
                      <h3 class="text-lg font-bold text-white flex items-center">
                          <i class="fas fa-shopping-cart text-purple-500 mr-2"></i>
                          최근 구매 제안
                      </h3>
                      <button onclick="refreshPurchaseOffers()" class="text-sm text-gray-400 hover:text-white transition">
                          <i class="fas fa-sync-alt mr-1"></i>새로고침
                      </button>
                  </div>
                  <div id="purchaseOffersList" class="space-y-3">
                      <div class="text-center py-4 text-gray-500">
                          <i class="fas fa-spinner fa-spin"></i>
                      </div>
                  </div>
              </div>
              
              <!-- 진행 중인 경매 -->
              <div class="card-nft rounded-2xl p-6">
                  <div class="flex justify-between items-center mb-4">
                      <h3 class="text-lg font-bold text-white flex items-center">
                          <i class="fas fa-gavel text-amber-500 mr-2"></i>
                          진행 중인 경매
                      </h3>
                      <button onclick="refreshAuctions()" class="text-sm text-gray-400 hover:text-white transition">
                          <i class="fas fa-sync-alt mr-1"></i>새로고침
                      </button>
                  </div>
                  <div id="auctionsList" class="space-y-3">
                      <div class="text-center py-4 text-gray-500">
                          <i class="fas fa-spinner fa-spin"></i>
                      </div>
                  </div>
              </div>
              
              <!-- 최근 거래 내역 -->
              <div class="card-nft rounded-2xl p-6 lg:col-span-2">
                  <div class="flex justify-between items-center mb-4">
                      <h3 class="text-lg font-bold text-white flex items-center">
                          <i class="fas fa-exchange-alt text-cyan-500 mr-2"></i>
                          최근 거래 내역
                      </h3>
                      <div class="flex gap-2">
                          <select id="transactionStatusFilter" onchange="refreshTransactions()" class="px-3 py-1 bg-gray-900 border border-gray-700 rounded-lg text-sm text-white">
                              <option value="">전체 상태</option>
                              <option value="pending">대기 중</option>
                              <option value="completed">완료</option>
                              <option value="failed">실패</option>
                          </select>
                          <button onclick="refreshTransactions()" class="text-sm text-gray-400 hover:text-white transition">
                              <i class="fas fa-sync-alt mr-1"></i>새로고침
                          </button>
                      </div>
                  </div>
                  <div id="transactionsList" class="overflow-x-auto">
                      <div class="text-center py-4 text-gray-500">
                          <i class="fas fa-spinner fa-spin"></i>
                      </div>
                  </div>
              </div>
          </div>
          
          <!-- 차트 섹션 -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
              <div class="card-nft rounded-2xl p-6">
                  <h3 class="text-lg font-bold text-white mb-4">월별 작품 등록 추이</h3>
                  <div style="position: relative; height: 250px;">
                      <canvas id="monthlyChart"></canvas>
                  </div>
              </div>
              
              <div class="card-nft rounded-2xl p-6">
                  <h3 class="text-lg font-bold text-white mb-4">카테고리별 분포</h3>
                  <div style="position: relative; height: 250px;">
                      <canvas id="categoryChart"></canvas>
                  </div>
              </div>
              
              <div class="card-nft rounded-2xl p-6">
                  <h3 class="text-lg font-bold text-white mb-4">가격대별 분포</h3>
                  <div style="position: relative; height: 250px;">
                      <canvas id="priceChart"></canvas>
                  </div>
              </div>
              
              <div class="card-nft rounded-2xl p-6">
                  <h3 class="text-lg font-bold text-white mb-4">상태별 작품 현황</h3>
                  <div style="position: relative; height: 250px;">
                      <canvas id="statusChart"></canvas>
                  </div>
              </div>
          </div>
          
          <!-- 탭 메뉴 -->
          <div class="mb-6">
              <div class="flex gap-2 border-b border-white border-opacity-10">
                  <button onclick="switchTab('artworks')" id="tab-artworks" class="tab-button active px-6 py-3 font-semibold transition">
                      <i class="fas fa-palette mr-2"></i>작품 관리
                  </button>
                  <button onclick="switchTab('artists')" id="tab-artists" class="tab-button px-6 py-3 font-semibold transition">
                      <i class="fas fa-users mr-2"></i>작가 관리
                  </button>
                  <button onclick="switchTab('valuations')" id="tab-valuations" class="tab-button px-6 py-3 font-semibold transition">
                      <i class="fas fa-chart-line mr-2"></i>가치 평가
                  </button>
                  <button onclick="switchTab('transactions')" id="tab-transactions" class="tab-button px-6 py-3 font-semibold transition">
                      <i class="fas fa-exchange-alt mr-2"></i>거래 내역
                  </button>
                  <button onclick="switchTab('logs')" id="tab-logs" class="tab-button px-6 py-3 font-semibold transition">
                      <i class="fas fa-history mr-2"></i>활동 로그
                  </button>
              </div>
          </div>
          
          <!-- 작품 관리 탭 -->
          <div id="content-artworks" class="tab-content">
              <div class="flex justify-between items-center mb-4">
                  <h2 class="text-2xl font-bold text-white">작품 목록</h2>
                  <div class="flex gap-2">
                      <button onclick="showOpenSeaImportModal()" class="px-4 py-2 bg-cyan-500 bg-opacity-20 hover:bg-opacity-30 text-cyan-400 rounded-lg transition">
                          <i class="fas fa-download mr-2"></i>OpenSea에서 가져오기
                      </button>
                      <button onclick="showAddArtworkModal()" class="px-4 py-2 gradient-primary text-white rounded-lg hover:opacity-90 transition">
                          <i class="fas fa-plus mr-2"></i>새 작품 등록
                      </button>
                  </div>
              </div>
              
              <!-- 검색 및 필터 -->
              <div class="card-nft rounded-2xl p-4 mb-4">
                  <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                      <div class="md:col-span-2">
                          <div class="relative">
                              <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                              <input type="text" id="artworkSearchInput" placeholder="작품명, 작가명 검색..." 
                                  class="w-full pl-12 pr-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500"
                                  onkeyup="searchArtworks()">
                          </div>
                      </div>
                      
                      <select id="artworkCategoryFilter" onchange="filterArtworks()" class="px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white">
                          <option value="">전체 카테고리</option>
                          <option value="디지털아트">디지털아트</option>
                          <option value="회화">회화</option>
                          <option value="조각">조각</option>
                          <option value="사진">사진</option>
                          <option value="판화">판화</option>
                          <option value="설치미술">설치미술</option>
                      </select>
                      
                      <select id="artworkStatusFilter" onchange="filterArtworks()" class="px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white">
                          <option value="">전체 상태</option>
                          <option value="draft">초안</option>
                          <option value="pending_review">검토 중</option>
                          <option value="approved">승인됨</option>
                          <option value="minted">민팅됨</option>
                          <option value="sold">판매됨</option>
                      </select>
                  </div>
                  
                  <div class="flex justify-between items-center mt-3 pt-3 border-t border-white border-opacity-10">
                      <div class="flex gap-2">
                          <button onclick="selectAllArtworks()" class="text-sm text-gray-400 hover:text-white transition">
                              <i class="fas fa-check-double mr-1"></i>전체 선택
                          </button>
                          <button onclick="deselectAllArtworks()" class="text-sm text-gray-400 hover:text-white transition">
                              <i class="fas fa-times mr-1"></i>선택 해제
                          </button>
                          <div id="bulkActions" class="hidden flex gap-2 ml-4 pl-4 border-l border-white border-opacity-10">
                              <select id="bulkStatusChange" class="px-3 py-1 bg-white bg-opacity-5 border border-white border-opacity-10 rounded text-sm text-white">
                                  <option value="">상태 일괄 변경</option>
                                  <option value="draft">초안</option>
                                  <option value="pending_review">검토 중</option>
                                  <option value="approved">승인됨</option>
                                  <option value="minted">민팅됨</option>
                                  <option value="sold">판매됨</option>
                              </select>
                              <button onclick="applyBulkAction()" class="px-3 py-1 bg-purple-500 bg-opacity-20 hover:bg-opacity-30 text-purple-400 rounded text-sm transition">
                                  <i class="fas fa-check mr-1"></i>적용
                              </button>
                              <button onclick="bulkDeleteArtworks()" class="px-3 py-1 bg-red-500 bg-opacity-20 hover:bg-opacity-30 text-red-400 rounded text-sm transition">
                                  <i class="fas fa-trash mr-1"></i>선택 삭제
                              </button>
                          </div>
                      </div>
                      
                      <select id="artworkSortOrder" onchange="sortArtworks()" class="px-3 py-1 bg-white bg-opacity-5 border border-white border-opacity-10 rounded text-sm text-white">
                          <option value="newest">최신순</option>
                          <option value="oldest">오래된순</option>
                          <option value="price_high">가격 높은순</option>
                          <option value="price_low">가격 낮은순</option>
                          <option value="name">이름순</option>
                      </select>
                  </div>
              </div>
              
              <div class="card-nft rounded-2xl overflow-hidden">
                  <div class="overflow-x-auto">
                      <table class="w-full">
                          <thead class="bg-white bg-opacity-5">
                              <tr>
                                  <th class="px-6 py-4 w-12">
                                      <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" 
                                          class="w-4 h-4 rounded bg-white bg-opacity-5 border-white border-opacity-10 text-purple-600">
                                  </th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">작품</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">작가</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">카테고리</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">가격</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">상태</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">작업</th>
                              </tr>
                          </thead>
                          <tbody id="artworksTableBody" class="divide-y divide-white divide-opacity-5">
                              <!-- 동적으로 채워짐 -->
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
          
          <!-- 작가 관리 탭 -->
          <div id="content-artists" class="tab-content hidden">
              <div class="flex justify-between items-center mb-6">
                  <h2 class="text-2xl font-bold text-white">작가 목록</h2>
                  <button onclick="showAddArtistModal()" class="px-4 py-2 gradient-primary text-white rounded-lg hover:opacity-90 transition">
                      <i class="fas fa-plus mr-2"></i>새 작가 등록
                  </button>
              </div>
              
              <div class="card-nft rounded-2xl overflow-hidden">
                  <div class="overflow-x-auto">
                      <table class="w-full">
                          <thead class="bg-white bg-opacity-5">
                              <tr>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">작가명</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">이메일</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">경력</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">작품 수</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">지갑 주소</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">작업</th>
                              </tr>
                          </thead>
                          <tbody id="artistsTableBody" class="divide-y divide-white divide-opacity-5">
                              <!-- 동적으로 채워짐 -->
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
          
          <!-- 가치 평가 탭 -->
          <div id="content-valuations" class="tab-content hidden">
              <h2 class="text-2xl font-bold text-white mb-6">가치 평가 대기 목록</h2>
              
              <div id="valuationsList" class="space-y-4">
                  <!-- 동적으로 채워짐 -->
              </div>
          </div>
          
          <!-- 거래 내역 탭 -->
          <div id="content-transactions" class="tab-content hidden">
              <h2 class="text-2xl font-bold text-white mb-6">거래 내역</h2>
              
              <div class="card-nft rounded-2xl overflow-hidden">
                  <div class="overflow-x-auto">
                      <table class="w-full">
                          <thead class="bg-white bg-opacity-5">
                              <tr>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">거래 ID</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">작품</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">유형</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">가격</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">상태</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">날짜</th>
                              </tr>
                          </thead>
                          <tbody id="transactionsTableBody" class="divide-y divide-white divide-opacity-5">
                              <!-- 동적으로 채워짐 -->
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
          
          <!-- 활동 로그 탭 -->
          <div id="content-logs" class="tab-content hidden">
              <div class="flex justify-between items-center mb-6">
                  <h2 class="text-2xl font-bold text-white">활동 로그</h2>
                  <div class="flex gap-2">
                      <select id="logActionFilter" onchange="loadActivityLogs()" class="px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white text-sm">
                          <option value="">모든 활동</option>
                          <option value="login">로그인</option>
                          <option value="logout">로그아웃</option>
                          <option value="create_artwork">작품 추가</option>
                          <option value="update_artwork">작품 수정</option>
                          <option value="delete_artwork">작품 삭제</option>
                          <option value="create_artist">작가 추가</option>
                          <option value="update_artist">작가 수정</option>
                          <option value="delete_artist">작가 삭제</option>
                      </select>
                  </div>
              </div>
              
              <div class="card-nft rounded-2xl overflow-hidden">
                  <div class="overflow-x-auto">
                      <table class="w-full">
                          <thead class="bg-white bg-opacity-5">
                              <tr>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">시간</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">관리자</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">활동</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">대상</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">상세</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">IP 주소</th>
                              </tr>
                          </thead>
                          <tbody id="logsTableBody" class="divide-y divide-white divide-opacity-5">
                              <!-- 동적으로 채워짐 -->
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      </div>
  </section>
  
  <style>
      .tab-button {
          color: #9ca3af;
          border-bottom: 2px solid transparent;
      }
      
      .tab-button.active {
          color: #8b5cf6;
          border-bottom-color: #8b5cf6;
      }
      
      .tab-button:hover {
          color: #ffffff;
      }
  </style>
  
  <!-- 작품 추가/수정 모달 -->
  <div id="artworkModal" class="hidden fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div class="bg-black border border-white border-opacity-10 rounded-3xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
              <h2 id="artworkModalTitle" class="text-2xl font-bold text-white">새 작품 등록</h2>
              <button onclick="closeArtworkModal()" class="text-gray-400 hover:text-white transition">
                  <i class="fas fa-times text-2xl"></i>
              </button>
          </div>
          
          <form id="artworkForm" class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                  <div class="col-span-2">
                      <label class="block text-sm font-medium text-gray-300 mb-2">작품명 *</label>
                      <input type="text" id="artwork_title" name="title" required class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">작가 선택 *</label>
                      <select id="artwork_artist_id" name="artist_id" required class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white">
                          <option value="">작가를 선택하세요</option>
                      </select>
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">카테고리 *</label>
                      <select id="artwork_category" name="category" required class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white">
                          <option value="디지털아트">디지털아트</option>
                          <option value="회화">회화</option>
                          <option value="조각">조각</option>
                          <option value="사진">사진</option>
                          <option value="판화">판화</option>
                          <option value="설치미술">설치미술</option>
                      </select>
                  </div>
                  
                  <div class="col-span-2">
                      <label class="block text-sm font-medium text-gray-300 mb-2">설명</label>
                      <textarea id="artwork_description" name="description" rows="3" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white"></textarea>
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">기법</label>
                      <input type="text" id="artwork_technique" name="technique" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">제작년도</label>
                      <input type="number" id="artwork_creation_year" name="creation_year" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">가로 (cm)</label>
                      <input type="number" id="artwork_size_width" name="size_width" step="0.1" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">세로 (cm)</label>
                      <input type="number" id="artwork_size_height" name="size_height" step="0.1" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div class="col-span-2">
                      <label class="block text-sm font-medium text-gray-300 mb-2">이미지 *</label>
                      
                      <!-- 탭 선택 -->
                      <div class="flex gap-2 mb-3">
                          <button type="button" id="uploadTabBtn" onclick="switchImageTab('upload')" class="flex-1 px-4 py-2 bg-purple-500 bg-opacity-20 text-purple-400 rounded-lg text-sm font-semibold transition">
                              <i class="fas fa-upload mr-2"></i>파일 업로드
                          </button>
                          <button type="button" id="urlTabBtn" onclick="switchImageTab('url')" class="flex-1 px-4 py-2 bg-white bg-opacity-5 text-gray-400 rounded-lg text-sm font-semibold transition">
                              <i class="fas fa-link mr-2"></i>URL 입력
                          </button>
                      </div>
                      
                      <!-- 파일 업로드 영역 -->
                      <div id="uploadArea" class="upload-area">
                          <div id="dropZone" class="border-2 border-dashed border-white border-opacity-20 rounded-lg p-8 text-center hover:border-purple-500 hover:bg-purple-500 hover:bg-opacity-5 transition cursor-pointer">
                              <i class="fas fa-cloud-upload-alt text-4xl text-purple-500 mb-3"></i>
                              <p class="text-white mb-2">드래그 앤 드롭 또는 클릭하여 파일 선택</p>
                              <p class="text-sm text-gray-500">JPG, PNG, GIF, WebP (최대 10MB)</p>
                              <input type="file" id="artwork_image_file" accept="image/*" class="hidden" onchange="handleFileSelect(event)" />
                          </div>
                          
                          <div id="uploadProgress" class="hidden mt-3">
                              <div class="flex items-center justify-between mb-2">
                                  <span class="text-sm text-gray-400">업로드 중...</span>
                                  <span id="uploadPercent" class="text-sm text-purple-400">0%</span>
                              </div>
                              <div class="w-full bg-white bg-opacity-10 rounded-full h-2">
                                  <div id="uploadBar" class="bg-gradient-to-r from-purple-500 to-cyan-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                              </div>
                          </div>
                      </div>
                      
                      <!-- URL 입력 영역 -->
                      <div id="urlArea" class="hidden">
                          <input type="url" id="artwork_image_url" name="image_url" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" placeholder="https://..." />
                      </div>
                      
                      <input type="hidden" id="artwork_final_image_url" name="final_image_url" required />
                  </div>
                  
                  <div id="imagePreviewContainer" class="col-span-2 hidden">
                      <label class="block text-sm font-medium text-gray-300 mb-2">미리보기</label>
                      <div class="relative">
                          <img id="imagePreview" src="" alt="미리보기" class="w-full h-64 object-cover rounded-lg" />
                          <button type="button" onclick="removeImage()" class="absolute top-2 right-2 w-8 h-8 bg-red-500 bg-opacity-80 hover:bg-opacity-100 text-white rounded-full transition">
                              <i class="fas fa-times"></i>
                          </button>
                      </div>
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">가격 (원)</label>
                      <input type="number" id="artwork_current_price" name="current_price" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">상태</label>
                      <select id="artwork_status" name="status" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white">
                          <option value="draft">초안</option>
                          <option value="pending_review">검토 중</option>
                          <option value="approved">승인됨</option>
                          <option value="minted">민팅됨</option>
                          <option value="sold">판매됨</option>
                      </select>
                  </div>
              </div>
              
              <div class="flex gap-3 pt-4">
                  <button type="button" onclick="saveArtwork()" class="flex-1 gradient-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
                      <i class="fas fa-save mr-2"></i>저장
                  </button>
                  <button type="button" onclick="closeArtworkModal()" class="px-6 py-3 bg-gray-500 bg-opacity-20 text-gray-300 rounded-lg hover:bg-opacity-30 transition">
                      취소
                  </button>
              </div>
          </form>
      </div>
  </div>
  
  <!-- 작가 추가/수정 모달 -->
  <div id="artistModal" class="hidden fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div class="bg-black border border-white border-opacity-10 rounded-3xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
              <h2 id="artistModalTitle" class="text-2xl font-bold text-white">새 작가 등록</h2>
              <button onclick="closeArtistModal()" class="text-gray-400 hover:text-white transition">
                  <i class="fas fa-times text-2xl"></i>
              </button>
          </div>
          
          <form id="artistForm" class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">작가명 *</label>
                      <input type="text" id="artist_name" name="name" required class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">이메일 *</label>
                      <input type="email" id="artist_email" name="email" required class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div class="col-span-2">
                      <label class="block text-sm font-medium text-gray-300 mb-2">약력</label>
                      <textarea id="artist_bio" name="bio" rows="3" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white"></textarea>
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">경력 (년)</label>
                      <input type="number" id="artist_career_years" name="career_years" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">학력</label>
                      <input type="text" id="artist_education" name="education" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">개인전 횟수</label>
                      <input type="number" id="artist_solo_exhibitions" name="solo_exhibitions" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">단체전 횟수</label>
                      <input type="number" id="artist_group_exhibitions" name="group_exhibitions" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">공모전 수상</label>
                      <input type="number" id="artist_awards" name="awards" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div class="col-span-2">
                      <label class="block text-sm font-medium text-gray-300 mb-2">지갑 주소</label>
                      <input type="text" id="artist_wallet_address" name="wallet_address" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white font-mono text-sm" placeholder="0x..." />
                  </div>
              </div>
              
              <div class="flex gap-3 pt-4">
                  <button type="button" onclick="saveArtist()" class="flex-1 gradient-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
                      <i class="fas fa-save mr-2"></i>저장
                  </button>
                  <button type="button" onclick="closeArtistModal()" class="px-6 py-3 bg-gray-500 bg-opacity-20 text-gray-300 rounded-lg hover:bg-opacity-30 transition">
                      취소
                  </button>
              </div>
          </form>
      </div>
  </div>
  
  <!-- OpenSea 가져오기 모달 -->
  <div id="openSeaModal" class="hidden fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div class="bg-black border border-white border-opacity-10 rounded-3xl p-8 max-w-6xl w-full max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold text-white">OpenSea에서 가져오기</h2>
              <button onclick="closeOpenSeaModal()" class="text-gray-400 hover:text-white transition">
                  <i class="fas fa-times text-2xl"></i>
              </button>
          </div>
          
          <!-- Step 1: API 설정 및 URL 입력 -->
          <div id="openSeaStep1" class="space-y-4">
              <div class="bg-purple-500 bg-opacity-10 border border-purple-500 border-opacity-30 rounded-xl p-4 mb-4">
                  <div class="flex items-start gap-3">
                      <i class="fas fa-info-circle text-purple-400 text-xl mt-0.5"></i>
                      <div class="text-sm text-purple-300">
                          <p class="font-semibold mb-2">OpenSea API 사용 방법:</p>
                          <ol class="list-decimal ml-4 space-y-1 text-xs">
                              <li>OpenSea 웹사이트에서 원하는 컬렉션 페이지로 이동</li>
                              <li>브라우저 주소창의 URL을 복사 (예: https://opensea.io/collection/azuki)</li>
                              <li>OpenSea API 키가 있다면 입력 (실제 데이터 조회)</li>
                              <li>"작품 조회" 버튼을 클릭하여 최대 100개 작품 로드</li>
                          </ol>
                      </div>
                  </div>
              </div>
              
              <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">
                      OpenSea API Key (선택사항)
                      <a href="https://opensea.io/account/settings/developer" target="_blank" class="text-cyan-400 hover:underline text-xs ml-2">
                          <i class="fas fa-external-link-alt"></i> API 키 발급받기
                      </a>
                  </label>
                  <input type="text" id="openSeaApiKey" placeholder="sk_live_... 또는 비워두기 (데모 데이터)" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white font-mono text-sm" />
                  <p class="text-xs text-gray-500 mt-1">
                      <i class="fas fa-lightbulb text-yellow-500"></i> 
                      API 키 없이도 작동하지만, 데모 데이터만 표시됩니다. 실제 OpenSea 데이터를 가져오려면 API 키를 입력하세요.
                  </p>
              </div>
              
              <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">OpenSea 컬렉션 URL 또는 슬러그 *</label>
                  <input type="text" id="openSeaCollectionUrl" placeholder="https://opensea.io/collection/azuki 또는 azuki" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  <p class="text-xs text-gray-500 mt-1">전체 URL 또는 컬렉션 슬러그만 입력 가능 (최대 100개 작품 조회)</p>
              </div>
              
              <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">조회할 작품 수</label>
                  <select id="openSeaLimit" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white">
                      <option value="20">20개</option>
                      <option value="50" selected>50개</option>
                      <option value="100">100개</option>
                  </select>
              </div>
              
              <div class="flex gap-3 pt-4">
                  <button type="button" onclick="loadOpenSeaArtworks()" class="flex-1 gradient-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
                      <i class="fas fa-search mr-2"></i>작품 조회
                  </button>
                  <button type="button" onclick="closeOpenSeaModal()" class="px-6 py-3 bg-gray-500 bg-opacity-20 text-gray-300 rounded-lg hover:bg-opacity-30 transition">
                      취소
                  </button>
              </div>
          </div>
          
          <!-- Step 2: 작품 선택 -->
          <div id="openSeaStep2" class="hidden space-y-4">
              <div class="flex justify-between items-center mb-4">
                  <div>
                      <h3 class="text-lg font-bold text-white">작품 선택</h3>
                      <p class="text-sm text-gray-400">가져올 작품을 선택하세요 (<span id="selectedCount">0</span>개 선택됨)</p>
                  </div>
                  <div class="flex gap-2">
                      <button type="button" onclick="selectAllArtworks()" class="px-4 py-2 bg-purple-500 bg-opacity-20 text-purple-400 rounded-lg hover:bg-opacity-30 transition text-sm">
                          <i class="fas fa-check-double mr-1"></i>전체 선택
                      </button>
                      <button type="button" onclick="deselectAllArtworks()" class="px-4 py-2 bg-gray-500 bg-opacity-20 text-gray-400 rounded-lg hover:bg-opacity-30 transition text-sm">
                          <i class="fas fa-times mr-1"></i>전체 해제
                      </button>
                  </div>
              </div>
              
              <div id="openSeaArtworksList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-96 overflow-y-auto p-2">
                  <!-- 동적으로 채워짐 -->
              </div>
              
              <div class="flex gap-3 pt-4 border-t border-white border-opacity-10">
                  <button type="button" onclick="backToStep1()" class="px-6 py-3 bg-gray-500 bg-opacity-20 text-gray-300 rounded-lg hover:bg-opacity-30 transition">
                      <i class="fas fa-arrow-left mr-2"></i>이전
                  </button>
                  <button type="button" onclick="importSelectedArtworks()" class="flex-1 gradient-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
                      <i class="fas fa-download mr-2"></i>선택한 작품 가져오기
                  </button>
                  <button type="button" onclick="closeOpenSeaModal()" class="px-6 py-3 bg-gray-500 bg-opacity-20 text-gray-300 rounded-lg hover:bg-opacity-30 transition">
                      취소
                  </button>
              </div>
          </div>
      </div>
  </div>
  
  <script src="/static/admin-dashboard.js"></script>
  <script src="/static/admin-modals.js"></script>
  <script src="/static/admin-valuation.js"></script>
  <script>
      // 작가 목록 로드하여 셀렉트박스 채우기
      async function loadArtistOptions() {
          try {
              const response = await fetch('/api/admin/artists');
              const data = await response.json();
              
              if (data.success) {
                  const select = document.getElementById('artwork_artist_id');
                  select.innerHTML = '<option value="">작가를 선택하세요</option>';
                  
                  data.data.forEach(artist => {
                      const option = document.createElement('option');
                      option.value = artist.id;
                      option.textContent = artist.name;
                      select.appendChild(option);
                  });
              }
          } catch (error) {
              console.error('작가 목록 로드 실패:', error);
          }
      }
      
      // 페이지 로드 시 작가 목록 로드
      loadArtistOptions();
      
      // ========== 구매/경매 모니터링 함수 ==========
      
      // 최근 거래 내역 로드
      async function refreshTransactions() {
        const sessionToken = localStorage.getItem('admin_session_token');
        if (!sessionToken) return;
        
        const status = document.getElementById('transactionStatusFilter').value;
        
        try {
          const response = await axios.get('/api/admin/transactions', {
            params: { status, limit: 10 },
            headers: { 'Authorization': 'Bearer ' + sessionToken }
          });
          
          if (response.data.success && response.data.data.length > 0) {
            document.getElementById('transactionsList').innerHTML = \`
              <table class="w-full text-sm">
                <thead class="border-b border-gray-700">
                  <tr class="text-left text-gray-400">
                    <th class="py-2">작품</th>
                    <th class="py-2">구매자</th>
                    <th class="py-2">판매자</th>
                    <th class="py-2">가격</th>
                    <th class="py-2">상태</th>
                    <th class="py-2">날짜</th>
                  </tr>
                </thead>
                <tbody>
                  \${response.data.data.map(tx => \`
                    <tr class="border-b border-gray-800 hover:bg-gray-900">
                      <td class="py-3">
                        <div class="flex items-center gap-2">
                          <img src="\${tx.artwork_image}" class="w-10 h-10 rounded-lg object-cover" />
                          <span class="text-white">\${tx.artwork_title}</span>
                        </div>
                      </td>
                      <td class="py-3 text-gray-300">\${tx.buyer_name || tx.buyer_username || '-'}</td>
                      <td class="py-3 text-gray-300">\${tx.seller_name || tx.seller_username || '-'}</td>
                      <td class="py-3 text-white font-semibold">\${tx.price} \${tx.currency}</td>
                      <td class="py-3">
                        <span class="px-2 py-1 rounded-full text-xs \${
                          tx.status === 'completed' ? 'bg-green-500 bg-opacity-20 text-green-400' :
                          tx.status === 'pending' ? 'bg-yellow-500 bg-opacity-20 text-yellow-400' :
                          'bg-red-500 bg-opacity-20 text-red-400'
                        }">
                          \${tx.status === 'completed' ? '완료' : tx.status === 'pending' ? '대기중' : '실패'}
                        </span>
                      </td>
                      <td class="py-3 text-gray-400 text-xs">\${new Date(tx.created_at).toLocaleDateString('ko-KR')}</td>
                    </tr>
                  \`).join('')}
                </tbody>
              </table>
            \`;
          } else {
            document.getElementById('transactionsList').innerHTML = \`
              <div class="text-center py-8 text-gray-500">거래 내역이 없습니다</div>
            \`;
          }
        } catch (error) {
          console.error('Transactions fetch error:', error);
          document.getElementById('transactionsList').innerHTML = \`
            <div class="text-center py-4 text-red-400">거래 내역을 불러올 수 없습니다</div>
          \`;
        }
      }
      
      // 진행 중인 경매 로드
      async function refreshAuctions() {
        const sessionToken = localStorage.getItem('admin_session_token');
        if (!sessionToken) return;
        
        try {
          const response = await axios.get('/api/admin/auctions', {
            params: { status: 'active', limit: 5 },
            headers: { 'Authorization': 'Bearer ' + sessionToken }
          });
          
          if (response.data.success && response.data.data.length > 0) {
            document.getElementById('auctionsList').innerHTML = response.data.data.map(auction => {
              const endTime = new Date(auction.end_time);
              const now = new Date();
              const timeLeft = endTime - now;
              const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
              const daysLeft = Math.floor(hoursLeft / 24);
              
              let timeLeftText = '';
              if (timeLeft < 0) {
                timeLeftText = '<span class="text-red-400">종료됨</span>';
              } else if (daysLeft > 0) {
                timeLeftText = daysLeft + '일 ' + (hoursLeft % 24) + '시간';
              } else {
                timeLeftText = hoursLeft + '시간';
              }
              
              return \`
                <div class="bg-gray-900 rounded-lg p-4">
                  <div class="flex items-center gap-3 mb-3">
                    <img src="\${auction.artwork_image}" class="w-16 h-16 rounded-lg object-cover" />
                    <div class="flex-1">
                      <div class="text-white font-semibold">\${auction.artwork_title}</div>
                      <div class="text-xs text-gray-400">판매자: \${auction.seller_name || auction.seller_username}</div>
                    </div>
                  </div>
                  <div class="grid grid-cols-3 gap-2 text-xs">
                    <div>
                      <div class="text-gray-500">현재가</div>
                      <div class="text-white font-bold">\${auction.current_price} ETH</div>
                    </div>
                    <div>
                      <div class="text-gray-500">입찰 수</div>
                      <div class="text-white font-bold">\${auction.total_bids}회</div>
                    </div>
                    <div>
                      <div class="text-gray-500">남은시간</div>
                      <div class="text-white font-bold">\${timeLeftText}</div>
                    </div>
                  </div>
                </div>
              \`;
            }).join('');
          } else {
            document.getElementById('auctionsList').innerHTML = \`
              <div class="text-center py-8 text-gray-500">진행 중인 경매가 없습니다</div>
            \`;
          }
        } catch (error) {
          console.error('Auctions fetch error:', error);
          document.getElementById('auctionsList').innerHTML = \`
            <div class="text-center py-4 text-red-400">경매 목록을 불러올 수 없습니다</div>
          \`;
        }
      }
      
      // 구매 제안 목록 로드  
      async function refreshPurchaseOffers() {
        // Purchase offers는 아직 API가 없으므로 placeholder 표시
        document.getElementById('purchaseOffersList').innerHTML = \`
          <div class="text-center py-8 text-gray-500">
            구매 제안 기능은 추후 추가될 예정입니다
          </div>
        \`;
      }
      
      // 페이지 로드 시 모니터링 데이터 로드
      refreshTransactions();
      refreshAuctions();
      refreshPurchaseOffers();
  </script>
  `;
  
  return c.html(getLayout(content, '관리자 대시보드 - GALLERYPIA'))
})

// ============================================
// 관리자 API 엔드포인트
// ============================================

// 로그인 API
app.post('/api/admin/login', async (c) => {
  const { username, password } = await c.req.json()
  
  // SHA-256 해시 생성 (간단한 예시, 실제로는 bcrypt 사용 권장)
  const encoder = new TextEncoder()
  const data = encoder.encode(password)
  const hashBuffer = await crypto.subtle.digest('SHA-256', data)
  const hashArray = Array.from(new Uint8Array(hashBuffer))
  const passwordHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('')
  
  const db = c.env.DB
  
  // 사용자 확인
  const user = await db.prepare(`
    SELECT * FROM admin_users 
    WHERE username = ? AND password_hash = ? AND is_active = 1
  `).bind(username, passwordHash).first()
  
  if (!user) {
    return c.json({ success: false, message: '사용자명 또는 비밀번호가 올바르지 않습니다.' })
  }
  
  // 세션 토큰 생성
  const sessionToken = crypto.randomUUID()
  const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString() // 24시간
  
  // 세션 저장
  await db.prepare(`
    INSERT INTO admin_sessions (session_token, admin_user_id, expires_at)
    VALUES (?, ?, ?)
  `).bind(sessionToken, user.id, expiresAt).run()
  
  // 마지막 로그인 시간 업데이트
  await db.prepare(`
    UPDATE admin_users SET last_login_at = CURRENT_TIMESTAMP WHERE id = ?
  `).bind(user.id).run()
  
  // 활동 로그 기록
  await db.prepare(`
    INSERT INTO admin_activity_logs (admin_user_id, action, details)
    VALUES (?, 'login', ?)
  `).bind(user.id, JSON.stringify({ username })).run()
  
  return c.json({ 
    success: true, 
    session_token: sessionToken,
    user: {
      id: user.id,
      username: user.username,
      email: user.email,
      full_name: user.full_name,
      role: user.role
    }
  })
})

// 로그아웃 API
app.post('/api/admin/logout', async (c) => {
  const sessionToken = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!sessionToken) {
    return c.json({ success: false, message: '세션 토큰이 없습니다.' })
  }
  
  const db = c.env.DB
  
  // 세션 삭제
  await db.prepare(`
    DELETE FROM admin_sessions WHERE session_token = ?
  `).bind(sessionToken).run()
  
  return c.json({ success: true })
})

// 관리자 통계 API
app.get('/api/admin/stats', async (c) => {
  const db = c.env.DB
  
  const totalArtworks = await db.prepare('SELECT COUNT(*) as count FROM artworks').first()
  const mintedArtworks = await db.prepare('SELECT COUNT(*) as count FROM artworks WHERE is_minted = 1').first()
  const totalArtists = await db.prepare('SELECT COUNT(*) as count FROM artists').first()
  const pendingArtworks = await db.prepare("SELECT COUNT(*) as count FROM artworks WHERE status = 'pending_review'").first()
  
  return c.json({
    success: true,
    data: {
      totalArtworks: totalArtworks?.count || 0,
      mintedCount: mintedArtworks?.count || 0,
      totalArtists: totalArtists?.count || 0,
      pendingCount: pendingArtworks?.count || 0,
      totalVolume: '0'
    }
  })
})

// 작품 목록 조회 API (관리자용)
app.get('/api/admin/artworks', async (c) => {
  const db = c.env.DB
  
  const artworks = await db.prepare(`
    SELECT 
      a.*,
      ar.name as artist_name
    FROM artworks a
    LEFT JOIN artists ar ON a.artist_id = ar.id
    ORDER BY a.created_at DESC
    LIMIT 50
  `).all()
  
  return c.json({ success: true, data: artworks.results })
})

// 작가 목록 조회 API (관리자용)
app.get('/api/admin/artists', async (c) => {
  const db = c.env.DB
  
  const artists = await db.prepare(`
    SELECT 
      a.*,
      COUNT(aw.id) as artwork_count
    FROM artists a
    LEFT JOIN artworks aw ON a.id = aw.artist_id
    GROUP BY a.id
    ORDER BY a.created_at DESC
  `).all()
  
  return c.json({ success: true, data: artists.results })
})

// 단일 작품 조회 API
app.get('/api/admin/artworks/:id', async (c) => {
  const id = c.req.param('id')
  const db = c.env.DB
  
  const artwork = await db.prepare(`
    SELECT a.*, ar.name as artist_name
    FROM artworks a
    LEFT JOIN artists ar ON a.artist_id = ar.id
    WHERE a.id = ?
  `).bind(id).first()
  
  if (!artwork) {
    return c.json({ success: false, message: '작품을 찾을 수 없습니다.' })
  }
  
  return c.json({ success: true, data: artwork })
})

// 작품 추가 API
app.post('/api/admin/artworks', async (c) => {
  const data = await c.req.json()
  const db = c.env.DB
  
  try {
    const result = await db.prepare(`
      INSERT INTO artworks (
        artist_id, title, description, category, technique,
        size_width, size_height, creation_year, image_url,
        current_price, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      data.artist_id,
      data.title,
      data.description || '',
      data.category,
      data.technique || '',
      data.size_width || 0,
      data.size_height || 0,
      data.creation_year || new Date().getFullYear(),
      data.image_url,
      data.current_price || 0,
      data.status || 'draft'
    ).run()
    
    // 활동 로그 기록
    await db.prepare(`
      INSERT INTO admin_activity_logs (admin_user_id, action, entity_type, entity_id, details)
      VALUES (1, 'create_artwork', 'artwork', ?, ?)
    `).bind(result.meta.last_row_id, JSON.stringify({ title: data.title })).run()
    
    // 알림 생성
    await db.prepare(`
      INSERT INTO notifications (type, title, message, related_entity_type, related_entity_id)
      VALUES ('new_artwork', ?, ?, 'artwork', ?)
    `).bind(
      '새 작품 등록',
      `"${data.title}" 작품이 등록되었습니다.`,
      result.meta.last_row_id
    ).run()
    
    return c.json({ success: true, data: { id: result.meta.last_row_id } })
  } catch (error) {
    return c.json({ success: false, message: '작품 추가에 실패했습니다.' })
  }
})

// 작품 수정 API
app.put('/api/admin/artworks/:id', async (c) => {
  const id = c.req.param('id')
  const data = await c.req.json()
  const db = c.env.DB
  
  try {
    await db.prepare(`
      UPDATE artworks SET
        artist_id = ?,
        title = ?,
        description = ?,
        category = ?,
        technique = ?,
        size_width = ?,
        size_height = ?,
        creation_year = ?,
        image_url = ?,
        current_price = ?,
        status = ?,
        updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(
      data.artist_id,
      data.title,
      data.description || '',
      data.category,
      data.technique || '',
      data.size_width || 0,
      data.size_height || 0,
      data.creation_year,
      data.image_url,
      data.current_price || 0,
      data.status || 'draft',
      id
    ).run()
    
    return c.json({ success: true })
  } catch (error) {
    return c.json({ success: false, message: '작품 수정에 실패했습니다.' })
  }
})

// 작품 삭제 API
app.delete('/api/admin/artworks/:id', async (c) => {
  const id = c.req.param('id')
  const db = c.env.DB
  
  try {
    await db.prepare('DELETE FROM artworks WHERE id = ?').bind(id).run()
    return c.json({ success: true })
  } catch (error) {
    return c.json({ success: false, message: '작품 삭제에 실패했습니다.' })
  }
})

// 일괄 상태 변경 API
app.put('/api/admin/artworks/bulk/status', async (c) => {
  const { ids, status } = await c.req.json()
  const db = c.env.DB
  
  if (!ids || ids.length === 0) {
    return c.json({ success: false, message: '선택된 작품이 없습니다.' })
  }
  
  try {
    for (const id of ids) {
      await db.prepare(`
        UPDATE artworks SET status = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?
      `).bind(status, id).run()
    }
    
    return c.json({ success: true, updated: ids.length })
  } catch (error) {
    return c.json({ success: false, message: '일괄 상태 변경에 실패했습니다.' })
  }
})

// 일괄 삭제 API
app.delete('/api/admin/artworks/bulk/delete', async (c) => {
  const { ids } = await c.req.json()
  const db = c.env.DB
  
  if (!ids || ids.length === 0) {
    return c.json({ success: false, message: '선택된 작품이 없습니다.' })
  }
  
  try {
    for (const id of ids) {
      await db.prepare('DELETE FROM artworks WHERE id = ?').bind(id).run()
    }
    
    return c.json({ success: true, deleted: ids.length })
  } catch (error) {
    return c.json({ success: false, message: '일괄 삭제에 실패했습니다.' })
  }
})

// 단일 작가 조회 API
app.get('/api/admin/artists/:id', async (c) => {
  const id = c.req.param('id')
  const db = c.env.DB
  
  const artist = await db.prepare('SELECT * FROM artists WHERE id = ?').bind(id).first()
  
  if (!artist) {
    return c.json({ success: false, message: '작가를 찾을 수 없습니다.' })
  }
  
  return c.json({ success: true, data: artist })
})

// 작가 추가 API
app.post('/api/admin/artists', async (c) => {
  const data = await c.req.json()
  const db = c.env.DB
  
  try {
    const result = await db.prepare(`
      INSERT INTO artists (
        name, email, bio, career_years, education,
        solo_exhibitions_count, group_exhibitions_count,
        competition_awards_count, wallet_address
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      data.name,
      data.email,
      data.bio || '',
      data.career_years || 0,
      data.education || '',
      data.solo_exhibitions_count || 0,
      data.group_exhibitions_count || 0,
      data.competition_awards_count || 0,
      data.wallet_address || ''
    ).run()
    
    return c.json({ success: true, data: { id: result.meta.last_row_id } })
  } catch (error) {
    return c.json({ success: false, message: '작가 추가에 실패했습니다.' })
  }
})

// 작가 수정 API
app.put('/api/admin/artists/:id', async (c) => {
  const id = c.req.param('id')
  const data = await c.req.json()
  const db = c.env.DB
  
  try {
    await db.prepare(`
      UPDATE artists SET
        name = ?,
        email = ?,
        bio = ?,
        career_years = ?,
        education = ?,
        solo_exhibitions_count = ?,
        group_exhibitions_count = ?,
        competition_awards_count = ?,
        wallet_address = ?,
        updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(
      data.name,
      data.email,
      data.bio || '',
      data.career_years || 0,
      data.education || '',
      data.solo_exhibitions_count || 0,
      data.group_exhibitions_count || 0,
      data.competition_awards_count || 0,
      data.wallet_address || '',
      id
    ).run()
    
    return c.json({ success: true })
  } catch (error) {
    return c.json({ success: false, message: '작가 수정에 실패했습니다.' })
  }
})

// 작가 삭제 API
app.delete('/api/admin/artists/:id', async (c) => {
  const id = c.req.param('id')
  const db = c.env.DB
  
  try {
    // 관련 작품도 함께 삭제
    await db.prepare('DELETE FROM artworks WHERE artist_id = ?').bind(id).run()
    await db.prepare('DELETE FROM artists WHERE id = ?').bind(id).run()
    return c.json({ success: true })
  } catch (error) {
    return c.json({ success: false, message: '작가 삭제에 실패했습니다.' })
  }
})

// 평가 대기 목록 조회 API
app.get('/api/admin/valuations/pending', async (c) => {
  const db = c.env.DB
  
  const artworks = await db.prepare(`
    SELECT 
      a.*,
      ar.name as artist_name
    FROM artworks a
    LEFT JOIN artists ar ON a.artist_id = ar.id
    WHERE a.status = 'pending_review'
    ORDER BY a.created_at DESC
  `).all()
  
  return c.json({ success: true, data: artworks.results })
})

// 평가 승인 API
app.post('/api/admin/artworks/:id/approve', async (c) => {
  const id = c.req.param('id')
  const db = c.env.DB
  
  try {
    // 작품 정보 조회
    const artwork = await db.prepare('SELECT title FROM artworks WHERE id = ?').bind(id).first()
    
    await db.prepare(`
      UPDATE artworks SET status = 'approved', updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(id).run()
    
    // 알림 생성
    await db.prepare(`
      INSERT INTO notifications (type, title, message, related_entity_type, related_entity_id)
      VALUES ('approved', ?, ?, 'artwork', ?)
    `).bind(
      '작품 평가 승인',
      `"${artwork?.title || '작품'}" 평가가 승인되었습니다.`,
      id
    ).run()
    
    return c.json({ success: true })
  } catch (error) {
    return c.json({ success: false, message: '평가 승인에 실패했습니다.' })
  }
})

// 평가 반려 API
app.post('/api/admin/artworks/:id/reject', async (c) => {
  const id = c.req.param('id')
  const { reason } = await c.req.json()
  const db = c.env.DB
  
  try {
    await db.prepare(`
      UPDATE artworks SET status = 'draft', updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(id).run()
    
    // 반려 사유를 평가 이력에 기록
    await db.prepare(`
      INSERT INTO valuation_history (artwork_id, evaluator_name, evaluator_role, evaluation_notes)
      VALUES (?, 'Admin', 'system', ?)
    `).bind(id, `반려: ${reason}`).run()
    
    return c.json({ success: true })
  } catch (error) {
    return c.json({ success: false, message: '평가 반려에 실패했습니다.' })
  }
})

// 차트 데이터 API
app.get('/api/admin/charts', async (c) => {
  const db = c.env.DB
  
  try {
    // 월별 작품 등록 추이 (최근 6개월)
    const monthlyData = await db.prepare(`
      SELECT strftime('%Y-%m', created_at) as month, COUNT(*) as count
      FROM artworks
      WHERE created_at >= date('now', '-6 months')
      GROUP BY month
      ORDER BY month
    `).all()
    
    // 카테고리별 분포
    const categoryData = await db.prepare(`
      SELECT category, COUNT(*) as count
      FROM artworks
      GROUP BY category
    `).all()
    
    // 가격대별 분포
    const priceData = await db.prepare(`
      SELECT 
        CASE
          WHEN current_price < 1000000 THEN '~100만원'
          WHEN current_price < 5000000 THEN '100~500만원'
          WHEN current_price < 10000000 THEN '500~1000만원'
          WHEN current_price < 50000000 THEN '1000~5000만원'
          ELSE '5000만원~'
        END as price_range,
        COUNT(*) as count
      FROM artworks
      WHERE current_price > 0
      GROUP BY price_range
    `).all()
    
    // 상태별 현황
    const statusData = await db.prepare(`
      SELECT status, COUNT(*) as count
      FROM artworks
      GROUP BY status
    `).all()
    
    // 한국어 상태명 매핑
    const statusMap = {
      'draft': '초안',
      'pending_review': '검토 중',
      'approved': '승인됨',
      'minted': '민팅됨',
      'sold': '판매됨'
    }
    
    return c.json({
      success: true,
      data: {
        monthly: {
          labels: monthlyData.results.map(r => r.month),
          values: monthlyData.results.map(r => r.count)
        },
        category: {
          labels: categoryData.results.map(r => r.category),
          values: categoryData.results.map(r => r.count)
        },
        price: {
          labels: priceData.results.map(r => r.price_range),
          values: priceData.results.map(r => r.count)
        },
        status: {
          labels: statusData.results.map(r => statusMap[r.status] || r.status),
          values: statusData.results.map(r => r.count)
        }
      }
    })
  } catch (error) {
    return c.json({
      success: true,
      data: {
        monthly: { labels: [], values: [] },
        category: { labels: [], values: [] },
        price: { labels: [], values: [] },
        status: { labels: [], values: [] }
      }
    })
  }
})

// 이미지 업로드 API (R2)
app.post('/api/admin/upload/image', async (c) => {
  try {
    const formData = await c.req.formData()
    const file = formData.get('file') as File
    
    if (!file) {
      return c.json({ success: false, message: '파일이 없습니다.' })
    }
    
    // 파일 확장자 추출
    const fileName = file.name
    const fileExt = fileName.split('.').pop()
    const uniqueName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`
    
    // R2에 업로드 (로컬 개발 환경에서는 시뮬레이션)
    // 실제 배포 시에는 c.env.R2를 사용
    const imageUrl = `https://gallerypia-images.r2.cloudflarestorage.com/${uniqueName}`
    
    // 로컬 개발 환경에서는 base64로 변환하여 반환
    const arrayBuffer = await file.arrayBuffer()
    const base64 = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)))
    const dataUrl = `data:${file.type};base64,${base64}`
    
    return c.json({ 
      success: true, 
      url: dataUrl, // 로컬에서는 data URL 사용
      filename: uniqueName
    })
  } catch (error) {
    console.error('Upload error:', error)
    return c.json({ success: false, message: '업로드 중 오류가 발생했습니다.' })
  }
})

// 알림 조회 API
app.get('/api/admin/notifications', async (c) => {
  const db = c.env.DB
  
  const notifications = await db.prepare(`
    SELECT * FROM notifications
    ORDER BY created_at DESC
    LIMIT 50
  `).all()
  
  return c.json({ success: true, data: notifications.results || [] })
})

// 알림 읽음 표시 API
app.put('/api/admin/notifications/:id/read', async (c) => {
  const id = c.req.param('id')
  const db = c.env.DB
  
  await db.prepare(`
    UPDATE notifications SET is_read = 1 WHERE id = ?
  `).bind(id).run()
  
  return c.json({ success: true })
})

// 모든 알림 읽음 표시 API
app.put('/api/admin/notifications/read-all', async (c) => {
  const db = c.env.DB
  
  await db.prepare(`
    UPDATE notifications SET is_read = 1
  `).run()
  
  return c.json({ success: true })
})

// 활동 로그 조회 API
app.get('/api/admin/logs', async (c) => {
  const db = c.env.DB
  const action = c.req.query('action')
  
  let query = `
    SELECT 
      l.*,
      u.username as admin_username
    FROM admin_activity_logs l
    LEFT JOIN admin_users u ON l.admin_user_id = u.id
  `
  
  if (action) {
    query += ` WHERE l.action = '${action}'`
  }
  
  query += ` ORDER BY l.created_at DESC LIMIT 100`
  
  const logs = await db.prepare(query).all()
  
  return c.json({ success: true, data: logs.results })
})

// OpenSea 작품 조회 API (선택용) - 실제 OpenSea API v2 호출
app.post('/api/admin/opensea/fetch', async (c) => {
  const { slug, limit = 100, apiKey } = await c.req.json()
  
  if (!slug) {
    return c.json({ 
      success: false, 
      message: 'OpenSea 컬렉션 슬러그가 필요합니다.' 
    })
  }
  
  try {
    // API 키가 없으면 데모 데이터 생성
    if (!apiKey || !apiKey.trim()) {
      console.log('API 키 없음 - 데모 데이터 생성:', slug)
      
      const requestLimit = Math.min(limit, 100)
      const artworks = []
      
      for (let i = 0; i < requestLimit; i++) {
        artworks.push({
          name: `${slug} #${i + 1}`,
          description: `NFT artwork from ${slug} collection (Demo Data)`,
          collection: slug,
          image_url: `https://picsum.photos/seed/${slug}${i}/400/400`,
          token_id: `${i + 1}`,
          contract_address: '0x' + Math.random().toString(16).substring(2, 42),
          metadata: {
            opensea_url: `https://opensea.io/collection/${slug}`,
            attributes: []
          }
        })
      }
      
      return c.json({ 
        success: true, 
        artworks,
        total: artworks.length,
        message: `${artworks.length}개의 데모 작품을 생성했습니다. (실제 OpenSea 데이터를 가져오려면 API 키를 입력하세요)`,
        isDemo: true
      })
    }
    
    // OpenSea API v2 헤더 설정
    const headers: any = {
      'Accept': 'application/json',
      'Content-Type': 'application/json',
      'X-API-KEY': apiKey.trim()
    }
    
    // OpenSea API v2 호출 (최대 200개까지 조회 가능)
    const requestLimit = Math.min(limit, 200)
    const apiUrl = `https://api.opensea.io/api/v2/collection/${slug}/nfts?limit=${requestLimit}`
    
    console.log('OpenSea API 호출:', apiUrl)
    
    const response = await fetch(apiUrl, {
      method: 'GET',
      headers: headers
    })
    
    if (!response.ok) {
      const errorText = await response.text()
      console.error('OpenSea API 에러:', response.status, errorText)
      
      // API 키가 잘못된 경우 - 데모 데이터로 fallback
      if (response.status === 401 || response.status === 403) {
        console.log('API 인증 실패 - 데모 데이터로 fallback')
        
        const requestLimit = Math.min(limit, 100)
        const artworks = []
        
        for (let i = 0; i < requestLimit; i++) {
          artworks.push({
            name: `${slug} #${i + 1}`,
            description: `NFT artwork from ${slug} collection (Demo Data - Invalid API Key)`,
            collection: slug,
            image_url: `https://picsum.photos/seed/${slug}${i}/400/400`,
            token_id: `${i + 1}`,
            contract_address: '0x' + Math.random().toString(16).substring(2, 42),
            metadata: {
              opensea_url: `https://opensea.io/collection/${slug}`,
              attributes: []
            }
          })
        }
        
        return c.json({ 
          success: true, 
          artworks,
          total: artworks.length,
          message: `OpenSea API 인증 실패 - ${artworks.length}개의 데모 작품을 생성했습니다. 유효한 API 키를 입력하면 실제 데이터를 가져올 수 있습니다.`,
          isDemo: true,
          authError: true
        })
      }
      
      return c.json({ 
        success: false, 
        message: `OpenSea API 오류 (${response.status}): ${errorText}` 
      })
    }
    
    const data = await response.json()
    
    // OpenSea API 응답 파싱
    if (!data.nfts || !Array.isArray(data.nfts)) {
      return c.json({ 
        success: false, 
        message: 'OpenSea API 응답 형식이 올바르지 않습니다.' 
      })
    }
    
    // 우리 시스템 형식으로 변환
    const artworks = data.nfts.map((nft: any) => ({
      name: nft.name || `${slug} #${nft.identifier}`,
      description: nft.description || `NFT from ${slug} collection`,
      collection: slug,
      image_url: nft.image_url || nft.display_image_url || 'https://via.placeholder.com/400?text=No+Image',
      token_id: nft.identifier,
      contract_address: nft.contract || null,
      metadata: {
        opensea_url: `https://opensea.io/assets/ethereum/${nft.contract}/${nft.identifier}`,
        attributes: nft.traits || []
      }
    }))
    
    return c.json({ 
      success: true, 
      artworks,
      total: artworks.length,
      message: `${artworks.length}개의 실제 OpenSea 작품을 불러왔습니다.`,
      isDemo: false
    })
    
  } catch (error: any) {
    console.error('OpenSea fetch error:', error)
    return c.json({ 
      success: false, 
      message: 'OpenSea 작품 조회에 실패했습니다: ' + error.message 
    })
  }
})

// OpenSea 선택한 작품 import API
app.post('/api/admin/import/opensea', async (c) => {
  const { artworks } = await c.req.json()
  const db = c.env.DB
  
  if (!artworks || !Array.isArray(artworks) || artworks.length === 0) {
    return c.json({ success: false, message: '가져올 작품이 없습니다.' })
  }
  
  try {
    // 기본 작가 찾기 또는 생성
    const collectionName = artworks[0]?.collection || 'OpenSea Collection'
    let artist = await db.prepare(`
      SELECT id FROM artists WHERE name = ?
    `).bind(collectionName).first()
    
    if (!artist) {
      const result = await db.prepare(`
        INSERT INTO artists (name, email, bio, profile_image)
        VALUES (?, ?, ?, ?)
      `).bind(
        collectionName,
        `${collectionName.toLowerCase().replace(/\s+/g, '')}@opensea.io`,
        `Imported from OpenSea collection: ${collectionName}`,
        artworks[0]?.image_url || null
      ).run()
      artist = { id: result.meta.last_row_id }
    }
    
    // 선택한 작품들 import
    let imported = 0
    for (const artwork of artworks) {
      try {
        // 중복 체크 (token_id 기준)
        const existing = await db.prepare(`
          SELECT id FROM artworks WHERE nft_token_id = ?
        `).bind(artwork.token_id).first()
        
        if (existing) {
          continue // 이미 존재하면 스킵
        }
        
        await db.prepare(`
          INSERT INTO artworks (
            artist_id, title, description, category, image_url,
            current_price, status, is_minted, 
            nft_token_id, nft_contract_address, blockchain_network
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(
          artist.id,
          artwork.name,
          artwork.description || `NFT from ${collectionName}`,
          '디지털아트',
          artwork.image_url,
          Math.floor(Math.random() * 5000000) + 500000, // 50만원 ~ 500만원
          'approved',
          1, // is_minted
          artwork.token_id,
          artwork.contract_address || null,
          'Ethereum'
        ).run()
        
        imported++
      } catch (itemError) {
        console.error('Failed to import artwork:', artwork.name, itemError)
        // 개별 작품 실패는 무시하고 계속 진행
      }
    }
    
    return c.json({ 
      success: true, 
      imported,
      total: artworks.length,
      message: `${imported}개 작품을 성공적으로 가져왔습니다.`
    })
  } catch (error: any) {
    console.error('OpenSea import error:', error)
    return c.json({ 
      success: false, 
      message: 'OpenSea 가져오기에 실패했습니다: ' + error.message 
    })
  }
})

// ============================================
// 가치산정 알고리즘 API (논문 기반)
// ============================================

// 모듈1: 작가 업적 평가 점수 계산
app.post('/api/valuation/calculate-artist-achievement/:artistId', async (c) => {
  const artistId = c.req.param('artistId')
  const db = c.env.DB
  
  try {
    // 전시 이력 점수 계산: ∑(전시점수 × 권위도가중치 × 최신성계수)
    const exhibitions = await db.prepare(`
      SELECT 
        exhibition_type,
        authority_level,
        recency_coefficient,
        exhibition_score
      FROM artist_exhibitions
      WHERE artist_id = ?
    `).bind(artistId).all()
    
    let exhibitionScore = 0
    exhibitions.results.forEach((ex: any) => {
      const baseScore = ex.exhibition_type === 'solo' ? 20 : 10 // 개인전 20점, 단체전 10점
      const authorityWeight = ex.authority_level / 5 // 권위도 정규화 (0.2 ~ 1.0)
      const recencyCoeff = ex.recency_coefficient || 1.0
      exhibitionScore += baseScore * authorityWeight * recencyCoeff
    })
    
    // 수상 이력 점수 계산
    const awards = await db.prepare(`
      SELECT 
        award_rank,
        authority_level,
        recency_coefficient
      FROM artist_awards
      WHERE artist_id = ?
    `).bind(artistId).all()
    
    let awardScore = 0
    awards.results.forEach((award: any) => {
      let baseScore = 10
      if (award.award_rank === '대상') baseScore = 30
      else if (award.award_rank === '금상') baseScore = 25
      else if (award.award_rank === '은상') baseScore = 20
      else if (award.award_rank === '동상') baseScore = 15
      
      const authorityWeight = award.authority_level / 5
      const recencyCoeff = award.recency_coefficient || 1.0
      awardScore += baseScore * authorityWeight * recencyCoeff
    })
    
    // 최종 점수 정규화 (0~100)
    const totalScore = Math.min(100, (exhibitionScore + awardScore) / 2)
    
    // 작가 업적 점수 업데이트
    await db.prepare(`
      UPDATE artists 
      SET artist_achievement_score = ?,
          total_exhibitions = ?,
          solo_exhibitions = ?,
          group_exhibitions = ?,
          total_awards = ?
      WHERE id = ?
    `).bind(
      totalScore,
      exhibitions.results.length,
      exhibitions.results.filter((ex: any) => ex.exhibition_type === 'solo').length,
      exhibitions.results.filter((ex: any) => ex.exhibition_type === 'group').length,
      awards.results.length,
      artistId
    ).run()
    
    return c.json({ 
      success: true, 
      score: totalScore,
      details: {
        exhibitionScore,
        awardScore,
        totalExhibitions: exhibitions.results.length,
        totalAwards: awards.results.length
      }
    })
  } catch (error) {
    return c.json({ success: false, message: '작가 업적 점수 계산 실패' })
  }
})

// 모듈2: 작품 내용 평가 점수 계산
app.post('/api/valuation/calculate-artwork-content/:artworkId', async (c) => {
  const artworkId = c.req.param('artworkId')
  const body = await c.req.json()
  const db = c.env.DB
  
  try {
    const {
      content_depth_score = 0,
      content_comment = '',
      expression_score = 0,
      expression_comment = '',
      originality_score = 0,
      originality_comment = '',
      collection_value_score = 0,
      collection_value_comment = ''
    } = body
    
    // 4가지 항목 합산 (각 0~25점)
    const finalScore = content_depth_score + expression_score + originality_score + collection_value_score
    
    // 작품 내용 평가 저장/업데이트
    await db.prepare(`
      INSERT INTO artwork_content_evaluation (
        artwork_id,
        content_depth_score, content_comment,
        expression_score, expression_comment,
        originality_score, originality_comment,
        collection_value_score, collection_value_comment,
        artwork_content_final_score,
        evaluated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
      ON CONFLICT(artwork_id) DO UPDATE SET
        content_depth_score = excluded.content_depth_score,
        content_comment = excluded.content_comment,
        expression_score = excluded.expression_score,
        expression_comment = excluded.expression_comment,
        originality_score = excluded.originality_score,
        originality_comment = excluded.originality_comment,
        collection_value_score = excluded.collection_value_score,
        collection_value_comment = excluded.collection_value_comment,
        artwork_content_final_score = excluded.artwork_content_final_score,
        updated_at = CURRENT_TIMESTAMP
    `).bind(
      artworkId,
      content_depth_score, content_comment,
      expression_score, expression_comment,
      originality_score, originality_comment,
      collection_value_score, collection_value_comment,
      finalScore
    ).run()
    
    return c.json({ success: true, score: finalScore })
  } catch (error) {
    return c.json({ success: false, message: '작품 내용 평가 저장 실패' })
  }
})

// 모듈3: 저작권 인증 점수 계산
app.post('/api/valuation/calculate-certification/:artworkId', async (c) => {
  const artworkId = c.req.param('artworkId')
  const body = await c.req.json()
  const db = c.env.DB
  
  try {
    const {
      blockchain_hash = '',
      blockchain_network = '',
      copyright_registered = false,
      copyright_registration_number = '',
      license_type = 'exclusive'
    } = body
    
    // 인증 점수 계산
    let certScore = 0
    if (blockchain_hash) certScore += 40 // 블록체인 해시 존재
    if (copyright_registered && copyright_registration_number) certScore += 40 // 저작권 등록
    if (license_type) certScore += 20 // 라이선스 명시
    
    // 저작권 인증 정보 저장/업데이트
    await db.prepare(`
      INSERT INTO artwork_certification (
        artwork_id,
        blockchain_hash, blockchain_network,
        copyright_registered, copyright_registration_number,
        license_type,
        certification_score,
        created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
      ON CONFLICT(artwork_id) DO UPDATE SET
        blockchain_hash = excluded.blockchain_hash,
        blockchain_network = excluded.blockchain_network,
        copyright_registered = excluded.copyright_registered,
        copyright_registration_number = excluded.copyright_registration_number,
        license_type = excluded.license_type,
        certification_score = excluded.certification_score,
        updated_at = CURRENT_TIMESTAMP
    `).bind(
      artworkId,
      blockchain_hash, blockchain_network,
      copyright_registered, copyright_registration_number,
      license_type,
      certScore
    ).run()
    
    return c.json({ success: true, score: certScore })
  } catch (error) {
    return c.json({ success: false, message: '저작권 인증 정보 저장 실패' })
  }
})

// 모듈4: 전문가 평가 추가
app.post('/api/valuation/add-expert-evaluation/:artworkId', async (c) => {
  const artworkId = c.req.param('artworkId')
  const body = await c.req.json()
  const db = c.env.DB
  
  try {
    const {
      expert_name,
      expert_level, // 'curator', 'director', 'critic', 'graduate'
      expert_institution = '',
      technique_mastery_score = 0,
      art_historical_significance_score = 0,
      marketability_score = 0,
      development_potential_score = 0,
      evaluation_comment = ''
    } = body
    
    // 전문가 등급별 가중치
    const expertWeights: { [key: string]: number } = {
      'curator': 1.5,
      'director': 1.3,
      'critic': 1.2,
      'graduate': 1.0
    }
    const expertWeight = expertWeights[expert_level] || 1.0
    
    // 종합 점수 계산
    const overallScore = technique_mastery_score + art_historical_significance_score + 
                         marketability_score + development_potential_score
    
    // 전문가 평가 추가
    await db.prepare(`
      INSERT INTO expert_evaluations (
        artwork_id, expert_name, expert_level, expert_institution, expert_weight,
        technique_mastery_score, art_historical_significance_score,
        marketability_score, development_potential_score,
        overall_score, evaluation_comment, evaluated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
    `).bind(
      artworkId, expert_name, expert_level, expert_institution, expertWeight,
      technique_mastery_score, art_historical_significance_score,
      marketability_score, development_potential_score,
      overallScore, evaluation_comment
    ).run()
    
    return c.json({ success: true, score: overallScore })
  } catch (error) {
    return c.json({ success: false, message: '전문가 평가 추가 실패' })
  }
})

// 모듈4: 전문가 평가 가중 평균 계산
app.get('/api/valuation/calculate-expert-average/:artworkId', async (c) => {
  const artworkId = c.req.param('artworkId')
  const db = c.env.DB
  
  try {
    const evaluations = await db.prepare(`
      SELECT overall_score, expert_weight
      FROM expert_evaluations
      WHERE artwork_id = ?
    `).bind(artworkId).all()
    
    if (evaluations.results.length === 0) {
      return c.json({ success: true, score: 0, count: 0 })
    }
    
    // 가중 평균 계산
    let weightedSum = 0
    let totalWeight = 0
    
    evaluations.results.forEach((ev: any) => {
      weightedSum += ev.overall_score * ev.expert_weight
      totalWeight += ev.expert_weight
    })
    
    const averageScore = totalWeight > 0 ? weightedSum / totalWeight : 0
    
    return c.json({ 
      success: true, 
      score: averageScore,
      count: evaluations.results.length 
    })
  } catch (error) {
    return c.json({ success: false, message: '전문가 평가 평균 계산 실패' })
  }
})

// 전문가 평가 보상금 지급 API
app.post('/api/expert/pay-reward/:evaluationId', async (c) => {
  const evaluationId = c.req.param('evaluationId')
  const { reward_eth, tx_hash, expert_id } = await c.req.json()
  const db = c.env.DB
  
  try {
    // 평가 정보 업데이트
    await db.prepare(`
      UPDATE expert_evaluations 
      SET reward_eth = ?,
          reward_status = 'paid',
          reward_tx_hash = ?,
          reward_paid_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(reward_eth, tx_hash, evaluationId).run()
    
    // 보상 이력 기록
    const evaluation = await db.prepare(`
      SELECT artwork_id FROM expert_evaluations WHERE id = ?
    `).bind(evaluationId).first()
    
    await db.prepare(`
      INSERT INTO expert_rewards_history (
        expert_id, evaluation_id, artwork_id, reward_eth, tx_hash, status
      ) VALUES (?, ?, ?, ?, ?, 'completed')
    `).bind(expert_id, evaluationId, evaluation?.artwork_id, reward_eth, tx_hash).run()
    
    return c.json({ 
      success: true, 
      message: `${reward_eth} ETH 보상이 지급되었습니다.`,
      tx_hash 
    })
  } catch (error: any) {
    return c.json({ success: false, message: '보상금 지급 실패: ' + error.message })
  }
})

// 전문가 보상금 내역 조회 API
app.get('/api/expert/rewards/:expertId', async (c) => {
  const expertId = c.req.param('expertId')
  const db = c.env.DB
  
  try {
    const rewards = await db.prepare(`
      SELECT 
        rh.*,
        a.title as artwork_title,
        a.image_url as artwork_image
      FROM expert_rewards_history rh
      LEFT JOIN artworks a ON rh.artwork_id = a.id
      WHERE rh.expert_id = ?
      ORDER BY rh.paid_at DESC
    `).bind(expertId).all()
    
    // 총 보상금 계산
    const totalRewards = await db.prepare(`
      SELECT SUM(reward_eth) as total FROM expert_rewards_history WHERE expert_id = ?
    `).bind(expertId).first()
    
    return c.json({ 
      success: true, 
      rewards: rewards.results,
      total_eth: totalRewards?.total || 0
    })
  } catch (error: any) {
    return c.json({ success: false, message: '보상 내역 조회 실패: ' + error.message })
  }
})

// ========== Museum/Gallery APIs ==========

// 전시 목록 조회 (뮤지엄/갤러리)
app.get('/api/exhibitions', async (c) => {
  const db = c.env.DB
  const organizerId = c.req.query('organizer_id')
  const status = c.req.query('status')
  
  try {
    let query = `
      SELECT e.*, u.organization_name, u.username,
             (SELECT COUNT(*) FROM exhibition_artworks WHERE exhibition_id = e.id) as artwork_count
      FROM exhibitions e
      LEFT JOIN users u ON e.organizer_id = u.id
      WHERE 1=1
    `
    const params: any[] = []
    
    if (organizerId) {
      query += ` AND e.organizer_id = ?`
      params.push(organizerId)
    }
    
    if (status) {
      query += ` AND e.status = ?`
      params.push(status)
    }
    
    query += ` ORDER BY e.created_at DESC`
    
    const exhibitions = await db.prepare(query).bind(...params).all()
    
    return c.json({ success: true, exhibitions: exhibitions.results })
  } catch (error: any) {
    return c.json({ success: false, message: '전시 목록 조회 실패: ' + error.message })
  }
})

// 전시 상세 조회
app.get('/api/exhibitions/:id', async (c) => {
  const db = c.env.DB
  const exhibitionId = c.req.param('id')
  
  try {
    const exhibition = await db.prepare(`
      SELECT e.*, u.organization_name, u.username, u.organization_description
      FROM exhibitions e
      LEFT JOIN users u ON e.organizer_id = u.id
      WHERE e.id = ?
    `).bind(exhibitionId).first()
    
    if (!exhibition) {
      return c.json({ success: false, message: '전시를 찾을 수 없습니다.' })
    }
    
    // 전시 작품 목록
    const artworks = await db.prepare(`
      SELECT ea.*, a.title, a.image_url, a.artist_id, ar.name as artist_name
      FROM exhibition_artworks ea
      LEFT JOIN artworks a ON ea.artwork_id = a.id
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE ea.exhibition_id = ?
      ORDER BY ea.display_order, ea.added_at
    `).bind(exhibitionId).all()
    
    return c.json({ 
      success: true, 
      exhibition,
      artworks: artworks.results
    })
  } catch (error: any) {
    return c.json({ success: false, message: '전시 조회 실패: ' + error.message })
  }
})

// 전시 생성
app.post('/api/exhibitions', async (c) => {
  const db = c.env.DB
  const { organizer_id, title, description, theme, start_date, end_date, location, venue_type, max_artworks } = await c.req.json()
  
  try {
    const result = await db.prepare(`
      INSERT INTO exhibitions (
        organizer_id, title, description, theme, start_date, end_date, 
        location, venue_type, max_artworks, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'planning')
    `).bind(organizer_id, title, description, theme, start_date, end_date, location, venue_type || 'physical', max_artworks || 50).run()
    
    return c.json({ success: true, exhibition_id: result.meta.last_row_id })
  } catch (error: any) {
    return c.json({ success: false, message: '전시 생성 실패: ' + error.message })
  }
})

// 전시 수정
app.put('/api/exhibitions/:id', async (c) => {
  const db = c.env.DB
  const exhibitionId = c.req.param('id')
  const { title, description, theme, start_date, end_date, location, venue_type, max_artworks, status } = await c.req.json()
  
  try {
    await db.prepare(`
      UPDATE exhibitions 
      SET title = ?, description = ?, theme = ?, start_date = ?, end_date = ?,
          location = ?, venue_type = ?, max_artworks = ?, status = ?,
          updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(title, description, theme, start_date, end_date, location, venue_type, max_artworks, status, exhibitionId).run()
    
    return c.json({ success: true, message: '전시가 수정되었습니다.' })
  } catch (error: any) {
    return c.json({ success: false, message: '전시 수정 실패: ' + error.message })
  }
})

// 전시 삭제
app.delete('/api/exhibitions/:id', async (c) => {
  const db = c.env.DB
  const exhibitionId = c.req.param('id')
  
  try {
    // 전시 작품 먼저 삭제
    await db.prepare(`DELETE FROM exhibition_artworks WHERE exhibition_id = ?`).bind(exhibitionId).run()
    
    // 전시 삭제
    await db.prepare(`DELETE FROM exhibitions WHERE id = ?`).bind(exhibitionId).run()
    
    return c.json({ success: true, message: '전시가 삭제되었습니다.' })
  } catch (error: any) {
    return c.json({ success: false, message: '전시 삭제 실패: ' + error.message })
  }
})

// 전시에 작품 추가
app.post('/api/exhibitions/:id/artworks', async (c) => {
  const db = c.env.DB
  const exhibitionId = c.req.param('id')
  const { artwork_id, display_order, is_featured, curator_notes } = await c.req.json()
  
  try {
    await db.prepare(`
      INSERT INTO exhibition_artworks (exhibition_id, artwork_id, display_order, is_featured, curator_notes)
      VALUES (?, ?, ?, ?, ?)
    `).bind(exhibitionId, artwork_id, display_order || 0, is_featured || 0, curator_notes || null).run()
    
    return c.json({ success: true, message: '작품이 전시에 추가되었습니다.' })
  } catch (error: any) {
    return c.json({ success: false, message: '작품 추가 실패: ' + error.message })
  }
})

// 전시에서 작품 제거
app.delete('/api/exhibitions/:exhibitionId/artworks/:artworkId', async (c) => {
  const db = c.env.DB
  const exhibitionId = c.req.param('exhibitionId')
  const artworkId = c.req.param('artworkId')
  
  try {
    await db.prepare(`
      DELETE FROM exhibition_artworks 
      WHERE exhibition_id = ? AND artwork_id = ?
    `).bind(exhibitionId, artworkId).run()
    
    return c.json({ success: true, message: '작품이 전시에서 제거되었습니다.' })
  } catch (error: any) {
    return c.json({ success: false, message: '작품 제거 실패: ' + error.message })
  }
})

// 큐레이션 요청 목록 조회
app.get('/api/curation-requests', async (c) => {
  const db = c.env.DB
  const galleryId = c.req.query('gallery_id')
  const artistId = c.req.query('artist_id')
  const status = c.req.query('status')
  
  try {
    let query = `
      SELECT cr.*, 
             a.title as artwork_title, a.image_url as artwork_image,
             ar.name as artist_name,
             u.organization_name as gallery_name
      FROM curation_requests cr
      LEFT JOIN artworks a ON cr.artwork_id = a.id
      LEFT JOIN artists ar ON cr.artist_id = ar.id
      LEFT JOIN users u ON cr.gallery_id = u.id
      WHERE 1=1
    `
    const params: any[] = []
    
    if (galleryId) {
      query += ` AND cr.gallery_id = ?`
      params.push(galleryId)
    }
    
    if (artistId) {
      query += ` AND cr.artist_id = ?`
      params.push(artistId)
    }
    
    if (status) {
      query += ` AND cr.status = ?`
      params.push(status)
    }
    
    query += ` ORDER BY cr.requested_at DESC`
    
    const requests = await db.prepare(query).bind(...params).all()
    
    return c.json({ success: true, requests: requests.results })
  } catch (error: any) {
    return c.json({ success: false, message: '요청 목록 조회 실패: ' + error.message })
  }
})

// 큐레이션 요청 생성
app.post('/api/curation-requests', async (c) => {
  const db = c.env.DB
  const { gallery_id, artwork_id, artist_id, request_message, offer_percentage, duration_months } = await c.req.json()
  
  try {
    const result = await db.prepare(`
      INSERT INTO curation_requests (
        gallery_id, artwork_id, artist_id, request_message, 
        offer_percentage, duration_months, status
      ) VALUES (?, ?, ?, ?, ?, ?, 'pending')
    `).bind(gallery_id, artwork_id, artist_id, request_message, offer_percentage, duration_months).run()
    
    return c.json({ success: true, request_id: result.meta.last_row_id })
  } catch (error: any) {
    return c.json({ success: false, message: '요청 생성 실패: ' + error.message })
  }
})

// 큐레이션 요청 응답
app.put('/api/curation-requests/:id/respond', async (c) => {
  const db = c.env.DB
  const requestId = c.req.param('id')
  const { status, response_message } = await c.req.json()
  
  try {
    await db.prepare(`
      UPDATE curation_requests 
      SET status = ?, response_message = ?, responded_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(status, response_message, requestId).run()
    
    return c.json({ success: true, message: '요청에 응답했습니다.' })
  } catch (error: any) {
    return c.json({ success: false, message: '응답 실패: ' + error.message })
  }
})

// 모듈5: 대중 인기도 점수 업데이트
app.post('/api/valuation/update-popularity/:artworkId', async (c) => {
  const artworkId = c.req.param('artworkId')
  const body = await c.req.json()
  const db = c.env.DB
  
  try {
    const {
      youtube_views = 0,
      instagram_likes = 0,
      instagram_comments = 0,
      instagram_shares = 0,
      platform_likes = 0,
      platform_comments = 0,
      platform_shares = 0,
      google_trends_score = 0,
      media_coverage_count = 0
    } = body
    
    // Instagram 인게이지먼트 계산
    const instagram_engagement = instagram_likes + instagram_comments + instagram_shares
    
    // 인기도 점수 계산 (0~100)
    const popularityScore = Math.min(100, 
      (youtube_views / 10000) * 20 + // YouTube 조회수 (최대 20점)
      (instagram_engagement / 1000) * 20 + // Instagram 인게이지먼트 (최대 20점)
      (platform_likes / 100) * 15 + // 플랫폼 좋아요 (최대 15점)
      google_trends_score * 0.25 + // Google Trends (최대 25점)
      (media_coverage_count * 4) // 언론 보도 (최대 20점)
    )
    
    // 인기도 정보 저장/업데이트
    await db.prepare(`
      INSERT INTO artwork_popularity (
        artwork_id,
        youtube_views, instagram_likes, instagram_comments, instagram_shares,
        instagram_engagement, platform_likes, platform_comments, platform_shares,
        google_trends_score, media_coverage_count,
        popularity_final_score, last_updated
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
      ON CONFLICT(artwork_id) DO UPDATE SET
        youtube_views = excluded.youtube_views,
        instagram_likes = excluded.instagram_likes,
        instagram_comments = excluded.instagram_comments,
        instagram_shares = excluded.instagram_shares,
        instagram_engagement = excluded.instagram_engagement,
        platform_likes = excluded.platform_likes,
        platform_comments = excluded.platform_comments,
        platform_shares = excluded.platform_shares,
        google_trends_score = excluded.google_trends_score,
        media_coverage_count = excluded.media_coverage_count,
        popularity_final_score = excluded.popularity_final_score,
        last_updated = CURRENT_TIMESTAMP
    `).bind(
      artworkId,
      youtube_views, instagram_likes, instagram_comments, instagram_shares,
      instagram_engagement, platform_likes, platform_comments, platform_shares,
      google_trends_score, media_coverage_count,
      popularityScore
    ).run()
    
    return c.json({ success: true, score: popularityScore })
  } catch (error) {
    return c.json({ success: false, message: '인기도 정보 저장 실패' })
  }
})

// 최종 가치 점수 계산 (5개 모듈 통합)
app.post('/api/valuation/calculate-final/:artworkId', async (c) => {
  const artworkId = c.req.param('artworkId')
  const db = c.env.DB
  
  try {
    // 1. 작가 업적 점수 (모듈1)
    const artwork = await db.prepare(`
      SELECT ar.artist_achievement_score
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.id = ?
    `).bind(artworkId).first() as any
    
    const module1Score = artwork?.artist_achievement_score || 0
    
    // 2. 작품 내용 평가 (모듈2)
    const module2 = await db.prepare(`
      SELECT artwork_content_final_score
      FROM artwork_content_evaluation
      WHERE artwork_id = ?
    `).bind(artworkId).first() as any
    
    const module2Score = module2?.artwork_content_final_score || 0
    
    // 3. 저작권 인증 (모듈3)
    const module3 = await db.prepare(`
      SELECT certification_score
      FROM artwork_certification
      WHERE artwork_id = ?
    `).bind(artworkId).first() as any
    
    const module3Score = module3?.certification_score || 0
    
    // 4. 전문가 평가 (모듈4)
    const expertEvals = await db.prepare(`
      SELECT overall_score, expert_weight
      FROM expert_evaluations
      WHERE artwork_id = ?
    `).bind(artworkId).all()
    
    let module4Score = 0
    if (expertEvals.results.length > 0) {
      let weightedSum = 0
      let totalWeight = 0
      expertEvals.results.forEach((ev: any) => {
        weightedSum += ev.overall_score * ev.expert_weight
        totalWeight += ev.expert_weight
      })
      module4Score = totalWeight > 0 ? weightedSum / totalWeight : 0
    }
    
    // 5. 대중 인기도 (모듈5)
    const module5 = await db.prepare(`
      SELECT popularity_final_score
      FROM artwork_popularity
      WHERE artwork_id = ?
    `).bind(artworkId).first() as any
    
    const module5Score = module5?.popularity_final_score || 0
    
    // 가중치 (논문 기준)
    const alpha1 = 0.25 // 작가 업적
    const alpha2 = 0.30 // 작품 평가
    const alpha3 = 0.20 // 인증
    const alpha4 = 0.15 // 전문가
    const alpha5 = 0.10 // 인기도
    
    // 최종 가치 점수 계산
    const finalScore = 
      alpha1 * module1Score +
      alpha2 * module2Score +
      alpha3 * module3Score +
      alpha4 * module4Score +
      alpha5 * module5Score
    
    // AVI (Art Value Index) 계산 (0~1000)
    const artValueIndex = finalScore * 10
    
    // 추천 가격 범위 계산 (예시: 점수 기반)
    const basePrice = 1000000 // 100만원 기준
    const recommendedPriceAvg = Math.floor(basePrice * (finalScore / 20))
    const recommendedPriceMin = Math.floor(recommendedPriceAvg * 0.8)
    const recommendedPriceMax = Math.floor(recommendedPriceAvg * 1.2)
    
    // 시장 투명도 지수 (모든 모듈이 평가되었는지 확인)
    let transparencyIndex = 0
    if (module1Score > 0) transparencyIndex += 20
    if (module2Score > 0) transparencyIndex += 20
    if (module3Score > 0) transparencyIndex += 20
    if (module4Score > 0) transparencyIndex += 20
    if (module5Score > 0) transparencyIndex += 20
    
    // 최종 가치 정보 저장/업데이트
    await db.prepare(`
      INSERT INTO artwork_final_valuation (
        artwork_id,
        module1_artist_achievement,
        module2_artwork_content,
        module3_certification,
        module4_expert_evaluation,
        module5_popularity,
        weight_alpha1, weight_alpha2, weight_alpha3, weight_alpha4, weight_alpha5,
        final_value_score,
        recommended_price_min, recommended_price_max, recommended_price_avg,
        art_value_index,
        market_transparency_index,
        calculated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
      ON CONFLICT(artwork_id) DO UPDATE SET
        module1_artist_achievement = excluded.module1_artist_achievement,
        module2_artwork_content = excluded.module2_artwork_content,
        module3_certification = excluded.module3_certification,
        module4_expert_evaluation = excluded.module4_expert_evaluation,
        module5_popularity = excluded.module5_popularity,
        final_value_score = excluded.final_value_score,
        recommended_price_min = excluded.recommended_price_min,
        recommended_price_max = excluded.recommended_price_max,
        recommended_price_avg = excluded.recommended_price_avg,
        art_value_index = excluded.art_value_index,
        market_transparency_index = excluded.market_transparency_index,
        updated_at = CURRENT_TIMESTAMP
    `).bind(
      artworkId,
      module1Score, module2Score, module3Score, module4Score, module5Score,
      alpha1, alpha2, alpha3, alpha4, alpha5,
      finalScore,
      recommendedPriceMin, recommendedPriceMax, recommendedPriceAvg,
      artValueIndex,
      transparencyIndex
    ).run()
    
    return c.json({ 
      success: true,
      finalScore,
      modules: {
        module1: module1Score,
        module2: module2Score,
        module3: module3Score,
        module4: module4Score,
        module5: module5Score
      },
      weights: { alpha1, alpha2, alpha3, alpha4, alpha5 },
      recommendedPrice: {
        min: recommendedPriceMin,
        max: recommendedPriceMax,
        avg: recommendedPriceAvg
      },
      artValueIndex,
      marketTransparencyIndex: transparencyIndex
    })
  } catch (error) {
    console.error('Final valuation error:', error)
    return c.json({ success: false, message: '최종 가치 계산 실패' })
  }
})

// 작품의 전체 가치산정 정보 조회
app.get('/api/valuation/full-report/:artworkId', async (c) => {
  const artworkId = c.req.param('artworkId')
  const db = c.env.DB
  
  try {
    // 기본 작품 정보
    const artwork = await db.prepare(`
      SELECT a.*, ar.name as artist_name, ar.artist_achievement_score
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.id = ?
    `).bind(artworkId).first()
    
    // 모듈2: 작품 내용 평가
    const contentEval = await db.prepare(`
      SELECT * FROM artwork_content_evaluation WHERE artwork_id = ?
    `).bind(artworkId).first()
    
    // 모듈3: 인증 정보
    const certification = await db.prepare(`
      SELECT * FROM artwork_certification WHERE artwork_id = ?
    `).bind(artworkId).first()
    
    // 모듈4: 전문가 평가 목록
    const expertEvals = await db.prepare(`
      SELECT * FROM expert_evaluations WHERE artwork_id = ? ORDER BY evaluated_at DESC
    `).bind(artworkId).all()
    
    // 모듈5: 인기도 정보
    const popularity = await db.prepare(`
      SELECT * FROM artwork_popularity WHERE artwork_id = ?
    `).bind(artworkId).first()
    
    // 최종 가치 정보
    const finalValuation = await db.prepare(`
      SELECT * FROM artwork_final_valuation WHERE artwork_id = ?
    `).bind(artworkId).first()
    
    return c.json({
      success: true,
      artwork,
      contentEvaluation: contentEval,
      certification,
      expertEvaluations: expertEvals.results,
      popularity,
      finalValuation
    })
  } catch (error) {
    return c.json({ success: false, message: '가치산정 정보 조회 실패' })
  }
})

// ====================================
// USER AUTHENTICATION & MANAGEMENT APIs
// ====================================

// Note: generateSessionToken is defined earlier in the file

// Helper: Simple password hash (for demo - use bcrypt in production)
async function hashPassword(password: string): Promise<string> {
  const encoder = new TextEncoder()
  const data = encoder.encode(password)
  const hash = await crypto.subtle.digest('SHA-256', data)
  return Array.from(new Uint8Array(hash))
    .map(b => b.toString(16).padStart(2, '0'))
    .join('')
}

// Helper: Verify session token
async function verifySession(db: any, token: string) {
  const session = await db.prepare(`
    SELECT s.*, u.* 
    FROM user_sessions s
    JOIN users u ON s.user_id = u.id
    WHERE s.session_token = ? AND s.expires_at > datetime('now') AND u.is_active = 1
  `).bind(token).first()
  
  return session
}

// 1. User Registration
app.post('/api/auth/register', async (c) => {
  const db = c.env.DB
  const body = await c.req.json()
  
  try {
    const {
      email,
      password,
      username,
      full_name,
      role = 'artist', // 'artist', 'curator', 'dealer', 'expert', 'admin'
      phone,
      bio
    } = body
    
    // Validate required fields
    if (!email || !password || !username || !full_name) {
      return c.json({ success: false, message: '필수 정보를 입력해주세요' }, 400)
    }
    
    // Check if email or username already exists
    const existingUser = await db.prepare(`
      SELECT id FROM users WHERE email = ? OR username = ?
    `).bind(email, username).first()
    
    if (existingUser) {
      return c.json({ success: false, message: '이미 존재하는 이메일 또는 사용자명입니다' }, 400)
    }
    
    // Hash password
    const passwordHash = await hashPassword(password)
    
    // Insert user
    const result = await db.prepare(`
      INSERT INTO users (email, password_hash, username, full_name, role, phone, bio, created_at, updated_at)
      VALUES (?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    `).bind(email, passwordHash, username, full_name, role, phone || null, bio || null).run()
    
    const userId = result.meta.last_row_id
    
    // Create profile based on role
    if (role === 'artist') {
      await db.prepare(`
        INSERT INTO artist_profiles (user_id, created_at, updated_at)
        VALUES (?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
      `).bind(userId).run()
    } else if (['curator', 'dealer', 'expert'].includes(role)) {
      await db.prepare(`
        INSERT INTO expert_profiles (user_id, expert_type, created_at, updated_at)
        VALUES (?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
      `).bind(userId, role).run()
    }
    
    return c.json({ 
      success: true, 
      message: '회원가입이 완료되었습니다',
      user: { id: userId, email, username, full_name, role }
    })
  } catch (error) {
    console.error('Registration error:', error)
    return c.json({ success: false, message: '회원가입 중 오류가 발생했습니다' }, 500)
  }
})

// 2. User Login
app.post('/api/auth/login', async (c) => {
  const db = c.env.DB
  const body = await c.req.json()
  
  try {
    const { email, password } = body
    
    if (!email || !password) {
      return c.json({ success: false, message: '이메일과 비밀번호를 입력해주세요' }, 400)
    }
    
    // Hash password to compare
    const passwordHash = await hashPassword(password)
    
    // Find user
    const user = await db.prepare(`
      SELECT * FROM users 
      WHERE email = ? AND password_hash = ? AND is_active = 1
    `).bind(email, passwordHash).first()
    
    if (!user) {
      return c.json({ success: false, message: '이메일 또는 비밀번호가 올바르지 않습니다' }, 401)
    }
    
    // Generate session token
    const sessionToken = generateSessionToken()
    const expiresAt = new Date()
    expiresAt.setDate(expiresAt.getDate() + 7) // 7 days
    
    // Create session
    await db.prepare(`
      INSERT INTO user_sessions (user_id, session_token, expires_at, created_at)
      VALUES (?, ?, ?, CURRENT_TIMESTAMP)
    `).bind(user.id, sessionToken, expiresAt.toISOString()).run()
    
    // Update last login
    await db.prepare(`
      UPDATE users SET last_login_at = CURRENT_TIMESTAMP WHERE id = ?
    `).bind(user.id).run()
    
    // Log activity
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, created_at)
      VALUES (?, 'login', CURRENT_TIMESTAMP)
    `).bind(user.id).run()
    
    return c.json({
      success: true,
      message: '로그인 성공',
      token: sessionToken,
      user: {
        id: user.id,
        email: user.email,
        username: user.username,
        full_name: user.full_name,
        role: user.role,
        profile_image: user.profile_image
      }
    })
  } catch (error) {
    console.error('Login error:', error)
    return c.json({ success: false, message: '로그인 중 오류가 발생했습니다' }, 500)
  }
})

// 3. Verify Session / Get Current User
app.get('/api/auth/me', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '인증 토큰이 없습니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    return c.json({
      success: true,
      user: {
        id: session.user_id,
        email: session.email,
        username: session.username,
        full_name: session.full_name,
        role: session.role,
        profile_image: session.profile_image,
        bio: session.bio
      }
    })
  } catch (error) {
    return c.json({ success: false, message: '세션 확인 중 오류가 발생했습니다' }, 500)
  }
})

// 4. Logout
app.post('/api/auth/logout', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '인증 토큰이 없습니다' }, 401)
  }
  
  try {
    await db.prepare(`DELETE FROM user_sessions WHERE session_token = ?`).bind(token).run()
    return c.json({ success: true, message: '로그아웃 되었습니다' })
  } catch (error) {
    return c.json({ success: false, message: '로그아웃 중 오류가 발생했습니다' }, 500)
  }
})

// ====================================
// ARTWORK SUBMISSION APIs (For Artists)
// ====================================

// 5. Submit Artwork
app.post('/api/submissions/create', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session || session.role !== 'artist') {
      return c.json({ success: false, message: '작가 권한이 필요합니다' }, 403)
    }
    
    const body = await c.req.json()
    const {
      title,
      description,
      category,
      technique,
      size_width,
      size_height,
      size_depth,
      creation_year,
      image_url,
      estimated_price,
      exhibitions,
      awards,
      copyright_registration,
      blockchain_hash,
      license_type,
      // 새로 추가된 필드들 (v6.0)
      exhibition_name,
      exhibition_start_date,
      exhibition_end_date,
      originality_description,
      collection_value_description,
      youtube_url,
      instagram_url,
      nft_platform_url,
      press_release_url
    } = body
    
    if (!title || !image_url) {
      return c.json({ success: false, message: '제목과 이미지는 필수입니다' }, 400)
    }
    
    const result = await db.prepare(`
      INSERT INTO artwork_submissions (
        user_id, title, description, category, technique,
        size_width, size_height, size_depth, creation_year,
        image_url, estimated_price,
        exhibitions, awards, copyright_registration, blockchain_hash, license_type,
        submission_status, submitted_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending', CURRENT_TIMESTAMP)
    `).bind(
      session.user_id, title, description, category, technique,
      size_width, size_height, size_depth, creation_year,
      image_url, estimated_price,
      exhibitions ? JSON.stringify(exhibitions) : null,
      awards ? JSON.stringify(awards) : null,
      copyright_registration, blockchain_hash, license_type
    ).run()
    
    const submissionId = result.meta.last_row_id
    
    // Insert extended info if any additional fields are provided
    if (exhibition_name || originality_description || collection_value_description || 
        youtube_url || instagram_url || nft_platform_url || press_release_url) {
      await db.prepare(`
        INSERT INTO artwork_extended_info (
          submission_id,
          exhibition_name,
          exhibition_start_date,
          exhibition_end_date,
          originality_description,
          collection_value_description,
          youtube_url,
          instagram_url,
          nft_platform_url,
          press_release_url,
          created_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
      `).bind(
        submissionId,
        exhibition_name || null,
        exhibition_start_date || null,
        exhibition_end_date || null,
        originality_description || null,
        collection_value_description || null,
        youtube_url || null,
        instagram_url || null,
        nft_platform_url || null,
        press_release_url || null
      ).run()
    }
    
    // Log activity
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, entity_id, created_at)
      VALUES (?, 'submit_artwork', 'submission', ?, CURRENT_TIMESTAMP)
    `).bind(session.user_id, submissionId).run()
    
    // Create notification for admin
    await db.prepare(`
      INSERT INTO notifications (user_id, notification_type, title, message, created_at)
      SELECT id, 'new_submission', '새 작품 제출', ?, CURRENT_TIMESTAMP
      FROM users WHERE role = 'admin'
    `).bind(`${session.full_name}님이 새 작품을 제출했습니다: ${title}`).run()
    
    return c.json({
      success: true,
      message: '작품이 제출되었습니다',
      submission_id: submissionId
    })
  } catch (error) {
    console.error('Submission error:', error)
    return c.json({ success: false, message: '작품 제출 중 오류가 발생했습니다' }, 500)
  }
})

// 6. Get My Submissions
app.get('/api/submissions/my-submissions', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    const submissions = await db.prepare(`
      SELECT * FROM artwork_submissions 
      WHERE user_id = ? 
      ORDER BY submitted_at DESC
    `).bind(session.user_id).all()
    
    return c.json({ success: true, data: submissions.results })
  } catch (error) {
    return c.json({ success: false, message: '제출 내역 조회 중 오류가 발생했습니다' }, 500)
  }
})

// 7. Get All Submissions (Admin)
app.get('/api/submissions/all', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const status = c.req.query('status') // 'pending', 'approved', 'rejected'
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session || session.role !== 'admin') {
      return c.json({ success: false, message: '관리자 권한이 필요합니다' }, 403)
    }
    
    let query = `
      SELECT s.*, u.username, u.full_name, u.email
      FROM artwork_submissions s
      JOIN users u ON s.user_id = u.id
    `
    
    if (status) {
      query += ` WHERE s.submission_status = ?`
    }
    
    query += ` ORDER BY s.submitted_at DESC`
    
    const submissions = status 
      ? await db.prepare(query).bind(status).all()
      : await db.prepare(query).all()
    
    return c.json({ success: true, data: submissions.results })
  } catch (error) {
    return c.json({ success: false, message: '제출 내역 조회 중 오류가 발생했습니다' }, 500)
  }
})

// 8. Approve/Reject Submission (Admin)
app.post('/api/submissions/:submissionId/review', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const submissionId = c.req.param('submissionId')
  const body = await c.req.json()
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session || session.role !== 'admin') {
      return c.json({ success: false, message: '관리자 권한이 필요합니다' }, 403)
    }
    
    const { status, admin_notes, rejection_reason } = body
    
    if (!['approved', 'rejected'].includes(status)) {
      return c.json({ success: false, message: '유효하지 않은 상태입니다' }, 400)
    }
    
    // Get submission details
    const submission = await db.prepare(`
      SELECT * FROM artwork_submissions WHERE id = ?
    `).bind(submissionId).first()
    
    if (!submission) {
      return c.json({ success: false, message: '제출 내역을 찾을 수 없습니다' }, 404)
    }
    
    // Update submission status
    await db.prepare(`
      UPDATE artwork_submissions
      SET submission_status = ?, admin_notes = ?, rejection_reason = ?, reviewed_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(status, admin_notes, rejection_reason, submissionId).run()
    
    // If approved, create artwork and artist if needed
    if (status === 'approved') {
      // Check if artist exists for this user
      let artist = await db.prepare(`
        SELECT id FROM artists WHERE email = (SELECT email FROM users WHERE id = ?)
      `).bind(submission.user_id).first()
      
      let artistId
      if (!artist) {
        // Create artist from user profile
        const user = await db.prepare(`SELECT * FROM users WHERE id = ?`).bind(submission.user_id).first()
        const artistResult = await db.prepare(`
          INSERT INTO artists (name, email, bio, profile_image, created_at)
          VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP)
        `).bind(user.full_name, user.email, user.bio, user.profile_image).run()
        artistId = artistResult.meta.last_row_id
      } else {
        artistId = artist.id
      }
      
      // Create artwork
      const artworkResult = await db.prepare(`
        INSERT INTO artworks (
          artist_id, title, description, category, technique,
          size_width, size_height, size_depth, creation_year,
          image_url, current_price, status, created_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'minted', CURRENT_TIMESTAMP)
      `).bind(
        artistId, submission.title, submission.description, submission.category, submission.technique,
        submission.size_width, submission.size_height, submission.size_depth, submission.creation_year,
        submission.image_url, submission.estimated_price
      ).run()
      
      const artworkId = artworkResult.meta.last_row_id
      
      // Update submission with approved_at
      await db.prepare(`
        UPDATE artwork_submissions SET approved_at = CURRENT_TIMESTAMP WHERE id = ?
      `).bind(submissionId).run()
      
      // Create notification for artist
      await db.prepare(`
        INSERT INTO notifications (user_id, notification_type, title, message, link_url, created_at)
        VALUES (?, 'submission_approved', '작품 승인', ?, ?, CURRENT_TIMESTAMP)
      `).bind(
        submission.user_id,
        `작품 "${submission.title}"이(가) 승인되었습니다`,
        `/artwork/${artworkId}`
      ).run()
    } else {
      // Create notification for rejection
      await db.prepare(`
        INSERT INTO notifications (user_id, notification_type, title, message, created_at)
        VALUES (?, 'submission_rejected', '작품 반려', ?, CURRENT_TIMESTAMP)
      `).bind(
        submission.user_id,
        `작품 "${submission.title}"이(가) 반려되었습니다. 사유: ${rejection_reason}`
      ).run()
    }
    
    return c.json({ success: true, message: `제출이 ${status === 'approved' ? '승인' : '반려'}되었습니다` })
  } catch (error) {
    console.error('Review error:', error)
    return c.json({ success: false, message: '검토 처리 중 오류가 발생했습니다' }, 500)
  }
})

// ====================================
// EXPERT EVALUATION APIs
// ====================================

// 9. Create Expert Evaluation
app.post('/api/evaluations/create', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session || !['curator', 'dealer', 'expert', 'admin'].includes(session.role)) {
      return c.json({ success: false, message: '전문가 권한이 필요합니다' }, 403)
    }
    
    const body = await c.req.json()
    const {
      artwork_id,
      artistic_value_score,
      technical_skill_score,
      originality_score,
      market_potential_score,
      collection_value_score,
      recommended_price_min,
      recommended_price_max,
      evaluation_status = 'draft'
    } = body
    
    if (!artwork_id) {
      return c.json({ success: false, message: '작품 ID가 필요합니다' }, 400)
    }
    
    // Calculate overall score
    const overallScore = Math.round(
      (artistic_value_score + technical_skill_score + originality_score + 
       market_potential_score + collection_value_score) / 5
    )
    
    // Get expert profile
    const expertProfile = await db.prepare(`
      SELECT * FROM expert_profiles WHERE user_id = ?
    `).bind(session.user_id).first()
    
    const expertType = expertProfile?.expert_type || session.role
    const authorityLevel = expertProfile?.authority_level || 3
    
    const result = await db.prepare(`
      INSERT INTO user_expert_evaluations (
        artwork_id, expert_user_id, expert_type, expert_authority_level,
        artistic_value_score, technical_skill_score, originality_score,
        market_potential_score, collection_value_score, overall_score,
        recommended_price_min, recommended_price_max,
        evaluation_status, created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    `).bind(
      artwork_id, session.user_id, expertType, authorityLevel,
      artistic_value_score, technical_skill_score, originality_score,
      market_potential_score, collection_value_score, overallScore,
      recommended_price_min, recommended_price_max, evaluation_status
    ).run()
    
    // Log activity
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, entity_id, created_at)
      VALUES (?, 'create_evaluation', 'evaluation', ?, CURRENT_TIMESTAMP)
    `).bind(session.user_id, result.meta.last_row_id).run()
    
    return c.json({
      success: true,
      message: '평가가 저장되었습니다',
      evaluation_id: result.meta.last_row_id
    })
  } catch (error) {
    console.error('Evaluation error:', error)
    return c.json({ success: false, message: '평가 저장 중 오류가 발생했습니다' }, 500)
  }
})

// 10. Update Expert Evaluation
app.put('/api/evaluations/:evaluationId', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const evaluationId = c.req.param('evaluationId')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    // Check ownership
    const evaluation = await db.prepare(`
      SELECT * FROM user_expert_evaluations WHERE id = ? AND expert_user_id = ?
    `).bind(evaluationId, session.user_id).first()
    
    if (!evaluation) {
      return c.json({ success: false, message: '평가를 찾을 수 없거나 권한이 없습니다' }, 404)
    }
    
    const body = await c.req.json()
    const {
      artistic_value_score,
      technical_skill_score,
      originality_score,
      market_potential_score,
      collection_value_score,
      recommended_price_min,
      recommended_price_max,
      evaluation_status
    } = body
    
    // Calculate overall score
    const overallScore = Math.round(
      (artistic_value_score + technical_skill_score + originality_score + 
       market_potential_score + collection_value_score) / 5
    )
    
    await db.prepare(`
      UPDATE user_expert_evaluations
      SET artistic_value_score = ?, technical_skill_score = ?, originality_score = ?,
          market_potential_score = ?, collection_value_score = ?, overall_score = ?,
          recommended_price_min = ?, recommended_price_max = ?,
          evaluation_status = ?, updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(
      artistic_value_score, technical_skill_score, originality_score,
      market_potential_score, collection_value_score, overallScore,
      recommended_price_min, recommended_price_max, evaluation_status,
      evaluationId
    ).run()
    
    if (evaluation_status === 'submitted' && evaluation.evaluation_status !== 'submitted') {
      await db.prepare(`
        UPDATE user_expert_evaluations SET submitted_at = CURRENT_TIMESTAMP WHERE id = ?
      `).bind(evaluationId).run()
    }
    
    return c.json({ success: true, message: '평가가 업데이트되었습니다' })
  } catch (error) {
    return c.json({ success: false, message: '평가 업데이트 중 오류가 발생했습니다' }, 500)
  }
})

// 11. Get Evaluations for Artwork
app.get('/api/evaluations/artwork/:artworkId', async (c) => {
  const db = c.env.DB
  const artworkId = c.req.param('artworkId')
  
  try {
    const evaluations = await db.prepare(`
      SELECT e.*, u.full_name, u.username, u.profile_image
      FROM user_expert_evaluations e
      JOIN users u ON e.expert_user_id = u.id
      WHERE e.artwork_id = ? AND e.evaluation_status = 'published'
      ORDER BY e.submitted_at DESC
    `).bind(artworkId).all()
    
    return c.json({ success: true, data: evaluations.results })
  } catch (error) {
    return c.json({ success: false, message: '평가 조회 중 오류가 발생했습니다' }, 500)
  }
})

// 12. Create Expert Comment
app.post('/api/evaluations/:evaluationId/comments', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const evaluationId = c.req.param('evaluationId')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    // Check if user owns this evaluation
    const evaluation = await db.prepare(`
      SELECT * FROM user_expert_evaluations WHERE id = ? AND expert_user_id = ?
    `).bind(evaluationId, session.user_id).first()
    
    if (!evaluation) {
      return c.json({ success: false, message: '평가를 찾을 수 없거나 권한이 없습니다' }, 404)
    }
    
    const body = await c.req.json()
    const { comment_type, comment_text, is_public = 1 } = body
    
    if (!comment_text) {
      return c.json({ success: false, message: '코멘트 내용이 필요합니다' }, 400)
    }
    
    const result = await db.prepare(`
      INSERT INTO user_expert_comments (
        evaluation_id, artwork_id, expert_user_id,
        comment_type, comment_text, is_public,
        created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    `).bind(
      evaluationId, evaluation.artwork_id, session.user_id,
      comment_type, comment_text, is_public
    ).run()
    
    return c.json({
      success: true,
      message: '코멘트가 추가되었습니다',
      comment_id: result.meta.last_row_id
    })
  } catch (error) {
    return c.json({ success: false, message: '코멘트 추가 중 오류가 발생했습니다' }, 500)
  }
})

// 13. Get Comments for Evaluation
app.get('/api/evaluations/:evaluationId/comments', async (c) => {
  const db = c.env.DB
  const evaluationId = c.req.param('evaluationId')
  
  try {
    const comments = await db.prepare(`
      SELECT c.*, u.full_name, u.username, u.profile_image
      FROM user_expert_comments c
      JOIN users u ON c.expert_user_id = u.id
      WHERE c.evaluation_id = ? AND c.is_public = 1
      ORDER BY c.created_at DESC
    `).bind(evaluationId).all()
    
    return c.json({ success: true, data: comments.results })
  } catch (error) {
    return c.json({ success: false, message: '코멘트 조회 중 오류가 발생했습니다' }, 500)
  }
})

// 14. Get My Evaluations (for experts)
app.get('/api/evaluations/my-evaluations', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    const evaluations = await db.prepare(`
      SELECT e.*, a.title as artwork_title, a.image_url as artwork_image,
             ar.name as artist_name
      FROM user_expert_evaluations e
      JOIN artworks a ON e.artwork_id = a.id
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE e.expert_user_id = ?
      ORDER BY e.created_at DESC
    `).bind(session.user_id).all()
    
    return c.json({ success: true, data: evaluations.results })
  } catch (error) {
    return c.json({ success: false, message: '평가 조회 중 오류가 발생했습니다' }, 500)
  }
})

// 15. Get Notifications
app.get('/api/notifications', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    const notifications = await db.prepare(`
      SELECT * FROM notifications
      WHERE user_id = ?
      ORDER BY created_at DESC
      LIMIT 50
    `).bind(session.user_id).all()
    
    return c.json({ success: true, data: notifications.results })
  } catch (error) {
    return c.json({ success: false, message: '알림 조회 중 오류가 발생했습니다' }, 500)
  }
})

// 16. Mark Notification as Read
app.put('/api/notifications/:notificationId/read', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const notificationId = c.req.param('notificationId')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    await db.prepare(`
      UPDATE notifications SET is_read = 1
      WHERE id = ? AND user_id = ?
    `).bind(notificationId, session.user_id).run()
    
    return c.json({ success: true, message: '알림을 읽음으로 표시했습니다' })
  } catch (error) {
    return c.json({ success: false, message: '알림 업데이트 중 오류가 발생했습니다' }, 500)
  }
})

// ==================== 구매 및 경매 시스템 API ====================

// 17. 직접 구매 요청 (Direct Purchase)
app.post('/api/artworks/:id/purchase', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const artworkId = c.req.param('id')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    const { offer_price, message, payment_method } = await c.req.json()
    
    // 작품 정보 조회
    const artwork = await db.prepare(`
      SELECT a.*, ao.owner_id as current_owner_id
      FROM artworks a
      LEFT JOIN artwork_ownership ao ON a.id = ao.artwork_id AND ao.is_current_owner = 1
      WHERE a.id = ?
    `).bind(artworkId).first()
    
    if (!artwork) {
      return c.json({ success: false, message: '작품을 찾을 수 없습니다' }, 404)
    }
    
    if (!artwork.current_owner_id) {
      return c.json({ success: false, message: '소유자 정보가 없습니다' }, 400)
    }
    
    if (artwork.current_owner_id === session.user_id) {
      return c.json({ success: false, message: '본인의 작품은 구매할 수 없습니다' }, 400)
    }
    
    // 구매 제안 생성
    const expiresAt = new Date()
    expiresAt.setDate(expiresAt.getDate() + 7) // 7일 후 만료
    
    const result = await db.prepare(`
      INSERT INTO purchase_offers (artwork_id, buyer_id, seller_id, offer_price, message, status, expires_at)
      VALUES (?, ?, ?, ?, ?, 'pending', ?)
    `).bind(artworkId, session.user_id, artwork.current_owner_id, offer_price, message || null, expiresAt.toISOString()).run()
    
    // 판매자에게 알림 생성
    await db.prepare(`
      INSERT INTO notifications (user_id, type, title, message, link)
      VALUES (?, 'purchase_offer', '구매 제안 도착', ?, ?)
    `).bind(
      artwork.current_owner_id,
      `회원님의 작품 "${artwork.title}"에 대한 구매 제안이 도착했습니다. 제안 금액: ${offer_price} ETH`,
      `/mypage?tab=offers`
    ).run()
    
    return c.json({ 
      success: true, 
      message: '구매 제안이 전송되었습니다',
      offer_id: result.meta.last_row_id 
    })
  } catch (error: any) {
    console.error('Purchase offer error:', error)
    return c.json({ success: false, message: '구매 제안 중 오류가 발생했습니다: ' + error.message }, 500)
  }
})

// 18. 경매 생성
app.post('/api/artworks/:id/auction/create', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const artworkId = c.req.param('id')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    const { starting_price, reserve_price, duration_days } = await c.req.json()
    
    // 작품 소유권 확인
    const ownership = await db.prepare(`
      SELECT * FROM artwork_ownership
      WHERE artwork_id = ? AND owner_id = ? AND is_current_owner = 1
    `).bind(artworkId, session.user_id).first()
    
    if (!ownership) {
      return c.json({ success: false, message: '작품 소유자만 경매를 생성할 수 있습니다' }, 403)
    }
    
    // 이미 진행 중인 경매가 있는지 확인
    const existingAuction = await db.prepare(`
      SELECT * FROM auctions WHERE artwork_id = ? AND status = 'active'
    `).bind(artworkId).first()
    
    if (existingAuction) {
      return c.json({ success: false, message: '이미 진행 중인 경매가 있습니다' }, 400)
    }
    
    // 경매 종료 시간 계산
    const endTime = new Date()
    endTime.setDate(endTime.getDate() + (duration_days || 7))
    
    // 경매 생성
    const result = await db.prepare(`
      INSERT INTO auctions (
        artwork_id, seller_id, starting_price, current_price, 
        reserve_price, end_time, status
      )
      VALUES (?, ?, ?, ?, ?, ?, 'active')
    `).bind(
      artworkId, session.user_id, starting_price, starting_price,
      reserve_price || starting_price, endTime.toISOString()
    ).run()
    
    return c.json({ 
      success: true, 
      message: '경매가 생성되었습니다',
      auction_id: result.meta.last_row_id 
    })
  } catch (error: any) {
    console.error('Auction creation error:', error)
    return c.json({ success: false, message: '경매 생성 중 오류가 발생했습니다: ' + error.message }, 500)
  }
})

// 19. 경매 입찰
app.post('/api/auctions/:auctionId/bid', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const auctionId = c.req.param('auctionId')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    const { bid_amount } = await c.req.json()
    
    // 경매 정보 조회
    const auction = await db.prepare(`
      SELECT a.*, aw.title as artwork_title
      FROM auctions a
      LEFT JOIN artworks aw ON a.artwork_id = aw.id
      WHERE a.id = ?
    `).bind(auctionId).first()
    
    if (!auction) {
      return c.json({ success: false, message: '경매를 찾을 수 없습니다' }, 404)
    }
    
    if (auction.status !== 'active') {
      return c.json({ success: false, message: '진행 중인 경매가 아닙니다' }, 400)
    }
    
    if (new Date(auction.end_time) < new Date()) {
      return c.json({ success: false, message: '경매가 종료되었습니다' }, 400)
    }
    
    if (auction.seller_id === session.user_id) {
      return c.json({ success: false, message: '본인의 경매에는 입찰할 수 없습니다' }, 400)
    }
    
    if (bid_amount <= auction.current_price) {
      return c.json({ success: false, message: `입찰가는 현재가(${auction.current_price} ETH)보다 높아야 합니다` }, 400)
    }
    
    // 이전 최고 입찰자의 is_winning_bid를 0으로 변경
    await db.prepare(`
      UPDATE auction_bids SET is_winning_bid = 0
      WHERE auction_id = ? AND is_winning_bid = 1
    `).bind(auctionId).run()
    
    // 새로운 입찰 추가
    const bidResult = await db.prepare(`
      INSERT INTO auction_bids (auction_id, bidder_id, bid_amount, is_winning_bid)
      VALUES (?, ?, ?, 1)
    `).bind(auctionId, session.user_id, bid_amount).run()
    
    // 경매 정보 업데이트
    await db.prepare(`
      UPDATE auctions 
      SET current_price = ?, 
          winner_id = ?,
          winning_bid_id = ?,
          total_bids = total_bids + 1,
          updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(bid_amount, session.user_id, bidResult.meta.last_row_id, auctionId).run()
    
    // 판매자에게 알림
    await db.prepare(`
      INSERT INTO notifications (user_id, type, title, message, link)
      VALUES (?, 'new_bid', '새로운 입찰', ?, ?)
    `).bind(
      auction.seller_id,
      `"${auction.artwork_title}" 경매에 ${bid_amount} ETH 입찰이 들어왔습니다`,
      `/auction/${auctionId}`
    ).run()
    
    return c.json({ 
      success: true, 
      message: '입찰이 완료되었습니다',
      bid_id: bidResult.meta.last_row_id,
      current_price: bid_amount
    })
  } catch (error: any) {
    console.error('Bidding error:', error)
    return c.json({ success: false, message: '입찰 중 오류가 발생했습니다: ' + error.message }, 500)
  }
})

// 20. 경매 정보 조회
app.get('/api/artworks/:id/auction', async (c) => {
  const db = c.env.DB
  const artworkId = c.req.param('id')
  
  try {
    const auction = await db.prepare(`
      SELECT 
        a.*,
        u.full_name as seller_name,
        u.username as seller_username,
        COUNT(ab.id) as total_bids,
        MAX(ab.bid_amount) as highest_bid
      FROM auctions a
      LEFT JOIN users u ON a.seller_id = u.id
      LEFT JOIN auction_bids ab ON a.id = ab.auction_id
      WHERE a.artwork_id = ? AND a.status = 'active'
      GROUP BY a.id
    `).bind(artworkId).first()
    
    if (!auction) {
      return c.json({ success: true, data: null })
    }
    
    // 최근 입찰 내역
    const recentBids = await db.prepare(`
      SELECT 
        ab.*,
        u.username,
        u.full_name
      FROM auction_bids ab
      LEFT JOIN users u ON ab.bidder_id = u.id
      WHERE ab.auction_id = ?
      ORDER BY ab.bid_time DESC
      LIMIT 10
    `).bind(auction.id).all()
    
    return c.json({ 
      success: true, 
      data: auction,
      recent_bids: recentBids.results 
    })
  } catch (error: any) {
    console.error('Auction fetch error:', error)
    return c.json({ success: false, message: '경매 정보 조회 중 오류가 발생했습니다' }, 500)
  }
})

// 21. 관리자: 거래 내역 조회
app.get('/api/admin/transactions', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifyAdminSession(db, token)
    if (!session) {
      return c.json({ success: false, message: '관리자 권한이 필요합니다' }, 403)
    }
    
    const { status, type, limit = 50 } = c.req.query()
    
    let query = `
      SELECT 
        t.*,
        a.title as artwork_title,
        a.image_url as artwork_image,
        buyer.full_name as buyer_name,
        buyer.username as buyer_username,
        seller.full_name as seller_name,
        seller.username as seller_username
      FROM transactions t
      LEFT JOIN artworks a ON t.artwork_id = a.id
      LEFT JOIN users buyer ON t.buyer_id = buyer.id
      LEFT JOIN users seller ON t.seller_id = seller.id
      WHERE 1=1
    `
    
    const params: any[] = []
    
    if (status) {
      query += ` AND t.status = ?`
      params.push(status)
    }
    
    if (type) {
      query += ` AND t.transaction_type = ?`
      params.push(type)
    }
    
    query += ` ORDER BY t.created_at DESC LIMIT ?`
    params.push(parseInt(limit as string))
    
    const result = await db.prepare(query).bind(...params).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    console.error('Admin transactions fetch error:', error)
    return c.json({ success: false, message: '거래 내역 조회 중 오류가 발생했습니다' }, 500)
  }
})

// 22. 관리자: 경매 목록 조회
app.get('/api/admin/auctions', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifyAdminSession(db, token)
    if (!session) {
      return c.json({ success: false, message: '관리자 권한이 필요합니다' }, 403)
    }
    
    const { status, limit = 50 } = c.req.query()
    
    let query = `
      SELECT 
        a.*,
        aw.title as artwork_title,
        aw.image_url as artwork_image,
        seller.full_name as seller_name,
        seller.username as seller_username,
        winner.full_name as winner_name,
        winner.username as winner_username
      FROM auctions a
      LEFT JOIN artworks aw ON a.artwork_id = aw.id
      LEFT JOIN users seller ON a.seller_id = seller.id
      LEFT JOIN users winner ON a.winner_id = winner.id
      WHERE 1=1
    `
    
    const params: any[] = []
    
    if (status) {
      query += ` AND a.status = ?`
      params.push(status)
    }
    
    query += ` ORDER BY a.created_at DESC LIMIT ?`
    params.push(parseInt(limit as string))
    
    const result = await db.prepare(query).bind(...params).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    console.error('Admin auctions fetch error:', error)
    return c.json({ success: false, message: '경매 목록 조회 중 오류가 발생했습니다' }, 500)
  }
})

// ============================================
// 아티스트 랭크 프레임워크 API
// ============================================

// 1. 전시회 경력 추가
app.post('/api/artist/exhibitions', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    const { 
      exhibition_type, title, location, organizer, 
      start_date, end_date, is_famous_venue, proof_document_url 
    } = await c.req.json()
    
    // 점수 계산 (PDF 기준)
    const pointsMap: any = {
      'international_biennale': 150,
      'international_solo': 150,
      'international_2person': 100,
      'international_3person': 70,
      'international_group': 50,
      'domestic_biennale': 100,
      'domestic_solo': 100,
      'domestic_2person': 70,
      'domestic_3person': 50,
      'domestic_group': 30,
      'other': 20
    }
    
    let points = pointsMap[exhibition_type] || 20
    
    // 유명 전시회 가중치 +10%
    if (is_famous_venue) {
      points = Math.round(points * 1.1)
    }
    
    const result = await db.prepare(`
      INSERT INTO artist_exhibitions (
        artist_id, exhibition_type, title, location, organizer, 
        start_date, end_date, is_famous_venue, proof_document_url, points, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending')
    `).bind(
      session.user_id, exhibition_type, title, location, organizer,
      start_date, end_date, is_famous_venue ? 1 : 0, proof_document_url, points
    ).run()
    
    // 랭크 재계산
    await calculateArtistRank(db, session.user_id)
    
    return c.json({ 
      success: true, 
      message: '전시회 경력이 추가되었습니다',
      exhibition_id: result.meta.last_row_id 
    })
  } catch (error: any) {
    console.error('Exhibition add error:', error)
    return c.json({ success: false, message: '전시회 경력 추가 중 오류가 발생했습니다' }, 500)
  }
})

// 2. 전시회 경력 조회
app.get('/api/artist/exhibitions', async (c) => {
  const db = c.env.DB
  const artistId = c.req.query('artist_id')
  
  try {
    const result = await db.prepare(`
      SELECT * FROM artist_exhibitions 
      WHERE artist_id = ? 
      ORDER BY start_date DESC
    `).bind(artistId).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    console.error('Exhibitions fetch error:', error)
    return c.json({ success: false, message: '전시회 경력 조회 중 오류가 발생했습니다' }, 500)
  }
})

// 3. 수상 경력 추가
app.post('/api/artist/awards', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    const { 
      award_rank, award_name, competition_name, organizer, 
      award_date, is_international, certificate_url, proof_url 
    } = await c.req.json()
    
    // 점수 계산
    const rankPoints = [100, 70, 50, 30] // 1순위, 2순위, 3순위, 입선
    let points = rankPoints[award_rank - 1] || 30
    
    // 국제 수상 가중치 +10%
    if (is_international) {
      points = Math.round(points * 1.1)
    }
    
    const result = await db.prepare(`
      INSERT INTO artist_awards (
        artist_id, award_rank, award_name, competition_name, organizer,
        award_date, is_international, certificate_url, proof_url, points, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending')
    `).bind(
      session.user_id, award_rank, award_name, competition_name, organizer,
      award_date, is_international ? 1 : 0, certificate_url, proof_url, points
    ).run()
    
    await calculateArtistRank(db, session.user_id)
    
    return c.json({ 
      success: true, 
      message: '수상 경력이 추가되었습니다',
      award_id: result.meta.last_row_id 
    })
  } catch (error: any) {
    console.error('Award add error:', error)
    return c.json({ success: false, message: '수상 경력 추가 중 오류가 발생했습니다' }, 500)
  }
})

// 4. 수상 경력 조회
app.get('/api/artist/awards', async (c) => {
  const db = c.env.DB
  const artistId = c.req.query('artist_id')
  
  try {
    const result = await db.prepare(`
      SELECT * FROM artist_awards 
      WHERE artist_id = ? 
      ORDER BY award_date DESC
    `).bind(artistId).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    console.error('Awards fetch error:', error)
    return c.json({ success: false, message: '수상 경력 조회 중 오류가 발생했습니다' }, 500)
  }
})

// 5. 저작권 등록 추가
app.post('/api/artist/copyrights', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    const { 
      artwork_title, registration_number, registration_agency,
      registration_date, certificate_url, country 
    } = await c.req.json()
    
    const result = await db.prepare(`
      INSERT INTO artist_copyrights (
        artist_id, artwork_title, registration_number, registration_agency,
        registration_date, certificate_url, country, points, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, 30, 'pending')
    `).bind(
      session.user_id, artwork_title, registration_number, registration_agency,
      registration_date, certificate_url, country || 'KR'
    ).run()
    
    await calculateArtistRank(db, session.user_id)
    
    return c.json({ 
      success: true, 
      message: '저작권 등록이 추가되었습니다',
      copyright_id: result.meta.last_row_id 
    })
  } catch (error: any) {
    console.error('Copyright add error:', error)
    return c.json({ success: false, message: '저작권 등록 중 오류가 발생했습니다' }, 500)
  }
})

// 6. 저작권 조회
app.get('/api/artist/copyrights', async (c) => {
  const db = c.env.DB
  const artistId = c.req.query('artist_id')
  
  try {
    const result = await db.prepare(`
      SELECT * FROM artist_copyrights 
      WHERE artist_id = ? 
      ORDER BY registration_date DESC
    `).bind(artistId).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    console.error('Copyrights fetch error:', error)
    return c.json({ success: false, message: '저작권 조회 중 오류가 발생했습니다' }, 500)
  }
})

// 7. 아티스트 랭크 조회
app.get('/api/artist/rank/:artistId', async (c) => {
  const db = c.env.DB
  const artistId = c.req.param('artistId')
  
  try {
    const result = await db.prepare(`
      SELECT ar.*, u.username, u.full_name, u.bio
      FROM artist_ranks ar
      LEFT JOIN users u ON ar.artist_id = u.id
      WHERE ar.artist_id = ?
    `).bind(artistId).first()
    
    if (!result) {
      return c.json({ success: false, message: '랭크 정보를 찾을 수 없습니다' }, 404)
    }
    
    return c.json({ success: true, data: result })
  } catch (error: any) {
    console.error('Rank fetch error:', error)
    return c.json({ success: false, message: '랭크 조회 중 오류가 발생했습니다' }, 500)
  }
})

// 8. 랭크 리더보드 (상위 랭킹 아티스트)
app.get('/api/artist/leaderboard', async (c) => {
  const db = c.env.DB
  const limit = parseInt(c.req.query('limit') || '50')
  const category = c.req.query('category') // master, excellent, professional, emerging
  
  try {
    let query = `
      SELECT 
        ar.*,
        u.username, u.full_name, u.bio
      FROM artist_ranks ar
      LEFT JOIN users u ON ar.artist_id = u.id
      WHERE 1=1
    `
    
    const params: any[] = []
    
    if (category) {
      query += ` AND ar.rank_category = ?`
      params.push(category)
    }
    
    query += ` ORDER BY ar.final_score DESC LIMIT ?`
    params.push(limit)
    
    const result = await db.prepare(query).bind(...params).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    console.error('Leaderboard fetch error:', error)
    return c.json({ success: false, message: '리더보드 조회 중 오류가 발생했습니다' }, 500)
  }
})

// 9. 랭크 재계산 (관리자/자동)
app.post('/api/artist/rank/recalculate/:artistId', async (c) => {
  const db = c.env.DB
  const artistId = c.req.param('artistId')
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: '로그인이 필요합니다' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: '유효하지 않은 세션입니다' }, 401)
    }
    
    // 본인 또는 관리자만 재계산 가능
    if (session.user_id !== parseInt(artistId) && session.role !== 'admin') {
      return c.json({ success: false, message: '권한이 없습니다' }, 403)
    }
    
    await calculateArtistRank(db, parseInt(artistId))
    
    return c.json({ success: true, message: '랭크가 재계산되었습니다' })
  } catch (error: any) {
    console.error('Rank recalculation error:', error)
    return c.json({ success: false, message: '랭크 재계산 중 오류가 발생했습니다' }, 500)
  }
})

// 10. 랭크 히스토리 조회
app.get('/api/artist/rank/history/:artistId', async (c) => {
  const db = c.env.DB
  const artistId = c.req.param('artistId')
  
  try {
    const result = await db.prepare(`
      SELECT * FROM artist_rank_history 
      WHERE artist_id = ? 
      ORDER BY calculated_at DESC
      LIMIT 20
    `).bind(artistId).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    console.error('Rank history fetch error:', error)
    return c.json({ success: false, message: '랭크 히스토리 조회 중 오류가 발생했습니다' }, 500)
  }
})

// ============================================
// 랭크 계산 함수
// ============================================

async function calculateArtistRank(db: any, artistId: number) {
  try {
    // 1. 정량평가 계산
    
    // 전시회 점수
    const exhibitions = await db.prepare(`
      SELECT COALESCE(SUM(points), 0) as total
      FROM artist_exhibitions 
      WHERE artist_id = ? AND status = 'verified'
    `).bind(artistId).first()
    const exhibitionsScore = exhibitions?.total || 0
    
    // 수상 점수
    const awards = await db.prepare(`
      SELECT COALESCE(SUM(points), 0) as total
      FROM artist_awards 
      WHERE artist_id = ? AND status = 'verified'
    `).bind(artistId).first()
    const awardsScore = awards?.total || 0
    
    // 저작권 점수
    const copyrights = await db.prepare(`
      SELECT COALESCE(SUM(points), 0) as total
      FROM artist_copyrights 
      WHERE artist_id = ? AND status = 'verified'
    `).bind(artistId).first()
    const copyrightsScore = copyrights?.total || 0
    
    // 전시기획 점수
    const curations = await db.prepare(`
      SELECT COALESCE(SUM(points), 0) as total
      FROM artist_curations 
      WHERE artist_id = ? AND status = 'verified'
    `).bind(artistId).first()
    const curationsScore = curations?.total || 0
    
    // 논문/저서 점수
    const publications = await db.prepare(`
      SELECT COALESCE(SUM(points), 0) as total
      FROM artist_publications 
      WHERE artist_id = ? AND status = 'verified'
    `).bind(artistId).first()
    const publicationsScore = publications?.total || 0
    
    const quantitativeTotal = exhibitionsScore + awardsScore + copyrightsScore + curationsScore + publicationsScore
    const quantitativeWeighted = quantitativeTotal * 0.4 // 40%
    
    // 2. 정성평가 계산 (30%)
    // 전문가 평가 점수 (평균)
    const qualitative = await db.prepare(`
      SELECT 
        AVG(total_score) as avg_score,
        COUNT(*) as eval_count
      FROM artist_qualitative_evaluations 
      WHERE artist_id = ? AND status = 'completed'
    `).bind(artistId).first()
    
    let qualitativeScore = qualitative?.avg_score || 0
    
    // 판매 가중치 (판매 횟수 * 10점)
    const sales = await db.prepare(`
      SELECT COUNT(*) as count
      FROM artwork_sales_history 
      WHERE artist_id = ?
    `).bind(artistId).first()
    const salesBonus = (sales?.count || 0) * 10
    
    qualitativeScore += salesBonus
    const qualitativeWeighted = qualitativeScore * 0.3 // 30%
    
    // 3. 인기도 평가 계산 (30%)
    const user = await db.prepare(`
      SELECT youtube_views, opensea_views, platform_views 
      FROM users WHERE id = ?
    `).bind(artistId).first()
    
    const youtubeViews = user?.youtube_views || 0
    const openseaViews = user?.opensea_views || 0
    const platformViews = user?.platform_views || 0
    
    // YouTube/OpenSea 점수 계산
    let youtubeScore = 0
    if (youtubeViews >= 50000) youtubeScore = 500
    else if (youtubeViews >= 10000) youtubeScore = 500
    else if (youtubeViews >= 1000) youtubeScore = 400
    else if (youtubeViews >= 500) youtubeScore = 300
    else if (youtubeViews >= 100) youtubeScore = 200
    else if (youtubeViews >= 1) youtubeScore = 100
    
    let openseaScore = 0
    if (openseaViews >= 50000) openseaScore = 500
    else if (openseaViews >= 10000) openseaScore = 500
    else if (openseaViews >= 1000) openseaScore = 400
    else if (openseaViews >= 500) openseaScore = 300
    else if (openseaViews >= 100) openseaScore = 200
    else if (openseaViews >= 1) openseaScore = 100
    
    // 플랫폼 점수 계산
    let platformScore = 0
    if (platformViews >= 50000) platformScore = 500
    else if (platformViews >= 10000) platformScore = 400
    else if (platformViews >= 5000) platformScore = 300
    else if (platformViews >= 1000) platformScore = 200
    else if (platformViews >= 500) platformScore = 100
    else if (platformViews >= 1) platformScore = 50
    
    const popularityTotal = youtubeScore + openseaScore + platformScore
    const popularityWeighted = popularityTotal * 0.3 // 30%
    
    // 4. 최종 점수 계산
    const finalScore = quantitativeWeighted + qualitativeWeighted + popularityWeighted
    
    // 5. 랭크 등급 결정
    const { tier, grade, category } = determineRank(finalScore)
    
    // 6. 기존 랭크 조회
    const currentRank = await db.prepare(`
      SELECT * FROM artist_ranks WHERE artist_id = ?
    `).bind(artistId).first()
    
    // 7. 랭크 업데이트 또는 생성
    if (currentRank) {
      // 히스토리 기록
      if (currentRank.rank_tier !== tier || currentRank.rank_grade !== grade) {
        await db.prepare(`
          INSERT INTO artist_rank_history (
            artist_id, previous_rank_tier, previous_rank_grade, previous_score,
            new_rank_tier, new_rank_grade, new_score, change_reason
          ) VALUES (?, ?, ?, ?, ?, ?, ?, '자동 재계산')
        `).bind(
          artistId, currentRank.rank_tier, currentRank.rank_grade, currentRank.final_score,
          tier, grade, finalScore
        ).run()
      }
      
      // 랭크 업데이트
      await db.prepare(`
        UPDATE artist_ranks SET
          quantitative_exhibitions_score = ?,
          quantitative_awards_score = ?,
          quantitative_copyrights_score = ?,
          quantitative_curations_score = ?,
          quantitative_publications_score = ?,
          quantitative_total_score = ?,
          quantitative_weighted_score = ?,
          qualitative_total_score = ?,
          qualitative_weighted_score = ?,
          popularity_youtube_views = ?,
          popularity_youtube_score = ?,
          popularity_opensea_views = ?,
          popularity_opensea_score = ?,
          popularity_platform_views = ?,
          popularity_platform_score = ?,
          popularity_total_score = ?,
          popularity_weighted_score = ?,
          final_score = ?,
          rank_tier = ?,
          rank_grade = ?,
          rank_category = ?,
          last_calculated_at = datetime('now'),
          calculation_count = calculation_count + 1
        WHERE artist_id = ?
      `).bind(
        exhibitionsScore, awardsScore, copyrightsScore, curationsScore, publicationsScore,
        quantitativeTotal, quantitativeWeighted,
        qualitativeScore, qualitativeWeighted,
        youtubeViews, youtubeScore, openseaViews, openseaScore, platformViews, platformScore,
        popularityTotal, popularityWeighted,
        finalScore, tier, grade, category,
        artistId
      ).run()
    } else {
      // 새 랭크 생성
      await db.prepare(`
        INSERT INTO artist_ranks (
          artist_id,
          quantitative_exhibitions_score, quantitative_awards_score, quantitative_copyrights_score,
          quantitative_curations_score, quantitative_publications_score,
          quantitative_total_score, quantitative_weighted_score,
          qualitative_total_score, qualitative_weighted_score,
          popularity_youtube_views, popularity_youtube_score,
          popularity_opensea_views, popularity_opensea_score,
          popularity_platform_views, popularity_platform_score,
          popularity_total_score, popularity_weighted_score,
          final_score, rank_tier, rank_grade, rank_category,
          calculation_count
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 1)
      `).bind(
        artistId,
        exhibitionsScore, awardsScore, copyrightsScore, curationsScore, publicationsScore,
        quantitativeTotal, quantitativeWeighted,
        qualitativeScore, qualitativeWeighted,
        youtubeViews, youtubeScore, openseaViews, openseaScore, platformViews, platformScore,
        popularityTotal, popularityWeighted,
        finalScore, tier, grade, category
      ).run()
    }
    
    return { success: true, finalScore, tier, grade, category }
  } catch (error: any) {
    console.error('Rank calculation error:', error)
    throw error
  }
}

// 랭크 등급 결정 함수 (PDF 기준)
function determineRank(score: number): { tier: string, grade: string, category: string } {
  // 최우수 작가 (SS, S)
  if (score >= 3800) return { tier: 'SS', grade: 'S', category: 'master' }
  if (score >= 3500) return { tier: 'SS', grade: 'A', category: 'master' }
  if (score >= 3200) return { tier: 'SS', grade: 'B', category: 'master' }
  if (score >= 2900) return { tier: 'S', grade: 'S', category: 'master' }
  if (score >= 2600) return { tier: 'S', grade: 'A', category: 'master' }
  if (score >= 2300) return { tier: 'S', grade: 'B', category: 'master' }
  
  // 우수 작가 (A, B, C)
  if (score >= 2000) return { tier: 'A', grade: 'S', category: 'excellent' }
  if (score >= 1800) return { tier: 'A', grade: 'A', category: 'excellent' }
  if (score >= 1600) return { tier: 'A', grade: 'B', category: 'excellent' }
  if (score >= 1400) return { tier: 'B', grade: 'S', category: 'excellent' }
  if (score >= 1200) return { tier: 'B', grade: 'A', category: 'excellent' }
  if (score >= 1000) return { tier: 'B', grade: 'B', category: 'excellent' }
  if (score >= 900) return { tier: 'C', grade: 'S', category: 'excellent' }
  if (score >= 800) return { tier: 'C', grade: 'A', category: 'excellent' }
  if (score >= 700) return { tier: 'C', grade: 'B', category: 'excellent' }
  
  // 전문 작가 (D, E, F)
  if (score >= 600) return { tier: 'D', grade: 'S', category: 'professional' }
  if (score >= 550) return { tier: 'D', grade: 'A', category: 'professional' }
  if (score >= 500) return { tier: 'D', grade: 'B', category: 'professional' }
  if (score >= 450) return { tier: 'E', grade: 'S', category: 'professional' }
  if (score >= 400) return { tier: 'E', grade: 'A', category: 'professional' }
  if (score >= 350) return { tier: 'E', grade: 'B', category: 'professional' }
  if (score >= 300) return { tier: 'F', grade: 'S', category: 'professional' }
  if (score >= 250) return { tier: 'F', grade: 'A', category: 'professional' }
  if (score >= 200) return { tier: 'F', grade: 'B', category: 'professional' }
  
  // 신진 작가 (G)
  if (score >= 150) return { tier: 'G', grade: 'S', category: 'emerging' }
  if (score >= 100) return { tier: 'G', grade: 'A', category: 'emerging' }
  if (score >= 50) return { tier: 'G', grade: 'B', category: 'emerging' }
  
  return { tier: 'G', grade: 'B', category: 'emerging' }
}

function formatPrice(price: number): string {
  if (price >= 100000000) return (price / 100000000).toFixed(1) + '억원';
  else if (price >= 10000) return (price / 10000).toFixed(0) + '만원';
  return price.toLocaleString() + '원';
}

// ============================================
// 신규 페이지 라우트 (6개)
// ============================================

// 1. 지원 페이지
app.get('/support', (c) => {
  const content = `
    <section class="py-20">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <div class="inline-block mb-6 px-6 py-2 bg-gradient-to-r from-purple-600/20 to-cyan-600/20 backdrop-blur-sm rounded-full border border-purple-500/30">
                    <span class="text-gradient font-bold text-sm">💼 SUPPORT</span>
                </div>
                <h1 class="text-6xl font-black mb-6">
                    <span class="text-white">지원</span> <span class="text-gradient">센터</span>
                </h1>
                <p class="text-gray-400 text-xl">GALLERYPIA가 제공하는 다양한 지원 프로그램을 확인하세요</p>
            </div>

            <div class="grid gap-8">
                <!-- 아티스트 지원 -->
                <div class="card-nft rounded-3xl p-10">
                    <div class="flex items-center mb-6">
                        <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-palette text-white text-xl"></i>
                        </div>
                        <h2 class="text-3xl font-black text-white">아티스트 지원 프로그램</h2>
                    </div>
                    <ul class="space-y-4 text-gray-300">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                            <div>
                                <strong class="text-white">NFT 민팅 수수료 지원</strong>
                                <p class="text-sm text-gray-400 mt-1">신진 작가의 첫 NFT 민팅 수수료를 최대 50% 지원합니다</p>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                            <div>
                                <strong class="text-white">작품 가치산정 무료 지원</strong>
                                <p class="text-sm text-gray-400 mt-1">전문가 패널의 작품 평가를 무료로 받을 수 있습니다</p>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                            <div>
                                <strong class="text-white">마케팅 및 홍보 지원</strong>
                                <p class="text-sm text-gray-400 mt-1">플랫폼 메인 노출 및 SNS 홍보를 지원합니다</p>
                            </div>
                        </li>
                    </ul>
                </div>

                <!-- 컬렉터 지원 -->
                <div class="card-nft rounded-3xl p-10">
                    <div class="flex items-center mb-6">
                        <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-gem text-white text-xl"></i>
                        </div>
                        <h2 class="text-3xl font-black text-white">컬렉터 지원 프로그램</h2>
                    </div>
                    <ul class="space-y-4 text-gray-300">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                            <div>
                                <strong class="text-white">투자 가이드 제공</strong>
                                <p class="text-sm text-gray-400 mt-1">NFT 미술품 투자에 대한 전문적인 가이드를 제공합니다</p>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                            <div>
                                <strong class="text-white">VIP 프리뷰 초대</strong>
                                <p class="text-sm text-gray-400 mt-1">신작 NFT 공개 전 VIP 프리뷰에 초대됩니다</p>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                            <div>
                                <strong class="text-white">포트폴리오 관리 도구</strong>
                                <p class="text-sm text-gray-400 mt-1">보유 NFT의 가치 변동을 실시간으로 추적할 수 있습니다</p>
                            </div>
                        </li>
                    </ul>
                </div>

                <!-- 교육 지원 -->
                <div class="card-nft rounded-3xl p-10">
                    <div class="flex items-center mb-6">
                        <div class="w-14 h-14 bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-graduation-cap text-white text-xl"></i>
                        </div>
                        <h2 class="text-3xl font-black text-white">교육 프로그램</h2>
                    </div>
                    <ul class="space-y-4 text-gray-300">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                            <div>
                                <strong class="text-white">NFT 아카데미</strong>
                                <p class="text-sm text-gray-400 mt-1">블록체인과 NFT 기술에 대한 무료 온라인 강좌</p>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                            <div>
                                <strong class="text-white">전문가 워크샵</strong>
                                <p class="text-sm text-gray-400 mt-1">미술품 가치산정 및 NFT 마케팅 워크샵</p>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="mt-12 text-center">
                <a href="/contact" class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-purple-600 to-cyan-500 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-purple-500/50 transition-all">
                    <i class="fas fa-envelope mr-2"></i>
                    지원 문의하기
                </a>
            </div>
        </div>
    </section>
  `;
  return c.html(getLayout(content, '지원 센터 - GALLERYPIA'))
})

// 2. 도움말 페이지
app.get('/help', (c) => {
  const content = `
    <section class="py-20">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <div class="inline-block mb-6 px-6 py-2 bg-gradient-to-r from-blue-600/20 to-cyan-600/20 backdrop-blur-sm rounded-full border border-blue-500/30">
                    <span class="text-gradient font-bold text-sm">❓ HELP CENTER</span>
                </div>
                <h1 class="text-6xl font-black mb-6">
                    <span class="text-white">도움말</span> <span class="text-gradient">센터</span>
                </h1>
                <p class="text-gray-400 text-xl">자주 묻는 질문과 사용 가이드를 확인하세요</p>
            </div>

            <div class="space-y-6">
                <!-- FAQ 아코디언 스타일 -->
                <div class="card-nft rounded-2xl overflow-hidden">
                    <details class="group">
                        <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-white hover:bg-opacity-5 transition-all">
                            <div class="flex items-center">
                                <i class="fas fa-question-circle text-purple-400 mr-3 text-xl"></i>
                                <span class="font-bold text-lg text-white">GALLERYPIA는 어떤 서비스인가요?</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
                        </summary>
                        <div class="px-6 pb-6 text-gray-300 leading-relaxed">
                            GALLERYPIA는 전문가 패널의 정성평가와 데이터 기반의 정량평가를 결합한 객관적인 가치산정 시스템을 갖춘 NFT 미술품 플랫폼입니다. 
                            투명하고 신뢰할 수 있는 NFT 거래 환경을 제공합니다.
                        </div>
                    </details>
                </div>

                <div class="card-nft rounded-2xl overflow-hidden">
                    <details class="group">
                        <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-white hover:bg-opacity-5 transition-all">
                            <div class="flex items-center">
                                <i class="fas fa-wallet text-blue-400 mr-3 text-xl"></i>
                                <span class="font-bold text-lg text-white">지갑 연결은 어떻게 하나요?</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
                        </summary>
                        <div class="px-6 pb-6 text-gray-300 leading-relaxed">
                            메타마스크(MetaMask) 지갑이 필요합니다. 
                            1) 메타마스크 확장 프로그램을 설치하세요 (https://metamask.io)
                            2) 메인 페이지의 "지갑 연결" 버튼을 클릭하세요
                            3) 메타마스크 팝업에서 연결을 승인하세요
                        </div>
                    </details>
                </div>

                <div class="card-nft rounded-2xl overflow-hidden">
                    <details class="group">
                        <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-white hover:bg-opacity-5 transition-all">
                            <div class="flex items-center">
                                <i class="fas fa-paint-brush text-purple-400 mr-3 text-xl"></i>
                                <span class="font-bold text-lg text-white">NFT 민팅은 어떻게 하나요?</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
                        </summary>
                        <div class="px-6 pb-6 text-gray-300 leading-relaxed">
                            1) 회원가입 후 아티스트 계정으로 로그인하세요
                            2) "NFT 민팅" 메뉴에서 작품을 업로드하세요
                            3) 작품 정보와 메타데이터를 입력하세요
                            4) 전문가 평가를 받으세요 (가치산정)
                            5) 민팅 버튼을 클릭하여 NFT를 발행하세요
                        </div>
                    </details>
                </div>

                <div class="card-nft rounded-2xl overflow-hidden">
                    <details class="group">
                        <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-white hover:bg-opacity-5 transition-all">
                            <div class="flex items-center">
                                <i class="fas fa-chart-line text-green-400 mr-3 text-xl"></i>
                                <span class="font-bold text-lg text-white">가치산정 시스템은 어떻게 작동하나요?</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
                        </summary>
                        <div class="px-6 pb-6 text-gray-300 leading-relaxed">
                            우리의 가치산정 시스템은 3가지 요소로 구성됩니다:
                            <ul class="list-disc list-inside mt-3 space-y-2">
                                <li><strong>정량적 평가 (40%)</strong>: 시장 수요도, 희소성, 거래 이력 분석</li>
                                <li><strong>정성적 평가 (30%)</strong>: 예술적 완성도, 독창성, 전문가 평점</li>
                                <li><strong>인기도 평가 (30%)</strong>: 조회수, 좋아요, 소셜 미디어 반응</li>
                            </ul>
                        </div>
                    </details>
                </div>

                <div class="card-nft rounded-2xl overflow-hidden">
                    <details class="group">
                        <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-white hover:bg-opacity-5 transition-all">
                            <div class="flex items-center">
                                <i class="fas fa-shield-alt text-amber-400 mr-3 text-xl"></i>
                                <span class="font-bold text-lg text-white">거래는 안전한가요?</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
                        </summary>
                        <div class="px-6 pb-6 text-gray-300 leading-relaxed">
                            네, 모든 거래는 블록체인 스마트 컨트랙트를 통해 이루어지며, 변조가 불가능하고 투명하게 기록됩니다. 
                            또한 전문가 평가를 통한 가치산정으로 공정한 거래가 이루어집니다.
                        </div>
                    </details>
                </div>

                <div class="card-nft rounded-2xl overflow-hidden">
                    <details class="group">
                        <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-white hover:bg-opacity-5 transition-all">
                            <div class="flex items-center">
                                <i class="fas fa-trophy text-yellow-400 mr-3 text-xl"></i>
                                <span class="font-bold text-lg text-white">아티스트 랭킹 시스템은 무엇인가요?</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
                        </summary>
                        <div class="px-6 pb-6 text-gray-300 leading-relaxed">
                            전시회, 수상 경력, 저작권, 작품 활동 등을 종합하여 아티스트를 객관적으로 평가하는 시스템입니다. 
                            SS, S, A~G 등급으로 구분되며, 최우수 작가부터 신진 작가까지 4개 카테고리로 분류됩니다.
                        </div>
                    </details>
                </div>
            </div>

            <div class="mt-12 text-center">
                <p class="text-gray-400 mb-6">찾으시는 답변이 없나요?</p>
                <a href="/contact" class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-blue-600 to-cyan-500 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-blue-500/50 transition-all">
                    <i class="fas fa-envelope mr-2"></i>
                    문의하기
                </a>
            </div>
        </div>
    </section>
  `;
  return c.html(getLayout(content, '도움말 센터 - GALLERYPIA'))
})

// 3. 가치산정 시스템 상세 페이지
app.get('/valuation-system', (c) => {
  const content = `
    <section class="py-20">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <div class="inline-block mb-6 px-6 py-2 bg-gradient-to-r from-green-600/20 to-emerald-600/20 backdrop-blur-sm rounded-full border border-green-500/30">
                    <span class="text-gradient font-bold text-sm">📊 VALUATION SYSTEM</span>
                </div>
                <h1 class="text-6xl font-black mb-6">
                    <span class="text-white">가치산정</span> <span class="text-gradient">시스템</span>
                </h1>
                <p class="text-gray-400 text-xl max-w-3xl mx-auto">
                    3단계 평가 프로세스를 통한 객관적이고 투명한 NFT 미술품 가치 산정
                </p>
            </div>

            <!-- 평가 프로세스 -->
            <div class="grid md:grid-cols-3 gap-8 mb-16">
                <div class="card-nft rounded-3xl p-8 text-center">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center mx-auto mb-6">
                        <span class="text-white text-3xl font-black">1</span>
                    </div>
                    <h3 class="text-2xl font-black text-white mb-3">작품 제출</h3>
                    <p class="text-gray-400 text-sm leading-relaxed">
                        NFT 민팅 페이지에서 작품 이미지와 상세 정보를 업로드합니다
                    </p>
                </div>

                <div class="card-nft rounded-3xl p-8 text-center">
                    <div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-6">
                        <span class="text-white text-3xl font-black">2</span>
                    </div>
                    <h3 class="text-2xl font-black text-white mb-3">전문가 평가</h3>
                    <p class="text-gray-400 text-sm leading-relaxed">
                        검증된 전문가 패널이 정량/정성 평가를 진행합니다 (24-48시간 소요)
                    </p>
                </div>

                <div class="card-nft rounded-3xl p-8 text-center">
                    <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6">
                        <span class="text-white text-3xl font-black">3</span>
                    </div>
                    <h3 class="text-2xl font-black text-white mb-3">가치 확정</h3>
                    <p class="text-gray-400 text-sm leading-relaxed">
                        종합 평가 점수를 기반으로 최종 가치가 산정됩니다
                    </p>
                </div>
            </div>

            <!-- 평가 기준 상세 -->
            <div class="grid md:grid-cols-3 gap-8">
                <!-- 정량적 평가 -->
                <div class="card-nft rounded-3xl p-8">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-3">
                            <i class="fas fa-chart-bar text-white text-lg"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-black text-white">정량적 평가</h3>
                            <div class="text-blue-400 text-xs font-bold">40% 반영</div>
                        </div>
                    </div>
                    <ul class="space-y-3 text-sm text-gray-300">
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-blue-400 mr-2 mt-1"></i>
                            <span><strong>시장 수요도</strong>: NFT 마켓 트렌드, 거래량</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-blue-400 mr-2 mt-1"></i>
                            <span><strong>희소성</strong>: 에디션 수, 유사 작품 비교</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-blue-400 mr-2 mt-1"></i>
                            <span><strong>거래 이력</strong>: 과거 거래 내역, 가격 변동</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-blue-400 mr-2 mt-1"></i>
                            <span><strong>작가 경력</strong>: 전시, 수상, 저작권 활동</span>
                        </li>
                    </ul>
                </div>

                <!-- 정성적 평가 -->
                <div class="card-nft rounded-3xl p-8">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-3">
                            <i class="fas fa-star text-white text-lg"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-black text-white">정성적 평가</h3>
                            <div class="text-purple-400 text-xs font-bold">30% 반영</div>
                        </div>
                    </div>
                    <ul class="space-y-3 text-sm text-gray-300">
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-purple-400 mr-2 mt-1"></i>
                            <span><strong>예술적 완성도</strong>: 디자인 품질, 미적 완성도</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-purple-400 mr-2 mt-1"></i>
                            <span><strong>독창성</strong>: 고유한 스타일, 창의성</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-purple-400 mr-2 mt-1"></i>
                            <span><strong>기술적 완성도</strong>: 제작 기법, 기술력</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-purple-400 mr-2 mt-1"></i>
                            <span><strong>전문가 평점</strong>: 5인 이상 전문가 종합 평가</span>
                        </li>
                    </ul>
                </div>

                <!-- 인기도 평가 -->
                <div class="card-nft rounded-3xl p-8">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-500 rounded-xl flex items-center justify-center mr-3">
                            <i class="fas fa-fire text-white text-lg"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-black text-white">인기도 평가</h3>
                            <div class="text-green-400 text-xs font-bold">30% 반영</div>
                        </div>
                    </div>
                    <ul class="space-y-3 text-sm text-gray-300">
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-green-400 mr-2 mt-1"></i>
                            <span><strong>조회수</strong>: 플랫폼 내 작품 조회수</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-green-400 mr-2 mt-1"></i>
                            <span><strong>좋아요</strong>: 사용자 참여도 및 반응</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-green-400 mr-2 mt-1"></i>
                            <span><strong>소셜 미디어</strong>: SNS 공유 및 언급 횟수</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-green-400 mr-2 mt-1"></i>
                            <span><strong>커뮤니티 반응</strong>: 댓글, 토론 활발도</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- 가치산정 장점 -->
            <div class="mt-16 card-nft rounded-3xl p-10">
                <h2 class="text-3xl font-black text-white mb-8 text-center">
                    왜 우리의 <span class="text-gradient">가치산정 시스템</span>을 신뢰할 수 있나요?
                </h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="flex items-start">
                        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center mr-4 flex-shrink-0">
                            <i class="fas fa-shield-check text-white"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-white mb-2">검증된 전문가 패널</h4>
                            <p class="text-gray-400 text-sm">미술사, 큐레이터, NFT 전문가로 구성된 신뢰할 수 있는 평가단</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center mr-4 flex-shrink-0">
                            <i class="fas fa-database text-white"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-white mb-2">데이터 기반 분석</h4>
                            <p class="text-gray-400 text-sm">실시간 시장 데이터와 AI 알고리즘을 활용한 객관적 평가</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-500 rounded-lg flex items-center justify-center mr-4 flex-shrink-0">
                            <i class="fas fa-balance-scale text-white"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-white mb-2">투명한 프로세스</h4>
                            <p class="text-gray-400 text-sm">모든 평가 기준과 점수가 공개되어 투명성을 보장합니다</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-500 rounded-lg flex items-center justify-center mr-4 flex-shrink-0">
                            <i class="fas fa-sync text-white"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-white mb-2">지속적 업데이트</h4>
                            <p class="text-gray-400 text-sm">시장 변화에 따라 실시간으로 가치를 재평가합니다</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-12 text-center">
                <a href="/mint" class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-green-600 to-emerald-500 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-green-500/50 transition-all">
                    <i class="fas fa-paint-brush mr-2"></i>
                    작품 가치 평가 받기
                </a>
            </div>
        </div>
    </section>
  `;
  return c.html(getLayout(content, '가치산정 시스템 - GALLERYPIA'))
})

// 4. 문의하기 페이지
app.get('/contact', (c) => {
  const content = `
    <section class="py-20">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <div class="inline-block mb-6 px-6 py-2 bg-gradient-to-r from-cyan-600/20 to-blue-600/20 backdrop-blur-sm rounded-full border border-cyan-500/30">
                    <span class="text-gradient font-bold text-sm">📧 CONTACT US</span>
                </div>
                <h1 class="text-6xl font-black mb-6">
                    <span class="text-white">문의</span> <span class="text-gradient">하기</span>
                </h1>
                <p class="text-gray-400 text-xl">궁금하신 사항이 있으시면 언제든지 연락주세요</p>
            </div>

            <div class="grid md:grid-cols-2 gap-8 mb-12">
                <!-- 이메일 연락처 -->
                <div class="card-nft rounded-3xl p-8">
                    <div class="flex items-center mb-6">
                        <div class="w-14 h-14 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-envelope text-white text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-black text-white">이메일</h2>
                    </div>
                    <p class="text-gray-400 mb-4">일반 문의 및 제휴 문의</p>
                    <a href="mailto:gallerypia@gmail.com" class="text-gradient font-bold text-xl hover:opacity-80 transition-opacity">
                        gallerypia@gmail.com
                    </a>
                    <p class="text-gray-500 text-sm mt-4">평일 09:00 - 18:00 (주말/공휴일 제외)</p>
                </div>

                <!-- 소셜 미디어 -->
                <div class="card-nft rounded-3xl p-8">
                    <div class="flex items-center mb-6">
                        <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-share-alt text-white text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-black text-white">소셜 미디어</h2>
                    </div>
                    <p class="text-gray-400 mb-6">소셜 미디어로도 소통하세요</p>
                    <div class="flex space-x-4">
                        <a href="#" class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center hover:scale-110 transition-transform">
                            <i class="fab fa-twitter text-white text-lg"></i>
                        </a>
                        <a href="#" class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center hover:scale-110 transition-transform">
                            <i class="fab fa-discord text-white text-lg"></i>
                        </a>
                        <a href="#" class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-xl flex items-center justify-center hover:scale-110 transition-transform">
                            <i class="fab fa-telegram text-white text-lg"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- 문의 폼 -->
            <div class="card-nft rounded-3xl p-10">
                <h2 class="text-3xl font-black text-white mb-8 text-center">빠른 문의 양식</h2>
                <form class="space-y-6" onsubmit="handleContactSubmit(event)">
                    <div>
                        <label class="block text-sm font-bold text-gray-300 mb-2">이름 *</label>
                        <input type="text" name="name" required 
                               class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-300 mb-2">이메일 *</label>
                        <input type="email" name="email" required 
                               class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-300 mb-2">문의 유형</label>
                        <select name="type" 
                                class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-xl text-white focus:outline-none focus:border-purple-500 transition-colors">
                            <option value="general">일반 문의</option>
                            <option value="technical">기술 지원</option>
                            <option value="partnership">제휴 문의</option>
                            <option value="artist">아티스트 문의</option>
                            <option value="expert">전문가 신청</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-300 mb-2">제목 *</label>
                        <input type="text" name="subject" required 
                               class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-300 mb-2">문의 내용 *</label>
                        <textarea name="message" required rows="6"
                                  class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition-colors resize-none"></textarea>
                    </div>
                    <button type="submit" 
                            class="w-full px-8 py-4 bg-gradient-to-r from-cyan-600 to-blue-500 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-cyan-500/50 transition-all">
                        <i class="fas fa-paper-plane mr-2"></i>
                        문의 보내기
                    </button>
                </form>
            </div>

            <div class="mt-12 text-center">
                <p class="text-gray-400 text-sm">
                    * 문의하신 내용은 gallerypia@gmail.com으로 전송됩니다<br/>
                    영업일 기준 1-2일 내에 답변 드리겠습니다
                </p>
            </div>
        </div>
    </section>

    <script>
      function handleContactSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        
        const name = formData.get('name');
        const email = formData.get('email');
        const type = formData.get('type');
        const subject = formData.get('subject');
        const message = formData.get('message');
        
        // 이메일 클라이언트로 mailto 링크 생성
        const mailtoLink = \`mailto:gallerypia@gmail.com?subject=[\${type}] \${subject}&body=이름: \${name}%0D%0A이메일: \${email}%0D%0A%0D%0A\${message}\`;
        
        window.location.href = mailtoLink;
        
        alert('이메일 클라이언트가 열립니다. 이메일을 전송해주세요.');
      }
    </script>
  `;
  return c.html(getLayout(content, '문의하기 - GALLERYPIA'))
})

// 5. 개인정보보호 페이지
app.get('/privacy', (c) => {
  const content = `
    <section class="py-20">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <div class="inline-block mb-6 px-6 py-2 bg-gradient-to-r from-emerald-600/20 to-green-600/20 backdrop-blur-sm rounded-full border border-emerald-500/30">
                    <span class="text-gradient font-bold text-sm">🔒 PRIVACY POLICY</span>
                </div>
                <h1 class="text-6xl font-black mb-6">
                    <span class="text-white">개인정보</span> <span class="text-gradient">보호정책</span>
                </h1>
                <p class="text-gray-400 text-xl">GALLERYPIA 개인정보 처리방침</p>
                <p class="text-gray-500 text-sm mt-2">최종 업데이트: 2025년 1월 1일</p>
            </div>

            <div class="space-y-8">
                <div class="card-nft rounded-3xl p-8">
                    <h2 class="text-2xl font-black text-white mb-4 flex items-center">
                        <i class="fas fa-info-circle text-blue-400 mr-3"></i>
                        1. 개인정보 수집 항목
                    </h2>
                    <div class="text-gray-300 space-y-3">
                        <p><strong>필수 수집 항목:</strong></p>
                        <ul class="list-disc list-inside ml-4 space-y-2">
                            <li>이메일 주소, 사용자명, 비밀번호</li>
                            <li>이름, 연락처 (전문가/아티스트의 경우)</li>
                            <li>지갑 주소 (MetaMask 연동 시)</li>
                        </ul>
                        <p class="mt-4"><strong>선택 수집 항목:</strong></p>
                        <ul class="list-disc list-inside ml-4 space-y-2">
                            <li>프로필 사진, 자기소개</li>
                            <li>작품 포트폴리오 (아티스트)</li>
                            <li>전문 분야 및 경력 (전문가)</li>
                        </ul>
                    </div>
                </div>

                <div class="card-nft rounded-3xl p-8">
                    <h2 class="text-2xl font-black text-white mb-4 flex items-center">
                        <i class="fas fa-shield-alt text-green-400 mr-3"></i>
                        2. 개인정보 이용 목적
                    </h2>
                    <div class="text-gray-300 space-y-3">
                        <ul class="list-disc list-inside space-y-2">
                            <li>회원 가입 및 관리, 본인 확인</li>
                            <li>NFT 작품 등록 및 거래 서비스 제공</li>
                            <li>전문가 평가 및 가치산정 서비스</li>
                            <li>플랫폼 이용 통계 및 서비스 개선</li>
                            <li>공지사항 전달 및 고객 문의 응대</li>
                        </ul>
                    </div>
                </div>

                <div class="card-nft rounded-3xl p-8">
                    <h2 class="text-2xl font-black text-white mb-4 flex items-center">
                        <i class="fas fa-clock text-purple-400 mr-3"></i>
                        3. 개인정보 보유 기간
                    </h2>
                    <div class="text-gray-300 space-y-3">
                        <ul class="list-disc list-inside space-y-2">
                            <li><strong>회원 정보</strong>: 회원 탈퇴 시까지</li>
                            <li><strong>거래 내역</strong>: 관련 법령에 따라 5년 보관</li>
                            <li><strong>평가 데이터</strong>: 영구 보관 (블록체인 기록)</li>
                            <li><strong>방문 기록</strong>: 3개월</li>
                        </ul>
                    </div>
                </div>

                <div class="card-nft rounded-3xl p-8">
                    <h2 class="text-2xl font-black text-white mb-4 flex items-center">
                        <i class="fas fa-lock text-amber-400 mr-3"></i>
                        4. 개인정보 보호 조치
                    </h2>
                    <div class="text-gray-300 space-y-3">
                        <ul class="list-disc list-inside space-y-2">
                            <li>비밀번호는 암호화하여 저장 및 관리</li>
                            <li>해킹 등에 대비한 보안 시스템 운영</li>
                            <li>개인정보 취급 직원의 최소화 및 교육</li>
                            <li>블록체인 기반 거래 데이터 보호</li>
                            <li>정기적인 보안 감사 실시</li>
                        </ul>
                    </div>
                </div>

                <div class="card-nft rounded-3xl p-8">
                    <h2 class="text-2xl font-black text-white mb-4 flex items-center">
                        <i class="fas fa-user-check text-cyan-400 mr-3"></i>
                        5. 이용자의 권리
                    </h2>
                    <div class="text-gray-300 space-y-3">
                        <p>이용자는 다음의 권리를 행사할 수 있습니다:</p>
                        <ul class="list-disc list-inside space-y-2">
                            <li>개인정보 열람 요구</li>
                            <li>개인정보 정정 및 삭제 요구</li>
                            <li>개인정보 처리 정지 요구</li>
                            <li>동의 철회 (회원 탈퇴)</li>
                        </ul>
                        <p class="mt-4">권리 행사는 <a href="/contact" class="text-gradient font-bold hover:opacity-80">문의하기</a>를 통해 요청하실 수 있습니다.</p>
                    </div>
                </div>

                <div class="card-nft rounded-3xl p-8">
                    <h2 class="text-2xl font-black text-white mb-4 flex items-center">
                        <i class="fas fa-cookie-bite text-orange-400 mr-3"></i>
                        6. 쿠키 사용
                    </h2>
                    <div class="text-gray-300 space-y-3">
                        <p>GALLERYPIA는 다음의 목적으로 쿠키를 사용합니다:</p>
                        <ul class="list-disc list-inside space-y-2">
                            <li>로그인 세션 유지</li>
                            <li>사용자 맞춤 콘텐츠 제공</li>
                            <li>접속 빈도 및 방문 시간 분석</li>
                        </ul>
                        <p class="mt-4">브라우저 설정을 통해 쿠키 저장을 거부할 수 있으나, 일부 서비스 이용이 제한될 수 있습니다.</p>
                    </div>
                </div>

                <div class="card-nft rounded-3xl p-8 border-2 border-purple-500/30">
                    <h2 class="text-2xl font-black text-white mb-4 flex items-center">
                        <i class="fas fa-phone text-purple-400 mr-3"></i>
                        개인정보 보호 책임자
                    </h2>
                    <div class="text-gray-300">
                        <p><strong>담당자</strong>: Hyunwoo Nam Professor</p>
                        <p><strong>이메일</strong>: <a href="mailto:gallerypia@gmail.com" class="text-gradient font-bold">gallerypia@gmail.com</a></p>
                        <p class="mt-4 text-sm text-gray-400">
                            개인정보 보호와 관련하여 문의사항이 있으시면 위 연락처로 연락 주시기 바랍니다.
                        </p>
                    </div>
                </div>
            </div>

            <div class="mt-12 text-center">
                <p class="text-gray-500 text-sm">
                    본 개인정보 처리방침은 법령 및 정책 변경에 따라 변경될 수 있으며,<br/>
                    변경 시 웹사이트를 통해 공지하겠습니다.
                </p>
            </div>
        </div>
    </section>
  `;
  return c.html(getLayout(content, '개인정보보호정책 - GALLERYPIA'))
})

// 6. 사이트 이용하기 페이지
app.get('/usage-guide', (c) => {
  const content = `
    <section class="py-20">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <div class="inline-block mb-6 px-6 py-2 bg-gradient-to-r from-pink-600/20 to-purple-600/20 backdrop-blur-sm rounded-full border border-pink-500/30">
                    <span class="text-gradient font-bold text-sm">📖 USER GUIDE</span>
                </div>
                <h1 class="text-6xl font-black mb-6">
                    <span class="text-white">사이트</span> <span class="text-gradient">이용하기</span>
                </h1>
                <p class="text-gray-400 text-xl">GALLERYPIA를 처음 이용하시나요? 단계별 가이드를 확인하세요</p>
            </div>

            <!-- 사용자 유형별 가이드 -->
            <div class="grid md:grid-cols-3 gap-6 mb-16">
                <button onclick="showGuide('buyer')" id="guide-buyer-btn" class="guide-type-btn active">
                    <i class="fas fa-shopping-cart text-3xl mb-3"></i>
                    <h3 class="font-bold text-lg">구매자</h3>
                </button>
                <button onclick="showGuide('artist')" id="guide-artist-btn" class="guide-type-btn">
                    <i class="fas fa-palette text-3xl mb-3"></i>
                    <h3 class="font-bold text-lg">아티스트</h3>
                </button>
                <button onclick="showGuide('expert')" id="guide-expert-btn" class="guide-type-btn">
                    <i class="fas fa-user-tie text-3xl mb-3"></i>
                    <h3 class="font-bold text-lg">전문가</h3>
                </button>
            </div>

            <!-- 구매자 가이드 -->
            <div id="guide-buyer" class="guide-content">
                <div class="space-y-6">
                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">1</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">회원가입 및 지갑 연결</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>• <a href="/signup" class="text-gradient font-bold hover:opacity-80">회원가입</a> 페이지에서 계정을 생성하세요</li>
                                    <li>• MetaMask 지갑을 설치하고 연결하세요</li>
                                    <li>• 프로필 정보를 입력하고 관심 카테고리를 설정하세요</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">2</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">NFT 작품 탐색</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>• <a href="/gallery" class="text-gradient font-bold hover:opacity-80">갤러리</a>에서 다양한 NFT 작품을 둘러보세요</li>
                                    <li>• 카테고리, 가격대, 아티스트별로 필터링하세요</li>
                                    <li>• 작품 상세 페이지에서 가치산정 결과를 확인하세요</li>
                                    <li>• 관심 있는 작품은 좋아요로 저장하세요</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">3</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">NFT 구매하기</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>• 구매하고 싶은 작품의 "구매하기" 버튼을 클릭하세요</li>
                                    <li>• MetaMask 지갑에서 거래를 승인하세요</li>
                                    <li>• 블록체인에 기록되면 NFT가 지갑으로 전송됩니다</li>
                                    <li>• <a href="/mypage" class="text-gradient font-bold hover:opacity-80">마이페이지</a>에서 보유 NFT를 확인하세요</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 아티스트 가이드 -->
            <div id="guide-artist" class="guide-content" style="display: none;">
                <div class="space-y-6">
                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">1</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">아티스트 계정 생성</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>• <a href="/signup" class="text-gradient font-bold hover:opacity-80">회원가입</a> 시 "아티스트" 역할을 선택하세요</li>
                                    <li>• 프로필에 포트폴리오와 경력을 상세히 입력하세요</li>
                                    <li>• 아티스트 인증을 위해 필요한 서류를 제출하세요</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">2</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">작품 업로드 및 NFT 민팅</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>• <a href="/mint" class="text-gradient font-bold hover:opacity-80">NFT 민팅</a> 페이지로 이동하세요</li>
                                    <li>• 작품 이미지 (PNG, JPG, GIF, 최대 50MB)를 업로드하세요</li>
                                    <li>• 작품명, 설명, 카테고리, 에디션 수를 입력하세요</li>
                                    <li>• 가치산정을 신청하고 전문가 평가를 기다리세요</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">3</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">아티스트 랭킹 관리</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>• <a href="/mypage" class="text-gradient font-bold hover:opacity-80">마이페이지</a>에서 경력 정보를 입력하세요</li>
                                    <li>• 전시회, 수상, 저작권, 큐레이션 경력을 추가하세요</li>
                                    <li>• 경력 추가 시 증빙 자료를 첨부하세요</li>
                                    <li>• <a href="/leaderboard" class="text-gradient font-bold hover:opacity-80">랭킹</a> 페이지에서 나의 순위를 확인하세요</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">4</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">작품 판매 및 수익 관리</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>• 작품이 판매되면 자동으로 지갑에 수익이 입금됩니다</li>
                                    <li>• 2차 판매 시 로열티 (5-10%)를 받을 수 있습니다</li>
                                    <li>• 마이페이지에서 판매 내역을 확인하세요</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 전문가 가이드 -->
            <div id="guide-expert" class="guide-content" style="display: none;">
                <div class="space-y-6">
                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">1</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">전문가 신청</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>• <a href="/expert/apply" class="text-gradient font-bold hover:opacity-80">전문가 신청</a> 페이지에서 지원하세요</li>
                                    <li>• 전문 분야 (미술사, 큐레이터, NFT 전문가 등)를 선택하세요</li>
                                    <li>• 경력 및 자격증명을 제출하세요</li>
                                    <li>• 심사 후 승인되면 평가 패널에 합류할 수 있습니다</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">2</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">작품 평가하기</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>• 전문가 대시보드에서 평가 대기 중인 작품을 확인하세요</li>
                                    <li>• 8가지 평가 기준 (내용성, 표현성, 독창성 등)에 따라 점수를 부여하세요</li>
                                    <li>• 상세한 평가 코멘트를 작성하세요</li>
                                    <li>• 평가 완료 시 리워드를 받습니다</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">3</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">전문가 등급 관리</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>• 정확하고 공정한 평가를 통해 전문가 등급이 상승합니다</li>
                                    <li>• 높은 등급의 전문가는 더 많은 평가 기회를 받습니다</li>
                                    <li>• 평가 품질이 낮으면 등급이 하락할 수 있습니다</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 추가 도움말 -->
            <div class="mt-16 card-nft rounded-3xl p-10">
                <h2 class="text-3xl font-black text-white mb-6 text-center">
                    <i class="fas fa-lightbulb text-yellow-400 mr-3"></i>
                    유용한 팁
                </h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="flex items-start">
                        <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                        <div>
                            <h4 class="font-bold text-white mb-2">MetaMask 가스비</h4>
                            <p class="text-gray-400 text-sm">거래 시 가스비가 발생합니다. 네트워크 혼잡도에 따라 변동됩니다.</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                        <div>
                            <h4 class="font-bold text-white mb-2">작품 백업</h4>
                            <p class="text-gray-400 text-sm">원본 작품 파일은 항상 별도로 백업해두세요.</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                        <div>
                            <h4 class="font-bold text-white mb-2">저작권 주의</h4>
                            <p class="text-gray-400 text-sm">본인이 직접 창작한 작품만 NFT로 민팅하세요.</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                        <div>
                            <h4 class="font-bold text-white mb-2">투자 주의</h4>
                            <p class="text-gray-400 text-sm">NFT 가격은 변동될 수 있습니다. 신중하게 투자하세요.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-12 text-center">
                <p class="text-gray-400 mb-6">더 궁금한 사항이 있으신가요?</p>
                <div class="flex justify-center gap-4">
                    <a href="/help" class="px-8 py-4 bg-gradient-to-r from-purple-600 to-pink-500 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-purple-500/50 transition-all">
                        <i class="fas fa-question-circle mr-2"></i>
                        도움말 보기
                    </a>
                    <a href="/contact" class="px-8 py-4 bg-gradient-to-r from-cyan-600 to-blue-500 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-cyan-500/50 transition-all">
                        <i class="fas fa-envelope mr-2"></i>
                        문의하기
                    </a>
                </div>
            </div>
        </div>
    </section>

    <style>
      .guide-type-btn {
        padding: 2rem;
        background: linear-gradient(145deg, #1a1a1a 0%, #0a0a0a 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 1.5rem;
        color: #9ca3af;
        transition: all 0.3s ease;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      
      .guide-type-btn:hover {
        border-color: rgba(139, 92, 246, 0.5);
        transform: translateY(-4px);
        box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);
      }
      
      .guide-type-btn.active {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(6, 182, 212, 0.2) 100%);
        border-color: rgba(139, 92, 246, 0.5);
        color: white;
      }
    </style>

    <script>
      function showGuide(type) {
        // Hide all guides
        document.querySelectorAll('.guide-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.guide-type-btn').forEach(el => el.classList.remove('active'));
        
        // Show selected guide
        document.getElementById('guide-' + type).style.display = 'block';
        document.getElementById('guide-' + type + '-btn').classList.add('active');
      }
    </script>
  `;
  return c.html(getLayout(content, '사이트 이용하기 - GALLERYPIA'))
})

// 7. NFT 아카데미 페이지
app.get('/nft-academy', (c) => {
  const content = `
    <section class="py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <div class="inline-block mb-6 px-6 py-2 bg-gradient-to-r from-blue-600/20 to-purple-600/20 backdrop-blur-sm rounded-full border border-blue-500/30">
                    <span class="text-gradient font-bold text-sm">🎓 NFT ACADEMY</span>
                </div>
                <h1 class="text-6xl font-black mb-6">
                    <span class="text-white">NFT</span> <span class="text-gradient">아카데미</span>
                </h1>
                <p class="text-gray-400 text-xl">계정 유형별 맞춤 튜토리얼 가이드</p>
            </div>

            <!-- 계정 유형 선택 -->
            <div class="grid md:grid-cols-3 gap-6 mb-16">
                <button onclick="showGuide('buyer')" id="btn-buyer" class="role-btn active p-8 rounded-3xl border-2 border-purple-500/50 bg-gradient-to-br from-purple-900/40 to-pink-900/30 hover:border-purple-400 transition-all duration-300">
                    <div class="text-5xl mb-4">🛍️</div>
                    <h3 class="text-2xl font-black text-white mb-2">구매자</h3>
                    <p class="text-gray-400 text-sm">NFT 작품 구매 가이드</p>
                </button>
                
                <button onclick="showGuide('artist')" id="btn-artist" class="role-btn p-8 rounded-3xl border-2 border-blue-500/30 bg-gradient-to-br from-blue-900/20 to-cyan-900/20 hover:border-blue-400 transition-all duration-300">
                    <div class="text-5xl mb-4">🎨</div>
                    <h3 class="text-2xl font-black text-white mb-2">아티스트</h3>
                    <p class="text-gray-400 text-sm">NFT 작품 민팅 가이드</p>
                </button>
                
                <button onclick="showGuide('expert')" id="btn-expert" class="role-btn p-8 rounded-3xl border-2 border-amber-500/30 bg-gradient-to-br from-amber-900/20 to-orange-900/20 hover:border-amber-400 transition-all duration-300">
                    <div class="text-5xl mb-4">⭐</div>
                    <h3 class="text-2xl font-black text-white mb-2">평가 전문가</h3>
                    <p class="text-gray-400 text-sm">작품 평가 시스템 가이드</p>
                </button>
            </div>

            <!-- 구매자 가이드 -->
            <div id="guide-buyer" class="guide-content">
                <h2 class="text-4xl font-black text-white mb-8">🛍️ 구매자를 위한 NFT 작품 구매 가이드</h2>
                
                <div class="space-y-8">
                    <!-- 1. NFT 기초 -->
                    <div class="card-nft rounded-3xl p-10">
                        <h3 class="text-2xl font-black text-white mb-6 flex items-center">
                            <span class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center mr-4 text-lg">1</span>
                            NFT란 무엇인가요?
                        </h3>
                        <p class="text-gray-300 leading-relaxed mb-4">
                            NFT(Non-Fungible Token)는 블록체인 기반의 대체 불가능한 디지털 자산입니다. 
                            각 NFT는 고유한 식별자를 가지고 있어 복제가 불가능하며, 디지털 작품의 진정한 소유권을 증명합니다.
                        </p>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="p-6 bg-gradient-to-br from-purple-900/20 to-pink-900/20 rounded-xl border border-purple-500/20">
                                <h4 class="font-bold text-white mb-3">✅ NFT의 장점</h4>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• 진위 증명: 블록체인에 기록되어 위조 불가능</li>
                                    <li>• 소유권 증명: 내가 진짜 소유자임을 증명</li>
                                    <li>• 로열티 자동 지급: 재판매 시 아티스트에게 수익 분배</li>
                                    <li>• 투명한 거래 내역: 모든 거래가 공개적으로 기록</li>
                                </ul>
                            </div>
                            <div class="p-6 bg-gradient-to-br from-purple-900/20 to-pink-900/20 rounded-xl border border-purple-500/20">
                                <h4 class="font-bold text-white mb-3">⚠️ 주의사항</h4>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• 가격 변동성이 클 수 있습니다</li>
                                    <li>• 가스비(거래 수수료)가 발생합니다</li>
                                    <li>• 지갑 보안에 각별히 주의하세요</li>
                                    <li>• 신중한 작품 선택이 필요합니다</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 2. 지갑 설정 -->
                    <div class="card-nft rounded-3xl p-10">
                        <h3 class="text-2xl font-black text-white mb-6 flex items-center">
                            <span class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center mr-4 text-lg">2</span>
                            MetaMask 지갑 설정하기
                        </h3>
                        <div class="space-y-6">
                            <div class="p-6 bg-gradient-to-br from-blue-900/20 to-cyan-900/20 rounded-xl border border-blue-500/20">
                                <h4 class="font-bold text-white mb-4">설치 및 설정 방법</h4>
                                <ol class="space-y-4 text-gray-300 text-sm">
                                    <li class="flex items-start">
                                        <span class="font-bold text-cyan-400 mr-3 flex-shrink-0">1.</span>
                                        <div><strong class="text-white">MetaMask 설치:</strong> Chrome, Firefox, Edge 브라우저에서 <a href="https://metamask.io" target="_blank" class="text-cyan-400 hover:underline">metamask.io</a>에 접속하여 "Download" 클릭</div>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="font-bold text-cyan-400 mr-3 flex-shrink-0">2.</span>
                                        <div><strong class="text-white">지갑 생성:</strong> "Create a Wallet" 선택 → 강력한 비밀번호 설정 → 12단어 시드 구문 안전하게 보관</div>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="font-bold text-cyan-400 mr-3 flex-shrink-0">3.</span>
                                        <div><strong class="text-white">지갑 연결:</strong> GALLERYPIA 사이트에서 "지갑 연결" 버튼 클릭 → MetaMask 승인</div>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="font-bold text-cyan-400 mr-3 flex-shrink-0">4.</span>
                                        <div><strong class="text-white">암호화폐 입금:</strong> 거래소에서 ETH 구매 후 지갑 주소로 전송</div>
                                    </li>
                                </ol>
                            </div>
                            <div class="p-6 bg-red-900/20 rounded-xl border border-red-500/30">
                                <h4 class="font-bold text-red-400 mb-3">🔒 보안 필수 사항</h4>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• 시드 구문은 절대 타인과 공유하지 마세요 (MetaMask 직원도 요구하지 않습니다)</li>
                                    <li>• 피싱 사이트 주의 (URL 확인: https://gallerypia.pages.dev)</li>
                                    <li>• 공용 WiFi에서 거래하지 마세요</li>
                                    <li>• 큰 금액은 하드웨어 지갑 사용을 권장합니다</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 3. 작품 구매 -->
                    <div class="card-nft rounded-3xl p-10">
                        <h3 class="text-2xl font-black text-white mb-6 flex items-center">
                            <span class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-emerald-500 rounded-lg flex items-center justify-center mr-4 text-lg">3</span>
                            NFT 작품 구매 단계
                        </h3>
                        <div class="grid md:grid-cols-3 gap-6">
                            <div class="p-6 bg-gradient-to-br from-cyan-900/20 to-emerald-900/20 rounded-xl border border-cyan-500/20">
                                <div class="text-4xl font-black text-cyan-400 mb-4">Step 1</div>
                                <h4 class="font-bold text-white mb-3">작품 탐색 및 선택</h4>
                                <p class="text-gray-300 text-sm leading-relaxed mb-3">
                                    <a href="/gallery" class="text-cyan-400 hover:underline">NFT 갤러리</a>에서 마음에 드는 작품을 찾아보세요.
                                </p>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• 가치산정 점수 확인</li>
                                    <li>• 아티스트 랭킹 확인</li>
                                    <li>• 작품 설명 및 메타데이터 검토</li>
                                    <li>• 거래 이력 확인</li>
                                </ul>
                            </div>
                            <div class="p-6 bg-gradient-to-br from-cyan-900/20 to-emerald-900/20 rounded-xl border border-cyan-500/20">
                                <div class="text-4xl font-black text-cyan-400 mb-4">Step 2</div>
                                <h4 class="font-bold text-white mb-3">구매 결정</h4>
                                <p class="text-gray-300 text-sm leading-relaxed mb-3">
                                    작품 상세 페이지에서 "구매하기" 버튼 클릭
                                </p>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• 가격 재확인 (ETH 환율 체크)</li>
                                    <li>• 가스비 예상액 확인</li>
                                    <li>• MetaMask 팝업에서 거래 검토</li>
                                    <li>• 충분한 ETH 잔액 확인</li>
                                </ul>
                            </div>
                            <div class="p-6 bg-gradient-to-br from-cyan-900/20 to-emerald-900/20 rounded-xl border border-cyan-500/20">
                                <div class="text-4xl font-black text-cyan-400 mb-4">Step 3</div>
                                <h4 class="font-bold text-white mb-3">거래 완료 및 확인</h4>
                                <p class="text-gray-300 text-sm leading-relaxed mb-3">
                                    MetaMask에서 "확인" 버튼 클릭
                                </p>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• 블록체인에 거래 기록 (약 1-5분)</li>
                                    <li>• NFT가 지갑으로 전송됨</li>
                                    <li>• <a href="/mypage" class="text-cyan-400 hover:underline">마이페이지</a>에서 확인</li>
                                    <li>• 거래 영수증 저장</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 4. 추가 팁 -->
                    <div class="card-nft rounded-3xl p-10">
                        <h3 class="text-2xl font-black text-white mb-6">💡 구매자를 위한 추가 팁</h3>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="p-6 bg-gradient-to-br from-emerald-900/20 to-green-900/20 rounded-xl border border-emerald-500/20">
                                <h4 class="font-bold text-white mb-3">🎯 좋은 작품을 선택하는 방법</h4>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• 아티스트의 과거 작품 및 경력 확인</li>
                                    <li>• 가치산정 점수가 높은 작품 우선</li>
                                    <li>• 커뮤니티 리뷰 및 평가 참고</li>
                                    <li>• 로열티 비율 확인 (재판매 시 중요)</li>
                                    <li>• 에디션 수 확인 (희소성)</li>
                                </ul>
                            </div>
                            <div class="p-6 bg-gradient-to-br from-emerald-900/20 to-green-900/20 rounded-xl border border-emerald-500/20">
                                <h4 class="font-bold text-white mb-3">📊 투자 전략</h4>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• 분산 투자: 여러 작품에 나누어 투자</li>
                                    <li>• 장기 보유 vs 단기 거래 전략 수립</li>
                                    <li>• 시장 트렌드 파악 (<a href="/leaderboard" class="text-emerald-400 hover:underline">랭킹</a> 참고)</li>
                                    <li>• 손절 기준 미리 정하기</li>
                                    <li>• 감정적 투자 피하기</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 아티스트 가이드 -->
            <div id="guide-artist" class="guide-content hidden">
                <h2 class="text-4xl font-black text-white mb-8">🎨 아티스트를 위한 NFT 민팅 가이드</h2>
                
                <div class="space-y-8">
                    <!-- 1. 아티스트 등록 -->
                    <div class="card-nft rounded-3xl p-10">
                        <h3 class="text-2xl font-black text-white mb-6 flex items-center">
                            <span class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center mr-4 text-lg">1</span>
                            아티스트 계정 등록
                        </h3>
                        <p class="text-gray-300 leading-relaxed mb-6">
                            GALLERYPIA에서 NFT를 발행하려면 먼저 아티스트로 등록해야 합니다. 
                            전문적인 프로필과 경력 정보를 등록하면 랭킹 점수가 올라갑니다.
                        </p>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="p-6 bg-gradient-to-br from-blue-900/20 to-cyan-900/20 rounded-xl border border-blue-500/20">
                                <h4 class="font-bold text-white mb-4">필수 정보</h4>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• 아티스트명 (실명 또는 예명)</li>
                                    <li>• 프로필 이미지</li>
                                    <li>• 아티스트 소개 (경력, 작품 스타일)</li>
                                    <li>• 연락처 (이메일)</li>
                                    <li>• SNS 링크 (선택)</li>
                                </ul>
                            </div>
                            <div class="p-6 bg-gradient-to-br from-blue-900/20 to-cyan-900/20 rounded-xl border border-blue-500/20">
                                <h4 class="font-bold text-white mb-4">경력 등록</h4>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• 전시회 경력 (개인전, 단체전)</li>
                                    <li>• 수상 이력</li>
                                    <li>• 저작권 등록 증명서</li>
                                    <li>• 논문 및 저서</li>
                                    <li>• 전시 기획 경력</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 2. NFT 민팅 프로세스 -->
                    <div class="card-nft rounded-3xl p-10">
                        <h3 class="text-2xl font-black text-white mb-6 flex items-center">
                            <span class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center mr-4 text-lg">2</span>
                            NFT 민팅 단계별 가이드
                        </h3>
                        <div class="space-y-6">
                            <div class="flex items-start">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center mr-5 flex-shrink-0">
                                    <i class="fas fa-upload text-white text-lg"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-white text-lg mb-2">Step 1: 작품 파일 업로드</h4>
                                    <p class="text-gray-300 text-sm leading-relaxed mb-3">
                                        <a href="/mint" class="text-purple-400 hover:underline">NFT 민팅</a> 페이지에서 작품 이미지를 업로드합니다.
                                    </p>
                                    <ul class="text-gray-300 text-sm space-y-1">
                                        <li>• 지원 형식: PNG, JPG, GIF, WebP</li>
                                        <li>• 최대 파일 크기: 50MB</li>
                                        <li>• 권장 해상도: 최소 1000x1000px</li>
                                        <li>• 고품질 이미지 사용 권장</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center mr-5 flex-shrink-0">
                                    <i class="fas fa-edit text-white text-lg"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-white text-lg mb-2">Step 2: 메타데이터 입력</h4>
                                    <p class="text-gray-300 text-sm leading-relaxed mb-3">
                                        작품에 대한 상세 정보를 입력합니다.
                                    </p>
                                    <ul class="text-gray-300 text-sm space-y-1">
                                        <li>• <strong>작품명:</strong> 간결하고 매력적인 제목</li>
                                        <li>• <strong>설명:</strong> 작품의 의미, 제작 과정, 스토리</li>
                                        <li>• <strong>카테고리:</strong> 회화, 조각, 디지털아트 등</li>
                                        <li>• <strong>에디션 수:</strong> 1/1 (유니크) 또는 limited edition</li>
                                        <li>• <strong>로열티 비율:</strong> 재판매 시 수익 (일반적으로 5-10%)</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center mr-5 flex-shrink-0">
                                    <i class="fas fa-star text-white text-lg"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-white text-lg mb-2">Step 3: 가치산정 신청</h4>
                                    <p class="text-gray-300 text-sm leading-relaxed mb-3">
                                        전문가 패널에게 작품 평가를 신청합니다. 이는 작품의 신뢰도와 가치를 높입니다.
                                    </p>
                                    <ul class="text-gray-300 text-sm space-y-1">
                                        <li>• <strong>정량평가:</strong> 데이터 기반 객관적 평가 (자동)</li>
                                        <li>• <strong>정성평가:</strong> 전문가 패널의 주관적 평가 (3-5일 소요)</li>
                                        <li>• 평가 비용: 작품당 0.01 ETH (예시)</li>
                                        <li>• 평가 결과는 작품 페이지에 공개됩니다</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center mr-5 flex-shrink-0">
                                    <i class="fas fa-check text-white text-lg"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-white text-lg mb-2">Step 4: 민팅 완료</h4>
                                    <p class="text-gray-300 text-sm leading-relaxed mb-3">
                                        평가가 완료되면 "민팅" 버튼을 클릭하여 NFT를 블록체인에 기록합니다.
                                    </p>
                                    <ul class="text-gray-300 text-sm space-y-1">
                                        <li>• MetaMask에서 거래 승인</li>
                                        <li>• 가스비 지불 (네트워크 상황에 따라 변동)</li>
                                        <li>• 약 1-5분 후 NFT 발행 완료</li>
                                        <li>• 갤러리에 자동 등록됨</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. 랭킹 시스템 -->
                    <div class="card-nft rounded-3xl p-10">
                        <h3 class="text-2xl font-black text-white mb-6 flex items-center">
                            <span class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-500 rounded-lg flex items-center justify-center mr-4 text-lg">3</span>
                            아티스트 랭킹 올리기
                        </h3>
                        <p class="text-gray-300 leading-relaxed mb-6">
                            GALLERYPIA의 랭킹 시스템은 정량평가(40%), 정성평가(30%), 인기도(30%)로 구성됩니다.
                        </p>
                        <div class="grid md:grid-cols-3 gap-6">
                            <div class="p-6 bg-gradient-to-br from-amber-900/20 to-orange-900/20 rounded-xl border border-amber-500/20">
                                <h4 class="font-bold text-white mb-4">정량평가 (40%)</h4>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• 전시회 경력 (20-150점)</li>
                                    <li>• 수상 경력 (30-100점)</li>
                                    <li>• 저작권 등록 (30점)</li>
                                    <li>• 전시 기획 (50-150점)</li>
                                    <li>• 논문/저서 (10-30점)</li>
                                </ul>
                                <div class="mt-4 p-3 bg-amber-900/30 rounded-lg">
                                    <p class="text-xs text-gray-300">
                                        <strong class="text-white">TIP:</strong> <a href="/mypage" class="text-amber-400 hover:underline">마이페이지</a>에서 경력을 추가하세요!
                                    </p>
                                </div>
                            </div>
                            <div class="p-6 bg-gradient-to-br from-amber-900/20 to-orange-900/20 rounded-xl border border-amber-500/20">
                                <h4 class="font-bold text-white mb-4">정성평가 (30%)</h4>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• 내용성 (작품 주제의 깊이)</li>
                                    <li>• 표현성 (기술적 완성도)</li>
                                    <li>• 독창성 (참신함)</li>
                                    <li>• 소장가치 (장기적 가치)</li>
                                    <li>• 전문가 종합 평가</li>
                                </ul>
                                <div class="mt-4 p-3 bg-amber-900/30 rounded-lg">
                                    <p class="text-xs text-gray-300">
                                        <strong class="text-white">TIP:</strong> 작품마다 가치산정을 받으세요!
                                    </p>
                                </div>
                            </div>
                            <div class="p-6 bg-gradient-to-br from-amber-900/20 to-orange-900/20 rounded-xl border border-amber-500/20">
                                <h4 class="font-bold text-white mb-4">인기도 (30%)</h4>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• GALLERYPIA 조회수</li>
                                    <li>• YouTube 조회수</li>
                                    <li>• OpenSea 조회수</li>
                                    <li>• 소셜 미디어 참여도</li>
                                    <li>• 커뮤니티 반응</li>
                                </ul>
                                <div class="mt-4 p-3 bg-amber-900/30 rounded-lg">
                                    <p class="text-xs text-gray-300">
                                        <strong class="text-white">TIP:</strong> SNS로 작품을 홍보하세요!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. 아티스트 팁 -->
                    <div class="card-nft rounded-3xl p-10">
                        <h3 class="text-2xl font-black text-white mb-6">💡 성공적인 NFT 아티스트가 되는 팁</h3>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="p-6 bg-gradient-to-br from-blue-900/20 to-cyan-900/20 rounded-xl border border-blue-500/20">
                                <h4 class="font-bold text-white mb-3">🎯 작품 전략</h4>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• 일관된 스타일과 테마 유지</li>
                                    <li>• 고품질 이미지 사용 (최소 3000x3000px)</li>
                                    <li>• 작품 스토리텔링 강화</li>
                                    <li>• 시리즈 작품 발행 (컬렉션)</li>
                                    <li>• 정기적인 작품 업로드</li>
                                </ul>
                            </div>
                            <div class="p-6 bg-gradient-to-br from-blue-900/20 to-cyan-900/20 rounded-xl border border-blue-500/20">
                                <h4 class="font-bold text-white mb-3">📢 마케팅 전략</h4>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• SNS에 작품 홍보 (Twitter, Instagram)</li>
                                    <li>• 커뮤니티 참여 및 소통</li>
                                    <li>• 다른 아티스트와 협업</li>
                                    <li>• 이벤트 및 경연 대회 참가</li>
                                    <li>• 작품 제작 과정 공유</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 평가 전문가 가이드 -->
            <div id="guide-expert" class="guide-content hidden">
                <h2 class="text-4xl font-black text-white mb-8">⭐ 평가 전문가를 위한 가이드</h2>
                
                <div class="space-y-8">
                    <!-- 1. 전문가 자격 -->
                    <div class="card-nft rounded-3xl p-10">
                        <h3 class="text-2xl font-black text-white mb-6 flex items-center">
                            <span class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-500 rounded-lg flex items-center justify-center mr-4 text-lg">1</span>
                            평가 전문가 자격 요건
                        </h3>
                        <p class="text-gray-300 leading-relaxed mb-6">
                            GALLERYPIA의 평가 전문가가 되려면 미술 분야의 전문적인 경력과 지식이 필요합니다.
                        </p>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="p-6 bg-gradient-to-br from-amber-900/20 to-orange-900/20 rounded-xl border border-amber-500/20">
                                <h4 class="font-bold text-white mb-4">✅ 필수 자격</h4>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• 미술 관련 학위 (학사 이상)</li>
                                    <li>• 미술 분야 경력 5년 이상</li>
                                    <li>• 큐레이터, 미술 평론가, 갤러리 운영 경험</li>
                                    <li>• NFT 및 블록체인 기본 이해</li>
                                    <li>• 공정하고 객관적인 평가 능력</li>
                                </ul>
                            </div>
                            <div class="p-6 bg-gradient-to-br from-amber-900/20 to-orange-900/20 rounded-xl border border-amber-500/20">
                                <h4 class="font-bold text-white mb-4">📋 신청 서류</h4>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• 이력서 (CV)</li>
                                    <li>• 학위 증명서</li>
                                    <li>• 경력 증명 자료</li>
                                    <li>• 포트폴리오 (큐레이팅 경험 등)</li>
                                    <li>• 추천서 2부 (선택)</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-6 p-6 bg-blue-900/20 rounded-xl border border-blue-500/30">
                            <p class="text-gray-300 text-sm">
                                <strong class="text-white">신청 방법:</strong> 
                                <a href="/contact" class="text-blue-400 hover:underline ml-2">문의하기</a> 페이지에서 "평가 전문가 신청" 제목으로 이메일을 보내주세요. 
                                서류 검토 후 면접을 진행하며, 승인까지 약 2-4주 소요됩니다.
                            </p>
                        </div>
                    </div>

                    <!-- 2. 평가 시스템 -->
                    <div class="card-nft rounded-3xl p-10">
                        <h3 class="text-2xl font-black text-white mb-6 flex items-center">
                            <span class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center mr-4 text-lg">2</span>
                            작품 평가 시스템 이해하기
                        </h3>
                        <p class="text-gray-300 leading-relaxed mb-6">
                            GALLERYPIA의 가치산정 시스템은 정량평가와 정성평가를 결합한 하이브리드 모델입니다.
                        </p>
                        <div class="space-y-6">
                            <div class="p-6 bg-gradient-to-br from-blue-900/20 to-cyan-900/20 rounded-xl border border-blue-500/20">
                                <h4 class="font-bold text-white mb-4">📊 정량평가 (자동화, 40%)</h4>
                                <p class="text-gray-300 text-sm mb-4">
                                    데이터 기반의 객관적 평가로, 시스템이 자동으로 계산합니다. 전문가의 개입이 필요 없습니다.
                                </p>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• 아티스트 경력 점수 (전시회, 수상, 저작권)</li>
                                    <li>• 과거 작품 거래 실적</li>
                                    <li>• 시장 트렌드 분석</li>
                                    <li>• 희소성 (에디션 수)</li>
                                </ul>
                            </div>
                            
                            <div class="p-6 bg-gradient-to-br from-purple-900/20 to-pink-900/20 rounded-xl border border-purple-500/20">
                                <h4 class="font-bold text-white mb-4">🎨 정성평가 (전문가 평가, 60%)</h4>
                                <p class="text-gray-300 text-sm mb-4">
                                    전문가 패널이 직접 작품을 평가합니다. 다음 5가지 기준으로 각 10점 만점 (총 50점)으로 평가합니다.
                                </p>
                                <div class="space-y-4">
                                    <div>
                                        <h5 class="font-bold text-white mb-2">1. 내용성 (Content)</h5>
                                        <p class="text-gray-300 text-sm">
                                            작품의 주제, 메시지, 컨셉의 깊이와 의미를 평가합니다. 
                                            예술적 아이디어가 명확하고 감동적인가?
                                        </p>
                                    </div>
                                    <div>
                                        <h5 class="font-bold text-white mb-2">2. 표현성 (Expression)</h5>
                                        <p class="text-gray-300 text-sm">
                                            기술적 완성도, 표현 기법, 색채 사용, 구도 등을 평가합니다. 
                                            아티스트의 의도가 효과적으로 전달되는가?
                                        </p>
                                    </div>
                                    <div>
                                        <h5 class="font-bold text-white mb-2">3. 독창성 (Originality)</h5>
                                        <p class="text-gray-300 text-sm">
                                            참신함, 혁신성, 개성을 평가합니다. 
                                            기존 작품과 차별화되는 독특한 스타일이 있는가?
                                        </p>
                                    </div>
                                    <div>
                                        <h5 class="font-bold text-white mb-2">4. 소장가치 (Collectibility)</h5>
                                        <p class="text-gray-300 text-sm">
                                            장기적인 가치, 보존 가능성, 시장성을 평가합니다. 
                                            컬렉터가 소장하고 싶어 할 만한 작품인가?
                                        </p>
                                    </div>
                                    <div>
                                        <h5 class="font-bold text-white mb-2">5. 종합 평가 (Overall)</h5>
                                        <p class="text-gray-300 text-sm">
                                            위 4가지 기준을 종합하여 전문가의 직관적 평가를 포함합니다. 
                                            전체적인 완성도와 예술적 가치는 어떠한가?
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. 평가 프로세스 -->
                    <div class="card-nft rounded-3xl p-10">
                        <h3 class="text-2xl font-black text-white mb-6 flex items-center">
                            <span class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-emerald-500 rounded-lg flex items-center justify-center mr-4 text-lg">3</span>
                            평가 프로세스
                        </h3>
                        <div class="space-y-6">
                            <div class="flex items-start">
                                <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-emerald-500 rounded-lg flex items-center justify-center mr-5 flex-shrink-0 text-white font-black">
                                    1
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-white text-lg mb-2">작품 할당 받기</h4>
                                    <p class="text-gray-300 text-sm leading-relaxed">
                                        전문가 대시보드에 로그인하면 평가 대기 중인 작품 목록이 표시됩니다. 
                                        본인의 전문 분야(회화, 조각, 디지털아트 등)에 맞는 작품을 선택하여 평가를 시작합니다.
                                    </p>
                                </div>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-emerald-500 rounded-lg flex items-center justify-center mr-5 flex-shrink-0 text-white font-black">
                                    2
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-white text-lg mb-2">작품 검토</h4>
                                    <p class="text-gray-300 text-sm leading-relaxed mb-3">
                                        작품 이미지, 메타데이터, 아티스트 정보, 제작 배경 등을 꼼꼼히 검토합니다. 
                                        필요 시 아티스트에게 추가 정보를 요청할 수 있습니다.
                                    </p>
                                    <ul class="text-gray-300 text-sm space-y-1">
                                        <li>• 권장 검토 시간: 작품당 20-30분</li>
                                        <li>• 고해상도 이미지로 세부 사항 확인</li>
                                        <li>• 아티스트의 과거 작품도 참고</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-emerald-500 rounded-lg flex items-center justify-center mr-5 flex-shrink-0 text-white font-black">
                                    3
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-white text-lg mb-2">평가 점수 입력</h4>
                                    <p class="text-gray-300 text-sm leading-relaxed mb-3">
                                        5가지 기준(내용성, 표현성, 독창성, 소장가치, 종합평가)에 대해 각각 1-10점을 부여합니다. 
                                        객관적이고 공정한 평가를 위해 일관된 기준을 유지하세요.
                                    </p>
                                    <div class="p-4 bg-cyan-900/30 rounded-lg">
                                        <p class="text-gray-300 text-sm">
                                            <strong class="text-white">평가 가이드라인:</strong><br/>
                                            • 1-3점: 기준 미달<br/>
                                            • 4-6점: 평균 수준<br/>
                                            • 7-8점: 우수<br/>
                                            • 9-10점: 매우 뛰어남 (신중하게 부여)
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-emerald-500 rounded-lg flex items-center justify-center mr-5 flex-shrink-0 text-white font-black">
                                    4
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-white text-lg mb-2">평가 의견 작성</h4>
                                    <p class="text-gray-300 text-sm leading-relaxed mb-3">
                                        점수와 함께 200-500자 정도의 평가 의견을 작성합니다. 
                                        장점, 개선점, 시장 전망 등을 포함하여 건설적인 피드백을 제공하세요.
                                    </p>
                                    <ul class="text-gray-300 text-sm space-y-1">
                                        <li>• 구체적이고 명확한 표현 사용</li>
                                        <li>• 긍정적이고 존중하는 톤 유지</li>
                                        <li>• 개인적 취향보다 객관적 기준 우선</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-emerald-500 rounded-lg flex items-center justify-center mr-5 flex-shrink-0 text-white font-black">
                                    5
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-white text-lg mb-2">평가 제출</h4>
                                    <p class="text-gray-300 text-sm leading-relaxed">
                                        모든 평가를 완료하면 "제출" 버튼을 클릭합니다. 
                                        제출 후에는 수정이 불가능하므로 신중하게 검토한 후 제출하세요. 
                                        3명의 전문가 평가가 모두 완료되면 최종 점수가 산출됩니다.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. 전문가 윤리 강령 -->
                    <div class="card-nft rounded-3xl p-10">
                        <h3 class="text-2xl font-black text-white mb-6">📜 평가 전문가 윤리 강령</h3>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="p-6 bg-gradient-to-br from-red-900/20 to-pink-900/20 rounded-xl border border-red-500/30">
                                <h4 class="font-bold text-red-400 mb-4">⚠️ 금지 사항</h4>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• 아티스트와 사전 접촉 또는 금전 거래</li>
                                    <li>• 평가 결과 사전 유출</li>
                                    <li>• 편파적이거나 부당한 평가</li>
                                    <li>• 개인적 친분에 의한 평가</li>
                                    <li>• 다른 전문가의 평가에 영향</li>
                                </ul>
                            </div>
                            <div class="p-6 bg-gradient-to-br from-green-900/20 to-emerald-900/20 rounded-xl border border-green-500/30">
                                <h4 class="font-bold text-green-400 mb-4">✅ 준수 사항</h4>
                                <ul class="text-gray-300 text-sm space-y-2">
                                    <li>• 공정하고 객관적인 평가</li>
                                    <li>• 전문성과 독립성 유지</li>
                                    <li>• 평가 정보의 기밀 유지</li>
                                    <li>• 이해 상충 시 회피</li>
                                    <li>• 정기적인 교육 참여</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-6 p-6 bg-amber-900/20 rounded-xl border border-amber-500/30">
                            <p class="text-gray-300 text-sm">
                                <strong class="text-white">보상:</strong> 
                                평가 1건당 0.005 ETH의 보상이 지급됩니다 (예시). 
                                평가 품질과 신뢰도에 따라 보너스 보상이 제공될 수 있습니다. 
                                윤리 강령 위반 시 전문가 자격이 박탈될 수 있습니다.
                            </p>
                        </div>
                    </div>

                    <!-- 5. 추가 리소스 -->
                    <div class="card-nft rounded-3xl p-10">
                        <h3 class="text-2xl font-black text-white mb-6">📚 추가 학습 리소스</h3>
                        <div class="grid md:grid-cols-3 gap-6">
                            <a href="/valuation-system" class="p-6 bg-gradient-to-br from-blue-900/20 to-cyan-900/20 rounded-xl border border-blue-500/20 hover:border-blue-400/50 transition-all group">
                                <i class="fas fa-chart-line text-blue-400 text-3xl mb-4 group-hover:scale-110 transition-transform"></i>
                                <h4 class="font-bold text-white mb-2">가치산정 시스템</h4>
                                <p class="text-gray-400 text-sm">전체 평가 시스템 상세 설명</p>
                            </a>
                            <a href="/help" class="p-6 bg-gradient-to-br from-purple-900/20 to-pink-900/20 rounded-xl border border-purple-500/20 hover:border-purple-400/50 transition-all group">
                                <i class="fas fa-question-circle text-purple-400 text-3xl mb-4 group-hover:scale-110 transition-transform"></i>
                                <h4 class="font-bold text-white mb-2">도움말</h4>
                                <p class="text-gray-400 text-sm">자주 묻는 질문과 답변</p>
                            </a>
                            <a href="/contact" class="p-6 bg-gradient-to-br from-green-900/20 to-emerald-900/20 rounded-xl border border-green-500/20 hover:border-green-400/50 transition-all group">
                                <i class="fas fa-envelope text-green-400 text-3xl mb-4 group-hover:scale-110 transition-transform"></i>
                                <h4 class="font-bold text-white mb-2">문의하기</h4>
                                <p class="text-gray-400 text-sm">평가 전문가 신청 및 문의</p>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
      function showGuide(type) {
        // Hide all guides
        document.querySelectorAll('.guide-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.role-btn').forEach(el => el.classList.remove('active'));
        
        // Show selected guide
        document.getElementById('guide-' + type).classList.remove('hidden');
        document.getElementById('btn-' + type).classList.add('active');
      }
    </script>

    <style>
      .role-btn.active {
        border-width: 3px;
        transform: scale(1.05);
      }
      .guide-content {
        animation: fadeIn 0.5s ease-in;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
  `;
  return c.html(getLayout(content, 'NFT 아카데미 - GALLERYPIA'))
})

export default app
