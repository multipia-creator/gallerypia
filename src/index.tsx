import { Hono } from 'hono'
import { cors } from 'hono/cors'
import { getCookie } from 'hono/cookie'
import { serveStatic } from 'hono/cloudflare-workers'
import type { Bindings, Artwork, ArtworkWithArtist, Artist, ApiResponse } from './types'
import { calculateArtworkValue } from './types'
import { initSentry, sentryErrorHandler } from './middleware/sentry'
import { rateLimiters } from './middleware/rate-limiter'
import { securityHeaders, corsConfig } from './middleware/security-headers'
import { requireRole } from './middleware/auth'
import admin from './routes/admin'
import notifications from './routes/notifications'
import analytics from './routes/analytics'
import recommendations from './routes/recommendations'
import seo from './routes/seo'
import bcrypt from 'bcryptjs'

const app = new Hono<{ Bindings: Bindings }>()

// Sentry ì´ˆê¸°í™” (í™˜ê²½ë³€ìˆ˜ì—ì„œ DSN ì½ê¸°)
if (typeof process !== 'undefined' && process.env?.SENTRY_DSN) {
  initSentry(
    process.env.SENTRY_DSN,
    process.env.NODE_ENV || 'development'
  )
}

// Security headers middleware (OWASP best practices)
app.use('*', securityHeaders)

// Sentry ì—ëŸ¬ í•¸ë“¤ëŸ¬ ë¯¸ë“¤ì›¨ì–´ ì ìš©
app.use('*', sentryErrorHandler)

// Rate limiting for authentication endpoints (strict)
app.use('/api/auth/check-email', rateLimiters.api) // Moderate rate limit for email checks
app.use('/api/auth/signup', rateLimiters.signup)
app.use('/api/auth/login', rateLimiters.auth)
app.use('/api/auth/metamask-login', rateLimiters.auth)
app.use('/api/auth/google-login', rateLimiters.auth)
app.use('/api/auth/kakao-login', rateLimiters.auth)
app.use('/api/auth/naver-login', rateLimiters.auth)
app.use('/api/auth/apple-login', rateLimiters.auth)
app.use('/api/auth/facebook-login', rateLimiters.auth)
app.use('/api/auth/forgot-password', rateLimiters.auth)
app.use('/api/auth/reset-password', rateLimiters.auth)

// Rate limiting for data modification endpoints (POST/PUT/DELETE)
app.use('/api/artworks', async (c, next) => {
  if (c.req.method === 'POST' || c.req.method === 'PUT' || c.req.method === 'DELETE') {
    return rateLimiters.mutation(c, next)
  }
  await next()
})
app.use('/api/artists', async (c, next) => {
  if (c.req.method === 'POST' || c.req.method === 'PUT' || c.req.method === 'DELETE') {
    return rateLimiters.mutation(c, next)
  }
  await next()
})
app.use('/api/exhibitions', async (c, next) => {
  if (c.req.method === 'POST' || c.req.method === 'PUT' || c.req.method === 'DELETE') {
    return rateLimiters.mutation(c, next)
  }
  await next()
})

// General API rate limiting (moderate)
app.use('/api/*', rateLimiters.api)

// Enhanced CORS configuration
app.use('/api/*', cors(corsConfig()))

// âœ… CRITICAL: Admin API authentication middleware
// All /api/admin/* routes require admin or super_admin role (session-based)
// Exception: /api/admin/login and /api/admin/logout are public
app.use('/api/admin/*', async (c, next) => {
  const path = c.req.path
  
  // Allow login and logout without authentication
  if (path === '/api/admin/login' || path === '/api/admin/logout') {
    return next()
  }
  
  // Session-based authentication for admin routes
  const token = c.req.header('Authorization')?.replace('Bearer ', '') || getCookie(c, 'auth_token')
  
  if (!token) {
    return c.json({ error: 'Unauthorized', message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  // Verify session using verifySession function (defined later in this file)
  // Note: This creates a forward reference that will be resolved at runtime
  const verifySessionFn = async (db: any, sessionToken: string) => {
    const session = await db.prepare(`
      SELECT s.*, u.role 
      FROM admin_sessions s
      JOIN admin_users u ON s.user_id = u.id
      WHERE s.session_token = ? AND s.expires_at > datetime('now') AND s.is_active = 1
    `).bind(sessionToken).first()
    
    return session || null
  }
  
  const session = await verifySessionFn(c.env.DB, token)
  
  if (!session) {
    return c.json({ error: 'Unauthorized', message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
  }
  
  const allowedRoles = ['admin', 'super_admin']
  if (!session.role || !allowedRoles.includes(session.role)) {
    return c.json({ error: 'Forbidden', message: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' }, 403)
  }
  
  // Store session for later use in route handlers
  c.set('adminSession', session)
  
  return next()
})

// ì •ì  íŒŒì¼ ì„œë¹™
app.use('/static/*', serveStatic({ root: './public' }))

// HTML íŒŒì¼ ì„œë¹™ (academy.html ë“±)
app.use('/*.html', serveStatic({ root: './' }))

// HTML í˜ì´ì§€ ë¼ìš°íŠ¸ (Cloudflare Pages í˜¸í™˜)
app.get('/login.html', (c) => {
  return c.redirect('/login')
})

app.get('/signup.html', (c) => {
  return c.redirect('/signup')
})

app.get('/mint-nft.html', (c) => {
  return c.redirect('/mint')
})

app.get('/artist-dashboard.html', (c) => {
  return c.redirect('/artist-dashboard')
})

// ============================================
// ê³µí†µ ë ˆì´ì•„ì›ƒ í•¨ìˆ˜ - ë¸”ë™ í…Œë§ˆ
// ============================================

function getLayout(content: string, title: string = 'ê°¤ëŸ¬ë¦¬í”¼ì•„ - NFT Art Museum') {
  return `
<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ê°¤ëŸ¬ë¦¬í”¼ì•„ - í•™ìˆ  ë…¼ë¬¸ ê¸°ë°˜ ê³¼í•™ì  NFT ë¯¸ìˆ í’ˆ ê°€ì¹˜ì‚°ì • ì‹œìŠ¤í…œ. 5ê°œ ëª¨ë“ˆ í†µí•© í‰ê°€ë¡œ íˆ¬ëª…í•˜ê³  ê³µì •í•œ NFT ê±°ë˜ë¥¼ ì‹¤í˜„í•©ë‹ˆë‹¤.">
    <meta name="keywords" content="NFT, ë¯¸ìˆ í’ˆ, ê°€ì¹˜ì‚°ì •, ë¸”ë¡ì²´ì¸, ë””ì§€í„¸ì•„íŠ¸, NFTê°¤ëŸ¬ë¦¬, ì•„í‹°ìŠ¤íŠ¸ë­í‚¹, íë ˆì´ì…˜">
    <meta name="author" content="ì„œê²½ëŒ€í•™êµ ë‚¨í˜„ìš° êµìˆ˜">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#8b5cf6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ê°¤ëŸ¬ë¦¬í”¼ì•„">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="/manifest.json">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512x512.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192x192.png">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="${title}">
    <meta property="og:description" content="í•™ìˆ  ë…¼ë¬¸ ê¸°ë°˜ ê³¼í•™ì  NFT ë¯¸ìˆ í’ˆ ê°€ì¹˜ì‚°ì • í”Œë«í¼">
    <meta property="og:image" content="/static/logo.png">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="${title}">
    <meta property="twitter:description" content="í•™ìˆ  ë…¼ë¬¸ ê¸°ë°˜ ê³¼í•™ì  NFT ë¯¸ìˆ í’ˆ ê°€ì¹˜ì‚°ì • í”Œë«í¼">
    
    <title>${title}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- 3D/AR/VR Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Outfit', 'system-ui', 'sans-serif'],
            },
            colors: {
              primary: {
                50: '#f0f9ff',
                500: '#0ea5e9',
                600: '#0284c7',
                700: '#0369a1',
              },
              accent: {
                500: '#8b5cf6',
                600: '#7c3aed',
              }
            }
          }
        }
      }
    </script>
    <style>
      * {
        font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
      }
      
      body {
        background: #000000;
        color: #ffffff;
      }
      
      .gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      
      .gradient-gold {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      }
      
      .gradient-cyber {
        background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
      }
      
      .neon-border {
        border: 1px solid rgba(139, 92, 246, 0.3);
        box-shadow: 0 0 20px rgba(139, 92, 246, 0.1);
      }
      
      .neon-glow {
        box-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
      }
      
      .card-nft {
        background: linear-gradient(145deg, #1a1a1a 0%, #0a0a0a 100%);
        border: 1px solid rgba(255, 255, 255, 0.05);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .card-nft:hover {
        transform: translateY(-12px);
        border-color: rgba(139, 92, 246, 0.5);
        box-shadow: 0 25px 50px rgba(139, 92, 246, 0.2);
      }
      
      .img-nft {
        transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .card-nft:hover .img-nft {
        transform: scale(1.08);
      }
      
      .nav-link {
        position: relative;
        transition: color 0.3s ease;
      }
      
      .nav-link::after {
        content: '';
        position: absolute;
        bottom: -4px;
        left: 0;
        width: 0;
        height: 2px;
        background: linear-gradient(90deg, #8b5cf6, #06b6d4);
        transition: width 0.3s ease;
      }
      
      .nav-link:hover::after,
      .nav-link.active::after {
        width: 100%;
      }
      
      .btn-neon {
        background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
        box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
        transition: all 0.3s ease;
      }
      
      .btn-neon:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 30px rgba(139, 92, 246, 0.6);
      }
      
      .stat-card {
        background: linear-gradient(145deg, #1a1a1a 0%, #0f0f0f 100%);
        border: 1px solid rgba(139, 92, 246, 0.2);
        backdrop-filter: blur(10px);
      }
      
      .hero-gradient {
        background: radial-gradient(ellipse at top, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                    radial-gradient(ellipse at bottom, rgba(6, 182, 212, 0.15) 0%, transparent 50%);
      }
      
      @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-20px); }
      }
      
      .float {
        animation: float 6s ease-in-out infinite;
      }
      
      @keyframes glow {
        0%, 100% { opacity: 0.5; }
        50% { opacity: 1; }
      }
      
      .glow-pulse {
        animation: glow 2s ease-in-out infinite;
      }
      
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      
      @keyframes slide-in {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      @keyframes slide-out {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
      
      .animate-slide-in {
        animation: slide-in 0.3s ease-out;
      }
      
      .animate-pulse-slow {
        animation: pulse 3s ease-in-out infinite;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
      }
      
      /* Skeleton Loading Animations */
      @keyframes skeleton-shimmer {
        0% {
          background-position: -1000px 0;
        }
        100% {
          background-position: 1000px 0;
        }
      }
      
      .skeleton {
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.05) 0%,
          rgba(255, 255, 255, 0.1) 50%,
          rgba(255, 255, 255, 0.05) 100%
        );
        background-size: 1000px 100%;
        animation: skeleton-shimmer 2s infinite linear;
        border-radius: 0.5rem;
      }
      
      .skeleton-text {
        height: 1rem;
        margin-bottom: 0.5rem;
      }
      
      .skeleton-title {
        height: 2rem;
        width: 60%;
        margin-bottom: 1rem;
      }
      
      .skeleton-card {
        height: 300px;
        border-radius: 1rem;
      }
      
      .skeleton-circle {
        border-radius: 50%;
      }
      
      /* Toast Animation */
      @keyframes toast-slide-up {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      
      .animate-slide-up {
        animation: toast-slide-up 0.3s ease-out;
        transition: opacity 0.3s, transform 0.3s;
      }
      
      .text-gradient {
        background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .text-gold {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .bg-grid {
        background-image: 
          linear-gradient(rgba(139, 92, 246, 0.05) 1px, transparent 1px),
          linear-gradient(90deg, rgba(139, 92, 246, 0.05) 1px, transparent 1px);
        background-size: 50px 50px;
      }
      
      .category-badge {
        transition: all 0.3s ease;
        border: 1px solid rgba(139, 92, 246, 0.3);
      }
      
      .category-badge:hover,
      .category-badge.active {
        background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
        border-color: transparent;
        transform: scale(1.05);
      }
      
      .score-bar {
        background: linear-gradient(90deg, #8b5cf6, #06b6d4);
        box-shadow: 0 2px 10px rgba(139, 92, 246, 0.3);
      }
      
      /* ============================================
         í‚¤ë³´ë“œ ì ‘ê·¼ì„± (Keyboard Accessibility)
         ============================================ */
      
      /* Focus indicators - ëª¨ë“  ì¸í„°ë™í‹°ë¸Œ ìš”ì†Œì— ëª…í™•í•œ í¬ì»¤ìŠ¤ í‘œì‹œ */
      a:focus,
      button:focus,
      input:focus,
      textarea:focus,
      select:focus,
      [tabindex]:focus {
        outline: 2px solid #8b5cf6;
        outline-offset: 2px;
        border-radius: 0.25rem;
      }
      
      /* ì¹´ë“œ ë° í´ë¦­ ê°€ëŠ¥í•œ ìš”ì†Œì— ëŒ€í•œ í¬ì»¤ìŠ¤ ìŠ¤íƒ€ì¼ */
      .card-nft:focus,
      .category-badge:focus {
        outline: 3px solid #8b5cf6;
        outline-offset: 3px;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
      }
      
      /* ë²„íŠ¼ í¬ì»¤ìŠ¤ ìŠ¤íƒ€ì¼ ê°•í™” */
      .btn-neon:focus {
        outline: 3px solid #06b6d4;
        outline-offset: 3px;
        box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.3);
      }
      
      /* Skip to content link - í‚¤ë³´ë“œ ì‚¬ìš©ìë¥¼ ìœ„í•œ ë°”ë¡œê°€ê¸° */
      .skip-to-content {
        position: fixed;
        top: -100px;
        left: 50%;
        transform: translateX(-50%);
        background: #8b5cf6;
        color: white;
        padding: 1rem 2rem;
        border-radius: 0.5rem;
        z-index: 9999;
        font-weight: 600;
        transition: top 0.3s ease;
        box-shadow: 0 10px 30px rgba(139, 92, 246, 0.5);
      }
      
      .skip-to-content:focus {
        top: 1rem;
        outline: 3px solid white;
        outline-offset: 2px;
      }
      
      /* í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ íŒíŠ¸ í‘œì‹œ */
      .keyboard-hint {
        display: inline-block;
        background: rgba(139, 92, 246, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.3);
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
        color: #a78bfa;
      }
      
      /* ëª¨ë‹¬ ë° ë“œë¡­ë‹¤ìš´ í¬ì»¤ìŠ¤ íŠ¸ë© í‘œì‹œ */
      [role="dialog"]:focus-within,
      [role="menu"]:focus-within {
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3);
      }
      
      /* ë¹„í™œì„±í™”ëœ ìš”ì†Œ ëª…í™•íˆ í‘œì‹œ */
      button:disabled,
      input:disabled,
      select:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        outline: none;
      }
      
      /* íˆ´íŒ í¬ì»¤ìŠ¤ ì‹œ í‘œì‹œ */
      [data-tooltip]:focus::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #1f2937;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        white-space: nowrap;
        z-index: 100;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      }
      
      /* ============================================
         ì˜¨ë³´ë”© íŠœí† ë¦¬ì–¼ (Onboarding Tutorial)
         ============================================ */
      
      /* íŠœí† ë¦¬ì–¼ ì˜¤ë²„ë ˆì´ */
      .tutorial-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(4px);
        z-index: 9998;
        animation: fadeIn 0.3s ease-out;
      }
      
      /* í•˜ì´ë¼ì´íŠ¸ëœ ìš”ì†Œ ê°•ì¡° */
      .tutorial-highlight {
        position: relative;
        z-index: 9999;
        box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.5),
                    0 0 0 8px rgba(139, 92, 246, 0.3),
                    0 0 60px rgba(139, 92, 246, 0.4);
        border-radius: 0.5rem;
        animation: pulse-highlight 2s ease-in-out infinite;
      }
      
      @keyframes pulse-highlight {
        0%, 100% {
          box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.5),
                      0 0 0 8px rgba(139, 92, 246, 0.3),
                      0 0 60px rgba(139, 92, 246, 0.4);
        }
        50% {
          box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.7),
                      0 0 0 8px rgba(139, 92, 246, 0.5),
                      0 0 80px rgba(139, 92, 246, 0.6);
        }
      }
      
      /* íŠœí† ë¦¬ì–¼ íˆ´íŒ */
      .tutorial-tooltip {
        position: fixed;
        background: linear-gradient(145deg, #1f1f1f 0%, #0a0a0a 100%);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 1rem;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        max-width: 400px;
        z-index: 10000;
        animation: slideInUp 0.4s ease-out;
      }
      
      @keyframes slideInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      /* íŠœí† ë¦¬ì–¼ í™”ì‚´í‘œ */
      .tutorial-arrow {
        position: absolute;
        width: 0;
        height: 0;
        border-style: solid;
      }
      
      .tutorial-arrow.top {
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        border-width: 0 10px 10px 10px;
        border-color: transparent transparent rgba(139, 92, 246, 0.3) transparent;
      }
      
      .tutorial-arrow.bottom {
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border-width: 10px 10px 0 10px;
        border-color: rgba(139, 92, 246, 0.3) transparent transparent transparent;
      }
      
      /* ì§„í–‰ë¥  ì¸ë””ì¼€ì´í„° */
      .tutorial-progress {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }
      
      .tutorial-progress-dot {
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
      }
      
      .tutorial-progress-dot.active {
        background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
        transform: scale(1.3);
      }
      
      /* íŠœí† ë¦¬ì–¼ ë²„íŠ¼ */
      .tutorial-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      
      .tutorial-btn-primary {
        background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
        color: white;
        border: none;
      }
      
      .tutorial-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
      }
      
      .tutorial-btn-secondary {
        background: transparent;
        color: #9ca3af;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .tutorial-btn-secondary:hover {
        color: white;
        border-color: rgba(255, 255, 255, 0.3);
      }
      
      /* ì›°ì»´ ëª¨ë‹¬ */
      .tutorial-welcome {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        padding: 1rem;
      }
      
      .tutorial-welcome-content {
        background: linear-gradient(145deg, #1f1f1f 0%, #0a0a0a 100%);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 2rem;
        padding: 3rem;
        max-width: 600px;
        text-align: center;
        box-shadow: 0 20px 80px rgba(0, 0, 0, 0.6);
        animation: scaleIn 0.5s ease-out;
      }
      
      @keyframes scaleIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
    </style>
</head>
<body class="antialiased bg-black text-white">
    <!-- Skip to content link (í‚¤ë³´ë“œ ì ‘ê·¼ì„±) -->
    <a href="#main-content" class="skip-to-content">ë©”ì¸ ì½˜í…ì¸ ë¡œ ë°”ë¡œê°€ê¸°</a>
    
    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="fixed top-0 w-full z-50 bg-black bg-opacity-80 backdrop-blur-xl border-b border-white border-opacity-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center space-x-12">
                    <a href="/" class="flex items-center space-x-3 group">
                        <img src="/static/logo.png" alt="GALLERYPIA Logo" class="w-12 h-12 rounded-xl group-hover:scale-110 transition-transform duration-300 group-hover:rotate-6" />
                        <div>
                            <div class="text-xs text-gray-400 font-semibold tracking-wider uppercase">NFT Art Museum</div>
                            <div class="text-xl font-black text-gradient">GALLERYPIA</div>
                        </div>
                    </a>
                    <div class="hidden md:flex items-center space-x-1">
                        <a href="/gallery" class="nav-link px-4 py-2 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all duration-300 font-medium text-sm">ê°¤ëŸ¬ë¦¬</a>
                        <a href="/recommendations" class="nav-link px-4 py-2 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all duration-300 font-medium text-sm">ì¶”ì²œ</a>
                        <a href="/leaderboard" class="nav-link px-4 py-2 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all duration-300 font-medium text-sm">ì•„í‹°ìŠ¤íŠ¸</a>
                        <a href="/valuation-system" class="nav-link px-4 py-2 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all duration-300 font-medium text-sm">ê°€ì¹˜ì‚°ì •</a>
                        <a href="/curation" class="nav-link px-4 py-2 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all duration-300 font-medium text-sm">íë ˆì´ì…˜</a>
                        <a href="/nft-academy" class="nav-link px-4 py-2 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all duration-300 font-medium text-sm">ì•„ì¹´ë°ë¯¸</a>
                        <a href="/about" class="nav-link px-4 py-2 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all duration-300 font-medium text-sm">ì†Œê°œ</a>
                    </div>
                </div>
                <div id="authNav" class="flex items-center space-x-3">
                    <!-- ê²€ìƒ‰ ë²„íŠ¼ -->
                    <a href="/search" class="hidden sm:flex items-center px-3 py-2 text-gray-400 hover:text-white rounded-xl hover:bg-white hover:bg-opacity-5 transition-all">
                        <i class="fas fa-search"></i>
                    </a>
                    
                    <!-- ì–¸ì–´ ì„ íƒ ë²„íŠ¼ (i18n) -->
                    <div class="relative" id="languageSwitcher">
                        <button onclick="toggleLanguageMenu()" class="hidden sm:flex items-center px-3 py-2 text-gray-400 hover:text-white rounded-xl hover:bg-white hover:bg-opacity-5 transition-all">
                            <i class="fas fa-globe mr-2"></i>
                            <span id="currentLanguageFlag" class="text-lg">ğŸ‡°ğŸ‡·</span>
                        </button>
                        
                        <!-- ì–¸ì–´ ë“œë¡­ë‹¤ìš´ -->
                        <div id="languageMenu" class="hidden absolute right-0 mt-2 w-56 bg-gray-900 rounded-2xl shadow-2xl border border-white border-opacity-10 overflow-hidden z-50">
                            <div class="p-4 border-b border-white border-opacity-10">
                                <h3 class="text-sm font-bold text-white mb-1">ì–¸ì–´ ì„ íƒ</h3>
                                <p class="text-xs text-gray-400">Select Language</p>
                            </div>
                            <div class="p-2 space-y-1" id="languageList">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    

                    
                    <!-- ì•Œë¦¼ ì•„ì´ì½˜ (ë¡œê·¸ì¸ ì‹œì—ë§Œ í‘œì‹œ) -->
                    <div id="notificationBell" class="relative" style="display: none;">
                        <button onclick="toggleNotifications()" class="flex items-center px-3 py-2 text-gray-400 hover:text-white rounded-xl hover:bg-white hover:bg-opacity-5 transition-all relative">
                            <i class="fas fa-bell"></i>
                            <span id="notificationCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold" style="display: none;">0</span>
                        </button>
                        
                        <!-- ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ -->
                        <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-96 bg-gray-900 rounded-2xl shadow-2xl border border-white border-opacity-10 overflow-hidden z-50 max-h-96 overflow-y-auto">
                            <div class="p-4 border-b border-white border-opacity-10 flex justify-between items-center">
                                <h3 class="text-lg font-bold text-white">ì•Œë¦¼</h3>
                                <button onclick="markAllNotificationsRead()" class="text-xs text-purple-400 hover:text-purple-300 transition">
                                    ëª¨ë‘ ì½ìŒ í‘œì‹œ
                                </button>
                            </div>
                            
                            <!-- ë¡œë”© ìƒíƒœ -->
                            <div id="notificationsLoading" class="p-8 text-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mx-auto mb-2"></div>
                                <p class="text-sm text-gray-400">ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                            </div>
                            
                            <!-- ì•Œë¦¼ ëª©ë¡ -->
                            <div id="notificationsList" class="hidden divide-y divide-white divide-opacity-5"></div>
                            
                            <!-- ë¹ˆ ìƒíƒœ -->
                            <div id="notificationsEmpty" class="hidden p-8 text-center text-gray-400">
                                <i class="fas fa-bell-slash text-4xl mb-3 opacity-50"></i>
                                <p>ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
                            </div>
                            
                            <div class="p-3 border-t border-white border-opacity-10 text-center">
                                <a href="/notifications" class="text-sm text-purple-400 hover:text-purple-300 font-semibold">
                                    ëª¨ë“  ì•Œë¦¼ ë³´ê¸° â†’
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Analytics ë§í¬ (admin/expertë§Œ) -->
                    <a href="/analytics-dashboard" id="analyticsLink" class="hidden items-center px-3 py-2 text-gray-400 hover:text-white rounded-xl hover:bg-white hover:bg-opacity-5 transition-all">
                        <i class="fas fa-chart-line"></i>
                    </a>
                    
                    <!-- Admin Panel ë§í¬ (adminë§Œ) -->
                    <a href="/admin-dashboard" id="adminLink" class="hidden items-center px-3 py-2 text-gray-400 hover:text-white rounded-xl hover:bg-white hover:bg-opacity-5 transition-all">
                        <i class="fas fa-cog"></i>
                    </a>
                    
                    <!-- ì‚¬ìš©ì ë“œë¡­ë‹¤ìš´ (ë¡œê·¸ì¸ ì‹œì—ë§Œ í‘œì‹œ) -->
                    <div id="userDropdown" class="relative" style="display: none;">
                        <button id="userMenuButton" class="flex items-center space-x-2 px-3 py-2 text-gray-400 hover:text-white rounded-xl hover:bg-white hover:bg-opacity-5 transition-all">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-cyan-500 flex items-center justify-center text-white font-bold text-sm">
                                <span id="userInitial">U</span>
                            </div>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="userMenu" class="absolute right-0 mt-2 w-56 bg-gray-900 rounded-xl shadow-lg border border-white border-opacity-10 overflow-hidden hidden">
                            <div class="px-4 py-3 border-b border-white border-opacity-10">
                                <p class="text-sm font-semibold text-white" id="userName">ì‚¬ìš©ì</p>
                                <p class="text-xs text-gray-400" id="userEmail">user@example.com</p>
                            </div>
                            <div class="py-2">
                                <a href="/dashboard" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-white hover:bg-opacity-5 hover:text-white transition-all">
                                    <i class="fas fa-tachometer-alt w-5"></i>
                                    <span class="ml-3">ëŒ€ì‹œë³´ë“œ</span>
                                </a>
                                <a href="/profile" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-white hover:bg-opacity-5 hover:text-white transition-all">
                                    <i class="fas fa-user w-5"></i>
                                    <span class="ml-3">í”„ë¡œí•„</span>
                                </a>
                                <a href="/settings" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-white hover:bg-opacity-5 hover:text-white transition-all">
                                    <i class="fas fa-cog w-5"></i>
                                    <span class="ml-3">ì„¤ì •</span>
                                </a>
                                <button onclick="restartTutorial()" class="flex items-center w-full px-4 py-2 text-sm text-gray-300 hover:bg-white hover:bg-opacity-5 hover:text-white transition-all">
                                    <i class="fas fa-graduation-cap w-5"></i>
                                    <span class="ml-3">íŠœí† ë¦¬ì–¼ ë‹¤ì‹œë³´ê¸°</span>
                                </button>
                            </div>
                            <div class="border-t border-white border-opacity-10 py-2">
                                <button id="logoutBtn" class="flex items-center w-full px-4 py-2 text-sm text-red-400 hover:bg-red-500 hover:bg-opacity-10 hover:text-red-300 transition-all">
                                    <i class="fas fa-sign-out-alt w-5"></i>
                                    <span class="ml-3">ë¡œê·¸ì•„ì›ƒ</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ë¹„ë¡œê·¸ì¸ ì‹œì—ë§Œ í‘œì‹œ -->
                    <a href="/signup" id="signupBtn" class="signup-btn flex items-center px-4 py-2 text-gray-400 hover:text-white rounded-xl hover:bg-white hover:bg-opacity-5 transition-all">
                        <i class="fas fa-user-plus mr-2"></i>
                        <span class="text-sm font-medium">íšŒì›ê°€ì…</span>
                    </a>
                    <a href="/login" id="loginBtn" class="login-btn flex items-center px-4 py-2 text-gray-400 hover:text-white rounded-xl hover:bg-white hover:bg-opacity-5 transition-all">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        <span class="text-sm font-medium">ë¡œê·¸ì¸</span>
                    </a>
                    
                    <!-- ì§€ê°‘ì—°ê²° ë²„íŠ¼ -->
                    <button onclick="connectWallet()" id="walletBtn" class="wallet-btn hidden items-center px-4 py-2 bg-gradient-to-r from-orange-500 to-pink-500 hover:from-orange-600 hover:to-pink-600 text-white rounded-xl transition-all duration-300 font-medium text-sm shadow-lg hover:shadow-xl">
                        <i class="fas fa-wallet mr-2"></i>
                        <span class="text-sm font-medium">ì§€ê°‘ì—°ê²°</span>
                    </button>
                    
                    <!-- ëª¨ë°”ì¼ í–„ë²„ê±° ë©”ë‰´ ë²„íŠ¼ -->
                    <button id="mobileMenuButton" class="md:hidden flex items-center px-3 py-2 text-gray-400 hover:text-white rounded-xl hover:bg-white hover:bg-opacity-5 transition-all">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ëª¨ë°”ì¼ ë©”ë‰´ (Slide-in from right) -->
        <div id="mobileMenu" class="fixed inset-y-0 right-0 w-80 bg-black bg-opacity-95 backdrop-blur-xl border-l border-white border-opacity-10 transform translate-x-full transition-transform duration-300 ease-in-out z-50 md:hidden overflow-y-auto">
            <div class="p-6">
                <!-- ë‹«ê¸° ë²„íŠ¼ -->
                <div class="flex justify-between items-center mb-8">
                    <div class="text-xl font-bold text-gradient">GALLERYPIA</div>
                    <button id="closeMobileMenu" class="p-2 text-gray-400 hover:text-white rounded-xl hover:bg-white hover:bg-opacity-5 transition-all">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- ì‚¬ìš©ì ì •ë³´ (ë¡œê·¸ì¸ ì‹œ) -->
                <div id="mobileUserInfo" class="hidden mb-6 p-4 bg-gradient-to-r from-purple-900/20 to-cyan-900/20 rounded-xl border border-purple-500/20">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-r from-purple-500 to-cyan-500 flex items-center justify-center text-white font-bold">
                            <span id="mobileUserInitial">U</span>
                        </div>
                        <div>
                            <p class="text-white font-semibold" id="mobileUserName">ì‚¬ìš©ì</p>
                            <p class="text-xs text-gray-400" id="mobileUserEmail">user@example.com</p>
                        </div>
                    </div>
                </div>
                
                <!-- ë„¤ë¹„ê²Œì´ì…˜ ë§í¬ -->
                <nav class="space-y-2">
                    <a href="/gallery" class="block px-4 py-3 text-gray-300 hover:text-white hover:bg-white hover:bg-opacity-5 rounded-xl transition-all">
                        <i class="fas fa-images w-6 mr-3"></i>ê°¤ëŸ¬ë¦¬
                    </a>
                    <a href="/leaderboard" class="block px-4 py-3 text-gray-300 hover:text-white hover:bg-white hover:bg-opacity-5 rounded-xl transition-all">
                        <i class="fas fa-trophy w-6 mr-3"></i>ì•„í‹°ìŠ¤íŠ¸
                    </a>
                    <a href="/valuation-system" class="block px-4 py-3 text-gray-300 hover:text-white hover:bg-white hover:bg-opacity-5 rounded-xl transition-all">
                        <i class="fas fa-balance-scale w-6 mr-3"></i>ê°€ì¹˜ì‚°ì •
                    </a>

                    <a href="/curation" class="block px-4 py-3 text-gray-300 hover:text-white hover:bg-white hover:bg-opacity-5 rounded-xl transition-all">
                        <i class="fas fa-users w-6 mr-3"></i>íë ˆì´ì…˜
                    </a>
                    <a href="/nft-academy" class="block px-4 py-3 text-gray-300 hover:text-white hover:bg-white hover:bg-opacity-5 rounded-xl transition-all">
                        <i class="fas fa-graduation-cap w-6 mr-3"></i>ì•„ì¹´ë°ë¯¸
                    </a>
                    <a href="/about" class="block px-4 py-3 text-gray-300 hover:text-white hover:bg-white hover:bg-opacity-5 rounded-xl transition-all">
                        <i class="fas fa-info-circle w-6 mr-3"></i>ì†Œê°œ
                    </a>
                    <button onclick="restartTutorial(); closeMobileMenuFunc();" class="w-full text-left px-4 py-3 text-gray-300 hover:text-white hover:bg-white hover:bg-opacity-5 rounded-xl transition-all">
                        <i class="fas fa-question-circle w-6 mr-3"></i>ë„ì›€ë§
                    </button>
                    
                    <div class="border-t border-white border-opacity-10 my-4"></div>
                    
                    <!-- ë¡œê·¸ì¸ ì‹œ ë©”ë‰´ -->
                    <div id="mobileAuthMenu" class="hidden space-y-2">
                        <a href="/dashboard" class="block px-4 py-3 text-gray-300 hover:text-white hover:bg-white hover:bg-opacity-5 rounded-xl transition-all">
                            <i class="fas fa-tachometer-alt w-6 mr-3"></i>ëŒ€ì‹œë³´ë“œ
                        </a>
                        <a href="/profile" class="block px-4 py-3 text-gray-300 hover:text-white hover:bg-white hover:bg-opacity-5 rounded-xl transition-all">
                            <i class="fas fa-user w-6 mr-3"></i>í”„ë¡œí•„
                        </a>
                        <a href="/favorites" class="block px-4 py-3 text-gray-300 hover:text-white hover:bg-white hover:bg-opacity-5 rounded-xl transition-all">
                            <i class="fas fa-heart w-6 mr-3 text-red-500"></i>ê´€ì‹¬ì‘í’ˆ
                        </a>
                        <a href="/transactions" class="block px-4 py-3 text-gray-300 hover:text-white hover:bg-white hover:bg-opacity-5 rounded-xl transition-all">
                            <i class="fas fa-exchange-alt w-6 mr-3"></i>ê±°ë˜ ë‚´ì—­
                        </a>
                        <a href="/settings" class="block px-4 py-3 text-gray-300 hover:text-white hover:bg-white hover:bg-opacity-5 rounded-xl transition-all">
                            <i class="fas fa-cog w-6 mr-3"></i>ì„¤ì •
                        </a>
                        <button onclick="restartTutorial(); closeMobileMenuFunc();" class="w-full text-left px-4 py-3 text-gray-300 hover:text-white hover:bg-white hover:bg-opacity-5 rounded-xl transition-all">
                            <i class="fas fa-graduation-cap w-6 mr-3"></i>íŠœí† ë¦¬ì–¼ ë‹¤ì‹œë³´ê¸°
                        </button>
                        <button id="mobileLogoutBtn" class="w-full text-left px-4 py-3 text-red-400 hover:text-red-300 hover:bg-red-500 hover:bg-opacity-10 rounded-xl transition-all">
                            <i class="fas fa-sign-out-alt w-6 mr-3"></i>ë¡œê·¸ì•„ì›ƒ
                        </button>
                    </div>
                    
                    <!-- ë¹„ë¡œê·¸ì¸ ì‹œ ë©”ë‰´ -->
                    <div id="mobileGuestMenu" class="space-y-2">
                        <a href="/login" class="block px-4 py-3 bg-gradient-to-r from-purple-600 to-cyan-600 text-white text-center rounded-xl font-semibold hover:from-purple-700 hover:to-cyan-700 transition-all">
                            <i class="fas fa-sign-in-alt mr-2"></i>ë¡œê·¸ì¸
                        </a>
                        <a href="/signup" class="block px-4 py-3 bg-white bg-opacity-5 text-white text-center rounded-xl font-semibold hover:bg-opacity-10 transition-all">
                            <i class="fas fa-user-plus mr-2"></i>íšŒì›ê°€ì…
                        </a>
                    </div>
                </nav>
            </div>
        </div>
        
        <!-- ëª¨ë°”ì¼ ë©”ë‰´ ì˜¤ë²„ë ˆì´ -->
        <div id="mobileMenuOverlay" class="fixed inset-0 bg-black bg-opacity-50 opacity-0 pointer-events-none transition-opacity duration-300 z-40 md:hidden"></div>
    </nav>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="pt-20">
        ${content}
    </div>

    <!-- í‘¸í„° -->
    <footer class="border-t border-white border-opacity-10 py-16 mt-32">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid md:grid-cols-4 gap-12">
                <div class="col-span-2">
                    <div class="flex items-center space-x-3 mb-6">
                        <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-cyan-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-cube text-white text-lg"></i>
                        </div>
                        <div>
                            <div class="text-xl font-bold text-gradient">GALLERYPIA</div>
                            <div class="text-xs text-gray-500">NFT Art Museum</div>
                        </div>
                    </div>
                    <p class="text-gray-400 mb-4 leading-relaxed text-sm">
                        ë¯¸ìˆ í’ˆ ê°€ì¹˜ì‚°ì • ê¸°ë°˜ì˜ íˆ¬ëª…í•˜ê³  ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” NFT í”Œë«í¼
                    </p>
                    <div class="mb-6 p-4 bg-gradient-to-r from-purple-900/20 to-cyan-900/20 rounded-xl border border-purple-500/20">
                        <p class="text-gray-300 text-sm leading-relaxed">
                            <i class="fas fa-envelope text-purple-400 mr-2"></i>
                            <strong class="text-white">ê¸°ìˆ ì´ì „ ë¬¸ì˜:</strong><br/>
                            <span class="ml-6">ì„œê²½ëŒ€í•™êµ ë‚¨í˜„ìš° êµìˆ˜</span><br/>
                            <a href="mailto:gallerypia@gmail.com" class="ml-6 text-cyan-400 hover:text-cyan-300 transition-colors">gallerypia@gmail.com</a>
                        </p>
                    </div>
                </div>
                <div>
                    <h4 class="font-bold mb-4 text-white">NFT í”Œë«í¼</h4>
                    <ul class="space-y-3 text-gray-400 text-sm">
                        <li><a href="/gallery" class="hover:text-white transition-colors"><i class="fas fa-images mr-2 text-purple-400"></i>NFT ê°¤ëŸ¬ë¦¬</a></li>
                        <li><a href="/artists" class="hover:text-white transition-colors"><i class="fas fa-palette mr-2 text-blue-400"></i>NFT ì•„í‹°ìŠ¤íŠ¸</a></li>
                        <li><a href="/leaderboard" class="hover:text-white transition-colors"><i class="fas fa-trophy mr-2 text-yellow-400"></i>NFT ë­í‚¹ì‹œìŠ¤í…œ</a></li>
                        <li><a href="/collections" class="hover:text-white transition-colors"><i class="fas fa-layer-group mr-2 text-cyan-400"></i>NFT ì»¬ë ‰ì…˜</a></li>
                        <li><a href="/search" class="hover:text-white transition-colors"><i class="fas fa-robot mr-2 text-pink-400"></i>NFT AI ì¶”ì²œ ì‹œìŠ¤í…œ</a></li>
                        <li><a href="/valuation-system" class="hover:text-white transition-colors"><i class="fas fa-chart-line mr-2 text-green-400"></i>NFT ë¯¸ìˆ í’ˆ ê°€ì¹˜ì‚°ì • ì‹œìŠ¤í…œ</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold mb-4 text-white">ì´ìš©ë°©ë²•/ì§€ì›</h4>
                    <ul class="space-y-3 text-gray-400 text-sm">
                        <li><a href="/usage-guide" class="hover:text-white transition-colors"><i class="fas fa-book mr-2 text-cyan-400"></i>ì‚¬ì´íŠ¸ ì´ìš©í•˜ê¸°</a></li>
                        <li><a href="/help" class="hover:text-white transition-colors"><i class="fas fa-question-circle mr-2 text-blue-400"></i>ë„ì›€ë§</a></li>
                        <li><a href="/valuation-system" class="hover:text-white transition-colors"><i class="fas fa-chart-line mr-2 text-green-400"></i>ê°€ì¹˜ì‚°ì • ì‹œìŠ¤í…œ</a></li>
                        <li><a href="/support" class="hover:text-white transition-colors"><i class="fas fa-headset mr-2 text-purple-400"></i>ì§€ì›</a></li>
                        <li><a href="/contact" class="hover:text-white transition-colors"><i class="fas fa-envelope mr-2 text-pink-400"></i>ë¬¸ì˜í•˜ê¸°</a></li>
                        <li><a href="/privacy" class="hover:text-white transition-colors"><i class="fas fa-shield-alt mr-2 text-amber-400"></i>ê°œì¸ì •ë³´ë³´í˜¸</a></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-white border-opacity-10 mt-12 pt-8 text-center text-gray-500 text-sm">
                <p>&copy; 2025 Imageroot All rights reserved. Powered by Hyunwoo Nam Professor.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <script>
      let web3;
      let currentAccount;
      
      // ë©”íƒ€ë§ˆìŠ¤í¬ ì—°ê²°
      async function connectMetaMask() {
        if (typeof window.ethereum !== 'undefined') {
          try {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            currentAccount = accounts[0];
            web3 = new Web3(window.ethereum);
            
            // UI ì—…ë°ì´íŠ¸
            const walletText = document.getElementById('walletText');
            if (walletText) {
              walletText.textContent = currentAccount.substring(0, 6) + '...' + currentAccount.substring(38);
            }
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            localStorage.setItem('walletAddress', currentAccount);
            
            console.log('Connected:', currentAccount);
            
            // ê³„ì • ë³€ê²½ ê°ì§€
            window.ethereum.on('accountsChanged', function (accounts) {
              currentAccount = accounts[0];
              if (walletText) {
                walletText.textContent = currentAccount ? currentAccount.substring(0, 6) + '...' + currentAccount.substring(38) : 'ì§€ê°‘ ì—°ê²°';
              }
              if (currentAccount) {
                localStorage.setItem('walletAddress', currentAccount);
              } else {
                localStorage.removeItem('walletAddress');
              }
              updateWalletButton();
            });
            
            return currentAccount;
          } catch (error) {
            console.error('ë©”íƒ€ë§ˆìŠ¤í¬ ì—°ê²° ì‹¤íŒ¨:', error);
            alert('ë©”íƒ€ë§ˆìŠ¤í¬ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        } else {
          alert('ë©”íƒ€ë§ˆìŠ¤í¬ë¥¼ ì„¤ì¹˜í•´ì£¼ì„¸ìš”! https://metamask.io');
        }
      }
      
      // ì§€ê°‘ ë²„íŠ¼ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateWalletButton() {
        const walletBtn = document.getElementById('walletBtn');
        if (!walletBtn) return;
        
        if (currentAccount) {
          const shortAddress = currentAccount.substring(0, 6) + '...' + currentAccount.substring(38);
          walletBtn.innerHTML = \`
            <i class="fas fa-wallet mr-2"></i>
            <span class="text-sm font-medium">\${shortAddress}</span>
          \`;
          walletBtn.classList.remove('from-orange-500', 'to-pink-500', 'hover:from-orange-600', 'hover:to-pink-600');
          walletBtn.classList.add('from-green-500', 'to-emerald-500', 'hover:from-green-600', 'hover:to-emerald-600');
        } else {
          walletBtn.innerHTML = \`
            <i class="fas fa-wallet mr-2"></i>
            <span class="text-sm font-medium">ì§€ê°‘ì—°ê²°</span>
          \`;
          walletBtn.classList.remove('from-green-500', 'to-emerald-500', 'hover:from-green-600', 'hover:to-emerald-600');
          walletBtn.classList.add('from-orange-500', 'to-pink-500', 'hover:from-orange-600', 'hover:to-pink-600');
        }
      }
      
      // ì§€ê°‘ ì—°ê²° í•¨ìˆ˜ ë˜í¼
      async function connectWallet() {
        await window.connectWallet();
        updateWalletButton();
      }
      
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì—°ê²° ìƒíƒœ í™•ì¸
      window.addEventListener('DOMContentLoaded', async function() {
        const savedAddress = localStorage.getItem('walletAddress');
        if (savedAddress && typeof window.ethereum !== 'undefined') {
          try {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts.length > 0) {
              currentAccount = accounts[0];
              web3 = new Web3(window.ethereum);
              const walletText = document.getElementById('walletText');
              if (walletText) {
                walletText.textContent = currentAccount.substring(0, 6) + '...' + currentAccount.substring(38);
              }
              updateWalletButton();
            }
          } catch (error) {
            console.error('ê³„ì • í™•ì¸ ì‹¤íŒ¨:', error);
          }
        }
        updateWalletButton();
        
        // ì‚¬ìš©ì ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™”
        initUserNavigation();
      });
      
      // ì‚¬ìš©ì ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™”
      async function initUserNavigation() {
        const token = localStorage.getItem('auth_token');
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        
        // DOM ìš”ì†Œ
        const signupBtn = document.getElementById('signupBtn');
        const loginBtn = document.getElementById('loginBtn');
        const walletBtn = document.getElementById('walletBtn');
        const userDropdown = document.getElementById('userDropdown');
        const userMenuButton = document.getElementById('userMenuButton');
        const userMenu = document.getElementById('userMenu');
        const notificationBell = document.getElementById('notificationBell');
        const notificationCount = document.getElementById('notificationCount');
        const analyticsLink = document.getElementById('analyticsLink');
        const adminLink = document.getElementById('adminLink');
        const logoutBtn = document.getElementById('logoutBtn');
        
        if (token && user) {
          // ë¡œê·¸ì¸ ìƒíƒœ
          if (signupBtn) signupBtn.style.display = 'none';
          if (loginBtn) loginBtn.style.display = 'none';
          if (walletBtn) walletBtn.classList.remove('hidden');
          if (userDropdown) userDropdown.style.display = 'block';
          if (notificationBell) notificationBell.style.display = 'block';
          
          // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
          const userInitial = document.getElementById('userInitial');
          const userName = document.getElementById('userName');
          const userEmail = document.getElementById('userEmail');
          
          if (userInitial) userInitial.textContent = (user.full_name || user.email || 'U').charAt(0).toUpperCase();
          if (userName) userName.textContent = user.full_name || 'ì‚¬ìš©ì';
          if (userEmail) userEmail.textContent = user.email || '';
          
          // ì—­í• ë³„ ë§í¬ í‘œì‹œ
          if (user.role === 'admin' || user.role === 'expert') {
            if (analyticsLink) analyticsLink.classList.remove('hidden');
            if (analyticsLink) analyticsLink.classList.add('flex');
          }
          if (user.role === 'admin') {
            if (adminLink) adminLink.classList.remove('hidden');
            if (adminLink) adminLink.classList.add('flex');
          }
          
          // ì•Œë¦¼ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
          try {
            const response = await fetch('/api/notifications/unread-count', {
              headers: { 'Authorization': \`Bearer \${token}\` }
            });
            if (response.ok) {
              const data = await response.json();
              if (data.count > 0) {
                if (notificationCount) {
                  notificationCount.textContent = data.count > 99 ? '99+' : data.count;
                  notificationCount.style.display = 'flex';
                }
              }
            }
          } catch (error) {
            console.error('ì•Œë¦¼ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
          }
          
          // ë“œë¡­ë‹¤ìš´ í† ê¸€
          if (userMenuButton) {
            userMenuButton.addEventListener('click', () => {
              if (userMenu) {
                userMenu.classList.toggle('hidden');
              }
            });
          }
          
          // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
          document.addEventListener('click', (e) => {
            if (userDropdown && !userDropdown.contains(e.target)) {
              if (userMenu) userMenu.classList.add('hidden');
            }
          });
          
          // ë¡œê·¸ì•„ì›ƒ
          if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
              try {
                await fetch('/api/auth/logout', {
                  method: 'POST',
                  headers: { 'Authorization': \`Bearer \${token}\` }
                });
              } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
              } finally {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user');
                window.location.href = '/';
              }
            });
          }
        } else {
          // ë¹„ë¡œê·¸ì¸ ìƒíƒœ
          if (signupBtn) signupBtn.style.display = 'flex';
          if (loginBtn) loginBtn.style.display = 'flex';
          if (walletBtn) walletBtn.classList.add('hidden');
          if (userDropdown) userDropdown.style.display = 'none';
          if (notificationBell) notificationBell.style.display = 'none';
          if (analyticsLink) analyticsLink.style.display = 'none';
          if (adminLink) adminLink.style.display = 'none';
        }
      }
      
      // ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ í† ê¸€
      window.toggleNotifications = async function() {
        const dropdown = document.getElementById('notificationDropdown');
        const notificationBell = document.getElementById('notificationBell');
        
        if (!dropdown) return;
        
        const isHidden = dropdown.classList.contains('hidden');
        
        if (isHidden) {
          dropdown.classList.remove('hidden');
          await loadNotifications();
        } else {
          dropdown.classList.add('hidden');
        }
        
        // ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener('click', function closeDropdown(e) {
          if (notificationBell && !notificationBell.contains(e.target)) {
            dropdown.classList.add('hidden');
            document.removeEventListener('click', closeDropdown);
          }
        });
      }
      
      // ì•Œë¦¼ ëª©ë¡ ë¡œë“œ
      window.loadNotifications = async function() {
        const token = localStorage.getItem('auth_token');
        if (!token) return;
        
        const loading = document.getElementById('notificationsLoading');
        const list = document.getElementById('notificationsList');
        const empty = document.getElementById('notificationsEmpty');
        
        try {
          loading.classList.remove('hidden');
          list.classList.add('hidden');
          empty.classList.add('hidden');
          
          const response = await fetch('/api/notifications?limit=10', {
            headers: { 'Authorization': \`Bearer \${token}\` }
          });
          
          if (!response.ok) throw new Error('Failed to load notifications');
          
          const data = await response.json();
          const notifications = data.notifications || [];
          
          loading.classList.add('hidden');
          
          if (notifications.length === 0) {
            empty.classList.remove('hidden');
            return;
          }
          
          list.classList.remove('hidden');
          list.innerHTML = notifications.map(notif => {
            const isUnread = !notif.is_read;
            const date = new Date(notif.created_at).toLocaleString('ko-KR', {
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            
            const typeIcon = {
              'purchase_offer': 'fa-shopping-cart',
              'bid_placed': 'fa-gavel',
              'evaluation_complete': 'fa-star',
              'price_change': 'fa-chart-line',
              'new_artwork': 'fa-palette'
            }[notif.type] || 'fa-bell';
            
            return \`
              <div class="p-4 hover:bg-white hover:bg-opacity-5 transition-colors cursor-pointer \${isUnread ? 'bg-purple-500 bg-opacity-10' : ''}" onclick="handleNotificationClick('\${notif.id}', '\${notif.link || '#'}')">
                <div class="flex items-start gap-3">
                  <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-purple-600 to-cyan-500 flex items-center justify-center">
                    <i class="fas \${typeIcon} text-white text-sm"></i>
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="text-white font-semibold text-sm mb-1">\${notif.title}</p>
                    <p class="text-gray-400 text-xs mb-2 line-clamp-2">\${notif.message}</p>
                    <p class="text-gray-500 text-xs">\${date}</p>
                  </div>
                  \${isUnread ? '<div class="flex-shrink-0 w-2 h-2 bg-purple-500 rounded-full"></div>' : ''}
                </div>
              </div>
            \`;
          }).join('');
          
        } catch (error) {
          console.error('ì•Œë¦¼ ë¡œë“œ ì‹¤íŒ¨:', error);
          loading.classList.add('hidden');
          empty.classList.remove('hidden');
          empty.innerHTML = \`
            <i class="fas fa-exclamation-triangle text-4xl mb-3 text-red-500"></i>
            <p>ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
          \`;
        }
      }
      
      // ì•Œë¦¼ í´ë¦­ ì²˜ë¦¬
      window.handleNotificationClick = async function(notificationId, link) {
        const token = localStorage.getItem('auth_token');
        if (!token) return;
        
        try {
          // ì½ìŒ í‘œì‹œ
          await fetch(\`/api/notifications/\${notificationId}/read\`, {
            method: 'PUT',
            headers: { 'Authorization': \`Bearer \${token}\` }
          });
          
          // ì•Œë¦¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
          await updateNotificationCount();
          
          // í˜ì´ì§€ ì´ë™
          if (link && link !== '#') {
            window.location.href = link;
          }
        } catch (error) {
          console.error('ì•Œë¦¼ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        }
      }
      
      // ëª¨ë‘ ì½ìŒ í‘œì‹œ
      window.markAllNotificationsRead = async function() {
        const token = localStorage.getItem('auth_token');
        if (!token) return;
        
        try {
          await fetch('/api/notifications/mark-all-read', {
            method: 'PUT',
            headers: { 'Authorization': \`Bearer \${token}\` }
          });
          
          await updateNotificationCount();
          await loadNotifications();
        } catch (error) {
          console.error('ëª¨ë‘ ì½ìŒ í‘œì‹œ ì‹¤íŒ¨:', error);
        }
      }
      
      // ì•Œë¦¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
      window.updateNotificationCount = async function() {
        const token = localStorage.getItem('auth_token');
        if (!token) return;
        
        try {
          const response = await fetch('/api/notifications/unread-count', {
            headers: { 'Authorization': \`Bearer \${token}\` }
          });
          
          if (response.ok) {
            const data = await response.json();
            const notificationCount = document.getElementById('notificationCount');
            
            if (notificationCount) {
              if (data.count > 0) {
                notificationCount.textContent = data.count > 99 ? '99+' : data.count;
                notificationCount.style.display = 'flex';
              } else {
                notificationCount.style.display = 'none';
              }
            }
          }
        } catch (error) {
          console.error('ì•Œë¦¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
        }
      }
      
      // ============================================
      // Global Utility Functions (Error & Retry Logic)
      // ============================================
      
      // Retry wrapper for API calls
      window.fetchWithRetry = async function(url, options = {}, maxRetries = 3, delay = 1000) {
        let lastError;
        
        for (let i = 0; i < maxRetries; i++) {
          try {
            const response = await fetch(url, options);
            
            // If successful, return
            if (response.ok) {
              return response;
            }
            
            // If 4xx error (client error), don't retry
            if (response.status >= 400 && response.status < 500) {
              return response;
            }
            
            // 5xx errors (server errors) will retry
            lastError = new Error(\`HTTP \${response.status}: \${response.statusText}\`);
          } catch (error) {
            lastError = error;
          }
          
          // Wait before retry (exponential backoff)
          if (i < maxRetries - 1) {
            await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
          }
        }
        
        // All retries failed
        throw lastError;
      }
      
      // Global error handler
      window.handleApiError = function(error, customMessage = '\uc624\ub958\uac00 \ubc1c\uc0dd\ud588\uc2b5\ub2c8\ub2e4') {
        console.error('API Error:', error);
        
        let message = customMessage;
        
        if (error.response) {
          // Server responded with error status
          if (error.response.status === 401) {
            message = '\ub85c\uadf8\uc778\uc774 \ud544\uc694\ud569\ub2c8\ub2e4';
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            window.location.href = '/login';
            return;
          } else if (error.response.status === 403) {
            message = '\uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4';
          } else if (error.response.status === 404) {
            message = '\uc694\uccad\ud55c \ub9ac\uc18c\uc2a4\ub97c \ucc3e\uc744 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4';
          } else if (error.response.status >= 500) {
            message = '\uc11c\ubc84 \uc624\ub958\uac00 \ubc1c\uc0dd\ud588\uc2b5\ub2c8\ub2e4. \uc7a0\uc2dc \ud6c4 \ub2e4\uc2dc \uc2dc\ub3c4\ud574\uc8fc\uc138\uc694';
          }
          
          if (error.response.data && error.response.data.message) {
            message += \`: \${error.response.data.message}\`;
          }
        } else if (error.request) {
          // Request made but no response
          message = '\ub124\ud2b8\uc6cc\ud06c \uc5f0\uacb0\uc744 \ud655\uc778\ud574\uc8fc\uc138\uc694';
        }
        
        showErrorToast(message);
        
        // Report to Sentry if available
        if (window.Sentry) {
          window.Sentry.captureException(error);
        }
      }
      
      // Error toast message
      window.showErrorToast = function(message) {
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-8 right-8 px-6 py-4 rounded-xl shadow-2xl z-50 animate-slide-up bg-red-600';
        toast.innerHTML = \`
          <div class="flex items-center gap-3">
            <i class="fas fa-exclamation-circle text-white text-xl"></i>
            <p class="text-white font-semibold">\${message}</p>
          </div>
        \`;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateY(20px)';
          setTimeout(() => toast.remove(), 300);
        }, 4000);
      }
      
      // Success toast message
      window.showSuccessToast = function(message) {
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-8 right-8 px-6 py-4 rounded-xl shadow-2xl z-50 animate-slide-up bg-green-600';
        toast.innerHTML = \`
          <div class="flex items-center gap-3">
            <i class="fas fa-check-circle text-white text-xl"></i>
            <p class="text-white font-semibold">\${message}</p>
          </div>
        \`;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateY(20px)';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
      
      // Info toast message
      window.showInfoToast = function(message) {
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-8 right-8 px-6 py-4 rounded-xl shadow-2xl z-50 animate-slide-up bg-blue-600';
        toast.innerHTML = \`
          <div class="flex items-center gap-3">
            <i class="fas fa-info-circle text-white text-xl"></i>
            <p class="text-white font-semibold">\${message}</p>
          </div>
        \`;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateY(20px)';
          setTimeout(() => toast.remove(), 300);
        }, 4000);
      }
      
      // Loading overlay
      window.showLoadingOverlay = function(message = '\ub85c\ub529 \uc911...') {
        // Remove existing overlay if any
        const existing = document.getElementById('globalLoadingOverlay');
        if (existing) existing.remove();
        
        const overlay = document.createElement('div');
        overlay.id = 'globalLoadingOverlay';
        overlay.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
        overlay.innerHTML = \`
          <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-purple-500 mx-auto mb-4"></div>
            <p class="text-white text-lg font-semibold">\${message}</p>
          </div>
        \`;
        document.body.appendChild(overlay);
      }
      
      window.hideLoadingOverlay = function() {
        const overlay = document.getElementById('globalLoadingOverlay');
        if (overlay) {
          overlay.style.opacity = '0';
          setTimeout(() => overlay.remove(), 300);
        }
      }
      
      // ============================================
      // í‚¤ë³´ë“œ ì ‘ê·¼ì„± (Keyboard Accessibility)
      // ============================================
      
      // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ í•¸ë“¤ëŸ¬
      document.addEventListener('keydown', function(e) {
        // Escape í‚¤ - ëª¨ë‹¬ ë‹«ê¸°
        if (e.key === 'Escape') {
          // ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
          const notificationDropdown = document.getElementById('notificationDropdown');
          if (notificationDropdown && !notificationDropdown.classList.contains('hidden')) {
            notificationDropdown.classList.add('hidden');
            return;
          }
          
          // ëª¨ë°”ì¼ ë©”ë‰´ ë‹«ê¸°
          const mobileMenu = document.getElementById('mobileMenu');
          if (mobileMenu && !mobileMenu.classList.contains('translate-x-full')) {
            closeMobileMenuFunc();
            return;
          }
          
          // ì‚¬ìš©ì ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
          const userMenu = document.getElementById('userMenu');
          if (userMenu && !userMenu.classList.contains('hidden')) {
            userMenu.classList.add('hidden');
            return;
          }
        }
        
        // Ctrl/Cmd + K - ê²€ìƒ‰ í˜ì´ì§€ë¡œ ì´ë™
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          window.location.href = '/search';
          return;
        }
        
        // Ctrl/Cmd + / - ë‹¨ì¶•í‚¤ ë„ì›€ë§ í‘œì‹œ
        if ((e.ctrlKey || e.metaKey) && e.key === '/') {
          e.preventDefault();
          showKeyboardShortcutsHelp();
          return;
        }
        
        // G + H - í™ˆìœ¼ë¡œ ì´ë™
        if (e.key === 'g') {
          const nextKey = function(e2) {
            if (e2.key === 'h') {
              e2.preventDefault();
              window.location.href = '/';
            }
            document.removeEventListener('keydown', nextKey);
          };
          document.addEventListener('keydown', nextKey);
          setTimeout(() => document.removeEventListener('keydown', nextKey), 1000);
          return;
        }
        
        // G + G - ê°¤ëŸ¬ë¦¬ë¡œ ì´ë™
        if (e.key === 'g') {
          const nextKey = function(e2) {
            if (e2.key === 'g') {
              e2.preventDefault();
              window.location.href = '/gallery';
            }
            document.removeEventListener('keydown', nextKey);
          };
          document.addEventListener('keydown', nextKey);
          setTimeout(() => document.removeEventListener('keydown', nextKey), 1000);
          return;
        }
        
        // N - ì•Œë¦¼ ì—´ê¸° (ë¡œê·¸ì¸ ì‹œ)
        if (e.key === 'n' && !e.ctrlKey && !e.metaKey && !e.altKey) {
          // Input/textareaì—ì„œëŠ” ì‘ë™í•˜ì§€ ì•Šë„ë¡
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
          
          const notificationBell = document.getElementById('notificationBell');
          if (notificationBell && notificationBell.style.display !== 'none') {
            e.preventDefault();
            toggleNotifications();
          }
          return;
        }
      });
      
      // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ë„ì›€ë§ í‘œì‹œ
      window.showKeyboardShortcutsHelp = function() {
        const helpModal = document.createElement('div');
        helpModal.id = 'keyboardShortcutsModal';
        helpModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60] p-4';
        helpModal.setAttribute('role', 'dialog');
        helpModal.setAttribute('aria-labelledby', 'shortcuts-title');
        helpModal.setAttribute('aria-modal', 'true');
        
        helpModal.innerHTML = \`
          <div class="bg-gray-900 rounded-2xl shadow-2xl max-w-2xl w-full border border-white border-opacity-10 overflow-hidden">
            <div class="p-6 border-b border-white border-opacity-10">
              <div class="flex justify-between items-center">
                <h2 id="shortcuts-title" class="text-2xl font-bold text-white">âŒ¨ï¸ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤</h2>
                <button onclick="closeKeyboardShortcutsHelp()" class="text-gray-400 hover:text-white transition p-2" aria-label="ë‹«ê¸°">
                  <i class="fas fa-times text-xl"></i>
                </button>
              </div>
            </div>
            
            <div class="p-6 max-h-[70vh] overflow-y-auto">
              <div class="space-y-6">
                <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
                <div>
                  <h3 class="text-lg font-semibold text-purple-400 mb-3">ğŸ§­ ë„¤ë¹„ê²Œì´ì…˜</h3>
                  <div class="space-y-2">
                    <div class="flex justify-between items-center p-3 bg-white bg-opacity-5 rounded-lg">
                      <span class="text-gray-300">í™ˆìœ¼ë¡œ ì´ë™</span>
                      <div class="flex gap-2">
                        <kbd class="px-3 py-1 bg-gray-800 border border-gray-700 rounded text-sm font-mono">G</kbd>
                        <kbd class="px-3 py-1 bg-gray-800 border border-gray-700 rounded text-sm font-mono">H</kbd>
                      </div>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-white bg-opacity-5 rounded-lg">
                      <span class="text-gray-300">ê°¤ëŸ¬ë¦¬ë¡œ ì´ë™</span>
                      <div class="flex gap-2">
                        <kbd class="px-3 py-1 bg-gray-800 border border-gray-700 rounded text-sm font-mono">G</kbd>
                        <kbd class="px-3 py-1 bg-gray-800 border border-gray-700 rounded text-sm font-mono">G</kbd>
                      </div>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-white bg-opacity-5 rounded-lg">
                      <span class="text-gray-300">ê²€ìƒ‰</span>
                      <div class="flex gap-2">
                        <kbd class="px-3 py-1 bg-gray-800 border border-gray-700 rounded text-sm font-mono">Ctrl</kbd>
                        <span class="text-gray-500">+</span>
                        <kbd class="px-3 py-1 bg-gray-800 border border-gray-700 rounded text-sm font-mono">K</kbd>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- ì•¡ì…˜ -->
                <div>
                  <h3 class="text-lg font-semibold text-cyan-400 mb-3">âš¡ ì•¡ì…˜</h3>
                  <div class="space-y-2">
                    <div class="flex justify-between items-center p-3 bg-white bg-opacity-5 rounded-lg">
                      <span class="text-gray-300">ì•Œë¦¼ ì—´ê¸°</span>
                      <kbd class="px-3 py-1 bg-gray-800 border border-gray-700 rounded text-sm font-mono">N</kbd>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-white bg-opacity-5 rounded-lg">
                      <span class="text-gray-300">ëª¨ë‹¬/ë©”ë‰´ ë‹«ê¸°</span>
                      <kbd class="px-3 py-1 bg-gray-800 border border-gray-700 rounded text-sm font-mono">ESC</kbd>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-white bg-opacity-5 rounded-lg">
                      <span class="text-gray-300">ë‹¨ì¶•í‚¤ ë„ì›€ë§</span>
                      <div class="flex gap-2">
                        <kbd class="px-3 py-1 bg-gray-800 border border-gray-700 rounded text-sm font-mono">Ctrl</kbd>
                        <span class="text-gray-500">+</span>
                        <kbd class="px-3 py-1 bg-gray-800 border border-gray-700 rounded text-sm font-mono">/</kbd>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- ì ‘ê·¼ì„± -->
                <div>
                  <h3 class="text-lg font-semibold text-green-400 mb-3">â™¿ ì ‘ê·¼ì„±</h3>
                  <div class="space-y-2">
                    <div class="flex justify-between items-center p-3 bg-white bg-opacity-5 rounded-lg">
                      <span class="text-gray-300">ìš”ì†Œ ê°„ ì´ë™</span>
                      <kbd class="px-3 py-1 bg-gray-800 border border-gray-700 rounded text-sm font-mono">Tab</kbd>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-white bg-opacity-5 rounded-lg">
                      <span class="text-gray-300">ì—­ë°©í–¥ ì´ë™</span>
                      <div class="flex gap-2">
                        <kbd class="px-3 py-1 bg-gray-800 border border-gray-700 rounded text-sm font-mono">Shift</kbd>
                        <span class="text-gray-500">+</span>
                        <kbd class="px-3 py-1 bg-gray-800 border border-gray-700 rounded text-sm font-mono">Tab</kbd>
                      </div>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-white bg-opacity-5 rounded-lg">
                      <span class="text-gray-300">ë§í¬/ë²„íŠ¼ í™œì„±í™”</span>
                      <kbd class="px-3 py-1 bg-gray-800 border border-gray-700 rounded text-sm font-mono">Enter</kbd>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="mt-6 p-4 bg-purple-900 bg-opacity-20 rounded-lg border border-purple-500 border-opacity-30">
                <p class="text-sm text-gray-300">
                  <i class="fas fa-lightbulb text-yellow-400 mr-2"></i>
                  <strong>Tip:</strong> Tab í‚¤ë¥¼ ëˆŒëŸ¬ í˜ì´ì§€ ë‚´ ëª¨ë“  ì¸í„°ë™í‹°ë¸Œ ìš”ì†Œë¥¼ íƒìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
              </div>
            </div>
            
            <div class="p-4 border-t border-white border-opacity-10 bg-gray-800 bg-opacity-50">
              <button onclick="closeKeyboardShortcutsHelp()" class="w-full px-6 py-3 bg-gradient-to-r from-purple-600 to-cyan-600 text-white rounded-xl font-semibold hover:shadow-lg transition">
                í™•ì¸ <span class="keyboard-hint ml-2">ESC</span>
              </button>
            </div>
          </div>
        \`;
        
        document.body.appendChild(helpModal);
        
        // í¬ì»¤ìŠ¤ íŠ¸ë© ì„¤ì •
        const closeButton = helpModal.querySelector('button[onclick="closeKeyboardShortcutsHelp()"]');
        if (closeButton) closeButton.focus();
        
        // ESCë¡œ ë‹«ê¸°
        const escHandler = function(e) {
          if (e.key === 'Escape') {
            closeKeyboardShortcutsHelp();
            document.removeEventListener('keydown', escHandler);
          }
        };
        document.addEventListener('keydown', escHandler);
        
        // ì™¸ë¶€ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
        helpModal.addEventListener('click', function(e) {
          if (e.target === helpModal) {
            closeKeyboardShortcutsHelp();
          }
        });
      }
      
      window.closeKeyboardShortcutsHelp = function() {
        const modal = document.getElementById('keyboardShortcutsModal');
        if (modal) {
          modal.style.opacity = '0';
          setTimeout(() => modal.remove(), 300);
        }
      }
      
      // Tab navigation ê°œì„  - ì¹´ë“œì— tabindex ì¶”ê°€
      window.enhanceTabNavigation = function() {
        // ëª¨ë“  í´ë¦­ ê°€ëŠ¥í•œ ì¹´ë“œì— tabindex ì¶”ê°€
        document.querySelectorAll('.card-nft').forEach(card => {
          if (!card.hasAttribute('tabindex')) {
            card.setAttribute('tabindex', '0');
            card.setAttribute('role', 'button');
            
            // Enter/Spaceë¡œ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡
            card.addEventListener('keydown', function(e) {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                card.click();
              }
            });
          }
        });
        
        // ì¹´í…Œê³ ë¦¬ ë°°ì§€ì— tabindex ì¶”ê°€
        document.querySelectorAll('.category-badge').forEach(badge => {
          if (!badge.hasAttribute('tabindex')) {
            badge.setAttribute('tabindex', '0');
            badge.setAttribute('role', 'button');
            
            badge.addEventListener('keydown', function(e) {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                badge.click();
              }
            });
          }
        });
        
        // ëª¨ë“  ë§í¬ì— ARIA labels ì¶”ê°€ (ì—†ëŠ” ê²½ìš°)
        document.querySelectorAll('a[href]').forEach(link => {
          if (!link.hasAttribute('aria-label') && !link.textContent.trim()) {
            const href = link.getAttribute('href');
            link.setAttribute('aria-label', \`Navigate to \${href}\`);
          }
        });
      }
      
      // í˜ì´ì§€ ë¡œë“œ ì‹œ Tab navigation ê°œì„  ì ìš©
      document.addEventListener('DOMContentLoaded', enhanceTabNavigation);
      
      // ë™ì  ì½˜í…ì¸  ë¡œë“œ í›„ì—ë„ ì ìš© (MutationObserver)
      if (typeof MutationObserver !== 'undefined') {
        const observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length) {
              enhanceTabNavigation();
            }
          });
        });
        
        observer.observe(document.body, {
          childList: true,
          subtree: true
        });
      }
      
      // ============================================
      // ì˜¨ë³´ë”© íŠœí† ë¦¬ì–¼ (Onboarding Tutorial)
      // ============================================
      
      window.tutorialState = {
        currentStep: 0,
        steps: [
          {
            target: 'a[href="/gallery"]',
            title: 'ğŸ¨ ê°¤ëŸ¬ë¦¬',
            description: 'í”„ë¦¬ë¯¸ì—„ NFT ì‘í’ˆë“¤ì„ ë‘˜ëŸ¬ë³´ì„¸ìš”. ê°€ì¹˜ì‚°ì • ì‹œìŠ¤í…œìœ¼ë¡œ ê²€ì¦ëœ ì‘í’ˆë“¤ì„ ë§Œë‚˜ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
            position: 'bottom'
          },
          {
            target: 'a[href="/leaderboard"]',
            title: 'ğŸ† ì•„í‹°ìŠ¤íŠ¸ ë­í‚¹',
            description: 'í™œë™ ì¤‘ì¸ ì•„í‹°ìŠ¤íŠ¸ë“¤ì˜ ë­í‚¹ì„ í™•ì¸í•˜ê³ , ê·¸ë“¤ì˜ ì‘í’ˆì„ ì‚´í´ë³´ì„¸ìš”.',
            position: 'bottom'
          },
          {
            target: 'a[href="/valuation-system"]',
            title: 'ğŸ“Š ê°€ì¹˜ì‚°ì • ì‹œìŠ¤í…œ',
            description: '5ê°œ ëª¨ë“ˆ ê¸°ë°˜ì˜ ê³¼í•™ì  ê°€ì¹˜ì‚°ì • ë°©ë²•ë¡ ì„ í™•ì¸í•˜ì„¸ìš”. íˆ¬ëª…í•˜ê³  ê³µì •í•œ í‰ê°€ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.',
            position: 'bottom'
          },
          {
            target: 'a[href="/mint"]',
            title: 'ğŸ’ NFT ë¯¼íŒ…',
            description: 'ìì‹ ì˜ ì‘í’ˆì„ NFTë¡œ ë¯¼íŒ…í•˜ê³ , ê°€ì¹˜ í‰ê°€ë¥¼ ë°›ì•„ë³´ì„¸ìš”.',
            position: 'bottom'
          },
          {
            target: 'a[href="/search"]',
            title: 'ğŸ” ìŠ¤ë§ˆíŠ¸ ê²€ìƒ‰',
            description: 'í…ìŠ¤íŠ¸, ìŒì„±, AI ê¸°ë°˜ ê²€ìƒ‰ìœ¼ë¡œ ì›í•˜ëŠ” ì‘í’ˆì„ ì‰½ê²Œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
            position: 'bottom'
          }
        ],
        isActive: false
      };
      
      // ì²« ë°©ë¬¸ ì—¬ë¶€ í™•ì¸
      window.checkFirstVisit = function() {
        const hasVisited = localStorage.getItem('tutorial_completed');
        const currentPath = window.location.pathname;
        
        // í™ˆí˜ì´ì§€ì—ì„œë§Œ íŠœí† ë¦¬ì–¼ í‘œì‹œ
        if (!hasVisited && currentPath === '/') {
          setTimeout(() => {
            showWelcomeModal();
          }, 1000);
        }
      };
      
      // ì›°ì»´ ëª¨ë‹¬ í‘œì‹œ
      window.showWelcomeModal = function() {
        const modal = document.createElement('div');
        modal.id = 'tutorialWelcomeModal';
        modal.className = 'tutorial-overlay';
        
        modal.innerHTML = \`
          <div class="tutorial-welcome">
            <div class="tutorial-welcome-content">
              <div class="mb-6">
                <div class="inline-block p-6 rounded-full bg-gradient-to-br from-purple-600 to-cyan-500 mb-6">
                  <i class="fas fa-star text-6xl text-white"></i>
                </div>
              </div>
              
              <h1 class="text-4xl font-black mb-4 text-white">
                ê°¤ëŸ¬ë¦¬í”¼ì•„ì— ì˜¤ì‹  ê²ƒì„<br/>í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‰
              </h1>
              
              <p class="text-gray-300 text-lg mb-8 leading-relaxed">
                NFT ë¯¸ìˆ í’ˆ ê°€ì¹˜ì‚°ì • í”Œë«í¼ì˜ ì£¼ìš” ê¸°ëŠ¥ì„<br/>
                ê°„ë‹¨í•œ ê°€ì´ë“œë¡œ ì•ˆë‚´í•´ë“œë¦´ê²Œìš”.
              </p>
              
              <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button onclick="startTutorial()" class="tutorial-btn tutorial-btn-primary px-8 py-4 text-lg">
                  <i class="fas fa-play mr-2"></i>
                  íŠœí† ë¦¬ì–¼ ì‹œì‘
                </button>
                <button onclick="skipTutorial()" class="tutorial-btn tutorial-btn-secondary px-8 py-4 text-lg">
                  <i class="fas fa-times mr-2"></i>
                  ê±´ë„ˆë›°ê¸°
                </button>
              </div>
              
              <div class="mt-6 text-sm text-gray-500">
                <label class="flex items-center justify-center cursor-pointer">
                  <input type="checkbox" id="dontShowAgain" class="mr-2 w-4 h-4" />
                  ë‹¤ì‹œ ë³´ì§€ ì•Šê¸°
                </label>
              </div>
            </div>
          </div>
        \`;
        
        document.body.appendChild(modal);
      };
      
      // íŠœí† ë¦¬ì–¼ ì‹œì‘
      window.startTutorial = function() {
        const modal = document.getElementById('tutorialWelcomeModal');
        if (modal) modal.remove();
        
        window.tutorialState.isActive = true;
        window.tutorialState.currentStep = 0;
        
        showTutorialStep(0);
      };
      
      // íŠœí† ë¦¬ì–¼ ê±´ë„ˆë›°ê¸°
      window.skipTutorial = function() {
        const dontShowAgain = document.getElementById('dontShowAgain');
        if (dontShowAgain && dontShowAgain.checked) {
          localStorage.setItem('tutorial_completed', 'true');
        }
        
        const modal = document.getElementById('tutorialWelcomeModal');
        if (modal) modal.remove();
      };
      
      // íŠœí† ë¦¬ì–¼ ë‹¨ê³„ í‘œì‹œ
      window.showTutorialStep = function(stepIndex) {
        const step = window.tutorialState.steps[stepIndex];
        if (!step) return;
        
        // ì´ì „ í•˜ì´ë¼ì´íŠ¸ ì œê±°
        document.querySelectorAll('.tutorial-highlight').forEach(el => {
          el.classList.remove('tutorial-highlight');
        });
        
        // ì´ì „ íˆ´íŒ ì œê±°
        const oldTooltip = document.getElementById('tutorialTooltip');
        if (oldTooltip) oldTooltip.remove();
        
        // ì´ì „ ì˜¤ë²„ë ˆì´ ì œê±°
        const oldOverlay = document.getElementById('tutorialOverlay');
        if (oldOverlay) oldOverlay.remove();
        
        // íƒ€ê²Ÿ ìš”ì†Œ ì°¾ê¸°
        const targetElement = document.querySelector(step.target);
        if (!targetElement) {
          console.warn('Tutorial target not found:', step.target);
          nextTutorialStep();
          return;
        }
        
        // ì˜¤ë²„ë ˆì´ ì¶”ê°€
        const overlay = document.createElement('div');
        overlay.id = 'tutorialOverlay';
        overlay.className = 'tutorial-overlay';
        document.body.appendChild(overlay);
        
        // íƒ€ê²Ÿ ê°•ì¡°
        targetElement.classList.add('tutorial-highlight');
        
        // íˆ´íŒ ìƒì„±
        const tooltip = document.createElement('div');
        tooltip.id = 'tutorialTooltip';
        tooltip.className = 'tutorial-tooltip';
        
        // ì§„í–‰ë¥  í‘œì‹œ
        const progressDots = window.tutorialState.steps.map((_, index) => {
          return \`<div class="tutorial-progress-dot \${index === stepIndex ? 'active' : ''}"></div>\`;
        }).join('');
        
        tooltip.innerHTML = \`
          <div class="p-6">
            <div class="tutorial-progress mb-4">
              \${progressDots}
            </div>
            
            <h3 class="text-2xl font-bold text-white mb-3">\${step.title}</h3>
            <p class="text-gray-300 mb-6 leading-relaxed">\${step.description}</p>
            
            <div class="flex justify-between items-center gap-4">
              <div class="text-sm text-gray-500">
                <span class="font-semibold text-white">\${stepIndex + 1}</span> / \${window.tutorialState.steps.length}
              </div>
              
              <div class="flex gap-3">
                <button onclick="skipTutorialProgress()" class="tutorial-btn tutorial-btn-secondary text-sm">
                  ê±´ë„ˆë›°ê¸°
                </button>
                
                \${stepIndex > 0 ? \`
                  <button onclick="prevTutorialStep()" class="tutorial-btn tutorial-btn-secondary text-sm">
                    <i class="fas fa-arrow-left mr-1"></i>
                    ì´ì „
                  </button>
                \` : ''}
                
                <button onclick="nextTutorialStep()" class="tutorial-btn tutorial-btn-primary text-sm">
                  \${stepIndex === window.tutorialState.steps.length - 1 ? 'ì™„ë£Œ' : 'ë‹¤ìŒ'}
                  <i class="fas fa-arrow-right ml-1"></i>
                </button>
              </div>
            </div>
          </div>
        \`;
        
        document.body.appendChild(tooltip);
        
        // íˆ´íŒ ìœ„ì¹˜ ê³„ì‚°
        positionTooltip(tooltip, targetElement, step.position);
        
        // ìš”ì†Œê°€ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤
        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
      };
      
      // íˆ´íŒ ìœ„ì¹˜ ì„¤ì •
      window.positionTooltip = function(tooltip, target, position) {
        const targetRect = target.getBoundingClientRect();
        const tooltipRect = tooltip.getBoundingClientRect();
        
        let top, left;
        
        if (position === 'bottom') {
          top = targetRect.bottom + 20;
          left = targetRect.left + (targetRect.width / 2) - (tooltipRect.width / 2);
        } else if (position === 'top') {
          top = targetRect.top - tooltipRect.height - 20;
          left = targetRect.left + (targetRect.width / 2) - (tooltipRect.width / 2);
        } else if (position === 'left') {
          top = targetRect.top + (targetRect.height / 2) - (tooltipRect.height / 2);
          left = targetRect.left - tooltipRect.width - 20;
        } else if (position === 'right') {
          top = targetRect.top + (targetRect.height / 2) - (tooltipRect.height / 2);
          left = targetRect.right + 20;
        }
        
        // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ ì¡°ì •
        const padding = 20;
        if (left < padding) left = padding;
        if (left + tooltipRect.width > window.innerWidth - padding) {
          left = window.innerWidth - tooltipRect.width - padding;
        }
        if (top < padding) top = padding;
        if (top + tooltipRect.height > window.innerHeight - padding) {
          top = window.innerHeight - tooltipRect.height - padding;
        }
        
        tooltip.style.top = \`\${top}px\`;
        tooltip.style.left = \`\${left}px\`;
      };
      
      // ë‹¤ìŒ ë‹¨ê³„
      window.nextTutorialStep = function() {
        const nextIndex = window.tutorialState.currentStep + 1;
        
        if (nextIndex < window.tutorialState.steps.length) {
          window.tutorialState.currentStep = nextIndex;
          showTutorialStep(nextIndex);
        } else {
          // íŠœí† ë¦¬ì–¼ ì™„ë£Œ
          completeTutorial();
        }
      };
      
      // ì´ì „ ë‹¨ê³„
      window.prevTutorialStep = function() {
        const prevIndex = window.tutorialState.currentStep - 1;
        
        if (prevIndex >= 0) {
          window.tutorialState.currentStep = prevIndex;
          showTutorialStep(prevIndex);
        }
      };
      
      // íŠœí† ë¦¬ì–¼ ì§„í–‰ ì¤‘ ê±´ë„ˆë›°ê¸°
      window.skipTutorialProgress = function() {
        if (confirm('íŠœí† ë¦¬ì–¼ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          completeTutorial();
        }
      };
      
      // íŠœí† ë¦¬ì–¼ ì™„ë£Œ
      window.completeTutorial = function() {
        // í•˜ì´ë¼ì´íŠ¸ ì œê±°
        document.querySelectorAll('.tutorial-highlight').forEach(el => {
          el.classList.remove('tutorial-highlight');
        });
        
        // íˆ´íŒ ì œê±°
        const tooltip = document.getElementById('tutorialTooltip');
        if (tooltip) tooltip.remove();
        
        // ì˜¤ë²„ë ˆì´ ì œê±°
        const overlay = document.getElementById('tutorialOverlay');
        if (overlay) overlay.remove();
        
        // ìƒíƒœ ì´ˆê¸°í™”
        window.tutorialState.isActive = false;
        window.tutorialState.currentStep = 0;
        
        // ì™„ë£Œ í‘œì‹œ ì €ì¥
        localStorage.setItem('tutorial_completed', 'true');
        
        // ì™„ë£Œ ë©”ì‹œì§€
        showSuccessToast('ğŸ‰ íŠœí† ë¦¬ì–¼ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!');
      };
      
      // íŠœí† ë¦¬ì–¼ ë‹¤ì‹œ ì‹œì‘ (í—¤ë” ë©”ë‰´ì—ì„œ í˜¸ì¶œ)
      window.restartTutorial = function() {
        localStorage.removeItem('tutorial_completed');
        showWelcomeModal();
      };
      
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì²« ë°©ë¬¸ í™•ì¸
      document.addEventListener('DOMContentLoaded', checkFirstVisit);
      
      // ============================================
      // PWA Installation & Service Worker
      // ============================================
      
      let deferredPrompt = null;
      
      // Service Worker ë“±ë¡
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
          try {
            const registration = await navigator.serviceWorker.register('/service-worker.js');
            console.log('[PWA] Service Worker registered successfully:', registration.scope);
            
            // Service Worker ì—…ë°ì´íŠ¸ í™•ì¸
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // ìƒˆë¡œìš´ ë²„ì „ ì‚¬ìš© ê°€ëŠ¥ ì•Œë¦¼
                  showUpdateNotification();
                }
              });
            });
          } catch (error) {
            console.error('[PWA] Service Worker registration failed:', error);
          }
        });
      }
      
      // PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ì €ì¥
      window.addEventListener('beforeinstallprompt', (e) => {
        console.log('[PWA] Install prompt available');
        e.preventDefault();
        deferredPrompt = e;
        
        // ì„¤ì¹˜ ë²„íŠ¼ í‘œì‹œ (í—¤ë”ì— ì¶”ê°€)
        showInstallButton();
      });
      
      // PWA ì„¤ì¹˜ ì„±ê³µ ê°ì§€
      window.addEventListener('appinstalled', () => {
        console.log('[PWA] App installed successfully');
        deferredPrompt = null;
        hideInstallButton();
        showSuccessToast('ğŸ‰ ì•±ì´ í™ˆ í™”ë©´ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
      });
      
      // ì„¤ì¹˜ ë²„íŠ¼ í‘œì‹œ í•¨ìˆ˜
      function showInstallButton() {
        const heroBtn = document.getElementById('pwa-install-hero-button');
        if (heroBtn) {
          heroBtn.style.display = 'inline-flex';
        }
      }
      
      // ì„¤ì¹˜ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
      function hideInstallButton() {
        const heroBtn = document.getElementById('pwa-install-hero-button');
        if (heroBtn) {
          heroBtn.style.display = 'none';
        }
      }
      
      // PWA ì„¤ì¹˜ ì‹¤í–‰ í•¨ìˆ˜
      window.installPWA = async function() {
        if (!deferredPrompt) {
          // ì´ë¯¸ ì„¤ì¹˜ë¨ ë˜ëŠ” í”„ë¡¬í”„íŠ¸ ë¶ˆê°€ëŠ¥
          if (window.matchMedia('(display-mode: standalone)').matches) {
            showInfoToast('ì´ë¯¸ ì•±ì´ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤');
          } else {
            showInfoToast('ë¸Œë¼ìš°ì €ì—ì„œ ì„¤ì¹˜ ì˜µì…˜ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”');
          }
          return;
        }
        
        // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
        deferredPrompt.prompt();
        
        // ì‚¬ìš©ì ì„ íƒ ëŒ€ê¸°
        const { outcome } = await deferredPrompt.userChoice;
        console.log('[PWA] User choice:', outcome);
        
        if (outcome === 'accepted') {
          showSuccessToast('ì•± ì„¤ì¹˜ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤...');
        }
        
        // í”„ë¡¬í”„íŠ¸ ì´ˆê¸°í™”
        deferredPrompt = null;
        hideInstallButton();
      };
      
      // ì•± ì—…ë°ì´íŠ¸ ì•Œë¦¼
      function showUpdateNotification() {
        const notification = document.createElement('div');
        notification.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 animate-slide-up';
        notification.innerHTML = \`
          <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-4 rounded-full shadow-2xl flex items-center space-x-4">
            <i class="fas fa-sync-alt text-2xl"></i>
            <div>
              <p class="font-bold">ìƒˆë¡œìš´ ë²„ì „ì´ ìˆìŠµë‹ˆë‹¤</p>
              <p class="text-sm opacity-90">ì—…ë°ì´íŠ¸í•˜ë ¤ë©´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”</p>
            </div>
            <button onclick="window.location.reload()" class="bg-white text-purple-600 px-4 py-2 rounded-full font-bold hover:bg-gray-100 transition">
              ì—…ë°ì´íŠ¸
            </button>
          </div>
        \`;
        document.body.appendChild(notification);
        
        // 10ì´ˆ í›„ ìë™ ì œê±°
        setTimeout(() => {
          notification.remove();
        }, 10000);
      }
      
      // ============================================
      // Language Switcher (i18n) - L3-6
      // ============================================
      
      window.toggleLanguageMenu = function() {
        const menu = document.getElementById('languageMenu');
        if (!menu) return;
        
        menu.classList.toggle('hidden');
        
        // Close when clicking outside
        if (!menu.classList.contains('hidden')) {
          setTimeout(() => {
            document.addEventListener('click', closeLanguageMenuOnClickOutside, { once: true });
          }, 10);
        }
      };
      
      function closeLanguageMenuOnClickOutside(e) {
        const menu = document.getElementById('languageMenu');
        const switcher = document.getElementById('languageSwitcher');
        
        if (menu && switcher && !switcher.contains(e.target)) {
          menu.classList.add('hidden');
        }
      }
      
      window.changeLanguage = function(langCode) {
        if (!window.i18n) {
          console.error('i18n not initialized');
          return;
        }
        
        // Change language
        const success = window.i18n.setLanguage(langCode);
        
        if (success) {
          // Update flag in button
          const languages = window.i18n.getAllLanguages();
          const lang = languages.find(l => l.code === langCode);
          if (lang) {
            document.getElementById('currentLanguageFlag').textContent = lang.flag;
          }
          
          // Close menu
          document.getElementById('languageMenu').classList.add('hidden');
          
          // Reload page to apply translations
          window.location.reload();
        }
      };
      
      // Initialize language switcher on page load
      document.addEventListener('DOMContentLoaded', () => {
        // Wait for i18n to load (with fallback)
        const initLanguageSwitcher = () => {
          const languageList = document.getElementById('languageList');
          if (!languageList) return;
          
          if (!window.i18n) {
            // Fallback: Create basic language list if i18n fails to load
            const fallbackLanguages = [
              { code: 'ko', name: 'Korean', nativeName: 'í•œêµ­ì–´', flag: 'ğŸ‡°ğŸ‡·' },
              { code: 'en', name: 'English', nativeName: 'English', flag: 'ğŸ‡ºğŸ‡¸' },
              { code: 'ja', name: 'Japanese', nativeName: 'æ—¥æœ¬èª', flag: 'ğŸ‡¯ğŸ‡µ' },
              { code: 'zh', name: 'Chinese', nativeName: 'ä¸­æ–‡', flag: 'ğŸ‡¨ğŸ‡³' }
            ];
            const currentLang = localStorage.getItem('language') || 'ko';
            
            languageList.innerHTML = fallbackLanguages.map(lang => \`
              <button 
                onclick="changeLanguage('\${lang.code}')"
                class="w-full flex items-center justify-between px-4 py-3 text-left rounded-xl hover:bg-white hover:bg-opacity-5 transition-all \${lang.code === currentLang ? 'bg-purple-600 bg-opacity-20 text-white' : 'text-gray-300'}"
              >
                <div class="flex items-center space-x-3">
                  <span class="text-2xl">\${lang.flag}</span>
                  <div>
                    <div class="font-medium \${lang.code === currentLang ? 'text-white' : 'text-gray-200'}">\${lang.nativeName}</div>
                    <div class="text-xs text-gray-400">\${lang.name}</div>
                  </div>
                </div>
                \${lang.code === currentLang ? '<i class="fas fa-check text-purple-400"></i>' : ''}
              </button>
            \`).join('');
            
            const currentLangObj = fallbackLanguages.find(l => l.code === currentLang);
            if (currentLangObj) {
              document.getElementById('currentLanguageFlag').textContent = currentLangObj.flag;
            }
            return;
          }
          
          // Use i18n if available
          const languages = window.i18n.getAllLanguages();
          const currentLang = window.i18n.currentLanguage;
          
          languageList.innerHTML = languages.map(lang => \`
            <button 
              onclick="changeLanguage('\${lang.code}')"
              class="w-full flex items-center justify-between px-4 py-3 text-left rounded-xl hover:bg-white hover:bg-opacity-5 transition-all \${lang.code === currentLang ? 'bg-purple-600 bg-opacity-20 text-white' : 'text-gray-300'}"
            >
              <div class="flex items-center space-x-3">
                <span class="text-2xl">\${lang.flag}</span>
                <div>
                  <div class="font-medium \${lang.code === currentLang ? 'text-white' : 'text-gray-200'}">\${lang.nativeName}</div>
                  <div class="text-xs text-gray-400">\${lang.name}</div>
                </div>
              </div>
              \${lang.code === currentLang ? '<i class="fas fa-check text-purple-400"></i>' : ''}
            </button>
          \`).join('');
          
          // Update current flag
          const currentLangObj = languages.find(l => l.code === currentLang);
          if (currentLangObj) {
            document.getElementById('currentLanguageFlag').textContent = currentLangObj.flag;
          }
        };
        
        // Try to initialize immediately, or wait for i18n
        initLanguageSwitcher();
        
        // Retry if i18n loads late
        setTimeout(initLanguageSwitcher, 1000);
      });
      
      // í‘¸ì‹œ ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ (ì‚¬ìš©ì ë¡œê·¸ì¸ í›„ í˜¸ì¶œ)
      window.requestNotificationPermission = async function() {
        if (!('Notification' in window)) {
          console.log('[PWA] This browser does not support notifications');
          return false;
        }
        
        if (Notification.permission === 'granted') {
          console.log('[PWA] Notification permission already granted');
          return true;
        }
        
        if (Notification.permission !== 'denied') {
          const permission = await Notification.requestPermission();
          if (permission === 'granted') {
            showSuccessToast('ğŸ”” ì•Œë¦¼ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
            
            // í…ŒìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
            new Notification('ê°¤ëŸ¬ë¦¬í”¼ì•„', {
              body: 'ì•Œë¦¼ì´ ì„±ê³µì ìœ¼ë¡œ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!',
              icon: '/icons/icon-192x192.png',
              badge: '/icons/badge-72x72.png',
              tag: 'welcome',
              vibrate: [200, 100, 200]
            });
            
            return true;
          }
        }
        
        console.log('[PWA] Notification permission denied');
        return false;
      };
      
      // ì˜¤í”„ë¼ì¸ ìƒíƒœ ê°ì§€ ë° ì•Œë¦¼
      window.addEventListener('online', () => {
        showSuccessToast('ğŸŒ ì¸í„°ë„·ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤');
      });
      
      window.addEventListener('offline', () => {
        showInfoToast('ğŸ“´ ì˜¤í”„ë¼ì¸ ëª¨ë“œì…ë‹ˆë‹¤. ì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
      });
      
      // ì˜¤í”„ë¼ì¸ ì•¡ì…˜ í ì €ì¥ (IndexedDB)
      window.saveOfflineAction = async function(url, method, headers, body) {
        try {
          const db = await openIndexedDB();
          const transaction = db.transaction(['actions'], 'readwrite');
          const store = transaction.objectStore('actions');
          
          await store.add({
            url,
            method,
            headers,
            body,
            timestamp: Date.now()
          });
          
          console.log('[PWA] Offline action saved');
          showInfoToast('ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤. ì˜¨ë¼ì¸ ì‹œ ìë™ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤');
        } catch (error) {
          console.error('[PWA] Failed to save offline action:', error);
        }
      };
      
      // IndexedDB ì—´ê¸° í—¬í¼
      function openIndexedDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open('gallerypia-offline', 1);
          
          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve(request.result);
          
          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains('actions')) {
              db.createObjectStore('actions', { keyPath: 'id', autoIncrement: true });
            }
          };
        });
      }
      
      // Window unload handler (warn before leaving during upload/transaction)
      window.isProcessing = false;
      
      window.addEventListener('beforeunload', (e) => {
        if (window.isProcessing) {
          e.preventDefault();
          e.returnValue = '';
          return '';
        }
      });
      
      // ============================================
      // 3D/AR/VR Viewer Functions
      // ============================================
      
      // 3D ë·°ì–´ í‘œì‹œ
      window.show3DViewer = function(artworkId, imageUrl, title) {
        const modal = document.createElement('div');
        modal.id = '3d-viewer-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-95 z-50 flex items-center justify-center p-4';
        modal.innerHTML = \`
          <div class="relative w-full max-w-6xl h-[80vh] bg-gray-900 rounded-2xl overflow-hidden">
            <div class="absolute top-4 left-4 z-10">
              <h3 class="text-2xl font-bold text-white mb-1">\${title}</h3>
              <p class="text-sm text-gray-400">3D ë¯¸ë¦¬ë³´ê¸°</p>
            </div>
            <button onclick="close3DViewer()" class="absolute top-4 right-4 z-10 w-12 h-12 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center transition-all">
              <i class="fas fa-times text-white text-xl"></i>
            </button>
            <div class="absolute bottom-4 left-4 right-4 z-10 bg-black/50 backdrop-blur-sm rounded-xl p-4">
              <div class="flex items-center justify-between text-white text-sm">
                <div class="flex items-center space-x-2">
                  <button onclick="rotate3DModel('left')" class="flex items-center space-x-2 px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition" title="ì™¼ìª½ íšŒì „">
                    <i class="fas fa-undo"></i>
                    <span class="hidden md:inline">ì™¼ìª½</span>
                  </button>
                  <button onclick="rotate3DModel('right')" class="flex items-center space-x-2 px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition" title="ì˜¤ë¥¸ìª½ íšŒì „">
                    <i class="fas fa-redo"></i>
                    <span class="hidden md:inline">ì˜¤ë¥¸ìª½</span>
                  </button>
                  <button onclick="reset3DView()" class="flex items-center space-x-2 px-3 py-2 bg-cyan-600 hover:bg-cyan-700 rounded-lg transition" title="ë·° ë¦¬ì…‹">
                    <i class="fas fa-sync-alt"></i>
                    <span class="hidden md:inline">ë¦¬ì…‹</span>
                  </button>
                  <button onclick="toggle3DWireframe()" class="flex items-center space-x-2 px-3 py-2 bg-pink-600 hover:bg-pink-700 rounded-lg transition" title="ì™€ì´ì–´í”„ë ˆì„">
                    <i class="fas fa-border-all" id="wireframe-icon"></i>
                    <span class="hidden md:inline">ì™€ì´ì–´</span>
                  </button>
                  <button onclick="toggle3DAutoRotate()" class="flex items-center space-x-2 px-3 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition" title="ìë™ íšŒì „">
                    <i class="fas fa-sync-alt" id="autorotate-icon"></i>
                    <span class="hidden md:inline">ìë™</span>
                  </button>
                </div>
                <div class="text-xs text-gray-400 hidden md:block">
                  <i class="fas fa-mouse-pointer mr-2"></i>
                  ë“œë˜ê·¸: íšŒì „ | ìŠ¤í¬ë¡¤: ì¤Œ | ìš°í´ë¦­: íŒ¬
                </div>
              </div>
            </div>
            <div id="3d-canvas-container" class="w-full h-full"></div>
          </div>
        \`;
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
        
        // Initialize Three.js 3D viewer
        init3DViewer(imageUrl);
      };
      
      // 3D ë·°ì–´ ì´ˆê¸°í™” (Three.js)
      window.init3DViewer = function(imageUrl) {
        const container = document.getElementById('3d-canvas-container');
        if (!container || typeof THREE === 'undefined') return;
        
        // Scene setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a0a);
        
        // Camera setup
        const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.z = 5;
        
        // Renderer setup
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);
        
        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 5, 5);
        scene.add(directionalLight);
        
        // Create 3D plane with artwork texture
        const textureLoader = new THREE.TextureLoader();
        textureLoader.load(imageUrl, (texture) => {
          const geometry = new THREE.BoxGeometry(3, 4, 0.1);
          const material = new THREE.MeshStandardMaterial({ 
            map: texture,
            metalness: 0.2,
            roughness: 0.8
          });
          const mesh = new THREE.Mesh(geometry, material);
          scene.add(mesh);
          
          window.artwork3DMesh = mesh;
        }, undefined, (error) => {
          console.error('Failed to load texture:', error);
          // Fallback: create colored plane
          const geometry = new THREE.BoxGeometry(3, 4, 0.1);
          const material = new THREE.MeshStandardMaterial({ color: 0x8b5cf6 });
          const mesh = new THREE.Mesh(geometry, material);
          scene.add(mesh);
          window.artwork3DMesh = mesh;
        });
        
        // OrbitControls (if available) - Enhanced
        if (typeof THREE.OrbitControls !== 'undefined') {
          const controls = new THREE.OrbitControls(camera, renderer.domElement);
          controls.enableDamping = true;
          controls.dampingFactor = 0.05;
          controls.enableZoom = true;
          controls.enablePan = true;
          controls.minDistance = 2;
          controls.maxDistance = 15;
          controls.autoRotate = false;
          controls.autoRotateSpeed = 2.0;
          window.artwork3DControls = controls;
        }
        
        // Animation loop
        function animate() {
          requestAnimationFrame(animate);
          if (window.artwork3DControls) {
            window.artwork3DControls.update();
          }
          renderer.render(scene, camera);
        }
        animate();
        
        // Store references
        window.artwork3DScene = scene;
        window.artwork3DCamera = camera;
        window.artwork3DRenderer = renderer;
        
        // Handle window resize
        window.addEventListener('resize', () => {
          if (container && renderer) {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
          }
        });
      };
      
      // 3D ëª¨ë¸ íšŒì „
      window.rotate3DModel = function(direction) {
        if (!window.artwork3DMesh) return;
        const rotationSpeed = 0.3;
        if (direction === 'left') {
          window.artwork3DMesh.rotation.y -= rotationSpeed;
        } else if (direction === 'right') {
          window.artwork3DMesh.rotation.y += rotationSpeed;
        }
      };
      
      // ì™€ì´ì–´í”„ë ˆì„ í† ê¸€
      window.toggle3DWireframe = function() {
        if (window.artwork3DMesh && window.artwork3DMesh.material) {
          window.artwork3DMesh.material.wireframe = !window.artwork3DMesh.material.wireframe;
          const icon = document.getElementById('wireframe-icon');
          if (icon) {
            if (window.artwork3DMesh.material.wireframe) {
              icon.classList.remove('fa-border-all');
              icon.classList.add('fa-th');
              showInfoToast('ì™€ì´ì–´í”„ë ˆì„ ëª¨ë“œ í™œì„±í™”');
            } else {
              icon.classList.remove('fa-th');
              icon.classList.add('fa-border-all');
              showInfoToast('ì™€ì´ì–´í”„ë ˆì„ ëª¨ë“œ ë¹„í™œì„±í™”');
            }
          }
        }
      };
      
      // ìë™ íšŒì „ í† ê¸€
      window.toggle3DAutoRotate = function() {
        if (window.artwork3DControls) {
          window.artwork3DControls.autoRotate = !window.artwork3DControls.autoRotate;
          const icon = document.getElementById('autorotate-icon');
          if (icon) {
            if (window.artwork3DControls.autoRotate) {
              icon.style.animation = 'spin 2s linear infinite';
              showInfoToast('ìë™ íšŒì „ í™œì„±í™”');
            } else {
              icon.style.animation = '';
              showInfoToast('ìë™ íšŒì „ ë¹„í™œì„±í™”');
            }
          }
        }
      };
      
      // 3D ë·° ì´ˆê¸°í™”
      window.reset3DView = function() {
        if (window.artwork3DMesh) {
          window.artwork3DMesh.rotation.set(0, 0, 0);
        }
        if (window.artwork3DCamera) {
          window.artwork3DCamera.position.set(0, 0, 5);
        }
        if (window.artwork3DControls) {
          window.artwork3DControls.reset();
        }
        showInfoToast('ë·°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
      };
      
      // 3D ë·°ì–´ ë‹«ê¸°
      window.close3DViewer = function() {
        const modal = document.getElementById('3d-viewer-modal');
        if (modal) {
          // Cleanup Three.js resources
          if (window.artwork3DRenderer) {
            window.artwork3DRenderer.dispose();
          }
          if (window.artwork3DScene) {
            window.artwork3DScene.clear();
          }
          window.artwork3DMesh = null;
          window.artwork3DControls = null;
          window.artwork3DScene = null;
          window.artwork3DCamera = null;
          window.artwork3DRenderer = null;
          
          modal.remove();
          document.body.style.overflow = '';
        }
      };
      
      // AR ë·°ì–´ í‘œì‹œ
      window.showARViewer = function(artworkId, imageUrl, title) {
        const modal = document.createElement('div');
        modal.id = 'ar-viewer-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-95 z-50 flex items-center justify-center p-4';
        modal.innerHTML = \`
          <div class="relative w-full max-w-4xl bg-gray-900 rounded-2xl overflow-hidden p-8">
            <button onclick="closeARViewer()" class="absolute top-4 right-4 w-12 h-12 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center transition-all">
              <i class="fas fa-times text-white text-xl"></i>
            </button>
            
            <div class="text-center mb-6">
              <div class="inline-block p-4 rounded-full bg-gradient-to-r from-cyan-600 to-blue-600 mb-4">
                <i class="fas fa-mobile-alt text-4xl text-white"></i>
              </div>
              <h2 class="text-3xl font-bold text-white mb-2">ARë¡œ ì‘í’ˆ ë³´ê¸°</h2>
              <p class="text-gray-400">ëª¨ë°”ì¼ ê¸°ê¸°ì—ì„œ ì¹´ë©”ë¼ë¥¼ í†µí•´ ì‹¤ì œ ê³µê°„ì— ì‘í’ˆì„ ë°°ì¹˜í•´ë³´ì„¸ìš”</p>
            </div>
            
            <div class="bg-black/50 rounded-xl p-6 mb-6">
              <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                <i class="fas fa-qrcode text-cyan-400 mr-2"></i>
                QR ì½”ë“œë¡œ ëª¨ë°”ì¼ì—ì„œ ì—´ê¸°
              </h3>
              <div class="flex flex-col md:flex-row items-center gap-6">
                <div id="ar-qr-code" class="bg-white p-4 rounded-xl">
                  <!-- QR Code will be generated here -->
                  <div class="w-48 h-48 bg-white flex items-center justify-center">
                    <i class="fas fa-qrcode text-gray-400 text-6xl"></i>
                  </div>
                </div>
                <div class="flex-1 text-gray-300 space-y-3">
                  <p class="flex items-start">
                    <i class="fas fa-check-circle text-green-400 mt-1 mr-3"></i>
                    <span>ëª¨ë°”ì¼ ê¸°ê¸°ë¡œ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</span>
                  </p>
                  <p class="flex items-start">
                    <i class="fas fa-check-circle text-green-400 mt-1 mr-3"></i>
                    <span>ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”</span>
                  </p>
                  <p class="flex items-start">
                    <i class="fas fa-check-circle text-green-400 mt-1 mr-3"></i>
                    <span>í‰í‰í•œ í‘œë©´ì„ ë¹„ì¶”ë©´ ì‘í’ˆì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤</span>
                  </p>
                  <p class="flex items-start">
                    <i class="fas fa-check-circle text-green-400 mt-1 mr-3"></i>
                    <span>ì†ê°€ë½ìœ¼ë¡œ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ì™€ í¬ê¸°ë¥¼ ì¡°ì ˆí•˜ì„¸ìš”</span>
                  </p>
                </div>
              </div>
            </div>
            
            <div class="text-center">
              <a href="#" onclick="openARDirect(); return false;" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white font-bold rounded-xl transition-all">
                <i class="fas fa-mobile-alt"></i>
                <span>ëª¨ë°”ì¼ì—ì„œ ì§ì ‘ ì—´ê¸°</span>
              </a>
              <p class="text-xs text-gray-500 mt-3">iOS Safari ë˜ëŠ” Android Chrome ê¶Œì¥</p>
            </div>
          </div>
        \`;
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
        
        // Generate QR code (simplified - would need QR library in production)
        showInfoToast('AR ê¸°ëŠ¥ì€ ëª¨ë°”ì¼ ê¸°ê¸°ì— ìµœì í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤');
      };
      
      // AR ë·°ì–´ ë‹«ê¸°
      window.closeARViewer = function() {
        const modal = document.getElementById('ar-viewer-modal');
        if (modal) {
          modal.remove();
          document.body.style.overflow = '';
        }
      };
      
      // VR ê°¤ëŸ¬ë¦¬ í‘œì‹œ
      window.showVRGallery = function(artworkId, imageUrl, title) {
        const modal = document.createElement('div');
        modal.id = 'vr-gallery-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-95 z-50 flex items-center justify-center p-4';
        modal.innerHTML = \`
          <div class="relative w-full max-w-6xl h-[80vh] bg-gray-900 rounded-2xl overflow-hidden">
            <div class="absolute top-4 left-4 z-10">
              <h3 class="text-2xl font-bold text-white mb-1">VR ê°¤ëŸ¬ë¦¬ íˆ¬ì–´</h3>
              <p class="text-sm text-gray-400">360ë„ ê°€ìƒ ê°¤ëŸ¬ë¦¬ì—ì„œ ì‘í’ˆ ê°ìƒí•˜ê¸°</p>
            </div>
            <button onclick="closeVRGallery()" class="absolute top-4 right-4 z-10 w-12 h-12 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center transition-all">
              <i class="fas fa-times text-white text-xl"></i>
            </button>
            <div class="absolute bottom-4 left-4 right-4 z-10 bg-black/50 backdrop-blur-sm rounded-xl p-4">
              <div class="flex items-center justify-between text-white text-sm">
                <div class="flex items-center space-x-4">
                  <button onclick="enterVRMode()" class="flex items-center space-x-2 px-4 py-2 bg-pink-600 hover:bg-pink-700 rounded-lg transition">
                    <i class="fas fa-vr-cardboard"></i>
                    <span>VR ëª¨ë“œ ì§„ì…</span>
                  </button>
                  <button onclick="toggleVRSound()" class="flex items-center space-x-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition">
                    <i class="fas fa-volume-up" id="vr-sound-icon"></i>
                    <span>ë°°ê²½ìŒì•…</span>
                  </button>
                </div>
                <div class="text-xs text-gray-400">
                  <i class="fas fa-mouse-pointer mr-2"></i>
                  ë§ˆìš°ìŠ¤ë¡œ ë“œë˜ê·¸ | WASD í‚¤ë¡œ ì´ë™
                </div>
              </div>
            </div>
            <div id="vr-scene-container" class="w-full h-full bg-black">
              <!-- A-Frame VR scene will be inserted here -->
              <div class="flex items-center justify-center h-full text-white">
                <div class="text-center">
                  <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-pink-500 mx-auto mb-4"></div>
                  <p>VR ê°¤ëŸ¬ë¦¬ ë¡œë”© ì¤‘...</p>
                </div>
              </div>
            </div>
          </div>
        \`;
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
        
        // Initialize VR gallery with A-Frame
        setTimeout(() => initVRGallery(imageUrl, title), 100);
      };
      
      // VR ê°¤ëŸ¬ë¦¬ ì´ˆê¸°í™” (A-Frame)
      window.initVRGallery = function(imageUrl, title) {
        const container = document.getElementById('vr-scene-container');
        if (!container) return;
        
        // Create A-Frame scene with enhanced features
        container.innerHTML = \`
          <a-scene embedded vr-mode-ui="enabled: true">
            <!-- Sky with gradient effect -->
            <a-sky color="#0a0a0a"></a-sky>
            
            <!-- Gallery floor with grid pattern -->
            <a-plane position="0 0 0" rotation="-90 0 0" width="30" height="30" color="#1a1a1a" 
                     material="roughness: 0.8; metalness: 0.2"></a-plane>
            
            <!-- Gallery walls -->
            <a-box position="0 2.5 -10" width="30" height="5" depth="0.2" color="#0f0f0f"></a-box>
            <a-box position="-15 2.5 5" rotation="0 90 0" width="30" height="5" depth="0.2" color="#0f0f0f"></a-box>
            <a-box position="15 2.5 5" rotation="0 -90 0" width="30" height="5" depth="0.2" color="#0f0f0f"></a-box>
            <a-box position="0 5 5" rotation="90 0 0" width="30" height="30" depth="0.1" color="#0a0a0a"></a-box>
            
            <!-- Main artwork on front wall with frame -->
            <a-box position="0 2.5 -9.8" width="4.2" height="5.2" depth="0.1" color="#8b5cf6"></a-box>
            <a-image src="\${imageUrl}" position="0 2.5 -9.7" width="4" height="5"></a-image>
            <a-text value="\${title}" position="0 0.3 -9.6" width="8" align="center" color="#ffffff" 
                    font="roboto" wrap-count="40"></a-text>
            
            <!-- Side artworks (left wall) -->
            <a-box position="-14.8 2.5 -5" rotation="0 90 0" width="3.2" height="4.2" depth="0.1" color="#06b6d4"></a-box>
            <a-plane position="-14.7 2.5 -5" rotation="0 90 0" width="3" height="4" color="#1a1a1a"></a-plane>
            <a-text value="Gallery" position="-14.6 1.2 -5" rotation="0 90 0" width="6" align="center" 
                    color="#ffffff" font="roboto"></a-text>
            
            <!-- Side artworks (right wall) -->
            <a-box position="14.8 2.5 -5" rotation="0 -90 0" width="3.2" height="4.2" depth="0.1" color="#ec4899"></a-box>
            <a-plane position="14.7 2.5 -5" rotation="0 -90 0" width="3" height="4" color="#1a1a1a"></a-plane>
            <a-text value="Pia" position="14.6 1.2 -5" rotation="0 -90 0" width="6" align="center" 
                    color="#ffffff" font="roboto"></a-text>
            
            <!-- Enhanced Lighting -->
            <a-light type="ambient" intensity="0.4" color="#ffffff"></a-light>
            <a-light type="directional" intensity="0.6" position="5 10 5" color="#ffffff"></a-light>
            <a-light type="point" intensity="1.2" position="0 4 -8" color="#8b5cf6" distance="15"></a-light>
            <a-light type="point" intensity="0.8" position="-12 4 0" color="#06b6d4" distance="12"></a-light>
            <a-light type="point" intensity="0.8" position="12 4 0" color="#ec4899" distance="12"></a-light>
            <a-light type="point" intensity="0.5" position="0 3 8" color="#ffffff" distance="10"></a-light>
            
            <!-- Decorative elements -->
            <a-cylinder position="-5 2 -8" radius="0.3" height="4" color="#8b5cf6" opacity="0.5"></a-cylinder>
            <a-cylinder position="5 2 -8" radius="0.3" height="4" color="#06b6d4" opacity="0.5"></a-cylinder>
            <a-sphere position="0 4.5 -8" radius="0.5" color="#ec4899" opacity="0.6" 
                      animation="property: rotation; to: 0 360 0; loop: true; dur: 8000"></a-sphere>
            
            <!-- Floor markers -->
            <a-ring position="0 0.01 3" rotation="-90 0 0" radius-inner="0.8" radius-outer="1" 
                    color="#8b5cf6" opacity="0.5"></a-ring>
            <a-text value="START" position="0 0.02 3" rotation="-90 0 0" width="3" align="center" 
                    color="#ffffff" font="roboto"></a-text>
            
            <!-- Camera with enhanced controls -->
            <a-entity camera look-controls wasd-controls position="0 1.6 8">
              <a-cursor color="#8b5cf6" opacity="0.8" fuse="true" fuse-timeout="1500"></a-cursor>
            </a-entity>
          </a-scene>
        \`;
        
        showSuccessToast('VR ê°¤ëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. WASD í‚¤ë¡œ ì´ë™í•˜ì„¸ìš”!');
      };
      
      // VR ëª¨ë“œ ì§„ì…
      window.enterVRMode = function() {
        const scene = document.querySelector('a-scene');
        if (scene && scene.enterVR) {
          scene.enterVR();
        } else {
          showInfoToast('VR í—¤ë“œì…‹ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë§ˆìš°ìŠ¤ë¡œ ë‘˜ëŸ¬ë³´ì„¸ìš”.');
        }
      };
      
      // VR ì‚¬ìš´ë“œ í† ê¸€
      window.toggleVRSound = function() {
        const icon = document.getElementById('vr-sound-icon');
        if (icon) {
          if (icon.classList.contains('fa-volume-up')) {
            icon.classList.remove('fa-volume-up');
            icon.classList.add('fa-volume-mute');
            showInfoToast('ë°°ê²½ìŒì•…ì´ êº¼ì¡ŒìŠµë‹ˆë‹¤');
          } else {
            icon.classList.remove('fa-volume-mute');
            icon.classList.add('fa-volume-up');
            showInfoToast('ë°°ê²½ìŒì•…ì´ ì¼œì¡ŒìŠµë‹ˆë‹¤');
          }
        }
      };
      
      // VR ê°¤ëŸ¬ë¦¬ ë‹«ê¸°
      window.closeVRGallery = function() {
        const modal = document.getElementById('vr-gallery-modal');
        if (modal) {
          modal.remove();
          document.body.style.overflow = '';
        }
      };
      
      // ============================================
      // Mobile Menu Functions
      // ============================================
      
      const mobileMenuButton = document.getElementById('mobileMenuButton');
      const mobileMenu = document.getElementById('mobileMenu');
      const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
      const closeMobileMenu = document.getElementById('closeMobileMenu');
      
      function openMobileMenu() {
        mobileMenu.classList.remove('translate-x-full');
        mobileMenuOverlay.classList.remove('opacity-0', 'pointer-events-none');
        document.body.style.overflow = 'hidden';
      }
      
      function closeMobileMenuFunc() {
        mobileMenu.classList.add('translate-x-full');
        mobileMenuOverlay.classList.add('opacity-0', 'pointer-events-none');
        document.body.style.overflow = '';
      }
      
      if (mobileMenuButton) {
        mobileMenuButton.addEventListener('click', openMobileMenu);
      }
      
      if (closeMobileMenu) {
        closeMobileMenu.addEventListener('click', closeMobileMenuFunc);
      }
      
      if (mobileMenuOverlay) {
        mobileMenuOverlay.addEventListener('click', closeMobileMenuFunc);
      }
      
      // ëª¨ë°”ì¼ ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
      function updateMobileUserInfo() {
        const token = localStorage.getItem('auth_token');
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        
        const mobileUserInfo = document.getElementById('mobileUserInfo');
        const mobileAuthMenu = document.getElementById('mobileAuthMenu');
        const mobileGuestMenu = document.getElementById('mobileGuestMenu');
        
        if (token && user) {
          // ë¡œê·¸ì¸ ìƒíƒœ
          if (mobileUserInfo) {
            mobileUserInfo.classList.remove('hidden');
            document.getElementById('mobileUserInitial').textContent = (user.full_name || 'U').charAt(0).toUpperCase();
            document.getElementById('mobileUserName').textContent = user.full_name || '\uc0ac\uc6a9\uc790';
            document.getElementById('mobileUserEmail').textContent = user.email || '';
          }
          if (mobileAuthMenu) mobileAuthMenu.classList.remove('hidden');
          if (mobileGuestMenu) mobileGuestMenu.classList.add('hidden');
          
          // ëª¨ë°”ì¼ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
          const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
          if (mobileLogoutBtn) {
            mobileLogoutBtn.addEventListener('click', async () => {
              try {
                await fetch('/api/auth/logout', {
                  method: 'POST',
                  headers: { 'Authorization': \`Bearer \${token}\` }
                });
              } catch (error) {
                console.error('\ub85c\uadf8\uc544\uc6c3 \uc2e4\ud328:', error);
              } finally {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user');
                window.location.href = '/';
              }
            });
          }
        } else {
          // ë¹„ë¡œê·¸ì¸ ìƒíƒœ
          if (mobileUserInfo) mobileUserInfo.classList.add('hidden');
          if (mobileAuthMenu) mobileAuthMenu.classList.add('hidden');
          if (mobileGuestMenu) mobileGuestMenu.classList.remove('hidden');
        }
      }
      
      updateMobileUserInfo();
      
      // ============================================
      // Touch Gesture Support (Swipe to close mobile menu)
      // ============================================
      
      let touchStartX = 0;
      let touchEndX = 0;
      
      if (mobileMenu) {
        mobileMenu.addEventListener('touchstart', (e) => {
          touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });
        
        mobileMenu.addEventListener('touchend', (e) => {
          touchEndX = e.changedTouches[0].screenX;
          handleSwipe();
        }, { passive: true });
      }
      
      function handleSwipe() {
        // Swipe right to close (threshold: 50px)
        if (touchEndX - touchStartX > 50) {
          closeMobileMenuFunc();
        }
      }
      
      // ============================================
      // Responsive Improvements
      // ============================================
      
      // Detect if mobile device
      window.isMobileDevice = function() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      }
      
      // Viewport height fix for mobile browsers (address bar issue)
      function setViewportHeight() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', \`\${vh}px\`);
      }
      
      setViewportHeight();
      window.addEventListener('resize', setViewportHeight);
      
      // Prevent zoom on double tap (iOS Safari)
      let lastTouchEnd = 0;
      document.addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) {
          e.preventDefault();
        }
        lastTouchEnd = now;
      }, { passive: false });
    </script>
    
    <!-- Phase 8: Production Monitoring & Error Tracking -->
    <!-- Sentry Browser SDK -->
    <script
      src="https://browser.sentry-cdn.com/8.45.0/bundle.min.js"
      integrity="sha384-/x1aHz0nKRd6zVUazsV6CbQvjJvr6zQL2CHbQZaiQnd3Ybp8tLbSMl7rZH4dWvUx"
      crossorigin="anonymous"
    ></script>
    <script>
      if (window.Sentry) {
        Sentry.init({
          dsn: "${typeof process !== 'undefined' && process.env?.SENTRY_DSN ? process.env.SENTRY_DSN : ''}",
          environment: "${typeof process !== 'undefined' && process.env?.NODE_ENV ? process.env.NODE_ENV : 'development'}",
          tracesSampleRate: 0.1,
          replaysSessionSampleRate: 0.1,
          replaysOnErrorSampleRate: 1.0,
          integrations: [
            Sentry.replayIntegration({
              maskAllText: false,
              blockAllMedia: false,
            }),
          ],
        });
      }
    </script>
    
    <!-- Performance & Error Monitoring -->
    <script src="/static/monitoring.js"></script>
    
    <!-- i18n (Internationalization) - L3-6 -->
    <script src="/static/i18n.js"></script>
    
    <!-- Advanced AI Search - L3-7 -->
    <script src="/static/advanced-search.js"></script>
    
    <!-- Blockchain Minting Integration - L3-8 -->
    <script src="/static/blockchain-minting.js"></script>
    
    <!-- Realtime Chat System - L4-1 -->
    <script src="/static/realtime-chat.js"></script>
    
    <!-- Notification System - L4-2 -->
    <script src="/static/notification-system.js"></script>
    
    <!-- Level 4: Advanced Features -->
    <script src="/static/advanced-analytics-v2.js"></script> <!-- L4-3 -->
    <script src="/static/artwork-comparison.js"></script> <!-- L4-4 -->
    <script src="/static/collection-manager.js"></script> <!-- L4-5 -->
    <script src="/static/social-share.js"></script> <!-- L4-6 -->
    <script src="/static/price-prediction-ai.js"></script> <!-- L4-7 -->
    <script src="/static/blockchain-provenance.js"></script> <!-- L4-8 -->
    <script src="/static/advanced-filtering.js"></script> <!-- L4-9 -->
    <script src="/static/artwork-timeline.js"></script> <!-- L4-10 -->
    <script src="/static/proxy-bidding.js"></script> <!-- L4-11 -->
    <script src="/static/appraisal-request.js"></script> <!-- L4-12 -->
    <script src="/static/portfolio-tracker.js"></script> <!-- L4-13 -->
    <script src="/static/image-similarity.js"></script> <!-- L4-14 -->
    <script src="/static/certificate-generator.js"></script> <!-- L4-15 -->
    <script src="/static/email-notifications.js"></script> <!-- L4-16 -->
    <script src="/static/accessibility-wcag.js"></script> <!-- L4-17 -->
    
    <!-- Level 5: Innovation Features -->
    <script src="/static/ai-art-generator.js"></script> <!-- L5-1 -->
    <script src="/static/voice-search.js"></script> <!-- L5-2 -->
    <script src="/static/gesture-control.js"></script> <!-- L5-3 -->
    <script src="/static/emotion-recommendation.js"></script> <!-- L5-4 -->
    <script src="/static/ai-storyteller.js"></script> <!-- L5-5 -->
    <script src="/static/virtual-exhibition.js"></script> <!-- L5-6 -->
    <script src="/static/nft-fractionalization.js"></script> <!-- L5-7 -->
    <script src="/static/dao-governance.js"></script> <!-- L5-8 -->
    <script src="/static/nft-staking.js"></script> <!-- L5-9 -->
    <script src="/static/crosschain-bridge.js"></script> <!-- L5-10 -->
    <script src="/static/ai-curator.js"></script> <!-- L5-11 -->
    <script src="/static/live-auction.js"></script> <!-- L5-12 -->
    <script src="/static/lidar-upload.js"></script> <!-- L5-13 -->
    <script src="/static/ar-home-simulation.js"></script> <!-- L5-14 -->
    <script src="/static/blockchain-royalty.js"></script> <!-- L5-15 -->
    <script src="/static/metaverse-integration.js"></script> <!-- L5-16 -->
    
    <!-- v11.1: UX/UI Improvements & Security Fixes -->
    <script src="/static/form-validation.js"></script> <!-- Real-time validation -->
    <script src="/static/loading-skeleton.js"></script> <!-- Loading states -->
    <script src="/static/toast-system.js"></script> <!-- Toast notifications -->
    
    <!-- Phase 6: UX Enhancement Scripts -->
    <!-- ì„±ëŠ¥ ìµœì í™” (í•„ìˆ˜) -->
    <script src="/static/performance-optimizer.js"></script>
    
    <!-- í…Œë§ˆ ë° ì ‘ê·¼ì„± (í•„ìˆ˜) -->
    <script src="/static/theme-customizer.js"></script>
    <script src="/static/accessibility-panel.js"></script>
    <link rel="stylesheet" href="/static/high-contrast.css" media="(prefers-contrast: high)">
    <link rel="stylesheet" href="/static/text-accessibility.css">
    
    <!-- í˜ì´ì§€ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ (í•„ìˆ˜) -->
    <script src="/static/page-transitions.js"></script>
    <link rel="stylesheet" href="/static/page-transitions.css">
    
    <!-- ë§ˆì´í¬ë¡œ ì• ë‹ˆë©”ì´ì…˜ (ì„ íƒ) -->
    <link rel="stylesheet" href="/static/micro-animations.css">
    <script src="/static/interaction-animations.js"></script>
    
    <!-- ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // ì„±ëŠ¥ ìµœì í™” ì´ˆê¸°í™”
        if (window.PerformanceOptimizer) {
          const perfOptimizer = new window.PerformanceOptimizer();
          perfOptimizer.init();
        }
        
        // í…Œë§ˆ ì´ˆê¸°í™”
        if (window.ThemeCustomizer) {
          const themeCustomizer = new window.ThemeCustomizer();
          themeCustomizer.loadPreferences();
        }
        
        // ì ‘ê·¼ì„± íŒ¨ë„ ì´ˆê¸°í™”
        if (window.AccessibilityPanel) {
          const accessibilityPanel = new window.AccessibilityPanel();
          accessibilityPanel.init();
        }
        
        // í˜ì´ì§€ ì „í™˜ ì´ˆê¸°í™”
        if (window.PageTransitionManager) {
          const pageTransitions = new window.PageTransitionManager();
          pageTransitions.init();
        }
        
        // ìƒí˜¸ì‘ìš© ì• ë‹ˆë©”ì´ì…˜ ì´ˆê¸°í™”
        if (window.LikeButtonManager) {
          const likeManager = new window.LikeButtonManager();
          likeManager.init();
        }
        
        // í”„ë¡œë•ì…˜ ëª¨ë‹ˆí„°ë§ ì´ˆê¸°í™” (Phase 8)
        if (window.PerformanceMonitor) {
          const perfMonitor = new window.PerformanceMonitor();
          console.log('âœ… Production monitoring initialized');
        }
      });
    </script>
</body>
</html>
  `;
}

// ============================================
// ì¸ì¦ API
// ============================================

// Helper: Generate session token
function generateSessionToken(): string {
  return crypto.randomUUID() + '-' + Date.now().toString(36)
}

// Helper: Verify session
async function verifyUserSession(db: any, token: string) {
  const result = await db.prepare(`
    SELECT us.*, u.* 
    FROM user_sessions us
    JOIN users u ON us.user_id = u.id
    WHERE us.session_token = ? AND us.expires_at > datetime('now')
  `).bind(token).first()
  
  return result
}

// Check Email Availability API (for real-time validation)
app.get('/api/auth/check-email', async (c) => {
  const db = c.env.DB
  
  try {
    const email = c.req.query('email')
    
    if (!email) {
      return c.json({ success: false, error: 'ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”' }, 400)
    }
    
    // Normalize email
    const normalizedEmail = email.toLowerCase().trim()
    
    // Check if email exists
    const existingUser = await db.prepare(`
      SELECT id FROM users WHERE LOWER(email) = ?
    `).bind(normalizedEmail).first()
    
    return c.json({ 
      success: true,
      exists: !!existingUser,
      available: !existingUser
    })
  } catch (error: any) {
    console.error('Check email error:', error)
    return c.json({ success: false, error: 'ì´ë©”ì¼ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// Signup API
app.post('/api/auth/signup', async (c) => {
  const db = c.env.DB
  
  try {
    const { 
      email, password, password_hash, username, full_name, role, phone, website, bio,
      organization_name, organization_type, organization_description,
      organization_address, organization_website, organization_contact_email, organization_phone
    } = await c.req.json()
    
    // Validation - detailed error messages
    const missingFields = []
    if (!email) missingFields.push('ì´ë©”ì¼')
    if (!password && !password_hash) missingFields.push('ë¹„ë°€ë²ˆí˜¸')
    if (!username) missingFields.push('ì‚¬ìš©ìëª…')
    if (!full_name) missingFields.push('ì´ë¦„')
    if (!role) missingFields.push('ê³„ì • ìœ í˜•')
    
    if (missingFields.length > 0) {
      return c.json({ 
        success: false, 
        error: `í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”: ${missingFields.join(', ')}` 
      }, 400)
    }
    
    // Password strength validation (backend)
    if (password) {
      const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/
      if (!passwordRegex.test(password)) {
        return c.json({ 
          success: false, 
          error: 'ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒ, ëŒ€ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤' 
        }, 400)
      }
    }
    
    // Hash password with bcrypt (SECURITY FIX)
    const finalPasswordHash = password_hash || await bcrypt.hash(password, 10)
    
    // Check if email/username already exists
    const existing = await db.prepare(`
      SELECT id FROM users WHERE email = ? OR username = ?
    `).bind(email, username).first()
    
    if (existing) {
      return c.json({ success: false, error: 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ ë˜ëŠ” ì‚¬ìš©ìëª…ì…ë‹ˆë‹¤' }, 400)
    }
    
    // Insert user with organization fields
    const result = await db.prepare(`
      INSERT INTO users (
        email, password_hash, username, full_name, role, phone, website, bio,
        organization_name, organization_type, organization_description, 
        organization_address, organization_website, organization_contact_email, organization_phone,
        is_verified, is_active, created_at
      )
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 0, 1, datetime('now'))
    `).bind(
      email, finalPasswordHash, username, full_name, role,
      phone || null, website || null, bio || null,
      organization_name || null, organization_type || null, organization_description || null,
      organization_address || null, organization_website || null, 
      organization_contact_email || null, organization_phone || null
    ).run()
    
    const userId = result.meta.last_row_id
    
    // Add role to user_roles table
    await db.prepare(`
      INSERT INTO user_roles (user_id, role, is_active, granted_at)
      VALUES (?, ?, 1, datetime('now'))
    `).bind(userId, role).run()
    
    // If artist, create artist profile
    if (role === 'artist') {
      await db.prepare(`
        INSERT INTO artist_profiles (user_id, art_style, major_medium, created_at)
        VALUES (?, ?, ?, datetime('now'))
      `).bind(userId, '', '').run()
    }
    
    // If museum or gallery, initialize counts and submit partnership application
    if (role === 'museum' || role === 'gallery') {
      await db.prepare(`
        UPDATE users 
        SET curator_count = 0, exhibition_count = 0
        WHERE id = ?
      `).bind(userId).run()
      
      // Auto-submit partnership application
      const partnerCategory = role === 'museum' ? 'museum' : 'gallery'
      await db.prepare(`
        INSERT INTO museum_partnership_applications (
          partner_category, applicant_name, applicant_email, museum_name, museum_type,
          museum_country, partnership_reason, application_status, submitted_at
        ) VALUES (?, ?, ?, ?, ?, 'KR', ?, 'submitted', datetime('now'))
      `).bind(
        partnerCategory,
        full_name,
        email,
        organization_name || `${full_name}ì˜ ${role === 'museum' ? 'ë¯¸ìˆ ê´€' : 'ê°¤ëŸ¬ë¦¬'}`,
        'other',
        `íšŒì›ê°€ì…ê³¼ í•¨ê»˜ ${role === 'museum' ? 'ë¯¸ìˆ ê´€' : 'ê°¤ëŸ¬ë¦¬'} íŒŒíŠ¸ë„ˆì‹­ì„ ì‹ ì²­í•©ë‹ˆë‹¤.`
      ).run()
    }
    
    // If expert, set evaluator status to inactive (requires approval)
    if (role === 'expert') {
      await db.prepare(`
        UPDATE users 
        SET evaluator_status = 'inactive', evaluator_rank = NULL
        WHERE id = ?
      `).bind(userId).run()
    }
    
    // Log activity
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, details, created_at)
      VALUES (?, 'signup', 'user', ?, datetime('now'))
    `).bind(userId, JSON.stringify({ 
      role, 
      email,
      is_organization: role === 'museum' || role === 'gallery',
      organization_name: organization_name || null
    })).run()
    
    // Success message based on role
    let successMessage = 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤'
    if (role === 'museum' || role === 'gallery') {
      const categoryName = role === 'museum' ? 'ë¯¸ìˆ ê´€' : 'ê°¤ëŸ¬ë¦¬'
      successMessage = `íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ${categoryName} íŒŒíŠ¸ë„ˆì‹­ ì‹ ì²­ì´ ìë™ìœ¼ë¡œ ì œì¶œë˜ì—ˆìœ¼ë©°, ê´€ë¦¬ì ê²€í†  í›„ ìŠ¹ì¸ë©ë‹ˆë‹¤.`
    }
    
    // ì›°ì»´ ì´ë©”ì¼ ë°œì†¡ (ë¹„ë™ê¸°, ì‹¤íŒ¨í•´ë„ íšŒì›ê°€ì…ì€ ì„±ê³µ)
    try {
      const welcomeEmail = getWelcomeEmail(full_name || username)
      await sendEmail(c.env.SENDGRID_API_KEY, {
        to: email,
        toName: full_name || username,
        subject: welcomeEmail.subject,
        html: welcomeEmail.html,
        text: welcomeEmail.text
      })
    } catch (emailError) {
      console.error('Failed to send welcome email:', emailError)
      // ì´ë©”ì¼ ì‹¤íŒ¨ëŠ” ë¬´ì‹œí•˜ê³  íšŒì›ê°€ì…ì€ ì„±ê³µ ì²˜ë¦¬
    }
    
    return c.json({ 
      success: true, 
      message: successMessage,
      user_id: userId,
      role: role,
      partnership_auto_submitted: role === 'museum' || role === 'gallery',
      next_action: role === 'expert' ? 'admin_approval_required' : 'login_now',
      redirect_url: '/login',
      toast_type: 'success'
    }, 201)
  } catch (error: any) {
    console.error('Signup error:', error)
    return c.json({ success: false, error: error.message || 'íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// Login API
app.post('/api/auth/login', async (c) => {
  const db = c.env.DB
  
  try {
    const { email, password, password_hash } = await c.req.json()
    
    if (!email || (!password && !password_hash)) {
      return c.json({ success: false, error: 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”' }, 400)
    }
    
    // Find user by email only
    const userResult = await db.prepare(`
      SELECT * FROM users WHERE email = ? AND is_active = 1
    `).bind(email).first()
    
    if (!userResult) {
      return c.json({ success: false, error: 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤' }, 401)
    }
    
    const user = userResult as any
    
    // Verify password with bcrypt (SECURITY FIX)
    const isValidPassword = password_hash 
      ? password_hash === user.password_hash // Backward compatibility for old hashed passwords
      : await bcrypt.compare(password, user.password_hash)
    
    if (!isValidPassword) {
      return c.json({ success: false, error: 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤' }, 401)
    }
    
    // Generate session token
    const sessionToken = generateSessionToken()
    const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7 days
    
    // Create session
    await db.prepare(`
      INSERT INTO user_sessions (user_id, session_token, expires_at, created_at)
      VALUES (?, ?, ?, datetime('now'))
    `).bind(user.id, sessionToken, expiresAt.toISOString()).run()
    
    // Update last login
    await db.prepare(`
      UPDATE users SET last_login_at = datetime('now') WHERE id = ?
    `).bind(user.id).run()
    
    // Log activity
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, created_at)
      VALUES (?, 'login', 'user', datetime('now'))
    `).bind(user.id).run()
    
    // Set HttpOnly cookie (SECURITY FIX: XSS prevention)
    c.header('Set-Cookie', `session_token=${sessionToken}; HttpOnly; Secure; SameSite=Strict; Path=/; Max-Age=${7 * 24 * 60 * 60}`)
    
    return c.json({ 
      success: true, 
      message: 'ë¡œê·¸ì¸ ì„±ê³µ',
      user: {
        id: Number(user.id),
        email: String(user.email),
        username: String(user.username),
        full_name: String(user.full_name),
        role: String(user.role),
        profile_image: user.profile_image ? String(user.profile_image) : null,
        is_verified: Boolean(user.is_verified)
      }
    })
  } catch (error: any) {
    console.error('Login error:', error)
    return c.json({ success: false, error: 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// Logout API
app.post('/api/auth/logout', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, error: 'ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤' }, 401)
  }
  
  try {
    // Delete session
    await db.prepare(`
      DELETE FROM user_sessions WHERE session_token = ?
    `).bind(token).run()
    
    return c.json({ success: true, message: 'ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤' })
  } catch (error: any) {
    return c.json({ success: false, error: 'ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// Admin routes (requires admin role)
app.route('/api/admin', admin)

// Notification routes
app.route('/api/notifications', notifications)

// Analytics routes
app.route('/api/analytics', analytics)

// Recommendation routes
app.route('/api/recommendations', recommendations)

// SEO routes (sitemap, robots, schema)
app.route('/', seo)

// ============================================
// ğŸ¤– Phase 10.5: AI Price Prediction API
// ============================================
import { predictArtworkPrice, batchPredictPrices, predictPriceTrend, type ArtworkFeatures } from './utils/price-prediction'

// Predict single artwork price
app.post('/api/price-prediction/predict', async (c) => {
  try {
    const features: ArtworkFeatures = await c.req.json()
    
    // Validate required fields
    if (!features.artist_achievement_score || !features.content_depth_score) {
      return c.json({ error: 'Missing required fields' }, 400)
    }
    
    // Get historical data for better prediction
    const db = c.env.DB
    const historicalData = await db.prepare(`
      SELECT category, current_price as price, created_at
      FROM artworks
      WHERE created_at >= datetime('now', '-30 days')
        AND current_price > 0
      ORDER BY created_at DESC
      LIMIT 100
    `).all()
    
    const prediction = predictArtworkPrice(features, historicalData.results || [])
    
    return c.json({ prediction })
  } catch (error: any) {
    console.error('âŒ Price prediction error:', error)
    return c.json({ error: 'Failed to predict price' }, 500)
  }
})

// Batch predict multiple artworks
app.post('/api/price-prediction/batch', async (c) => {
  try {
    const { artworks } = await c.req.json()
    
    if (!Array.isArray(artworks) || artworks.length === 0) {
      return c.json({ error: 'Invalid artworks array' }, 400)
    }
    
    if (artworks.length > 50) {
      return c.json({ error: 'Maximum 50 artworks per batch' }, 400)
    }
    
    const db = c.env.DB
    const historicalData = await db.prepare(`
      SELECT category, current_price as price, created_at
      FROM artworks
      WHERE created_at >= datetime('now', '-30 days')
        AND current_price > 0
      LIMIT 100
    `).all()
    
    const predictions = batchPredictPrices(artworks, historicalData.results || [])
    
    return c.json({ predictions })
  } catch (error: any) {
    console.error('âŒ Batch prediction error:', error)
    return c.json({ error: 'Failed to predict prices' }, 500)
  }
})

// Predict price trend for an artwork
app.post('/api/price-prediction/trend', async (c) => {
  try {
    const { current_price, features, days = 30 } = await c.req.json()
    
    if (!current_price || !features) {
      return c.json({ error: 'Missing required fields' }, 400)
    }
    
    if (days > 365) {
      return c.json({ error: 'Maximum 365 days for trend prediction' }, 400)
    }
    
    const trend = predictPriceTrend(current_price, features, days)
    
    return c.json({ trend })
  } catch (error: any) {
    console.error('âŒ Trend prediction error:', error)
    return c.json({ error: 'Failed to predict trend' }, 500)
  }
})

// Get price prediction for existing artwork by ID
app.get('/api/price-prediction/artwork/:id', async (c) => {
  try {
    const artworkId = parseInt(c.req.param('id'))
    const db = c.env.DB
    
    // Get artwork details
    const artwork = await db.prepare(`
      SELECT 
        a.*,
        ar.career_years as artist_career_years,
        ar.solo_exhibitions_count as artist_solo_exhibitions,
        ar.group_exhibitions_count as artist_group_exhibitions,
        ar.competition_awards_count as artist_awards,
        (SELECT COUNT(*) FROM expert_evaluations WHERE artwork_id = a.id) as expert_count
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.id = ?
    `).bind(artworkId).first()
    
    if (!artwork) {
      return c.json({ error: 'Artwork not found' }, 404)
    }
    
    // Prepare features
    const features: ArtworkFeatures = {
      artist_achievement_score: Number(artwork.artist_achievement_score) || 0,
      artist_career_years: Number(artwork.artist_career_years) || 0,
      artist_solo_exhibitions: Number(artwork.artist_solo_exhibitions) || 0,
      artist_group_exhibitions: Number(artwork.artist_group_exhibitions) || 0,
      artist_awards: Number(artwork.artist_awards) || 0,
      content_depth_score: Number(artwork.content_depth_score) || 0,
      expression_score: Number(artwork.expression_score) || 0,
      originality_innovation_score: Number(artwork.originality_innovation_score) || 0,
      collection_value_score: Number(artwork.collection_value_score) || 0,
      certification_score: Number(artwork.certification_score) || 0,
      expert_evaluation_score: Number(artwork.expert_evaluation_final_score) || 0,
      expert_count: Number(artwork.expert_count) || 0,
      popularity_score: Number(artwork.popularity_score) || 0,
      views_count: Number(artwork.views_count) || 0,
      likes_count: Number(artwork.likes_count) || 0,
      category: String(artwork.category),
      size_cm2: (Number(artwork.size_width) || 0) * (Number(artwork.size_height) || 0),
      creation_year: Number(artwork.creation_year) || undefined
    }
    
    // Get historical data
    const historicalData = await db.prepare(`
      SELECT category, current_price as price, created_at
      FROM artworks
      WHERE category = ?
        AND created_at >= datetime('now', '-30 days')
        AND current_price > 0
      LIMIT 50
    `).bind(artwork.category).all()
    
    const prediction = predictArtworkPrice(features, historicalData.results || [])
    
    return c.json({ 
      artwork: {
        id: artwork.id,
        title: artwork.title,
        current_price: Number(artwork.current_price) || 0
      },
      prediction 
    })
  } catch (error: any) {
    console.error('âŒ Artwork price prediction error:', error)
    return c.json({ error: 'Failed to predict artwork price' }, 500)
  }
})

// Get current user info
app.get('/api/auth/me', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, error: 'ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifyUserSession(db, token)
    
    if (!session) {
      return c.json({ success: false, error: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    return c.json({ 
      success: true,
      user: {
        id: session.id,
        email: session.email,
        username: session.username,
        full_name: session.full_name,
        role: session.role,
        profile_image: session.profile_image,
        bio: session.bio,
        is_verified: session.is_verified
      }
    })
  } catch (error: any) {
    return c.json({ success: false, error: 'ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ============================================
// ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°/ì¬ì„¤ì • API
// ============================================

// Request password reset
app.post('/api/auth/forgot-password', async (c) => {
  const db = c.env.DB
  
  try {
    const { email } = await c.req.json()
    
    if (!email) {
      return c.json({ success: false, error: 'ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”' }, 400)
    }
    
    // Check if user exists
    const user = await db.prepare(`
      SELECT id, email, full_name FROM users WHERE email = ? AND is_active = 1
    `).bind(email).first()
    
    if (!user) {
      // Don't reveal if email exists or not for security
      return c.json({ 
        success: true, 
        message: 'ì´ë©”ì¼ì´ ë“±ë¡ë˜ì–´ ìˆë‹¤ë©´ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë§í¬ë¥¼ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.' 
      })
    }
    
    // Generate reset token
    const resetToken = generateSessionToken()
    const expiresAt = new Date(Date.now() + 60 * 60 * 1000) // 1 hour
    
    // Save reset token
    await db.prepare(`
      INSERT INTO password_reset_tokens (user_id, token, expires_at, created_at)
      VALUES (?, ?, ?, datetime('now'))
    `).bind(user.id, resetToken, expiresAt.toISOString()).run()
    
    // In production, send email here
    // For now, return token in response (development only)
    console.log('Reset token for ' + email + ': ' + resetToken)
    
    // Log activity
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, details, created_at)
      VALUES (?, 'password_reset_request', 'user', ?, datetime('now'))
    `).bind(user.id, JSON.stringify({ email })).run()
    
    return c.json({ 
      success: true, 
      message: 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë§í¬ê°€ ì´ë©”ì¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
      // Development only - remove in production
      reset_link: '/reset-password?token=' + resetToken
    })
  } catch (error: any) {
    console.error('Forgot password error:', error)
    return c.json({ success: false, error: 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// Reset password
app.post('/api/auth/reset-password', async (c) => {
  const db = c.env.DB
  
  try {
    const { token, password_hash } = await c.req.json()
    
    if (!token || !password_hash) {
      return c.json({ success: false, error: 'í† í°ê³¼ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”' }, 400)
    }
    
    // Verify token
    const resetToken = await db.prepare(`
      SELECT * FROM password_reset_tokens 
      WHERE token = ? AND used = 0 AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!resetToken) {
      return c.json({ success: false, error: 'ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œëœ í† í°ì…ë‹ˆë‹¤' }, 400)
    }
    
    // Update password
    await db.prepare(`
      UPDATE users SET password_hash = ?, updated_at = datetime('now')
      WHERE id = ?
    `).bind(password_hash, resetToken.user_id).run()
    
    // Mark token as used
    await db.prepare(`
      UPDATE password_reset_tokens SET used = 1, used_at = datetime('now')
      WHERE id = ?
    `).bind(resetToken.id).run()
    
    // Invalidate all existing sessions for security
    await db.prepare(`
      DELETE FROM user_sessions WHERE user_id = ?
    `).bind(resetToken.user_id).run()
    
    // Log activity
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, created_at)
      VALUES (?, 'password_reset', 'user', datetime('now'))
    `).bind(resetToken.user_id).run()
    
    return c.json({ 
      success: true, 
      message: 'ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.' 
    })
  } catch (error: any) {
    console.error('Reset password error:', error)
    return c.json({ success: false, error: 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ============================================
// MetaMask Login API
// ============================================
app.post('/api/auth/metamask-login', async (c) => {
  const db = c.env.DB
  
  try {
    const { wallet_address, signature, message } = await c.req.json()
    
    if (!wallet_address || !signature || !message) {
      return c.json({ success: false, error: 'ì§€ê°‘ ì£¼ì†Œì™€ ì„œëª…ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 400)
    }
    
    // In production, verify signature here using ethers.js or web3.js
    // For now, we'll skip signature verification for simplicity
    
    // Check if user exists with this wallet
    let user = await db.prepare(`
      SELECT * FROM users WHERE wallet_address = ? AND is_active = 1
    `).bind(wallet_address).first()
    
    // If user doesn't exist, create new user
    if (!user) {
      const username = `user_${wallet_address.substring(0, 8)}`
      const fullName = `User ${wallet_address.substring(0, 8)}`
      
      const result = await db.prepare(`
        INSERT INTO users (
          email, username, full_name, wallet_address, role, 
          is_verified, is_active, created_at
        ) VALUES (?, ?, ?, ?, 'buyer', 1, 1, datetime('now'))
      `).bind(
        `${wallet_address}@metamask.wallet`,
        username,
        fullName,
        wallet_address
      ).run()
      
      const userId = result.meta.last_row_id
      
      // Add role
      await db.prepare(`
        INSERT INTO user_roles (user_id, role, is_active, granted_at)
        VALUES (?, 'buyer', 1, datetime('now'))
      `).bind(userId).run()
      
      // Log activity
      await db.prepare(`
        INSERT INTO activity_logs (user_id, action_type, entity_type, details, created_at)
        VALUES (?, 'metamask_signup', 'user', ?, datetime('now'))
      `).bind(userId, JSON.stringify({ wallet_address })).run()
      
      // Fetch newly created user
      user = await db.prepare(`
        SELECT * FROM users WHERE id = ?
      `).bind(userId).first()
    }
    
    // Generate session token
    const sessionToken = generateSessionToken()
    const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7 days
    
    // Create session
    await db.prepare(`
      INSERT INTO user_sessions (user_id, session_token, expires_at, created_at)
      VALUES (?, ?, ?, datetime('now'))
    `).bind(user.id, sessionToken, expiresAt.toISOString()).run()
    
    // Update last login
    await db.prepare(`
      UPDATE users SET last_login_at = datetime('now') WHERE id = ?
    `).bind(user.id).run()
    
    // Log activity
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, created_at)
      VALUES (?, 'metamask_login', 'user', datetime('now'))
    `).bind(user.id).run()
    
    return c.json({ 
      success: true, 
      message: 'MetaMask ë¡œê·¸ì¸ ì„±ê³µ',
      session_token: sessionToken,
      user: {
        id: user.id,
        email: user.email,
        username: user.username,
        full_name: user.full_name,
        role: user.role,
        wallet_address: user.wallet_address,
        profile_image: user.profile_image,
        is_verified: user.is_verified
      }
    })
  } catch (error: any) {
    console.error('MetaMask login error:', error)
    return c.json({ success: false, error: 'MetaMask ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ============================================
// Google OAuth Login API
// ============================================
app.post('/api/auth/google-login', async (c) => {
  const db = c.env.DB
  
  try {
    const { google_id, email, name, picture, email_verified } = await c.req.json()
    
    if (!google_id || !email) {
      return c.json({ success: false, error: 'Google ê³„ì • ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤' }, 400)
    }
    
    // Check if user exists with this Google ID or email
    let user = await db.prepare(`
      SELECT * FROM users WHERE google_id = ? OR email = ? AND is_active = 1
    `).bind(google_id, email).first()
    
    // If user doesn't exist, create new user
    if (!user) {
      const username = 'google_' + google_id.substring(0, 10)
      const fullName = name || 'Google User'
      
      const result = await db.prepare(`
        INSERT INTO users (
          email, username, full_name, google_id, profile_image, role, 
          is_verified, is_active, created_at
        ) VALUES (?, ?, ?, ?, ?, 'buyer', ?, 1, datetime('now'))
      `).bind(
        email,
        username,
        fullName,
        google_id,
        picture || null,
        email_verified ? 1 : 0
      ).run()
      
      const userId = result.meta.last_row_id
      
      // Add role
      await db.prepare(`
        INSERT INTO user_roles (user_id, role, is_active, granted_at)
        VALUES (?, 'buyer', 1, datetime('now'))
      `).bind(userId).run()
      
      // Log activity
      await db.prepare(`
        INSERT INTO activity_logs (user_id, action_type, entity_type, details, created_at)
        VALUES (?, 'google_signup', 'user', ?, datetime('now'))
      `).bind(userId, JSON.stringify({ google_id, email })).run()
      
      // Fetch newly created user
      user = await db.prepare(`
        SELECT * FROM users WHERE id = ?
      `).bind(userId).first()
    } else {
      // Update existing user's Google info if needed
      await db.prepare(`
        UPDATE users 
        SET google_id = ?, profile_image = COALESCE(?, profile_image), 
            is_verified = CASE WHEN ? = 1 THEN 1 ELSE is_verified END,
            updated_at = datetime('now')
        WHERE id = ?
      `).bind(google_id, picture, email_verified ? 1 : 0, user.id).run()
    }
    
    // Generate session token
    const sessionToken = generateSessionToken()
    const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7 days
    
    // Create session
    await db.prepare(`
      INSERT INTO user_sessions (user_id, session_token, expires_at, created_at)
      VALUES (?, ?, ?, datetime('now'))
    `).bind(user.id, sessionToken, expiresAt.toISOString()).run()
    
    // Update last login
    await db.prepare(`
      UPDATE users SET last_login_at = datetime('now') WHERE id = ?
    `).bind(user.id).run()
    
    // Log activity
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, created_at)
      VALUES (?, 'google_login', 'user', datetime('now'))
    `).bind(user.id).run()
    
    return c.json({ 
      success: true, 
      message: 'Google ë¡œê·¸ì¸ ì„±ê³µ',
      session_token: sessionToken,
      user: {
        id: user.id,
        email: user.email,
        username: user.username,
        full_name: user.full_name,
        role: user.role,
        profile_image: user.profile_image,
        is_verified: user.is_verified
      }
    })
  } catch (error: any) {
    console.error('Google login error:', error)
    return c.json({ success: false, error: 'Google ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// Kakao OAuth Login API
app.post('/api/auth/kakao-login', async (c) => {
  const db = c.env.DB
  
  try {
    const { kakao_id, email, name, picture } = await c.req.json()
    
    if (!kakao_id) {
      return c.json({ success: false, error: 'ì¹´ì¹´ì˜¤ ê³„ì • ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤' }, 400)
    }
    
    // Check if user exists with this Kakao ID or email
    let user = await db.prepare(`
      SELECT * FROM users WHERE google_id = ? OR (email = ? AND email IS NOT NULL) AND is_active = 1
    `).bind('kakao_' + kakao_id, email).first()
    
    // If user doesn't exist, create new user
    if (!user) {
      const username = 'kakao_' + kakao_id.toString().substring(0, 10)
      const fullName = name || 'Kakao User'
      const userEmail = email || `kakao_${kakao_id}@kakao.local`
      
      const result = await db.prepare(`
        INSERT INTO users (
          email, username, full_name, google_id, profile_image, role, 
          is_verified, is_active, created_at
        ) VALUES (?, ?, ?, ?, ?, 'buyer', 1, 1, datetime('now'))
      `).bind(
        userEmail,
        username,
        fullName,
        'kakao_' + kakao_id,
        picture || null
      ).run()
      
      const userId = result.meta.last_row_id
      
      // Add role
      await db.prepare(`
        INSERT INTO user_roles (user_id, role, is_active, granted_at)
        VALUES (?, 'buyer', 1, datetime('now'))
      `).bind(userId).run()
      
      // Log activity
      await db.prepare(`
        INSERT INTO activity_logs (user_id, action_type, entity_type, details, created_at)
        VALUES (?, 'kakao_signup', 'user', ?, datetime('now'))
      `).bind(userId, JSON.stringify({ kakao_id, email: userEmail })).run()
      
      user = await db.prepare(`SELECT * FROM users WHERE id = ?`).bind(userId).first()
    } else {
      // Update existing user's Kakao info
      await db.prepare(`
        UPDATE users 
        SET google_id = ?, profile_image = COALESCE(?, profile_image), 
            updated_at = datetime('now')
        WHERE id = ?
      `).bind('kakao_' + kakao_id, picture, user.id).run()
    }
    
    // Generate session token
    const sessionToken = generateSessionToken()
    const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
    
    await db.prepare(`
      INSERT INTO user_sessions (user_id, session_token, expires_at, created_at)
      VALUES (?, ?, ?, datetime('now'))
    `).bind(user.id, sessionToken, expiresAt.toISOString()).run()
    
    await db.prepare(`
      UPDATE users SET last_login_at = datetime('now') WHERE id = ?
    `).bind(user.id).run()
    
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, created_at)
      VALUES (?, 'kakao_login', 'user', datetime('now'))
    `).bind(user.id).run()
    
    return c.json({ 
      success: true, 
      message: 'ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì„±ê³µ',
      session_token: sessionToken,
      user: {
        id: user.id,
        email: user.email,
        username: user.username,
        full_name: user.full_name,
        role: user.role,
        profile_image: user.profile_image,
        is_verified: user.is_verified
      }
    })
  } catch (error: any) {
    console.error('Kakao login error:', error)
    return c.json({ success: false, error: 'ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// Naver OAuth Login API
app.post('/api/auth/naver-login', async (c) => {
  const db = c.env.DB
  
  try {
    const { naver_id, email, name, picture } = await c.req.json()
    
    if (!naver_id) {
      return c.json({ success: false, error: 'ë„¤ì´ë²„ ê³„ì • ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤' }, 400)
    }
    
    // Check if user exists
    let user = await db.prepare(`
      SELECT * FROM users WHERE google_id = ? OR (email = ? AND email IS NOT NULL) AND is_active = 1
    `).bind('naver_' + naver_id, email).first()
    
    if (!user) {
      const username = 'naver_' + naver_id.substring(0, 10)
      const fullName = name || 'Naver User'
      const userEmail = email || `naver_${naver_id}@naver.local`
      
      const result = await db.prepare(`
        INSERT INTO users (
          email, username, full_name, google_id, profile_image, role, 
          is_verified, is_active, created_at
        ) VALUES (?, ?, ?, ?, ?, 'buyer', 1, 1, datetime('now'))
      `).bind(
        userEmail,
        username,
        fullName,
        'naver_' + naver_id,
        picture || null
      ).run()
      
      const userId = result.meta.last_row_id
      
      await db.prepare(`
        INSERT INTO user_roles (user_id, role, is_active, granted_at)
        VALUES (?, 'buyer', 1, datetime('now'))
      `).bind(userId).run()
      
      await db.prepare(`
        INSERT INTO activity_logs (user_id, action_type, entity_type, details, created_at)
        VALUES (?, 'naver_signup', 'user', ?, datetime('now'))
      `).bind(userId, JSON.stringify({ naver_id, email: userEmail })).run()
      
      user = await db.prepare(`SELECT * FROM users WHERE id = ?`).bind(userId).first()
    } else {
      await db.prepare(`
        UPDATE users 
        SET google_id = ?, profile_image = COALESCE(?, profile_image), 
            updated_at = datetime('now')
        WHERE id = ?
      `).bind('naver_' + naver_id, picture, user.id).run()
    }
    
    const sessionToken = generateSessionToken()
    const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
    
    await db.prepare(`
      INSERT INTO user_sessions (user_id, session_token, expires_at, created_at)
      VALUES (?, ?, ?, datetime('now'))
    `).bind(user.id, sessionToken, expiresAt.toISOString()).run()
    
    await db.prepare(`
      UPDATE users SET last_login_at = datetime('now') WHERE id = ?
    `).bind(user.id).run()
    
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, created_at)
      VALUES (?, 'naver_login', 'user', datetime('now'))
    `).bind(user.id).run()
    
    return c.json({ 
      success: true, 
      message: 'ë„¤ì´ë²„ ë¡œê·¸ì¸ ì„±ê³µ',
      session_token: sessionToken,
      user: {
        id: user.id,
        email: user.email,
        username: user.username,
        full_name: user.full_name,
        role: user.role,
        profile_image: user.profile_image,
        is_verified: user.is_verified
      }
    })
  } catch (error: any) {
    console.error('Naver login error:', error)
    return c.json({ success: false, error: 'ë„¤ì´ë²„ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// Apple OAuth Login API
app.post('/api/auth/apple-login', async (c) => {
  const db = c.env.DB
  
  try {
    const { apple_id, email, name } = await c.req.json()
    
    if (!apple_id) {
      return c.json({ success: false, error: 'Apple ê³„ì • ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤' }, 400)
    }
    
    // Check if user exists with this Apple ID or email
    let user = await db.prepare(`
      SELECT * FROM users WHERE google_id = ? OR (email = ? AND email IS NOT NULL) AND is_active = 1
    `).bind('apple_' + apple_id, email).first()
    
    // If user doesn't exist, create new user
    if (!user) {
      const username = 'apple_' + apple_id.substring(0, 10)
      const fullName = name || 'Apple User'
      const userEmail = email || `apple_${apple_id}@appleid.local`
      
      const result = await db.prepare(`
        INSERT INTO users (
          email, username, full_name, google_id, role, 
          is_verified, is_active, created_at
        ) VALUES (?, ?, ?, ?, 'buyer', 1, 1, datetime('now'))
      `).bind(
        userEmail,
        username,
        fullName,
        'apple_' + apple_id
      ).run()
      
      const userId = result.meta.last_row_id
      
      // Add role
      await db.prepare(`
        INSERT INTO user_roles (user_id, role, is_active, granted_at)
        VALUES (?, 'buyer', 1, datetime('now'))
      `).bind(userId).run()
      
      // Log activity
      await db.prepare(`
        INSERT INTO activity_logs (user_id, action_type, entity_type, details, created_at)
        VALUES (?, 'apple_signup', 'user', ?, datetime('now'))
      `).bind(userId, JSON.stringify({ apple_id, email: userEmail })).run()
      
      user = await db.prepare(`SELECT * FROM users WHERE id = ?`).bind(userId).first()
    } else {
      // Update existing user's Apple info
      await db.prepare(`
        UPDATE users 
        SET google_id = ?, updated_at = datetime('now')
        WHERE id = ?
      `).bind('apple_' + apple_id, user.id).run()
    }
    
    // Generate session token
    const sessionToken = generateSessionToken()
    const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
    
    await db.prepare(`
      INSERT INTO user_sessions (user_id, session_token, expires_at, created_at)
      VALUES (?, ?, ?, datetime('now'))
    `).bind(user.id, sessionToken, expiresAt.toISOString()).run()
    
    await db.prepare(`
      UPDATE users SET last_login_at = datetime('now') WHERE id = ?
    `).bind(user.id).run()
    
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, created_at)
      VALUES (?, 'apple_login', 'user', datetime('now'))
    `).bind(user.id).run()
    
    return c.json({ 
      success: true, 
      message: 'Apple ë¡œê·¸ì¸ ì„±ê³µ',
      session_token: sessionToken,
      user: {
        id: user.id,
        email: user.email,
        username: user.username,
        full_name: user.full_name,
        role: user.role,
        profile_image: user.profile_image,
        is_verified: user.is_verified
      }
    })
  } catch (error: any) {
    console.error('Apple login error:', error)
    return c.json({ success: false, error: 'Apple ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// Facebook OAuth Login API
app.post('/api/auth/facebook-login', async (c) => {
  const db = c.env.DB
  
  try {
    const { facebook_id, email, name, picture } = await c.req.json()
    
    if (!facebook_id) {
      return c.json({ success: false, error: 'Facebook ê³„ì • ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤' }, 400)
    }
    
    // Check if user exists with this Facebook ID or email
    let user = await db.prepare(`
      SELECT * FROM users WHERE google_id = ? OR (email = ? AND email IS NOT NULL) AND is_active = 1
    `).bind('facebook_' + facebook_id, email).first()
    
    // If user doesn't exist, create new user
    if (!user) {
      const username = 'facebook_' + facebook_id.substring(0, 10)
      const fullName = name || 'Facebook User'
      const userEmail = email || `facebook_${facebook_id}@facebook.local`
      
      const result = await db.prepare(`
        INSERT INTO users (
          email, username, full_name, google_id, profile_image, role, 
          is_verified, is_active, created_at
        ) VALUES (?, ?, ?, ?, ?, 'buyer', 1, 1, datetime('now'))
      `).bind(
        userEmail,
        username,
        fullName,
        'facebook_' + facebook_id,
        picture?.data?.url || null
      ).run()
      
      const userId = result.meta.last_row_id
      
      // Add role
      await db.prepare(`
        INSERT INTO user_roles (user_id, role, is_active, granted_at)
        VALUES (?, 'buyer', 1, datetime('now'))
      `).bind(userId).run()
      
      // Log activity
      await db.prepare(`
        INSERT INTO activity_logs (user_id, action_type, entity_type, details, created_at)
        VALUES (?, 'facebook_signup', 'user', ?, datetime('now'))
      `).bind(userId, JSON.stringify({ facebook_id, email: userEmail })).run()
      
      user = await db.prepare(`SELECT * FROM users WHERE id = ?`).bind(userId).first()
    } else {
      // Update existing user's Facebook info
      await db.prepare(`
        UPDATE users 
        SET google_id = ?, profile_image = COALESCE(?, profile_image), 
            updated_at = datetime('now')
        WHERE id = ?
      `).bind('facebook_' + facebook_id, picture?.data?.url, user.id).run()
    }
    
    // Generate session token
    const sessionToken = generateSessionToken()
    const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
    
    await db.prepare(`
      INSERT INTO user_sessions (user_id, session_token, expires_at, created_at)
      VALUES (?, ?, ?, datetime('now'))
    `).bind(user.id, sessionToken, expiresAt.toISOString()).run()
    
    await db.prepare(`
      UPDATE users SET last_login_at = datetime('now') WHERE id = ?
    `).bind(user.id).run()
    
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, created_at)
      VALUES (?, 'facebook_login', 'user', datetime('now'))
    `).bind(user.id).run()
    
    return c.json({ 
      success: true, 
      message: 'Facebook ë¡œê·¸ì¸ ì„±ê³µ',
      session_token: sessionToken,
      user: {
        id: user.id,
        email: user.email,
        username: user.username,
        full_name: user.full_name,
        role: user.role,
        profile_image: user.profile_image,
        is_verified: user.is_verified
      }
    })
  } catch (error: any) {
    console.error('Facebook login error:', error)
    return c.json({ success: false, error: 'Facebook ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ============================================
// ì „ë¬¸ê°€ ì‹ ì²­ API
// ============================================

// Submit expert application
app.post('/api/expert/apply', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifyUserSession(db, token)
    if (!session) {
      return c.json({ success: false, error: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    // Check if already applied
    const existing = await db.prepare(`
      SELECT id, application_status FROM expert_applications WHERE user_id = ?
    `).bind(session.id).first()
    
    if (existing) {
      if (existing.application_status === 'pending') {
        return c.json({ success: false, error: 'ì´ë¯¸ ì‹¬ì‚¬ ì¤‘ì¸ ì‹ ì²­ì´ ìˆìŠµë‹ˆë‹¤' }, 400)
      } else if (existing.application_status === 'approved') {
        return c.json({ success: false, error: 'ì´ë¯¸ ì „ë¬¸ê°€ë¡œ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤' }, 400)
      }
    }
    
    const { expert_type, institution, position, years_experience, specialization, 
            resume_url, portfolio_url, motivation, expertise_description } = await c.req.json()
    
    // Validation
    if (!expert_type || !institution || !position || !years_experience || !specialization || !motivation || !expertise_description) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”' }, 400)
    }
    
    if (years_experience < 3) {
      return c.json({ success: false, error: 'ìµœì†Œ 3ë…„ ì´ìƒì˜ ê²½ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 400)
    }
    
    // Insert application
    await db.prepare(`
      INSERT INTO expert_applications (
        user_id, expert_type, institution, position, years_experience,
        specialization, resume_url, portfolio_url, motivation, expertise_description,
        application_status, submitted_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending', datetime('now'))
    `).bind(
      session.id, expert_type, institution, position, years_experience,
      specialization, resume_url, portfolio_url, motivation, expertise_description
    ).run()
    
    // Create notification for admins
    await db.prepare(`
      INSERT INTO notifications (user_id, type, title, message, is_read, created_at)
      SELECT id, 'expert_application', 'ìƒˆë¡œìš´ ì „ë¬¸ê°€ ì‹ ì²­', ?, 0, datetime('now')
      FROM admin_users WHERE role = 'super_admin'
    `).bind(`${session.full_name}ë‹˜ì´ ì „ë¬¸ê°€ë¡œ ì‹ ì²­í–ˆìŠµë‹ˆë‹¤ (${expert_type})`).run()
    
    // Log activity
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, details, created_at)
      VALUES (?, 'expert_application', 'application', ?, datetime('now'))
    `).bind(session.id, JSON.stringify({ expert_type, institution })).run()
    
    return c.json({ 
      success: true, 
      message: 'ì „ë¬¸ê°€ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì‹¬ì‚¬ ê²°ê³¼ëŠ” ì´ë©”ì¼ë¡œ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.'
    })
  } catch (error: any) {
    console.error('Expert application error:', error)
    return c.json({ success: false, error: 'ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// Get expert application status
app.get('/api/expert/application-status', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifyUserSession(db, token)
    if (!session) {
      return c.json({ success: false, error: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const application = await db.prepare(`
      SELECT * FROM expert_applications WHERE user_id = ? ORDER BY submitted_at DESC LIMIT 1
    `).bind(session.id).first()
    
    return c.json({ 
      success: true,
      application: application || null
    })
  } catch (error: any) {
    return c.json({ success: false, error: 'ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ============================================
// OpenSea API ì—°ë™
// ============================================

// Import NFT from OpenSea by contract address and token ID
app.post('/api/opensea/import-nft', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    // Verify admin session
    const adminSession = await verifySession(db, token)
    if (!adminSession || adminSession.role !== 'super_admin') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' }, 403)
    }
    
    const { contract_address, token_id } = await c.req.json()
    
    if (!contract_address || !token_id) {
      return c.json({ success: false, error: 'Contract addressì™€ Token IDê°€ í•„ìš”í•©ë‹ˆë‹¤' }, 400)
    }
    
    // Check if already imported
    const existing = await db.prepare(`
      SELECT artwork_id FROM opensea_artwork_mapping 
      WHERE contract_address = ? AND token_id = ?
    `).bind(contract_address, token_id).first()
    
    if (existing) {
      return c.json({ success: false, error: 'ì´ë¯¸ ë“±ë¡ëœ NFTì…ë‹ˆë‹¤' }, 400)
    }
    
    // Get OpenSea API key from settings
    const apiKeySetting = await db.prepare(`
      SELECT setting_value FROM system_settings WHERE setting_key = 'opensea_api_key'
    `).first()
    
    const openSeaApiKey = apiKeySetting?.setting_value
    
    if (!openSeaApiKey) {
      return c.json({ success: false, error: 'OpenSea API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤' }, 400)
    }
    
    // Fetch NFT data from OpenSea API
    const openSeaUrl = `https://api.opensea.io/api/v2/chain/ethereum/contract/${contract_address}/nfts/${token_id}`
    
    const openSeaResponse = await fetch(openSeaUrl, {
      headers: {
        'X-API-KEY': openSeaApiKey,
        'Accept': 'application/json'
      }
    })
    
    if (!openSeaResponse.ok) {
      return c.json({ success: false, error: 'OpenSea API ìš”ì²­ ì‹¤íŒ¨: ' + openSeaResponse.statusText }, 500)
    }
    
    const nftData = await openSeaResponse.json()
    const nft = nftData.nft
    
    if (!nft) {
      return c.json({ success: false, error: 'NFTë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 404)
    }
    
    // Find or create artist
    const artistName = nft.creator || nft.collection?.name || 'Unknown Artist'
    let artistId: any
    
    const existingArtist = await db.prepare(`
      SELECT id FROM artists WHERE name = ?
    `).bind(artistName).first()
    
    if (existingArtist) {
      artistId = existingArtist.id
    } else {
      const artistResult = await db.prepare(`
        INSERT INTO artists (name, bio, profile_image, created_at)
        VALUES (?, ?, ?, datetime('now'))
      `).bind(
        artistName,
        nft.collection?.description || '',
        nft.collection?.image_url || nft.image_url || ''
      ).run()
      
      artistId = artistResult.meta.last_row_id
    }
    
    // Insert artwork
    const artworkResult = await db.prepare(`
      INSERT INTO artworks (
        title, description, artist_id, category, image_url, 
        estimated_value, is_minted, minting_status, blockchain_hash,
        created_at
      ) VALUES (?, ?, ?, ?, ?, ?, 1, 'minted', ?, datetime('now'))
    `).bind(
      nft.name || `Token #${token_id}`,
      nft.description || '',
      artistId,
      'Digital Art',
      nft.image_url || nft.display_image_url || '',
      0, // Will be calculated later
      contract_address
    ).run()
    
    const artworkId = artworkResult.meta.last_row_id
    
    // Create OpenSea mapping
    await db.prepare(`
      INSERT INTO opensea_artwork_mapping (
        artwork_id, contract_address, token_id, collection_slug,
        opensea_url, opensea_metadata, last_synced_at
      ) VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
    `).bind(
      artworkId,
      contract_address,
      token_id,
      nft.collection?.slug || '',
      `https://opensea.io/assets/ethereum/${contract_address}/${token_id}`,
      JSON.stringify(nft)
    ).run()
    
    // Log activity
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, entity_id, details, created_at)
      VALUES (?, 'opensea_import', 'artwork', ?, ?, datetime('now'))
    `).bind(
      adminSession.user_id,
      artworkId,
      JSON.stringify({ contract_address, token_id, name: nft.name })
    ).run()
    
    return c.json({ 
      success: true, 
      message: 'NFTê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤',
      artwork_id: artworkId,
      nft_data: {
        name: nft.name,
        image_url: nft.image_url,
        opensea_url: `https://opensea.io/assets/ethereum/${contract_address}/${token_id}`
      }
    })
  } catch (error: any) {
    console.error('OpenSea import error:', error)
    return c.json({ success: false, error: error.message || 'NFT ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// Import multiple NFTs from OpenSea collection
app.post('/api/opensea/import-collection', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    // Verify admin session
    const adminSession = await verifySession(db, token)
    if (!adminSession || adminSession.role !== 'super_admin') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' }, 403)
    }
    
    const { collection_slug, limit = 10 } = await c.req.json()
    
    if (!collection_slug) {
      return c.json({ success: false, error: 'Collection slugê°€ í•„ìš”í•©ë‹ˆë‹¤' }, 400)
    }
    
    // Get OpenSea API key
    const apiKeySetting = await db.prepare(`
      SELECT setting_value FROM system_settings WHERE setting_key = 'opensea_api_key'
    `).first()
    
    const openSeaApiKey = apiKeySetting?.setting_value
    
    if (!openSeaApiKey) {
      return c.json({ success: false, error: 'OpenSea API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤' }, 400)
    }
    
    // Create sync job
    const jobResult = await db.prepare(`
      INSERT INTO opensea_sync_jobs (
        job_type, collection_slug, status, total_items, created_at
      ) VALUES ('collection_import', ?, 'running', ?, datetime('now'))
    `).bind(collection_slug, limit).run()
    
    const jobId = jobResult.meta.last_row_id
    
    // Fetch collection NFTs from OpenSea
    const openSeaUrl = `https://api.opensea.io/api/v2/collection/${collection_slug}/nfts?limit=${limit}`
    
    const openSeaResponse = await fetch(openSeaUrl, {
      headers: {
        'X-API-KEY': openSeaApiKey,
        'Accept': 'application/json'
      }
    })
    
    if (!openSeaResponse.ok) {
      await db.prepare(`
        UPDATE opensea_sync_jobs 
        SET status = 'failed', error_log = ?, completed_at = datetime('now')
        WHERE id = ?
      `).bind('OpenSea API ìš”ì²­ ì‹¤íŒ¨: ' + openSeaResponse.statusText, jobId).run()
      
      return c.json({ success: false, error: 'OpenSea API ìš”ì²­ ì‹¤íŒ¨' }, 500)
    }
    
    const collectionData = await openSeaResponse.json()
    const nfts = collectionData.nfts || []
    
    let imported = 0
    let failed = 0
    const importedIds: number[] = []
    
    for (const nft of nfts) {
      try {
        // Check if already imported
        const existing = await db.prepare(`
          SELECT artwork_id FROM opensea_artwork_mapping 
          WHERE contract_address = ? AND token_id = ?
        `).bind(nft.contract, nft.identifier).first()
        
        if (existing) {
          failed++
          continue
        }
        
        // Find or create artist
        const artistName = nft.creator || collection_slug
        let artistId: any
        
        const existingArtist = await db.prepare(`
          SELECT id FROM artists WHERE name = ?
        `).bind(artistName).first()
        
        if (existingArtist) {
          artistId = existingArtist.id
        } else {
          const artistResult = await db.prepare(`
            INSERT INTO artists (name, bio, profile_image, created_at)
            VALUES (?, ?, ?, datetime('now'))
          `).bind(artistName, collectionData.collection?.description || '', nft.image_url || '').run()
          
          artistId = artistResult.meta.last_row_id
        }
        
        // Insert artwork
        const artworkResult = await db.prepare(`
          INSERT INTO artworks (
            title, description, artist_id, category, image_url, 
            estimated_value, is_minted, minting_status, blockchain_hash,
            created_at
          ) VALUES (?, ?, ?, ?, ?, ?, 1, 'minted', ?, datetime('now'))
        `).bind(
          nft.name || `Token #${nft.identifier}`,
          nft.description || '',
          artistId,
          'Digital Art',
          nft.image_url || nft.display_image_url || '',
          0,
          nft.contract
        ).run()
        
        const artworkId = artworkResult.meta.last_row_id
        
        // Create OpenSea mapping
        await db.prepare(`
          INSERT INTO opensea_artwork_mapping (
            artwork_id, contract_address, token_id, collection_slug,
            opensea_url, opensea_metadata, last_synced_at
          ) VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
        `).bind(
          artworkId,
          nft.contract,
          nft.identifier,
          collection_slug,
          `https://opensea.io/assets/ethereum/${nft.contract}/${nft.identifier}`,
          JSON.stringify(nft)
        ).run()
        
        imported++
        importedIds.push(artworkId)
      } catch (err) {
        console.error('Failed to import NFT:', err)
        failed++
      }
    }
    
    // Update job status
    await db.prepare(`
      UPDATE opensea_sync_jobs 
      SET status = 'completed', processed_items = ?, failed_items = ?,
          imported_artworks = ?, completed_at = datetime('now')
      WHERE id = ?
    `).bind(imported, failed, JSON.stringify(importedIds), jobId).run()
    
    return c.json({ 
      success: true, 
      message: `${imported}ê°œì˜ NFTê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤`,
      job_id: jobId,
      stats: {
        imported,
        failed,
        total: nfts.length
      }
    })
  } catch (error: any) {
    console.error('OpenSea collection import error:', error)
    return c.json({ success: false, error: error.message || 'ì»¬ë ‰ì…˜ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// Get OpenSea sync job status
app.get('/api/opensea/job/:jobId', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const jobId = c.req.param('jobId')
  
  if (!token) {
    return c.json({ success: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const adminSession = await verifySession(db, token)
    if (!adminSession) {
      return c.json({ success: false, error: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const job = await db.prepare(`
      SELECT * FROM opensea_sync_jobs WHERE id = ?
    `).bind(jobId).first()
    
    if (!job) {
      return c.json({ success: false, error: 'ì‘ì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 404)
    }
    
    return c.json({ success: true, job })
  } catch (error: any) {
    return c.json({ success: false, error: 'ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// Set OpenSea API key (admin only)
app.post('/api/opensea/set-api-key', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const adminSession = await verifySession(db, token)
    if (!adminSession || adminSession.role !== 'super_admin') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' }, 403)
    }
    
    const { api_key } = await c.req.json()
    
    if (!api_key) {
      return c.json({ success: false, error: 'API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”' }, 400)
    }
    
    // Update or insert API key
    await db.prepare(`
      INSERT INTO system_settings (setting_key, setting_value, is_sensitive, updated_at, updated_by)
      VALUES ('opensea_api_key', ?, 1, datetime('now'), ?)
      ON CONFLICT(setting_key) DO UPDATE SET 
        setting_value = excluded.setting_value,
        updated_at = datetime('now'),
        updated_by = excluded.updated_by
    `).bind(api_key, adminSession.user_id).run()
    
    return c.json({ success: true, message: 'OpenSea API í‚¤ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤' })
  } catch (error: any) {
    return c.json({ success: false, error: 'API í‚¤ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ============================================
// ë¬¸ì„œ ë‹¤ìš´ë¡œë“œ ë¼ìš°íŠ¸
// ============================================

app.get('/download/documents', async (c) => {
  try {
    const filePath = './public/static/nft_art_platform_documents.tar.gz'
    const file = await Bun.file(filePath)
    
    return new Response(file, {
      headers: {
        'Content-Type': 'application/x-tar',
        'Content-Disposition': 'attachment; filename="nft_art_platform_documents.tar.gz"',
      }
    })
  } catch (error) {
    return c.text('File not found', 404)
  }
})

// ============================================
// API ë¼ìš°íŠ¸
// ============================================

app.get('/api/artworks', async (c) => {
  try {
    const { category, status, sort = 'created_at', order = 'DESC', limit = '50' } = c.req.query()
    
    // âœ… Whitelist validation for SQL Injection prevention
    const allowedSortColumns = ['created_at', 'title', 'estimated_value', 'view_count']
    const allowedOrders = ['ASC', 'DESC']
    const validSort = allowedSortColumns.includes(sort) ? sort : 'created_at'
    const validOrder = allowedOrders.includes(order.toUpperCase()) ? order.toUpperCase() : 'DESC'
    const validLimit = Math.min(parseInt(limit) || 50, 100) // Max 100
    
    let query = `
      SELECT 
        a.*,
        ar.name as artist_name,
        ar.profile_image as artist_profile_image
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE 1=1
    `
    
    const bindings: any[] = []
    
    if (category && category !== 'all') {
      query += ` AND a.category = ?`
      bindings.push(category)
    }
    
    if (status) {
      query += ` AND a.status = ?`
      bindings.push(status)
    } else {
      query += ` AND a.status IN ('approved', 'minted')`
    }
    
    // âœ… Safe: validSort and validOrder are whitelisted
    query += ` ORDER BY a.${validSort} ${validOrder} LIMIT ?`
    bindings.push(validLimit)
    
    const result = await c.env.DB.prepare(query).bind(...bindings).all()
    
    return c.json<ApiResponse<ArtworkWithArtist[]>>({
      success: true,
      data: result.results as ArtworkWithArtist[]
    })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

app.get('/api/artworks/:id', async (c) => {
  try {
    const id = c.req.param('id')
    
    const result = await c.env.DB.prepare(`
      SELECT 
        a.*,
        ar.name as artist_name,
        ar.bio as artist_bio,
        ar.profile_image as artist_profile_image,
        ar.career_years,
        ar.exhibitions_count,
        ar.awards_count
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.id = ?
    `).bind(id).first()
    
    if (!result) {
      return c.json<ApiResponse>({ success: false, error: 'ì‘í’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    await c.env.DB.prepare(`UPDATE artworks SET views_count = views_count + 1 WHERE id = ?`).bind(id).run()
    
    return c.json<ApiResponse>({ success: true, data: result })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

// Upload artwork with image
app.post('/api/artworks', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifyUserSession(db, token)
    if (!session) {
      return c.json({ success: false, error: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    // Only artists can upload artworks
    if (session.role !== 'artist') {
      return c.json({ success: false, error: 'ì•„í‹°ìŠ¤íŠ¸ë§Œ ì‘í’ˆì„ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' }, 403)
    }
    
    // Parse multipart form data
    const formData = await c.req.formData()
    const image = formData.get('image') as File
    const title = formData.get('title') as string
    const description = formData.get('description') as string
    const category = formData.get('category') as string
    const current_price = formData.get('current_price') as string
    
    if (!image || !title || !category || !current_price) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”' }, 400)
    }
    
    // Validate image type
    if (!image.type.startsWith('image/')) {
      return c.json({ success: false, error: 'ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤' }, 400)
    }
    
    // Validate image size (max 10MB)
    if (image.size > 10 * 1024 * 1024) {
      return c.json({ success: false, error: 'ì´ë¯¸ì§€ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 400)
    }
    
    // Get artist ID
    const artist = await db.prepare(`
      SELECT id FROM artists WHERE user_id = ?
    `).bind(session.id).first()
    
    let artistId = artist?.id
    
    // If artist profile doesn't exist, create one
    if (!artistId) {
      const result = await db.prepare(`
        INSERT INTO artists (user_id, name, email, profile_image, created_at)
        VALUES (?, ?, ?, ?, datetime('now'))
      `).bind(session.id, session.full_name, session.email, session.profile_image || null).run()
      artistId = result.meta.last_row_id
    }
    
    // R2 Storage Integration (when R2 is enabled)
    // For now, store base64 data URL temporarily
    // TODO: Enable R2 in Cloudflare Dashboard and uncomment R2 upload code
    let imageUrl: string
    
    if (c.env.R2) {
      // R2 is enabled - upload to R2
      const fileExtension = image.name.split('.').pop()
      const fileName = `artworks/${Date.now()}-${crypto.randomUUID()}.${fileExtension}`
      
      await c.env.R2.put(fileName, image.stream(), {
        httpMetadata: {
          contentType: image.type
        }
      })
      
      imageUrl = `https://gallerypia-artworks.r2.dev/${fileName}`
    } else {
      // R2 not enabled - store as base64 data URL (temporary solution)
      const arrayBuffer = await image.arrayBuffer()
      const base64 = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)))
      imageUrl = `data:${image.type};base64,${base64}`
    }
    
    // Insert artwork
    const artworkResult = await db.prepare(`
      INSERT INTO artworks (
        artist_id, title, description, category, image_url, current_price,
        status, created_at
      ) VALUES (?, ?, ?, ?, ?, ?, 'pending', datetime('now'))
    `).bind(artistId, title, description || null, category, imageUrl, parseFloat(current_price)).run()
    
    const artworkId = artworkResult.meta.last_row_id
    
    // Log activity
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, entity_id, details, created_at)
      VALUES (?, 'upload', 'artwork', ?, ?, datetime('now'))
    `).bind(session.id, artworkId, JSON.stringify({ title, category })).run()
    
    return c.json({ 
      success: true, 
      message: 'ì‘í’ˆì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤',
      id: artworkId,
      image_url: imageUrl
    })
  } catch (error: any) {
    console.error('Artwork upload error:', error)
    return c.json({ success: false, error: 'ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

app.get('/api/artists', async (c) => {
  try {
    const result = await c.env.DB.prepare(`SELECT * FROM artists ORDER BY exhibitions_count DESC`).all()
    return c.json<ApiResponse<Artist[]>>({ success: true, data: result.results as Artist[] })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

app.get('/api/collections', async (c) => {
  try {
    const result = await c.env.DB.prepare(`SELECT * FROM collections ORDER BY created_at DESC`).all()
    return c.json<ApiResponse>({ success: true, data: result.results })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

app.get('/api/stats', async (c) => {
  try {
    const totalArtworks = await c.env.DB.prepare('SELECT COUNT(*) as count FROM artworks').first()
    const totalArtists = await c.env.DB.prepare('SELECT COUNT(*) as count FROM artists').first()
    const mintedNFTs = await c.env.DB.prepare('SELECT COUNT(*) as count FROM artworks WHERE is_minted = 1').first()
    const totalValue = await c.env.DB.prepare('SELECT SUM(estimated_value) as total FROM artworks').first()
    
    return c.json<ApiResponse>({
      success: true,
      data: {
        total_artworks: totalArtworks?.count || 0,
        total_artists: totalArtists?.count || 0,
        minted_nfts: mintedNFTs?.count || 0,
        total_value: totalValue?.total || 0
      }
    })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

// ê°€ì¹˜í‰ê°€ ì´ë ¥ ì¡°íšŒ
app.get('/api/valuation-history/:artworkId', async (c) => {
  try {
    const artworkId = c.req.param('artworkId')
    const history = await c.env.DB.prepare(`
      SELECT * FROM valuation_history 
      WHERE artwork_id = ? 
      ORDER BY evaluated_at DESC
    `).bind(artworkId).all()
    
    return c.json<ApiResponse>({
      success: true,
      data: history.results
    })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

// ============================================
// v6.0 ì¶”ê°€ API - ë©”ì¸ í˜ì´ì§€ ì¹´í…Œê³ ë¦¬
// ============================================

// ì¶”ì²œ ì‘í’ˆ (í‰ê°€ ì ìˆ˜ê°€ ë†’ì€ ì‘í’ˆ)
app.get('/api/artworks/featured/recommended', async (c) => {
  try {
    const limit = c.req.query('limit') || '8'
    
    const result = await c.env.DB.prepare(`
      SELECT 
        a.*,
        ar.name as artist_name,
        ar.profile_image as artist_profile_image,
        COALESCE(a.average_rating, 0) as rating_score
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.status IN ('approved', 'minted')
        AND a.average_rating >= 4.0
      ORDER BY a.average_rating DESC, a.views_count DESC
      LIMIT ?
    `).bind(limit).all()
    
    return c.json<ApiResponse>({
      success: true,
      data: result.results
    })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

// ì¸ê¸° ì‘í’ˆ (ì¡°íšŒìˆ˜ì™€ ì¢‹ì•„ìš”ê°€ ë§ì€ ì‘í’ˆ)
app.get('/api/artworks/featured/popular', async (c) => {
  try {
    const limit = c.req.query('limit') || '8'
    
    const result = await c.env.DB.prepare(`
      SELECT 
        a.*,
        ar.name as artist_name,
        ar.profile_image as artist_profile_image,
        (a.views_count * 1 + a.likes_count * 3) as popularity_score
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.status IN ('approved', 'minted')
      ORDER BY popularity_score DESC, a.created_at DESC
      LIMIT ?
    `).bind(limit).all()
    
    return c.json<ApiResponse>({
      success: true,
      data: result.results
    })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

// ì‹ ê·œ ì‘í’ˆ (ìµœê·¼ ë“±ë¡ëœ ì‘í’ˆ)
app.get('/api/artworks/featured/recent', async (c) => {
  try {
    const limit = c.req.query('limit') || '8'
    
    const result = await c.env.DB.prepare(`
      SELECT 
        a.*,
        ar.name as artist_name,
        ar.profile_image as artist_profile_image
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.status IN ('approved', 'minted')
      ORDER BY a.created_at DESC
      LIMIT ?
    `).bind(limit).all()
    
    return c.json<ApiResponse>({
      success: true,
      data: result.results
    })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

// v6.0: ë¦¬ë·° ì‹œìŠ¤í…œ API
// ì‘í’ˆ ë¦¬ë·° ì¡°íšŒ
app.get('/api/artworks/:id/reviews', async (c) => {
  try {
    const artworkId = c.req.param('id')
    const limit = c.req.query('limit') || '20'
    
    const result = await c.env.DB.prepare(`
      SELECT 
        r.*,
        u.username,
        u.full_name,
        u.profile_image
      FROM artwork_reviews r
      LEFT JOIN users u ON r.user_id = u.id
      WHERE r.artwork_id = ?
      ORDER BY r.created_at DESC
      LIMIT ?
    `).bind(artworkId, limit).all()
    
    return c.json<ApiResponse>({
      success: true,
      data: result.results
    })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

// ë¦¬ë·° ì‘ì„±
app.post('/api/artworks/:id/reviews', async (c) => {
  const db = c.env.DB
  const artworkId = c.req.param('id')
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const {
      rating,
      review_text,
      artistic_value_rating,
      investment_potential_rating
    } = await c.req.json()
    
    if (!rating || rating < 1 || rating > 5) {
      return c.json({ success: false, message: 'í‰ì ì€ 1-5 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤' }, 400)
    }
    
    // ì¤‘ë³µ ë¦¬ë·° í™•ì¸
    const existingReview = await db.prepare(`
      SELECT id FROM artwork_reviews 
      WHERE artwork_id = ? AND user_id = ?
    `).bind(artworkId, session.user_id).first()
    
    if (existingReview) {
      return c.json({ success: false, message: 'ì´ë¯¸ ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ì…¨ìŠµë‹ˆë‹¤' }, 400)
    }
    
    // ë¦¬ë·° ì‚½ì…
    const result = await db.prepare(`
      INSERT INTO artwork_reviews (
        artwork_id, user_id, rating, review_text,
        artistic_value_rating, investment_potential_rating,
        created_at
      ) VALUES (?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
    `).bind(
      artworkId,
      session.user_id,
      rating,
      review_text || null,
      artistic_value_rating || null,
      investment_potential_rating || null
    ).run()
    
    // ì‘í’ˆì˜ í‰ê·  í‰ì  ì—…ë°ì´íŠ¸
    const avgResult = await db.prepare(`
      SELECT AVG(rating) as avg_rating, COUNT(*) as review_count
      FROM artwork_reviews
      WHERE artwork_id = ?
    `).bind(artworkId).first()
    
    await db.prepare(`
      UPDATE artworks
      SET average_rating = ?, reviews_count = ?
      WHERE id = ?
    `).bind(
      avgResult?.avg_rating || 0,
      avgResult?.review_count || 0,
      artworkId
    ).run()
    
    return c.json({
      success: true,
      message: 'ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤',
      review_id: result.meta.last_row_id
    })
  } catch (error: any) {
    console.error('Review creation error:', error)
    return c.json({ success: false, message: 'ë¦¬ë·° ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ì „ë¬¸ê°€ í‰ê°€ ì œì¶œ API
app.post('/api/artworks/:id/evaluate', async (c) => {
  const db = c.env.DB
  const artworkId = c.req.param('id')
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifyUserSession(db, token)
    if (!session) {
      return c.json({ success: false, error: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    // Check if user is expert
    if (session.role !== 'expert' && session.role !== 'admin') {
      return c.json({ success: false, error: 'ì „ë¬¸ê°€ë§Œ í‰ê°€ë¥¼ ì œì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' }, 403)
    }
    
    const {
      artist_achievement_score,
      content_depth_score,
      expression_score,
      originality_innovation_score,
      collection_value_score,
      certification_score,
      market_demand_score,
      rarity_score,
      popularity_score,
      expert_comment
    } = await c.req.json()
    
    // Validate scores
    const scores = [
      artist_achievement_score, content_depth_score, expression_score,
      originality_innovation_score, collection_value_score, certification_score,
      market_demand_score, rarity_score, popularity_score
    ]
    
    if (scores.some(s => s < 0 || s > 100)) {
      return c.json({ success: false, error: 'ì ìˆ˜ëŠ” 0-100 ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”' }, 400)
    }
    
    if (!expert_comment || expert_comment.trim().length < 10) {
      return c.json({ success: false, error: 'ì¢…í•© ì˜ê²¬ì„ 10ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”' }, 400)
    }
    
    // Check if expert already evaluated this artwork
    const existing = await db.prepare(`
      SELECT id FROM expert_evaluations WHERE artwork_id = ? AND expert_id = ?
    `).bind(artworkId, session.id).first()
    
    if (existing) {
      return c.json({ success: false, error: 'ì´ë¯¸ í‰ê°€ë¥¼ ì œì¶œí•˜ì…¨ìŠµë‹ˆë‹¤' }, 400)
    }
    
    // Calculate final score (weighted average)
    const finalScore = (
      artist_achievement_score * 0.15 +
      (content_depth_score + expression_score + originality_innovation_score + collection_value_score) / 4 * 0.40 +
      certification_score * 0.15 +
      (market_demand_score + rarity_score) / 2 * 0.20 +
      popularity_score * 0.10
    )
    
    // Insert evaluation
    const result = await db.prepare(`
      INSERT INTO expert_evaluations (
        artwork_id, expert_id,
        artist_achievement_score, content_depth_score, expression_score,
        originality_innovation_score, collection_value_score, certification_score,
        market_demand_score, rarity_score, popularity_score,
        expert_evaluation_final_score, expert_comment,
        evaluation_status, evaluated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'approved', datetime('now'))
    `).bind(
      artworkId, session.id,
      artist_achievement_score, content_depth_score, expression_score,
      originality_innovation_score, collection_value_score, certification_score,
      market_demand_score, rarity_score, popularity_score,
      finalScore, expert_comment
    ).run()
    
    // Update artwork scores (average of all expert evaluations)
    const avgScores = await db.prepare(`
      SELECT 
        AVG(artist_achievement_score) as avg_artist,
        AVG(content_depth_score) as avg_content,
        AVG(expression_score) as avg_expression,
        AVG(originality_innovation_score) as avg_originality,
        AVG(collection_value_score) as avg_collection,
        AVG(certification_score) as avg_certification,
        AVG(market_demand_score) as avg_market,
        AVG(rarity_score) as avg_rarity,
        AVG(popularity_score) as avg_popularity,
        AVG(expert_evaluation_final_score) as avg_final,
        COUNT(*) as expert_count
      FROM expert_evaluations
      WHERE artwork_id = ? AND evaluation_status = 'approved'
    `).bind(artworkId).first()
    
    if (avgScores) {
      await db.prepare(`
        UPDATE artworks SET
          artist_achievement_score = ?,
          content_depth_score = ?,
          expression_score = ?,
          originality_innovation_score = ?,
          collection_value_score = ?,
          certification_score = ?,
          market_demand_score = ?,
          rarity_score = ?,
          popularity_score = ?,
          expert_evaluation_final_score = ?,
          expert_evaluation_count = ?
        WHERE id = ?
      `).bind(
        avgScores.avg_artist || 0,
        avgScores.avg_content || 0,
        avgScores.avg_expression || 0,
        avgScores.avg_originality || 0,
        avgScores.avg_collection || 0,
        avgScores.avg_certification || 0,
        avgScores.avg_market || 0,
        avgScores.avg_rarity || 0,
        avgScores.avg_popularity || 0,
        avgScores.avg_final || 0,
        avgScores.expert_count || 0,
        artworkId
      ).run()
    }
    
    // Log activity
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, entity_id, details, created_at)
      VALUES (?, 'evaluate', 'artwork', ?, ?, datetime('now'))
    `).bind(session.id, artworkId, JSON.stringify({ final_score: finalScore.toFixed(2) })).run()
    
    return c.json({
      success: true,
      message: 'í‰ê°€ê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤',
      evaluation_id: result.meta.last_row_id,
      final_score: finalScore.toFixed(2)
    })
  } catch (error: any) {
    console.error('Evaluation submission error:', error)
    return c.json({ success: false, error: 'í‰ê°€ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ì†Œìœ ì ì •ë³´ ì¡°íšŒ API
app.get('/api/artworks/:id/ownership', async (c) => {
  try {
    const artworkId = c.req.param('id')
    
    const result = await c.env.DB.prepare(`
      SELECT 
        ao.*,
        u.username,
        u.full_name,
        u.profile_image
      FROM artwork_ownership ao
      LEFT JOIN users u ON ao.owner_id = u.id
      WHERE ao.artwork_id = ? AND ao.is_current_owner = 1
      LIMIT 1
    `).bind(artworkId).first()
    
    return c.json<ApiResponse>({
      success: true,
      data: result || null
    })
  } catch (error: any) {
    return c.json<ApiResponse>({ success: false, error: error.message }, 500)
  }
})

// v6.0: ë§ˆì´í˜ì´ì§€ API
// ë‚´ ì†Œìœ  NFT ëª©ë¡
app.get('/api/my/artworks', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const result = await db.prepare(`
      SELECT 
        a.*,
        ar.name as artist_name,
        ar.profile_image as artist_profile_image,
        ao.acquired_at as acquired_date,
        ao.acquisition_price as purchase_price
      FROM artwork_ownership ao
      LEFT JOIN artworks a ON ao.artwork_id = a.id
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE ao.owner_id = ? AND ao.is_current_owner = 1
      ORDER BY ao.acquired_at DESC
    `).bind(session.user_id).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    return c.json({ success: false, message: 'ì†Œìœ  NFT ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ë‚´ ê±°ë˜ ë‚´ì—­
app.get('/api/my/transactions', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const result = await db.prepare(`
      SELECT 
        t.*,
        a.title as artwork_title,
        a.image_url as artwork_image
      FROM transactions t
      LEFT JOIN artworks a ON t.artwork_id = a.id
      WHERE t.buyer_id = ? OR t.seller_id = ?
      ORDER BY t.transaction_date DESC
      LIMIT 50
    `).bind(session.user_id, session.user_id).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    return c.json({ success: false, message: 'ê±°ë˜ë‚´ì—­ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// í”„ë¡œí•„ ìˆ˜ì •
app.put('/api/my/profile', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const { full_name, bio, phone, website, profile_image } = await c.req.json()
    
    await db.prepare(`
      UPDATE users
      SET full_name = ?, bio = ?, phone = ?, website = ?, profile_image = ?
      WHERE id = ?
    `).bind(full_name, bio, phone, website, profile_image, session.user_id).run()
    
    return c.json({ success: true, message: 'í”„ë¡œí•„ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤' })
  } catch (error: any) {
    return c.json({ success: false, message: 'í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ê³ ê°ì§€ì› í‹°ì¼“ ìƒì„±
app.post('/api/support/tickets', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const { category, subject, description, priority } = await c.req.json()
    
    if (!category || !subject || !description) {
      return c.json({ success: false, message: 'í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”' }, 400)
    }
    
    const result = await db.prepare(`
      INSERT INTO support_tickets (
        user_id, category, subject, description, priority,
        status, created_at
      ) VALUES (?, ?, ?, ?, ?, 'open', CURRENT_TIMESTAMP)
    `).bind(session.user_id, category, subject, description, priority || 'medium').run()
    
    return c.json({
      success: true,
      message: 'ë¬¸ì˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤',
      ticket_id: result.meta.last_row_id
    })
  } catch (error: any) {
    return c.json({ success: false, message: 'ë¬¸ì˜ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ë‚´ í‹°ì¼“ ëª©ë¡
app.get('/api/support/my-tickets', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const result = await db.prepare(`
      SELECT * FROM support_tickets
      WHERE user_id = ?
      ORDER BY created_at DESC
    `).bind(session.user_id).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    return c.json({ success: false, message: 'í‹°ì¼“ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// v6.0: KYC/AML API
// KYC ì •ë³´ ì œì¶œ
app.post('/api/kyc/submit', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const {
      legal_name,
      date_of_birth,
      nationality,
      id_type,
      id_number,
      address_line1,
      address_line2,
      city,
      state_province,
      postal_code,
      country,
      id_document_url,
      address_proof_url,
      selfie_url
    } = await c.req.json()
    
    // í•„ìˆ˜ í•­ëª© ê²€ì¦
    if (!legal_name || !date_of_birth || !nationality || !id_type || !id_number) {
      return c.json({ success: false, message: 'í•„ìˆ˜ KYC ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”' }, 400)
    }
    
    // ê¸°ì¡´ KYC í™•ì¸
    const existing = await db.prepare(`
      SELECT id FROM user_kyc_verification WHERE user_id = ?
    `).bind(session.user_id).first()
    
    if (existing) {
      return c.json({ success: false, message: 'ì´ë¯¸ KYC ì¸ì¦ì„ ì‹ ì²­í•˜ì…¨ìŠµë‹ˆë‹¤' }, 400)
    }
    
    // KYC ì •ë³´ ì‚½ì…
    await db.prepare(`
      INSERT INTO user_kyc_verification (
        user_id, legal_name, date_of_birth, nationality,
        id_type, id_number, address_line1, address_line2,
        city, state_province, postal_code, country,
        id_document_url, address_proof_url, selfie_url,
        verification_status, risk_level, submitted_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending', 'low', CURRENT_TIMESTAMP)
    `).bind(
      session.user_id, legal_name, date_of_birth, nationality,
      id_type, id_number, address_line1, address_line2 || null,
      city, state_province, postal_code, country,
      id_document_url || null, address_proof_url || null, selfie_url || null
    ).run()
    
    return c.json({ success: true, message: 'KYC ì¸ì¦ì´ ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤' })
  } catch (error: any) {
    console.error('KYC submission error:', error)
    return c.json({ success: false, message: 'KYC ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ============================================
// í˜ì´ì§€ ë¼ìš°íŠ¸
// ============================================

app.get('/', async (c) => {
  try {
    const db = c.env.DB
    
    // Get stats directly from database
    const statsData = await db.prepare(`
      SELECT 
        COUNT(*) as total_artworks,
        COUNT(DISTINCT artist_id) as total_artists,
        SUM(CASE WHEN is_minted = 1 THEN 1 ELSE 0 END) as minted_nfts,
        SUM(estimated_value) as total_value
      FROM artworks
    `).first()
    
    const stats = { data: statsData }
    
    // Get featured artworks
    const artworksData = await db.prepare(`
      SELECT a.*, ar.name as artist_name, ar.profile_image as artist_profile_image
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.status IN ('approved', 'minted')
      ORDER BY a.created_at DESC
      LIMIT 8
    `).all()
    
    const artworks = { data: artworksData.results }
    
    // v6.0: Get recommended artworks (rating >= 4.0)
    const recommendedData = await db.prepare(`
      SELECT a.*, ar.name as artist_name, ar.profile_image as artist_profile_image
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.status IN ('approved', 'minted') AND a.average_rating >= 4.0
      ORDER BY a.average_rating DESC, a.views_count DESC
      LIMIT 8
    `).all()
    
    const recommended = { data: recommendedData.results }
    
    // v6.0: Get popular artworks
    const popularData = await db.prepare(`
      SELECT a.*, ar.name as artist_name, ar.profile_image as artist_profile_image,
             (a.views_count * 1 + a.likes_count * 3) as popularity_score
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.status IN ('approved', 'minted')
      ORDER BY popularity_score DESC
      LIMIT 8
    `).all()
    
    const popular = { data: popularData.results }
    
    // v6.0: Get recent artworks
    const recentData = await db.prepare(`
      SELECT a.*, ar.name as artist_name, ar.profile_image as artist_profile_image
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.status IN ('approved', 'minted')
      ORDER BY a.created_at DESC
      LIMIT 8
    `).all()
    
    const recent = { data: recentData.results }
    
    const content = `
    <!-- íˆì–´ë¡œ ì„¹ì…˜ -->
    <section id="main-content" class="relative overflow-hidden bg-grid" tabindex="-1">
        <div class="hero-gradient absolute inset-0"></div>
        <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-32">
            <div class="text-center max-w-5xl mx-auto">
                <div class="inline-block mb-6 px-6 py-2 bg-white bg-opacity-5 backdrop-blur-sm rounded-full border border-white border-opacity-10">
                    <span class="text-gradient font-bold text-sm">ğŸ¨ NFT Art Museum Platform</span>
                </div>
                
                <h1 class="text-6xl md:text-8xl font-black mb-8 leading-tight">
                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-white via-gray-200 to-white">Discover</span><br/>
                    <span class="text-gradient animate-pulse">Premium NFTs</span>
                </h1>
                
                <p class="text-xl md:text-2xl text-gray-400 mb-8 font-light leading-relaxed max-w-3xl mx-auto">
                    ê°ê´€ì ì¸ ê°€ì¹˜ì‚°ì • ì‹œìŠ¤í…œìœ¼ë¡œ ê²€ì¦ëœ<br class="hidden sm:block"/>
                    í”„ë¦¬ë¯¸ì—„ NFT ì•„íŠ¸ ì»¬ë ‰ì…˜
                </p>
                
                <!-- AI ê²€ìƒ‰ ì¸í„°í˜ì´ìŠ¤ -->
                <div class="max-w-3xl mx-auto mb-12">
                    <div class="relative">
                        <!-- ê²€ìƒ‰ ì…ë ¥ì°½ -->
                        <div class="relative group">
                            <input 
                                type="text" 
                                id="aiSearchInput"
                                placeholder="AIë¡œ ì‘í’ˆ ê²€ìƒ‰... (í…ìŠ¤íŠ¸, ìŒì„± ì§€ì›)"
                                class="w-full px-6 py-5 pr-36 bg-white/5 backdrop-blur-lg border border-white/10 rounded-2xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500/50 focus:bg-white/10 transition-all duration-300 text-lg"
                                onkeypress="if(event.key === 'Enter') performAISearch()"
                            >
                            <div class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-2">
                                <button onclick="startVoiceSearch()" class="p-3 bg-purple-600/80 hover:bg-purple-600 rounded-xl transition-all duration-200 hover:scale-110" title="ìŒì„± ê²€ìƒ‰">
                                    <i class="fas fa-microphone text-white text-lg"></i>
                                </button>
                                <button onclick="performAISearch()" class="p-3 bg-gradient-to-r from-purple-600 to-cyan-500 hover:from-purple-700 hover:to-cyan-600 rounded-xl transition-all duration-200 hover:scale-110" title="AI ê²€ìƒ‰">
                                    <i class="fas fa-search text-white text-lg"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- ì¹´í…Œê³ ë¦¬ ë¹ ë¥¸ ê²€ìƒ‰ -->
                        <div class="flex flex-wrap gap-2 mt-4 justify-center">
                            <a href="/gallery?category=painting" class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-purple-500/50 rounded-full text-sm text-gray-300 hover:text-white transition-all">
                                <i class="fas fa-paint-brush mr-1"></i>íšŒí™”
                            </a>
                            <a href="/gallery?category=digital" class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-purple-500/50 rounded-full text-sm text-gray-300 hover:text-white transition-all">
                                <i class="fas fa-laptop-code mr-1"></i>ë””ì§€í„¸ì•„íŠ¸
                            </a>
                            <a href="/gallery?category=photography" class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-purple-500/50 rounded-full text-sm text-gray-300 hover:text-white transition-all">
                                <i class="fas fa-camera mr-1"></i>ì‚¬ì§„
                            </a>
                            <a href="/gallery?category=sculpture" class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-purple-500/50 rounded-full text-sm text-gray-300 hover:text-white transition-all">
                                <i class="fas fa-cube mr-1"></i>ì¡°ê°
                            </a>
                            <a href="/gallery?category=abstract" class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-purple-500/50 rounded-full text-sm text-gray-300 hover:text-white transition-all">
                                <i class="fas fa-palette mr-1"></i>ì¶”ìƒí™”
                            </a>
                            <a href="/gallery?category=3d" class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-purple-500/50 rounded-full text-sm text-gray-300 hover:text-white transition-all">
                                <i class="fas fa-cube-alt mr-1"></i>3D ì•„íŠ¸
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- ì£¼ìš” ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹ -->
                <div class="max-w-4xl mx-auto mb-12">
                    <!-- ì²« ë²ˆì§¸ ì¤„: ì£¼ìš” íƒìƒ‰ ë²„íŠ¼ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <a href="/gallery" class="group relative px-8 py-5 bg-gradient-to-br from-purple-600/20 to-cyan-600/20 hover:from-purple-600/30 hover:to-cyan-600/30 rounded-2xl font-bold text-base inline-flex flex-col items-center justify-center border border-purple-500/30 hover:border-purple-500/60 transition-all duration-300 hover:scale-105">
                            <i class="fas fa-compass text-3xl mb-2 text-purple-400 group-hover:text-purple-300 transition-colors"></i>
                            <span class="text-white">NFT ì»¬ë ‰ì…˜ íƒìƒ‰</span>
                        </a>
                        <div class="group relative px-8 py-5 bg-gradient-to-br from-blue-600/20 to-cyan-600/20 rounded-2xl border border-blue-500/30">
                            <a href="/valuation" class="inline-flex flex-col items-center justify-center hover:opacity-80 transition-all duration-300">
                                <i class="fas fa-chart-line text-3xl mb-2 text-blue-400 transition-colors"></i>
                                <span class="text-white font-bold text-base mb-3">ì…€í”„ê°€ì¹˜ì‚°ì • ì‹œìŠ¤í…œ</span>
                            </a>
                            <a href="/valuation-system" class="block w-full px-4 py-2 bg-blue-600/40 hover:bg-blue-600/60 rounded-lg text-center text-white text-sm transition-all">
                                <i class="fas fa-info-circle mr-1"></i>ì‹œìŠ¤í…œ ì•ˆë‚´
                            </a>
                        </div>
                        <a href="/expert/apply" class="group relative px-8 py-5 bg-gradient-to-br from-amber-600/20 to-orange-600/20 hover:from-amber-600/30 hover:to-orange-600/30 rounded-2xl font-bold text-base inline-flex flex-col items-center justify-center border border-amber-500/30 hover:border-amber-500/60 transition-all duration-300 hover:scale-105">
                            <i class="fas fa-user-tie text-3xl mb-2 text-amber-400 group-hover:text-amber-300 transition-colors"></i>
                            <span class="text-white">ì „ë¬¸ê°€ ì‹ ì²­/í‰ê°€</span>
                        </a>
                        <a href="/signup" class="group relative px-8 py-5 bg-gradient-to-br from-amber-500/20 to-orange-500/20 hover:from-amber-500/30 hover:to-orange-500/30 rounded-2xl font-bold text-base inline-flex flex-col items-center justify-center border border-amber-400/40 hover:border-amber-400/70 transition-all duration-300 hover:scale-105 overflow-hidden">
                            <div class="absolute top-2 right-2 px-2 py-0.5 bg-amber-500 text-xs text-white rounded-full font-bold animate-pulse">NEW</div>
                            <i class="fas fa-handshake text-3xl mb-2 text-amber-400 group-hover:text-amber-300 transition-colors"></i>
                            <span class="text-white">Partnership</span>
                            <span class="text-xs text-amber-300 mt-1">ë¯¸ìˆ ê´€Â·ê°¤ëŸ¬ë¦¬Â·ë”œëŸ¬</span>
                        </a>
                    </div>
                    
                    <!-- ë‘ ë²ˆì§¸ ì¤„: íšŒì› ì•¡ì…˜ ë²„íŠ¼ -->
                    <div class="flex flex-col sm:flex-row justify-center gap-4">
                        <a href="/signup" class="group px-10 py-4 bg-gradient-to-r from-purple-600 to-cyan-500 hover:from-purple-700 hover:to-cyan-600 text-white rounded-xl font-bold text-base inline-flex items-center justify-center shadow-lg shadow-purple-500/30 hover:shadow-purple-500/50 transition-all duration-300 hover:scale-105">
                            <i class="fas fa-user-plus mr-2 text-lg group-hover:rotate-12 transition-transform"></i>
                            <span>íšŒì›ê°€ì…</span>
                        </a>
                        <button id="pwa-install-hero-button" onclick="installPWA()" class="group px-10 py-4 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white rounded-xl font-bold text-base inline-flex items-center justify-center shadow-lg shadow-emerald-500/30 hover:shadow-emerald-500/50 transition-all duration-300 hover:scale-105" style="display: none;" title="í™ˆ í™”ë©´ì— ì•± ì¶”ê°€">
                            <i class="fas fa-download mr-2 text-lg group-hover:scale-110 transition-transform"></i>
                            <span>ì•± ì„¤ì¹˜</span>
                        </button>
                        <a href="/mint" class="group px-10 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-xl font-bold text-base inline-flex items-center justify-center shadow-lg shadow-indigo-500/30 hover:shadow-indigo-500/50 transition-all duration-300 hover:scale-105">
                            <i class="fas fa-magic mr-2 text-lg group-hover:rotate-12 transition-transform"></i>
                            <span>NFT ë¯¼íŒ…</span>
                        </a>
                        <button onclick="connectMetaMask()" class="group px-10 py-4 bg-gradient-to-r from-gray-800 to-gray-900 hover:from-gray-700 hover:to-gray-800 text-white rounded-xl font-bold text-base inline-flex items-center justify-center border border-gray-700 hover:border-gray-600 shadow-lg shadow-gray-900/50 transition-all duration-300 hover:scale-105">
                            <i class="fas fa-wallet mr-2 text-lg group-hover:scale-110 transition-transform"></i>
                            <span id="walletTextMain">ì§€ê°‘ ì—°ê²°</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- í†µê³„ ì¹´ë“œ - Apple ìŠ¤íƒ€ì¼ ì¹´ë“œí˜• ë””ìì¸ -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 max-w-5xl mx-auto">
                <!-- NFT ì‘í’ˆ ì¹´ë“œ -->
                <div class="group rounded-3xl p-6 md:p-8 text-center bg-gradient-to-br from-purple-900/40 via-purple-800/30 to-indigo-900/40 backdrop-blur-xl border border-purple-500/20 hover:border-purple-400/40 transition-all duration-500 hover:scale-[1.02] hover:shadow-2xl hover:shadow-purple-500/20 cursor-pointer">
                    <div class="text-3xl md:text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400 mb-2 group-hover:scale-110 transition-transform duration-300">${stats.data?.total_artworks || 0}</div>
                    <div class="text-gray-300 font-semibold text-xs md:text-sm tracking-wide">NFT ì‘í’ˆ</div>
                </div>
                
                <!-- ì•„í‹°ìŠ¤íŠ¸ ì¹´ë“œ -->
                <div class="group rounded-3xl p-6 md:p-8 text-center bg-gradient-to-br from-amber-900/40 via-orange-800/30 to-yellow-900/40 backdrop-blur-xl border border-amber-500/20 hover:border-amber-400/40 transition-all duration-500 hover:scale-[1.02] hover:shadow-2xl hover:shadow-amber-500/20 cursor-pointer">
                    <div class="text-3xl md:text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-amber-400 to-yellow-300 mb-2 group-hover:scale-110 transition-transform duration-300">${stats.data?.total_artists || 0}</div>
                    <div class="text-gray-300 font-semibold text-xs md:text-sm tracking-wide">ì•„í‹°ìŠ¤íŠ¸</div>
                </div>
                
                <!-- ë¯¼íŒ… ì™„ë£Œ ì¹´ë“œ -->
                <div class="group rounded-3xl p-6 md:p-8 text-center bg-gradient-to-br from-cyan-900/40 via-blue-800/30 to-teal-900/40 backdrop-blur-xl border border-cyan-500/20 hover:border-cyan-400/40 transition-all duration-500 hover:scale-[1.02] hover:shadow-2xl hover:shadow-cyan-500/20 cursor-pointer">
                    <div class="text-3xl md:text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-400 mb-2 group-hover:scale-110 transition-transform duration-300">${stats.data?.minted_nfts || 0}</div>
                    <div class="text-gray-300 font-semibold text-xs md:text-sm tracking-wide">ë¯¼íŒ… ì™„ë£Œ</div>
                </div>
                
                <!-- ì´ ê°€ì¹˜ ì¹´ë“œ -->
                <div class="group rounded-3xl p-6 md:p-8 text-center bg-gradient-to-br from-emerald-900/40 via-green-800/30 to-teal-900/40 backdrop-blur-xl border border-emerald-500/20 hover:border-emerald-400/40 transition-all duration-500 hover:scale-[1.02] hover:shadow-2xl hover:shadow-emerald-500/20 cursor-pointer">
                    <div class="text-3xl md:text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-green-300 mb-2 group-hover:scale-110 transition-transform duration-300">${((stats.data?.total_value || 0) / 100000000).toFixed(0)}ì–µ</div>
                    <div class="text-gray-300 font-semibold text-xs md:text-sm tracking-wide">ì´ ê°€ì¹˜</div>
                </div>
            </div>
        </div>
    </section>

    <!-- ì›”ë“œí´ë˜ìŠ¤ 3ëŒ€ ì‹ ê¸°ëŠ¥ -->
    <section class="py-20 relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-b from-purple-900/10 via-transparent to-transparent"></div>
        <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <div class="inline-block mb-4 px-6 py-2 bg-gradient-to-r from-purple-600/20 to-pink-600/20 backdrop-blur-sm rounded-full border border-purple-500/30">
                    <span class="text-gradient font-bold text-sm">ğŸš€ ì›”ë“œí´ë˜ìŠ¤ í˜ì‹  ê¸°ìˆ </span>
                </div>
                <h2 class="text-5xl md:text-6xl font-black mb-6">
                    <span class="text-white">NFT í”Œë«í¼ì˜</span> <span class="text-gradient">ìƒˆë¡œìš´ ê¸°ì¤€</span>
                </h2>
                <p class="text-xl text-gray-400 max-w-3xl mx-auto">
                    AI ê¸°ë°˜ ì§„ìœ„ ê²€ì¦, ì™„ì „ ìë™í™”ëœ ë¡œì—´í‹°, ê¸€ë¡œë²Œ íŒŒíŠ¸ë„ˆì‹­ìœ¼ë¡œ<br/>
                    ì„¸ê³„ ìµœê³  ìˆ˜ì¤€ì˜ NFT ê±°ë˜ í™˜ê²½ì„ ì œê³µí•©ë‹ˆë‹¤
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- AI ì§„ìœ„ ê²€ì¦ -->
                <div class="group relative">
                    <div class="absolute inset-0 bg-gradient-to-br from-purple-600/20 to-pink-600/20 rounded-3xl blur-xl group-hover:blur-2xl transition-all duration-500"></div>
                    <div class="relative card-nft rounded-3xl p-8 border-2 border-purple-500/30 hover:border-purple-500/60 transition-all duration-500 hover:scale-[1.02]">
                        <div class="w-16 h-16 mb-6 bg-gradient-to-br from-purple-600 to-pink-600 rounded-2xl flex items-center justify-center group-hover:rotate-12 transition-transform duration-500">
                            <i class="fas fa-robot text-3xl text-white"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-4">AI ì§„ìœ„ ê²€ì¦</h3>
                        <p class="text-gray-400 mb-6 leading-relaxed">
                            ë”¥ëŸ¬ë‹ ê¸°ë°˜ ì´ë¯¸ì§€ ë¶„ì„ê³¼ ë¸”ë¡ì²´ì¸ ì¶”ì ìœ¼ë¡œ ì‘í’ˆì˜ ì§„ìœ„ì„±ì„ ìë™ìœ¼ë¡œ ê²€ì¦í•©ë‹ˆë‹¤
                        </p>
                        <ul class="space-y-2 mb-6">
                            <li class="flex items-start text-sm text-gray-300">
                                <i class="fas fa-check text-purple-400 mr-2 mt-1"></i>
                                <span>ì‹¤ì‹œê°„ ìœ„ì¡°í’ˆ íƒì§€</span>
                            </li>
                            <li class="flex items-start text-sm text-gray-300">
                                <i class="fas fa-check text-purple-400 mr-2 mt-1"></i>
                                <span>ë¸”ë¡ì²´ì¸ ê¸°ë¡ ìë™ ì¶”ì </span>
                            </li>
                            <li class="flex items-start text-sm text-gray-300">
                                <i class="fas fa-check text-purple-400 mr-2 mt-1"></i>
                                <span>ì „ë¬¸ê°€ 2ì°¨ ê²€ì¦ ì‹œìŠ¤í…œ</span>
                            </li>
                        </ul>
                        <a href="/admin/authenticity" class="inline-flex items-center text-purple-400 hover:text-purple-300 font-semibold group/link">
                            ìì„¸íˆ ë³´ê¸°
                            <i class="fas fa-arrow-right ml-2 group-hover/link:translate-x-1 transition-transform"></i>
                        </a>
                    </div>
                </div>

                <!-- ë¡œì—´í‹° ìë™í™” -->
                <div class="group relative">
                    <div class="absolute inset-0 bg-gradient-to-br from-blue-600/20 to-cyan-600/20 rounded-3xl blur-xl group-hover:blur-2xl transition-all duration-500"></div>
                    <div class="relative card-nft rounded-3xl p-8 border-2 border-blue-500/30 hover:border-blue-500/60 transition-all duration-500 hover:scale-[1.02]">
                        <div class="w-16 h-16 mb-6 bg-gradient-to-br from-blue-600 to-cyan-600 rounded-2xl flex items-center justify-center group-hover:rotate-12 transition-transform duration-500">
                            <i class="fas fa-coins text-3xl text-white"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-4">ë¡œì—´í‹° ìë™í™”</h3>
                        <p class="text-gray-400 mb-6 leading-relaxed">
                            ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸ ê¸°ë°˜ ìë™ ë¶„ë°°ë¡œ ì‘ê°€ì™€ ì¤‘ê°œì¸ì˜ ìˆ˜ìµì„ ì‹¤ì‹œê°„ ì •ì‚°í•©ë‹ˆë‹¤
                        </p>
                        <ul class="space-y-2 mb-6">
                            <li class="flex items-start text-sm text-gray-300">
                                <i class="fas fa-check text-blue-400 mr-2 mt-1"></i>
                                <span>ê±°ë˜ ì¦‰ì‹œ ìë™ ì •ì‚°</span>
                            </li>
                            <li class="flex items-start text-sm text-gray-300">
                                <i class="fas fa-check text-blue-400 mr-2 mt-1"></i>
                                <span>íˆ¬ëª…í•œ ìˆ˜ìµ ë°°ë¶„</span>
                            </li>
                            <li class="flex items-start text-sm text-gray-300">
                                <i class="fas fa-check text-blue-400 mr-2 mt-1"></i>
                                <span>ì‹¤ì‹œê°„ ìˆ˜ìµ ëŒ€ì‹œë³´ë“œ</span>
                            </li>
                        </ul>
                        <a href="/admin/royalty" class="inline-flex items-center text-blue-400 hover:text-blue-300 font-semibold group/link">
                            ìì„¸íˆ ë³´ê¸°
                            <i class="fas fa-arrow-right ml-2 group-hover/link:translate-x-1 transition-transform"></i>
                        </a>
                    </div>
                </div>

                <!-- Museum Partnership -->
                <div class="group relative">
                    <div class="absolute inset-0 bg-gradient-to-br from-amber-600/20 to-orange-600/20 rounded-3xl blur-xl group-hover:blur-2xl transition-all duration-500"></div>
                    <div class="relative card-nft rounded-3xl p-8 border-2 border-amber-500/30 hover:border-amber-500/60 transition-all duration-500 hover:scale-[1.02]">
                        <div class="w-16 h-16 mb-6 bg-gradient-to-br from-amber-600 to-orange-600 rounded-2xl flex items-center justify-center group-hover:rotate-12 transition-transform duration-500">
                            <i class="fas fa-handshake text-3xl text-white"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-4">ê¸€ë¡œë²Œ íŒŒíŠ¸ë„ˆì‹­</h3>
                        <p class="text-gray-400 mb-6 leading-relaxed">
                            ë¯¸ìˆ ê´€, ê°¤ëŸ¬ë¦¬, ì•„íŠ¸ë”œëŸ¬ì™€ í˜‘ë ¥í•˜ì—¬ ê²€ì¦ëœ ì‘í’ˆë§Œì„ íë ˆì´ì…˜í•©ë‹ˆë‹¤
                        </p>
                        <ul class="space-y-2 mb-6">
                            <li class="flex items-start text-sm text-gray-300">
                                <i class="fas fa-check text-amber-400 mr-2 mt-1"></i>
                                <span>ì„¸ê³„ì  ë¯¸ìˆ ê´€ ì—°ê³„</span>
                            </li>
                            <li class="flex items-start text-sm text-gray-300">
                                <i class="fas fa-check text-amber-400 mr-2 mt-1"></i>
                                <span>ì „ë¬¸ ê°¤ëŸ¬ë¦¬ íë ˆì´ì…˜</span>
                            </li>
                            <li class="flex items-start text-sm text-gray-300">
                                <i class="fas fa-check text-amber-400 mr-2 mt-1"></i>
                                <span>ê²€ì¦ëœ ì•„íŠ¸ë”œëŸ¬ ë„¤íŠ¸ì›Œí¬</span>
                            </li>
                        </ul>
                        <a href="/museum/apply" class="inline-flex items-center text-amber-400 hover:text-amber-300 font-semibold group/link">
                            íŒŒíŠ¸ë„ˆ ì‹ ì²­
                            <i class="fas fa-arrow-right ml-2 group-hover/link:translate-x-1 transition-transform"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- ì‹ ë¢° ë°°ì§€ -->
            <div class="mt-16 text-center">
                <div class="inline-flex items-center gap-8 px-8 py-4 bg-white/5 backdrop-blur-sm rounded-2xl border border-white/10">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-shield-check text-2xl text-green-400"></i>
                        <span class="text-white font-semibold">100% ê²€ì¦ëœ ì‘í’ˆ</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-lock text-2xl text-blue-400"></i>
                        <span class="text-white font-semibold">ë¸”ë¡ì²´ì¸ ë³´ì•ˆ</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-globe text-2xl text-purple-400"></i>
                        <span class="text-white font-semibold">ê¸€ë¡œë²Œ ë„¤íŠ¸ì›Œí¬</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Featured NFTs -->
    <section class="py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center mb-12">
                <div>
                    <h2 class="text-5xl font-black mb-3">
                        <span class="text-gradient">Featured</span> <span class="text-white">NFTs</span>
                    </h2>
                    <p class="text-gray-500">ê°€ì¥ ê°€ì¹˜ìˆëŠ” í”„ë¦¬ë¯¸ì—„ ì»¬ë ‰ì…˜</p>
                </div>
                <a href="/gallery" class="text-gradient hover:opacity-80 font-bold flex items-center group">
                    ì „ì²´ ë³´ê¸°
                    <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                </a>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                ${artworks.data?.map((artwork: any, index: number) => `
                    <a href="/artwork/${artwork.id}" class="card-nft rounded-3xl overflow-hidden group">
                        <div class="relative aspect-square bg-gray-900 overflow-hidden">
                            <img src="${artwork.image_url}" 
                                 alt="${artwork.title}" 
                                 class="w-full h-full object-cover img-nft"
                                 loading="lazy"
                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/800x800/1a1a1a/8b5cf6?text=${encodeURIComponent(artwork.title)}'">
                            <div class="absolute top-4 right-4">
                                <span class="px-3 py-1.5 bg-black bg-opacity-80 backdrop-blur-sm text-white text-xs font-bold rounded-full border border-white border-opacity-20">
                                    ${artwork.category}
                                </span>
                            </div>
                            <div class="absolute top-4 left-4 flex flex-col gap-2">
                                <span class="px-3 py-1.5 bg-gradient-to-r from-purple-600 to-cyan-500 text-white text-xs font-bold rounded-full flex items-center">
                                    <i class="fas fa-cube mr-1.5"></i>NFT
                                </span>
                                ${index < 3 ? `
                                <span class="px-3 py-1.5 bg-gradient-to-r from-amber-500 to-yellow-500 text-white text-xs font-bold rounded-full flex items-center">
                                    <i class="fas fa-crown mr-1.5"></i>TOP ${index + 1}
                                </span>
                                ` : ''}
                            </div>
                            <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-60"></div>
                        </div>
                        <div class="p-6">
                            <h3 class="font-bold text-xl text-white mb-3 line-clamp-1">${artwork.title}</h3>
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center flex-1 min-w-0">
                                    <img src="${artwork.artist_profile_image || 'https://via.placeholder.com/100/8b5cf6/ffffff?text=' + encodeURIComponent(artwork.artist_name?.charAt(0) || '?')}" 
                                         class="w-8 h-8 rounded-full mr-2 object-cover border border-white border-opacity-20 flex-shrink-0"
                                         alt="${artwork.artist_name}"
                                         loading="lazy"
                                         onerror="this.onerror=null; this.src='https://via.placeholder.com/100/8b5cf6/ffffff?text=${encodeURIComponent(artwork.artist_name?.charAt(0) || '?')}'">
                                    <span class="text-sm text-gray-400 font-medium truncate">${artwork.artist_name}</span>
                                </div>
                                ${artwork.average_rating > 0 ? `
                                <div class="flex items-center gap-1 ml-2 flex-shrink-0">
                                    <i class="fas fa-star text-yellow-400 text-xs"></i>
                                    <span class="text-xs text-yellow-400 font-bold">${artwork.average_rating.toFixed(1)}</span>
                                </div>
                                ` : ''}
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">ì‚°ì •ê°€</div>
                                    <div class="font-black text-lg text-gradient">${formatPrice(artwork.estimated_value)}</div>
                                </div>
                                <div class="flex items-center space-x-3 text-gray-500 text-sm">
                                    <span class="flex items-center"><i class="fas fa-eye mr-1"></i>${artwork.views_count || 0}</span>
                                    <span class="flex items-center"><i class="fas fa-heart mr-1"></i>${artwork.likes_count || 0}</span>
                                </div>
                            </div>
                        </div>
                    </a>
                `).join('') || '<div class="col-span-full text-center text-gray-500 py-20"><i class="fas fa-image text-6xl mb-4 opacity-20"></i><p class="text-xl">ë“±ë¡ëœ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p></div>'}
            </div>
        </div>
    </section>

    <!-- v6.0: ì¶”ì²œ ì‘í’ˆ ì„¹ì…˜ -->
    <section class="py-20 bg-gradient-to-b from-transparent to-purple-900/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center mb-12">
                <div>
                    <h2 class="text-5xl font-black mb-3">
                        <span class="text-gradient">ì¶”ì²œ</span> <span class="text-white">ì‘í’ˆ</span>
                    </h2>
                    <p class="text-gray-500">ì „ë¬¸ê°€ í‰ê°€ê°€ ìš°ìˆ˜í•œ ì—„ì„ ëœ ì»¬ë ‰ì…˜</p>
                </div>
                <a href="/gallery?filter=recommended" class="text-gradient hover:opacity-80 font-bold flex items-center group">
                    ì „ì²´ ë³´ê¸°
                    <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                </a>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                ${recommended.data?.map((artwork: any) => `
                    <a href="/artwork/${artwork.id}" class="card-nft rounded-3xl overflow-hidden group">
                        <div class="relative aspect-square bg-gray-900 overflow-hidden">
                            <img src="${artwork.image_url}" 
                                 alt="${artwork.title}" 
                                 class="w-full h-full object-cover img-nft"
                                 loading="lazy"
                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/800x800/1a1a1a/8b5cf6?text=${encodeURIComponent(artwork.title)}'">
                            <div class="absolute top-4 right-4">
                                <span class="px-3 py-1.5 bg-black bg-opacity-80 backdrop-blur-sm text-white text-xs font-bold rounded-full border border-white border-opacity-20">
                                    ${artwork.category}
                                </span>
                            </div>
                            <div class="absolute top-4 left-4">
                                <span class="px-3 py-1.5 bg-gradient-to-r from-amber-500 to-orange-500 text-white text-xs font-bold rounded-full flex items-center">
                                    <i class="fas fa-star mr-1.5"></i>ì¶”ì²œ
                                </span>
                            </div>
                            <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-60"></div>
                        </div>
                        <div class="p-6">
                            <h3 class="font-bold text-xl text-white mb-3 line-clamp-1">${artwork.title}</h3>
                            <div class="flex items-center mb-4">
                                <img src="${artwork.artist_profile_image || 'https://via.placeholder.com/100/f59e0b/ffffff?text=' + encodeURIComponent(artwork.artist_name?.charAt(0) || '?')}" 
                                     class="w-8 h-8 rounded-full mr-2 object-cover border border-white border-opacity-20"
                                     alt="${artwork.artist_name}"
                                     loading="lazy"
                                     onerror="this.onerror=null; this.src='https://via.placeholder.com/100/f59e0b/ffffff?text=${encodeURIComponent(artwork.artist_name?.charAt(0) || '?')}'">
                                <span class="text-sm text-gray-400 font-medium">${artwork.artist_name}</span>
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">ì‚°ì •ê°€</div>
                                    <div class="font-black text-lg text-gradient">${formatPrice(artwork.estimated_value)}</div>
                                </div>
                                <div class="flex items-center space-x-3 text-gray-500 text-sm">
                                    <span class="flex items-center"><i class="fas fa-eye mr-1"></i>${artwork.views_count || 0}</span>
                                    <span class="flex items-center"><i class="fas fa-heart mr-1"></i>${artwork.likes_count || 0}</span>
                                </div>
                            </div>
                        </div>
                    </a>
                `).join('') || '<div class="col-span-full text-center text-gray-500 py-20"><i class="fas fa-star text-6xl mb-4 opacity-20"></i><p class="text-xl">í‰ì  4.0 ì´ìƒì˜ ì¶”ì²œ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p><p class="text-sm mt-2">ì „ë¬¸ê°€ í‰ê°€ë¥¼ ë°›ì€ ìš°ìˆ˜í•œ ì‘í’ˆì´ ê³§ ì¶”ê°€ë©ë‹ˆë‹¤.</p></div>'}
            </div>
        </div>
    </section>

    <!-- v6.0: ì¸ê¸° ì‘í’ˆ ì„¹ì…˜ -->
    <section class="py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center mb-12">
                <div>
                    <h2 class="text-5xl font-black mb-3">
                        <span class="text-gradient">ì¸ê¸°</span> <span class="text-white">ì‘í’ˆ</span>
                    </h2>
                    <p class="text-gray-500">ê°€ì¥ ë§ì€ ê´€ì‹¬ì„ ë°›ê³  ìˆëŠ” ì‘í’ˆ</p>
                </div>
                <a href="/gallery?filter=popular" class="text-gradient hover:opacity-80 font-bold flex items-center group">
                    ì „ì²´ ë³´ê¸°
                    <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                </a>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                ${popular.data?.map((artwork: any) => `
                    <a href="/artwork/${artwork.id}" class="card-nft rounded-3xl overflow-hidden group">
                        <div class="relative aspect-square bg-gray-900 overflow-hidden">
                            <img src="${artwork.image_url}" 
                                 alt="${artwork.title}" 
                                 class="w-full h-full object-cover img-nft"
                                 loading="lazy"
                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/800x800/1a1a1a/ef4444?text=${encodeURIComponent(artwork.title)}'">
                            <div class="absolute top-4 right-4">
                                <span class="px-3 py-1.5 bg-black bg-opacity-80 backdrop-blur-sm text-white text-xs font-bold rounded-full border border-white border-opacity-20">
                                    ${artwork.category}
                                </span>
                            </div>
                            <div class="absolute top-4 left-4">
                                <span class="px-3 py-1.5 bg-gradient-to-r from-red-500 to-pink-500 text-white text-xs font-bold rounded-full flex items-center">
                                    <i class="fas fa-fire mr-1.5"></i>ì¸ê¸°
                                </span>
                            </div>
                            <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-60"></div>
                        </div>
                        <div class="p-6">
                            <h3 class="font-bold text-xl text-white mb-3 line-clamp-1">${artwork.title}</h3>
                            <div class="flex items-center mb-4">
                                <img src="${artwork.artist_profile_image || 'https://via.placeholder.com/100/ef4444/ffffff?text=' + encodeURIComponent(artwork.artist_name?.charAt(0) || '?')}" 
                                     class="w-8 h-8 rounded-full mr-2 object-cover border border-white border-opacity-20"
                                     alt="${artwork.artist_name}"
                                     loading="lazy"
                                     onerror="this.onerror=null; this.src='https://via.placeholder.com/100/ef4444/ffffff?text=${encodeURIComponent(artwork.artist_name?.charAt(0) || '?')}'">
                                <span class="text-sm text-gray-400 font-medium">${artwork.artist_name}</span>
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">ì‚°ì •ê°€</div>
                                    <div class="font-black text-lg text-gradient">${formatPrice(artwork.estimated_value)}</div>
                                </div>
                                <div class="flex items-center space-x-3 text-gray-500 text-sm">
                                    <span class="flex items-center"><i class="fas fa-eye mr-1"></i>${artwork.views_count || 0}</span>
                                    <span class="flex items-center"><i class="fas fa-heart mr-1"></i>${artwork.likes_count || 0}</span>
                                </div>
                            </div>
                        </div>
                    </a>
                `).join('') || '<div class="col-span-full text-center text-gray-500 py-20"><i class="fas fa-fire text-6xl mb-4 opacity-20"></i><p class="text-xl">ì¸ê¸° ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p><p class="text-sm mt-2">ì¡°íšŒìˆ˜ì™€ ì¢‹ì•„ìš”ê°€ ë§ì€ ì‘í’ˆì´ ê³§ ì¶”ê°€ë©ë‹ˆë‹¤.</p></div>'}
            </div>
        </div>
    </section>

    <!-- v6.0: ì‹ ê·œ ì‘í’ˆ ì„¹ì…˜ -->
    <section class="py-20 bg-gradient-to-b from-transparent to-cyan-900/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center mb-12">
                <div>
                    <h2 class="text-5xl font-black mb-3">
                        <span class="text-gradient">ì‹ ê·œ</span> <span class="text-white">ì‘í’ˆ</span>
                    </h2>
                    <p class="text-gray-500">ìµœê·¼ ë“±ë¡ëœ ë”°ëˆë”°ëˆí•œ ì‹ ì‘</p>
                </div>
                <a href="/gallery?filter=recent" class="text-gradient hover:opacity-80 font-bold flex items-center group">
                    ì „ì²´ ë³´ê¸°
                    <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                </a>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                ${recent.data?.map((artwork: any) => `
                    <a href="/artwork/${artwork.id}" class="card-nft rounded-3xl overflow-hidden group">
                        <div class="relative aspect-square bg-gray-900 overflow-hidden">
                            <img src="${artwork.image_url}" 
                                 alt="${artwork.title}" 
                                 class="w-full h-full object-cover img-nft"
                                 loading="lazy"
                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/800x800/1a1a1a/10b981?text=${encodeURIComponent(artwork.title)}'">
                            <div class="absolute top-4 right-4">
                                <span class="px-3 py-1.5 bg-black bg-opacity-80 backdrop-blur-sm text-white text-xs font-bold rounded-full border border-white border-opacity-20">
                                    ${artwork.category}
                                </span>
                            </div>
                            <div class="absolute top-4 left-4">
                                <span class="px-3 py-1.5 bg-gradient-to-r from-green-500 to-cyan-500 text-white text-xs font-bold rounded-full flex items-center">
                                    <i class="fas fa-sparkles mr-1.5"></i>NEW
                                </span>
                            </div>
                            <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-60"></div>
                        </div>
                        <div class="p-6">
                            <h3 class="font-bold text-xl text-white mb-3 line-clamp-1">${artwork.title}</h3>
                            <div class="flex items-center mb-4">
                                <img src="${artwork.artist_profile_image || 'https://via.placeholder.com/100/10b981/ffffff?text=' + encodeURIComponent(artwork.artist_name?.charAt(0) || '?')}" 
                                     class="w-8 h-8 rounded-full mr-2 object-cover border border-white border-opacity-20"
                                     alt="${artwork.artist_name}"
                                     loading="lazy"
                                     onerror="this.onerror=null; this.src='https://via.placeholder.com/100/10b981/ffffff?text=${encodeURIComponent(artwork.artist_name?.charAt(0) || '?')}'">
                                <span class="text-sm text-gray-400 font-medium">${artwork.artist_name}</span>
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">ì‚°ì •ê°€</div>
                                    <div class="font-black text-lg text-gradient">${formatPrice(artwork.estimated_value)}</div>
                                </div>
                                <div class="flex items-center space-x-3 text-gray-500 text-sm">
                                    <span class="flex items-center"><i class="fas fa-eye mr-1"></i>${artwork.views_count || 0}</span>
                                    <span class="flex items-center"><i class="fas fa-heart mr-1"></i>${artwork.likes_count || 0}</span>
                                </div>
                            </div>
                        </div>
                    </a>
                `).join('') || '<div class="col-span-full text-center text-gray-500 py-20"><i class="fas fa-sparkles text-6xl mb-4 opacity-20"></i><p class="text-xl">ì‹ ê·œ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p><p class="text-sm mt-2">ê³§ ìƒˆë¡œìš´ ì‘í’ˆì´ ë“±ë¡ë©ë‹ˆë‹¤.</p></div>'}
            </div>
        </div>
    </section>

    <!-- ê°€ì¹˜ì‚°ì • ì‹œìŠ¤í…œ -->
    <section class="py-20 relative overflow-hidden">
        <div class="hero-gradient absolute inset-0"></div>
        <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <h2 class="text-4xl md:text-5xl font-black mb-4">
                    <span class="text-gradient">ì…€í”„ê°€ì¹˜ì‚°ì • ì‹œìŠ¤í…œ</span>
                </h2>
                <p class="text-gray-400 text-base md:text-lg font-light leading-relaxed max-w-3xl mx-auto">
                    ì „ë¬¸ê°€ íŒ¨ë„ì˜ ì •ì„±í‰ê°€ì™€ ë°ì´í„° ê¸°ë°˜ì˜ ì •ëŸ‰í‰ê°€ë¥¼ ê²°í•©í•˜ì—¬<br class="hidden md:block"/>
                    íˆ¬ëª…í•˜ê³  ê°ê´€ì ì¸ NFT ë¯¸ìˆ í’ˆ ê°€ì¹˜ì‚°ì •ì„ ì œê³µí•©ë‹ˆë‹¤
                </p>
            </div>
            
            <div class="grid md:grid-cols-2 gap-10">
                <!-- ì •ëŸ‰ì  í‰ê°€ ì¹´ë“œ -->
                <div class="group rounded-3xl p-10 bg-gradient-to-br from-blue-900/40 to-cyan-900/30 border border-blue-500/30 hover:border-blue-400/60 transition-all duration-500 hover:scale-105 hover:shadow-2xl hover:shadow-blue-500/20">
                    <div class="flex items-center mb-8">
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center mr-5 group-hover:scale-110 group-hover:rotate-6 transition-transform duration-500">
                            <i class="fas fa-chart-line text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="text-3xl font-black text-white mb-1">ì •ëŸ‰ì  í‰ê°€</h3>
                            <div class="text-blue-400 text-sm font-semibold">Quantitative Analysis</div>
                        </div>
                    </div>
                    <ul class="space-y-5">
                        <li class="flex items-start group/item">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0 mt-0.5 group-hover/item:scale-110 transition-transform">
                                <i class="fas fa-fire text-white text-base"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white mb-2 text-lg">ì‹œì¥ ìˆ˜ìš”ë„</div>
                                <div class="text-gray-300 text-sm leading-relaxed">NFT ë§ˆì¼“ íŠ¸ë Œë“œ ë° ê±°ë˜ëŸ‰ ë¶„ì„</div>
                                <div class="mt-2 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full" style="width: 85%"></div>
                                </div>
                            </div>
                        </li>
                        <li class="flex items-start group/item">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0 mt-0.5 group-hover/item:scale-110 transition-transform">
                                <i class="fas fa-gem text-white text-base"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white mb-2 text-lg">í¬ì†Œì„±</div>
                                <div class="text-gray-300 text-sm leading-relaxed">ì—ë””ì…˜ ìˆ˜ ë° ìœ ì‚¬ NFT ë¹„êµ ë¶„ì„</div>
                                <div class="mt-2 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full" style="width: 92%"></div>
                                </div>
                            </div>
                        </li>
                        <li class="flex items-start group/item">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0 mt-0.5 group-hover/item:scale-110 transition-transform">
                                <i class="fas fa-history text-white text-base"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white mb-2 text-lg">ê±°ë˜ ì´ë ¥</div>
                                <div class="text-gray-300 text-sm leading-relaxed">ê³¼ê±° ê±°ë˜ ë‚´ì—­ ë° ê°€ê²© ë³€ë™ ì¶”ì´</div>
                                <div class="mt-2 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full" style="width: 78%"></div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
                
                <!-- ì •ì„±ì  í‰ê°€ ì¹´ë“œ -->
                <div class="group rounded-3xl p-10 bg-gradient-to-br from-purple-900/40 to-pink-900/30 border border-purple-500/30 hover:border-purple-400/60 transition-all duration-500 hover:scale-105 hover:shadow-2xl hover:shadow-purple-500/20">
                    <div class="flex items-center mb-8">
                        <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center mr-5 group-hover:scale-110 group-hover:rotate-6 transition-transform duration-500">
                            <i class="fas fa-star text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="text-3xl font-black text-white mb-1">ì •ì„±ì  í‰ê°€</h3>
                            <div class="text-purple-400 text-sm font-semibold">Qualitative Analysis</div>
                        </div>
                    </div>
                    <ul class="space-y-5">
                        <li class="flex items-start group/item">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0 mt-0.5 group-hover/item:scale-110 transition-transform">
                                <i class="fas fa-palette text-white text-base"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white mb-2 text-lg">ì˜ˆìˆ ì  ì™„ì„±ë„</div>
                                <div class="text-gray-300 text-sm leading-relaxed">ë””ìì¸ í’ˆì§ˆ ë° ë¯¸ì  ì™„ì„±ë„ í‰ê°€</div>
                                <div class="mt-2 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full" style="width: 95%"></div>
                                </div>
                            </div>
                        </li>
                        <li class="flex items-start group/item">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0 mt-0.5 group-hover/item:scale-110 transition-transform">
                                <i class="fas fa-lightbulb text-white text-base"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white mb-2 text-lg">ë…ì°½ì„±</div>
                                <div class="text-gray-300 text-sm leading-relaxed">ì•„í‹°ìŠ¤íŠ¸ì˜ ê³ ìœ í•œ ìŠ¤íƒ€ì¼ê³¼ ì°½ì˜ì„±</div>
                                <div class="mt-2 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full" style="width: 88%"></div>
                                </div>
                            </div>
                        </li>
                        <li class="flex items-start group/item">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0 mt-0.5 group-hover/item:scale-110 transition-transform">
                                <i class="fas fa-user-tie text-white text-base"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white mb-2 text-lg">ì „ë¬¸ê°€ í‰ì </div>
                                <div class="text-gray-300 text-sm leading-relaxed">ê²€ì¦ëœ ì „ë¬¸ê°€ íŒ¨ë„ì˜ ì¢…í•© í‰ê°€</div>
                                <div class="mt-2 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full" style="width: 91%"></div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </section>
    
    <script>
      function formatPrice(price) {
        if (price >= 100000000) return (price / 100000000).toFixed(1) + 'ì–µì›';
        else if (price >= 10000) return (price / 10000).toFixed(0) + 'ë§Œì›';
        return price.toLocaleString() + 'ì›';
      }

      // ìŒì„± ê²€ìƒ‰ (ë©”ì¸ í˜ì´ì§€ìš©)
      function startVoiceSearch() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          alert('âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\\n\\nChrome, Edge, Safari ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
          return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'ko-KR';
        recognition.continuous = false;
        recognition.interimResults = false;

        const searchInput = document.getElementById('aiSearchInput');
        
        // ìŒì„± ì¸ì‹ ì‹œì‘ ì•Œë¦¼
        searchInput.placeholder = 'ğŸ¤ ë“£ê³  ìˆìŠµë‹ˆë‹¤... ë§ì”€í•´ì£¼ì„¸ìš”';
        searchInput.classList.add('border-purple-500', 'bg-purple-900/20');

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          searchInput.value = transcript;
          searchInput.placeholder = 'AIë¡œ ì‘í’ˆ ê²€ìƒ‰... (í…ìŠ¤íŠ¸, ìŒì„± ì§€ì›)';
          searchInput.classList.remove('border-purple-500', 'bg-purple-900/20');
          
          // ì¸ì‹ëœ í…ìŠ¤íŠ¸ë¡œ ì¦‰ì‹œ ê²€ìƒ‰
          setTimeout(() => performAISearch(), 500);
        };

        recognition.onerror = (event) => {
          console.error('Speech recognition error:', event.error);
          searchInput.placeholder = 'âŒ ìŒì„± ì¸ì‹ ì˜¤ë¥˜ - ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”';
          searchInput.classList.remove('border-purple-500', 'bg-purple-900/20');
          setTimeout(() => {
            searchInput.placeholder = 'AIë¡œ ì‘í’ˆ ê²€ìƒ‰... (í…ìŠ¤íŠ¸, ìŒì„± ì§€ì›)';
          }, 2000);
        };

        recognition.onend = () => {
          searchInput.classList.remove('border-purple-500', 'bg-purple-900/20');
        };

        recognition.start();
      }

      // AI ê²€ìƒ‰ ìˆ˜í–‰ (ë©”ì¸ í˜ì´ì§€ìš©)
      async function performAISearch() {
        const searchInput = document.getElementById('aiSearchInput');
        const query = searchInput?.value?.trim();
        
        if (!query) {
          alert('ğŸ” ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // AI ë¶„ì„ ì¤‘ í‘œì‹œ
        searchInput.placeholder = 'ğŸ¤– AIê°€ ì‘í’ˆì„ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
        searchInput.disabled = true;
        
        try {
          // API í˜¸ì¶œí•˜ì—¬ ê²€ìƒ‰
          const response = await axios.get('/api/artworks', {
            params: {
              search: query,
              limit: 20
            }
          });
          
          const artworks = response.data.data || [];
          
          if (artworks.length > 0) {
            // ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ê°¤ëŸ¬ë¦¬ í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = '/gallery?search=' + encodeURIComponent(query);
          } else {
            alert('âŒ "' + query + '"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.\\n\\në‹¤ë¥¸ ê²€ìƒ‰ì–´ë¡œ ì‹œë„í•´ë³´ì„¸ìš”.');
            searchInput.value = '';
          }
        } catch (error) {
          console.error('Search error:', error);
          alert('âŒ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\\n\\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        } finally {
          searchInput.disabled = false;
          searchInput.placeholder = 'AIë¡œ ì‘í’ˆ ê²€ìƒ‰... (í…ìŠ¤íŠ¸, ìŒì„± ì§€ì›)';
        }
      }
    </script>
    `;
    
    return c.html(getLayout(content))
  } catch (error: any) {
    return c.html(getLayout('<div class="py-20 text-center text-red-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>'))
  }
})

// ============================================
// ì¶”ì²œ í˜ì´ì§€ (ML-Based Recommendations)
// ============================================
app.get('/recommendations', (c) => {
  const content = `
    <section class="py-20" id="main-content" tabindex="-1">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <div class="inline-block mb-6 px-6 py-2 bg-gradient-to-r from-purple-600/20 to-cyan-600/20 backdrop-blur-sm rounded-full border border-purple-500/30">
                    <span class="text-gradient font-bold text-sm">ğŸ¤– AI RECOMMENDATIONS</span>
                </div>
                <h1 class="text-6xl font-black mb-6">
                    <span class="text-white">ë‹¹ì‹ ì„ ìœ„í•œ</span> <span class="text-gradient">ì¶”ì²œ ì‘í’ˆ</span>
                </h1>
                <p class="text-gray-400 text-xl max-w-3xl mx-auto">
                    AI ê¸°ë°˜ ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ì·¨í–¥ì— ë§ëŠ” ì‘í’ˆì„ ë°œê²¬í•˜ì„¸ìš”
                </p>
            </div>
            
            <!-- ì¶”ì²œ íƒ­ -->
            <div class="flex flex-wrap gap-3 mb-12 justify-center">
                <button onclick="loadRecommendations('personalized')" class="rec-tab active px-6 py-3 bg-purple-600/20 hover:bg-purple-600/30 text-purple-300 rounded-xl transition-all border border-purple-500/30 hover:border-purple-400/50 font-semibold" data-tab="personalized">
                    <i class="fas fa-user-circle mr-2"></i>ë§ì¶¤ ì¶”ì²œ
                </button>
                <button onclick="loadRecommendations('trending')" class="rec-tab px-6 py-3 bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white rounded-xl transition-all border border-white/10 hover:border-white/20 font-semibold" data-tab="trending">
                    <i class="fas fa-fire mr-2"></i>ì¸ê¸° ê¸‰ìƒìŠ¹
                </button>
                <button onclick="loadRecommendations('new')" class="rec-tab px-6 py-3 bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white rounded-xl transition-all border border-white/10 hover:border-white/20 font-semibold" data-tab="new">
                    <i class="fas fa-sparkles mr-2"></i>ì‹ ê·œ ì‘í’ˆ
                </button>
            </div>
            
            <!-- ë¡œë”© ìƒíƒœ -->
            <div id="recommendations-loading" class="text-center py-20">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-500 mx-auto mb-4"></div>
                <p class="text-gray-400">ì¶”ì²œ ì‘í’ˆì„ ë¶„ì„í•˜ëŠ” ì¤‘...</p>
            </div>
            
            <!-- ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜ ì„¤ëª… -->
            <div id="recommendations-meta" class="hidden mb-8 p-6 bg-gradient-to-br from-purple-900/20 via-pink-900/20 to-cyan-900/20 backdrop-blur-sm rounded-2xl border border-purple-500/20">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-bold text-white mb-2 flex items-center">
                            <i class="fas fa-robot text-purple-400 mr-2"></i>
                            <span id="algorithm-name">í•˜ì´ë¸Œë¦¬ë“œ ì¶”ì²œ</span>
                        </h3>
                        <p class="text-sm text-gray-400" id="algorithm-description">
                            ë‹¹ì‹ ì˜ ì·¨í–¥ê³¼ í–‰ë™ íŒ¨í„´ì„ ë¶„ì„í•˜ì—¬ ìµœì ì˜ ì‘í’ˆì„ ì¶”ì²œí•©ë‹ˆë‹¤
                        </p>
                    </div>
                    <div class="hidden md:flex items-center space-x-4 text-sm">
                        <div class="text-center px-4 py-2 bg-purple-600/20 rounded-lg">
                            <div class="text-2xl font-bold text-gradient" id="rec-count">0</div>
                            <div class="text-xs text-gray-400">ì¶”ì²œ ì‘í’ˆ</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ì¶”ì²œ ì‘í’ˆ ê·¸ë¦¬ë“œ -->
            <div id="recommendations-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
            
            <!-- ë¹ˆ ìƒíƒœ -->
            <div id="recommendations-empty" class="hidden text-center py-20">
                <i class="fas fa-heart-broken text-6xl text-gray-700 mb-4"></i>
                <h3 class="text-2xl font-bold text-white mb-2">ì•„ì§ ì¶”ì²œí•  ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤</h3>
                <p class="text-gray-400 mb-8">ì‘í’ˆì„ ë‘˜ëŸ¬ë³´ê³  ì¢‹ì•„ìš”ë¥¼ ëˆŒëŸ¬ ì·¨í–¥ì„ ì•Œë ¤ì£¼ì„¸ìš”!</p>
                <a href="/gallery" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-purple-600 to-cyan-600 text-white font-bold rounded-xl hover:scale-105 transition-all">
                    <i class="fas fa-palette mr-2"></i>
                    ê°¤ëŸ¬ë¦¬ ë‘˜ëŸ¬ë³´ê¸°
                </a>
            </div>
        </div>
    </section>
    
    <script>
        let currentTab = 'personalized';
        
        // ì¶”ì²œ ë¡œë“œ í•¨ìˆ˜
        async function loadRecommendations(type) {
            currentTab = type;
            
            // íƒ­ í™œì„±í™”
            document.querySelectorAll('.rec-tab').forEach(tab => {
                if (tab.dataset.tab === type) {
                    tab.classList.add('active', 'bg-purple-600/20', 'text-purple-300', 'border-purple-500/30');
                    tab.classList.remove('bg-white/5', 'text-gray-400', 'border-white/10');
                } else {
                    tab.classList.remove('active', 'bg-purple-600/20', 'text-purple-300', 'border-purple-500/30');
                    tab.classList.add('bg-white/5', 'text-gray-400', 'border-white/10');
                }
            });
            
            // UI ìƒíƒœ
            document.getElementById('recommendations-loading').classList.remove('hidden');
            document.getElementById('recommendations-grid').innerHTML = '';
            document.getElementById('recommendations-meta').classList.add('hidden');
            document.getElementById('recommendations-empty').classList.add('hidden');
            
            try {
                const token = localStorage.getItem('token');
                const headers = { 'Content-Type': 'application/json' };
                if (token) {
                    headers['Authorization'] = \`Bearer \${token}\`;
                }
                
                let url = \`/api/recommendations/\${type}\`;
                const response = await fetch(url, { headers });
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    displayRecommendations(result.data, result.meta);
                } else {
                    document.getElementById('recommendations-empty').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Failed to load recommendations:', error);
                showErrorToast('ì¶”ì²œ ì‘í’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            } finally {
                document.getElementById('recommendations-loading').classList.add('hidden');
            }
        }
        
        // ì¶”ì²œ ì‘í’ˆ í‘œì‹œ
        function displayRecommendations(artworks, meta) {
            const grid = document.getElementById('recommendations-grid');
            const metaDiv = document.getElementById('recommendations-meta');
            
            // ì•Œê³ ë¦¬ì¦˜ ë©”íƒ€ ì •ë³´ í‘œì‹œ
            if (meta) {
                metaDiv.classList.remove('hidden');
                document.getElementById('rec-count').textContent = artworks.length;
                
                let algorithmName = '';
                let algorithmDesc = '';
                
                if (meta.algorithm === 'hybrid') {
                    algorithmName = 'ğŸ§  í•˜ì´ë¸Œë¦¬ë“œ ì¶”ì²œ';
                    algorithmDesc = 'í˜‘ì—… í•„í„°ë§ê³¼ ì½˜í…ì¸  ê¸°ë°˜ ë¶„ì„ì„ ê²°í•©í•œ ë§ì¶¤í˜• ì¶”ì²œ';
                } else if (meta.algorithm === 'trending') {
                    algorithmName = 'ğŸ”¥ ì¸ê¸° ê¸‰ìƒìŠ¹';
                    algorithmDesc = 'ìµœê·¼ ' + (meta.time_window_days || 7) + 'ì¼ê°„ ê°€ì¥ ë§ì€ ê´€ì‹¬ì„ ë°›ì€ ì‘í’ˆ';
                } else if (meta.algorithm === 'latest_quality') {
                    algorithmName = 'âœ¨ ì‹ ê·œ ê³ í’ˆì§ˆ';
                    algorithmDesc = 'ìµœê·¼ ë“±ë¡ëœ ê³ í’ˆì§ˆ ì‘í’ˆ ì¤‘ ì¶”ì²œ';
                }
                
                document.getElementById('algorithm-name').textContent = algorithmName;
                document.getElementById('algorithm-description').textContent = algorithmDesc;
            }
            
            // ì‘í’ˆ ì¹´ë“œ ìƒì„±
            artworks.forEach(art => {
                const card = document.createElement('div');
                card.className = 'card-nft rounded-2xl overflow-hidden cursor-pointer hover:scale-105 transition-transform duration-300';
                card.onclick = () => {
                    trackInteraction(art.id, 'view');
                    window.location.href = \`/artwork/\${art.id}\`;
                };
                
                const scoreDisplay = art.recommendation_score 
                    ? \`<div class="absolute top-3 right-3 px-3 py-1 bg-black/70 backdrop-blur-sm rounded-full text-xs font-bold text-gradient">
                         <i class="fas fa-star mr-1"></i>\${Math.round(art.recommendation_score)}
                       </div>\`
                    : '';
                
                card.innerHTML = \`
                    <div class="relative aspect-square bg-gray-900">
                        <img src="\${art.image_url}" alt="\${art.title}" class="w-full h-full object-cover" loading="lazy" 
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/400x400/1a1a1a/8b5cf6?text=\${encodeURIComponent(art.title)}'">
                        \${scoreDisplay}
                    </div>
                    <div class="p-4">
                        <h3 class="text-lg font-bold text-white mb-2 truncate">\${art.title}</h3>
                        <div class="flex items-center text-sm text-gray-400 mb-3">
                            <img src="\${art.artist_profile_image}" class="w-6 h-6 rounded-full mr-2" loading="lazy"
                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/50/8b5cf6/ffffff?text=\${encodeURIComponent(art.artist_name?.charAt(0) || '?')}'">
                            <span class="truncate">\${art.artist_name}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gradient font-bold text-lg">
                                \${(art.estimated_value / 1000000).toFixed(1)}Mì›
                            </span>
                            <span class="px-2 py-1 bg-white/5 text-gray-400 text-xs rounded-lg">\${art.category}</span>
                        </div>
                    </div>
                \`;
                
                grid.appendChild(card);
            });
        }
        
        // ì¸í„°ë™ì…˜ ì¶”ì 
        async function trackInteraction(artworkId, type) {
            try {
                const token = localStorage.getItem('token');
                const headers = { 'Content-Type': 'application/json' };
                if (token) {
                    headers['Authorization'] = \`Bearer \${token}\`;
                }
                
                await fetch('/api/recommendations/track', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        artwork_id: artworkId,
                        interaction_type: type,
                        metadata: {
                            source: 'recommendations_page',
                            tab: currentTab
                        }
                    })
                });
            } catch (error) {
                console.error('Track interaction failed:', error);
            }
        }
        
        // ì´ˆê¸° ë¡œë“œ
        document.addEventListener('DOMContentLoaded', () => {
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            if (user) {
                loadRecommendations('personalized');
            } else {
                loadRecommendations('trending');
            }
        });
    </script>
  `;
  
  return c.html(getLayout(content, 'ì¶”ì²œ ì‘í’ˆ - GALLERYPIA'))
})

// ê°¤ëŸ¬ë¦¬ í˜ì´ì§€ (ê³„ì†...)

app.get('/gallery', async (c) => {
  try {
    const db = c.env.DB
    
    // ëª¨ë“  ì‘í’ˆ ê°€ì ¸ì˜¤ê¸°
    const artworksResult = await db.prepare(`
      SELECT 
        a.*,
        ar.name as artist_name,
        ar.profile_image as artist_profile_image,
        ar.wallet_address as artist_wallet
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.status IN ('approved', 'minted', 'sold')
      ORDER BY a.created_at DESC
    `).all()
    
    const artworks = artworksResult.results || []
    
    // ì‘í’ˆ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
    const now = new Date()
    const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000)
    
    const newArtworks = artworks.filter((a: any) => new Date(a.created_at) > sevenDaysAgo).slice(0, 8)
    const popularArtworks = [...artworks].sort((a: any, b: any) => (b.views_count || 0) - (a.views_count || 0)).slice(0, 8)
    const curatedArtworks = artworks.filter((a: any) => (a.valuation_score || 0) >= 80).slice(0, 8)
    const premiumArtworks = artworks.filter((a: any) => (a.estimated_value || 0) >= 50000000).slice(0, 8)
    
    // í†µê³„ ì •ë³´
    const stats = {
      total: artworks.length,
      minted: artworks.filter((a: any) => a.is_minted).length,
      totalValue: artworks.reduce((sum: number, a: any) => sum + (a.estimated_value || 0), 0),
      avgScore: artworks.length > 0 ? artworks.reduce((sum: number, a: any) => sum + (a.valuation_score || 0), 0) / artworks.length : 0
    }
    
    const content = `
    <section id="main-content" class="py-16" tabindex="-1">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Hero Header -->
            <div class="text-center mb-16">
                <div class="inline-block mb-6 px-6 py-2 bg-gradient-to-r from-purple-600/20 to-cyan-600/20 backdrop-blur-sm rounded-full border border-purple-500/30">
                    <span class="text-gradient font-bold text-sm">ğŸ¨ NFT ART GALLERY</span>
                </div>
                <h1 class="text-6xl md:text-7xl font-black mb-6">
                    <span class="text-white">NFT ë¯¸ìˆ í’ˆ</span><br/>
                    <span class="text-gradient">ê°¤ëŸ¬ë¦¬</span>
                </h1>
                <p class="text-gray-300 text-xl max-w-3xl mx-auto leading-relaxed mb-8">
                    ê°€ì¹˜ì‚°ì • ì‹œìŠ¤í…œê³¼ ì—°ë™ëœ í”„ë¦¬ë¯¸ì—„ NFT ì‘í’ˆì„ ë§Œë‚˜ë³´ì„¸ìš”
                </p>
                
                <!-- AI ê²€ìƒ‰ ì¸í„°í˜ì´ìŠ¤ -->
                <div class="max-w-2xl mx-auto">
                    <div class="relative">
                        <!-- ê²€ìƒ‰ ì…ë ¥ì°½ -->
                        <div class="relative group">
                            <input 
                                type="text" 
                                id="gallerySearchInput"
                                placeholder="ì‘í’ˆ ê²€ìƒ‰... (í…ìŠ¤íŠ¸, ìŒì„± ì§€ì›)"
                                class="w-full px-6 py-4 pr-32 bg-white/5 backdrop-blur-lg border border-white/10 rounded-2xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500/50 focus:bg-white/10 transition-all duration-300"
                                onkeypress="if(event.key === 'Enter') performGallerySearch()"
                            >
                            <div class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-2">
                                <button onclick="startGalleryVoiceSearch()" class="p-2.5 bg-purple-600/80 hover:bg-purple-600 rounded-xl transition-all duration-200 hover:scale-110" title="ìŒì„± ê²€ìƒ‰">
                                    <i class="fas fa-microphone text-white"></i>
                                </button>
                                <button onclick="performGallerySearch()" class="p-2.5 bg-gradient-to-r from-purple-600 to-cyan-500 hover:from-purple-700 hover:to-cyan-600 rounded-xl transition-all duration-200 hover:scale-110" title="ê²€ìƒ‰">
                                    <i class="fas fa-search text-white"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í•„í„° UI -->
            <div class="mb-12 p-6 bg-gradient-to-br from-gray-900/50 to-black/50 backdrop-blur-sm rounded-2xl border border-white/10">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-400 mb-3">
                            <i class="fas fa-tag mr-2"></i>ì¹´í…Œê³ ë¦¬
                        </label>
                        <select id="categoryFilter" class="w-full px-4 py-3 bg-gray-800/80 border border-gray-700 rounded-xl text-white focus:border-purple-500 focus:outline-none transition-colors" onchange="applyFilters()">
                            <option value="all">ì „ì²´</option>
                            <option value="painting">íšŒí™”</option>
                            <option value="sculpture">ì¡°ê°</option>
                            <option value="photography">ì‚¬ì§„</option>
                            <option value="digital">ë””ì§€í„¸ì•„íŠ¸</option>
                            <option value="mixed">í˜¼í•©ë§¤ì²´</option>
                        </select>
                    </div>
                    
                    <!-- ê°€ê²© ë²”ìœ„ í•„í„° -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-400 mb-3">
                            <i class="fas fa-won-sign mr-2"></i>ê°€ê²© ë²”ìœ„
                        </label>
                        <select id="priceFilter" class="w-full px-4 py-3 bg-gray-800/80 border border-gray-700 rounded-xl text-white focus:border-purple-500 focus:outline-none transition-colors" onchange="applyFilters()">
                            <option value="all">ì „ì²´</option>
                            <option value="0-10000000">1ì²œë§Œì› ë¯¸ë§Œ</option>
                            <option value="10000000-50000000">1ì²œë§Œ ~ 5ì²œë§Œì›</option>
                            <option value="50000000-100000000">5ì²œë§Œ ~ 1ì–µì›</option>
                            <option value="100000000-999999999">1ì–µì› ì´ìƒ</option>
                        </select>
                    </div>
                    
                    <!-- ìƒíƒœ í•„í„° -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-400 mb-3">
                            <i class="fas fa-filter mr-2"></i>ìƒíƒœ
                        </label>
                        <select id="statusFilter" class="w-full px-4 py-3 bg-gray-800/80 border border-gray-700 rounded-xl text-white focus:border-purple-500 focus:outline-none transition-colors" onchange="applyFilters()">
                            <option value="all">ì „ì²´</option>
                            <option value="minted">NFT ë¯¼íŒ…ë¨</option>
                            <option value="not-minted">ë¯¸ë¯¼íŒ…</option>
                            <option value="on-sale">íŒë§¤ì¤‘</option>
                        </select>
                    </div>
                    
                    <!-- ì •ë ¬ í•„í„° -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-400 mb-3">
                            <i class="fas fa-sort mr-2"></i>ì •ë ¬
                        </label>
                        <select id="sortFilter" class="w-full px-4 py-3 bg-gray-800/80 border border-gray-700 rounded-xl text-white focus:border-purple-500 focus:outline-none transition-colors" onchange="applyFilters()">
                            <option value="created_desc">ìµœì‹ ìˆœ</option>
                            <option value="created_asc">ì˜¤ë˜ëœìˆœ</option>
                            <option value="price_desc">ê°€ê²© ë†’ì€ìˆœ</option>
                            <option value="price_asc">ê°€ê²© ë‚®ì€ìˆœ</option>
                            <option value="views_desc">ì¡°íšŒìˆ˜ ë†’ì€ìˆœ</option>
                            <option value="likes_desc">ì¢‹ì•„ìš” ë§ì€ìˆœ</option>
                            <option value="score_desc">í‰ì  ë†’ì€ìˆœ</option>
                        </select>
                    </div>
                </div>
                
                <!-- í•„í„° ì´ˆê¸°í™” ë²„íŠ¼ -->
                <div class="mt-4 flex justify-end">
                    <button onclick="resetFilters()" class="px-6 py-2 bg-gray-700/50 hover:bg-gray-700 text-gray-300 hover:text-white rounded-lg transition-colors flex items-center gap-2">
                        <i class="fas fa-redo-alt"></i>
                        <span>í•„í„° ì´ˆê¸°í™”</span>
                    </button>
                </div>
            </div>

            <!-- í†µê³„ ëŒ€ì‹œë³´ë“œ -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-16">
                <div class="card-nft rounded-2xl p-6 text-center bg-gradient-to-br from-purple-900/30 to-pink-900/20 border border-purple-500/30">
                    <div class="text-4xl font-black text-gradient mb-2">${stats.total}</div>
                    <div class="text-xs text-gray-400 uppercase font-semibold">ì „ì²´ ì‘í’ˆ</div>
                </div>
                <div class="card-nft rounded-2xl p-6 text-center bg-gradient-to-br from-cyan-900/30 to-emerald-900/20 border border-cyan-500/30">
                    <div class="text-4xl font-black text-gradient mb-2">${stats.minted}</div>
                    <div class="text-xs text-gray-400 uppercase font-semibold">NFT ë¯¼íŒ…</div>
                </div>
                <div class="card-nft rounded-2xl p-6 text-center bg-gradient-to-br from-amber-900/30 to-orange-900/20 border border-amber-500/30">
                    <div class="text-4xl font-black text-gradient mb-2">${(stats.totalValue / 100000000).toFixed(1)}ì–µ</div>
                    <div class="text-xs text-gray-400 uppercase font-semibold">ì´ ê°€ì¹˜</div>
                </div>
                <div class="card-nft rounded-2xl p-6 text-center bg-gradient-to-br from-green-900/30 to-emerald-900/20 border border-green-500/30">
                    <div class="text-4xl font-black text-gradient mb-2">${stats.avgScore.toFixed(1)}</div>
                    <div class="text-xs text-gray-400 uppercase font-semibold">í‰ê·  ì ìˆ˜</div>
                </div>
            </div>

            <!-- ì‘í’ˆ ì¹´í…Œê³ ë¦¬ íƒ­ -->
            <div class="mb-12">
                <div class="flex flex-wrap gap-3 border-b border-white/10 pb-6">
                    <button onclick="showCategory('all')" id="tab-all" class="category-tab active px-6 py-3 rounded-xl font-bold transition-all" aria-label="ì „ì²´ ì‘í’ˆ ë³´ê¸°">
                        <i class="fas fa-th mr-2"></i>ì „ì²´
                    </button>
                    <button onclick="showCategory('new')" id="tab-new" class="category-tab px-6 py-3 rounded-xl font-bold transition-all" aria-label="ì‹ ê·œ ì‘í’ˆ ë³´ê¸°">
                        <i class="fas fa-sparkles mr-2"></i>ì‹ ê·œ ì‘í’ˆ
                    </button>
                    <button onclick="showCategory('popular')" id="tab-popular" class="category-tab px-6 py-3 rounded-xl font-bold transition-all" aria-label="ì¸ê¸° ì‘í’ˆ ë³´ê¸°">
                        <i class="fas fa-fire mr-2"></i>ì¸ê¸° ì‘í’ˆ
                    </button>
                    <button onclick="showCategory('curated')" id="tab-curated" class="category-tab px-6 py-3 rounded-xl font-bold transition-all" aria-label="íë ˆì´í„° ì¶”ì²œ ì‘í’ˆ ë³´ê¸°">
                        <i class="fas fa-star mr-2"></i>íë ˆì´í„° ì¶”ì²œ
                    </button>
                    <button onclick="showCategory('premium')" id="tab-premium" class="category-tab px-6 py-3 rounded-xl font-bold transition-all" aria-label="í”„ë¦¬ë¯¸ì—„ ì‘í’ˆ ë³´ê¸°">
                        <i class="fas fa-gem mr-2"></i>í”„ë¦¬ë¯¸ì—„
                    </button>
                    <button onclick="showCategory('collections')" id="tab-collections" class="category-tab px-6 py-3 rounded-xl font-bold transition-all" aria-label="ì»¬ë ‰ì…˜ ë³´ê¸°">
                        <i class="fas fa-layer-group mr-2"></i>ì»¬ë ‰ì…˜
                    </button>
                </div>
            </div>

            <!-- ì‹ ê·œ ì‘í’ˆ -->
            <div id="category-new" class="category-content hidden">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-3xl font-black text-white flex items-center">
                        <i class="fas fa-sparkles text-purple-400 mr-3"></i>
                        ì‹ ê·œ ì‘í’ˆ (ìµœê·¼ 7ì¼)
                    </h3>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${newArtworks.length > 0 ? newArtworks.map((artwork: any) => `
                        <a href="/artwork/${artwork.id}" class="gallery-item card-nft rounded-3xl overflow-hidden group">
                            <div class="relative aspect-square bg-gray-900 overflow-hidden">
                                <img src="${artwork.image_url}" alt="${artwork.title}" 
                                     class="w-full h-full object-cover img-nft" 
                                     loading="lazy"
                                     onerror="this.onerror=null; this.src='https://via.placeholder.com/800x800/1a1a1a/10b981?text=${encodeURIComponent(artwork.title)}'">
                                
                                <div class="absolute top-4 right-4 flex gap-2">
                                    <span class="badge px-2 py-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white text-xs font-bold rounded-full">
                                        <i class="fas fa-sparkles mr-1"></i>NEW
                                    </span>
                                    ${artwork.is_minted ? `
                                    <span class="badge px-2 py-1 bg-gradient-to-r from-purple-600 to-cyan-500 text-white text-xs font-bold rounded-full">
                                        <i class="fas fa-cube mr-1"></i>NFT
                                    </span>
                                    ` : ''}
                                    ${(artwork.valuation_score || 0) >= 80 ? `
                                    <span class="px-2 py-1 bg-gradient-to-r from-green-600 to-emerald-500 text-white text-xs font-bold rounded-full">
                                        ${artwork.valuation_score}ì 
                                    </span>
                                    ` : ''}
                                </div>
                                
                                <div class="absolute top-4 left-4">
                                    <span class="category-badge px-3 py-1.5 bg-black bg-opacity-80 backdrop-blur-sm text-white text-xs font-bold rounded-full border border-white border-opacity-20">
                                        ${artwork.category}
                                    </span>
                                </div>
                                
                                <div class="absolute bottom-4 left-4 right-4 flex justify-between text-white text-xs">
                                    <span class="flex items-center bg-black bg-opacity-60 backdrop-blur-sm px-2 py-1 rounded-full">
                                        <i class="fas fa-eye mr-1"></i>${artwork.views_count || 0}
                                    </span>
                                    <span class="flex items-center bg-black bg-opacity-60 backdrop-blur-sm px-2 py-1 rounded-full">
                                        <i class="fas fa-heart mr-1"></i>${artwork.likes_count || 0}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="p-6">
                                <h3 class="font-bold text-xl text-white mb-2 line-clamp-1">${artwork.title}</h3>
                                
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center flex-1 min-w-0">
                                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-600 to-cyan-500 mr-2 flex items-center justify-center text-white text-xs font-bold flex-shrink-0">
                                            ${(artwork.artist_name || 'U').charAt(0).toUpperCase()}
                                        </div>
                                        <span class="text-sm text-gray-400 font-medium truncate">${artwork.artist_name || 'Unknown'}</span>
                                    </div>
                                    ${artwork.average_rating > 0 ? `
                                    <div class="flex items-center gap-1 ml-2 flex-shrink-0">
                                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                                        <span class="text-xs text-yellow-400 font-bold">${artwork.average_rating.toFixed(1)}</span>
                                    </div>
                                    ` : ''}
                                </div>
                                
                                <div class="flex justify-between items-end">
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">ì‚°ì •ê°€</div>
                                        <div class="price-value font-black text-lg text-gradient" data-price="${artwork.estimated_value || 0}">${formatPrice(artwork.estimated_value || 0)}</div>
                                    </div>
                                    ${artwork.current_price > 0 ? `
                                    <div class="text-right current-price">
                                        <div class="text-xs text-gray-500 mb-1">í˜„ì¬ê°€</div>
                                        <div class="font-bold text-sm text-white">${formatPrice(artwork.current_price)}</div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </a>
                    `).join('') : '<div class="col-span-full text-center py-20 text-gray-400">ì‹ ê·œ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤</div>'}
                </div>
            </div>

            <!-- ì¸ê¸° ì‘í’ˆ -->
            <div id="category-popular" class="category-content hidden">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-3xl font-black text-white flex items-center">
                        <i class="fas fa-fire text-orange-400 mr-3"></i>
                        ì¸ê¸° ì‘í’ˆ (ì¡°íšŒìˆ˜ ê¸°ì¤€)
                    </h3>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${popularArtworks.length > 0 ? popularArtworks.map((artwork: any) => `
                        <a href="/artwork/${artwork.id}" class="gallery-item card-nft rounded-3xl overflow-hidden group">
                            <div class="relative aspect-square bg-gray-900 overflow-hidden">
                                <img src="${artwork.image_url}" alt="${artwork.title}" 
                                     class="w-full h-full object-cover img-nft" 
                                     loading="lazy"
                                     onerror="this.onerror=null; this.src='https://via.placeholder.com/800x800/1a1a1a/10b981?text=${encodeURIComponent(artwork.title)}'">
                                
                                <div class="absolute top-4 right-4 flex gap-2">
                                    <span class="px-2 py-1 bg-gradient-to-r from-orange-600 to-red-600 text-white text-xs font-bold rounded-full">
                                        <i class="fas fa-fire mr-1"></i>HOT
                                    </span>
                                    ${artwork.is_minted ? `
                                    <span class="px-2 py-1 bg-gradient-to-r from-purple-600 to-cyan-500 text-white text-xs font-bold rounded-full">
                                        <i class="fas fa-cube mr-1"></i>NFT
                                    </span>
                                    ` : ''}
                                    ${(artwork.valuation_score || 0) >= 80 ? `
                                    <span class="px-2 py-1 bg-gradient-to-r from-green-600 to-emerald-500 text-white text-xs font-bold rounded-full">
                                        ${artwork.valuation_score}ì 
                                    </span>
                                    ` : ''}
                                </div>
                                
                                <div class="absolute top-4 left-4">
                                    <span class="category-badge px-3 py-1.5 bg-black bg-opacity-80 backdrop-blur-sm text-white text-xs font-bold rounded-full border border-white border-opacity-20">
                                        ${artwork.category}
                                    </span>
                                </div>
                                
                                <div class="absolute bottom-4 left-4 right-4 flex justify-between text-white text-xs">
                                    <span class="flex items-center bg-black bg-opacity-60 backdrop-blur-sm px-2 py-1 rounded-full">
                                        <i class="fas fa-eye mr-1"></i>${artwork.views_count || 0}
                                    </span>
                                    <span class="flex items-center bg-black bg-opacity-60 backdrop-blur-sm px-2 py-1 rounded-full">
                                        <i class="fas fa-heart mr-1"></i>${artwork.likes_count || 0}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="p-6">
                                <h3 class="font-bold text-xl text-white mb-2 line-clamp-1">${artwork.title}</h3>
                                
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center flex-1 min-w-0">
                                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-600 to-cyan-500 mr-2 flex items-center justify-center text-white text-xs font-bold flex-shrink-0">
                                            ${(artwork.artist_name || 'U').charAt(0).toUpperCase()}
                                        </div>
                                        <span class="text-sm text-gray-400 font-medium truncate">${artwork.artist_name || 'Unknown'}</span>
                                    </div>
                                    ${artwork.average_rating > 0 ? `
                                    <div class="flex items-center gap-1 ml-2 flex-shrink-0">
                                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                                        <span class="text-xs text-yellow-400 font-bold">${artwork.average_rating.toFixed(1)}</span>
                                    </div>
                                    ` : ''}
                                </div>
                                
                                <div class="flex justify-between items-end">
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">ì‚°ì •ê°€</div>
                                        <div class="price-value font-black text-lg text-gradient" data-price="${artwork.estimated_value || 0}">${formatPrice(artwork.estimated_value || 0)}</div>
                                    </div>
                                    ${artwork.current_price > 0 ? `
                                    <div class="text-right current-price">
                                        <div class="text-xs text-gray-500 mb-1">í˜„ì¬ê°€</div>
                                        <div class="font-bold text-sm text-white">${formatPrice(artwork.current_price)}</div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </a>
                    `).join('') : '<div class="col-span-full text-center py-20 text-gray-400">ì¸ê¸° ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤</div>'}
                </div>
            </div>

            <!-- íë ˆì´í„° ì¶”ì²œ -->
            <div id="category-curated" class="category-content hidden">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-3xl font-black text-white flex items-center">
                        <i class="fas fa-star text-yellow-400 mr-3"></i>
                        íë ˆì´í„° ì¶”ì²œ (í‰ê°€ì ìˆ˜ 80ì  ì´ìƒ)
                    </h3>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${curatedArtworks.length > 0 ? curatedArtworks.map((artwork: any) => `
                        <a href="/artwork/${artwork.id}" class="gallery-item card-nft rounded-3xl overflow-hidden group">
                            <div class="relative aspect-square bg-gray-900 overflow-hidden">
                                <img src="${artwork.image_url}" alt="${artwork.title}" 
                                     class="w-full h-full object-cover img-nft" 
                                     loading="lazy"
                                     onerror="this.onerror=null; this.src='https://via.placeholder.com/800x800/1a1a1a/10b981?text=${encodeURIComponent(artwork.title)}'">
                                
                                <div class="absolute top-4 right-4 flex gap-2">
                                    <span class="px-2 py-1 bg-gradient-to-r from-yellow-600 to-orange-500 text-white text-xs font-bold rounded-full">
                                        <i class="fas fa-star mr-1"></i>ì¶”ì²œ
                                    </span>
                                    ${artwork.is_minted ? `
                                    <span class="px-2 py-1 bg-gradient-to-r from-purple-600 to-cyan-500 text-white text-xs font-bold rounded-full">
                                        <i class="fas fa-cube mr-1"></i>NFT
                                    </span>
                                    ` : ''}
                                    <span class="px-2 py-1 bg-gradient-to-r from-green-600 to-emerald-500 text-white text-xs font-bold rounded-full">
                                        ${artwork.valuation_score}ì 
                                    </span>
                                </div>
                                
                                <div class="absolute top-4 left-4">
                                    <span class="category-badge px-3 py-1.5 bg-black bg-opacity-80 backdrop-blur-sm text-white text-xs font-bold rounded-full border border-white border-opacity-20">
                                        ${artwork.category}
                                    </span>
                                </div>
                                
                                <div class="absolute bottom-4 left-4 right-4 flex justify-between text-white text-xs">
                                    <span class="flex items-center bg-black bg-opacity-60 backdrop-blur-sm px-2 py-1 rounded-full">
                                        <i class="fas fa-eye mr-1"></i>${artwork.views_count || 0}
                                    </span>
                                    <span class="flex items-center bg-black bg-opacity-60 backdrop-blur-sm px-2 py-1 rounded-full">
                                        <i class="fas fa-heart mr-1"></i>${artwork.likes_count || 0}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="p-6">
                                <h3 class="font-bold text-xl text-white mb-2 line-clamp-1">${artwork.title}</h3>
                                
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center flex-1 min-w-0">
                                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-600 to-cyan-500 mr-2 flex items-center justify-center text-white text-xs font-bold flex-shrink-0">
                                            ${(artwork.artist_name || 'U').charAt(0).toUpperCase()}
                                        </div>
                                        <span class="text-sm text-gray-400 font-medium truncate">${artwork.artist_name || 'Unknown'}</span>
                                    </div>
                                    ${artwork.average_rating > 0 ? `
                                    <div class="flex items-center gap-1 ml-2 flex-shrink-0">
                                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                                        <span class="text-xs text-yellow-400 font-bold">${artwork.average_rating.toFixed(1)}</span>
                                    </div>
                                    ` : ''}
                                </div>
                                
                                <div class="flex justify-between items-end">
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">ì‚°ì •ê°€</div>
                                        <div class="price-value font-black text-lg text-gradient" data-price="${artwork.estimated_value || 0}">${formatPrice(artwork.estimated_value || 0)}</div>
                                    </div>
                                    ${artwork.current_price > 0 ? `
                                    <div class="text-right current-price">
                                        <div class="text-xs text-gray-500 mb-1">í˜„ì¬ê°€</div>
                                        <div class="font-bold text-sm text-white">${formatPrice(artwork.current_price)}</div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </a>
                    `).join('') : '<div class="col-span-full text-center py-20 text-gray-400">ì¶”ì²œ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤</div>'}
                </div>
            </div>

            <!-- í”„ë¦¬ë¯¸ì—„ ì‘í’ˆ -->
            <div id="category-premium" class="category-content hidden">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-3xl font-black text-white flex items-center">
                        <i class="fas fa-gem text-cyan-400 mr-3"></i>
                        í”„ë¦¬ë¯¸ì—„ ì‘í’ˆ (5ì²œë§Œì› ì´ìƒ)
                    </h3>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${premiumArtworks.length > 0 ? premiumArtworks.map((artwork: any) => `
                        <a href="/artwork/${artwork.id}" class="gallery-item card-nft rounded-3xl overflow-hidden group">
                            <div class="relative aspect-square bg-gray-900 overflow-hidden">
                                <img src="${artwork.image_url}" alt="${artwork.title}" 
                                     class="w-full h-full object-cover img-nft" 
                                     loading="lazy"
                                     onerror="this.onerror=null; this.src='https://via.placeholder.com/800x800/1a1a1a/10b981?text=${encodeURIComponent(artwork.title)}'">
                                
                                <div class="absolute top-4 right-4 flex gap-2">
                                    <span class="px-2 py-1 bg-gradient-to-r from-cyan-600 to-blue-600 text-white text-xs font-bold rounded-full">
                                        <i class="fas fa-gem mr-1"></i>PREMIUM
                                    </span>
                                    ${artwork.is_minted ? `
                                    <span class="px-2 py-1 bg-gradient-to-r from-purple-600 to-cyan-500 text-white text-xs font-bold rounded-full">
                                        <i class="fas fa-cube mr-1"></i>NFT
                                    </span>
                                    ` : ''}
                                    ${(artwork.valuation_score || 0) >= 80 ? `
                                    <span class="px-2 py-1 bg-gradient-to-r from-green-600 to-emerald-500 text-white text-xs font-bold rounded-full">
                                        ${artwork.valuation_score}ì 
                                    </span>
                                    ` : ''}
                                </div>
                                
                                <div class="absolute top-4 left-4">
                                    <span class="category-badge px-3 py-1.5 bg-black bg-opacity-80 backdrop-blur-sm text-white text-xs font-bold rounded-full border border-white border-opacity-20">
                                        ${artwork.category}
                                    </span>
                                </div>
                                
                                <div class="absolute bottom-4 left-4 right-4 flex justify-between text-white text-xs">
                                    <span class="flex items-center bg-black bg-opacity-60 backdrop-blur-sm px-2 py-1 rounded-full">
                                        <i class="fas fa-eye mr-1"></i>${artwork.views_count || 0}
                                    </span>
                                    <span class="flex items-center bg-black bg-opacity-60 backdrop-blur-sm px-2 py-1 rounded-full">
                                        <i class="fas fa-heart mr-1"></i>${artwork.likes_count || 0}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="p-6">
                                <h3 class="font-bold text-xl text-white mb-2 line-clamp-1">${artwork.title}</h3>
                                
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center flex-1 min-w-0">
                                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-600 to-cyan-500 mr-2 flex items-center justify-center text-white text-xs font-bold flex-shrink-0">
                                            ${(artwork.artist_name || 'U').charAt(0).toUpperCase()}
                                        </div>
                                        <span class="text-sm text-gray-400 font-medium truncate">${artwork.artist_name || 'Unknown'}</span>
                                    </div>
                                    ${artwork.average_rating > 0 ? `
                                    <div class="flex items-center gap-1 ml-2 flex-shrink-0">
                                        <i class="fas fa-star text-yellow-400 text-xs"></i>
                                        <span class="text-xs text-yellow-400 font-bold">${artwork.average_rating.toFixed(1)}</span>
                                    </div>
                                    ` : ''}
                                </div>
                                
                                <div class="flex justify-between items-end">
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">ì‚°ì •ê°€</div>
                                        <div class="price-value font-black text-lg text-gradient" data-price="${artwork.estimated_value || 0}">${formatPrice(artwork.estimated_value || 0)}</div>
                                    </div>
                                    ${artwork.current_price > 0 ? `
                                    <div class="text-right current-price">
                                        <div class="text-xs text-gray-500 mb-1">í˜„ì¬ê°€</div>
                                        <div class="font-bold text-sm text-white">${formatPrice(artwork.current_price)}</div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </a>
                    `).join('') : '<div class="col-span-full text-center py-20 text-gray-400">í”„ë¦¬ë¯¸ì—„ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤</div>'}
                </div>
            </div>

            <!-- ì „ì²´ ì‘í’ˆ -->
            <!-- ì»¬ë ‰ì…˜ -->
            <div id="category-collections" class="category-content hidden">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-3xl font-black text-white flex items-center">
                        <i class="fas fa-layer-group text-cyan-400 mr-3"></i>
                        NFT ì»¬ë ‰ì…˜
                    </h3>
                </div>
                <div id="collectionsList" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="col-span-full text-center py-12 text-gray-400">
                        <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                        <p>ì»¬ë ‰ì…˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            </div>

            <div id="category-all" class="category-content">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-3xl font-black text-white flex items-center">
                        <i class="fas fa-th text-gray-400 mr-3"></i>
                        ì „ì²´ ì‘í’ˆ (${artworks.length}ê°œ)
                    </h3>
                </div>
            
            <!-- ê²€ìƒ‰ ë° í•„í„° -->
            <div class="card-nft rounded-2xl p-6 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                    <!-- ê²€ìƒ‰ -->
                    <div class="md:col-span-5">
                        <div class="relative">
                            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                            <input 
                                type="text" 
                                id="searchInput" 
                                placeholder="ì‘í’ˆëª…, ì‘ê°€ëª…ìœ¼ë¡œ ê²€ìƒ‰..." 
                                aria-label="ì‘í’ˆ ê²€ìƒ‰"
                                class="w-full pl-12 pr-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500"
                                onkeyup="filterGallery()"
                            />
                        </div>
                    </div>
                    
                    <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
                    <div class="md:col-span-3">
                        <select id="categoryFilter" onchange="filterGallery()" class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white">
                            <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                            <option value="ë””ì§€í„¸ì•„íŠ¸">ë””ì§€í„¸ì•„íŠ¸</option>
                            <option value="íšŒí™”">íšŒí™”</option>
                            <option value="ì¡°ê°">ì¡°ê°</option>
                            <option value="ì‚¬ì§„">ì‚¬ì§„</option>
                        </select>
                    </div>
                    
                    <!-- ê°€ê²© ë²”ìœ„ -->
                    <div class="md:col-span-2">
                        <select id="priceFilter" onchange="filterGallery()" class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white">
                            <option value="">ì „ì²´ ê°€ê²©</option>
                            <option value="0-10000000">~1ì²œë§Œì›</option>
                            <option value="10000000-50000000">1ì²œë§Œ~5ì²œë§Œì›</option>
                            <option value="50000000-100000000">5ì²œë§Œ~1ì–µì›</option>
                            <option value="100000000-999999999999">1ì–µì› ì´ìƒ</option>
                        </select>
                    </div>
                    
                    <!-- ì •ë ¬ -->
                    <div class="md:col-span-2">
                        <select id="sortOrder" onchange="sortGallery()" class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white">
                            <option value="newest">ìµœì‹ ìˆœ</option>
                            <option value="oldest">ì˜¤ë˜ëœìˆœ</option>
                            <option value="price_high">ê°€ê²© ë†’ì€ìˆœ</option>
                            <option value="price_low">ê°€ê²© ë‚®ì€ìˆœ</option>
                            <option value="popular">ì¸ê¸°ìˆœ</option>
                        </select>
                    </div>
                </div>
                
                <!-- ë¹ ë¥¸ í•„í„° ë²„íŠ¼ -->
                <div class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-white border-opacity-10">
                    <button onclick="quickFilter('minted')" class="px-4 py-2 bg-purple-500 bg-opacity-20 hover:bg-opacity-30 text-purple-400 rounded-lg text-sm font-semibold transition">
                        <i class="fas fa-cube mr-2"></i>ë¯¼íŒ…ëœ NFT
                    </button>
                    <button onclick="quickFilter('korean')" class="px-4 py-2 bg-cyan-500 bg-opacity-20 hover:bg-opacity-30 text-cyan-400 rounded-lg text-sm font-semibold transition">
                        <i class="fas fa-flag mr-2"></i>í•œêµ­ ì‘ê°€
                    </button>
                    <button onclick="quickFilter('high-value')" class="px-4 py-2 bg-yellow-500 bg-opacity-20 hover:bg-opacity-30 text-yellow-400 rounded-lg text-sm font-semibold transition">
                        <i class="fas fa-gem mr-2"></i>ê³ ê°€ ì‘í’ˆ
                    </button>
                    <button onclick="resetFilters()" class="px-4 py-2 bg-gray-500 bg-opacity-20 hover:bg-opacity-30 text-gray-400 rounded-lg text-sm font-semibold transition">
                        <i class="fas fa-redo mr-2"></i>í•„í„° ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
            
            <!-- ê²°ê³¼ ì¹´ìš´íŠ¸ -->
            <div class="mb-6 text-gray-400">
                <span id="resultCount">${artworks.length}</span>ê°œì˜ ì‘í’ˆì„ ì°¾ì•˜ìŠµë‹ˆë‹¤
            </div>
            
            <!-- ì‘í’ˆ ê·¸ë¦¬ë“œ -->
            <div id="galleryGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                ${artworks.map((artwork: any) => `
                    <a href="/artwork/${artwork.id}" 
                       class="gallery-item card-nft rounded-3xl overflow-hidden group"
                       data-id="${artwork.id}"
                       data-category="${artwork.category}"
                       data-price="${artwork.estimated_value || 0}"
                       data-minted="${artwork.is_minted ? '1' : '0'}"
                       data-artist="${(artwork.artist_name || '').toLowerCase()}"
                       data-title="${(artwork.title || '').toLowerCase()}"
                       data-views="${artwork.views_count || 0}"
                       data-created="${artwork.created_at}">
                        <!-- ì´ë¯¸ì§€ -->
                        <div class="relative aspect-square bg-gray-900 overflow-hidden">
                            <img src="${artwork.image_url}" alt="${artwork.title}" 
                                 class="w-full h-full object-cover img-nft" 
                                 loading="lazy"
                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/800x800/1a1a1a/8b5cf6?text=${encodeURIComponent(artwork.title)}'">
                            
                            <!-- ë±ƒì§€ -->
                            <div class="absolute top-4 right-4 flex gap-2">
                                ${artwork.is_minted ? `
                                <span class="px-3 py-1.5 bg-gradient-to-r from-purple-600 to-cyan-500 text-white text-xs font-bold rounded-full flex items-center backdrop-blur-sm">
                                    <i class="fas fa-cube mr-1.5"></i>NFT
                                </span>
                                ` : ''}
                            </div>
                            
                            <!-- ì¹´í…Œê³ ë¦¬ -->
                            <div class="absolute top-4 left-4">
                                <span class="px-3 py-1.5 bg-black bg-opacity-80 backdrop-blur-sm text-white text-xs font-bold rounded-full border border-white border-opacity-20">
                                    ${artwork.category}
                                </span>
                            </div>
                            
                            <!-- í†µê³„ -->
                            <div class="absolute bottom-4 left-4 right-4 flex justify-between text-white text-xs">
                                <span class="flex items-center bg-black bg-opacity-60 backdrop-blur-sm px-2 py-1 rounded-full">
                                    <i class="fas fa-eye mr-1"></i>${artwork.views_count || 0}
                                </span>
                                <span class="flex items-center bg-black bg-opacity-60 backdrop-blur-sm px-2 py-1 rounded-full">
                                    <i class="fas fa-heart mr-1"></i>${artwork.likes_count || 0}
                                </span>
                            </div>
                        </div>
                        
                        <!-- ì •ë³´ -->
                        <div class="p-6">
                            <h3 class="font-bold text-xl text-white mb-2 line-clamp-1">${artwork.title}</h3>
                            
                            <!-- ì‘ê°€ -->
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center flex-1 min-w-0">
                                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-600 to-cyan-500 mr-2 flex items-center justify-center text-white text-xs font-bold flex-shrink-0">
                                        ${(artwork.artist_name || 'U').charAt(0).toUpperCase()}
                                    </div>
                                    <span class="text-sm text-gray-400 font-medium truncate">${artwork.artist_name || 'Unknown'}</span>
                                </div>
                                ${artwork.average_rating > 0 ? `
                                <div class="flex items-center gap-1 ml-2 flex-shrink-0">
                                    <i class="fas fa-star text-yellow-400 text-xs"></i>
                                    <span class="text-xs text-yellow-400 font-bold">${artwork.average_rating.toFixed(1)}</span>
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- ê°€ê²© -->
                            <div class="flex justify-between items-end">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">ì‚°ì •ê°€</div>
                                    <div class="font-black text-lg text-gradient">${formatPrice(artwork.estimated_value || 0)}</div>
                                </div>
                                ${artwork.current_price > 0 ? `
                                <div class="text-right">
                                    <div class="text-xs text-gray-500 mb-1">í˜„ì¬ê°€</div>
                                    <div class="font-bold text-sm text-white">${formatPrice(artwork.current_price)}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </a>
                `).join('')}
            </div>
            
            <!-- ê²°ê³¼ ì—†ìŒ -->
            <div id="noResults" class="hidden text-center py-20">
                <i class="fas fa-search text-6xl text-gray-700 mb-4"></i>
                <p class="text-gray-400 text-lg">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                <button onclick="resetFilters()" class="mt-4 px-6 py-3 bg-purple-500 bg-opacity-20 hover:bg-opacity-30 text-purple-400 rounded-lg font-semibold transition">
                    í•„í„° ì´ˆê¸°í™”
                </button>
            </div>
        </div>
    </section>
    
    <script src="/static/gallery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
      function showCategory(category) {
        // Hide all categories
        document.querySelectorAll('.category-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.category-tab').forEach(el => el.classList.remove('active'));
        
        // Show selected category
        document.getElementById('category-' + category).classList.remove('hidden');
        document.getElementById('tab-' + category).classList.add('active');
        
        // Load collections if collections tab is selected
        if (category === 'collections' && !window.collectionsLoaded) {
          loadCollections();
          window.collectionsLoaded = true;
        }
      }
      
      // í•„í„° ì ìš© í•¨ìˆ˜
      function applyFilters() {
        const category = document.getElementById('categoryFilter').value;
        const priceRange = document.getElementById('priceFilter').value;
        const status = document.getElementById('statusFilter').value;
        const sort = document.getElementById('sortFilter').value;
        
        // ëª¨ë“  ê°¤ëŸ¬ë¦¬ ì•„ì´í…œ ê°€ì ¸ì˜¤ê¸°
        const items = Array.from(document.querySelectorAll('.gallery-item'));
        
        // í•„í„°ë§
        items.forEach(item => {
          let show = true;
          
          // ì¹´í…Œê³ ë¦¬ í•„í„°
          if (category !== 'all') {
            const itemCategory = item.querySelector('.category-badge')?.textContent?.toLowerCase();
            if (itemCategory !== category) show = false;
          }
          
          // ê°€ê²© í•„í„°
          if (priceRange !== 'all') {
            const priceText = item.querySelector('.price-value')?.textContent?.replace(/[^0-9]/g, '') || '0';
            const price = parseInt(priceText);
            const [min, max] = priceRange.split('-').map(Number);
            if (price < min || price > max) show = false;
          }
          
          // ìƒíƒœ í•„í„°
          if (status !== 'all') {
            const badges = item.querySelectorAll('.badge');
            const isMinted = Array.from(badges).some(b => b.textContent.includes('NFT'));
            const isOnSale = item.querySelector('.current-price') !== null;
            
            if (status === 'minted' && !isMinted) show = false;
            if (status === 'not-minted' && isMinted) show = false;
            if (status === 'on-sale' && !isOnSale) show = false;
          }
          
          item.style.display = show ? '' : 'none';
        });
        
        // ì •ë ¬
        const parent = items[0]?.parentElement;
        if (!parent) return;
        
        const visibleItems = items.filter(item => item.style.display !== 'none');
        
        visibleItems.sort((a, b) => {
          const [field, order] = sort.split('_');
          
          let aValue, bValue;
          
          if (field === 'created') {
            // created_at ê¸°ì¤€ ì •ë ¬ (ê¸°ë³¸)
            return order === 'desc' ? 0 : 0; // ì´ë¯¸ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ë˜ì–´ ìˆìŒ
          } else if (field === 'price') {
            aValue = parseInt(a.querySelector('.price-value')?.textContent?.replace(/[^0-9]/g, '') || '0');
            bValue = parseInt(b.querySelector('.price-value')?.textContent?.replace(/[^0-9]/g, '') || '0');
          } else if (field === 'views') {
            aValue = parseInt(a.querySelector('.fa-eye')?.parentElement?.textContent || '0');
            bValue = parseInt(b.querySelector('.fa-eye')?.parentElement?.textContent || '0');
          } else if (field === 'likes') {
            aValue = parseInt(a.querySelector('.fa-heart')?.parentElement?.textContent || '0');
            bValue = parseInt(b.querySelector('.fa-heart')?.parentElement?.textContent || '0');
          } else if (field === 'score') {
            aValue = parseFloat(a.querySelector('.fa-star')?.parentElement?.textContent || '0');
            bValue = parseFloat(b.querySelector('.fa-star')?.parentElement?.textContent || '0');
          }
          
          if (order === 'desc') {
            return bValue - aValue;
          } else {
            return aValue - bValue;
          }
        });
        
        // DOM ì¬ë°°ì¹˜
        visibleItems.forEach(item => parent.appendChild(item));
        
        // ê²°ê³¼ ì—…ë°ì´íŠ¸
        updateFilterResults(visibleItems.length);
      }
      
      // í•„í„° ê²°ê³¼ ì—…ë°ì´íŠ¸
      function updateFilterResults(count) {
        const resultDiv = document.getElementById('filterResults');
        if (!resultDiv) {
          const filterContainer = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-4');
          if (filterContainer) {
            const result = document.createElement('div');
            result.id = 'filterResults';
            result.className = 'col-span-full text-center text-gray-400 text-sm mt-4';
            filterContainer.parentElement.appendChild(result);
          }
        }
        
        const el = document.getElementById('filterResults');
        if (el) {
          el.textContent = \`\${count}ê°œì˜ ì‘í’ˆì´ ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤.\`;
        }
      }
      
      // í•„í„° ì´ˆê¸°í™”
      function resetFilters() {
        document.getElementById('categoryFilter').value = 'all';
        document.getElementById('priceFilter').value = 'all';
        document.getElementById('statusFilter').value = 'all';
        document.getElementById('sortFilter').value = 'created_desc';
        
        // ëª¨ë“  ì•„ì´í…œ í‘œì‹œ
        document.querySelectorAll('.gallery-item').forEach(item => {
          item.style.display = '';
        });
        
        const resultDiv = document.getElementById('filterResults');
        if (resultDiv) resultDiv.textContent = '';
      }
      
      async function loadCollections() {
        try {
          const response = await axios.get('/api/collections');
          const collections = response.data.data || [];
          
          const list = document.getElementById('collectionsList');
          if (collections.length === 0) {
            list.innerHTML = '<p class="text-gray-400 text-center col-span-full py-12">ë“±ë¡ëœ ì»¬ë ‰ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
          }
          
          list.innerHTML = collections.map(collection => \`
            <div class="card-nft rounded-3xl overflow-hidden group hover:scale-[1.02] transition-transform duration-300">
                <div class="relative h-64 bg-gradient-to-br from-purple-900 via-pink-900 to-red-900 overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent"></div>
                    <div class="absolute top-4 right-4">
                        <span class="px-3 py-1.5 bg-black bg-opacity-80 backdrop-blur-sm text-cyan-400 text-xs font-bold rounded-full border border-cyan-500 border-opacity-30">
                            <i class="fas fa-layer-group mr-1"></i>ì»¬ë ‰ì…˜
                        </span>
                    </div>
                    <div class="absolute bottom-4 left-4 right-4">
                        <h3 class="font-bold text-3xl text-white mb-2 drop-shadow-lg">\${collection.name}</h3>
                    </div>
                </div>
                <div class="p-6">
                    <p class="text-gray-400 mb-4 line-clamp-2">\${collection.description || 'íë ˆì´í„°ê°€ ì—„ì„ í•œ NFT ì‘í’ˆ ì»¬ë ‰ì…˜'}</p>
                    
                    <div class="flex items-center justify-between mb-4 p-4 bg-white bg-opacity-5 rounded-xl">
                        <div>
                            <div class="text-xs text-gray-500 mb-1">íë ˆì´í„°</div>
                            <div class="text-white font-semibold">\${collection.curator_name || 'ìµëª…'}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500 mb-1">ì‘í’ˆ ìˆ˜</div>
                            <div class="text-2xl font-black text-gradient">\${collection.artwork_count || 0}</div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-xs text-gray-500 mb-1">ì´ ê°€ì¹˜</div>
                            <div class="font-bold text-lg text-gradient">\${formatCollectionValue(collection.total_value || 0)}</div>
                        </div>
                        <a href="/collection/\${collection.id}" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-cyan-500 hover:from-purple-700 hover:to-cyan-600 text-white rounded-lg font-semibold text-sm transition-all">
                            <i class="fas fa-arrow-right mr-1"></i>ë³´ê¸°
                        </a>
                    </div>
                </div>
            </div>
          \`).join('');
        } catch (error) {
          console.error('Failed to load collections:', error);
          document.getElementById('collectionsList').innerHTML = '<p class="text-red-500 text-center col-span-full py-12">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
        }
      }
      
      function formatCollectionValue(value) {
        if (value >= 100000000) {
          return (value / 100000000).toFixed(1) + 'ì–µì›';
        } else if (value >= 10000) {
          return (value / 10000).toFixed(0) + 'ë§Œì›';
        }
        return value.toLocaleString() + 'ì›';
      }
      
      // ê°¤ëŸ¬ë¦¬ ê²€ìƒ‰ í•¨ìˆ˜
      function performGallerySearch() {
        const searchInput = document.getElementById('gallerySearchInput');
        const query = searchInput?.value?.trim();
        
        if (!query) {
          // ê²€ìƒ‰ì–´ ì—†ìœ¼ë©´ ì „ì²´ ì„¹ì…˜ ê²€ìƒ‰ ì…ë ¥ì°½ìœ¼ë¡œ í¬ì»¤ìŠ¤
          showCategory('all');
          setTimeout(() => {
            document.getElementById('searchInput')?.focus();
          }, 300);
          return;
        }
        
        // ì „ì²´ ì„¹ì…˜ìœ¼ë¡œ ì´ë™í•˜ê³  ê²€ìƒ‰
        showCategory('all');
        setTimeout(() => {
          const allSearchInput = document.getElementById('searchInput');
          if (allSearchInput) {
            allSearchInput.value = query;
            filterGallery();
            allSearchInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 300);
      }

      // ìŒì„± ê²€ìƒ‰ í•¨ìˆ˜
      function startGalleryVoiceSearch() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          alert('âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\\n\\nChrome, Edge, Safari ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
          return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'ko-KR';
        recognition.continuous = false;
        recognition.interimResults = false;

        const searchInput = document.getElementById('gallerySearchInput');
        
        // ìŒì„± ì¸ì‹ ì‹œì‘ ì•Œë¦¼
        searchInput.placeholder = 'ğŸ¤ ë“£ê³  ìˆìŠµë‹ˆë‹¤... ë§ì”€í•´ì£¼ì„¸ìš”';
        searchInput.classList.add('border-purple-500', 'bg-purple-900/20');

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          searchInput.value = transcript;
          searchInput.placeholder = 'ì‘í’ˆ ê²€ìƒ‰... (í…ìŠ¤íŠ¸, ìŒì„± ì§€ì›)';
          searchInput.classList.remove('border-purple-500', 'bg-purple-900/20');
          
          // ì¸ì‹ëœ í…ìŠ¤íŠ¸ë¡œ ì¦‰ì‹œ ê²€ìƒ‰
          setTimeout(() => performGallerySearch(), 500);
        };

        recognition.onerror = (event) => {
          console.error('Speech recognition error:', event.error);
          searchInput.placeholder = 'âŒ ìŒì„± ì¸ì‹ ì˜¤ë¥˜ - ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”';
          searchInput.classList.remove('border-purple-500', 'bg-purple-900/20');
          setTimeout(() => {
            searchInput.placeholder = 'ì‘í’ˆ ê²€ìƒ‰... (í…ìŠ¤íŠ¸, ìŒì„± ì§€ì›)';
          }, 2000);
        };

        recognition.onend = () => {
          searchInput.classList.remove('border-purple-500', 'bg-purple-900/20');
        };

        recognition.start();
      }
    </script>
    
    <style>
      .category-tab {
        background: rgba(255, 255, 255, 0.03);
        color: #9ca3af;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .category-tab:hover {
        background: rgba(255, 255, 255, 0.08);
        color: white;
      }
      .category-tab.active {
        background: linear-gradient(135deg, rgba(168, 85, 247, 0.2) 0%, rgba(6, 182, 212, 0.2) 100%);
        border-color: rgba(168, 85, 247, 0.5);
        color: white;
      }
      .category-content {
        animation: fadeIn 0.5s ease-in;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
    `;
    
    return c.html(getLayout(content, 'NFT Gallery - GALLERYPIA'))
  } catch (error: any) {
    return c.html(getLayout('<div class="py-20 text-center text-red-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message + '</div>'))
  }
})

// ì‘í’ˆ ìƒì„¸ í˜ì´ì§€ - ê°€ì¹˜í‰ê°€ ì •ë³´ í¬í•¨
app.get('/artwork/:id', async (c) => {
  try {
    const id = c.req.param('id')
    const db = c.env.DB
    
    // Get artwork with artist info and ranking
    const art = await db.prepare(`
      SELECT a.*, 
             ar.name as artist_name, 
             ar.profile_image as artist_profile_image, 
             ar.bio as artist_bio,
             ark.final_score as artist_total_score,
             (SELECT COUNT(*) + 1 FROM artist_ranks WHERE final_score > COALESCE(ark.final_score, 0)) as artist_rank
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      LEFT JOIN artist_ranks ark ON ar.id = ark.artist_id
      WHERE a.id = ?
    `).bind(id).first()
    
    if (!art) {
      return c.html(getLayout('<div class="py-20 text-center text-red-500">ì‘í’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>'))
    }
    
    // Get valuation history
    const historyData = await db.prepare(`
      SELECT * FROM artwork_final_valuation WHERE artwork_id = ? ORDER BY calculated_at DESC LIMIT 10
    `).bind(id).all()
    const history = { data: historyData.results }
    
    // v6.0: Get ownership info
    const ownershipData = await db.prepare(`
      SELECT ao.*, u.full_name, u.username, u.profile_image
      FROM artwork_ownership ao
      LEFT JOIN users u ON ao.owner_id = u.id
      WHERE ao.artwork_id = ? AND ao.is_current_owner = 1
      ORDER BY ao.acquired_at DESC
      LIMIT 1
    `).bind(id).first()
    const ownership = { data: ownershipData }
    
    // v6.0: Get reviews - Expert reviews first, then user reviews
    const reviewsData = await db.prepare(`
      SELECT r.*, u.username, u.full_name, u.profile_image, u.role
      FROM artwork_reviews r
      LEFT JOIN users u ON r.user_id = u.id
      WHERE r.artwork_id = ?
      ORDER BY 
        CASE WHEN u.role = 'expert' THEN 0 ELSE 1 END,
        r.created_at DESC
      LIMIT 10
    `).bind(id).all()
    const reviews = { data: reviewsData.results }
    
    // Get extended info
    const extendedInfo = await db.prepare(`
      SELECT * FROM artwork_extended_info WHERE artwork_id = ?
    `).bind(id).first()
    
    const content = `
    <section class="py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- ë’¤ë¡œê°€ê¸° -->
            <a href="/gallery" class="inline-flex items-center text-gray-400 hover:text-white mb-8 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i> ê°¤ëŸ¬ë¦¬ë¡œ ëŒì•„ê°€ê¸°
            </a>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                <!-- ì‘í’ˆ ì´ë¯¸ì§€ -->
                <div class="space-y-6">
                    <div class="card-nft rounded-3xl overflow-hidden">
                        <div class="aspect-square bg-gray-900">
                            <img src="${art.image_url}" alt="${art.title}" class="w-full h-full object-cover" loading="lazy" onerror="this.onerror=null; this.src='https://via.placeholder.com/800x800/1a1a1a/8b5cf6?text=${encodeURIComponent(art.title)}'">
                        </div>
                    </div>
                    
                    ${art.is_minted ? `
                    <div class="card-nft rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                            <i class="fas fa-cube text-gradient mr-2"></i>
                            NFT ì •ë³´
                        </h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">ë¸”ë¡ì²´ì¸</span>
                                <span class="text-white font-semibold">${art.blockchain_network || 'Ethereum'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">í† í° ID</span>
                                <span class="text-white font-mono text-xs">${art.nft_token_id || 'N/A'}</span>
                            </div>
                            ${art.nft_contract_address ? `
                            <div class="flex justify-between items-start">
                                <span class="text-gray-400">ì»¨íŠ¸ë™íŠ¸</span>
                                <span class="text-white font-mono text-xs break-all text-right ml-4">${art.nft_contract_address.substring(0, 10)}...${art.nft_contract_address.substring(art.nft_contract_address.length - 8)}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- 3D/AR/VR ë·°ì–´ -->
                    <div class="card-nft rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                            <i class="fas fa-vr-cardboard text-gradient mr-2"></i>
                            3D/AR/VR ë¯¸ë¦¬ë³´ê¸°
                        </h3>
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <button 
                                onclick="show3DViewer(${art.id}, '${art.image_url}', '${art.title}')" 
                                class="flex flex-col items-center justify-center p-4 bg-purple-600/20 hover:bg-purple-600/30 text-purple-300 rounded-xl transition-all border border-purple-500/30 hover:border-purple-400/50"
                            >
                                <i class="fas fa-cube text-2xl mb-2"></i>
                                <span class="text-xs font-semibold">3D ë·°ì–´</span>
                            </button>
                            <button 
                                onclick="showARViewer(${art.id}, '${art.image_url}', '${art.title}')" 
                                class="flex flex-col items-center justify-center p-4 bg-cyan-600/20 hover:bg-cyan-600/30 text-cyan-300 rounded-xl transition-all border border-cyan-500/30 hover:border-cyan-400/50"
                            >
                                <i class="fas fa-mobile-alt text-2xl mb-2"></i>
                                <span class="text-xs font-semibold">AR ë³´ê¸°</span>
                            </button>
                            <button 
                                onclick="showVRGallery(${art.id}, '${art.image_url}', '${art.title}')" 
                                class="flex flex-col items-center justify-center p-4 bg-pink-600/20 hover:bg-pink-600/30 text-pink-300 rounded-xl transition-all border border-pink-500/30 hover:border-pink-400/50"
                            >
                                <i class="fas fa-vr-cardboard text-2xl mb-2"></i>
                                <span class="text-xs font-semibold">VR ê°¤ëŸ¬ë¦¬</span>
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 text-center">
                            ì‘í’ˆì„ 3Dë¡œ íšŒì „í•˜ê±°ë‚˜ ARë¡œ ì‹¤ì œ ê³µê°„ì— ë°°ì¹˜í•´ë³´ì„¸ìš”
                        </p>
                    </div>
                </div>
                
                <!-- ì‘í’ˆ ì •ë³´ ë° ê°€ì¹˜í‰ê°€ -->
                <div class="space-y-8">
                    <!-- ê¸°ë³¸ ì •ë³´ -->
                    <div>
                        <div class="flex items-center gap-3 mb-4">
                            ${art.is_minted ? '<span class="px-3 py-1.5 bg-gradient-to-r from-purple-600 to-cyan-500 text-white text-xs font-bold rounded-full flex items-center w-fit"><i class="fas fa-cube mr-1.5"></i>NFT</span>' : ''}
                            <span class="px-3 py-1.5 bg-white bg-opacity-5 text-gray-300 text-xs font-semibold rounded-full">${art.category}</span>
                        </div>
                        <h1 class="text-5xl font-black text-white mb-4">${art.title}</h1>
                        
                        <!-- ì‘í’ˆ ì„¤ëª… ìƒì„¸ ì˜ì—­ -->
                        <div class="bg-gradient-to-br from-indigo-900/20 via-purple-900/20 to-pink-900/20 backdrop-blur-sm rounded-2xl p-6 mb-6 border border-purple-500/20">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <i class="fas fa-align-left text-purple-400 mr-2"></i>
                                ì‘í’ˆ ì„¤ëª…
                            </h3>
                            <div class="text-gray-300 text-base leading-relaxed space-y-3">
                                <p>${art.description || 'ì‘í’ˆ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</p>
                                ${extendedInfo?.description_extended ? `
                                    <p class="pt-3 border-t border-purple-500/20">${extendedInfo.description_extended}</p>
                                ` : ''}
                                ${art.creation_story ? `
                                    <div class="pt-3 border-t border-purple-500/20">
                                        <p class="text-sm font-semibold text-purple-300 mb-2">ì œì‘ ë°°ê²½</p>
                                        <p class="text-gray-400">${art.creation_story}</p>
                                    </div>
                                ` : ''}
                                ${extendedInfo?.artistic_concept ? `
                                    <div class="pt-3 border-t border-purple-500/20">
                                        <p class="text-sm font-semibold text-purple-300 mb-2">ì˜ˆìˆ ì  ê°œë…</p>
                                        <p class="text-gray-400">${extendedInfo.artistic_concept}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- ì•„í‹°ìŠ¤íŠ¸ ì •ë³´ with Ranking -->
                        <div class="flex items-center gap-4 p-6 rounded-2xl bg-gradient-to-br from-amber-900/30 via-orange-900/20 to-yellow-900/30 backdrop-blur-sm border border-amber-500/30 hover:border-amber-400/50 transition-all duration-300">
                            <img src="${art.artist_profile_image}" class="w-16 h-16 rounded-full object-cover ring-2 ring-amber-400/50" alt="${art.artist_name}" loading="lazy" onerror="this.onerror=null; this.src='https://via.placeholder.com/100/f59e0b/ffffff?text=${encodeURIComponent(art.artist_name?.charAt(0) || '?')}'">
                            <div class="flex-1">
                                <div class="text-xs text-amber-400 mb-1 font-semibold flex items-center">
                                    <i class="fas fa-palette mr-1"></i>
                                    Artist
                                </div>
                                <div class="text-white font-bold text-xl mb-1">${art.artist_name}</div>
                                ${art.artist_rank ? `
                                    <div class="flex items-center gap-2 text-sm">
                                        <span class="px-2 py-0.5 bg-gradient-to-r from-amber-500 to-orange-500 text-white text-xs font-bold rounded-full flex items-center">
                                            <i class="fas fa-trophy mr-1"></i>
                                            ë­í‚¹ #${art.artist_rank}
                                        </span>
                                        <span class="text-amber-300 text-xs font-semibold">
                                            ì¢…í•©ì ìˆ˜: ${art.artist_total_score ? art.artist_total_score.toFixed(1) : 'N/A'}ì 
                                        </span>
                                    </div>
                                ` : ''}
                            </div>
                            <a href="/artists/${art.artist_id}" class="px-4 py-2 bg-amber-500/20 hover:bg-amber-500/30 text-amber-300 text-sm font-semibold rounded-lg transition-all">
                                í”„ë¡œí•„ ë³´ê¸° <i class="fas fa-arrow-right ml-1"></i>
                            </a>
                        </div>
                    </div>
                    
                    <!-- ê°€ì¹˜í‰ê°€ ì‹œìŠ¤í…œ -->
                    <div class="card-nft rounded-3xl p-8 space-y-8">
                        <div class="text-center border-b border-white border-opacity-10 pb-6">
                            <div class="text-sm text-gray-400 mb-2">AI ê¸°ë°˜ ì‘í’ˆ ê°€ì¹˜ ì‚°ì •</div>
                            <div class="text-5xl font-black text-gradient mb-2">${formatPrice(art.estimated_value)}</div>
                            <div class="text-xs text-gray-500 mb-4">Based on quantitative and qualitative analysis</div>
                            
                            <!-- AI ê°€ê²© ì˜ˆì¸¡ ë²„íŠ¼ -->
                            <div class="flex flex-col sm:flex-row gap-3">
                                <button 
                                    onclick="showPricePrediction(${art.id})"
                                    class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 hover:from-purple-700 hover:to-cyan-600 text-white font-bold rounded-xl transition-all hover:scale-105 shadow-lg"
                                >
                                    <i class="fas fa-robot"></i>
                                    <span>AI ê°€ê²© ì˜ˆì¸¡ ë³´ê¸°</span>
                                    <i class="fas fa-chart-line"></i>
                                </button>
                                
                                <!-- ì „ë¬¸ê°€ í‰ê°€ ë²„íŠ¼ (ì „ë¬¸ê°€/ê´€ë¦¬ìë§Œ í‘œì‹œ) -->
                                <a 
                                    href="/evaluate/${art.id}"
                                    id="evaluateBtn"
                                    class="hidden items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-amber-600 to-orange-500 hover:from-amber-700 hover:to-orange-600 text-white font-bold rounded-xl transition-all hover:scale-105 shadow-lg"
                                >
                                    <i class="fas fa-clipboard-check"></i>
                                    <span>ì‘í’ˆ í‰ê°€í•˜ê¸°</span>
                                </a>
                            </div>
                            
                            <script>
                                // Show evaluate button for experts and admins
                                (function() {
                                    const user = JSON.parse(localStorage.getItem('user') || 'null');
                                    if (user && (user.role === 'expert' || user.role === 'admin')) {
                                        document.getElementById('evaluateBtn').classList.remove('hidden');
                                        document.getElementById('evaluateBtn').classList.add('inline-flex');
                                    }
                                })();
                            </script>
                        </div>
                        
                        <!-- ì •ëŸ‰ì  í‰ê°€ (30%) -->
                        <div>
                            <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                                <i class="fas fa-chart-line text-cyan-400 mr-2"></i>
                                ì •ëŸ‰ì  í‰ê°€ <span class="text-gray-500 text-sm ml-2">(30%)</span>
                            </h3>
                            <div class="space-y-4">
                                <!-- ì‹œì¥ ìˆ˜ìš” -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-gray-400">ì‹œì¥ ìˆ˜ìš” (50%)</span>
                                        <span class="text-sm font-bold text-white">${art.market_demand_score}/100</span>
                                    </div>
                                    <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-cyan-500 to-blue-500" style="width: ${art.market_demand_score}%"></div>
                                    </div>
                                </div>
                                
                                <!-- í¬ì†Œì„± -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-gray-400">í¬ì†Œì„± (50%)</span>
                                        <span class="text-sm font-bold text-white">${art.rarity_score}/100</span>
                                    </div>
                                    <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500" style="width: ${art.rarity_score}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ì •ì„±ì  í‰ê°€ (70%) -->
                        <div>
                            <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                                <i class="fas fa-palette text-purple-400 mr-2"></i>
                                ì •ì„±ì  í‰ê°€ <span class="text-gray-500 text-sm ml-2">(70%)</span>
                            </h3>
                            <div class="space-y-4">
                                <!-- ì˜ˆìˆ ì  ì™„ì„±ë„ -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-gray-400">ì˜ˆìˆ ì  ì™„ì„±ë„ (35%)</span>
                                        <span class="text-sm font-bold text-white">${art.artistic_quality_score}/100</span>
                                    </div>
                                    <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-yellow-500 to-orange-500" style="width: ${art.artistic_quality_score}%"></div>
                                    </div>
                                </div>
                                
                                <!-- ë…ì°½ì„± -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-gray-400">ë…ì°½ì„± (30%)</span>
                                        <span class="text-sm font-bold text-white">${art.originality_score}/100</span>
                                    </div>
                                    <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-green-500 to-emerald-500" style="width: ${art.originality_score}%"></div>
                                    </div>
                                </div>
                                
                                <!-- ë¬¸í™”ì  ì˜ì˜ -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-gray-400">ë¬¸í™”ì  ì˜ì˜ (20%)</span>
                                        <span class="text-sm font-bold text-white">${art.cultural_significance_score}/100</span>
                                    </div>
                                    <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-pink-500 to-rose-500" style="width: ${art.cultural_significance_score}%"></div>
                                    </div>
                                </div>
                                
                                <!-- ê¸°ìˆ ì  ìš°ìˆ˜ì„± -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-gray-400">ê¸°ìˆ ì  ìš°ìˆ˜ì„± (15%)</span>
                                        <span class="text-sm font-bold text-white">${art.technical_excellence_score}/100</span>
                                    </div>
                                    <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500" style="width: ${art.technical_excellence_score}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        

                    </div>
                    
                    <!-- êµ¬ë§¤/ì…ì°° ì•¡ì…˜ ë²„íŠ¼ -->
                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex flex-col sm:flex-row gap-4">
                            ${art.current_price > 0 ? `
                            <button 
                                onclick="openPurchaseModal()"
                                class="flex-1 py-4 bg-gradient-to-r from-green-600 to-emerald-500 hover:from-green-700 hover:to-emerald-600 text-white font-bold text-lg rounded-xl transition-all hover:scale-105 shadow-lg flex items-center justify-center gap-2"
                            >
                                <i class="fas fa-shopping-cart"></i>
                                <span>êµ¬ë§¤ ì œì•ˆí•˜ê¸°</span>
                                <span class="text-sm opacity-80">(${formatPrice(art.current_price)})</span>
                            </button>
                            ` : ''}
                            
                            <button 
                                onclick="openBidModal()"
                                class="flex-1 py-4 bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 text-white font-bold text-lg rounded-xl transition-all hover:scale-105 shadow-lg flex items-center justify-center gap-2"
                            >
                                <i class="fas fa-gavel"></i>
                                <span>ì…ì°°í•˜ê¸°</span>
                            </button>
                            
                            <button 
                                onclick="toggleFavorite()"
                                id="favoriteBtn"
                                class="px-6 py-4 bg-gray-800 hover:bg-gray-700 text-white rounded-xl transition-all flex items-center justify-center gap-2"
                            >
                                <i class="far fa-heart"></i>
                                <span class="hidden sm:inline">ê´€ì‹¬ì‘í’ˆ</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- í‰ê°€ ì´ë ¥ -->
                    ${history.data && history.data.length > 0 ? `
                    <div class="card-nft rounded-3xl p-8">
                        <h3 class="text-lg font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-history text-gradient mr-2"></i>
                            ê°€ì¹˜í‰ê°€ ì´ë ¥
                        </h3>
                        <div class="space-y-4">
                            ${history.data.map((h: any) => `
                            <div class="bg-white bg-opacity-5 rounded-xl p-4">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <div class="text-white font-semibold">${h.evaluator_name || 'ìµëª… í‰ê°€ì'}</div>
                                        <div class="text-xs text-gray-500">${h.evaluator_role || 'ì¼ë°˜'} Â· ${new Date(h.evaluated_at).toLocaleDateString('ko-KR')}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-gray-400">í‰ê°€ì•¡</div>
                                        <div class="font-bold text-gradient">${formatPrice(h.estimated_value)}</div>
                                    </div>
                                </div>
                                ${h.evaluation_notes ? `<p class="text-sm text-gray-400 italic">&quot;${h.evaluation_notes}&quot;</p>` : ''}
                            </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- ì‘í’ˆ ìƒì„¸ ì •ë³´ with ì €ì‘ê¶Œ/ë¼ì´ì„¼ìŠ¤ -->
                    <div class="card-nft rounded-3xl p-8">
                        <h3 class="text-lg font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-info-circle text-gradient mr-2"></i>
                            ì‘í’ˆ ìƒì„¸ ì •ë³´
                        </h3>
                        <div class="grid grid-cols-2 gap-6 text-sm mb-8">
                            <div>
                                <div class="text-gray-500 mb-2 flex items-center">
                                    <i class="fas fa-calendar text-cyan-400 mr-2"></i>
                                    ì œì‘ ì—°ë„
                                </div>
                                <div class="text-white font-semibold text-base">${art.creation_year || 'N/A'}</div>
                            </div>
                            <div>
                                <div class="text-gray-500 mb-2 flex items-center">
                                    <i class="fas fa-brush text-purple-400 mr-2"></i>
                                    ê¸°ë²•
                                </div>
                                <div class="text-white font-semibold text-base">${art.technique || 'N/A'}</div>
                            </div>
                            ${art.size_width && art.size_height ? `
                            <div>
                                <div class="text-gray-500 mb-2 flex items-center">
                                    <i class="fas fa-expand-arrows-alt text-pink-400 mr-2"></i>
                                    í¬ê¸°
                                </div>
                                <div class="text-white font-semibold text-base">${art.size_width} Ã— ${art.size_height} cm</div>
                            </div>
                            ` : ''}
                            <div>
                                <div class="text-gray-500 mb-2 flex items-center">
                                    <i class="fas fa-check-circle text-green-400 mr-2"></i>
                                    ìƒíƒœ
                                </div>
                                <div class="text-white font-semibold text-base">${art.status === 'approved' ? 'ìŠ¹ì¸ë¨' : art.status === 'minted' ? 'NFT ë°œí–‰' : 'ê²€í† ì¤‘'}</div>
                            </div>
                        </div>
                        
                        <!-- ì €ì‘ê¶Œ ë° ë¼ì´ì„¼ìŠ¤ ì •ë³´ -->
                        <div class="pt-6 border-t border-white border-opacity-10">
                            <h4 class="text-base font-bold text-white mb-4 flex items-center">
                                <i class="fas fa-copyright text-amber-400 mr-2"></i>
                                ì €ì‘ê¶Œ ë° ë¼ì´ì„¼ìŠ¤
                            </h4>
                            <div class="space-y-4 text-sm">
                                <div class="bg-amber-900/20 rounded-xl p-4 border border-amber-500/30">
                                    <div class="flex items-start gap-3">
                                        <i class="fas fa-shield-alt text-amber-400 mt-1"></i>
                                        <div>
                                            <p class="text-amber-200 font-semibold mb-1">ì €ì‘ê¶Œ</p>
                                            <p class="text-gray-300">ë³¸ ì‘í’ˆì˜ ì €ì‘ê¶Œì€ ì‘ê°€ <span class="text-white font-bold">${art.artist_name}</span>ì—ê²Œ ìˆìœ¼ë©°, ëª¨ë“  ê¶Œë¦¬ê°€ ë³´í˜¸ë©ë‹ˆë‹¤.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-blue-900/20 rounded-xl p-4 border border-blue-500/30">
                                    <div class="flex items-start gap-3">
                                        <i class="fas fa-file-contract text-blue-400 mt-1"></i>
                                        <div>
                                            <p class="text-blue-200 font-semibold mb-2">NFT ë¼ì´ì„¼ìŠ¤ ë²”ìœ„</p>
                                            <ul class="space-y-1.5 text-gray-300">
                                                <li class="flex items-start">
                                                    <i class="fas fa-check text-green-400 mr-2 mt-0.5 text-xs"></i>
                                                    <span>ê°œì¸ì  ìš©ë„ë¡œ ì†Œì¥ ë° ê°ìƒ ê°€ëŠ¥</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <i class="fas fa-check text-green-400 mr-2 mt-0.5 text-xs"></i>
                                                    <span>NFT ì†Œìœ ê¶Œ ë° ê±°ë˜ê¶Œ ë³´ìœ </span>
                                                </li>
                                                <li class="flex items-start">
                                                    <i class="fas fa-check text-green-400 mr-2 mt-0.5 text-xs"></i>
                                                    <span>ë¹„ìƒì—…ì  ì „ì‹œ ë° ê³µìœ  í—ˆìš©</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <i class="fas fa-times text-red-400 mr-2 mt-0.5 text-xs"></i>
                                                    <span>ìƒì—…ì  ì´ìš© ì‹œ ì‘ê°€ ìŠ¹ì¸ í•„ìš”</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <i class="fas fa-times text-red-400 mr-2 mt-0.5 text-xs"></i>
                                                    <span>2ì°¨ ì €ì‘ë¬¼ ì œì‘ ê¸ˆì§€ (ì‘ê°€ ì‚¬ì „ ë™ì˜ í•„ìš”)</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                
                                ${extendedInfo?.license_type ? `
                                <div class="bg-purple-900/20 rounded-xl p-4 border border-purple-500/30">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-purple-200 font-semibold mb-1">ë¼ì´ì„¼ìŠ¤ ìœ í˜•</p>
                                            <p class="text-white font-bold">${extendedInfo.license_type}</p>
                                        </div>
                                        <i class="fas fa-certificate text-purple-400 text-2xl"></i>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- v6.0: ì†Œìœ ì ì •ë³´ -->
                    ${ownership.data ? `
                    <div class="card-nft rounded-3xl p-8">
                        <h3 class="text-lg font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-user-circle text-gradient mr-2"></i>
                            í˜„ì¬ ì†Œìœ ì
                        </h3>
                        <div class="flex items-center gap-4 p-4 rounded-2xl bg-white bg-opacity-5">
                            <img src="${ownership.data.profile_image || 'https://via.placeholder.com/80'}" 
                                 class="w-16 h-16 rounded-full object-cover" 
                                 alt="${ownership.data.full_name}"
                                 loading="lazy">
                            <div class="flex-1">
                                <div class="text-white font-bold text-lg">${ownership.data.full_name || ownership.data.username}</div>
                                <div class="text-xs text-gray-500">ì†Œìœ  ì‹œì‘: ${new Date(ownership.data.acquired_at).toLocaleDateString('ko-KR')}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500 mb-1">íšë“ê°€</div>
                                <div class="font-bold text-gradient">${formatPrice(ownership.data.acquisition_price)}</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                    <div class="flex gap-4">
                        <button onclick="handlePurchase(${id})" class="flex-1 btn-neon px-8 py-4 rounded-2xl text-white font-bold text-lg">
                            <i class="fas fa-shopping-cart mr-2"></i>
                            êµ¬ë§¤í•˜ê¸°
                        </button>
                        <button onclick="handleBidding(${id})" class="flex-1 px-8 py-4 rounded-2xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold hover:opacity-90 transition-all">
                            <i class="fas fa-gavel mr-2"></i>
                            ê²½ë§¤ ì°¸ì—¬
                        </button>
                        <button onclick="handleLike(${id})" class="px-8 py-4 rounded-2xl bg-white bg-opacity-5 text-white font-bold hover:bg-opacity-10 transition-all neon-border">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- v6.0: ë¦¬ë·° & í‰ê°€ ì„¹ì…˜ (ì „ë¬¸ê°€ ë¦¬ë·° ìš°ì„ ) -->
            <div class="mt-20">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-black text-white flex items-center">
                        <i class="fas fa-star text-gradient mr-3"></i>
                        ì‘í’ˆ ë¦¬ë·°
                    </h2>
                    <button onclick="openReviewModal()" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 text-white rounded-xl font-semibold hover:opacity-90 transition">
                        <i class="fas fa-edit mr-2"></i>
                        ë¦¬ë·° ì‘ì„±
                    </button>
                </div>
                
                <!-- ë¦¬ë·° í†µê³„ -->
                ${reviews.data && reviews.data.length > 0 ? `
                <div class="card-nft rounded-3xl p-8 mb-8">
                    <div class="grid md:grid-cols-3 gap-8">
                        <div class="text-center">
                            <div class="text-5xl font-black text-gradient mb-2">${art.average_rating ? art.average_rating.toFixed(1) : '0.0'}</div>
                            <div class="flex justify-center mb-2">
                                ${[1,2,3,4,5].map(star => `
                                    <i class="fas fa-star ${star <= Math.round(art.average_rating || 0) ? 'text-yellow-400' : 'text-gray-600'}"></i>
                                `).join('')}
                            </div>
                            <div class="text-gray-400 text-sm">${reviews.data.length}ê°œì˜ ë¦¬ë·°</div>
                        </div>
                        <div class="md:col-span-2">
                            <div class="space-y-2">
                                ${[5,4,3,2,1].map(rating => {
                                  const count = reviews.data.filter((r: any) => r.rating === rating).length
                                  const percentage = reviews.data.length > 0 ? (count / reviews.data.length) * 100 : 0
                                  return `
                                    <div class="flex items-center gap-3">
                                        <div class="text-sm text-gray-400 w-8">${rating}ì </div>
                                        <div class="flex-1 h-2 bg-gray-800 rounded-full overflow-hidden">
                                            <div class="h-full bg-gradient-to-r from-yellow-400 to-yellow-600" style="width: ${percentage}%"></div>
                                        </div>
                                        <div class="text-sm text-gray-500 w-12 text-right">${count}ê°œ</div>
                                    </div>
                                  `
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ë¦¬ë·° ëª©ë¡ (ì „ë¬¸ê°€ ë¦¬ë·° ìš°ì„  í‘œì‹œ) -->
                <div class="space-y-6">
                    ${reviews.data.map((review: any) => `
                        <div class="card-nft rounded-2xl p-6 ${review.role === 'expert' ? 'ring-2 ring-amber-500/50 bg-gradient-to-br from-amber-900/10 via-transparent to-transparent' : ''}">
                            <div class="flex items-start gap-4">
                                <div class="relative">
                                    <img src="${review.profile_image || 'https://via.placeholder.com/60'}" 
                                         class="w-12 h-12 rounded-full object-cover ${review.role === 'expert' ? 'ring-2 ring-amber-400' : ''}" 
                                         alt="${review.full_name}"
                                         loading="lazy">
                                    ${review.role === 'expert' ? `
                                        <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-gradient-to-r from-amber-500 to-orange-500 rounded-full flex items-center justify-center">
                                            <i class="fas fa-certificate text-white text-xs"></i>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-2">
                                        <div>
                                            <div class="flex items-center gap-2">
                                                <span class="text-white font-bold">${review.full_name || review.username}</span>
                                                ${review.role === 'expert' ? `
                                                    <span class="px-2 py-0.5 bg-gradient-to-r from-amber-500 to-orange-500 text-white text-xs font-bold rounded-full flex items-center">
                                                        <i class="fas fa-medal mr-1"></i>
                                                        ì „ë¬¸ê°€
                                                    </span>
                                                ` : ''}
                                            </div>
                                            <div class="flex items-center gap-2 text-sm text-gray-400">
                                                <div class="flex">
                                                    ${[1,2,3,4,5].map(star => `
                                                        <i class="fas fa-star text-xs ${star <= review.rating ? 'text-yellow-400' : 'text-gray-600'}"></i>
                                                    `).join('')}
                                                </div>
                                                <span>Â·</span>
                                                <span>${new Date(review.created_at).toLocaleDateString('ko-KR')}</span>
                                            </div>
                                        </div>
                                    </div>
                                    ${review.review_text ? `
                                        <p class="text-gray-300 mt-3 leading-relaxed">${review.review_text}</p>
                                    ` : ''}
                                    ${review.artistic_value_rating || review.investment_potential_rating ? `
                                        <div class="flex gap-4 mt-4 pt-4 border-t border-white border-opacity-10">
                                            ${review.artistic_value_rating ? `
                                                <div class="text-sm">
                                                    <span class="text-gray-500">ì˜ˆìˆ ì„±:</span>
                                                    <span class="text-gradient font-bold ml-2">${review.artistic_value_rating}/5</span>
                                                </div>
                                            ` : ''}
                                            ${review.investment_potential_rating ? `
                                                <div class="text-sm">
                                                    <span class="text-gray-500">íˆ¬ìê°€ì¹˜:</span>
                                                    <span class="text-gradient font-bold ml-2">${review.investment_potential_rating}/5</span>
                                                </div>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                ` : `
                <div class="card-nft rounded-3xl p-12 text-center">
                    <i class="fas fa-comments text-6xl text-gray-600 mb-4"></i>
                    <p class="text-gray-400 text-lg">ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    <p class="text-gray-500 text-sm mt-2">ì²« ë²ˆì§¸ ë¦¬ë·°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
                </div>
                `}
            </div>
        </div>
    </section>
    
    <!-- ë¦¬ë·° ì‘ì„± ëª¨ë‹¬ -->
    <div id="reviewModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="card-nft rounded-3xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-white">ë¦¬ë·° ì‘ì„±</h3>
                <button onclick="closeReviewModal()" class="text-gray-400 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="reviewForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-3">ì „ì²´ í‰ì  *</label>
                    <div class="flex gap-2">
                        ${[1,2,3,4,5].map(star => `
                            <button type="button" onclick="setRating(${star})" 
                                    class="rating-star text-3xl text-gray-600 hover:text-yellow-400 transition">
                                <i class="fas fa-star"></i>
                            </button>
                        `).join('')}
                    </div>
                    <input type="hidden" id="reviewRating" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">ë¦¬ë·° ë‚´ìš©</label>
                    <textarea id="reviewText" rows="5" 
                              class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white resize-none focus:border-purple-500 focus:outline-none"
                              placeholder="ì‘í’ˆì— ëŒ€í•œ ì†”ì§í•œ ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš”"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">ì˜ˆìˆ ì  ê°€ì¹˜</label>
                        <select id="artisticValue" 
                                class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-purple-500 focus:outline-none">
                            <option value="">ì„ íƒ ì•ˆí•¨</option>
                            ${[1,2,3,4,5].map(n => `<option value="${n}">${n}ì </option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">íˆ¬ì ê°€ì¹˜</label>
                        <select id="investmentValue" 
                                class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-purple-500 focus:outline-none">
                            <option value="">ì„ íƒ ì•ˆí•¨</option>
                            ${[1,2,3,4,5].map(n => `<option value="${n}">${n}ì </option>`).join('')}
                        </select>
                    </div>
                </div>
                
                <div class="flex gap-4">
                    <button type="button" onclick="closeReviewModal()" 
                            class="flex-1 py-3 bg-gray-800 hover:bg-gray-700 text-white rounded-xl transition">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit" 
                            class="flex-1 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 text-white rounded-xl font-semibold hover:opacity-90 transition">
                        ë¦¬ë·° ë“±ë¡
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- êµ¬ë§¤í•˜ê¸° ëª¨ë‹¬ -->
    <div id="purchaseModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="card-nft rounded-3xl p-8 max-w-xl w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-white">ì‘í’ˆ êµ¬ë§¤í•˜ê¸°</h3>
                <button onclick="closePurchaseModal()" class="text-gray-400 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-6">
                <div class="text-sm text-gray-400 mb-2">ì‘í’ˆëª…</div>
                <div class="text-white font-bold text-lg">${art.title}</div>
            </div>
            
            <div class="mb-6">
                <div class="text-sm text-gray-400 mb-2">ì˜ˆìƒ ê°€ê²©</div>
                <div class="text-gradient font-black text-3xl">${formatPrice(art.estimated_value || 0)}</div>
            </div>
            
            <form id="purchaseForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">ì œì•ˆ ê°€ê²© (ETH) *</label>
                    <input type="number" id="offerPrice" step="0.001" min="0.001" required
                           class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-purple-500 focus:outline-none"
                           placeholder="0.000" />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">ë©”ì‹œì§€ (ì„ íƒ)</label>
                    <textarea id="purchaseMessage" rows="3"
                              class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white resize-none focus:border-purple-500 focus:outline-none"
                              placeholder="íŒë§¤ìì—ê²Œ ì „ë‹¬í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>
                
                <div class="bg-purple-500 bg-opacity-10 border border-purple-500 border-opacity-30 rounded-xl p-4">
                    <div class="text-sm text-purple-300">
                        <i class="fas fa-info-circle mr-2"></i>
                        êµ¬ë§¤ ì œì•ˆì€ íŒë§¤ìì—ê²Œ ì „ì†¡ë˜ë©°, íŒë§¤ìê°€ ìˆ˜ë½í•˜ë©´ ê±°ë˜ê°€ ì§„í–‰ë©ë‹ˆë‹¤.
                    </div>
                </div>
                
                <div class="flex gap-4 pt-2">
                    <button type="button" onclick="closePurchaseModal()" 
                            class="flex-1 py-3 bg-gray-800 hover:bg-gray-700 text-white rounded-xl transition">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit" 
                            class="flex-1 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 text-white rounded-xl font-semibold hover:opacity-90 transition">
                        ì œì•ˆ ë³´ë‚´ê¸°
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ê²½ë§¤ ì°¸ì—¬ ëª¨ë‹¬ -->
    <div id="biddingModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="card-nft rounded-3xl p-8 max-w-xl w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-white">ê²½ë§¤ ì…ì°°</h3>
                <button onclick="closeBiddingModal()" class="text-gray-400 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="auctionInfo" class="space-y-4 mb-6">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin text-3xl text-gray-500"></i>
                    <div class="text-gray-400 mt-2">ê²½ë§¤ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
            
            <form id="biddingForm" class="hidden space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">ì…ì°° ê¸ˆì•¡ (ETH) *</label>
                    <input type="number" id="bidAmount" step="0.001" min="0.001" required
                           class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-amber-500 focus:outline-none"
                           placeholder="0.000" />
                    <div class="text-xs text-gray-500 mt-1">í˜„ì¬ê°€ë³´ë‹¤ ë†’ì€ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                </div>
                
                <div class="bg-amber-500 bg-opacity-10 border border-amber-500 border-opacity-30 rounded-xl p-4">
                    <div class="text-sm text-amber-300">
                        <i class="fas fa-gavel mr-2"></i>
                        ì…ì°°ì€ ì·¨ì†Œí•  ìˆ˜ ì—†ìœ¼ë©°, ê²½ë§¤ ì¢…ë£Œ ì‹œ ìµœê³  ì…ì°°ìê°€ ë‚™ì°°ë©ë‹ˆë‹¤.
                    </div>
                </div>
                
                <div class="flex gap-4 pt-2">
                    <button type="button" onclick="closeBiddingModal()" 
                            class="flex-1 py-3 bg-gray-800 hover:bg-gray-700 text-white rounded-xl transition">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit" 
                            class="flex-1 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl font-semibold hover:opacity-90 transition">
                        ì…ì°°í•˜ê¸°
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
      const ARTWORK_ID = ${id};
      
      function formatPrice(price) {
        if (price >= 100000000) return (price / 100000000).toFixed(1) + 'ì–µì›';
        else if (price >= 10000) return (price / 10000).toFixed(0) + 'ë§Œì›';
        return price.toLocaleString() + 'ì›';
      }
      
      // ë¦¬ë·° ëª¨ë‹¬
      let selectedRating = 0;
      
      function openReviewModal() {
        document.getElementById('reviewModal').classList.remove('hidden');
      }
      
      function closeReviewModal() {
        document.getElementById('reviewModal').classList.add('hidden');
        document.getElementById('reviewForm').reset();
        selectedRating = 0;
        updateStarDisplay();
      }
      
      function setRating(rating) {
        selectedRating = rating;
        document.getElementById('reviewRating').value = rating;
        updateStarDisplay();
      }
      
      function updateStarDisplay() {
        const stars = document.querySelectorAll('.rating-star');
        stars.forEach((star, index) => {
          if (index < selectedRating) {
            star.classList.add('text-yellow-400');
            star.classList.remove('text-gray-600');
          } else {
            star.classList.add('text-gray-600');
            star.classList.remove('text-yellow-400');
          }
        });
      }
      
      // ë¦¬ë·° ì œì¶œ
      document.getElementById('reviewForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const sessionToken = localStorage.getItem('session_token');
        if (!sessionToken) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          window.location.href = '/login';
          return;
        }
        
        if (!selectedRating) {
          alert('í‰ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        
        try {
          const response = await axios.post('/api/artworks/' + ${id} + '/reviews', {
            rating: selectedRating,
            review_text: document.getElementById('reviewText').value,
            artistic_value_rating: parseInt(document.getElementById('artisticValue').value) || null,
            investment_potential_rating: parseInt(document.getElementById('investmentValue').value) || null
          }, {
            headers: {
              'Authorization': 'Bearer ' + sessionToken
            }
          });
          
          if (response.data.success) {
            alert('ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            closeReviewModal();
            location.reload();
          } else {
            alert('ë¦¬ë·° ë“±ë¡ ì‹¤íŒ¨: ' + response.data.message);
          }
        } catch (error) {
          console.error('Review submission error:', error);
          alert('ë¦¬ë·° ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error.response?.data?.message || error.message));
        }
      });
      
      // êµ¬ë§¤/ê²½ë§¤/ì¢‹ì•„ìš” í•¸ë“¤ëŸ¬
      function handlePurchase(artworkId) {
        const sessionToken = localStorage.getItem('session_token');
        if (!sessionToken) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          window.location.href = '/login';
          return;
        }
        document.getElementById('purchaseModal').classList.remove('hidden');
      }
      
      function closePurchaseModal() {
        document.getElementById('purchaseModal').classList.add('hidden');
        document.getElementById('purchaseForm').reset();
      }
      
      async function handleBidding(artworkId) {
        const sessionToken = localStorage.getItem('session_token');
        if (!sessionToken) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          window.location.href = '/login';
          return;
        }
        
        document.getElementById('biddingModal').classList.remove('hidden');
        
        // ê²½ë§¤ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        try {
          const response = await axios.get('/api/artworks/' + artworkId + '/auction');
          
          if (response.data.success && response.data.data) {
            const auction = response.data.data;
            const recentBids = response.data.recent_bids || [];
            
            const endTime = new Date(auction.end_time);
            const now = new Date();
            const timeLeft = endTime - now;
            const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
            const daysLeft = Math.floor(hoursLeft / 24);
            
            let timeLeftText = '';
            if (timeLeft < 0) {
              timeLeftText = '<span class="text-red-400">ê²½ë§¤ ì¢…ë£Œ</span>';
            } else if (daysLeft > 0) {
              timeLeftText = daysLeft + 'ì¼ ' + (hoursLeft % 24) + 'ì‹œê°„ ë‚¨ìŒ';
            } else {
              timeLeftText = hoursLeft + 'ì‹œê°„ ë‚¨ìŒ';
            }
            
            document.getElementById('auctionInfo').innerHTML = \`
              <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-900 rounded-xl p-4">
                  <div class="text-xs text-gray-500 mb-1">ì‹œì‘ê°€</div>
                  <div class="text-white font-bold">\${auction.starting_price} ETH</div>
                </div>
                <div class="bg-gray-900 rounded-xl p-4">
                  <div class="text-xs text-gray-500 mb-1">í˜„ì¬ê°€</div>
                  <div class="text-gradient font-bold text-lg">\${auction.current_price} ETH</div>
                </div>
                <div class="bg-gray-900 rounded-xl p-4">
                  <div class="text-xs text-gray-500 mb-1">ì…ì°° ìˆ˜</div>
                  <div class="text-white font-bold">\${auction.total_bids}íšŒ</div>
                </div>
                <div class="bg-gray-900 rounded-xl p-4">
                  <div class="text-xs text-gray-500 mb-1">ë‚¨ì€ ì‹œê°„</div>
                  <div class="text-white font-bold">\${timeLeftText}</div>
                </div>
              </div>
              \${recentBids.length > 0 ? \`
                <div class="mt-4">
                  <div class="text-sm text-gray-400 mb-2">ìµœê·¼ ì…ì°°</div>
                  <div class="space-y-2 max-h-32 overflow-y-auto">
                    \${recentBids.map(bid => \`
                      <div class="flex justify-between items-center text-sm bg-gray-900 rounded-lg p-2">
                        <span class="text-white">\${bid.full_name || bid.username}</span>
                        <span class="text-gradient font-bold">\${bid.bid_amount} ETH</span>
                      </div>
                    \`).join('')}
                  </div>
                </div>
              \` : ''}
            \`;
            
            // ìµœì†Œ ì…ì°°ê°€ ì„¤ì •
            document.getElementById('bidAmount').min = parseFloat(auction.current_price) + 0.001;
            document.getElementById('bidAmount').value = (parseFloat(auction.current_price) + 0.01).toFixed(3);
            
            document.getElementById('biddingForm').classList.remove('hidden');
          } else {
            document.getElementById('auctionInfo').innerHTML = \`
              <div class="text-center py-8">
                <i class="fas fa-gavel text-4xl text-gray-600 mb-3"></i>
                <div class="text-gray-400">ì§„í–‰ ì¤‘ì¸ ê²½ë§¤ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                <div class="text-sm text-gray-500 mt-2">íŒë§¤ìê°€ ê²½ë§¤ë¥¼ ì‹œì‘í•˜ë©´ ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
              </div>
            \`;
          }
        } catch (error) {
          console.error('Auction fetch error:', error);
          document.getElementById('auctionInfo').innerHTML = \`
            <div class="text-center py-8 text-red-400">
              <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
              <div>ê²½ë§¤ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
          \`;
        }
      }
      
      function closeBiddingModal() {
        document.getElementById('biddingModal').classList.add('hidden');
        document.getElementById('biddingForm').reset();
        document.getElementById('biddingForm').classList.add('hidden');
      }
      
      function handleLike(artworkId) {
        alert('ì¢‹ì•„ìš” ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
      }
      
      // êµ¬ë§¤ ì œì•ˆ ì œì¶œ
      document.getElementById('purchaseForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const sessionToken = localStorage.getItem('session_token');
        if (!sessionToken) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          window.location.href = '/login';
          return;
        }
        
        const offerPrice = document.getElementById('offerPrice').value;
        const message = document.getElementById('purchaseMessage').value;
        
        if (!offerPrice || offerPrice <= 0) {
          alert('ì˜¬ë°”ë¥¸ ì œì•ˆ ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš”.');
          return;
        }
        
        try {
          const response = await axios.post('/api/artworks/' + ARTWORK_ID + '/purchase', {
            offer_price: parseFloat(offerPrice),
            message: message
          }, {
            headers: {
              'Authorization': 'Bearer ' + sessionToken
            }
          });
          
          if (response.data.success) {
            alert('êµ¬ë§¤ ì œì•ˆì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!\\níŒë§¤ìì˜ ì‘ë‹µì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
            closePurchaseModal();
          } else {
            alert('êµ¬ë§¤ ì œì•ˆ ì‹¤íŒ¨: ' + response.data.message);
          }
        } catch (error) {
          console.error('Purchase offer error:', error);
          alert('êµ¬ë§¤ ì œì•ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error.response?.data?.message || error.message));
        }
      });
      
      // ê²½ë§¤ ì…ì°° ì œì¶œ
      document.getElementById('biddingForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const sessionToken = localStorage.getItem('session_token');
        if (!sessionToken) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          window.location.href = '/login';
          return;
        }
        
        const bidAmount = document.getElementById('bidAmount').value;
        
        if (!bidAmount || bidAmount <= 0) {
          alert('ì˜¬ë°”ë¥¸ ì…ì°° ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');
          return;
        }
        
        try {
          // ë¨¼ì € ê²½ë§¤ IDë¥¼ ê°€ì ¸ì™€ì•¼ í•¨
          const auctionResponse = await axios.get('/api/artworks/' + ARTWORK_ID + '/auction');
          
          if (!auctionResponse.data.success || !auctionResponse.data.data) {
            alert('ê²½ë§¤ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          
          const auctionId = auctionResponse.data.data.id;
          
          const response = await axios.post('/api/auctions/' + auctionId + '/bid', {
            bid_amount: parseFloat(bidAmount)
          }, {
            headers: {
              'Authorization': 'Bearer ' + sessionToken
            }
          });
          
          if (response.data.success) {
            alert('ì…ì°°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\\ní˜„ì¬ ìµœê³  ì…ì°°ìì…ë‹ˆë‹¤.');
            closeBiddingModal();
            location.reload();
          } else {
            alert('ì…ì°° ì‹¤íŒ¨: ' + response.data.message);
          }
        } catch (error) {
          console.error('Bidding error:', error);
          alert('ì…ì°° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error.response?.data?.message || error.message));
        }
      });
      
      // Purchase Modal
      function openPurchaseModal() {
        const modal = document.createElement('div');
        modal.id = 'purchaseModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4';
        modal.innerHTML = \`
          <div class="bg-gray-900 rounded-2xl p-8 max-w-md w-full border border-white/10 animate-slide-in">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-2xl font-bold text-white">êµ¬ë§¤ ì œì•ˆ</h3>
              <button onclick="closePurchaseModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-2xl"></i>
              </button>
            </div>
            
            <div class="mb-6">
              <label class="block text-gray-300 mb-2">ì œì•ˆ ê°€ê²© (ETH)</label>
              <input 
                type="number" 
                id="offerPrice" 
                step="0.01" 
                min="0"
                value="${art.current_price || 0}"
                class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-purple-500 focus:outline-none"
              >
              <p class="text-xs text-gray-500 mt-1">í˜„ì¬ê°€: ${formatPrice(art.current_price || 0)}</p>
            </div>
            
            <div class="mb-6">
              <label class="block text-gray-300 mb-2">ë©”ì‹œì§€ (ì„ íƒ)</label>
              <textarea 
                id="offerMessage" 
                rows="3"
                placeholder="íŒë§¤ìì—ê²Œ ì „ë‹¬í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-purple-500 focus:outline-none resize-none"
              ></textarea>
            </div>
            
            <div class="flex gap-3">
              <button 
                onclick="submitPurchaseOffer()"
                class="flex-1 py-3 bg-gradient-to-r from-green-600 to-emerald-500 hover:from-green-700 hover:to-emerald-600 text-white font-bold rounded-xl transition-all"
              >
                ì œì•ˆ ì œì¶œ
              </button>
              <button 
                onclick="closePurchaseModal()"
                class="px-6 py-3 bg-gray-800 hover:bg-gray-700 text-white font-bold rounded-xl transition-colors"
              >
                ì·¨ì†Œ
              </button>
            </div>
          </div>
        \`;
        document.body.appendChild(modal);
      }
      
      function closePurchaseModal() {
        const modal = document.getElementById('purchaseModal');
        if (modal) modal.remove();
      }
      
      async function submitPurchaseOffer() {
        const token = localStorage.getItem('auth_token');
        if (!token) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
          window.location.href = '/login';
          return;
        }
        
        const offerPrice = document.getElementById('offerPrice').value;
        const message = document.getElementById('offerMessage').value;
        
        if (!offerPrice || parseFloat(offerPrice) <= 0) {
          alert('ìœ íš¨í•œ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
          return;
        }
        
        try {
          const response = await axios.post('/api/artworks/${art.id}/purchase', {
            offer_price: parseFloat(offerPrice),
            message: message,
            payment_method: 'eth'
          }, {
            headers: { 'Authorization': \`Bearer \${token}\` }
          });
          
          if (response.data.success) {
            alert('âœ… êµ¬ë§¤ ì œì•ˆì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\níŒë§¤ìê°€ ì œì•ˆì„ ê²€í†  í›„ ì—°ë½ë“œë¦½ë‹ˆë‹¤.');
            closePurchaseModal();
          } else {
            alert('âŒ ' + response.data.message);
          }
        } catch (error) {
          console.error('Purchase error:', error);
          alert('êµ¬ë§¤ ì œì•ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error.response?.data?.message || error.message));
        }
      }
      
      // Favorite Toggle
      async function toggleFavorite() {
        const token = localStorage.getItem('auth_token');
        if (!token) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
          window.location.href = '/login';
          return;
        }
        
        const btn = document.getElementById('favoriteBtn');
        const icon = btn.querySelector('i');
        const artworkId = window.location.pathname.split('/')[2];
        
        // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
        btn.disabled = true;
        
        try {
          const isCurrentlyFavorited = icon.classList.contains('fas');
          
          // API í˜¸ì¶œ
          const response = await axios.post(\`/api/artworks/\${artworkId}/favorite\`, {}, {
            headers: { 'Authorization': \`Bearer \${token}\` }
          });
          
          if (response.data.success) {
            // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
            icon.classList.add('animate-ping');
            setTimeout(() => icon.classList.remove('animate-ping'), 300);
            
            if (response.data.is_favorited) {
              // ì¦ê²¨ì°¾ê¸° ì¶”ê°€
              icon.classList.remove('far');
              icon.classList.add('fas', 'text-red-500');
              btn.classList.add('text-red-500');
              
              // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ (ê°„ë‹¨í•˜ê²Œ alert ëŒ€ì‹ )
              showToast('âœ¨ ê´€ì‹¬ì‘í’ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } else {
              // ì¦ê²¨ì°¾ê¸° ì œê±°
              icon.classList.remove('fas', 'text-red-500');
              icon.classList.add('far');
              btn.classList.remove('text-red-500');
              
              showToast('ê´€ì‹¬ì‘í’ˆì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
            }
          } else {
            alert('ì˜¤ë¥˜: ' + response.data.message);
          }
        } catch (error) {
          console.error('ì¦ê²¨ì°¾ê¸° í† ê¸€ ì‹¤íŒ¨:', error);
          alert('ì¦ê²¨ì°¾ê¸° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        } finally {
          btn.disabled = false;
        }
      }
      
      // ê°„ë‹¨í•œ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í•¨ìˆ˜
      function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = \`fixed bottom-8 right-8 px-6 py-4 rounded-xl shadow-2xl z-50 animate-slide-up \${
          type === 'success' ? 'bg-green-600' : 'bg-blue-600'
        }\`;
        toast.innerHTML = \`
          <p class="text-white font-semibold">\${message}</p>
        \`;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateY(20px)';
          setTimeout(() => toast.remove(), 300);
        }, 2000);
      }
      
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦ê²¨ì°¾ê¸° ìƒíƒœ í™•ì¸
      async function checkFavoriteStatus() {
        const token = localStorage.getItem('auth_token');
        if (!token) return;
        
        const artworkId = window.location.pathname.split('/')[2];
        
        try {
          const response = await axios.get(\`/api/artworks/\${artworkId}/favorite-status\`, {
            headers: { 'Authorization': \`Bearer \${token}\` }
          });
          
          if (response.data.is_favorited) {
            const btn = document.getElementById('favoriteBtn');
            const icon = btn.querySelector('i');
            icon.classList.remove('far');
            icon.classList.add('fas', 'text-red-500');
            btn.classList.add('text-red-500');
          }
        } catch (error) {
          console.error('ì¦ê²¨ì°¾ê¸° ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
        }
      }
      
      checkFavoriteStatus();
      
      // Load AI Price Prediction UI
      const script = document.createElement('script');
      script.src = '/static/price-prediction-ui.js';
      document.body.appendChild(script);
    </script>
    `;
    
    return c.html(getLayout(content, `${art.title} - GALLERYPIA`))
  } catch (error: any) {
    console.error('Artwork detail error:', error)
    return c.html(getLayout(`<div class="py-20 text-center text-red-500">ì‘í’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br/><small>${error.message || String(error)}</small></div>`))
  }
})

// ì „ë¬¸ê°€ í‰ê°€ í˜ì´ì§€
app.get('/evaluate/:id', async (c) => {
  try {
    const id = c.req.param('id')
    const db = c.env.DB
    
    // Get artwork details
    const artwork = await db.prepare(`
      SELECT a.*, ar.name as artist_name, ar.profile_image as artist_profile_image
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.id = ?
    `).bind(id).first()
    
    if (!artwork) {
      return c.html(getLayout('<div class="py-20 text-center text-red-500">ì‘í’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>'))
    }
    
    const content = `
    <section class="py-16">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- í—¤ë” -->
            <div class="mb-12">
                <a href="/artwork/${id}" class="inline-flex items-center text-gray-400 hover:text-white mb-6 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i> ì‘í’ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </a>
                
                <div class="text-center">
                    <div class="inline-block mb-6 px-6 py-2 bg-gradient-to-r from-purple-600/20 to-cyan-600/20 backdrop-blur-sm rounded-full border border-purple-500/30">
                        <span class="text-gradient font-bold text-sm"><i class="fas fa-user-tie mr-2"></i>ì „ë¬¸ê°€ í‰ê°€</span>
                    </div>
                    <h1 class="text-5xl font-black mb-4">
                        <span class="text-white">ì‘í’ˆ í‰ê°€ ì œì¶œ</span>
                    </h1>
                    <p class="text-gray-400 text-lg">ì „ë¬¸ê°€ì˜ ì¢…í•©ì ì¸ í‰ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                </div>
            </div>
            
            <!-- ì‘í’ˆ ì •ë³´ ì¹´ë“œ -->
            <div class="card-nft rounded-2xl p-6 mb-8 bg-gradient-to-br from-gray-900/50 to-black/50 border border-white/10">
                <div class="flex items-center gap-6">
                    <img src="${artwork.image_url}" alt="${artwork.title}" class="w-32 h-32 rounded-xl object-cover" onerror="this.onerror=null; this.src='https://via.placeholder.com/128/1a1a1a/8b5cf6?text=${encodeURIComponent(artwork.title.charAt(0))}'">
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold text-white mb-2">${artwork.title}</h2>
                        <div class="flex items-center gap-3 text-sm text-gray-400">
                            <span><i class="fas fa-palette mr-2 text-purple-400"></i>${artwork.artist_name}</span>
                            <span>â€¢</span>
                            <span><i class="fas fa-tag mr-2 text-cyan-400"></i>${artwork.category}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- í‰ê°€ í¼ -->
            <form id="evaluationForm" class="space-y-8">
                <!-- ëª¨ë“ˆ 1: ì‘ê°€ ì—…ì  í‰ê°€ -->
                <div class="card-nft rounded-2xl p-8 bg-gradient-to-br from-purple-900/20 to-pink-900/10 border border-purple-500/30">
                    <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                        <span class="w-10 h-10 bg-gradient-to-br from-purple-600 to-cyan-500 rounded-xl flex items-center justify-center mr-3">
                            <i class="fas fa-trophy text-white"></i>
                        </span>
                        ëª¨ë“ˆ 1: ì‘ê°€ ì—…ì  í‰ê°€
                        <span class="ml-auto text-sm text-gray-400">0-100ì </span>
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-300 mb-2">ì‘ê°€ ê²½ë ¥ ë° í™œë™ í‰ê°€</label>
                            <input type="number" id="artistScore" min="0" max="100" required class="w-full px-4 py-3 bg-gray-800/80 border border-gray-700 rounded-xl text-white focus:border-purple-500 focus:outline-none">
                            <p class="text-xs text-gray-500 mt-1">ê°œì¸ì „, ë‹¨ì²´ì „, ìˆ˜ìƒê²½ë ¥, ìµœê·¼ í™œë™ ë“±ì„ ì¢…í•© í‰ê°€</p>
                        </div>
                    </div>
                </div>
                
                <!-- ëª¨ë“ˆ 2: ì‘í’ˆ ë‚´ìš© í‰ê°€ -->
                <div class="card-nft rounded-2xl p-8 bg-gradient-to-br from-cyan-900/20 to-blue-900/10 border border-cyan-500/30">
                    <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                        <span class="w-10 h-10 bg-gradient-to-br from-cyan-600 to-blue-500 rounded-xl flex items-center justify-center mr-3">
                            <i class="fas fa-palette text-white"></i>
                        </span>
                        ëª¨ë“ˆ 2: ì‘í’ˆ ë‚´ìš© í‰ê°€
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-300 mb-2">ë‚´ìš©ì„± (ì£¼ì œì˜ì‹, ë©”ì‹œì§€)</label>
                            <input type="number" id="contentDepth" min="0" max="100" required class="w-full px-4 py-3 bg-gray-800/80 border border-gray-700 rounded-xl text-white focus:border-cyan-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-gray-300 mb-2">í‘œí˜„ì„± (ê¸°ë²•, ì‹œê°ì™„ì„±ë„)</label>
                            <input type="number" id="expression" min="0" max="100" required class="w-full px-4 py-3 bg-gray-800/80 border border-gray-700 rounded-xl text-white focus:border-cyan-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-gray-300 mb-2">ë…ì°½ì„± (ì°¨ë³„ì„±, í˜ì‹ ì„±)</label>
                            <input type="number" id="originality" min="0" max="100" required class="w-full px-4 py-3 bg-gray-800/80 border border-gray-700 rounded-xl text-white focus:border-cyan-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-gray-300 mb-2">ì†Œì¥ê°€ì¹˜ (ì‹œëŒ€ì ì˜ë¯¸, ë¯¸ë˜ì „ë§)</label>
                            <input type="number" id="collectionValue" min="0" max="100" required class="w-full px-4 py-3 bg-gray-800/80 border border-gray-700 rounded-xl text-white focus:border-cyan-500 focus:outline-none">
                        </div>
                    </div>
                </div>
                
                <!-- ëª¨ë“ˆ 3: ì¸ì¦ì„± í‰ê°€ -->
                <div class="card-nft rounded-2xl p-8 bg-gradient-to-br from-amber-900/20 to-orange-900/10 border border-amber-500/30">
                    <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                        <span class="w-10 h-10 bg-gradient-to-br from-amber-600 to-orange-500 rounded-xl flex items-center justify-center mr-3">
                            <i class="fas fa-certificate text-white"></i>
                        </span>
                        ëª¨ë“ˆ 3: ì¸ì¦ì„± í‰ê°€
                    </h3>
                    <div>
                        <label class="block text-gray-300 mb-2">ì‘í’ˆ ì§„ìœ„ì„± ë° ì¶œì²˜ í™•ì¸</label>
                        <input type="number" id="certification" min="0" max="100" required class="w-full px-4 py-3 bg-gray-800/80 border border-gray-700 rounded-xl text-white focus:border-amber-500 focus:outline-none">
                        <p class="text-xs text-gray-500 mt-1">ì‘ê°€ ì„œëª…, ì—ë””ì…˜ ë„˜ë²„, ì¶œì²˜ ì¦ëª…, ì†Œìœ ê¶Œ ì´ë ¥ ë“±</p>
                    </div>
                </div>
                
                <!-- ëª¨ë“ˆ 4: ì‹œì¥ì„± í‰ê°€ -->
                <div class="card-nft rounded-2xl p-8 bg-gradient-to-br from-green-900/20 to-emerald-900/10 border border-green-500/30">
                    <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                        <span class="w-10 h-10 bg-gradient-to-br from-green-600 to-emerald-500 rounded-xl flex items-center justify-center mr-3">
                            <i class="fas fa-chart-line text-white"></i>
                        </span>
                        ëª¨ë“ˆ 4: ì‹œì¥ì„± í‰ê°€
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-300 mb-2">ìˆ˜ìš” ì˜ˆì¸¡</label>
                            <input type="number" id="marketDemand" min="0" max="100" required class="w-full px-4 py-3 bg-gray-800/80 border border-gray-700 rounded-xl text-white focus:border-green-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-gray-300 mb-2">í¬ì†Œì„±</label>
                            <input type="number" id="rarity" min="0" max="100" required class="w-full px-4 py-3 bg-gray-800/80 border border-gray-700 rounded-xl text-white focus:border-green-500 focus:outline-none">
                        </div>
                    </div>
                </div>
                
                <!-- ëª¨ë“ˆ 5: ëŒ€ì¤‘ì„± í‰ê°€ -->
                <div class="card-nft rounded-2xl p-8 bg-gradient-to-br from-pink-900/20 to-rose-900/10 border border-pink-500/30">
                    <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                        <span class="w-10 h-10 bg-gradient-to-br from-pink-600 to-rose-500 rounded-xl flex items-center justify-center mr-3">
                            <i class="fas fa-users text-white"></i>
                        </span>
                        ëª¨ë“ˆ 5: ëŒ€ì¤‘ì„± í‰ê°€
                    </h3>
                    <div>
                        <label class="block text-gray-300 mb-2">ëŒ€ì¤‘ í˜¸ì‘ë„ ë° ì ‘ê·¼ì„±</label>
                        <input type="number" id="popularity" min="0" max="100" required class="w-full px-4 py-3 bg-gray-800/80 border border-gray-700 rounded-xl text-white focus:border-pink-500 focus:outline-none">
                        <p class="text-xs text-gray-500 mt-1">ì¼ë°˜ ëŒ€ì¤‘ì˜ ì´í•´ë„, ê°ìƒ ìš©ì´ì„±, SNS ë°˜ì‘ ë“±</p>
                    </div>
                </div>
                
                <!-- ì¢…í•© ì˜ê²¬ -->
                <div class="card-nft rounded-2xl p-8">
                    <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                        <i class="fas fa-comment-alt text-purple-400 mr-3"></i>
                        ì „ë¬¸ê°€ ì¢…í•© ì˜ê²¬
                    </h3>
                    <textarea id="expertComment" rows="6" required class="w-full px-4 py-3 bg-gray-800/80 border border-gray-700 rounded-xl text-white focus:border-purple-500 focus:outline-none resize-none" placeholder="ì‘í’ˆì— ëŒ€í•œ ì „ë¬¸ê°€ì˜ ì¢…í•©ì ì¸ ì˜ê²¬ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
                </div>
                
                <!-- ì œì¶œ ë²„íŠ¼ -->
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 py-4 bg-gradient-to-r from-purple-600 to-cyan-500 hover:from-purple-700 hover:to-cyan-600 text-white font-bold text-lg rounded-xl transition-all hover:scale-105 shadow-lg">
                        <i class="fas fa-check-circle mr-2"></i>í‰ê°€ ì œì¶œ
                    </button>
                    <a href="/artwork/${id}" class="px-8 py-4 bg-gray-800 hover:bg-gray-700 text-white font-bold rounded-xl transition-colors flex items-center">
                        ì·¨ì†Œ
                    </a>
                </div>
            </form>
        </div>
    </section>
    
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
      document.getElementById('evaluationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const token = localStorage.getItem('auth_token');
        if (!token) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
          window.location.href = '/login';
          return;
        }
        
        const data = {
          artist_achievement_score: parseInt(document.getElementById('artistScore').value),
          content_depth_score: parseInt(document.getElementById('contentDepth').value),
          expression_score: parseInt(document.getElementById('expression').value),
          originality_innovation_score: parseInt(document.getElementById('originality').value),
          collection_value_score: parseInt(document.getElementById('collectionValue').value),
          certification_score: parseInt(document.getElementById('certification').value),
          market_demand_score: parseInt(document.getElementById('marketDemand').value),
          rarity_score: parseInt(document.getElementById('rarity').value),
          popularity_score: parseInt(document.getElementById('popularity').value),
          expert_comment: document.getElementById('expertComment').value
        };
        
        // ì ìˆ˜ ê²€ì¦
        const scores = Object.values(data).filter(v => typeof v === 'number');
        if (scores.some(s => s < 0 || s > 100)) {
          alert('ì ìˆ˜ëŠ” 0-100 ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”');
          return;
        }
        
        try {
          const response = await axios.post('/api/artworks/${id}/evaluate', data, {
            headers: {
              'Authorization': \`Bearer \${token}\`,
              'Content-Type': 'application/json'
            }
          });
          
          alert('âœ… í‰ê°€ê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!');
          window.location.href = '/artwork/${id}';
        } catch (error) {
          console.error(error);
          alert('âŒ í‰ê°€ ì œì¶œ ì‹¤íŒ¨: ' + (error.response?.data?.error || 'ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”'));
        }
      });
    </script>
    `;
    
    return c.html(getLayout(content, `ì „ë¬¸ê°€ í‰ê°€ - ${artwork.title} - GALLERYPIA`))
  } catch (error: any) {
    console.error('Evaluation page error:', error)
    return c.html(getLayout(`<div class="py-20 text-center text-red-500">í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br/><small>${error.message || String(error)}</small></div>`))
  }
})

// ê°€ì¹˜ì‚°ì • í˜ì´ì§€
// ê°€ì¹˜ì‚°ì • í˜ì´ì§€ - 5ê°œ ëª¨ë“ˆ ì‹œìŠ¤í…œ (ì‘í’ˆ ì´ë¯¸ì§€ + ì „ë¬¸ê°€ í‰ê°€ í¬í•¨)
app.get('/valuation', async (c) => {
  const content = `
  <section class="py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-12">
              <h1 class="text-6xl font-black mb-4">
                  <span class="text-gradient">NFT ê°€ì¹˜í‰ê°€</span> <span class="text-white">ì‹œìŠ¤í…œ</span>
              </h1>
              <p class="text-gray-400 text-lg">ì‘í’ˆë¶„ì„ + AIí‰ê°€ + ì „ë¬¸ê°€ ê²€ì¦</p>
              <p class="text-gray-500 text-sm mt-2">NFT ë¯¸ìˆ í’ˆ í‰ê· ê°€ê²© (1 ETH, OpenSea 2022 í†µê³„ê°’ ê¸°ì¤€)</p>
              
              <!-- ì…€í”„ í‰ê°€ ì•ˆë‚´ -->
              <div class="mt-6 bg-gradient-to-r from-cyan-500/10 to-purple-500/10 border border-cyan-500/30 rounded-2xl p-6 max-w-4xl mx-auto">
                  <div class="flex items-start gap-4">
                      <div class="flex-shrink-0">
                          <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-purple-600 rounded-xl flex items-center justify-center">
                              <i class="fas fa-user-edit text-white text-xl"></i>
                          </div>
                      </div>
                      <div class="flex-1">
                          <h3 class="text-xl font-bold text-white mb-2">
                              <i class="fas fa-sparkles text-cyan-400 mr-2"></i>
                              ì…€í”„ ê°€ì¹˜í‰ê°€ ì‹œìŠ¤í…œ
                          </h3>
                          <p class="text-gray-300 mb-3">
                              ì‘ê°€ ë³¸ì¸ì´ ì§ì ‘ ì‘í’ˆì˜ ê°€ì¹˜ë¥¼ í‰ê°€í•˜ê³  NFTë¡œ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                          </p>
                          <ul class="space-y-2 text-sm text-gray-400">
                              <li class="flex items-center">
                                  <i class="fas fa-check-circle text-green-400 mr-2"></i>
                                  <span>5ê°œ ëª¨ë“ˆ í‰ê°€ í•­ëª©ì„ ì§ì ‘ ì…ë ¥í•˜ì—¬ ê°ê´€ì  ê°€ì¹˜ ì‚°ì •</span>
                              </li>
                              <li class="flex items-center">
                                  <i class="fas fa-check-circle text-green-400 mr-2"></i>
                                  <span>ì „ë¬¸ê°€ ê²€ì¦ ì „ ì˜ˆìƒ ê°€ê²© í™•ì¸ ê°€ëŠ¥</span>
                              </li>
                              <li class="flex items-center">
                                  <i class="fas fa-check-circle text-green-400 mr-2"></i>
                                  <span>í‰ê°€ ì™„ë£Œ í›„ ì¦‰ì‹œ NFT ë¯¼íŒ… ë° ë“±ë¡ ê°€ëŠ¥</span>
                              </li>
                              <li class="flex items-center">
                                  <i class="fas fa-coins text-amber-400 mr-2"></i>
                                  <span class="text-amber-300">ì „ë¬¸ê°€ í‰ê°€ë¥¼ ë°›ìœ¼ë©´ ë³´ìƒê¸ˆ (0.01-0.1 ETH) ì œê³µ</span>
                              </li>
                          </ul>
                      </div>
                  </div>
              </div>
          </div>

          <!-- ì‘í’ˆ ì´ë¯¸ì§€ ì„¹ì…˜ -->
          <div class="grid lg:grid-cols-5 gap-8 mb-8">
              <!-- ì‘í’ˆ ì´ë¯¸ì§€ (ì™¼ìª½ 2ì»¬ëŸ¼) -->
              <div class="lg:col-span-2">
                  <div class="card-nft rounded-3xl overflow-hidden sticky top-24">
                      <div class="aspect-square bg-gray-900 overflow-hidden relative group">
                          <img src="https://picsum.photos/seed/art1/800/800" 
                               alt="Cyber Dreamscape #001" 
                               class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                               loading="lazy">
                          <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-60"></div>
                          <div class="absolute bottom-0 left-0 right-0 p-6">
                              <h3 class="text-2xl font-bold text-white mb-2">Cyber Dreamscape #001</h3>
                              <p class="text-gray-300 text-sm mb-3">ë””ì§€í„¸ì•„íŠ¸ â€¢ 2024</p>
                              <div class="flex items-center">
                                  <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=artist1" 
                                       class="w-8 h-8 rounded-full mr-2 border border-white border-opacity-30"
                                       loading="lazy">
                                  <span class="text-sm text-gray-300">ê¹€ë¯¼ì¤€</span>
                              </div>
                          </div>
                      </div>
                      
                      <!-- ìµœì¢… ì‚°ì •ê°€ (ì‘í’ˆ ì´ë¯¸ì§€ ì•„ë˜) -->
                      <div class="p-6 bg-gradient-to-br from-purple-900/30 to-cyan-900/30">
                          <div class="text-center">
                              <div class="text-sm text-gray-400 mb-2">AI ì‚°ì • ê°€ì¹˜</div>
                              <div class="text-4xl font-black text-gradient mb-2" id="estimatedValueKRW">1.0000 ETH (â‚©3,000,000)</div>
                              <div class="text-sm text-gray-500 mb-4">ìµœì¢… ì ìˆ˜: <span id="finalScore" class="text-white font-bold">50.0</span>/100</div>
                              <div class="grid grid-cols-2 gap-2 text-xs">
                                  <div class="bg-black/30 rounded-lg p-2">
                                      <div class="text-gray-400">ì‘ê°€ ì—…ì </div>
                                      <div class="text-white font-bold" id="module1Score">50</div>
                                  </div>
                                  <div class="bg-black/30 rounded-lg p-2">
                                      <div class="text-gray-400">ì‘í’ˆ ë‚´ìš©</div>
                                      <div class="text-white font-bold" id="module2Score">50</div>
                                  </div>
                                  <div class="bg-black/30 rounded-lg p-2">
                                      <div class="text-gray-400">ì¸ì¦</div>
                                      <div class="text-white font-bold" id="module3Score">40</div>
                                  </div>
                                  <div class="bg-black/30 rounded-lg p-2">
                                      <div class="text-gray-400">ì „ë¬¸ê°€</div>
                                      <div class="text-white font-bold" id="module4Score">50</div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- í‰ê°€ ì‹œìŠ¤í…œ (ì˜¤ë¥¸ìª½ 3ì»¬ëŸ¼) -->
              <div class="lg:col-span-3 space-y-6">

          <div class="grid lg:grid-cols-2 gap-8">
              
              <!-- ì¢Œì¸¡: ëª¨ë“ˆ 1, 2, 3 -->
              <div class="space-y-6">
                  
                  <!-- ëª¨ë“ˆ 1: ì‘ê°€ ì—…ì  í‰ê°€ -->
                  <div class="card-nft rounded-2xl p-6">
                      <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                          <span class="w-8 h-8 bg-gradient-to-br from-purple-600 to-cyan-500 rounded-lg flex items-center justify-center mr-3 text-sm">â‘ </span>
                          ì‘ê°€ ì—…ì  í‰ê°€
                          <span class="ml-auto text-sm text-gray-400">í”„ë¦¬ë¯¸ì—„(Î±â‚)</span>
                      </h3>
                      <div class="space-y-3">
                          <div class="grid grid-cols-2 gap-3">
                              <div>
                                  <label class="text-xs text-gray-400 block mb-1">ê°œì¸ì „ íšŸìˆ˜</label>
                                  <input type="number" id="soloExhibitions" value="3" min="0" class="w-full px-3 py-2 bg-black border border-white border-opacity-10 rounded text-white" onchange="updateNumberInput('soloExhibitions')">
                              </div>
                              <div>
                                  <label class="text-xs text-gray-400 block mb-1">ë‹¨ì²´ì „ íšŸìˆ˜</label>
                                  <input type="number" id="groupExhibitions" value="5" min="0" class="w-full px-3 py-2 bg-black border border-white border-opacity-10 rounded text-white" onchange="updateNumberInput('groupExhibitions')">
                              </div>
                              <div>
                                  <label class="text-xs text-gray-400 block mb-1">ê³µëª¨ì „ ìˆ˜ìƒ</label>
                                  <input type="number" id="competitionAwards" value="1" min="0" class="w-full px-3 py-2 bg-black border border-white border-opacity-10 rounded text-white" onchange="updateNumberInput('competitionAwards')">
                              </div>
                              <div>
                                  <label class="text-xs text-gray-400 block mb-1">ìµœê·¼ ì „ì‹œ ì—°ë„</label>
                                  <input type="number" id="latestExhibitionYear" value="2024" min="2000" max="2025" class="w-full px-3 py-2 bg-black border border-white border-opacity-10 rounded text-white" onchange="updateNumberInput('latestExhibitionYear')">
                              </div>
                          </div>
                          <div class="flex justify-between items-center pt-2">
                              <span class="text-sm text-gray-400">ëª¨ë“ˆ ì ìˆ˜:</span>
                              <span id="module1Score" class="text-2xl font-bold text-gradient">50</span>
                          </div>
                          <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                              <div id="bar1" class="h-full bg-gradient-to-r from-purple-500 to-cyan-500" style="width: 50%"></div>
                          </div>
                          <div class="mt-3">
                              <div class="flex justify-between mb-1">
                                  <span class="text-xs text-gray-400">ê°€ì¤‘ì¹˜ (Î±â‚):</span>
                                  <span id="weightArtistDisplay" class="text-xs font-bold text-white">25%</span>
                              </div>
                              <input type="range" id="weightArtist" min="0" max="100" value="25" class="w-full" oninput="updateWeightSlider('Artist', 'weightArtistDisplay')">
                          </div>
                      </div>
                  </div>

                  <!-- ëª¨ë“ˆ 2: ì‘í’ˆ ë‚´ìš© í‰ê°€ -->
                  <div class="card-nft rounded-2xl p-6">
                      <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                          <span class="w-8 h-8 bg-gradient-to-br from-purple-600 to-cyan-500 rounded-lg flex items-center justify-center mr-3 text-sm">â‘¡</span>
                          ì‘í’ˆ ë‚´ìš© í‰ê°€
                      </h3>
                      <div class="space-y-4">
                          <div>
                              <div class="flex justify-between mb-1">
                                  <span class="text-sm text-gray-300">ë‚´ìš©ì„± (ì£¼ì œì˜ì‹, ë©”ì‹œì§€)</span>
                                  <span id="contentDepthDisplay" class="text-sm font-bold">50</span>
                              </div>
                              <input type="range" id="contentDepth" min="0" max="100" value="50" class="w-full" oninput="updateSliderValue('contentDepth', 'contentDepthDisplay')">
                          </div>
                          <div>
                              <div class="flex justify-between mb-1">
                                  <span class="text-sm text-gray-300">í‘œí˜„ì„± (ê¸°ë²•, ì‹œê°ì™„ì„±ë„)</span>
                                  <span id="expressionDisplay" class="text-sm font-bold">50</span>
                              </div>
                              <input type="range" id="expression" min="0" max="100" value="50" class="w-full" oninput="updateSliderValue('expression', 'expressionDisplay')">
                          </div>
                          <div>
                              <div class="flex justify-between mb-1">
                                  <span class="text-sm text-gray-300">ë…ì°½ì„± (ì°¨ë³„ì„±, í˜ì‹ ì„±)</span>
                                  <span id="originalityDisplay" class="text-sm font-bold">50</span>
                              </div>
                              <input type="range" id="originality" min="0" max="100" value="50" class="w-full" oninput="updateSliderValue('originality', 'originalityDisplay')">
                          </div>
                          <div>
                              <div class="flex justify-between mb-1">
                                  <span class="text-sm text-gray-300">ì†Œì¥ê°€ì¹˜ (ì‹œëŒ€ì ì˜ë¯¸, ë¯¸ë˜ì „ë§)</span>
                                  <span id="collectionValueDisplay" class="text-sm font-bold">50</span>
                              </div>
                              <input type="range" id="collectionValue" min="0" max="100" value="50" class="w-full" oninput="updateSliderValue('collectionValue', 'collectionValueDisplay')">
                          </div>
                          <div class="flex justify-between items-center pt-2 border-t border-white border-opacity-10">
                              <span class="text-sm text-gray-400">ëª¨ë“ˆ ì ìˆ˜:</span>
                              <span id="module2Score" class="text-2xl font-bold text-gradient">50</span>
                          </div>
                          <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                              <div id="bar2" class="h-full bg-gradient-to-r from-yellow-500 to-orange-500" style="width: 50%"></div>
                          </div>
                          <div class="mt-3">
                              <div class="flex justify-between mb-1">
                                  <span class="text-xs text-gray-400">ê°€ì¤‘ì¹˜ (Î±â‚‚):</span>
                                  <span id="weightArtworkDisplay" class="text-xs font-bold text-white">30%</span>
                              </div>
                              <input type="range" id="weightArtwork" min="0" max="100" value="30" class="w-full" oninput="updateWeightSlider('Artwork', 'weightArtworkDisplay')">
                          </div>
                      </div>
                  </div>

                  <!-- ëª¨ë“ˆ 3: ì¸ì¦ -->
                  <div class="card-nft rounded-2xl p-6">
                      <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                          <span class="w-8 h-8 bg-gradient-to-br from-purple-600 to-cyan-500 rounded-lg flex items-center justify-center mr-3 text-sm">â‘¢</span>
                          ì €ì‘ê¶Œ/ì†Œìœ ê¶Œ ì¸ì¦
                      </h3>
                      <div class="space-y-3">
                          <label class="flex items-center">
                              <input type="checkbox" id="hasBlockchainHash" checked class="mr-3" onchange="updateCheckbox('hasBlockchainHash')">
                              <span class="text-sm text-gray-300">ë¸”ë¡ì²´ì¸ ì›ë³¸ í•´ì‹œ ë“±ë¡ (+40ì )</span>
                          </label>
                          <label class="flex items-center">
                              <input type="checkbox" id="hasCopyright" class="mr-3" onchange="updateCheckbox('hasCopyright')">
                              <span class="text-sm text-gray-300">ì €ì‘ê¶Œ ë“±ë¡ë²ˆí˜¸ ë³´ìœ  (+40ì )</span>
                          </label>
                          <label class="flex items-center">
                              <input type="checkbox" id="hasLicense" class="mr-3" onchange="updateCheckbox('hasLicense')">
                              <span class="text-sm text-gray-300">ë¼ì´ì„ ìŠ¤ ë²”ìœ„ ëª…ì‹œ (+20ì )</span>
                          </label>
                          <div class="flex justify-between items-center pt-2 border-t border-white border-opacity-10">
                              <span class="text-sm text-gray-400">ëª¨ë“ˆ ì ìˆ˜:</span>
                              <span id="module3Score" class="text-2xl font-bold text-gradient">40</span>
                          </div>
                          <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                              <div id="bar3" class="h-full bg-gradient-to-r from-green-500 to-emerald-500" style="width: 40%"></div>
                          </div>
                          <div class="mt-3">
                              <div class="flex justify-between mb-1">
                                  <span class="text-xs text-gray-400">ê°€ì¤‘ì¹˜ (Î±â‚ƒ):</span>
                                  <span id="weightCertificationDisplay" class="text-xs font-bold text-white">15%</span>
                              </div>
                              <input type="range" id="weightCertification" min="0" max="100" value="15" class="w-full" oninput="updateWeightSlider('Certification', 'weightCertificationDisplay')">
                          </div>
                      </div>
                  </div>

              </div>

              <!-- ìš°ì¸¡: ëª¨ë“ˆ 4, 5 ë° ê²°ê³¼ -->
              <div class="space-y-6">
                  
                  <!-- ëª¨ë“ˆ 4: ì „ë¬¸ê°€ í‰ê°€ -->
                  <div class="card-nft rounded-2xl p-6">
                      <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                          <span class="w-8 h-8 bg-gradient-to-br from-purple-600 to-cyan-500 rounded-lg flex items-center justify-center mr-3 text-sm">â‘£</span>
                          ì „ë¬¸ê°€ ì •ì„± í‰ê°€
                      </h3>
                      <div class="space-y-4">
                          <p class="text-sm text-gray-400 mb-3">í•™ì˜ˆì‚¬, ë””ë ‰í„°, ë¹„í‰ê°€, ì „ê³µì ë“±ì˜ í‰ê°€ ì¢…í•©</p>
                          
                          <!-- í‘œí˜„ê¸°ë²• ì™„ì„±ë„ -->
                          <div>
                              <div class="flex justify-between mb-1">
                                  <span class="text-sm text-gray-300">í‘œí˜„ê¸°ë²• ì™„ì„±ë„</span>
                                  <span id="techniqueMasteryDisplay" class="text-sm font-bold">50</span>
                              </div>
                              <input type="range" id="techniqueMastery" min="0" max="100" value="50" class="w-full" oninput="updateSliderValue('techniqueMastery', 'techniqueMasteryDisplay')">
                          </div>
                          
                          <!-- ì˜ˆìˆ , ë¬¸í™”, ì‚¬íšŒì  ê°€ì¹˜ ì˜ë¯¸ -->
                          <div>
                              <div class="flex justify-between mb-1">
                                  <span class="text-sm text-gray-300">ì˜ˆìˆ , ë¬¸í™”, ì‚¬íšŒì  ê°€ì¹˜ ì˜ë¯¸</span>
                                  <span id="artHistoricalSignificanceDisplay" class="text-sm font-bold">50</span>
                              </div>
                              <input type="range" id="artHistoricalSignificance" min="0" max="100" value="50" class="w-full" oninput="updateSliderValue('artHistoricalSignificance', 'artHistoricalSignificanceDisplay')">
                          </div>
                          
                          <!-- ì‹œì¥ì„± -->
                          <div>
                              <div class="flex justify-between mb-1">
                                  <span class="text-sm text-gray-300">ì‹œì¥ì„±</span>
                                  <span id="marketabilityDisplay" class="text-sm font-bold">50</span>
                              </div>
                              <input type="range" id="marketability" min="0" max="100" value="50" class="w-full" oninput="updateSliderValue('marketability', 'marketabilityDisplay')">
                          </div>
                          
                          <!-- ë°œì „ ë° í™•ì¥ ê°€ëŠ¥ì„± -->
                          <div>
                              <div class="flex justify-between mb-1">
                                  <span class="text-sm text-gray-300">ë°œì „ ë° í™•ì¥ ê°€ëŠ¥ì„±</span>
                                  <span id="developmentPotentialDisplay" class="text-sm font-bold">50</span>
                              </div>
                              <input type="range" id="developmentPotential" min="0" max="100" value="50" class="w-full" oninput="updateSliderValue('developmentPotential', 'developmentPotentialDisplay')">
                          </div>
                          
                          <div class="flex justify-between items-center pt-2 border-t border-white border-opacity-10">
                              <span class="text-sm text-gray-400">ëª¨ë“ˆ ì ìˆ˜ (í‰ê· ):</span>
                              <span id="module4Score" class="text-2xl font-bold text-gradient">50</span>
                          </div>
                          <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                              <div id="bar4" class="h-full bg-gradient-to-r from-pink-500 to-rose-500" style="width: 50%"></div>
                          </div>
                          <div class="mt-3">
                              <div class="flex justify-between mb-1">
                                  <span class="text-xs text-gray-400">ê°€ì¤‘ì¹˜ (Î±â‚„):</span>
                                  <span id="weightExpertDisplay" class="text-xs font-bold text-white">20%</span>
                              </div>
                              <input type="range" id="weightExpert" min="0" max="100" value="20" class="w-full" oninput="updateWeightSlider('Expert', 'weightExpertDisplay')">
                          </div>
                      </div>
                  </div>

                  <!-- ëª¨ë“ˆ 5: ì¸ê¸°ë„ -->
                  <div class="card-nft rounded-2xl p-6">
                      <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                          <span class="w-8 h-8 bg-gradient-to-br from-purple-600 to-cyan-500 rounded-lg flex items-center justify-center mr-3 text-sm">â‘¤</span>
                          ëŒ€ì¤‘ ì¸ì§€ë„/ì¸ê¸°ë„
                      </h3>
                      <div class="space-y-3">
                          <div class="grid grid-cols-2 gap-3">
                              <div>
                                  <label class="text-xs text-gray-400 block mb-1">YouTube ì¡°íšŒìˆ˜</label>
                                  <input type="number" id="youtubeViews" value="10000" min="0" class="w-full px-3 py-2 bg-black border border-white border-opacity-10 rounded text-white text-sm" onchange="updateNumberInput('youtubeViews')">
                              </div>
                              <div>
                                  <label class="text-xs text-gray-400 block mb-1">Instagram ë°˜ì‘</label>
                                  <input type="number" id="instagramEngagement" value="1000" min="0" class="w-full px-3 py-2 bg-black border border-white border-opacity-10 rounded text-white text-sm" onchange="updateNumberInput('instagramEngagement')">
                              </div>
                              <div>
                                  <label class="text-xs text-gray-400 block mb-1">í”Œë«í¼ í™œë™</label>
                                  <input type="number" id="platformActivity" value="100" min="0" class="w-full px-3 py-2 bg-black border border-white border-opacity-10 rounded text-white text-sm" onchange="updateNumberInput('platformActivity')">
                              </div>
                              <div>
                                  <label class="text-xs text-gray-400 block mb-1">ì–¸ë¡  ë³´ë„</label>
                                  <input type="number" id="mediaCoverage" value="2" min="0" class="w-full px-3 py-2 bg-black border border-white border-opacity-10 rounded text-white text-sm" onchange="updateNumberInput('mediaCoverage')">
                              </div>
                          </div>
                          <div>
                              <div class="flex justify-between mb-1">
                                  <span class="text-sm text-gray-300">Google Trends</span>
                                  <span id="googleTrendsDisplay" class="text-sm font-bold">50</span>
                              </div>
                              <input type="range" id="googleTrends" min="0" max="100" value="50" class="w-full" oninput="updateSliderValue('googleTrends', 'googleTrendsDisplay')">
                          </div>
                          <div class="flex justify-between items-center pt-2 border-t border-white border-opacity-10">
                              <span class="text-sm text-gray-400">ëª¨ë“ˆ ì ìˆ˜:</span>
                              <span id="module5Score" class="text-2xl font-bold text-gradient">50</span>
                          </div>
                          <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                              <div id="bar5" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500" style="width: 50%"></div>
                          </div>
                          <div class="mt-3">
                              <div class="flex justify-between mb-1">
                                  <span class="text-xs text-gray-400">ê°€ì¤‘ì¹˜ (Î±â‚…):</span>
                                  <span id="weightPopularityDisplay" class="text-xs font-bold text-white">10%</span>
                              </div>
                              <input type="range" id="weightPopularity" min="0" max="100" value="10" class="w-full" oninput="updateWeightSlider('Popularity', 'weightPopularityDisplay')">
                          </div>
                      </div>
                  </div>

                  <!-- ê°€ì¤‘ì¹˜ í•©ê³„ -->
                  <div class="card-nft rounded-2xl p-6 border-2 border-yellow-500 border-opacity-30">
                      <div class="flex items-center justify-between">
                          <div>
                              <div class="text-sm text-gray-400 mb-1">ê°€ì¤‘ì¹˜ í•©ê³„ (Î£Î±)</div>
                              <div class="text-xs text-gray-500">Î±â‚ + Î±â‚‚ + Î±â‚ƒ + Î±â‚„ + Î±â‚… = 1.0</div>
                          </div>
                          <div class="text-3xl font-black" id="weightSum">1.00</div>
                      </div>
                  </div>

              </div>
          </div>

          <!-- ì „ë¬¸ê°€ í‰ê°€ ë° ì½”ë©˜íŠ¸ ì„¹ì…˜ -->
          <div class="mt-12">
              <h2 class="text-3xl font-black mb-6">
                  <span class="text-gradient">ì „ë¬¸ê°€ í‰ê°€</span> <span class="text-white">& ì½”ë©˜íŠ¸(ì˜ˆì‹œ)</span>
              </h2>
              
              <div class="grid md:grid-cols-3 gap-6">
                  <!-- íë ˆì´í„° í‰ê°€ -->
                  <div class="card-nft rounded-2xl p-6">
                      <div class="flex items-center mb-4">
                          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center mr-3">
                              <i class="fas fa-palette text-white"></i>
                          </div>
                          <div>
                              <h4 class="text-lg font-bold text-white">íë ˆì´í„°</h4>
                              <p class="text-xs text-gray-400">Museum Curator</p>
                          </div>
                      </div>
                      <div class="mb-4">
                          <div class="flex justify-between mb-2">
                              <span class="text-sm text-gray-400">í‰ê°€ ì ìˆ˜</span>
                              <span class="text-lg font-bold text-gradient">88/100</span>
                          </div>
                          <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                              <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500" style="width: 88%"></div>
                          </div>
                      </div>
                      <p class="text-sm text-gray-300 leading-relaxed">
                          "ì‘í’ˆì˜ êµ¬ì„±ê³¼ ìƒ‰ì±„ í™œìš©ì´ ë§¤ìš° ë›°ì–´ë‚˜ë©°, í˜„ëŒ€ ë¯¸ìˆ ì˜ ìƒˆë¡œìš´ ê°€ëŠ¥ì„±ì„ ì œì‹œí•©ë‹ˆë‹¤. 
                          íŠ¹íˆ ë””ì§€í„¸ ë§¤ì²´ë¥¼ í™œìš©í•œ í‘œí˜„ ê¸°ë²•ì´ ë‹ë³´ì…ë‹ˆë‹¤."
                      </p>
                      <div class="mt-4 pt-4 border-t border-white border-opacity-10 text-xs text-gray-500">
                          <i class="fas fa-calendar mr-1"></i> 2024-01-15
                      </div>
                  </div>

                  <!-- ë”œëŸ¬ í‰ê°€ -->
                  <div class="card-nft rounded-2xl p-6">
                      <div class="flex items-center mb-4">
                          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-cyan-600 to-blue-600 flex items-center justify-center mr-3">
                              <i class="fas fa-chart-line text-white"></i>
                          </div>
                          <div>
                              <h4 class="text-lg font-bold text-white">ì•„íŠ¸ë”œëŸ¬</h4>
                              <p class="text-xs text-gray-400">Art Dealer</p>
                          </div>
                      </div>
                      <div class="mb-4">
                          <div class="flex justify-between mb-2">
                              <span class="text-sm text-gray-400">í‰ê°€ ì ìˆ˜</span>
                              <span class="text-lg font-bold text-gradient">92/100</span>
                          </div>
                          <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                              <div class="h-full bg-gradient-to-r from-cyan-500 to-blue-500" style="width: 92%"></div>
                          </div>
                      </div>
                      <p class="text-sm text-gray-300 leading-relaxed">
                          "ì‹œì¥ì„±ì´ ë§¤ìš° ë†’ìœ¼ë©°, ì»¬ë ‰í„°ë“¤ì˜ ê´€ì‹¬ë„ê°€ ë›°ì–´ë‚  ê²ƒìœ¼ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤. 
                          ì‘ê°€ì˜ ë…ì°½ì ì¸ ì‹œê°ê³¼ ì™„ì„±ë„ ë†’ì€ ê¸°ë²•ì´ íˆ¬ì ê°€ì¹˜ë¥¼ ë†’ì…ë‹ˆë‹¤."
                      </p>
                      <div class="mt-4 pt-4 border-t border-white border-opacity-10 text-xs text-gray-500">
                          <i class="fas fa-calendar mr-1"></i> 2024-01-16
                      </div>
                  </div>

                  <!-- ì „ë¬¸ê°€ í‰ê°€ -->
                  <div class="card-nft rounded-2xl p-6">
                      <div class="flex items-center mb-4">
                          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-orange-600 to-red-600 flex items-center justify-center mr-3">
                              <i class="fas fa-award text-white"></i>
                          </div>
                          <div>
                              <h4 class="text-lg font-bold text-white">ë¯¸ìˆ  ì „ë¬¸ê°€</h4>
                              <p class="text-xs text-gray-400">Art Expert</p>
                          </div>
                      </div>
                      <div class="mb-4">
                          <div class="flex justify-between mb-2">
                              <span class="text-sm text-gray-400">í‰ê°€ ì ìˆ˜</span>
                              <span class="text-lg font-bold text-gradient">85/100</span>
                          </div>
                          <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                              <div class="h-full bg-gradient-to-r from-orange-500 to-red-500" style="width: 85%"></div>
                          </div>
                      </div>
                      <p class="text-sm text-gray-300 leading-relaxed">
                          "ì˜ˆìˆ ì‚¬ì  ê´€ì ì—ì„œ ë³¼ ë•Œ, ì „í†µê³¼ í˜„ëŒ€ë¥¼ ì¡°í™”ë¡­ê²Œ ìœµí•©í•œ ì‘í’ˆì…ë‹ˆë‹¤. 
                          ì‘ê°€ì˜ ì² í•™ê³¼ ë©”ì‹œì§€ê°€ ëª…í™•í•˜ê²Œ ì „ë‹¬ë˜ë©°, ë°œì „ ê°€ëŠ¥ì„±ì´ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤."
                      </p>
                      <div class="mt-4 pt-4 border-t border-white border-opacity-10 text-xs text-gray-500">
                          <i class="fas fa-calendar mr-1"></i> 2024-01-17
                      </div>
                  </div>
              </div>
          </div>

          <!-- ì €ì¥ ë²„íŠ¼ -->
          <div class="mt-12 text-center">
              <button onclick="alert('í‰ê°€ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!')" class="px-12 py-4 bg-gradient-to-r from-purple-600 to-cyan-500 text-white font-bold text-lg rounded-2xl hover:scale-105 transition-transform">
                  <i class="fas fa-save mr-2"></i>
                  í‰ê°€ ê²°ê³¼ ì €ì¥
              </button>
          </div>
      </div>
  </section>
  
  <script src="/static/valuation-complete.js"></script>
  `;
  
  return c.html(getLayout(content, 'NFT ê°€ì¹˜í‰ê°€ ì‹œìŠ¤í…œ - GALLERYPIA'))
})

// ë¡œê·¸ì¸ í˜ì´ì§€

// NFT ë¯¼íŒ… - ìŠ¹ì¸ëœ ì‘í’ˆ ëª©ë¡ í˜ì´ì§€
app.get('/mint', (c) => {
  const content = `
  <section class="py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-12">
              <h1 class="text-6xl font-black mb-4">
                  <span class="text-gradient">NFT</span> <span class="text-white">ë¯¼íŒ…</span>
              </h1>
              <p class="text-gray-400 text-lg mb-6">ê°€ì¹˜í‰ê°€ê°€ ì™„ë£Œëœ ì‘í’ˆì„ NFTë¡œ ë°œí–‰í•˜ì„¸ìš”</p>
              <a href="/mint-upload" class="inline-flex items-center px-8 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 text-white font-semibold rounded-xl hover:shadow-lg hover:shadow-purple-500/50 transition">
                  <i class="fas fa-upload mr-2"></i>
                  ìƒˆ ì‘í’ˆ ì—…ë¡œë“œ
              </a>
          </div>
          
          <div id="mintContent" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
              <p class="text-gray-400 text-center col-span-full">ë¡œë”© ì¤‘...</p>
          </div>
      </div>
  </section>
  
  <script>
    async function loadMintableArtworks() {
      try {
        const response = await axios.get('/api/artworks?status=approved&limit=20');
        const artworks = response.data.data || [];
        
        const content = document.getElementById('mintContent');
        if (artworks.length === 0) {
          content.innerHTML = '<p class="text-gray-400 text-center col-span-full">ë¯¼íŒ… ê°€ëŠ¥í•œ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        content.innerHTML = artworks.map(artwork => \`
          <div class="card-nft rounded-3xl overflow-hidden">
              <div class="relative aspect-square bg-gray-900 overflow-hidden">
                  <img src="\${artwork.image_url}" alt="\${artwork.title}" class="w-full h-full object-cover img-nft" loading="lazy">
                  \${artwork.is_minted ? \`
                  <div class="absolute top-4 left-4">
                      <span class="px-3 py-1.5 bg-green-600 text-white text-xs font-bold rounded-full flex items-center">
                          <i class="fas fa-check-circle mr-1.5"></i>ë¯¼íŒ… ì™„ë£Œ
                      </span>
                  </div>
                  \` : \`
                  <div class="absolute top-4 left-4">
                      <span class="px-3 py-1.5 bg-yellow-600 text-white text-xs font-bold rounded-full flex items-center">
                          <i class="fas fa-clock mr-1.5"></i>ë¯¼íŒ… ê°€ëŠ¥
                      </span>
                  </div>
                  \`}
              </div>
              <div class="p-6">
                  <h3 class="font-bold text-xl text-white mb-3">\${artwork.title}</h3>
                  <div class="flex items-center mb-4">
                      <img src="\${artwork.artist_profile_image}" class="w-8 h-8 rounded-full mr-2 object-cover border border-white border-opacity-20" loading="lazy">
                      <span class="text-sm text-gray-400 font-medium">\${artwork.artist_name}</span>
                  </div>
                  
                  <div class="bg-white bg-opacity-5 rounded-xl p-4 mb-4">
                      <div class="text-xs text-gray-500 mb-2">AI ì‚°ì •ê°€</div>
                      <div class="font-black text-lg text-gradient mb-3">\${formatPrice(artwork.estimated_value)}</div>
                  </div>
                  
                  \${!artwork.is_minted ? \`
                  <button onclick="mintNFT(\${artwork.id}, '\${artwork.title}', \${artwork.estimated_value})" class="w-full btn-neon px-4 py-3 rounded-xl text-white font-bold text-sm">
                      <i class="fas fa-hammer mr-2"></i>
                      NFT ë¯¼íŒ…í•˜ê¸°
                  </button>
                  \` : \`
                  <a href="/artwork/\${artwork.id}" class="block w-full text-center px-4 py-3 rounded-xl bg-white bg-opacity-5 text-white font-bold text-sm hover:bg-opacity-10 transition-all neon-border">
                      <i class="fas fa-eye mr-2"></i>
                      ìƒì„¸ë³´ê¸°
                  </a>
                  \`}
              </div>
          </div>
        \`).join('');
      } catch (error) {
        document.getElementById('mintContent').innerHTML = '<p class="text-red-500 text-center col-span-full">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }
    
    function formatPrice(priceKRW) {
      const ETH_PRICE_KRW = 3000000; // 1 ETH = 3,000,000ì›
      const priceETH = (priceKRW / ETH_PRICE_KRW).toFixed(4);
      const formattedKRW = priceKRW.toLocaleString();
      return \`\${priceETH} ETH (â‚©\${formattedKRW})\`;
    }
    
    async function mintNFT(artworkId, title, price) {
      if (!currentAccount) {
        alert('ë¨¼ì € ë©”íƒ€ë§ˆìŠ¤í¬ ì§€ê°‘ì„ ì—°ê²°í•´ì£¼ì„¸ìš”.');
        await connectMetaMask();
        return;
      }
      
      try {
        const confirm = window.confirm(\`"\${title}"ì„(ë¥¼) NFTë¡œ ë¯¼íŒ…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nì‚°ì •ê°€: \${formatPrice(price)}\\nê°€ìŠ¤ë¹„ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\`);
        if (!confirm) return;
        
        alert('NFT ë¯¼íŒ…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
        
        const response = await axios.post('/api/mint-nft', {
          artwork_id: artworkId,
          wallet_address: currentAccount,
          price: price
        });
        
        if (response.data.success) {
          alert('NFT ë¯¼íŒ…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
          location.reload();
        }
      } catch (error) {
        console.error('ë¯¼íŒ… ì‹¤íŒ¨:', error);
        alert('NFT ë¯¼íŒ…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }
    
    document.addEventListener('DOMContentLoaded', loadMintableArtworks);
  </script>
  `;
  
  return c.html(getLayout(content, 'NFT ë¯¼íŒ… - GALLERYPIA'))
})

// NFT ë¯¼íŒ… - ì‘í’ˆ ì—…ë¡œë“œ í˜ì´ì§€
app.get('/mint-upload', (c) => {
  const content = `
  <section class="py-16">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="mb-8">
              <h1 class="text-4xl font-bold mb-2">
                  <span class="text-gradient">NFT ì‘í’ˆ ì—…ë¡œë“œ</span>
              </h1>
              <p class="text-gray-400">ì‘í’ˆì„ ì—…ë¡œë“œí•˜ê³  NFTë¡œ ë°œí–‰í•˜ì„¸ìš”</p>
          </div>

          <form id="mintForm" class="card-nft rounded-3xl p-8 space-y-6">
              <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
              <div>
                  <label class="block text-lg font-semibold mb-4 text-white">ì‘í’ˆ ì´ë¯¸ì§€ *</label>
                  <div id="uploadArea" class="upload-area rounded-2xl p-8 text-center cursor-pointer border-2 border-dashed border-purple-500/50 hover:border-purple-500 transition">
                      <input type="file" id="artworkImage" accept="image/*" class="hidden">
                      <div id="uploadPlaceholder">
                          <i class="fas fa-cloud-upload-alt text-6xl text-primary-500 mb-4"></i>
                          <p class="text-gray-300 text-lg font-medium mb-2">ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                          <p class="text-gray-500 text-sm">PNG, JPG, GIF (ìµœëŒ€ 10MB)</p>
                      </div>
                      <div id="imagePreview" class="hidden">
                          <img id="previewImg" class="max-h-96 mx-auto rounded-xl">
                          <button type="button" onclick="removeImage()" class="mt-4 px-4 py-2 bg-red-500 hover:bg-red-600 rounded-xl text-sm">
                              <i class="fas fa-times mr-2"></i>ì´ë¯¸ì§€ ì œê±°
                          </button>
                      </div>
                  </div>
              </div>

              <!-- ê¸°ë³¸ ì •ë³´ -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div class="md:col-span-2">
                      <label class="block text-sm font-medium mb-2 text-white">ì‘í’ˆëª… *</label>
                      <input type="text" id="title" required
                             class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                  </div>

                  <div class="md:col-span-2">
                      <label class="block text-sm font-medium mb-2 text-white">ì‘í’ˆ ì„¤ëª…</label>
                      <textarea id="description" rows="4"
                                class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white resize-none focus:border-primary-500 focus:outline-none"></textarea>
                  </div>

                  <div>
                      <label class="block text-sm font-medium mb-2 text-white">ì¹´í…Œê³ ë¦¬ *</label>
                      <select id="category" required
                              class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                          <option value="íšŒí™”">íšŒí™”</option>
                          <option value="ì¡°ê°">ì¡°ê°</option>
                          <option value="ë””ì§€í„¸ì•„íŠ¸">ë””ì§€í„¸ì•„íŠ¸</option>
                          <option value="ì‚¬ì§„">ì‚¬ì§„</option>
                          <option value="ì„¤ì¹˜ë¯¸ìˆ ">ì„¤ì¹˜ë¯¸ìˆ </option>
                          <option value="ë¯¸ë””ì–´ì•„íŠ¸">ë¯¸ë””ì–´ì•„íŠ¸</option>
                          <option value="ê³µì˜ˆ">ê³µì˜ˆ</option>
                          <option value="ë””ìì¸">ë””ìì¸</option>
                      </select>
                  </div>

                  <div>
                      <label class="block text-sm font-medium mb-2 text-white">ê¸°ë²•</label>
                      <input type="text" id="technique"
                             class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none"
                             placeholder="ì˜ˆ: ìœ í™”, ìˆ˜ì±„í™”, Digital Art">
                  </div>

                  <div class="grid grid-cols-3 gap-3">
                      <div>
                          <label class="block text-sm font-medium mb-2 text-white">ê°€ë¡œ (cm)</label>
                          <input type="number" id="width"
                                 class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                      </div>
                      <div>
                          <label class="block text-sm font-medium mb-2 text-white">ì„¸ë¡œ (cm)</label>
                          <input type="number" id="height"
                                 class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                      </div>
                      <div>
                          <label class="block text-sm font-medium mb-2 text-white">ê¹Šì´ (cm)</label>
                          <input type="number" id="depth"
                                 class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                      </div>
                  </div>

                  <div>
                      <label class="block text-sm font-medium mb-2 text-white">ì œì‘ ì—°ë„</label>
                      <input type="number" id="year" min="1900" max="2025"
                             class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                  </div>

                  <div>
                      <label class="block text-sm font-medium mb-2 text-white">ê°€ê²© (ETH)</label>
                      <input type="number" id="priceEth" step="0.01" onchange="convertEthToKrw()"
                             class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none"
                             placeholder="0.00">
                  </div>
              </div>

              <!-- ê°€ê²© í‘œì‹œ -->
              <div id="priceDisplay" class="hidden card-nft rounded-xl p-4">
                  <div class="flex items-center justify-between">
                      <div>
                          <p class="text-gray-400 text-sm mb-1">íŒë§¤ ê°€ê²©</p>
                          <p class="text-2xl font-bold text-gradient"><span id="displayEth">0.00</span> ETH</p>
                      </div>
                      <div class="text-right">
                          <p class="text-gray-400 text-sm mb-1">ì›í™” í™˜ì‚°</p>
                          <p class="text-xl font-semibold text-gray-300">â‚©<span id="displayKrw">0</span></p>
                      </div>
                  </div>
              </div>

              <!-- ì €ì‘ê¶Œ ì •ë³´ -->
              <div class="space-y-4">
                  <h3 class="text-lg font-semibold text-white">ì €ì‘ê¶Œ ì •ë³´ (ì„ íƒ)</h3>
                  
                  <div>
                      <label class="block text-sm font-medium mb-2 text-white">ì €ì‘ê¶Œ ë“±ë¡ë²ˆí˜¸</label>
                      <input type="text" id="copyrightReg"
                             class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                  </div>

                  <div>
                      <label class="block text-sm font-medium mb-2 text-white">ë¼ì´ì„ ìŠ¤ ìœ í˜•</label>
                      <select id="licenseType"
                              class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                          <option value="exclusive">ë…ì  ë¼ì´ì„ ìŠ¤</option>
                          <option value="non-exclusive">ë¹„ë…ì  ë¼ì´ì„ ìŠ¤</option>
                          <option value="creative_commons">í¬ë¦¬ì—ì´í‹°ë¸Œ ì»¤ë¨¼ì¦ˆ</option>
                      </select>
                  </div>
              </div>

              <!-- ì „ì‹œíšŒ ì •ë³´ (ì„ íƒ) -->
              <div class="space-y-4">
                  <h3 class="text-lg font-semibold text-white flex items-center">
                      <i class="fas fa-building mr-2 text-purple-400"></i>
                      ì „ì‹œíšŒ ì •ë³´ (ì„ íƒ)
                  </h3>
                  <p class="text-sm text-gray-400">ì‘í’ˆì´ ì „ì‹œëœ ê²½ë ¥ì´ ìˆë‹¤ë©´ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                  
                  <div>
                      <label class="block text-sm font-medium mb-2 text-white">ì „ì‹œíšŒ ëª…ì¹­</label>
                      <input type="text" id="exhibitionName"
                             class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none"
                             placeholder="ì˜ˆ: 2024 ì„œìš¸ êµ­ì œ ì•„íŠ¸í˜ì–´">
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                          <label class="block text-sm font-medium mb-2 text-white">ì „ì‹œíšŒ ì‹œì‘ì¼</label>
                          <input type="date" id="exhibitionStartDate"
                                 class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                      </div>
                      <div>
                          <label class="block text-sm font-medium mb-2 text-white">ì „ì‹œíšŒ ì¢…ë£Œì¼</label>
                          <input type="date" id="exhibitionEndDate"
                                 class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none">
                      </div>
                  </div>
              </div>

              <!-- ì‘í’ˆ ê°€ì¹˜ ì„¤ëª… (ì„ íƒ) -->
              <div class="space-y-4">
                  <h3 class="text-lg font-semibold text-white flex items-center">
                      <i class="fas fa-gem mr-2 text-cyan-400"></i>
                      ì‘í’ˆ ê°€ì¹˜ ì„¤ëª… (ì„ íƒ)
                  </h3>
                  <p class="text-sm text-gray-400">ì‘í’ˆì˜ ë…ì°½ì„±ê³¼ ì†Œì¥ ê°€ì¹˜ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”</p>
                  
                  <div>
                      <label class="block text-sm font-medium mb-2 text-white">ë…ì°½ì„± ì„¤ëª…</label>
                      <textarea id="originalityDescription" rows="3"
                                class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white resize-none focus:border-primary-500 focus:outline-none"
                                placeholder="ì´ ì‘í’ˆë§Œì˜ ë…íŠ¹í•œ ì , ì˜ˆìˆ ì  ì ‘ê·¼ ë°©ì‹, ì°½ì‘ ê³¼ì •ì˜ íŠ¹ë³„í•¨ ë“±ì„ ì„¤ëª…í•´ì£¼ì„¸ìš”"></textarea>
                  </div>

                  <div>
                      <label class="block text-sm font-medium mb-2 text-white">ì†Œì¥ê°€ì¹˜ ì„¤ëª…</label>
                      <textarea id="collectionValueDescription" rows="3"
                                class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white resize-none focus:border-primary-500 focus:outline-none"
                                placeholder="ì™œ ì´ ì‘í’ˆì´ ìˆ˜ì§‘í•  ê°€ì¹˜ê°€ ìˆëŠ”ì§€, íˆ¬ì ê°€ì¹˜, í¬ì†Œì„± ë“±ì„ ì„¤ëª…í•´ì£¼ì„¸ìš”"></textarea>
                  </div>
              </div>

              <!-- ì™¸ë¶€ ë§í¬ (ì„ íƒ) -->
              <div class="space-y-4">
                  <h3 class="text-lg font-semibold text-white flex items-center">
                      <i class="fas fa-link mr-2 text-green-400"></i>
                      ì™¸ë¶€ ë§í¬ (ì„ íƒ)
                  </h3>
                  <p class="text-sm text-gray-400">ì‘í’ˆ ê´€ë ¨ ì™¸ë¶€ ë§í¬ë¥¼ ì¶”ê°€í•˜ì—¬ ì‹ ë¢°ë„ë¥¼ ë†’ì´ì„¸ìš”</p>
                  
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                          <label class="block text-sm font-medium mb-2 text-white flex items-center">
                              <i class="fab fa-youtube text-red-500 mr-2"></i>
                              YouTube URL
                          </label>
                          <input type="url" id="youtubeUrl"
                                 class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none"
                                 placeholder="https://www.youtube.com/watch?v=...">
                      </div>

                      <div>
                          <label class="block text-sm font-medium mb-2 text-white flex items-center">
                              <i class="fab fa-instagram text-pink-500 mr-2"></i>
                              Instagram URL
                          </label>
                          <input type="url" id="instagramUrl"
                                 class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none"
                                 placeholder="https://www.instagram.com/p/...">
                      </div>

                      <div>
                          <label class="block text-sm font-medium mb-2 text-white flex items-center">
                              <i class="fas fa-store text-blue-400 mr-2"></i>
                              NFT í”Œë«í¼ URL
                          </label>
                          <input type="url" id="nftPlatformUrl"
                                 class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none"
                                 placeholder="https://opensea.io/assets/...">
                      </div>

                      <div>
                          <label class="block text-sm font-medium mb-2 text-white flex items-center">
                              <i class="fas fa-newspaper text-amber-400 mr-2"></i>
                              ë³´ë„ìë£Œ URL
                          </label>
                          <input type="url" id="pressReleaseUrl"
                                 class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-primary-500 focus:outline-none"
                                 placeholder="https://...">
                      </div>
                  </div>
              </div>

              <!-- ì œì¶œ ë²„íŠ¼ -->
              <div class="flex gap-4">
                  <button type="button" onclick="window.history.back()"
                          class="flex-1 py-4 bg-gray-800 hover:bg-gray-700 text-white rounded-xl transition">
                          <i class="fas fa-arrow-left mr-2"></i>ì·¨ì†Œ
                  </button>
                  <button type="submit"
                          class="flex-1 py-4 bg-gradient-to-r from-purple-600 to-cyan-500 hover:shadow-lg hover:shadow-purple-500/50 text-white font-semibold rounded-xl transition">
                          <i class="fas fa-rocket mr-2"></i>NFT ë¯¼íŒ…í•˜ê¸°
                  </button>
              </div>
          </form>
      </div>
  </section>

  <style>
    .upload-area {
      transition: all 0.3s ease;
    }
    .upload-area:hover {
      background: rgba(139, 92, 246, 0.05);
    }
    .upload-area.dragover {
      border-color: #8b5cf6;
      background: rgba(139, 92, 246, 0.1);
    }
  </style>

  <script>
    const ETH_TO_KRW = 3000000; // 1 ETH = 3,000,000 KRW

    // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('previewImg').src = e.target.result;
          document.getElementById('uploadPlaceholder').classList.add('hidden');
          document.getElementById('imagePreview').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    }

    function removeImage() {
      document.getElementById('artworkImage').value = '';
      document.getElementById('uploadPlaceholder').classList.remove('hidden');
      document.getElementById('imagePreview').classList.add('hidden');
    }

    // Drag & Drop
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('artworkImage');
    
    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleImageUpload);
    
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        fileInput.files = e.dataTransfer.files;
        handleImageUpload({ target: { files: [file] } });
      }
    });

    // ETH to KRW ë³€í™˜
    function convertEthToKrw() {
      const eth = parseFloat(document.getElementById('priceEth').value) || 0;
      const krw = Math.round(eth * ETH_TO_KRW);
      
      document.getElementById('displayEth').textContent = eth.toFixed(2);
      document.getElementById('displayKrw').textContent = krw.toLocaleString();
      document.getElementById('priceDisplay').classList.toggle('hidden', eth === 0);
    }

    // í¼ ì œì¶œ
    document.getElementById('mintForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Get session token
      const sessionToken = localStorage.getItem('session_token');
      if (!sessionToken) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = '/login';
        return;
      }
      
      const formData = {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        category: document.getElementById('category').value,
        technique: document.getElementById('technique').value,
        size_width: parseInt(document.getElementById('width').value) || null,
        size_height: parseInt(document.getElementById('height').value) || null,
        size_depth: parseInt(document.getElementById('depth').value) || null,
        creation_year: parseInt(document.getElementById('year').value) || null,
        price_eth: parseFloat(document.getElementById('priceEth').value) || null,
        image_url: document.getElementById('previewImg').src || 'https://via.placeholder.com/800',
        copyright_registration: document.getElementById('copyrightReg').value,
        license_type: document.getElementById('licenseType').value,
        // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œë“¤ (v6.0)
        exhibition_name: document.getElementById('exhibitionName').value || null,
        exhibition_start_date: document.getElementById('exhibitionStartDate').value || null,
        exhibition_end_date: document.getElementById('exhibitionEndDate').value || null,
        originality_description: document.getElementById('originalityDescription').value || null,
        collection_value_description: document.getElementById('collectionValueDescription').value || null,
        youtube_url: document.getElementById('youtubeUrl').value || null,
        instagram_url: document.getElementById('instagramUrl').value || null,
        nft_platform_url: document.getElementById('nftPlatformUrl').value || null,
        press_release_url: document.getElementById('pressReleaseUrl').value || null
      };

      try {
        const response = await axios.post('/api/submissions/create', formData, {
          headers: {
            'Authorization': 'Bearer ' + sessionToken,
            'Content-Type': 'application/json'
          }
        });
        const data = response.data;
        
        if (data.success) {
          alert('ì‘í’ˆì´ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\nê´€ë¦¬ì ìŠ¹ì¸ í›„ ê°¤ëŸ¬ë¦¬ì— í‘œì‹œë©ë‹ˆë‹¤.');
          window.location.href = '/mypage';
        } else {
          alert('ì œì¶œ ì‹¤íŒ¨: ' + data.message);
        }
      } catch (error) {
        console.error('Submit error:', error);
        alert('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error.response?.data?.message || error.message));
      }
    });
  </script>
  `;
  
  return c.html(getLayout(content, 'NFT ì‘í’ˆ ì—…ë¡œë“œ - GALLERYPIA'))
})

// Mypage - ê°œì¸í™” ëŒ€ì‹œë³´ë“œ
app.get('/mypage', (c) => {
  const content = `
  <section class="py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <!-- ë¡œê·¸ì¸ ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ -->
          <script>
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ í™•ì¸
            (function() {
              const sessionToken = localStorage.getItem('session_token');
              if (!sessionToken) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ í˜ì´ì§€ì…ë‹ˆë‹¤.');
                window.location.href = '/login';
                return;
              }
              
              // ì„¸ì…˜ ê²€ì¦
              fetch('/api/auth/me', {
                headers: {
                  'Authorization': 'Bearer ' + sessionToken
                }
              })
              .then(res => res.json())
              .then(data => {
                if (!data.success) {
                  alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                  localStorage.removeItem('session_token');
                  window.location.href = '/login';
                }
              })
              .catch(err => {
                console.error('ì„¸ì…˜ ê²€ì¦ ì‹¤íŒ¨:', err);
                window.location.href = '/login';
              });
            })();
          </script>
          
          <!-- í—¤ë” -->
          <div class="flex justify-between items-center mb-12">
              <div>
                  <h1 class="text-5xl font-black mb-2">
                      <span class="text-gradient">ë§ˆì´</span> <span class="text-white">í˜ì´ì§€</span>
                  </h1>
                  <p class="text-gray-400">ë‚´ ì‘í’ˆê³¼ í™œë™ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
              </div>
              <a href="/mint-upload" class="flex items-center px-6 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 text-white font-semibold rounded-xl hover:shadow-lg hover:shadow-purple-500/50 transition">
                  <i class="fas fa-plus-circle mr-2"></i>
                  ìƒˆ ì‘í’ˆ ì—…ë¡œë“œ
              </a>
          </div>

          <!-- ì•„í‹°ìŠ¤íŠ¸ ë­í¬ ì¹´ë“œ -->
          <div id="artist-rank-card" class="mb-8">
              <div class="text-center py-8 text-gray-400">
                  <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                  <p>ë­í¬ ì •ë³´ ë¡œë”© ì¤‘...</p>
              </div>
          </div>

          <!-- í†µê³„ ì¹´ë“œ ê·¸ë¦¬ë“œ -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
              <!-- ì´ ì‘í’ˆ ìˆ˜ -->
              <div class="card-nft rounded-2xl p-6 relative overflow-hidden">
                  <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-purple-600/20 to-transparent rounded-full -mr-16 -mt-16"></div>
                  <div class="relative z-10">
                      <div class="flex items-center justify-between mb-4">
                          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-600 to-purple-800 flex items-center justify-center">
                              <i class="fas fa-images text-white text-xl"></i>
                          </div>
                          <span class="text-xs text-green-400 flex items-center">
                              <i class="fas fa-arrow-up mr-1"></i>12%
                          </span>
                      </div>
                      <div class="text-3xl font-black text-white mb-1">24</div>
                      <div class="text-sm text-gray-400">ì´ ì‘í’ˆ ìˆ˜</div>
                  </div>
              </div>

              <!-- ë¯¼íŒ… ì™„ë£Œ -->
              <div class="card-nft rounded-2xl p-6 relative overflow-hidden">
                  <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-cyan-600/20 to-transparent rounded-full -mr-16 -mt-16"></div>
                  <div class="relative z-10">
                      <div class="flex items-center justify-between mb-4">
                          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-600 to-blue-800 flex items-center justify-center">
                              <i class="fas fa-cube text-white text-xl"></i>
                          </div>
                          <span class="text-xs text-green-400 flex items-center">
                              <i class="fas fa-arrow-up mr-1"></i>8%
                          </span>
                      </div>
                      <div class="text-3xl font-black text-white mb-1">18</div>
                      <div class="text-sm text-gray-400">ë¯¼íŒ… ì™„ë£Œ</div>
                  </div>
              </div>

              <!-- ì´ íŒë§¤ì•¡ -->
              <div class="card-nft rounded-2xl p-6 relative overflow-hidden">
                  <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-green-600/20 to-transparent rounded-full -mr-16 -mt-16"></div>
                  <div class="relative z-10">
                      <div class="flex items-center justify-between mb-4">
                          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-600 to-emerald-800 flex items-center justify-center">
                              <i class="fas fa-dollar-sign text-white text-xl"></i>
                          </div>
                          <span class="text-xs text-green-400 flex items-center">
                              <i class="fas fa-arrow-up mr-1"></i>24%
                          </span>
                      </div>
                      <div class="text-3xl font-black text-white mb-1">12.5 ETH</div>
                      <div class="text-sm text-gray-400">ì´ íŒë§¤ì•¡</div>
                  </div>
              </div>

              <!-- í‰ê·  í‰ê°€ ì ìˆ˜ -->
              <div class="card-nft rounded-2xl p-6 relative overflow-hidden">
                  <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-orange-600/20 to-transparent rounded-full -mr-16 -mt-16"></div>
                  <div class="relative z-10">
                      <div class="flex items-center justify-between mb-4">
                          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-600 to-red-800 flex items-center justify-center">
                              <i class="fas fa-star text-white text-xl"></i>
                          </div>
                          <span class="text-xs text-green-400 flex items-center">
                              <i class="fas fa-arrow-up mr-1"></i>5%
                          </span>
                      </div>
                      <div class="text-3xl font-black text-white mb-1">87.5</div>
                      <div class="text-sm text-gray-400">í‰ê·  í‰ê°€ ì ìˆ˜</div>
                  </div>
              </div>
          </div>

          <!-- í™œë™ ê·¸ë˜í”„ & ìµœê·¼ ì‘í’ˆ -->
          <div class="grid lg:grid-cols-3 gap-8 mb-12">
              <!-- ì›”ë³„ í™œë™ ê·¸ë˜í”„ -->
              <div class="lg:col-span-2 card-nft rounded-2xl p-6">
                  <div class="flex items-center justify-between mb-6">
                      <h3 class="text-xl font-bold text-white">ì›”ë³„ ì‘í’ˆ í™œë™</h3>
                      <select class="px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white text-sm">
                          <option>ìµœê·¼ 6ê°œì›”</option>
                          <option>ìµœê·¼ 1ë…„</option>
                      </select>
                  </div>
                  <canvas id="activityChart" class="w-full"></canvas>
              </div>

              <!-- ì¹´í…Œê³ ë¦¬ ë¶„í¬ -->
              <div class="card-nft rounded-2xl p-6">
                  <h3 class="text-xl font-bold text-white mb-6">ì‘í’ˆ ì¹´í…Œê³ ë¦¬</h3>
                  <canvas id="categoryChart" class="w-full mb-4"></canvas>
                  <div class="space-y-3">
                      <div class="flex items-center justify-between">
                          <div class="flex items-center">
                              <div class="w-3 h-3 rounded-full bg-purple-500 mr-2"></div>
                              <span class="text-sm text-gray-300">ë””ì§€í„¸ì•„íŠ¸</span>
                          </div>
                          <span class="text-sm font-bold text-white">42%</span>
                      </div>
                      <div class="flex items-center justify-between">
                          <div class="flex items-center">
                              <div class="w-3 h-3 rounded-full bg-cyan-500 mr-2"></div>
                              <span class="text-sm text-gray-300">íšŒí™”</span>
                          </div>
                          <span class="text-sm font-bold text-white">28%</span>
                      </div>
                      <div class="flex items-center justify-between">
                          <div class="flex items-center">
                              <div class="w-3 h-3 rounded-full bg-orange-500 mr-2"></div>
                              <span class="text-sm text-gray-300">ì‚¬ì§„</span>
                          </div>
                          <span class="text-sm font-bold text-white">18%</span>
                      </div>
                      <div class="flex items-center justify-between">
                          <div class="flex items-center">
                              <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                              <span class="text-sm text-gray-300">ê¸°íƒ€</span>
                          </div>
                          <span class="text-sm font-bold text-white">12%</span>
                      </div>
                  </div>
              </div>
          </div>

          <!-- ê²½ë ¥ ì…ë ¥ ì„¹ì…˜ -->
          <div class="mb-12">
              <div class="flex items-center justify-between mb-6">
                  <h2 class="text-3xl font-black">
                      <span class="text-gradient">ë‚˜ì˜</span> <span class="text-white">ê²½ë ¥</span>
                  </h2>
                  <button onclick="toggleCareerForm()" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 text-white font-semibold rounded-xl hover:shadow-lg transition">
                      <i class="fas fa-plus-circle mr-2"></i>
                      ê²½ë ¥ ì¶”ê°€
                  </button>
              </div>
              
              <div id="artist-career-form" style="display: none;">
                  <!-- ê²½ë ¥ ì…ë ¥ í¼ì´ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
              </div>
          </div>

          <!-- ë‚´ ì‘í’ˆ ëª©ë¡ -->
          <div>
              <div class="flex items-center justify-between mb-6">
                  <h2 class="text-3xl font-black">
                      <span class="text-gradient">ë‚´</span> <span class="text-white">ì‘í’ˆ</span>
                  </h2>
                  <div class="flex gap-2">
                      <button class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium">ì „ì²´</button>
                      <button class="px-4 py-2 bg-gray-800 text-gray-400 hover:bg-gray-700 rounded-lg text-sm font-medium">ìŠ¹ì¸ëŒ€ê¸°</button>
                      <button class="px-4 py-2 bg-gray-800 text-gray-400 hover:bg-gray-700 rounded-lg text-sm font-medium">ë¯¼íŒ…ì™„ë£Œ</button>
                  </div>
              </div>

              <div id="myArtworks" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                  <!-- ì‘í’ˆ ì¹´ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                  <div class="text-center col-span-full py-12 text-gray-400">
                      <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                      <p>ì‘í’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                  </div>
              </div>
          </div>
      </div>
  </section>

  <script>
    // ì›”ë³„ í™œë™ ì°¨íŠ¸
    const activityCtx = document.getElementById('activityChart').getContext('2d');
    new Chart(activityCtx, {
      type: 'line',
      data: {
        labels: ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”'],
        datasets: [{
          label: 'ì‘í’ˆ ì—…ë¡œë“œ',
          data: [3, 5, 2, 8, 6, 4],
          borderColor: '#8b5cf6',
          backgroundColor: 'rgba(139, 92, 246, 0.1)',
          tension: 0.4,
          fill: true
        }, {
          label: 'NFT ë¯¼íŒ…',
          data: [2, 4, 1, 6, 5, 3],
          borderColor: '#06b6d4',
          backgroundColor: 'rgba(6, 182, 212, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 2.5,
        plugins: {
          legend: {
            display: true,
            labels: { color: '#9ca3af' }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(255, 255, 255, 0.05)' },
            ticks: { color: '#9ca3af' }
          },
          x: {
            grid: { color: 'rgba(255, 255, 255, 0.05)' },
            ticks: { color: '#9ca3af' }
          }
        }
      }
    });

    // ì¹´í…Œê³ ë¦¬ ë„ë„› ì°¨íŠ¸
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
      type: 'doughnut',
      data: {
        labels: ['ë””ì§€í„¸ì•„íŠ¸', 'íšŒí™”', 'ì‚¬ì§„', 'ê¸°íƒ€'],
        datasets: [{
          data: [42, 28, 18, 12],
          backgroundColor: ['#8b5cf6', '#06b6d4', '#f97316', '#10b981'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false }
        }
      }
    });

    // ë‚´ ì‘í’ˆ ë¡œë“œ
    async function loadMyArtworks() {
      try {
        const response = await axios.get('/api/submissions/my');
        const submissions = response.data.data || [];
        
        const container = document.getElementById('myArtworks');
        if (submissions.length === 0) {
          container.innerHTML = \`
            <div class="text-center col-span-full py-12">
              <i class="fas fa-paint-brush text-6xl text-gray-700 mb-4"></i>
              <p class="text-gray-400 text-lg mb-4">ì•„ì§ ì—…ë¡œë“œí•œ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤</p>
              <a href="/mint-upload" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 text-white font-semibold rounded-xl hover:shadow-lg transition">
                <i class="fas fa-plus-circle mr-2"></i>ì²« ì‘í’ˆ ì—…ë¡œë“œí•˜ê¸°
              </a>
            </div>
          \`;
          return;
        }

        container.innerHTML = submissions.map(artwork => \`
          <div class="card-nft rounded-2xl overflow-hidden group cursor-pointer" onclick="viewArtwork(\${artwork.id})">
            <div class="relative aspect-square bg-gray-900 overflow-hidden">
              <img src="\${artwork.image_url}" alt="\${artwork.title}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy">
              <div class="absolute top-3 right-3">
                \${artwork.submission_status === 'pending' ? 
                  \`<span class="px-3 py-1 bg-yellow-600 text-white text-xs font-bold rounded-full">ìŠ¹ì¸ëŒ€ê¸°</span>\` :
                  artwork.submission_status === 'approved' ?
                  \`<span class="px-3 py-1 bg-green-600 text-white text-xs font-bold rounded-full">ìŠ¹ì¸ì™„ë£Œ</span>\` :
                  \`<span class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full">ë°˜ë ¤</span>\`
                }
              </div>
            </div>
            <div class="p-4">
              <h3 class="font-bold text-white mb-2 truncate">\${artwork.title}</h3>
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-400">\${artwork.category || 'ë¯¸ë¶„ë¥˜'}</span>
                <span class="text-gray-500">\${artwork.submitted_at?.split('T')[0] || ''}</span>
              </div>
            </div>
          </div>
        \`).join('');
      } catch (error) {
        console.error('Failed to load artworks:', error);
        document.getElementById('myArtworks').innerHTML = \`
          <div class="text-center col-span-full py-12 text-red-500">
            <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
            <p>ì‘í’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</p>
          </div>
        \`;
      }
    }

    function viewArtwork(id) {
      // ì‘í’ˆ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ ë˜ëŠ” ëª¨ë‹¬ í‘œì‹œ
      console.log('View artwork:', id);
    }
    
    // ê²½ë ¥ í¼ í† ê¸€
    function toggleCareerForm() {
      const form = document.getElementById('artist-career-form');
      if (form.style.display === 'none') {
        form.style.display = 'block';
        loadArtistCareerForm();
      } else {
        form.style.display = 'none';
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‘í’ˆ ëª©ë¡ ë° ë­í¬ ë¡œë“œ
    document.addEventListener('DOMContentLoaded', () => {
      loadMyArtworks();
      loadArtistRank();
    });
  </script>
  <script src="/static/artist-rank.js"></script>
  `;
  
  return c.html(getLayout(content, 'ë§ˆì´í˜ì´ì§€ - GALLERYPIA'))
})

// ë¦¬ë”ë³´ë“œ í˜ì´ì§€ - ì•„í‹°ìŠ¤íŠ¸ ë­í‚¹
app.get('/leaderboard', (c) => {
  const content = `
  <section class="py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <!-- í—¤ë” -->
          <div class="text-center mb-12">
              <h1 class="text-6xl font-black mb-4">
                  <i class="fas fa-trophy text-yellow-400 mr-4"></i>
                  <span class="text-gradient">ì•„í‹°ìŠ¤íŠ¸</span>
              </h1>
              <p class="text-gray-400 text-lg">
                  ì „ì‹œíšŒ, ìˆ˜ìƒ, ì‘í’ˆ í™œë™ ê¸°ë°˜ì˜ ê°ê´€ì  ì•„í‹°ìŠ¤íŠ¸ í‰ê°€ ì‹œìŠ¤í…œ
              </p>
          </div>
          
          <!-- íƒ­ ë©”ë‰´ -->
          <div class="mb-12">
              <div class="flex flex-wrap gap-3 border-b border-white/10 pb-6 justify-center">
                  <button onclick="showLeaderboardTab('ranking')" id="tab-ranking" class="leaderboard-tab active px-6 py-3 rounded-xl font-bold transition-all">
                      <i class="fas fa-trophy mr-2"></i>ë­í‚¹
                  </button>
                  <button onclick="showLeaderboardTab('artists')" id="tab-artists" class="leaderboard-tab px-6 py-3 rounded-xl font-bold transition-all">
                      <i class="fas fa-users mr-2"></i>ì•„í‹°ìŠ¤íŠ¸
                  </button>
              </div>
          </div>
          
          <!-- ë­í‚¹ íƒ­ ì½˜í…ì¸  -->
          <div id="ranking-tab-content">
              <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
              <div class="flex flex-wrap justify-center gap-4 mb-12">
                  <button onclick="filterLeaderboard('all')" class="leaderboard-filter active">
                      <i class="fas fa-globe mr-2"></i>ì „ì²´
                  </button>
                  <button onclick="filterLeaderboard('master')" class="leaderboard-filter">
                      <i class="fas fa-crown text-yellow-400 mr-2"></i>ìµœìš°ìˆ˜ ì‘ê°€
                  </button>
                  <button onclick="filterLeaderboard('excellent')" class="leaderboard-filter">
                      <i class="fas fa-star text-blue-400 mr-2"></i>ìš°ìˆ˜ ì‘ê°€
                  </button>
                  <button onclick="filterLeaderboard('professional')" class="leaderboard-filter">
                      <i class="fas fa-medal text-purple-400 mr-2"></i>ì „ë¬¸ ì‘ê°€
                  </button>
                  <button onclick="filterLeaderboard('emerging')" class="leaderboard-filter">
                      <i class="fas fa-seedling text-green-400 mr-2"></i>ì‹ ì§„ ì‘ê°€
                  </button>
              </div>
          
          <!-- ë­í‚¹ í†µê³„ -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
              <div class="card-nft rounded-2xl p-6 text-center">
                  <div class="text-4xl font-black text-gradient mb-2" id="total-artists">-</div>
                  <div class="text-gray-400 text-sm">ì´ ë“±ë¡ ì•„í‹°ìŠ¤íŠ¸</div>
              </div>
              <div class="card-nft rounded-2xl p-6 text-center">
                  <div class="text-4xl font-black text-yellow-400 mb-2" id="master-count">-</div>
                  <div class="text-gray-400 text-sm">ìµœìš°ìˆ˜ ì‘ê°€</div>
              </div>
              <div class="card-nft rounded-2xl p-6 text-center">
                  <div class="text-4xl font-black text-blue-400 mb-2" id="excellent-count">-</div>
                  <div class="text-gray-400 text-sm">ìš°ìˆ˜ ì‘ê°€</div>
              </div>
              <div class="card-nft rounded-2xl p-6 text-center">
                  <div class="text-4xl font-black text-purple-400 mb-2" id="professional-count">-</div>
                  <div class="text-gray-400 text-sm">ì „ë¬¸ ì‘ê°€</div>
              </div>
          </div>
          
          <!-- ë¦¬ë”ë³´ë“œ í…Œì´ë¸” -->
          <div class="card-nft rounded-2xl p-8">
              <div class="overflow-x-auto">
                  <table class="w-full">
                      <thead>
                          <tr class="border-b border-gray-800">
                              <th class="text-left py-4 px-4 text-gray-400 font-semibold">ìˆœìœ„</th>
                              <th class="text-left py-4 px-4 text-gray-400 font-semibold">ì•„í‹°ìŠ¤íŠ¸</th>
                              <th class="text-left py-4 px-4 text-gray-400 font-semibold">ë­í¬</th>
                              <th class="text-center py-4 px-4 text-gray-400 font-semibold">ì •ëŸ‰í‰ê°€</th>
                              <th class="text-center py-4 px-4 text-gray-400 font-semibold">ì •ì„±í‰ê°€</th>
                              <th class="text-center py-4 px-4 text-gray-400 font-semibold">ì¸ê¸°ë„</th>
                              <th class="text-center py-4 px-4 text-gray-400 font-semibold">ì´ì </th>
                          </tr>
                      </thead>
                      <tbody id="leaderboard-body">
                          <tr>
                              <td colspan="7" class="text-center py-12 text-gray-400">
                                  <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                                  <p>ë­í‚¹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                              </td>
                          </tr>
                      </tbody>
                  </table>
              </div>
          </div>
          
          <!-- í‰ê°€ ê¸°ì¤€ ì•ˆë‚´ -->
          <div class="mt-12 card-nft rounded-2xl p-8">
              <h3 class="text-2xl font-bold text-white mb-6">
                  <i class="fas fa-info-circle text-cyan-400 mr-2"></i>
                  ë­í¬ í‰ê°€ ê¸°ì¤€
              </h3>
              <div class="grid md:grid-cols-3 gap-6">
                  <div>
                      <div class="text-purple-400 font-bold mb-2">
                          <i class="fas fa-chart-line mr-2"></i>ì •ëŸ‰í‰ê°€ (40%)
                      </div>
                      <ul class="text-sm text-gray-400 space-y-1">
                          <li>â€¢ ì „ì‹œíšŒ ê²½ë ¥ (êµ­ë‚´ì™¸ ë¹„ì—”ë‚ ë ˆ, ê°œì¸ì „ ë“±)</li>
                          <li>â€¢ ìˆ˜ìƒ ê²½ë ¥ (ê³µëª¨ì „, ëŒ€íšŒ ë“±)</li>
                          <li>â€¢ ì €ì‘ê¶Œ ë“±ë¡</li>
                          <li>â€¢ ì „ì‹œê¸°íš ê²½ë ¥</li>
                          <li>â€¢ ë…¼ë¬¸ ë° ì €ì„œ</li>
                      </ul>
                  </div>
                  <div>
                      <div class="text-cyan-400 font-bold mb-2">
                          <i class="fas fa-user-check mr-2"></i>ì •ì„±í‰ê°€ (30%)
                      </div>
                      <ul class="text-sm text-gray-400 space-y-1">
                          <li>â€¢ ì‘í’ˆ ë‚´ìš©ì„± (ì»¨ì…‰, ìŠ¤í† ë¦¬)</li>
                          <li>â€¢ í‘œí˜„ì„± (ê¸°ìˆ , ì¡°í˜•ìš”ì†Œ)</li>
                          <li>â€¢ ë…ì°½ì„± (ìœ ì¼ì„±, í¬ê·€ì„±)</li>
                          <li>â€¢ ì†Œì¥ê°€ì¹˜ (íˆ¬ìê°€ì¹˜, ì´ë ¥)</li>
                          <li>â€¢ ì „ë¬¸ê°€ í‰ê°€ ìœ„ì›íšŒ ì‹¬ì‚¬</li>
                      </ul>
                  </div>
                  <div>
                      <div class="text-pink-400 font-bold mb-2">
                          <i class="fas fa-fire mr-2"></i>ì¸ê¸°ë„ (30%)
                      </div>
                      <ul class="text-sm text-gray-400 space-y-1">
                          <li>â€¢ YouTube ì¡°íšŒìˆ˜</li>
                          <li>â€¢ OpenSea ì¡°íšŒìˆ˜</li>
                          <li>â€¢ NFT í”Œë«í¼ ì¡°íšŒìˆ˜</li>
                          <li>â€¢ íŒë§¤ ì‹¤ì </li>
                          <li>â€¢ ì†Œì…œ ë¯¸ë””ì–´ ì¸ì§€ë„</li>
                      </ul>
                  </div>
              </div>
          </div>
          
          <!-- íŠ¹í—ˆ/ì €ì‘ê¶Œ ë³´í˜¸ ì•ˆë‚´ -->
          <div class="mt-12 p-6 rounded-2xl bg-gradient-to-r from-amber-900/30 via-orange-900/20 to-red-900/30 backdrop-blur-sm border border-amber-500/40">
              <div class="flex items-start gap-4">
                  <div class="flex-shrink-0">
                      <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-600 rounded-full flex items-center justify-center">
                          <i class="fas fa-shield-alt text-white text-xl"></i>
                      </div>
                  </div>
                  <div class="flex-1">
                      <div class="flex items-center gap-2 mb-2">
                          <i class="fas fa-copyright text-amber-400"></i>
                          <span class="text-amber-300 font-bold text-lg">ì§€ì ì¬ì‚°ê¶Œ ë³´í˜¸</span>
                      </div>
                      <p class="text-gray-300 text-sm leading-relaxed">
                          ìƒê¸° ì—°êµ¬ëŠ” <span class="text-white font-semibold">íŠ¹í—ˆ</span>, <span class="text-white font-semibold">ì €ì‘ê¶Œ</span>ìœ¼ë¡œ ë³´í˜¸ ë°›ê³  ìˆìŠµë‹ˆë‹¤.
                      </p>
                  </div>
              </div>
          </div>
          </div>
          <!-- End ë­í‚¹ íƒ­ ì½˜í…ì¸  -->
          
          <!-- ì•„í‹°ìŠ¤íŠ¸ íƒ­ ì½˜í…ì¸  -->
          <div id="artists-tab-content" class="hidden">
              <!-- íë ˆì´í„° ì¶”ì²œ ì•„í‹°ìŠ¤íŠ¸ -->
              <div class="mb-20">
                  <div class="flex items-center justify-between mb-8">
                      <h2 class="text-3xl font-black text-white flex items-center">
                          <i class="fas fa-star text-yellow-400 mr-3"></i>
                          íë ˆì´í„° ì¶”ì²œ ì•„í‹°ìŠ¤íŠ¸
                      </h2>
                  </div>
                  <div id="curatorRecommended" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                      <div class="col-span-full text-center py-12 text-gray-400">
                          <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                          <p>ë¡œë”© ì¤‘...</p>
                      </div>
                  </div>
              </div>
              
              <!-- ì¸ê¸° ì•„í‹°ìŠ¤íŠ¸ -->
              <div class="mb-20">
                  <div class="flex items-center justify-between mb-8">
                      <h2 class="text-3xl font-black text-white flex items-center">
                          <i class="fas fa-fire text-orange-400 mr-3"></i>
                          ì¸ê¸° ì•„í‹°ìŠ¤íŠ¸
                      </h2>
                  </div>
                  <div id="popularArtists" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                      <div class="col-span-full text-center py-12 text-gray-400">
                          <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                          <p>ë¡œë”© ì¤‘...</p>
                      </div>
                  </div>
              </div>
              
              <!-- ì‹ ê·œ ì•„í‹°ìŠ¤íŠ¸ -->
              <div class="mb-12">
                  <div class="flex items-center justify-between mb-8">
                      <h2 class="text-3xl font-black text-white flex items-center">
                          <i class="fas fa-seedling text-green-400 mr-3"></i>
                          ì‹ ê·œ ì•„í‹°ìŠ¤íŠ¸
                      </h2>
                  </div>
                  <div id="newArtists" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                      <div class="col-span-full text-center py-12 text-gray-400">
                          <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                          <p>ë¡œë”© ì¤‘...</p>
                      </div>
                  </div>
              </div>
          </div>
          <!-- End ì•„í‹°ìŠ¤íŠ¸ íƒ­ ì½˜í…ì¸  -->
      </div>
  </section>
  
  <script>
    let currentFilter = 'all';
    
    // ë¦¬ë”ë³´ë“œ ë°ì´í„° ë¡œë“œ
    async function loadLeaderboard(category = null) {
      try {
        let url = '/api/artist/leaderboard?limit=50';
        if (category && category !== 'all') {
          url += \`&category=\${category}\`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          renderLeaderboard(result.data);
          updateStats(result.data);
        } else {
          document.getElementById('leaderboard-body').innerHTML = \`
            <tr>
              <td colspan="7" class="text-center py-12 text-gray-400">
                  <i class="fas fa-inbox text-5xl mb-4"></i>
                  <p>ë“±ë¡ëœ ì•„í‹°ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>
              </td>
            </tr>
          \`;
        }
      } catch (error) {
        console.error('Failed to load leaderboard:', error);
        document.getElementById('leaderboard-body').innerHTML = \`
          <tr>
            <td colspan="7" class="text-center py-12 text-red-400">
                <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</p>
            </td>
          </tr>
        \`;
      }
    }
    
    // ë¦¬ë”ë³´ë“œ ë Œë”ë§
    function renderLeaderboard(artists) {
      const tbody = document.getElementById('leaderboard-body');
      
      tbody.innerHTML = artists.map((artist, index) => {
        const rankBadge = getRankBadgeHTML(artist.rank_tier, artist.rank_grade, artist.rank_category);
        const rankIcon = index < 3 ? 
          \`<i class="fas fa-trophy text-\${index === 0 ? 'yellow' : index === 1 ? 'gray' : 'orange'}-400 text-xl"></i>\` :
          \`<span class="text-gray-400 font-bold">\${index + 1}</span>\`;
        
        return \`
          <tr class="border-b border-gray-800/50 hover:bg-white/5 transition-colors">
            <td class="py-4 px-4 text-center">\${rankIcon}</td>
            <td class="py-4 px-4">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-600 to-cyan-500 flex items-center justify-center text-white font-bold">
                  \${artist.username ? artist.username.substring(0, 2).toUpperCase() : 'UN'}
                </div>
                <div>
                  <div class="text-white font-bold">\${artist.full_name || artist.username || 'Unknown'}</div>
                  <div class="text-gray-400 text-sm">@\${artist.username || 'unknown'}</div>
                </div>
              </div>
            </td>
            <td class="py-4 px-4">\${rankBadge}</td>
            <td class="py-4 px-4 text-center">
              <div class="text-purple-400 font-bold">\${artist.quantitative_weighted_score.toFixed(1)}</div>
            </td>
            <td class="py-4 px-4 text-center">
              <div class="text-cyan-400 font-bold">\${artist.qualitative_weighted_score.toFixed(1)}</div>
            </td>
            <td class="py-4 px-4 text-center">
              <div class="text-pink-400 font-bold">\${artist.popularity_weighted_score.toFixed(1)}</div>
            </td>
            <td class="py-4 px-4 text-center">
              <div class="text-2xl font-black text-gradient">\${artist.final_score.toFixed(1)}</div>
            </td>
          </tr>
        \`;
      }).join('');
    }
    
    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStats(artists) {
      document.getElementById('total-artists').textContent = artists.length;
      
      const masterCount = artists.filter(a => a.rank_category === 'master').length;
      const excellentCount = artists.filter(a => a.rank_category === 'excellent').length;
      const professionalCount = artists.filter(a => a.rank_category === 'professional').length;
      
      document.getElementById('master-count').textContent = masterCount;
      document.getElementById('excellent-count').textContent = excellentCount;
      document.getElementById('professional-count').textContent = professionalCount;
    }
    
    // ì¹´í…Œê³ ë¦¬ í•„í„°
    function filterLeaderboard(category) {
      currentFilter = category;
      
      // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.leaderboard-filter').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.closest('button').classList.add('active');
      
      // ë°ì´í„° ë¡œë“œ
      loadLeaderboard(category === 'all' ? null : category);
    }
    
    // íƒ­ ì „í™˜
    function showLeaderboardTab(tab) {
      // íƒ­ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.leaderboard-tab').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById('tab-' + tab).classList.add('active');
      
      // íƒ­ ì½˜í…ì¸  í‘œì‹œ/ìˆ¨ê¹€
      document.getElementById('ranking-tab-content').style.display = tab === 'ranking' ? 'block' : 'none';
      document.getElementById('artists-tab-content').style.display = tab === 'artists' ? 'block' : 'none';
      
      // ì•„í‹°ìŠ¤íŠ¸ íƒ­ ì„ íƒ ì‹œ ë°ì´í„° ë¡œë“œ
      if (tab === 'artists' && !window.artistsLoaded) {
        loadArtists();
        window.artistsLoaded = true;
      }
    }
    
    // ì•„í‹°ìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ
    async function loadArtists() {
      await Promise.all([
        loadCuratorRecommended(),
        loadPopularArtists(),
        loadNewArtists()
      ]);
    }
    
    // íë ˆì´í„° ì¶”ì²œ ì•„í‹°ìŠ¤íŠ¸ (Top 3)
    async function loadCuratorRecommended() {
      try {
        const response = await axios.get('/api/artist/leaderboard?limit=3&category=master');
        const artists = response.data.data || [];
        
        const container = document.getElementById('curatorRecommended');
        if (artists.length === 0) {
          container.innerHTML = '<p class="text-gray-400 text-center col-span-full py-12">ì¶”ì²œ ì•„í‹°ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        container.innerHTML = artists.map((artist, index) => {
          const rankIcon = index === 0 ? 
            \`<i class="fas fa-trophy text-yellow-400 text-2xl"></i>\` :
            index === 1 ? \`<i class="fas fa-trophy text-gray-400 text-2xl"></i>\` :
            \`<i class="fas fa-trophy text-orange-400 text-2xl"></i>\`;
          
          return \`
            <div class="group card-nft rounded-3xl overflow-hidden hover:scale-[1.02] transition-transform duration-300">
                <div class="relative h-48 bg-gradient-to-br from-amber-900 via-orange-900 to-yellow-900">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent"></div>
                    <div class="absolute top-4 right-4">\${rankIcon}</div>
                    <div class="absolute bottom-4 left-4">
                        <span class="text-amber-300 text-sm font-bold">íë ˆì´í„° ì¶”ì²œ #\${index + 1}</span>
                    </div>
                </div>
                <div class="p-6 -mt-16 relative z-10">
                    <div class="w-28 h-28 rounded-full border-4 border-black mb-4 overflow-hidden bg-gradient-to-br from-amber-500 to-orange-600 ring-2 ring-amber-400/50">
                        <img src="\${artist.profile_image || 'https://via.placeholder.com/112'}" loading="lazy" 
                             alt="\${artist.full_name || artist.username}" 
                             class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-bold text-2xl text-white mb-2">\${artist.full_name || artist.username}</h3>
                    <p class="text-gray-400 text-sm mb-3">@\${artist.username || 'unknown'}</p>
                    <div class="grid grid-cols-3 gap-4 mb-4 p-4 bg-white/5 rounded-xl">
                        <div class="text-center">
                            <div class="text-xl font-bold text-purple-400">\${artist.quantitative_weighted_score.toFixed(1)}</div>
                            <div class="text-xs text-gray-500">ì •ëŸ‰</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xl font-bold text-cyan-400">\${artist.qualitative_weighted_score.toFixed(1)}</div>
                            <div class="text-xs text-gray-500">ì •ì„±</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xl font-bold text-pink-400">\${artist.popularity_weighted_score.toFixed(1)}</div>
                            <div class="text-xs text-gray-500">ì¸ê¸°</div>
                        </div>
                    </div>
                    <div class="text-center p-3 bg-gradient-to-r from-amber-900/30 to-orange-900/30 rounded-xl border border-amber-500/30">
                        <div class="text-xs text-amber-400 mb-1">ì¢…í•©ì ìˆ˜</div>
                        <div class="text-3xl font-black text-gradient">\${artist.final_score.toFixed(1)}</div>
                    </div>
                </div>
            </div>
          \`;
        }).join('');
      } catch (error) {
        console.error('Failed to load curator recommended:', error);
        document.getElementById('curatorRecommended').innerHTML = 
          '<p class="text-red-500 text-center col-span-full py-12">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }
    
    // ì¸ê¸° ì•„í‹°ìŠ¤íŠ¸ (ë†’ì€ ì¸ê¸°ë„ ì ìˆ˜)
    async function loadPopularArtists() {
      try {
        const response = await axios.get('/api/artist/leaderboard?limit=50');
        let artists = response.data.data || [];
        artists = artists.sort((a, b) => b.popularity_weighted_score - a.popularity_weighted_score).slice(0, 4);
        
        const container = document.getElementById('popularArtists');
        if (artists.length === 0) {
          container.innerHTML = '<p class="text-gray-400 text-center col-span-full py-12">ì¸ê¸° ì•„í‹°ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        container.innerHTML = artists.map(artist => \`
          <div class="card-nft rounded-3xl overflow-hidden hover:scale-[1.02] transition-transform duration-300">
              <div class="relative h-40 bg-gradient-to-br from-orange-900 via-red-900 to-pink-900 overflow-hidden">
                  <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent"></div>
                  <div class="absolute top-3 right-3">
                      <span class="px-2 py-1 bg-gradient-to-r from-orange-600 to-red-600 text-white text-xs font-bold rounded-full">
                          <i class="fas fa-fire mr-1"></i>HOT
                      </span>
                  </div>
              </div>
              <div class="p-6 -mt-12 relative z-10">
                  <div class="w-24 h-24 rounded-full border-4 border-black mb-4 overflow-hidden bg-gradient-to-br from-orange-500 to-pink-600">
                      <img src="\${artist.profile_image || 'https://via.placeholder.com/96'}" loading="lazy" 
                           alt="\${artist.full_name || artist.username}" 
                           class="w-full h-full object-cover">
                  </div>
                  <h3 class="font-bold text-xl text-white mb-1">\${artist.full_name || artist.username}</h3>
                  <p class="text-gray-400 text-sm mb-4">@\${artist.username || 'unknown'}</p>
                  <div class="text-center p-3 bg-gradient-to-r from-orange-900/30 to-red-900/30 rounded-xl border border-orange-500/30">
                      <div class="text-xs text-orange-400 mb-1">ì¸ê¸°ë„</div>
                      <div class="text-2xl font-black text-gradient">\${artist.popularity_weighted_score.toFixed(1)}</div>
                  </div>
              </div>
          </div>
        \`).join('');
      } catch (error) {
        console.error('Failed to load popular artists:', error);
        document.getElementById('popularArtists').innerHTML = 
          '<p class="text-red-500 text-center col-span-full py-12">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }
    
    // ì‹ ê·œ ì•„í‹°ìŠ¤íŠ¸ (ìµœê·¼ ë“±ë¡ìˆœ)
    async function loadNewArtists() {
      try {
        const response = await axios.get('/api/artist/leaderboard?limit=50');
        let artists = response.data.data || [];
        artists = artists.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0)).slice(0, 4);
        
        const container = document.getElementById('newArtists');
        if (artists.length === 0) {
          container.innerHTML = '<p class="text-gray-400 text-center col-span-full py-12">ì‹ ê·œ ì•„í‹°ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        container.innerHTML = artists.map(artist => \`
          <div class="card-nft rounded-3xl overflow-hidden hover:scale-[1.02] transition-transform duration-300">
              <div class="relative h-40 bg-gradient-to-br from-green-900 via-emerald-900 to-teal-900 overflow-hidden">
                  <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent"></div>
                  <div class="absolute top-3 right-3">
                      <span class="px-2 py-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white text-xs font-bold rounded-full">
                          <i class="fas fa-seedling mr-1"></i>NEW
                      </span>
                  </div>
              </div>
              <div class="p-6 -mt-12 relative z-10">
                  <div class="w-24 h-24 rounded-full border-4 border-black mb-4 overflow-hidden bg-gradient-to-br from-green-500 to-emerald-600">
                      <img src="\${artist.profile_image || 'https://via.placeholder.com/96'}" loading="lazy" 
                           alt="\${artist.full_name || artist.username}" 
                           class="w-full h-full object-cover">
                  </div>
                  <h3 class="font-bold text-xl text-white mb-1">\${artist.full_name || artist.username}</h3>
                  <p class="text-gray-400 text-sm mb-4">@\${artist.username || 'unknown'}</p>
                  <div class="text-center p-3 bg-gradient-to-r from-green-900/30 to-emerald-900/30 rounded-xl border border-green-500/30">
                      <div class="text-xs text-green-400 mb-1">ì¢…í•©ì ìˆ˜</div>
                      <div class="text-2xl font-black text-gradient">\${artist.final_score.toFixed(1)}</div>
                  </div>
              </div>
          </div>
        \`).join('');
      } catch (error) {
        console.error('Failed to load new artists:', error);
        document.getElementById('newArtists').innerHTML = 
          '<p class="text-red-500 text-center col-span-full py-12">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¦¬ë”ë³´ë“œ ë¡œë“œ
    document.addEventListener('DOMContentLoaded', () => {
      loadLeaderboard();
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  <script src="/static/artist-rank.js"></script>
  
  <style>
    .leaderboard-tab {
      background: rgba(255, 255, 255, 0.03);
      color: #9ca3af;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .leaderboard-tab:hover {
      background: rgba(255, 255, 255, 0.08);
      color: white;
    }
    .leaderboard-tab.active {
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.2) 0%, rgba(6, 182, 212, 0.2) 100%);
      border-color: rgba(168, 85, 247, 0.5);
      color: white;
    }
    
    .leaderboard-filter {
      padding: 12px 24px;
      background: #1f2937;
      color: #9ca3af;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .leaderboard-filter:hover {
      background: #374151;
      transform: translateY(-2px);
    }
    
    .leaderboard-filter.active {
      background: linear-gradient(135deg, #7c3aed 0%, #06b6d4 100%);
      color: white;
      box-shadow: 0 10px 30px rgba(124, 58, 237, 0.3);
    }
  </style>
  `;
  
  return c.html(getLayout(content, 'ì•„í‹°ìŠ¤íŠ¸ ë­í‚¹ - GALLERYPIA'))
})

// ê²€ìƒ‰ í˜ì´ì§€ - ìŒì„±ê²€ìƒ‰, AIê²€ìƒ‰, ì „ë¬¸ê°€ ì¶”ì²œ
app.get('/search', (c) => {
  const content = `
  <section id="main-content" class="py-16" tabindex="-1">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-12">
              <h1 class="text-6xl font-black mb-4">
                  <span class="text-gradient">ìŠ¤ë§ˆíŠ¸</span> <span class="text-white">ê²€ìƒ‰</span>
              </h1>
              <p class="text-gray-400 text-lg">ìŒì„±, í…ìŠ¤íŠ¸, AIë¡œ ì›í•˜ëŠ” ì‘í’ˆì„ ì°¾ì•„ë³´ì„¸ìš”</p>
          </div>

          <!-- ê²€ìƒ‰ ë°©ë²• ì„ íƒ íƒ­ -->
          <div class="flex justify-center gap-4 mb-12">
              <button onclick="switchSearchMode('text')" id="textTab" class="px-8 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 text-white rounded-xl font-semibold">
                  <i class="fas fa-keyboard mr-2"></i>í…ìŠ¤íŠ¸ ê²€ìƒ‰
              </button>
              <button onclick="switchSearchMode('voice')" id="voiceTab" class="px-8 py-3 bg-gray-800 text-gray-400 hover:bg-gray-700 rounded-xl font-semibold">
                  <i class="fas fa-microphone mr-2"></i>ìŒì„± ê²€ìƒ‰
              </button>
              <button onclick="switchSearchMode('ai')" id="aiTab" class="px-8 py-3 bg-gray-800 text-gray-400 hover:bg-gray-700 rounded-xl font-semibold">
                  <i class="fas fa-brain mr-2"></i>AI ê²€ìƒ‰
              </button>
          </div>

          <!-- í…ìŠ¤íŠ¸ ê²€ìƒ‰ -->
          <div id="textSearch" class="max-w-3xl mx-auto mb-16">
              <div class="card-nft rounded-2xl p-8">
                  <div class="relative">
                      <input type="text" id="searchInput" placeholder="ì‘í’ˆëª…, ì‘ê°€ëª…, í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                             class="w-full px-6 py-4 bg-gray-900 border border-gray-700 rounded-xl text-white text-lg focus:border-purple-500 focus:outline-none pr-14">
                      <button onclick="performSearch()" class="absolute right-3 top-1/2 -translate-y-1/2 px-4 py-2 bg-gradient-to-r from-purple-600 to-cyan-500 text-white rounded-lg">
                          <i class="fas fa-search"></i>
                      </button>
                  </div>
                  <div class="mt-4 flex flex-wrap gap-2">
                      <span class="text-sm text-gray-400">ì¸ê¸° ê²€ìƒ‰ì–´:</span>
                      <button onclick="quickSearch('ë””ì§€í„¸ì•„íŠ¸')" class="px-3 py-1 bg-gray-800 hover:bg-purple-600 text-gray-300 hover:text-white rounded-lg text-sm transition">ë””ì§€í„¸ì•„íŠ¸</button>
                      <button onclick="quickSearch('ì¶”ìƒí™”')" class="px-3 py-1 bg-gray-800 hover:bg-purple-600 text-gray-300 hover:text-white rounded-lg text-sm transition">ì¶”ìƒí™”</button>
                      <button onclick="quickSearch('NFT')" class="px-3 py-1 bg-gray-800 hover:bg-purple-600 text-gray-300 hover:text-white rounded-lg text-sm transition">NFT</button>
                  </div>
              </div>
          </div>

          <!-- ìŒì„± ê²€ìƒ‰ -->
          <div id="voiceSearch" class="hidden max-w-3xl mx-auto mb-16">
              <div class="card-nft rounded-2xl p-12 text-center">
                  <div id="voiceStatus" class="mb-8">
                      <div class="w-32 h-32 mx-auto rounded-full bg-gradient-to-br from-purple-600 to-cyan-500 flex items-center justify-center mb-6">
                          <i id="micIcon" class="fas fa-microphone text-white text-6xl"></i>
                      </div>
                      <p id="voiceText" class="text-gray-400 text-lg">ë§ˆì´í¬ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìŒì„±ìœ¼ë¡œ ê²€ìƒ‰í•˜ì„¸ìš”</p>
                  </div>
                  <button onclick="startVoiceSearch()" id="voiceButton" class="px-10 py-4 bg-gradient-to-r from-purple-600 to-cyan-500 text-white rounded-xl font-bold text-lg hover:shadow-lg hover:shadow-purple-500/50 transition">
                      <i class="fas fa-microphone mr-2"></i>ìŒì„± ê²€ìƒ‰ ì‹œì‘
                  </button>
                  <p id="recognizedText" class="mt-6 text-white text-xl font-semibold hidden"></p>
              </div>
          </div>

          <!-- AI ê²€ìƒ‰ -->
          <div id="aiSearch" class="hidden max-w-3xl mx-auto mb-16">
              <div class="card-nft rounded-2xl p-8">
                  <h3 class="text-2xl font-bold text-white mb-4">AI ì´ë¯¸ì§€ ê²€ìƒ‰</h3>
                  <p class="text-gray-400 mb-6">ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ AIê°€ ìœ ì‚¬í•œ ì‘í’ˆì„ ì°¾ì•„ë“œë¦½ë‹ˆë‹¤</p>
                  
                  <div id="aiUploadArea" class="border-2 border-dashed border-purple-500/50 hover:border-purple-500 rounded-2xl p-12 text-center cursor-pointer transition">
                      <input type="file" id="aiImageInput" accept="image/*" class="hidden">
                      <i class="fas fa-image text-6xl text-purple-500 mb-4"></i>
                      <p class="text-gray-300 text-lg font-medium mb-2">ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                      <p class="text-gray-500 text-sm">PNG, JPG, GIF (ìµœëŒ€ 10MB)</p>
                  </div>
                  
                  <div id="aiImagePreview" class="hidden mt-6">
                      <img id="aiPreviewImg" class="max-h-64 mx-auto rounded-xl mb-4">
                      <button onclick="performAISearch()" class="w-full py-4 bg-gradient-to-r from-purple-600 to-cyan-500 text-white rounded-xl font-bold">
                          <i class="fas fa-brain mr-2"></i>AIë¡œ ìœ ì‚¬ ì‘í’ˆ ì°¾ê¸°
                      </button>
                  </div>
              </div>
          </div>

          <!-- ì „ë¬¸ê°€ ì¶”ì²œ ì‘í’ˆ -->
          <div class="mb-12">
              <div class="flex items-center justify-between mb-6">
                  <h2 class="text-3xl font-black">
                      <span class="text-gradient">ì „ë¬¸ê°€</span> <span class="text-white">ì¶”ì²œ ì‘í’ˆ</span>
                  </h2>
                  <button class="text-purple-500 hover:text-purple-400 font-semibold">
                      ì „ì²´ ë³´ê¸° <i class="fas fa-arrow-right ml-1"></i>
                  </button>
              </div>
              
              <div id="expertRecommendations" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                  <!-- ì¶”ì²œ ì‘í’ˆì´ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                  <div class="text-center col-span-full py-12 text-gray-400">
                      <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                      <p>ì „ë¬¸ê°€ ì¶”ì²œ ì‘í’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                  </div>
              </div>
          </div>

          <!-- ê²€ìƒ‰ ê²°ê³¼ -->
          <div id="searchResults" class="hidden">
              <h3 class="text-2xl font-bold text-white mb-6">ê²€ìƒ‰ ê²°ê³¼</h3>
              <div id="resultsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                  <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
              </div>
          </div>
      </div>
  </section>

  <script>
    let currentMode = 'text';
    let recognition = null;

    // ê²€ìƒ‰ ëª¨ë“œ ì „í™˜
    function switchSearchMode(mode) {
      currentMode = mode;
      
      // íƒ­ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
      ['text', 'voice', 'ai'].forEach(m => {
        const tab = document.getElementById(m + 'Tab');
        if (m === mode) {
          tab.className = 'px-8 py-3 bg-gradient-to-r from-purple-600 to-cyan-500 text-white rounded-xl font-semibold';
        } else {
          tab.className = 'px-8 py-3 bg-gray-800 text-gray-400 hover:bg-gray-700 rounded-xl font-semibold';
        }
      });

      // ê²€ìƒ‰ ì˜ì—­ í‘œì‹œ/ìˆ¨ê¹€
      document.getElementById('textSearch').classList.toggle('hidden', mode !== 'text');
      document.getElementById('voiceSearch').classList.toggle('hidden', mode !== 'voice');
      document.getElementById('aiSearch').classList.toggle('hidden', mode !== 'ai');
    }

    // í…ìŠ¤íŠ¸ ê²€ìƒ‰
    async function performSearch() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) {
        alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }
      
      try {
        const response = await axios.get(\`/api/artworks?search=\${encodeURIComponent(query)}\`);
        displaySearchResults(response.data.data || []);
      } catch (error) {
        console.error('Search error:', error);
        alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    }

    // ë¹ ë¥¸ ê²€ìƒ‰ (ë©”ì¸ í˜ì´ì§€ìš©)
    function quickSearch(keyword) {
      const searchInput = document.getElementById('aiSearchInput');
      if (searchInput) {
        searchInput.value = keyword;
        performAISearch();
      } else {
        // ê°¤ëŸ¬ë¦¬ í˜ì´ì§€ìš©
        const gallerySearch = document.getElementById('searchInput');
        if (gallerySearch) {
          gallerySearch.value = keyword;
          performSearch();
        }
      }
    }

    // ìŒì„± ê²€ìƒ‰ (ë©”ì¸ í˜ì´ì§€ìš©)
    function startVoiceSearch() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nChrome, Edge, Safari ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = 'ko-KR';
      recognition.continuous = false;
      recognition.interimResults = false;

      const searchInput = document.getElementById('aiSearchInput');
      
      // ìŒì„± ì¸ì‹ ì‹œì‘ ì•Œë¦¼
      searchInput.placeholder = 'ğŸ¤ ë“£ê³  ìˆìŠµë‹ˆë‹¤... ë§ì”€í•´ì£¼ì„¸ìš”';
      searchInput.classList.add('border-purple-500', 'bg-purple-900/20');

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        searchInput.value = transcript;
        searchInput.placeholder = 'AIë¡œ ì‘í’ˆ ê²€ìƒ‰... (í…ìŠ¤íŠ¸, ìŒì„± ì§€ì›)';
        searchInput.classList.remove('border-purple-500', 'bg-purple-900/20');
        
        // ì¸ì‹ëœ í…ìŠ¤íŠ¸ë¡œ ì¦‰ì‹œ ê²€ìƒ‰
        setTimeout(() => performAISearch(), 500);
      };

      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        searchInput.placeholder = 'âŒ ìŒì„± ì¸ì‹ ì˜¤ë¥˜ - ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”';
        searchInput.classList.remove('border-purple-500', 'bg-purple-900/20');
        setTimeout(() => {
          searchInput.placeholder = 'AIë¡œ ì‘í’ˆ ê²€ìƒ‰... (í…ìŠ¤íŠ¸, ìŒì„± ì§€ì›)';
        }, 2000);
      };

      recognition.onend = () => {
        searchInput.classList.remove('border-purple-500', 'bg-purple-900/20');
      };

      recognition.start();
    }

    // AI ì´ë¯¸ì§€ ê²€ìƒ‰ ì„¤ì •
    const aiUploadArea = document.getElementById('aiUploadArea');
    const aiImageInput = document.getElementById('aiImageInput');
    const aiImagePreview = document.getElementById('aiImagePreview');
    const aiPreviewImg = document.getElementById('aiPreviewImg');

    aiUploadArea.addEventListener('click', () => aiImageInput.click());
    
    aiImageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          aiPreviewImg.src = event.target.result;
          aiUploadArea.classList.add('hidden');
          aiImagePreview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    });

    // AI ê²€ìƒ‰ ìˆ˜í–‰ (ë©”ì¸ í˜ì´ì§€ìš©)
    async function performAISearch() {
      const searchInput = document.getElementById('aiSearchInput');
      const query = searchInput?.value?.trim();
      
      if (!query) {
        alert('ğŸ” ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // AI ë¶„ì„ ì¤‘ í‘œì‹œ
      searchInput.placeholder = 'ğŸ¤– AIê°€ ì‘í’ˆì„ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
      searchInput.disabled = true;
      
      try {
        // API í˜¸ì¶œí•˜ì—¬ ê²€ìƒ‰
        const response = await axios.get('/api/artworks', {
          params: {
            search: query,
            limit: 20
          }
        });
        
        const artworks = response.data.data || [];
        
        if (artworks.length > 0) {
          // ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ê°¤ëŸ¬ë¦¬ í˜ì´ì§€ë¡œ ì´ë™
          window.location.href = '/gallery?search=' + encodeURIComponent(query);
        } else {
          alert('âŒ "' + query + '"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.\\n\\në‹¤ë¥¸ ê²€ìƒ‰ì–´ë¡œ ì‹œë„í•´ë³´ì„¸ìš”.');
          searchInput.value = '';
        }
      } catch (error) {
        console.error('Search error:', error);
        alert('âŒ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      } finally {
        searchInput.disabled = false;
        searchInput.placeholder = 'AIë¡œ ì‘í’ˆ ê²€ìƒ‰... (í…ìŠ¤íŠ¸, ìŒì„± ì§€ì›)';
      }
    }

    // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
    function displaySearchResults(artworks) {
      const resultsSection = document.getElementById('searchResults');
      const resultsGrid = document.getElementById('resultsGrid');
      
      if (artworks.length === 0) {
        resultsGrid.innerHTML = '<p class="text-gray-400 col-span-full text-center py-12">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
        resultsSection.classList.remove('hidden');
        return;
      }

      resultsGrid.innerHTML = artworks.map(art => \`
        <a href="/artwork/\${art.id}" class="card-nft rounded-2xl overflow-hidden group">
          <div class="relative aspect-square bg-gray-900 overflow-hidden">
            <img src="\${art.image_url}" alt="\${art.title}" class="w-full h-full object-cover img-nft" loading="lazy">
          </div>
          <div class="p-4">
            <h3 class="font-bold text-white mb-2 truncate">\${art.title}</h3>
            <p class="text-sm text-gray-400">\${art.artist_name}</p>
          </div>
        </a>
      \`).join('');
      
      resultsSection.classList.remove('hidden');
    }

    // ì „ë¬¸ê°€ ì¶”ì²œ ì‘í’ˆ ë¡œë“œ
    async function loadExpertRecommendations() {
      try {
        const response = await axios.get('/api/artworks?sort=estimated_value&order=DESC&limit=8');
        const artworks = response.data.data || [];
        
        const container = document.getElementById('expertRecommendations');
        if (artworks.length === 0) {
          container.innerHTML = '<p class="text-gray-400 col-span-full text-center py-12">ì¶”ì²œ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤</p>';
          return;
        }

        container.innerHTML = artworks.map(art => \`
          <a href="/artwork/\${art.id}" class="card-nft rounded-2xl overflow-hidden group">
            <div class="relative aspect-square bg-gray-900 overflow-hidden">
              <img src="\${art.image_url}" alt="\${art.title}" class="w-full h-full object-cover img-nft" loading="lazy">
              <div class="absolute top-3 left-3">
                <span class="px-3 py-1 bg-gradient-to-r from-yellow-600 to-orange-600 text-white text-xs font-bold rounded-full flex items-center">
                  <i class="fas fa-star mr-1"></i>ì „ë¬¸ê°€ ì¶”ì²œ
                </span>
              </div>
            </div>
            <div class="p-4">
              <h3 class="font-bold text-white mb-2 truncate">\${art.title}</h3>
              <div class="flex items-center justify-between">
                <span class="text-sm text-gray-400">\${art.artist_name}</span>
                <span class="text-xs text-gradient font-bold">\${art.category || ''}</span>
              </div>
            </div>
          </a>
        \`).join('');
      } catch (error) {
        console.error('Failed to load recommendations:', error);
        document.getElementById('expertRecommendations').innerHTML = 
          '<p class="text-red-500 col-span-full text-center py-12">ì¶”ì²œ ì‘í’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</p>';
      }
    }

    // ì—”í„°í‚¤ë¡œ ê²€ìƒ‰
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performSearch();
      }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì „ë¬¸ê°€ ì¶”ì²œ ì‘í’ˆ ë¡œë“œ
    document.addEventListener('DOMContentLoaded', loadExpertRecommendations);
  </script>
  `;
  
  return c.html(getLayout(content, 'ìŠ¤ë§ˆíŠ¸ ê²€ìƒ‰ - GALLERYPIA'))
})

// /artists ë¦¬ë‹¤ì´ë ‰íŠ¸ (ì•„í‹°ìŠ¤íŠ¸ ê¸°ëŠ¥ì€ /leaderboardë¡œ í†µí•©)
app.get('/artists', (c) => {
  return c.redirect('/leaderboard')
})

// Legacy artists í˜ì´ì§€ (ì‚¬ìš© ì•ˆ í•¨)
app.get('/artists-old', (c) => {
  const content = `
  <section class="py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <!-- í—¤ë” -->
          <div class="text-center mb-12">
              <h1 class="text-6xl font-black mb-4">
                  <span class="text-gradient">ì•„í‹°ìŠ¤íŠ¸</span>
              </h1>
              <p class="text-gray-400 text-lg">ë¸”ë¡ì²´ì¸ ê¸°ë°˜ NFT ì‘í’ˆì„ ì°½ì‘í•˜ëŠ” ì•„í‹°ìŠ¤íŠ¸ë“¤</p>
          </div>
          
          <!-- íë ˆì´í„° ì¶”ì²œ ì•„í‹°ìŠ¤íŠ¸ -->
          <div class="mb-20">
              <div class="flex items-center justify-between mb-8">
                  <h2 class="text-3xl font-black text-white flex items-center">
                      <i class="fas fa-star text-yellow-400 mr-3"></i>
                      íë ˆì´í„° ì¶”ì²œ ì•„í‹°ìŠ¤íŠ¸
                  </h2>
                  <a href="/leaderboard" class="text-cyan-400 hover:text-cyan-300 text-sm font-semibold flex items-center transition-colors">
                      ì „ì²´ ë­í‚¹ ë³´ê¸° <i class="fas fa-arrow-right ml-2"></i>
                  </a>
              </div>
              <div id="curatorRecommended" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                  <p class="text-gray-400 text-center col-span-full">ë¡œë”© ì¤‘...</p>
              </div>
          </div>
          
          <!-- ì¸ê¸° ì•„í‹°ìŠ¤íŠ¸ (Most Popular) -->
          <div class="mb-20">
              <div class="flex items-center justify-between mb-8">
                  <h2 class="text-3xl font-black text-white flex items-center">
                      <i class="fas fa-fire text-orange-400 mr-3"></i>
                      ì¸ê¸° ì•„í‹°ìŠ¤íŠ¸
                  </h2>
              </div>
              <div id="popularArtists" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                  <p class="text-gray-400 text-center col-span-full">ë¡œë”© ì¤‘...</p>
              </div>
          </div>
          
          <!-- ì‹ ê·œ ì•„í‹°ìŠ¤íŠ¸ (New Artists) -->
          <div class="mb-12">
              <div class="flex items-center justify-between mb-8">
                  <h2 class="text-3xl font-black text-white flex items-center">
                      <i class="fas fa-seedling text-green-400 mr-3"></i>
                      ì‹ ê·œ ì•„í‹°ìŠ¤íŠ¸
                  </h2>
              </div>
              <div id="newArtists" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                  <p class="text-gray-400 text-center col-span-full">ë¡œë”© ì¤‘...</p>
              </div>
          </div>
      </div>
  </section>
  
  <script>
    // íë ˆì´í„° ì¶”ì²œ ì•„í‹°ìŠ¤íŠ¸ ë¡œë“œ (Top 3 from leaderboard)
    async function loadCuratorRecommended() {
      try {
        const response = await axios.get('/api/artist/leaderboard?limit=3&category=master');
        const artists = response.data.data || [];
        
        const container = document.getElementById('curatorRecommended');
        if (artists.length === 0) {
          container.innerHTML = '<p class="text-gray-400 text-center col-span-full">ì¶”ì²œ ì•„í‹°ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        container.innerHTML = artists.map((artist, index) => {
          const rankBadge = getRankBadgeHTML(artist.rank_tier, artist.rank_grade, artist.rank_category);
          const rankIcon = index === 0 ? 
            \`<i class="fas fa-trophy text-yellow-400 text-2xl"></i>\` :
            index === 1 ? \`<i class="fas fa-trophy text-gray-400 text-2xl"></i>\` :
            \`<i class="fas fa-trophy text-orange-400 text-2xl"></i>\`;
          
          return \`
            <div class="group card-nft rounded-3xl overflow-hidden hover:scale-[1.02] transition-transform duration-300">
                <!-- Header with Gradient -->
                <div class="relative h-48 bg-gradient-to-br from-amber-900 via-orange-900 to-yellow-900">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent"></div>
                    <div class="absolute top-4 right-4">
                        \${rankIcon}
                    </div>
                    <div class="absolute bottom-4 left-4">
                        <span class="text-amber-300 text-sm font-bold">íë ˆì´í„° ì¶”ì²œ #\${index + 1}</span>
                    </div>
                </div>
                
                <!-- Profile Section -->
                <div class="p-6 -mt-16 relative z-10">
                    <div class="w-28 h-28 rounded-full border-4 border-black mb-4 overflow-hidden bg-gradient-to-br from-amber-500 to-orange-600 ring-2 ring-amber-400/50">
                        <img src="\${artist.profile_image || 'https://via.placeholder.com/112'}" loading="lazy" 
                             alt="\${artist.full_name || artist.username}" 
                             class="w-full h-full object-cover">
                    </div>
                    
                    <h3 class="font-bold text-2xl text-white mb-2">\${artist.full_name || artist.username}</h3>
                    <p class="text-gray-400 text-sm mb-3">@\${artist.username || 'unknown'}</p>
                    
                    <!-- Rank Badge -->
                    <div class="mb-4">
                        \${rankBadge}
                    </div>
                    
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-3 gap-4 mb-4 p-4 bg-white/5 rounded-xl">
                        <div class="text-center">
                            <div class="text-xl font-bold text-purple-400">\${artist.quantitative_weighted_score.toFixed(1)}</div>
                            <div class="text-xs text-gray-500">ì •ëŸ‰</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xl font-bold text-cyan-400">\${artist.qualitative_weighted_score.toFixed(1)}</div>
                            <div class="text-xs text-gray-500">ì •ì„±</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xl font-bold text-pink-400">\${artist.popularity_weighted_score.toFixed(1)}</div>
                            <div class="text-xs text-gray-500">ì¸ê¸°</div>
                        </div>
                    </div>
                    
                    <!-- Total Score -->
                    <div class="text-center p-3 bg-gradient-to-r from-amber-900/30 to-orange-900/30 rounded-xl border border-amber-500/30">
                        <div class="text-xs text-amber-400 mb-1">ì¢…í•©ì ìˆ˜</div>
                        <div class="text-3xl font-black text-gradient">\${artist.final_score.toFixed(1)}</div>
                    </div>
                </div>
            </div>
          \`;
        }).join('');
      } catch (error) {
        console.error('Failed to load curator recommended:', error);
        document.getElementById('curatorRecommended').innerHTML = 
          '<p class="text-red-500 text-center col-span-full">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }
    
    // ì¸ê¸° ì•„í‹°ìŠ¤íŠ¸ ë¡œë“œ (Highest popularity score)
    async function loadPopularArtists() {
      try {
        const response = await axios.get('/api/artist/leaderboard?limit=50');
        let artists = response.data.data || [];
        
        // Sort by popularity score descending
        artists = artists.sort((a, b) => b.popularity_weighted_score - a.popularity_weighted_score).slice(0, 4);
        
        const container = document.getElementById('popularArtists');
        if (artists.length === 0) {
          container.innerHTML = '<p class="text-gray-400 text-center col-span-full">ì¸ê¸° ì•„í‹°ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        container.innerHTML = artists.map(artist => {
          const rankBadge = getRankBadgeHTML(artist.rank_tier, artist.rank_grade, artist.rank_category);
          return \`
            <div class="group card-nft rounded-3xl overflow-hidden hover:scale-[1.02] transition-transform duration-300">
                <div class="relative h-40 bg-gradient-to-br from-orange-900 via-red-900 to-pink-900">
                    <div class="absolute inset-0 bg-gradient-to-t from-black to-transparent"></div>
                    <div class="absolute top-3 right-3">
                        <i class="fas fa-fire text-orange-400 text-xl"></i>
                    </div>
                </div>
                <div class="p-5 -mt-12 relative z-10">
                    <div class="w-20 h-20 rounded-full border-4 border-black mb-3 overflow-hidden bg-gradient-to-br from-orange-500 to-pink-600">
                        <img src="\${artist.profile_image || 'https://via.placeholder.com/80'}" loading="lazy" 
                             alt="\${artist.full_name || artist.username}" 
                             class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-bold text-lg text-white mb-1 truncate">\${artist.full_name || artist.username}</h3>
                    <p class="text-gray-400 text-xs mb-3 truncate">@\${artist.username || 'unknown'}</p>
                    <div class="mb-3">\${rankBadge}</div>
                    <div class="flex items-center justify-between p-3 bg-orange-900/20 rounded-xl border border-orange-500/30">
                        <span class="text-xs text-orange-300">ì¸ê¸°ë„</span>
                        <span class="text-lg font-black text-orange-400">\${artist.popularity_weighted_score.toFixed(1)}</span>
                    </div>
                </div>
            </div>
          \`;
        }).join('');
      } catch (error) {
        console.error('Failed to load popular artists:', error);
        document.getElementById('popularArtists').innerHTML = 
          '<p class="text-red-500 text-center col-span-full">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }
    
    // ì‹ ê·œ ì•„í‹°ìŠ¤íŠ¸ ë¡œë“œ (Most recent registrations or emerging category)
    async function loadNewArtists() {
      try {
        const response = await axios.get('/api/artist/leaderboard?limit=50&category=emerging');
        let artists = response.data.data || [];
        
        // If no emerging artists, get last 4 from all artists
        if (artists.length === 0) {
          const allResponse = await axios.get('/api/artists?limit=4');
          artists = allResponse.data.data || [];
        } else {
          artists = artists.slice(0, 4);
        }
        
        const container = document.getElementById('newArtists');
        if (artists.length === 0) {
          container.innerHTML = '<p class="text-gray-400 text-center col-span-full">ì‹ ê·œ ì•„í‹°ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        container.innerHTML = artists.map(artist => {
          const rankBadge = artist.rank_tier ? getRankBadgeHTML(artist.rank_tier, artist.rank_grade, artist.rank_category) : 
            '<span class="px-3 py-1 bg-green-900/30 text-green-300 text-xs font-bold rounded-full border border-green-500/30">ì‹ ì§„ì‘ê°€</span>';
          
          return \`
            <div class="group card-nft rounded-3xl overflow-hidden hover:scale-[1.02] transition-transform duration-300">
                <div class="relative h-40 bg-gradient-to-br from-green-900 via-emerald-900 to-teal-900">
                    <div class="absolute inset-0 bg-gradient-to-t from-black to-transparent"></div>
                    <div class="absolute top-3 right-3">
                        <i class="fas fa-seedling text-green-400 text-xl"></i>
                    </div>
                    <div class="absolute top-3 left-3">
                        <span class="px-2 py-1 bg-green-600 text-white text-xs font-bold rounded-full">NEW</span>
                    </div>
                </div>
                <div class="p-5 -mt-12 relative z-10">
                    <div class="w-20 h-20 rounded-full border-4 border-black mb-3 overflow-hidden bg-gradient-to-br from-green-500 to-teal-600">
                        <img src="\${artist.profile_image || 'https://via.placeholder.com/80'}" loading="lazy" 
                             alt="\${artist.full_name || artist.name || artist.username}" 
                             class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-bold text-lg text-white mb-1 truncate">\${artist.full_name || artist.name || artist.username}</h3>
                    <p class="text-gray-400 text-xs mb-3 truncate">@\${artist.username || 'unknown'}</p>
                    <div class="mb-3">\${rankBadge}</div>
                    <div class="grid grid-cols-2 gap-2 text-center">
                        <div class="p-2 bg-green-900/20 rounded-lg border border-green-500/20">
                            <div class="text-xs text-green-400">ì‘í’ˆ</div>
                            <div class="text-base font-bold text-white">\${artist.artwork_count || 0}</div>
                        </div>
                        <div class="p-2 bg-green-900/20 rounded-lg border border-green-500/20">
                            <div class="text-xs text-green-400">ì ìˆ˜</div>
                            <div class="text-base font-bold text-white">\${artist.final_score ? artist.final_score.toFixed(1) : 'N/A'}</div>
                        </div>
                    </div>
                </div>
            </div>
          \`;
        }).join('');
      } catch (error) {
        console.error('Failed to load new artists:', error);
        document.getElementById('newArtists').innerHTML = 
          '<p class="text-red-500 text-center col-span-full">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë“  ì„¹ì…˜ ë¡œë“œ
    document.addEventListener('DOMContentLoaded', () => {
      loadCuratorRecommended();
      loadPopularArtists();
      loadNewArtists();
    });
  </script>
  <script src="/static/artist-rank.js"></script>
  `;
  
  return c.html(getLayout(content, 'ì•„í‹°ìŠ¤íŠ¸ - GALLERYPIA'))
})

// /collections ë¦¬ë‹¤ì´ë ‰íŠ¸ (ì»¬ë ‰ì…˜ ê¸°ëŠ¥ì€ /galleryë¡œ í†µí•©)
app.get('/collections', (c) => {
  return c.redirect('/gallery')
})

// Legacy collections í˜ì´ì§€ (ì‚¬ìš© ì•ˆ í•¨)
app.get('/collections-old', (c) => {
  const content = `
  <section class="py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <h1 class="text-6xl font-black mb-4">
              <span class="text-gradient">ì»¬ë ‰ì…˜</span>
          </h1>
          <p class="text-gray-400 mb-12 text-lg">íë ˆì´í„°ê°€ ì—„ì„ í•œ NFT ì‘í’ˆ ì»¬ë ‰ì…˜</p>
          
          <div id="collectionsList" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <p class="text-gray-400 text-center col-span-full">ë¡œë”© ì¤‘...</p>
          </div>
      </div>
  </section>
  
  <script>
    async function loadCollections() {
      try {
        const response = await axios.get('/api/collections');
        const collections = response.data.data || [];
        
        const list = document.getElementById('collectionsList');
        if (collections.length === 0) {
          list.innerHTML = '<p class="text-gray-400 text-center col-span-full">ë“±ë¡ëœ ì»¬ë ‰ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        list.innerHTML = collections.map(collection => \`
          <div class="card-nft rounded-3xl overflow-hidden">
              <div class="relative h-64 bg-gray-900">
                  <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent"></div>
                  <div class="absolute bottom-4 left-4 right-4">
                      <h3 class="font-bold text-3xl text-white mb-2">\${collection.name}</h3>
                  </div>
              </div>
              <div class="p-6">
                  <p class="text-gray-400 mb-4">\${collection.description || 'ì»¬ë ‰ì…˜ ì„¤ëª…'}</p>
                  
                  <div class="flex items-center justify-between mb-4">
                      <div>
                          <div class="text-xs text-gray-500 mb-1">íë ˆì´í„°</div>
                          <div class="text-white font-semibold">\${collection.curator_name || 'ìµëª…'}</div>
                      </div>
                      <div class="text-right">
                          <div class="text-xs text-gray-500 mb-1">ì‘í’ˆ ìˆ˜</div>
                          <div class="text-2xl font-black text-gradient">\${collection.artwork_count || 0}</div>
                      </div>
                  </div>
              </div>
          </div>
        \`).join('');
      } catch (error) {
        document.getElementById('collectionsList').innerHTML = '<p class="text-red-500 text-center col-span-full">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }
    
    document.addEventListener('DOMContentLoaded', loadCollections);
  </script>
  `;
  
  return c.html(getLayout(content, 'ì»¬ë ‰ì…˜ - GALLERYPIA'))
})

// ============================================
// íšŒì›ê°€ì… í˜ì´ì§€
// ============================================
app.get('/signup', (c) => {
  const content = `
  <section id="main-content" class="min-h-screen py-20" tabindex="-1">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-12">
              <h1 class="text-5xl font-black mb-4">
                  <span class="text-gradient">íšŒì›ê°€ì…</span>
              </h1>
              <p class="text-xl text-gray-400">ê°¤ëŸ¬ë¦¬í”¼ì•„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</p>
          </div>
          
          <div class="card-nft rounded-3xl p-8 md:p-12">
              <div id="alertMessage" class="hidden mb-6"></div>
              
              <!-- SNS ë¡œê·¸ì¸ ìš°ì„  -->
              <div class="mb-8">
                  <div class="text-center mb-4">
                      <p class="text-gray-400 text-sm">ê°„í¸í•˜ê²Œ ì‹œì‘í•˜ê¸°</p>
                  </div>
                  <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
                      <button type="button" onclick="loginWithGoogle()" class="py-3 px-4 bg-white hover:bg-gray-100 rounded-lg font-semibold text-gray-800 flex items-center justify-center transition-all shadow-lg hover:shadow-xl">
                          <i class="fab fa-google mr-2 text-red-500"></i>
                          <span class="hidden md:inline">Google</span>
                      </button>
                      <button type="button" onclick="loginWithKakao()" class="py-3 px-4 bg-yellow-400 hover:bg-yellow-500 rounded-lg font-semibold text-gray-800 flex items-center justify-center transition-all shadow-lg hover:shadow-xl">
                          <i class="fas fa-comment mr-2"></i>
                          <span class="hidden md:inline">Kakao</span>
                      </button>
                      <button type="button" onclick="loginWithNaver()" class="py-3 px-4 bg-green-500 hover:bg-green-600 rounded-lg font-semibold text-white flex items-center justify-center transition-all shadow-lg hover:shadow-xl">
                          <span class="font-bold mr-2">N</span>
                          <span class="hidden md:inline">Naver</span>
                      </button>
                      <button type="button" onclick="loginWithApple()" class="py-3 px-4 bg-black hover:bg-gray-900 rounded-lg font-semibold text-white flex items-center justify-center transition-all shadow-lg hover:shadow-xl border border-white border-opacity-20">
                          <i class="fab fa-apple mr-2"></i>
                          <span class="hidden md:inline">Apple</span>
                      </button>
                      <button type="button" onclick="loginWithFacebook()" class="py-3 px-4 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold text-white flex items-center justify-center transition-all shadow-lg hover:shadow-xl">
                          <i class="fab fa-facebook-f mr-2"></i>
                          <span class="hidden md:inline">Facebook</span>
                      </button>
                  </div>
                  <div class="relative">
                      <div class="absolute inset-0 flex items-center">
                          <div class="w-full border-t border-white border-opacity-10"></div>
                      </div>
                      <div class="relative flex justify-center text-sm">
                          <span class="px-4 bg-black text-gray-500">ë˜ëŠ” ì´ë©”ì¼ë¡œ ê°€ì…</span>
                      </div>
                  </div>
              </div>
              
              <form id="signupForm" class="space-y-6">
                  <!-- ê¸°ë³¸ ì •ë³´ -->
                  <div>
                      <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                          <i class="fas fa-user mr-3 text-gradient"></i>
                          ê¸°ë³¸ ì •ë³´
                      </h3>
                      
                      <div class="grid md:grid-cols-2 gap-6">
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-envelope mr-2"></i>ì´ë©”ì¼ *
                              </label>
                              <input type="email" name="email" required
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                                     placeholder="your@email.com">
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-user-tag mr-2"></i>ì‚¬ìš©ìëª… *
                              </label>
                              <input type="text" name="username" required
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                                     placeholder="username">
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-id-card mr-2"></i>ì´ë¦„ *
                              </label>
                              <input type="text" name="full_name" required
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                                     placeholder="í™ê¸¸ë™">
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-phone mr-2"></i>ì „í™”ë²ˆí˜¸
                              </label>
                              <input type="tel" name="phone"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                                     placeholder="010-1234-5678">
                          </div>
                          
                          <div class="md:col-span-2">
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-lock mr-2"></i>ë¹„ë°€ë²ˆí˜¸ *
                              </label>
                              <input type="password" name="password" required minlength="8"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                                     placeholder="ìµœì†Œ 8ì ì´ìƒ">
                          </div>
                          
                          <div class="md:col-span-2">
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-lock mr-2"></i>ë¹„ë°€ë²ˆí˜¸ í™•ì¸ *
                              </label>
                              <input type="password" name="confirm_password" required minlength="8"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                                     placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”">
                          </div>
                      </div>
                  </div>
                  
                  <!-- ì—­í•  ì„ íƒ -->
                  <div>
                      <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                          <i class="fas fa-user-shield mr-3 text-gradient"></i>
                          ê³„ì • ìœ í˜• ì„ íƒ
                      </h3>
                      
                      <div class="grid md:grid-cols-2 gap-4">
                          <label class="relative cursor-pointer">
                              <input type="radio" name="role" value="buyer" checked class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-purple-500 peer-checked:bg-purple-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="flex items-center mb-3">
                                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 flex items-center justify-center mr-4">
                                          <i class="fas fa-shopping-cart text-white text-xl"></i>
                                      </div>
                                      <div class="text-xl font-bold text-white">êµ¬ë§¤ì</div>
                                  </div>
                                  <p class="text-sm text-gray-400">NFT ì‘í’ˆì„ êµ¬ë§¤í•˜ê³  ì†Œì¥í•©ë‹ˆë‹¤</p>
                              </div>
                          </label>
                          
                          <label class="relative cursor-pointer">
                              <input type="radio" name="role" value="seller" class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-green-500 peer-checked:bg-green-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="flex items-center mb-3">
                                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 flex items-center justify-center mr-4">
                                          <i class="fas fa-store text-white text-xl"></i>
                                      </div>
                                      <div class="text-xl font-bold text-white">íŒë§¤ì</div>
                                  </div>
                                  <p class="text-sm text-gray-400">NFT ì‘í’ˆì„ íŒë§¤í•˜ê³  ê±°ë˜í•©ë‹ˆë‹¤</p>
                              </div>
                          </label>
                          
                          <label class="relative cursor-pointer">
                              <input type="radio" name="role" value="artist" class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-amber-500 peer-checked:bg-amber-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="flex items-center mb-3">
                                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-amber-500 to-orange-500 flex items-center justify-center mr-4">
                                          <i class="fas fa-palette text-white text-xl"></i>
                                      </div>
                                      <div class="text-xl font-bold text-white">ë¯¸ìˆ ì‘ê°€</div>
                                  </div>
                                  <p class="text-sm text-gray-400">ì‘í’ˆì„ ë“±ë¡í•˜ê³  NFTë¡œ ë¯¼íŒ…í•©ë‹ˆë‹¤</p>
                              </div>
                          </label>
                          
                          <label class="relative cursor-pointer">
                              <input type="radio" name="role" value="expert" class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-purple-500 peer-checked:bg-purple-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="flex items-center mb-3">
                                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center mr-4">
                                          <i class="fas fa-user-tie text-white text-xl"></i>
                                      </div>
                                      <div class="text-xl font-bold text-white">ì „ë¬¸ê°€</div>
                                  </div>
                                  <p class="text-sm text-gray-400">ì‘í’ˆì„ í‰ê°€í•˜ê³  ETH ë³´ìƒì„ ë°›ìŠµë‹ˆë‹¤</p>
                                  <p class="text-xs text-amber-400 mt-2"><i class="fas fa-coins mr-1"></i>í‰ê°€ë‹¹ 0.01-0.1 ETH ë³´ìƒ</p>
                              </div>
                          </label>
                          
                          <label class="relative cursor-pointer">
                              <input type="radio" name="role" value="museum" class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-rose-500 peer-checked:bg-rose-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="flex items-center mb-3">
                                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-rose-500 to-red-500 flex items-center justify-center mr-4">
                                          <i class="fas fa-landmark text-white text-xl"></i>
                                      </div>
                                      <div class="text-xl font-bold text-white">ë®¤ì§€ì—„</div>
                                  </div>
                                  <p class="text-sm text-gray-400">ì „ì‹œë¥¼ ê¸°íší•˜ê³  ì‘í’ˆì„ íë ˆì´ì…˜í•©ë‹ˆë‹¤</p>
                              </div>
                          </label>
                          
                          <label class="relative cursor-pointer">
                              <input type="radio" name="role" value="gallery" class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-teal-500 peer-checked:bg-teal-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="flex items-center mb-3">
                                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-teal-500 to-cyan-500 flex items-center justify-center mr-4">
                                          <i class="fas fa-building-columns text-white text-xl"></i>
                                      </div>
                                      <div class="text-xl font-bold text-white">ê°¤ëŸ¬ë¦¬</div>
                                  </div>
                                  <p class="text-sm text-gray-400">ì‘í’ˆì„ ì „ì‹œí•˜ê³  ê±°ë˜ë¥¼ ì¤‘ê°œí•©ë‹ˆë‹¤</p>
                              </div>
                          </label>
                      </div>
                  </div>
                  
                  <!-- ì‘ê°€ ì¶”ê°€ ì •ë³´ -->
                  <div id="artist-fields" class="role-specific hidden">
                      <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                          <i class="fas fa-palette mr-3 text-gradient"></i>
                          ì‘ê°€ í”„ë¡œí•„ ì •ë³´
                      </h3>
                      
                      <div class="grid md:grid-cols-2 gap-6">
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">ì‘í’ˆ ìŠ¤íƒ€ì¼</label>
                              <input type="text" name="art_style"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="ì˜ˆ: ì¶”ìƒí™”, ì‚¬ì‹¤ì£¼ì˜">
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">ì£¼ìš” ë§¤ì²´</label>
                              <input type="text" name="major_medium"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="ì˜ˆ: ìœ í™”, ë””ì§€í„¸">
                          </div>
                          
                          <div class="md:col-span-2">
                              <label class="block text-sm font-medium text-gray-300 mb-2">ì›¹ì‚¬ì´íŠ¸/í¬íŠ¸í´ë¦¬ì˜¤</label>
                              <input type="url" name="website"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="https://your-portfolio.com">
                          </div>
                          
                          <div class="md:col-span-2">
                              <label class="block text-sm font-medium text-gray-300 mb-2">ìê¸°ì†Œê°œ</label>
                              <textarea name="bio" rows="3"
                                        class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                        placeholder="ì‘ê°€ë¡œì„œì˜ ë¹„ì „ê³¼ ì² í•™ì„ ê°„ë‹¨íˆ ì†Œê°œí•´ì£¼ì„¸ìš”"></textarea>
                          </div>
                      </div>
                  </div>
                  
                  <!-- ì „ë¬¸ê°€ ì•ˆë‚´ -->
                  <div id="expert-fields" class="role-specific hidden">
                      <div class="bg-amber-500 bg-opacity-10 border border-amber-500 border-opacity-30 rounded-lg p-6">
                          <h3 class="text-xl font-bold text-amber-400 mb-3 flex items-center">
                              <i class="fas fa-coins mr-3"></i>
                              ì „ë¬¸ê°€ í‰ê°€ ë³´ìƒ ì‹œìŠ¤í…œ
                          </h3>
                          <p class="text-gray-300 mb-4">ì‘í’ˆ í‰ê°€ ì‹œ ETHë¡œ ë³´ìƒì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                          <ul class="space-y-2 text-sm text-gray-400">
                              <li class="flex items-start">
                                  <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                                  <span>ì‘í’ˆ í‰ê°€ë‹¹ 0.01 ~ 0.1 ETH ë³´ìƒ</span>
                              </li>
                              <li class="flex items-start">
                                  <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                                  <span>ì •í™•í•˜ê³  ìƒì„¸í•œ í‰ê°€ì¼ìˆ˜ë¡ ë†’ì€ ë³´ìƒ</span>
                              </li>
                              <li class="flex items-start">
                                  <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                                  <span>í‰ê°€ ì™„ë£Œ í›„ ì¦‰ì‹œ ì§€ê°‘ìœ¼ë¡œ ì§€ê¸‰</span>
                              </li>
                              <li class="flex items-start">
                                  <i class="fas fa-info-circle text-blue-400 mr-2 mt-1"></i>
                                  <span>ì „ë¬¸ê°€ ë“±ê¸‰ì— ë”°ë¼ ë³´ìƒê¸ˆ ì°¨ë“± ì§€ê¸‰</span>
                              </li>
                          </ul>
                      </div>
                  </div>
                  
                  <!-- Museum/Gallery ì¶”ê°€ ì •ë³´ -->
                  <div id="museum-gallery-fields" class="role-specific hidden">
                      <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                          <i class="fas fa-building mr-3 text-gradient"></i>
                          ê¸°ê´€ ì •ë³´
                      </h3>
                      
                      <div class="grid md:grid-cols-2 gap-6">
                          <div class="md:col-span-2">
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-building mr-2"></i>ê¸°ê´€ëª… *
                              </label>
                              <input type="text" name="organization_name"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="ì˜ˆ: ì„œìš¸ í˜„ëŒ€ë¯¸ìˆ ê´€">
                          </div>
                          
                          <div class="md:col-span-2">
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-map-marker-alt mr-2"></i>ì£¼ì†Œ
                              </label>
                              <input type="text" name="organization_address"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="ê¸°ê´€ ì£¼ì†Œ">
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-globe mr-2"></i>ì›¹ì‚¬ì´íŠ¸
                              </label>
                              <input type="url" name="organization_website"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="https://museum.example.com">
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-envelope mr-2"></i>ê¸°ê´€ ì´ë©”ì¼
                              </label>
                              <input type="email" name="organization_contact_email"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="contact@museum.com">
                          </div>
                          
                          <div class="md:col-span-2">
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-info-circle mr-2"></i>ê¸°ê´€ ì†Œê°œ
                              </label>
                              <textarea name="organization_description" rows="3"
                                        class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                        placeholder="ê¸°ê´€ì˜ ë¹„ì „ê³¼ íŠ¹ì§•ì„ ê°„ë‹¨íˆ ì†Œê°œí•´ì£¼ì„¸ìš”"></textarea>
                          </div>
                      </div>
                  </div>
                  
                  <!-- ì•½ê´€ ë™ì˜ -->
                  <div class="space-y-3">
                      <label class="flex items-start">
                          <input type="checkbox" id="terms-required" required class="w-5 h-5 rounded bg-white bg-opacity-5 border-white border-opacity-10 text-purple-600 focus:ring-purple-500 mr-3 mt-0.5">
                          <span class="text-sm text-gray-300">
                              (í•„ìˆ˜) <a href="/terms.html" target="_blank" class="text-purple-400 hover:text-purple-300 underline">ì´ìš©ì•½ê´€</a> ë° 
                              <a href="/privacy.html" target="_blank" class="text-purple-400 hover:text-purple-300 underline">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>ì— ë™ì˜í•©ë‹ˆë‹¤
                          </span>
                      </label>
                      <label class="flex items-start">
                          <input type="checkbox" id="marketing-optional" class="w-5 h-5 rounded bg-white bg-opacity-5 border-white border-opacity-10 text-purple-600 focus:ring-purple-500 mr-3 mt-0.5">
                          <span class="text-sm text-gray-300">(ì„ íƒ) ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹ ì— ë™ì˜í•©ë‹ˆë‹¤</span>
                      </label>
                  </div>
                  
                  <!-- ì œì¶œ ë²„íŠ¼ -->
                  <div class="flex flex-col sm:flex-row gap-4 pt-6">
                      <button type="submit" 
                              class="flex-1 gradient-primary text-white py-4 rounded-xl font-bold text-lg hover:opacity-90 transition transform hover:scale-105">
                          <i class="fas fa-user-plus mr-2"></i>
                          íšŒì›ê°€ì…
                      </button>
                      <a href="/login" 
                         class="flex-1 bg-white bg-opacity-5 text-white py-4 rounded-xl font-bold text-lg hover:bg-opacity-10 transition text-center">
                          <i class="fas fa-sign-in-alt mr-2"></i>
                          ë¡œê·¸ì¸í•˜ê¸°
                      </a>
                  </div>
              </form>
          </div>
      </div>
  </section>
  
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  <script src="/static/auth-improved.js"></script>
  <script src="/static/social-login.js"></script>
  
  <script>
    // ê³„ì • ìœ í˜•ë³„ ë™ì  ì…ë ¥ í¼ í‘œì‹œ
    document.addEventListener('DOMContentLoaded', function() {
      const roleInputs = document.querySelectorAll('input[name="role"]');
      const roleSpecificSections = {
        'artist': document.getElementById('artist-fields'),
        'expert': document.getElementById('expert-fields'),
        'museum': document.getElementById('museum-gallery-fields'),
        'gallery': document.getElementById('museum-gallery-fields')
      };
      
      // ì—­í•  ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      roleInputs.forEach(input => {
        input.addEventListener('change', function() {
          // ëª¨ë“  ì—­í• ë³„ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
          Object.values(roleSpecificSections).forEach(section => {
            if (section) {
              section.classList.add('hidden');
              // ìˆ¨ê²¨ì§„ í•„ë“œì˜ required ì†ì„± ì œê±°
              const requiredInputs = section.querySelectorAll('[required]');
              requiredInputs.forEach(inp => {
                inp.removeAttribute('required');
                inp.dataset.wasRequired = 'true';
              });
            }
          });
          
          // ì„ íƒëœ ì—­í• ì˜ ì„¹ì…˜ í‘œì‹œ
          const selectedRole = this.value;
          const sectionToShow = roleSpecificSections[selectedRole];
          
          if (sectionToShow) {
            sectionToShow.classList.remove('hidden');
            // í‘œì‹œëœ í•„ë“œì— required ì†ì„± ë³µêµ¬
            const inputs = sectionToShow.querySelectorAll('[data-was-required="true"]');
            inputs.forEach(inp => {
              inp.setAttribute('required', 'required');
            });
            
            // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
            sectionToShow.style.opacity = '0';
            sectionToShow.style.transform = 'translateY(20px)';
            setTimeout(() => {
              sectionToShow.style.transition = 'all 0.3s ease-out';
              sectionToShow.style.opacity = '1';
              sectionToShow.style.transform = 'translateY(0)';
            }, 10);
          }
          
          // ì—­í• ë³„ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
          showRoleGuidance(selectedRole);
        });
      });
      
      // ì—­í• ë³„ ì•ˆë‚´ ë©”ì‹œì§€ í•¨ìˆ˜
      function showRoleGuidance(role) {
        const guidanceMessages = {
          'buyer': {
            icon: 'shopping-cart',
            color: 'blue',
            title: 'êµ¬ë§¤ì íšŒì›',
            message: 'NFT ì‘í’ˆì„ êµ¬ë§¤í•˜ê³  ì†Œì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë©”íƒ€ë§ˆìŠ¤í¬ ì§€ê°‘ ì—°ê²° í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.'
          },
          'seller': {
            icon: 'store',
            color: 'green',
            title: 'íŒë§¤ì íšŒì›',
            message: 'NFT ì‘í’ˆì„ íŒë§¤í•˜ê³  ê±°ë˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìˆ˜ìˆ˜ë£Œ ì •ì±…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'
          },
          'artist': {
            icon: 'palette',
            color: 'amber',
            title: 'ë¯¸ìˆ ì‘ê°€ íšŒì›',
            message: 'ì‘í’ˆì„ ë“±ë¡í•˜ê³  NFTë¡œ ë¯¼íŒ…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¶”ê°€ í”„ë¡œí•„ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'
          },
          'expert': {
            icon: 'user-tie',
            color: 'purple',
            title: 'ì „ë¬¸ê°€ íšŒì›',
            message: 'ì‘í’ˆì„ í‰ê°€í•˜ê³  ETH ë³´ìƒì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì „ë¬¸ê°€ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.'
          },
          'museum': {
            icon: 'landmark',
            color: 'rose',
            title: 'ë®¤ì§€ì—„ íšŒì›',
            message: 'ì „ì‹œë¥¼ ê¸°íší•˜ê³  ì‘í’ˆì„ íë ˆì´ì…˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. íšŒì›ê°€ì… ì‹œ íŒŒíŠ¸ë„ˆì‹­ ì‹ ì²­ì´ ìë™ìœ¼ë¡œ ì œì¶œë©ë‹ˆë‹¤. ê¸°ê´€ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'
          },
          'gallery': {
            icon: 'building-columns',
            color: 'teal',
            title: 'ê°¤ëŸ¬ë¦¬ íšŒì›',
            message: 'ì‘í’ˆì„ ì „ì‹œí•˜ê³  ê±°ë˜ë¥¼ ì¤‘ê°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. íšŒì›ê°€ì… ì‹œ íŒŒíŠ¸ë„ˆì‹­ ì‹ ì²­ì´ ìë™ìœ¼ë¡œ ì œì¶œë©ë‹ˆë‹¤. ê¸°ê´€ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'
          }
        };
        
        const guidance = guidanceMessages[role];
        if (!guidance) return;
        
        // ê¸°ì¡´ ì•ˆë‚´ ë©”ì‹œì§€ ì œê±°
        const existingGuidance = document.getElementById('roleGuidance');
        if (existingGuidance) {
          existingGuidance.remove();
        }
        
        // ìƒˆ ì•ˆë‚´ ë©”ì‹œì§€ ìƒì„±
        const guidanceHTML = \`
          <div id="roleGuidance" class="mt-6 p-4 rounded-xl bg-\${guidance.color}-500 bg-opacity-10 border border-\${guidance.color}-500 border-opacity-30 animate-fadeIn">
              <div class="flex items-start gap-3">
                  <div class="flex-shrink-0 w-10 h-10 rounded-full bg-\${guidance.color}-500 flex items-center justify-center">
                      <i class="fas fa-\${guidance.icon} text-white"></i>
                  </div>
                  <div>
                      <h4 class="text-\${guidance.color}-300 font-bold text-sm mb-1">\${guidance.title}</h4>
                      <p class="text-gray-300 text-sm">\${guidance.message}</p>
                  </div>
              </div>
          </div>
        \`;
        
        // ì—­í•  ì„ íƒ ì„¹ì…˜ ë‹¤ìŒì— ì‚½ì…
        const roleSection = document.querySelector('input[name="role"]:checked').closest('div').closest('div').closest('div');
        if (roleSection) {
          roleSection.insertAdjacentHTML('afterend', guidanceHTML);
        }
      }
      
      // ì´ˆê¸° ë¡œë“œ ì‹œ ì„ íƒëœ ì—­í• ì˜ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
      const initialRole = document.querySelector('input[name="role"]:checked');
      if (initialRole) {
        showRoleGuidance(initialRole.value);
      }
    });
  </script>
  
  <style>
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out;
    }
  </style>
  `;
  
  return c.html(getLayout(content, 'íšŒì›ê°€ì… - GALLERYPIA'))
})

// ============================================
// ì‚¬ìš©ì í”„ë¡œí•„ í˜ì´ì§€
// ============================================
app.get('/profile', (c) => {
  const content = `
    <section class="py-20">
      <div class="max-w-4xl mx-auto px-4">
        <h1 class="text-4xl font-bold mb-8 text-white">ë‚´ í”„ë¡œí•„</h1>
        
        <div class="card-nft rounded-2xl p-8 mb-6">
          <div class="flex items-center gap-6 mb-8">
            <div class="relative group">
              <div id="profileImageContainer" class="w-24 h-24 rounded-full bg-gradient-to-br from-purple-600 to-cyan-500 flex items-center justify-center text-white text-3xl font-bold overflow-hidden cursor-pointer" onclick="document.getElementById('profileImageInput').click()">
                <span id="profileInitial">U</span>
                <img id="profileImage" class="hidden w-full h-full object-cover" />
              </div>
              <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" onclick="document.getElementById('profileImageInput').click()">
                <i class="fas fa-camera text-white text-xl"></i>
              </div>
              <input type="file" id="profileImageInput" accept="image/*" class="hidden" onchange="handleProfileImageUpload(event)">
            </div>
            <div class="flex-1">
              <h2 id="profileName" class="text-2xl font-bold text-white mb-2">ì‚¬ìš©ì</h2>
              <p id="profileEmail" class="text-gray-400">user@example.com</p>
              <div id="profileRole" class="inline-block mt-2 px-3 py-1 bg-purple-500/20 text-purple-300 rounded-full text-sm font-semibold"></div>
            </div>
          </div>
          
          <form id="profileForm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-gray-400 mb-2">ì´ë¦„</label>
                <input type="text" id="fullName" name="full_name" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-purple-500 transition-colors" required>
              </div>
              <div>
                <label class="block text-gray-400 mb-2">ì´ë©”ì¼</label>
                <input type="email" id="email" name="email" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white text-sm" readonly>
              </div>
              <div>
                <label class="block text-gray-400 mb-2">ì‚¬ìš©ìëª…</label>
                <input type="text" id="username" name="username" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-purple-500 transition-colors">
              </div>
              <div>
                <label class="block text-gray-400 mb-2">ì§€ê°‘ ì£¼ì†Œ</label>
                <input type="text" id="walletAddress" name="wallet_address" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white text-sm" readonly>
              </div>
              <div class="md:col-span-2">
                <label class="block text-gray-400 mb-2">ìê¸°ì†Œê°œ</label>
                <textarea id="bio" name="bio" rows="3" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-purple-500 transition-colors" placeholder="ìê¸°ì†Œê°œë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
              </div>
            </div>
          </form>
        </div>
        
        <div class="flex gap-4">
          <button type="button" onclick="saveProfile()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl transition-colors">
            <i class="fas fa-save mr-2"></i>ë³€ê²½ì‚¬í•­ ì €ì¥
          </button>
          <a href="/settings" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl transition-colors">
            <i class="fas fa-cog mr-2"></i>ì„¤ì •
          </a>
          <a href="/dashboard" class="px-6 py-3 bg-gray-800 hover:bg-gray-700 text-white font-bold rounded-xl transition-colors">
            ëŒ€ì‹œë³´ë“œë¡œ
          </a>
        </div>
      </div>
    </section>
    
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
      const token = localStorage.getItem('auth_token');
      const user = JSON.parse(localStorage.getItem('user') || 'null');
      
      if (!token || !user) {
        window.location.href = '/login';
      }
      
      // í”„ë¡œí•„ ë°ì´í„° ë¡œë“œ
      function loadProfile() {
        document.getElementById('profileInitial').textContent = (user.full_name || 'U').charAt(0).toUpperCase();
        document.getElementById('profileName').textContent = user.full_name || 'ì‚¬ìš©ì';
        document.getElementById('profileEmail').textContent = user.email || '';
        document.getElementById('profileRole').textContent = user.role || 'buyer';
        document.getElementById('fullName').value = user.full_name || '';
        document.getElementById('email').value = user.email || '';
        document.getElementById('username').value = user.username || '';
        document.getElementById('walletAddress').value = user.wallet_address || 'ì—°ê²°ë˜ì§€ ì•ŠìŒ';
        document.getElementById('bio').value = user.bio || '';
        
        // í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œ
        if (user.profile_image_url) {
          document.getElementById('profileImage').src = user.profile_image_url;
          document.getElementById('profileImage').classList.remove('hidden');
          document.getElementById('profileInitial').classList.add('hidden');
        }
      }
      
      loadProfile();
      
      // í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
      let uploadedImageUrl = null;
      
      async function handleProfileImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // ì´ë¯¸ì§€ í¬ê¸° í™•ì¸ (5MB ì œí•œ)
        if (file.size > 5 * 1024 * 1024) {
          alert('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤');
          return;
        }
        
        try {
          // Base64ë¡œ ë³€í™˜ (ì„ì‹œ ë¯¸ë¦¬ë³´ê¸°)
          const reader = new FileReader();
          reader.onload = (e) => {
            document.getElementById('profileImage').src = e.target.result;
            document.getElementById('profileImage').classList.remove('hidden');
            document.getElementById('profileInitial').classList.add('hidden');
            uploadedImageUrl = e.target.result;
          };
          reader.readAsDataURL(file);
          
        } catch (error) {
          console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
          alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
      }
      
      // í”„ë¡œí•„ ì €ì¥
      async function saveProfile() {
        const form = document.getElementById('profileForm');
        const formData = {
          full_name: form.full_name.value,
          username: form.username.value,
          bio: form.bio.value,
          profile_image_url: uploadedImageUrl || user.profile_image_url || null
        };
        
        try {
          const response = await axios.put('/api/users/profile', formData, {
            headers: { 'Authorization': \`Bearer \${token}\` }
          });
          
          if (response.data.success) {
            // localStorage ì—…ë°ì´íŠ¸
            const updatedUser = { ...user, ...formData };
            localStorage.setItem('user', JSON.stringify(updatedUser));
            
            alert('í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            window.location.reload();
          } else {
            alert('ì˜¤ë¥˜: ' + response.data.message);
          }
        } catch (error) {
          console.error('í”„ë¡œí•„ ì €ì¥ ì˜¤ë¥˜:', error);
          alert('í”„ë¡œí•„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
      }
    </script>
  `;
  return c.html(getLayout(content, 'ë‚´ í”„ë¡œí•„ - GALLERYPIA'))
})

// ============================================
// ì„¤ì • í˜ì´ì§€
// ============================================
app.get('/settings', (c) => {
  const content = `
    <section class="py-20">
      <div class="max-w-4xl mx-auto px-4">
        <h1 class="text-4xl font-bold mb-8 text-white">ì„¤ì •</h1>
        
        <div class="space-y-6">
          <!-- ì•Œë¦¼ ì„¤ì • -->
          <div class="card-nft rounded-2xl p-8">
            <h2 class="text-xl font-bold text-white mb-6">
              <i class="fas fa-bell mr-2 text-purple-400"></i>
              ì•Œë¦¼ ì„¤ì •
            </h2>
            <form id="notificationSettingsForm" class="space-y-4">
              <label class="flex items-center justify-between p-4 bg-gray-800 rounded-xl hover:bg-gray-750 transition-colors cursor-pointer">
                <div>
                  <span class="text-white font-medium">ìƒˆ ì‘í’ˆ ì•Œë¦¼</span>
                  <p class="text-sm text-gray-400">ê´€ì‹¬ ì‘ê°€ì˜ ìƒˆ ì‘í’ˆ ë“±ë¡ ì‹œ ì•Œë¦¼</p>
                </div>
                <input type="checkbox" id="notify_new_artwork" class="w-6 h-6 text-purple-600 rounded focus:ring-2 focus:ring-purple-500">
              </label>
              
              <label class="flex items-center justify-between p-4 bg-gray-800 rounded-xl hover:bg-gray-750 transition-colors cursor-pointer">
                <div>
                  <span class="text-white font-medium">ê°€ê²© ë³€ë™ ì•Œë¦¼</span>
                  <p class="text-sm text-gray-400">ê´€ì‹¬ì‘í’ˆì˜ ê°€ê²© ë³€ë™ ì‹œ ì•Œë¦¼</p>
                </div>
                <input type="checkbox" id="notify_price_change" class="w-6 h-6 text-purple-600 rounded focus:ring-2 focus:ring-purple-500">
              </label>
              
              <label class="flex items-center justify-between p-4 bg-gray-800 rounded-xl hover:bg-gray-750 transition-colors cursor-pointer">
                <div>
                  <span class="text-white font-medium">ì…ì°° ì•Œë¦¼</span>
                  <p class="text-sm text-gray-400">ê²½ë§¤ ì…ì°° ë° ë‚™ì°° ì•Œë¦¼</p>
                </div>
                <input type="checkbox" id="notify_bid" class="w-6 h-6 text-purple-600 rounded focus:ring-2 focus:ring-purple-500">
              </label>
              
              <label class="flex items-center justify-between p-4 bg-gray-800 rounded-xl hover:bg-gray-750 transition-colors cursor-pointer">
                <div>
                  <span class="text-white font-medium">í‰ê°€ ì™„ë£Œ ì•Œë¦¼</span>
                  <p class="text-sm text-gray-400">ë‚´ ì‘í’ˆì˜ ì „ë¬¸ê°€ í‰ê°€ ì™„ë£Œ ì‹œ ì•Œë¦¼</p>
                </div>
                <input type="checkbox" id="notify_evaluation" class="w-6 h-6 text-purple-600 rounded focus:ring-2 focus:ring-purple-500">
              </label>
              
              <button type="button" onclick="saveNotificationSettings()" class="w-full px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl transition-colors">
                <i class="fas fa-save mr-2"></i>ì•Œë¦¼ ì„¤ì • ì €ì¥
              </button>
            </form>
          </div>
          
          <!-- ë³´ì•ˆ ì„¤ì • -->
          <div class="card-nft rounded-2xl p-8">
            <h2 class="text-xl font-bold text-white mb-6">
              <i class="fas fa-shield-alt mr-2 text-blue-400"></i>
              ë³´ì•ˆ ì„¤ì •
            </h2>
            
            <button onclick="openPasswordChangeModal()" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl transition-colors">
              <i class="fas fa-key mr-2"></i>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
            </button>
            
            <div class="mt-6 p-4 bg-blue-500 bg-opacity-10 border border-blue-500 border-opacity-30 rounded-xl">
              <h3 class="text-blue-400 font-bold mb-2">
                <i class="fas fa-info-circle mr-2"></i>
                ë³´ì•ˆ íŒ
              </h3>
              <ul class="text-sm text-gray-300 space-y-1">
                <li>â€¢ ì •ê¸°ì ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì„¸ìš”</li>
                <li>â€¢ ë‹¤ë¥¸ ì‚¬ì´íŠ¸ì™€ ë™ì¼í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”</li>
                <li>â€¢ íŠ¹ìˆ˜ë¬¸ìì™€ ìˆ«ìë¥¼ í¬í•¨í•œ 8ì ì´ìƒì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”</li>
              </ul>
            </div>
          </div>
          
          <!-- ì§€ê°‘ ì—°ê²° -->
          <div class="card-nft rounded-2xl p-8">
            <h2 class="text-xl font-bold text-white mb-6">
              <i class="fas fa-wallet mr-2 text-orange-400"></i>
              ì§€ê°‘ ì—°ê²°
            </h2>
            
            <div id="walletInfo" class="mb-4 p-4 bg-gray-800 rounded-xl">
              <p class="text-gray-400 text-sm mb-2">í˜„ì¬ ì—°ê²°ëœ ì§€ê°‘:</p>
              <p id="currentWallet" class="text-white font-mono text-sm">ì—°ê²°ë˜ì§€ ì•ŠìŒ</p>
            </div>
            
            <button onclick="connectMetaMask()" class="px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-xl transition-colors">
              <i class="fas fa-wallet mr-2"></i>MetaMask ì—°ê²°
            </button>
            
            <div class="mt-6 p-4 bg-yellow-500 bg-opacity-10 border border-yellow-500 border-opacity-30 rounded-xl">
              <h3 class="text-yellow-400 font-bold mb-2">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                MetaMask ì•ˆë‚´
              </h3>
              <p class="text-sm text-gray-300">
                MetaMask í™•ì¥ í”„ë¡œê·¸ë¨ì´ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. 
                <a href="https://metamask.io" target="_blank" class="text-purple-400 hover:text-purple-300 underline">
                  ì—¬ê¸°ì—ì„œ ë‹¤ìš´ë¡œë“œ
                </a>
              </p>
            </div>
          </div>
          
          <!-- ê³„ì • ê´€ë¦¬ -->
          <div class="card-nft rounded-2xl p-8 border-2 border-red-900">
            <h2 class="text-xl font-bold text-white mb-6">
              <i class="fas fa-exclamation-triangle mr-2 text-red-400"></i>
              ìœ„í—˜ êµ¬ì—­
            </h2>
            
            <p class="text-gray-400 mb-4">
              ê³„ì •ì„ ì‚­ì œí•˜ë©´ ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </p>
            
            <button onclick="openAccountDeleteModal()" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl transition-colors">
              <i class="fas fa-trash-alt mr-2"></i>ê³„ì • ì‚­ì œ
            </button>
          </div>
        </div>
        
        <div class="mt-8">
          <a href="/profile" class="px-6 py-3 bg-gray-800 hover:bg-gray-700 text-white font-bold rounded-xl transition-colors inline-block">
            <i class="fas fa-arrow-left mr-2"></i>í”„ë¡œí•„ë¡œ ëŒì•„ê°€ê¸°
          </a>
        </div>
      </div>
    </section>
    
    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
    <div id="passwordChangeModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
      <div class="bg-gray-900 rounded-2xl p-8 max-w-md w-full border border-gray-800">
        <h3 class="text-2xl font-bold text-white mb-6">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
        
        <form id="passwordChangeForm" class="space-y-4">
          <div>
            <label class="block text-gray-400 mb-2">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="currentPassword" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-purple-500 transition-colors" required>
          </div>
          
          <div>
            <label class="block text-gray-400 mb-2">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="newPassword" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-purple-500 transition-colors" required minlength="8">
          </div>
          
          <div>
            <label class="block text-gray-400 mb-2">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input type="password" id="confirmPassword" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-purple-500 transition-colors" required minlength="8">
          </div>
          
          <div class="flex gap-4 mt-6">
            <button type="button" onclick="changePassword()" class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl transition-colors">
              ë³€ê²½
            </button>
            <button type="button" onclick="closePasswordChangeModal()" class="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-xl transition-colors">
              ì·¨ì†Œ
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- ê³„ì • ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
    <div id="accountDeleteModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
      <div class="bg-gray-900 rounded-2xl p-8 max-w-md w-full border-2 border-red-900">
        <h3 class="text-2xl font-bold text-red-400 mb-6">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          ê³„ì • ì‚­ì œ í™•ì¸
        </h3>
        
        <div class="space-y-4 mb-6">
          <div class="p-4 bg-red-900 bg-opacity-30 border border-red-700 rounded-xl">
            <p class="text-red-300 font-bold mb-2">âš ï¸ ë‹¤ìŒ ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤:</p>
            <ul class="text-sm text-gray-300 space-y-1">
              <li>â€¢ í”„ë¡œí•„ ì •ë³´ ë° ì—…ë¡œë“œí•œ ì‘í’ˆ</li>
              <li>â€¢ ê±°ë˜ ë‚´ì—­ ë° í™œë™ ë¡œê·¸</li>
              <li>â€¢ ì¦ê²¨ì°¾ê¸° ë° íŒ”ë¡œìš° ì •ë³´</li>
              <li>â€¢ í‰ê°€ ë° ëŒ“ê¸€ ê¸°ë¡</li>
            </ul>
          </div>
          
          <div>
            <label class="block text-gray-400 mb-2">ì‚­ì œ í™•ì¸ì„ ìœ„í•´ "ê³„ì •ì‚­ì œ"ë¥¼ ì…ë ¥í•˜ì„¸ìš”</label>
            <input type="text" id="deleteConfirmText" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-red-500 transition-colors" placeholder="ê³„ì •ì‚­ì œ">
          </div>
          
          <div>
            <label class="block text-gray-400 mb-2">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="deletePassword" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl text-white focus:border-red-500 transition-colors" required>
          </div>
        </div>
        
        <div class="flex gap-4">
          <button type="button" onclick="confirmAccountDelete()" class="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl transition-colors">
            <i class="fas fa-trash-alt mr-2"></i>ì˜êµ¬ ì‚­ì œ
          </button>
          <button type="button" onclick="closeAccountDeleteModal()" class="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-xl transition-colors">
            ì·¨ì†Œ
          </button>
        </div>
      </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
      const token = localStorage.getItem('auth_token');
      const user = JSON.parse(localStorage.getItem('user') || 'null');
      
      if (!token || !user) {
        window.location.href = '/login';
      }
      
      // ì•Œë¦¼ ì„¤ì • ë¡œë“œ
      async function loadNotificationSettings() {
        try {
          const response = await axios.get('/api/users/notification-settings', {
            headers: { 'Authorization': \`Bearer \${token}\` }
          });
          
          if (response.data.success) {
            const settings = response.data.settings || {};
            document.getElementById('notify_new_artwork').checked = settings.notify_new_artwork !== false;
            document.getElementById('notify_price_change').checked = settings.notify_price_change !== false;
            document.getElementById('notify_bid').checked = settings.notify_bid !== false;
            document.getElementById('notify_evaluation').checked = settings.notify_evaluation !== false;
          }
        } catch (error) {
          console.error('ì•Œë¦¼ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      }
      
      loadNotificationSettings();
      
      // ì•Œë¦¼ ì„¤ì • ì €ì¥
      async function saveNotificationSettings() {
        const settings = {
          notify_new_artwork: document.getElementById('notify_new_artwork').checked,
          notify_price_change: document.getElementById('notify_price_change').checked,
          notify_bid: document.getElementById('notify_bid').checked,
          notify_evaluation: document.getElementById('notify_evaluation').checked
        };
        
        try {
          const response = await axios.put('/api/users/notification-settings', settings, {
            headers: { 'Authorization': \`Bearer \${token}\` }
          });
          
          if (response.data.success) {
            alert('ì•Œë¦¼ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
          } else {
            alert('ì˜¤ë¥˜: ' + response.data.message);
          }
        } catch (error) {
          console.error('ì•Œë¦¼ ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', error);
          alert('ì•Œë¦¼ ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
      }
      
      // ì§€ê°‘ ì£¼ì†Œ í‘œì‹œ
      if (user.wallet_address) {
        document.getElementById('currentWallet').textContent = user.wallet_address;
      }
      
      // MetaMask ì—°ê²°
      async function connectMetaMask() {
        if (typeof window.ethereum === 'undefined') {
          alert('MetaMaskê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. https://metamask.io ì—ì„œ ì„¤ì¹˜í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        try {
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          const walletAddress = accounts[0];
          
          // ì„œë²„ì— ì§€ê°‘ ì£¼ì†Œ ì €ì¥
          const response = await axios.put('/api/users/wallet', 
            { wallet_address: walletAddress },
            { headers: { 'Authorization': \`Bearer \${token}\` }}
          );
          
          if (response.data.success) {
            document.getElementById('currentWallet').textContent = walletAddress;
            user.wallet_address = walletAddress;
            localStorage.setItem('user', JSON.stringify(user));
            alert('MetaMaskê°€ ì„±ê³µì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!');
          }
        } catch (error) {
          console.error('MetaMask ì—°ê²° ì‹¤íŒ¨:', error);
          alert('MetaMask ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
      }
      
      // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬
      function openPasswordChangeModal() {
        document.getElementById('passwordChangeModal').classList.remove('hidden');
      }
      
      function closePasswordChangeModal() {
        document.getElementById('passwordChangeModal').classList.add('hidden');
        document.getElementById('passwordChangeForm').reset();
      }
      
      async function changePassword() {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (newPassword !== confirmPassword) {
          alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
          return;
        }
        
        if (newPassword.length < 8) {
          alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤');
          return;
        }
        
        try {
          const response = await axios.put('/api/users/password', 
            { current_password: currentPassword, new_password: newPassword },
            { headers: { 'Authorization': \`Bearer \${token}\` }}
          );
          
          if (response.data.success) {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!');
            closePasswordChangeModal();
          } else {
            alert('ì˜¤ë¥˜: ' + response.data.message);
          }
        } catch (error) {
          console.error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨:', error);
          alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
      }
      
      // ê³„ì • ì‚­ì œ ëª¨ë‹¬
      function openAccountDeleteModal() {
        document.getElementById('accountDeleteModal').classList.remove('hidden');
      }
      
      function closeAccountDeleteModal() {
        document.getElementById('accountDeleteModal').classList.add('hidden');
        document.getElementById('deleteConfirmText').value = '';
        document.getElementById('deletePassword').value = '';
      }
      
      async function confirmAccountDelete() {
        const confirmText = document.getElementById('deleteConfirmText').value;
        const password = document.getElementById('deletePassword').value;
        
        if (confirmText !== 'ê³„ì •ì‚­ì œ') {
          alert('"ê³„ì •ì‚­ì œ"ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”');
          return;
        }
        
        if (!password) {
          alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
          return;
        }
        
        try {
          const response = await axios.delete('/api/users/account', {
            headers: { 'Authorization': \`Bearer \${token}\` },
            data: { password }
          });
          
          if (response.data.success) {
            alert('ê³„ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            window.location.href = '/';
          } else {
            alert('ì˜¤ë¥˜: ' + response.data.message);
          }
        } catch (error) {
          console.error('ê³„ì • ì‚­ì œ ì‹¤íŒ¨:', error);
          alert('ê³„ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
      }
    </script>
  `;
  return c.html(getLayout(content, 'ì„¤ì • - GALLERYPIA'))
})

// ============================================
// ê´€ì‹¬ì‘í’ˆ í˜ì´ì§€
// ============================================
app.get('/favorites', (c) => {
  const content = `
    <section class="py-20">
      <div class="max-w-7xl mx-auto px-4">
        <h1 class="text-4xl font-bold mb-8 text-white">
          <i class="fas fa-heart mr-3 text-red-500"></i>
          ê´€ì‹¬ì‘í’ˆ
        </h1>
        
        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loadingState" class="text-center py-20">
          <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-500 mx-auto mb-4"></div>
          <p class="text-gray-400">ê´€ì‹¬ì‘í’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
        
        <!-- ì‘í’ˆ ëª©ë¡ -->
        <div id="favoritesList" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
        
        <!-- ë¹ˆ ìƒíƒœ -->
        <div id="emptyState" class="hidden col-span-full text-center py-20 text-gray-400">
          <i class="fas fa-heart text-6xl mb-4 opacity-50"></i>
          <p class="text-xl">ì•„ì§ ê´€ì‹¬ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤</p>
          <p class="text-sm mt-2 text-gray-500">ë§ˆìŒì— ë“œëŠ” ì‘í’ˆì— í•˜íŠ¸ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”</p>
          <a href="/gallery" class="inline-block mt-6 px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl transition-colors">
            ê°¤ëŸ¬ë¦¬ ë‘˜ëŸ¬ë³´ê¸°
          </a>
        </div>
      </div>
    </section>
    
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
      const token = localStorage.getItem('auth_token');
      if (!token) {
        window.location.href = '/login';
      }
      
      // ê´€ì‹¬ì‘í’ˆ ë¡œë“œ
      async function loadFavorites() {
        try {
          const response = await axios.get('/api/artworks/favorites', {
            headers: { 'Authorization': \`Bearer \${token}\` }
          });
          
          document.getElementById('loadingState').classList.add('hidden');
          
          if (response.data.success && response.data.artworks && response.data.artworks.length > 0) {
            const artworks = response.data.artworks;
            
            document.getElementById('favoritesList').classList.remove('hidden');
            
            const html = artworks.map(art => \`
              <a href="/artwork/\${art.id}" class="card-nft rounded-2xl overflow-hidden group hover:scale-105 transition-transform">
                <div class="aspect-square bg-gray-800 overflow-hidden relative">
                  <img src="\${art.image_url || '/static/placeholder.jpg'}" alt="\${art.title}" class="w-full h-full object-cover" />
                  <div class="absolute top-3 right-3">
                    <button onclick="removeFavorite(event, \${art.id})" class="w-10 h-10 rounded-full bg-black bg-opacity-50 hover:bg-opacity-70 flex items-center justify-center transition-all">
                      <i class="fas fa-heart text-red-500"></i>
                    </button>
                  </div>
                </div>
                <div class="p-4">
                  <h3 class="text-lg font-bold text-white mb-2 truncate">\${art.title}</h3>
                  <p class="text-sm text-gray-400 mb-3 truncate">\${art.artist_name || 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
                  <div class="flex items-center justify-between">
                    <span class="text-purple-400 font-bold">\${art.current_price ? 'â‚©' + art.current_price.toLocaleString() : 'ê°€ê²© ë¯¸ì •'}</span>
                    <span class="text-xs text-gray-500 flex items-center">
                      <i class="fas fa-eye mr-1"></i>\${art.views || 0}
                    </span>
                  </div>
                </div>
              </a>
            \`).join('');
            
            document.getElementById('favoritesList').innerHTML = html;
          } else {
            document.getElementById('emptyState').classList.remove('hidden');
          }
        } catch (error) {
          console.error('ê´€ì‹¬ì‘í’ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
          document.getElementById('loadingState').classList.add('hidden');
          document.getElementById('emptyState').classList.remove('hidden');
          document.getElementById('emptyState').innerHTML = \`
            <i class="fas fa-exclamation-triangle text-6xl mb-4 text-red-500"></i>
            <p class="text-xl">ê´€ì‹¬ì‘í’ˆì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
          \`;
        }
      }
      
      // ê´€ì‹¬ì‘í’ˆ ì œê±°
      async function removeFavorite(event, artworkId) {
        event.preventDefault();
        event.stopPropagation();
        
        if (!confirm('ê´€ì‹¬ì‘í’ˆì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }
        
        try {
          const response = await axios.post(\`/api/artworks/\${artworkId}/favorite\`, {}, {
            headers: { 'Authorization': \`Bearer \${token}\` }
          });
          
          if (response.data.success) {
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            loadFavorites();
          }
        } catch (error) {
          console.error('ê´€ì‹¬ì‘í’ˆ ì œê±° ì‹¤íŒ¨:', error);
          alert('ê´€ì‹¬ì‘í’ˆ ì œê±° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        }
      }
      
      loadFavorites();
    </script>
  `;
  return c.html(getLayout(content, 'ê´€ì‹¬ì‘í’ˆ - GALLERYPIA'))
})

// ============================================
// ë‚´ ì‘í’ˆ í˜ì´ì§€
// ============================================
app.get('/my-artworks', (c) => {
  const content = `
    <section class="py-20">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex justify-between items-center mb-8">
          <h1 class="text-4xl font-bold text-white">ë‚´ ì‘í’ˆ</h1>
          <a href="/upload-artwork" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl transition-colors">
            <i class="fas fa-plus mr-2"></i>ì‘í’ˆ ì—…ë¡œë“œ
          </a>
        </div>
        
        <div id="myArtworksList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="col-span-full text-center py-20 text-gray-400">
            <i class="fas fa-images text-6xl mb-4 opacity-50"></i>
            <p class="text-xl">ì—…ë¡œë“œí•œ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤</p>
            <a href="/upload-artwork" class="inline-block mt-6 px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl transition-colors">
              ì²« ì‘í’ˆ ì—…ë¡œë“œí•˜ê¸°
            </a>
          </div>
        </div>
      </div>
    </section>
    
    <script>
      // TODO: Load my artworks from API
      const token = localStorage.getItem('auth_token');
      const user = JSON.parse(localStorage.getItem('user') || 'null');
      if (!token) {
        window.location.href = '/login';
      }
      if (user && user.role !== 'artist') {
        alert('ì•„í‹°ìŠ¤íŠ¸ë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤');
        window.location.href = '/dashboard';
      }
    </script>
  `;
  return c.html(getLayout(content, 'ë‚´ ì‘í’ˆ - GALLERYPIA'))
})

// ============================================
// í†µí•© ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ (ì—­í• ë³„ ìë™ ì „í™˜)
// ============================================
app.get('/dashboard', (c) => {
  const content = `
  <div id="dashboardContainer" class="min-h-screen py-20">
    <div class="max-w-7xl mx-auto px-4">
      <div class="text-center py-20">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-500 mx-auto mb-4"></div>
        <p class="text-gray-400">ëŒ€ì‹œë³´ë“œ ë¡œë”© ì¤‘...</p>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  <script>
    async function loadDashboard() {
      const token = localStorage.getItem('auth_token');
      
      if (!token) {
        window.location.href = '/login';
        return;
      }
      
      const container = document.getElementById('dashboardContainer');
      
      try {
        // FIX-8: ì„œë²„ì—ì„œ ìµœì‹  ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì™€ ì—­í•  ë™ê¸°í™”
        const response = await fetch('/api/auth/me', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        
        if (!response.ok) {
          window.location.href = '/login';
          return;
        }
        
        const data = await response.json();
        if (!data.success || !data.user) {
          window.location.href = '/login';
          return;
        }
        
        // localStorage ì—…ë°ì´íŠ¸ (ìµœì‹  ì—­í•  ë°˜ì˜)
        const user = data.user;
        localStorage.setItem('user', JSON.stringify(user));
        
        let dashboardHTML = '';
        
        // ì—­í• ì— ë”°ë¼ ëŒ€ì‹œë³´ë“œ ë¡œë“œ
        switch(user.role) {
          case 'buyer':
            dashboardHTML = await loadBuyerDashboard(token);
            break;
          case 'artist':
          case 'seller':
            dashboardHTML = await loadArtistDashboard(token);
            break;
          case 'expert':
            dashboardHTML = await loadExpertDashboard(token);
            break;
          case 'museum':
          case 'gallery':
            dashboardHTML = await loadMuseumDashboard(token);
            break;
          case 'admin':
            window.location.href = '/admin-dashboard';
            return;
          default:
            dashboardHTML = await loadBuyerDashboard(token);
        }
        
        container.innerHTML = dashboardHTML;
        
      } catch (error) {
        console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
        container.innerHTML = \`
          <div class="text-center py-20">
            <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
            <p class="text-xl text-white mb-4">ëŒ€ì‹œë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
            <a href="/" class="text-purple-400 hover:text-purple-300">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
          </div>
        \`;
      }
    }
    
    // Buyer ëŒ€ì‹œë³´ë“œ
    async function loadBuyerDashboard(token) {
      const [artworks, favorites, recommendations, purchases] = await Promise.all([
        axios.get('/api/artworks?limit=6', { headers: { Authorization: \`Bearer \${token}\` }}),
        axios.get('/api/artworks/favorites?limit=6', { headers: { Authorization: \`Bearer \${token}\` }}),
        axios.get('/api/recommendations/artworks?limit=6', { headers: { Authorization: \`Bearer \${token}\` }}),
        axios.get('/api/purchases', { headers: { Authorization: \`Bearer \${token}\` }})
      ]);
      
      return \`
        <div class="max-w-7xl mx-auto px-4">
          <div class="mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">êµ¬ë§¤ì ëŒ€ì‹œë³´ë“œ</h1>
            <p class="text-gray-400">ë‹¹ì‹ ì„ ìœ„í•œ íŠ¹ë³„í•œ ì‘í’ˆë“¤</p>
          </div>
          
          <div class="grid md:grid-cols-3 gap-6 mb-12">
            <div class="stat-card p-6 rounded-xl">
              <div class="flex items-center justify-between mb-4">
                <i class="fas fa-heart text-3xl text-red-500"></i>
                <span class="text-2xl font-bold text-white">\${favorites.data.artworks?.length || 0}</span>
              </div>
              <p class="text-gray-400">ì¦ê²¨ì°¾ê¸°</p>
            </div>
            <div class="stat-card p-6 rounded-xl">
              <div class="flex items-center justify-between mb-4">
                <i class="fas fa-shopping-cart text-3xl text-green-500"></i>
                <span class="text-2xl font-bold text-white">\${purchases.data.purchases?.length || 0}</span>
              </div>
              <p class="text-gray-400">êµ¬ë§¤ ë‚´ì—­</p>
            </div>
            <div class="stat-card p-6 rounded-xl">
              <div class="flex items-center justify-between mb-4">
                <i class="fas fa-star text-3xl text-yellow-500"></i>
                <span class="text-2xl font-bold text-white">\${recommendations.data.artworks?.length || 0}</span>
              </div>
              <p class="text-gray-400">ì¶”ì²œ ì‘í’ˆ</p>
            </div>
          </div>
          
          <div class="mb-12">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-bold text-white">ì¶”ì²œ ì‘í’ˆ</h2>
              <a href="/gallery" class="text-purple-400 hover:text-purple-300">ì „ì²´ ë³´ê¸° â†’</a>
            </div>
            <div class="grid md:grid-cols-3 gap-6">
              \${(recommendations.data.artworks || []).slice(0, 6).map(art => \`
                <a href="/artwork/\${art.id}" class="card-nft rounded-xl overflow-hidden group">
                  <div class="aspect-square bg-gray-800 overflow-hidden">
                    <img src="\${art.image_url || '/static/placeholder.jpg'}" alt="\${art.title}" class="img-nft w-full h-full object-cover" />
                  </div>
                  <div class="p-4">
                    <h3 class="text-lg font-bold text-white mb-2 truncate">\${art.title}</h3>
                    <p class="text-gray-400 text-sm mb-3 truncate">\${art.artist_name || 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
                    <div class="flex items-center justify-between">
                      <span class="text-purple-400 font-bold">\${art.current_price || '0'} ETH</span>
                      <span class="text-sm text-gray-500">\${art.view_count || 0} views</span>
                    </div>
                  </div>
                </a>
              \`).join('')}
            </div>
          </div>
          
          <div>
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-bold text-white">ì¦ê²¨ì°¾ê¸°</h2>
              <a href="/favorites" class="text-purple-400 hover:text-purple-300">ì „ì²´ ë³´ê¸° â†’</a>
            </div>
            <div class="grid md:grid-cols-3 gap-6">
              \${(favorites.data.artworks || []).slice(0, 6).map(art => \`
                <a href="/artwork/\${art.id}" class="card-nft rounded-xl overflow-hidden group">
                  <div class="aspect-square bg-gray-800 overflow-hidden">
                    <img src="\${art.image_url || '/static/placeholder.jpg'}" alt="\${art.title}" class="img-nft w-full h-full object-cover" />
                  </div>
                  <div class="p-4">
                    <h3 class="text-lg font-bold text-white mb-2 truncate">\${art.title}</h3>
                    <p class="text-gray-400 text-sm mb-3 truncate">\${art.artist_name || 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
                    <div class="flex items-center justify-between">
                      <span class="text-purple-400 font-bold">\${art.current_price || '0'} ETH</span>
                      <span class="text-sm text-gray-500">â¤ï¸ \${art.like_count || 0}</span>
                    </div>
                  </div>
                </a>
              \`).join('')}
            </div>
          </div>
        </div>
      \`;
    }
    
    // Artist ëŒ€ì‹œë³´ë“œ
    async function loadArtistDashboard(token) {
      const user = JSON.parse(localStorage.getItem('user'));
      const artworks = await axios.get(\`/api/artworks?artist_id=\${user.id}&limit=6\`, { 
        headers: { Authorization: \`Bearer \${token}\` }
      });
      
      return \`
        <div class="max-w-7xl mx-auto px-4">
          <div class="mb-8 flex items-center justify-between">
            <div>
              <h1 class="text-4xl font-bold text-white mb-2">ì•„í‹°ìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ</h1>
              <p class="text-gray-400">ë‹¹ì‹ ì˜ ì‘í’ˆì„ ê´€ë¦¬í•˜ê³  ìˆ˜ìµì„ í™•ì¸í•˜ì„¸ìš”</p>
            </div>
            <button onclick="openUploadModal()" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-cyan-500 rounded-xl font-bold hover:scale-105 transition-transform">
              <i class="fas fa-plus mr-2"></i>ì‘í’ˆ ì—…ë¡œë“œ
            </button>
          </div>
          
          <div class="grid md:grid-cols-4 gap-6 mb-12">
            <div class="stat-card p-6 rounded-xl">
              <div class="flex items-center justify-between mb-4">
                <i class="fas fa-palette text-3xl text-purple-500"></i>
                <span class="text-2xl font-bold text-white">\${artworks.data.artworks?.length || 0}</span>
              </div>
              <p class="text-gray-400">ì‘í’ˆ ìˆ˜</p>
            </div>
            <div class="stat-card p-6 rounded-xl">
              <div class="flex items-center justify-between mb-4">
                <i class="fas fa-eye text-3xl text-blue-500"></i>
                <span class="text-2xl font-bold text-white">0</span>
              </div>
              <p class="text-gray-400">ì´ ì¡°íšŒìˆ˜</p>
            </div>
            <div class="stat-card p-6 rounded-xl">
              <div class="flex items-center justify-between mb-4">
                <i class="fas fa-heart text-3xl text-red-500"></i>
                <span class="text-2xl font-bold text-white">0</span>
              </div>
              <p class="text-gray-400">ì´ ì¢‹ì•„ìš”</p>
            </div>
            <div class="stat-card p-6 rounded-xl">
              <div class="flex items-center justify-between mb-4">
                <i class="fas fa-dollar-sign text-3xl text-green-500"></i>
                <span class="text-2xl font-bold text-white">0 ETH</span>
              </div>
              <p class="text-gray-400">ì´ ìˆ˜ìµ</p>
            </div>
          </div>
          
          <div>
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-bold text-white">ë‚´ ì‘í’ˆ</h2>
              <a href="/my-artworks" class="text-purple-400 hover:text-purple-300">ì „ì²´ ë³´ê¸° â†’</a>
            </div>
            <div class="grid md:grid-cols-3 gap-6">
              \${(artworks.data.artworks || []).slice(0, 6).map(art => \`
                <a href="/artwork/\${art.id}" class="card-nft rounded-xl overflow-hidden group">
                  <div class="aspect-square bg-gray-800 overflow-hidden relative">
                    <img src="\${art.image_url || '/static/placeholder.jpg'}" alt="\${art.title}" class="img-nft w-full h-full object-cover" />
                    <div class="absolute top-2 right-2">
                      <button class="px-3 py-1 bg-purple-500 rounded-lg text-xs font-bold">í¸ì§‘</button>
                    </div>
                  </div>
                  <div class="p-4">
                    <h3 class="text-lg font-bold text-white mb-2 truncate">\${art.title}</h3>
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-purple-400 font-bold">\${art.current_price || '0'} ETH</span>
                      <span class="text-sm text-gray-500">\${art.status || 'active'}</span>
                    </div>
                    <div class="flex items-center justify-between text-sm text-gray-400">
                      <span>ğŸ‘ï¸ \${art.view_count || 0}</span>
                      <span>â¤ï¸ \${art.like_count || 0}</span>
                    </div>
                  </div>
                </a>
              \`).join('')}
            </div>
          </div>
        </div>
      \`;
    }
    
    // Expert ëŒ€ì‹œë³´ë“œ
    async function loadExpertDashboard(token) {
      const evaluations = await axios.get('/api/expert/evaluations?limit=10', { 
        headers: { Authorization: \`Bearer \${token}\` }
      });
      
      return \`
        <div class="max-w-7xl mx-auto px-4">
          <div class="mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">ì „ë¬¸ê°€ ëŒ€ì‹œë³´ë“œ</h1>
            <p class="text-gray-400">ì‘í’ˆ í‰ê°€ ë° ê°ì • ê´€ë¦¬</p>
          </div>
          
          <div class="grid md:grid-cols-3 gap-6 mb-12">
            <div class="stat-card p-6 rounded-xl">
              <div class="flex items-center justify-between mb-4">
                <i class="fas fa-clipboard-check text-3xl text-green-500"></i>
                <span class="text-2xl font-bold text-white">\${evaluations.data.evaluations?.length || 0}</span>
              </div>
              <p class="text-gray-400">ì™„ë£Œëœ í‰ê°€</p>
            </div>
            <div class="stat-card p-6 rounded-xl">
              <div class="flex items-center justify-between mb-4">
                <i class="fas fa-hourglass-half text-3xl text-yellow-500"></i>
                <span class="text-2xl font-bold text-white">0</span>
              </div>
              <p class="text-gray-400">ëŒ€ê¸° ì¤‘</p>
            </div>
            <div class="stat-card p-6 rounded-xl">
              <div class="flex items-center justify-between mb-4">
                <i class="fas fa-star text-3xl text-purple-500"></i>
                <span class="text-2xl font-bold text-white">4.8</span>
              </div>
              <p class="text-gray-400">í‰ê·  í‰ì </p>
            </div>
          </div>
          
          <div>
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-bold text-white">í‰ê°€ ëŒ€ê¸° ì¤‘ì¸ ì‘í’ˆ</h2>
              <a href="/expert/queue" class="text-purple-400 hover:text-purple-300">ì „ì²´ ë³´ê¸° â†’</a>
            </div>
            <div class="space-y-4">
              <div class="stat-card p-6 rounded-xl text-center">
                <i class="fas fa-inbox text-5xl text-gray-600 mb-4"></i>
                <p class="text-gray-400">í‰ê°€ ëŒ€ê¸° ì¤‘ì¸ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤</p>
              </div>
            </div>
          </div>
        </div>
      \`;
    }
    
    // Museum/Gallery ëŒ€ì‹œë³´ë“œ
    async function loadMuseumDashboard(token) {
      const [exhibitions, stats] = await Promise.all([
        axios.get('/api/exhibitions?limit=6', { headers: { Authorization: \`Bearer \${token}\` }}),
        axios.get('/api/museum/stats', { headers: { Authorization: \`Bearer \${token}\` }})
      ]);
      
      return \`
        <div class="max-w-7xl mx-auto px-4">
          <div class="mb-8 flex items-center justify-between">
            <div>
              <h1 class="text-4xl font-bold text-white mb-2">ê¸°ê´€ ëŒ€ì‹œë³´ë“œ</h1>
              <p class="text-gray-400">ì „ì‹œíšŒ ë° ì»¬ë ‰ì…˜ ê´€ë¦¬</p>
            </div>
            <a href="/create-exhibition" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-cyan-500 rounded-xl font-bold hover:scale-105 transition-transform">
              <i class="fas fa-plus mr-2"></i>ì „ì‹œíšŒ ìƒì„±
            </a>
          </div>
          
          <div class="grid md:grid-cols-3 gap-6 mb-12">
            <div class="stat-card p-6 rounded-xl">
              <div class="flex items-center justify-between mb-4">
                <i class="fas fa-calendar-alt text-3xl text-purple-500"></i>
                <span class="text-2xl font-bold text-white">\${exhibitions.data.exhibitions?.length || 0}</span>
              </div>
              <p class="text-gray-400">ì§„í–‰ ì¤‘ ì „ì‹œíšŒ</p>
            </div>
            <div class="stat-card p-6 rounded-xl">
              <div class="flex items-center justify-between mb-4">
                <i class="fas fa-users text-3xl text-blue-500"></i>
                <span class="text-2xl font-bold text-white">\${stats.data.visitors?.toLocaleString() || 0}</span>
              </div>
              <p class="text-gray-400">ë°©ë¬¸ì ìˆ˜</p>
            </div>
            <div class="stat-card p-6 rounded-xl">
              <div class="flex items-center justify-between mb-4">
                <i class="fas fa-handshake text-3xl text-green-500"></i>
                <span class="text-2xl font-bold text-white">\${stats.data.partnerships || 0}</span>
              </div>
              <p class="text-gray-400">íŒŒíŠ¸ë„ˆì‹­</p>
            </div>
          </div>
          
          <div>
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-bold text-white">ë‚´ ì „ì‹œíšŒ</h2>
              <a href="/my-exhibitions" class="text-purple-400 hover:text-purple-300">ì „ì²´ ë³´ê¸° â†’</a>
            </div>
            <div class="grid md:grid-cols-3 gap-6">
              \${(exhibitions.data.exhibitions || []).slice(0, 6).map(ex => \`
                <a href="/exhibition/\${ex.id}" class="card-nft rounded-xl overflow-hidden group">
                  <div class="aspect-video bg-gray-800 overflow-hidden">
                    <img src="\${ex.thumbnail_url || '/static/placeholder.jpg'}" alt="\${ex.title}" class="img-nft w-full h-full object-cover" />
                  </div>
                  <div class="p-4">
                    <h3 class="text-lg font-bold text-white mb-2 truncate">\${ex.title}</h3>
                    <p class="text-gray-400 text-sm mb-3">\${ex.start_date || ''} ~ \${ex.end_date || ''}</p>
                    <div class="flex items-center justify-between text-sm">
                      <span class="text-purple-400">\${ex.status || 'active'}</span>
                      <span class="text-gray-500">\${ex.artwork_count || 0}ì </span>
                    </div>
                  </div>
                </a>
              \`).join('')}
            </div>
          </div>
        </div>
      \`;
    }
    
    // FIX-9: ì—…ë¡œë“œ ëª¨ë‹¬ í•¨ìˆ˜
    function openUploadModal() {
      // ê°„ë‹¨í•œ ì•Œë¦¼ìœ¼ë¡œ ëŒ€ì²´ (í–¥í›„ ì—…ë¡œë“œ ëª¨ë‹¬ êµ¬í˜„ ì˜ˆì •)
      if (window.toastSystem) {
        window.toastSystem.info('ì‘í’ˆ ì—…ë¡œë“œ ê¸°ëŠ¥ì€ ê³§ ì¶”ê°€ë©ë‹ˆë‹¤!', {
          duration: 3000
        });
      } else {
        alert('ì‘í’ˆ ì—…ë¡œë“œ ê¸°ëŠ¥ì€ ê³§ ì¶”ê°€ë©ë‹ˆë‹¤!');
      }
      
      // TODO: í–¥í›„ ì—…ë¡œë“œ ëª¨ë‹¬ êµ¬í˜„
      // const modal = document.getElementById('uploadModal');
      // modal.classList.remove('hidden');
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    loadDashboard();
  </script>
  `;
  
  return c.html(getLayout(content, 'ëŒ€ì‹œë³´ë“œ - GALLERYPIA'))
})

// ============================================
// ê³ ê¸‰ ë¶„ì„ ëŒ€ì‹œë³´ë“œ (Phase 10.4)
// ============================================
app.get('/analytics-dashboard', (c) => {
  const content = `
  <div id="analyticsDashboard" class="min-h-screen py-20">
    <div class="max-w-7xl mx-auto px-4">
      <div class="mb-8">
        <h1 class="text-4xl font-bold text-white mb-2">ê³ ê¸‰ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
        <p class="text-gray-400">ì‚¬ìš©ì í–‰ë™ ë° ë¹„ì¦ˆë‹ˆìŠ¤ ì¸ì‚¬ì´íŠ¸</p>
      </div>
      
      <!-- Tab Navigation -->
      <div class="mb-8 flex flex-wrap gap-2 border-b border-gray-800 pb-4">
        <button class="tab-btn active px-6 py-3 rounded-t-xl bg-purple-500 text-white font-bold" data-tab="cohort">
          <i class="fas fa-users mr-2"></i>Cohort ë¶„ì„
        </button>
        <button class="tab-btn px-6 py-3 rounded-t-xl bg-gray-800 text-gray-400 font-bold hover:bg-gray-700" data-tab="funnel">
          <i class="fas fa-filter mr-2"></i>Funnel ë¶„ì„
        </button>
        <button class="tab-btn px-6 py-3 rounded-t-xl bg-gray-800 text-gray-400 font-bold hover:bg-gray-700" data-tab="engagement">
          <i class="fas fa-chart-line mr-2"></i>ì°¸ì—¬ë„
        </button>
        <button class="tab-btn px-6 py-3 rounded-t-xl bg-gray-800 text-gray-400 font-bold hover:bg-gray-700" data-tab="segments">
          <i class="fas fa-layer-group mr-2"></i>ì‚¬ìš©ì ì„¸ê·¸ë¨¼íŠ¸
        </button>
        <button class="tab-btn px-6 py-3 rounded-t-xl bg-gray-800 text-gray-400 font-bold hover:bg-gray-700" data-tab="heatmap">
          <i class="fas fa-fire mr-2"></i>í™œë™ íˆíŠ¸ë§µ
        </button>
        <button class="tab-btn px-6 py-3 rounded-t-xl bg-gray-800 text-gray-400 font-bold hover:bg-gray-700" data-tab="demographics">
          <i class="fas fa-chart-pie mr-2"></i>ì¸êµ¬í†µê³„
        </button>
        <button class="tab-btn px-6 py-3 rounded-t-xl bg-gray-800 text-gray-400 font-bold hover:bg-gray-700" data-tab="ltv">
          <i class="fas fa-dollar-sign mr-2"></i>LTV ë¶„ì„
        </button>
      </div>
      
      <!-- Tab Contents -->
      <div id="cohortTab" class="tab-content">
        <div class="stat-card p-8 rounded-xl mb-6">
          <h2 class="text-2xl font-bold text-white mb-4">ì›”ë³„ ì½”í˜¸íŠ¸ ë¦¬í…ì…˜</h2>
          <div class="mb-4">
            <label class="text-gray-400 mr-2">ê¸°ê°„:</label>
            <select id="cohortMonths" class="bg-gray-800 text-white px-4 py-2 rounded-lg">
              <option value="3">3ê°œì›”</option>
              <option value="6" selected>6ê°œì›”</option>
              <option value="12">12ê°œì›”</option>
            </select>
          </div>
          <div id="cohortTable" class="overflow-x-auto mb-6"></div>
          <canvas id="cohortChart" width="800" height="400"></canvas>
        </div>
      </div>
      
      <div id="funnelTab" class="tab-content hidden">
        <div class="stat-card p-8 rounded-xl">
          <h2 class="text-2xl font-bold text-white mb-4">ì „í™˜ í¼ë„ (ê°€ì… â†’ êµ¬ë§¤)</h2>
          <canvas id="funnelChart" width="800" height="400"></canvas>
          <div id="funnelStats" class="mt-6 grid md:grid-cols-4 gap-4"></div>
        </div>
      </div>
      
      <div id="engagementTab" class="tab-content hidden">
        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <div class="stat-card p-6 rounded-xl">
            <h3 class="text-xl font-bold text-white mb-4">DAU (ì¼ë³„ í™œì„± ì‚¬ìš©ì)</h3>
            <canvas id="dauChart" width="400" height="250"></canvas>
          </div>
          <div class="stat-card p-6 rounded-xl">
            <h3 class="text-xl font-bold text-white mb-4">ì‚¬ìš©ìë‹¹ ì´ë²¤íŠ¸</h3>
            <canvas id="eventsChart" width="400" height="250"></canvas>
          </div>
        </div>
      </div>
      
      <div id="segmentsTab" class="tab-content hidden">
        <div class="stat-card p-8 rounded-xl">
          <h2 class="text-2xl font-bold text-white mb-4">ì‚¬ìš©ì ì„¸ê·¸ë¨¼íŠ¸ ë¶„í¬</h2>
          <canvas id="segmentsChart" width="800" height="400"></canvas>
          <div id="segmentsList" class="mt-6 space-y-4"></div>
        </div>
      </div>
      
      <div id="heatmapTab" class="tab-content hidden">
        <div class="stat-card p-8 rounded-xl">
          <h2 class="text-2xl font-bold text-white mb-4">í™œë™ íˆíŠ¸ë§µ (ìš”ì¼ Ã— ì‹œê°„ëŒ€)</h2>
          <canvas id="heatmapChart" width="800" height="400"></canvas>
        </div>
      </div>
      
      <div id="demographicsTab" class="tab-content hidden">
        <div class="grid md:grid-cols-2 gap-6">
          <div class="stat-card p-6 rounded-xl">
            <h3 class="text-xl font-bold text-white mb-4">ì—­í• ë³„ ì‚¬ìš©ì í†µê³„</h3>
            <canvas id="demographicsChart" width="400" height="300"></canvas>
          </div>
          <div class="stat-card p-6 rounded-xl">
            <h3 class="text-xl font-bold text-white mb-4">ì—­í• ë³„ í™œë™ë¥ </h3>
            <div id="demographicsTable" class="overflow-x-auto"></div>
          </div>
        </div>
      </div>
      
      <div id="ltvTab" class="tab-content hidden">
        <div class="stat-card p-8 rounded-xl">
          <h2 class="text-2xl font-bold text-white mb-4">ê³ ê° ìƒì•  ê°€ì¹˜ (LTV) Top 100</h2>
          <div id="ltvTable" class="overflow-x-auto"></div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  <script src="/static/advanced-analytics-dashboard.js"></script>
  <script>
    // ì¸ì¦ í™•ì¸
    const token = localStorage.getItem('auth_token');
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    
    if (!token || !user) {
      window.location.href = '/login';
    } else if (user.role !== 'admin' && user.role !== 'expert') {
      alert('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
      window.location.href = '/dashboard';
    } else {
      // ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™”
      const dashboard = new AdvancedAnalyticsDashboard();
      
      // íƒ­ ì „í™˜
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          
          // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
          document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('active', 'bg-purple-500', 'text-white');
            b.classList.add('bg-gray-800', 'text-gray-400');
          });
          btn.classList.add('active', 'bg-purple-500', 'text-white');
          btn.classList.remove('bg-gray-800', 'text-gray-400');
          
          // íƒ­ ì½˜í…ì¸  ì „í™˜
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
          });
          document.getElementById(tab + 'Tab').classList.remove('hidden');
        });
      });
    }
  </script>
  `;
  
  return c.html(getLayout(content, 'ê³ ê¸‰ ë¶„ì„ - GALLERYPIA'))
})

// ============================================
// ë¡œê·¸ì¸ í˜ì´ì§€
// ============================================
app.get('/login', (c) => {
  const content = `
  <section id="main-content" class="min-h-screen flex items-center justify-center py-20" tabindex="-1">
      <div class="w-full max-w-md px-4">
          <div class="card-nft rounded-3xl p-8 neon-border">
              <div class="text-center mb-8">
                  <div class="inline-block p-4 rounded-full gradient-primary mb-4">
                      <i class="fas fa-sign-in-alt text-4xl text-white"></i>
                  </div>
                  <h1 class="text-3xl font-bold text-white mb-2">ë¡œê·¸ì¸</h1>
                  <p class="text-gray-400">ê°¤ëŸ¬ë¦¬í”¼ì•„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</p>
              </div>
              
              <div id="alertMessage" class="hidden mb-6"></div>
              
              <form id="loginForm" class="space-y-6">
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">
                          <i class="fas fa-envelope mr-2"></i>ì´ë©”ì¼
                      </label>
                      <input 
                          type="email" 
                          name="email" 
                          required
                          class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                          placeholder="your@email.com"
                      />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">
                          <i class="fas fa-lock mr-2"></i>ë¹„ë°€ë²ˆí˜¸
                      </label>
                      <input 
                          type="password" 
                          name="password" 
                          required
                          class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                          placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                      />
                  </div>
                  
                  <div class="flex items-center justify-between">
                      <label class="flex items-center">
                          <input type="checkbox" class="w-4 h-4 rounded bg-white bg-opacity-5 border-white border-opacity-10 text-purple-600 focus:ring-purple-500">
                          <span class="ml-2 text-sm text-gray-400">ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€</span>
                      </label>
                      <a href="/forgot-password" class="text-sm text-purple-400 hover:text-purple-300">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a>
                  </div>
                  
                  <button 
                      type="submit" 
                      class="w-full gradient-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition transform hover:scale-105">
                      <i class="fas fa-sign-in-alt mr-2"></i>ë¡œê·¸ì¸
                  </button>
              </form>
              
              <div class="mt-6 text-center">
                  <p class="text-sm text-gray-400">
                      ì•„ì§ ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?
                      <a href="/signup" class="text-purple-400 hover:text-purple-300 font-semibold ml-1">íšŒì›ê°€ì…</a>
                  </p>
              </div>
              
              <div class="mt-8 pt-6 border-t border-white border-opacity-10">
                  <p class="text-xs text-gray-500 text-center mb-4">ë˜ëŠ” ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ë¡œê·¸ì¸</p>
                  <div class="grid grid-cols-3 gap-3">
                      <button onclick="showSocialLoginInfo('Google')" class="py-3 bg-white bg-opacity-5 hover:bg-opacity-10 rounded-lg transition" title="Google ë¡œê·¸ì¸">
                          <i class="fab fa-google text-xl text-red-400"></i>
                      </button>
                      <button onclick="showSocialLoginInfo('Facebook')" class="py-3 bg-white bg-opacity-5 hover:bg-opacity-10 rounded-lg transition" title="Facebook ë¡œê·¸ì¸">
                          <i class="fab fa-facebook text-xl text-blue-400"></i>
                      </button>
                      <button onclick="loginWithMetaMask()" class="py-3 bg-white bg-opacity-5 hover:bg-opacity-10 rounded-lg transition" title="MetaMask ë¡œê·¸ì¸">
                          <i class="fas fa-wallet text-xl text-orange-400"></i>
                      </button>
                  </div>
              </div>
          </div>
      </div>
  </section>
  
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  <script src="/static/auth-improved.js"></script>
  <script src="/static/social-login.js"></script>
  `;
  
  return c.html(getLayout(content, 'ë¡œê·¸ì¸ - GALLERYPIA'))
})

// ============================================
// ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° í˜ì´ì§€
// ============================================
app.get('/forgot-password', (c) => {
  const content = `
  <section class="min-h-screen flex items-center justify-center py-20">
      <div class="w-full max-w-md px-4">
          <div class="card-nft rounded-3xl p-8 neon-border">
              <div class="text-center mb-8">
                  <div class="inline-block p-4 rounded-full gradient-primary mb-4">
                      <i class="fas fa-key text-4xl text-white"></i>
                  </div>
                  <h1 class="text-3xl font-bold text-white mb-2">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</h1>
                  <p class="text-gray-400">ê°€ì…í•˜ì‹  ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
              </div>
              
              <div id="alertMessage" class="hidden mb-6"></div>
              
              <form id="forgotPasswordForm" class="space-y-6">
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">
                          <i class="fas fa-envelope mr-2"></i>ì´ë©”ì¼
                      </label>
                      <input 
                          type="email" 
                          name="email" 
                          required
                          class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                          placeholder="your@email.com"
                      />
                  </div>
                  
                  <div class="bg-blue-500 bg-opacity-10 border border-blue-500 border-opacity-30 rounded-lg p-4">
                      <p class="text-sm text-gray-300">
                          <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                          ì…ë ¥í•˜ì‹  ì´ë©”ì¼ë¡œ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë§í¬ê°€ ì „ì†¡ë©ë‹ˆë‹¤.
                      </p>
                  </div>
                  
                  <button 
                      type="submit" 
                      class="w-full gradient-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition transform hover:scale-105">
                      <i class="fas fa-paper-plane mr-2"></i>ì¬ì„¤ì • ë§í¬ ë³´ë‚´ê¸°
                  </button>
              </form>
              
              <div class="mt-6 text-center">
                  <a href="/login" class="text-sm text-purple-400 hover:text-purple-300">
                      <i class="fas fa-arrow-left mr-2"></i>ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                  </a>
              </div>
          </div>
      </div>
  </section>
  
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  <script src="/static/auth-improved.js"></script>
  `;
  
  return c.html(getLayout(content, 'ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° - GALLERYPIA'))
})

// ============================================
// ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • í˜ì´ì§€
// ============================================
app.get('/reset-password', (c) => {
  const token = c.req.query('token') || ''
  
  const content = `
  <section class="min-h-screen flex items-center justify-center py-20">
      <div class="w-full max-w-md px-4">
          <div class="card-nft rounded-3xl p-8 neon-border">
              <div class="text-center mb-8">
                  <div class="inline-block p-4 rounded-full gradient-primary mb-4">
                      <i class="fas fa-lock text-4xl text-white"></i>
                  </div>
                  <h1 class="text-3xl font-bold text-white mb-2">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</h1>
                  <p class="text-gray-400">ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
              </div>
              
              <div id="alertMessage" class="hidden mb-6"></div>
              
              <form id="resetPasswordForm" class="space-y-6">
                  <input type="hidden" name="token" value="${token}">
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">
                          <i class="fas fa-lock mr-2"></i>ìƒˆ ë¹„ë°€ë²ˆí˜¸
                      </label>
                      <input 
                          type="password" 
                          name="password" 
                          required
                          minlength="8"
                          class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                          placeholder="ìµœì†Œ 8ì ì´ìƒ"
                      />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">
                          <i class="fas fa-lock mr-2"></i>ë¹„ë°€ë²ˆí˜¸ í™•ì¸
                      </label>
                      <input 
                          type="password" 
                          name="confirm_password" 
                          required
                          minlength="8"
                          class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                          placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                      />
                  </div>
                  
                  <button 
                      type="submit" 
                      class="w-full gradient-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition transform hover:scale-105">
                      <i class="fas fa-check mr-2"></i>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                  </button>
              </form>
              
              <div class="mt-6 text-center">
                  <a href="/login" class="text-sm text-purple-400 hover:text-purple-300">
                      <i class="fas fa-arrow-left mr-2"></i>ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                  </a>
              </div>
          </div>
      </div>
  </section>
  
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  <script src="/static/auth.js?v=2"></script>
  `;
  
  return c.html(getLayout(content, 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • - GALLERYPIA'))
})

// ============================================
// ì „ë¬¸ê°€ ì‹ ì²­ í˜ì´ì§€
// ============================================
app.get('/expert/apply', (c) => {
  const content = `
  <section class="min-h-screen py-20">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-12">
              <div class="inline-block p-4 rounded-full bg-gradient-to-r from-amber-500 to-orange-500 mb-4">
                  <i class="fas fa-user-tie text-4xl text-white"></i>
              </div>
              <h1 class="text-5xl font-black mb-4">
                  <span class="text-gradient">ì „ë¬¸ê°€ ì‹ ì²­</span>
              </h1>
              <p class="text-xl text-gray-400">ì‘í’ˆ í‰ê°€ ì „ë¬¸ê°€ë¡œ í™œë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
          </div>
          
          <div class="card-nft rounded-3xl p-8 md:p-12">
              <div id="alertMessage" class="hidden mb-6"></div>
              
              <div class="bg-amber-500 bg-opacity-10 border border-amber-500 border-opacity-30 rounded-lg p-6 mb-8">
                  <h3 class="text-xl font-bold text-amber-400 mb-3 flex items-center">
                      <i class="fas fa-info-circle mr-3"></i>
                      ì „ë¬¸ê°€ ì‹ ì²­ ì•ˆë‚´
                  </h3>
                  <ul class="space-y-2 text-sm text-gray-300">
                      <li class="flex items-start">
                          <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                          <span>ì „ë¬¸ê°€ë¡œ ìŠ¹ì¸ë˜ë©´ ì‘í’ˆ í‰ê°€ ë° ì˜ê²¬ ì œê³µì´ ê°€ëŠ¥í•©ë‹ˆë‹¤</span>
                      </li>
                      <li class="flex items-start">
                          <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                          <span>í‰ê°€ í™œë™ì— ë”°ë¼ ë³´ìƒ ë° ì¸ì„¼í‹°ë¸Œê°€ ì œê³µë©ë‹ˆë‹¤</span>
                      </li>
                      <li class="flex items-start">
                          <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                          <span>ìµœì†Œ 3ë…„ ì´ìƒì˜ ê´€ë ¨ ê²½ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤</span>
                      </li>
                      <li class="flex items-start">
                          <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                          <span>ì‹¬ì‚¬ ê¸°ê°„ì€ 1-3 ì˜ì—…ì¼ ì†Œìš”ë©ë‹ˆë‹¤</span>
                      </li>
                  </ul>
              </div>
              
              <form id="expertApplicationForm" class="space-y-8">
                  <!-- ì „ë¬¸ê°€ ìœ í˜• -->
                  <div>
                      <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                          <i class="fas fa-briefcase mr-3 text-gradient"></i>
                          ì „ë¬¸ê°€ ìœ í˜• ì„ íƒ
                      </h3>
                      
                      <div class="grid md:grid-cols-2 gap-4">
                          <label class="relative cursor-pointer">
                              <input type="radio" name="expert_type" value="curator" checked class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-amber-500 peer-checked:bg-amber-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="text-lg font-bold text-white mb-2">íë ˆì´í„°</div>
                                  <p class="text-sm text-gray-400">ë¯¸ìˆ ê´€ í•™ì˜ˆì‚¬, ì „ì‹œ ê¸°íšì</p>
                              </div>
                          </label>
                          
                          <label class="relative cursor-pointer">
                              <input type="radio" name="expert_type" value="dealer" class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-amber-500 peer-checked:bg-amber-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="text-lg font-bold text-white mb-2">ë”œëŸ¬</div>
                                  <p class="text-sm text-gray-400">ê°¤ëŸ¬ë¦¬ ë””ë ‰í„°, ì•„íŠ¸ ë”œëŸ¬</p>
                              </div>
                          </label>
                          
                          <label class="relative cursor-pointer">
                              <input type="radio" name="expert_type" value="critic" class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-amber-500 peer-checked:bg-amber-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="text-lg font-bold text-white mb-2">ë¹„í‰ê°€</div>
                                  <p class="text-sm text-gray-400">ë¯¸ìˆ  ë¹„í‰ê°€, ì €ë„ë¦¬ìŠ¤íŠ¸</p>
                              </div>
                          </label>
                          
                          <label class="relative cursor-pointer">
                              <input type="radio" name="expert_type" value="professor" class="peer sr-only">
                              <div class="card-nft rounded-xl p-6 border-2 border-transparent peer-checked:border-amber-500 peer-checked:bg-amber-500 peer-checked:bg-opacity-10 transition-all">
                                  <div class="text-lg font-bold text-white mb-2">êµìˆ˜/í•™ì</div>
                                  <p class="text-sm text-gray-400">ëŒ€í•™ êµìˆ˜, ë¯¸ìˆ ì‚¬ ì—°êµ¬ì</p>
                              </div>
                          </label>
                      </div>
                  </div>
                  
                  <!-- ì†Œì† ë° ê²½ë ¥ -->
                  <div>
                      <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                          <i class="fas fa-building mr-3 text-gradient"></i>
                          ì†Œì† ë° ê²½ë ¥
                      </h3>
                      
                      <div class="grid md:grid-cols-2 gap-6">
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-university mr-2"></i>ì†Œì† ê¸°ê´€ *
                              </label>
                              <input type="text" name="institution" required
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="ì˜ˆ: ì„œìš¸ì‹œë¦½ë¯¸ìˆ ê´€">
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-id-badge mr-2"></i>ì§ì±… *
                              </label>
                              <input type="text" name="position" required
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="ì˜ˆ: ìˆ˜ì„ íë ˆì´í„°">
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-calendar-alt mr-2"></i>ê²½ë ¥ ì—°ìˆ˜ *
                              </label>
                              <input type="number" name="years_experience" required min="3"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="ì˜ˆ: 5">
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-tags mr-2"></i>ì „ë¬¸ ë¶„ì•¼ *
                              </label>
                              <input type="text" name="specialization" required
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="ì˜ˆ: í˜„ëŒ€ë¯¸ìˆ , í•œêµ­í™”">
                          </div>
                      </div>
                  </div>
                  
                  <!-- ìê²© ë° ì¦ë¹™ -->
                  <div>
                      <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                          <i class="fas fa-certificate mr-3 text-gradient"></i>
                          ìê²© ì¦ë¹™
                      </h3>
                      
                      <div class="space-y-4">
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-file-pdf mr-2"></i>ì´ë ¥ì„œ URL
                              </label>
                              <input type="url" name="resume_url"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="https://...">
                              <p class="text-xs text-gray-500 mt-1">Google Drive, Dropbox ë“±ì˜ ê³µê°œ ë§í¬</p>
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  <i class="fas fa-folder-open mr-2"></i>í¬íŠ¸í´ë¦¬ì˜¤ URL
                              </label>
                              <input type="url" name="portfolio_url"
                                     class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                     placeholder="https://...">
                          </div>
                      </div>
                  </div>
                  
                  <!-- ì§€ì› ë™ê¸° -->
                  <div>
                      <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                          <i class="fas fa-pen mr-3 text-gradient"></i>
                          ì§€ì› ë™ê¸° ë° ì „ë¬¸ì„±
                      </h3>
                      
                      <div class="space-y-4">
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  ì „ë¬¸ê°€ë¡œ í™œë™í•˜ê³ ì í•˜ëŠ” ì´ìœ  * (ìµœì†Œ 100ì)
                              </label>
                              <textarea name="motivation" required minlength="100" rows="4"
                                        class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                        placeholder="ê°¤ëŸ¬ë¦¬í”¼ì•„ ì „ë¬¸ê°€ë¡œ í™œë™í•˜ê³ ì í•˜ëŠ” ì´ìœ ì™€ ê¸°ì—¬í•  ìˆ˜ ìˆëŠ” ë¶€ë¶„ì„ ì‘ì„±í•´ì£¼ì„¸ìš”"></textarea>
                          </div>
                          
                          <div>
                              <label class="block text-sm font-medium text-gray-300 mb-2">
                                  ì „ë¬¸ ë¶„ì•¼ ìƒì„¸ ì„¤ëª… * (ìµœì†Œ 100ì)
                              </label>
                              <textarea name="expertise_description" required minlength="100" rows="4"
                                        class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition"
                                        placeholder="ë³¸ì¸ì˜ ì „ë¬¸ ë¶„ì•¼ì™€ í‰ê°€ ëŠ¥ë ¥ì— ëŒ€í•´ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”"></textarea>
                          </div>
                      </div>
                  </div>
                  
                  <!-- ì•½ê´€ ë™ì˜ -->
                  <div class="space-y-3 pt-4 border-t border-white border-opacity-10">
                      <label class="flex items-center">
                          <input type="checkbox" required class="w-5 h-5 rounded bg-white bg-opacity-5 border-white border-opacity-10 text-amber-600 focus:ring-amber-500 mr-3">
                          <span class="text-sm text-gray-300">(í•„ìˆ˜) ì „ë¬¸ê°€ í™œë™ ì•½ê´€ ë° í‰ê°€ ê°€ì´ë“œë¼ì¸ì— ë™ì˜í•©ë‹ˆë‹¤</span>
                      </label>
                      <label class="flex items-center">
                          <input type="checkbox" required class="w-5 h-5 rounded bg-white bg-opacity-5 border-white border-opacity-10 text-amber-600 focus:ring-amber-500 mr-3">
                          <span class="text-sm text-gray-300">(í•„ìˆ˜) ì œì¶œí•œ ì •ë³´ê°€ ì‚¬ì‹¤ì„ì„ í™•ì¸í•˜ë©°, í—ˆìœ„ ì‘ì„± ì‹œ ìê²©ì´ ë°•íƒˆë  ìˆ˜ ìˆìŒì„ ì¸ì§€í•©ë‹ˆë‹¤</span>
                      </label>
                  </div>
                  
                  <!-- ì œì¶œ ë²„íŠ¼ -->
                  <div class="flex flex-col sm:flex-row gap-4 pt-6">
                      <button type="submit" 
                              class="flex-1 bg-gradient-to-r from-amber-500 to-orange-500 text-white py-4 rounded-xl font-bold text-lg hover:from-amber-600 hover:to-orange-600 transition transform hover:scale-105">
                          <i class="fas fa-paper-plane mr-2"></i>
                          ì‹ ì²­ì„œ ì œì¶œ
                      </button>
                      <a href="/" 
                         class="flex-1 bg-white bg-opacity-5 text-white py-4 rounded-xl font-bold text-lg hover:bg-opacity-10 transition text-center">
                          <i class="fas fa-arrow-left mr-2"></i>
                          ì·¨ì†Œ
                      </a>
                  </div>
              </form>
          </div>
      </div>
  </section>
  
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  <script>
  document.getElementById('expertApplicationForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Get user session
    const sessionToken = localStorage.getItem('session_token');
    if (!sessionToken) {
      showError('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
      setTimeout(() => window.location.href = '/login', 1500);
      return;
    }
    
    const formData = new FormData(e.target);
    const data = {
      expert_type: formData.get('expert_type'),
      institution: formData.get('institution'),
      position: formData.get('position'),
      years_experience: parseInt(formData.get('years_experience')),
      specialization: formData.get('specialization'),
      resume_url: formData.get('resume_url') || null,
      portfolio_url: formData.get('portfolio_url') || null,
      motivation: formData.get('motivation'),
      expertise_description: formData.get('expertise_description')
    };
    
    try {
      const response = await axios.post('/api/expert/apply', data, {
        headers: { 'Authorization': 'Bearer ' + sessionToken }
      });
      
      if (response.data.success) {
        showSuccess('ì „ë¬¸ê°€ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì‹¬ì‚¬ ê²°ê³¼ëŠ” ì´ë©”ì¼ë¡œ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.');
        setTimeout(() => window.location.href = '/mypage', 2000);
      } else {
        showError(response.data.error || 'ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    } catch (error) {
      console.error('Application error:', error);
      showError(error.response?.data?.error || 'ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
  });
  
  function showSuccess(message) {
    const alertDiv = document.getElementById('alertMessage');
    alertDiv.className = 'mb-6 p-4 rounded-lg bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30';
    alertDiv.innerHTML = '<p class="text-green-400 text-sm"><i class="fas fa-check-circle mr-2"></i>' + message + '</p>';
    alertDiv.classList.remove('hidden');
  }
  
  function showError(message) {
    const alertDiv = document.getElementById('alertMessage');
    alertDiv.className = 'mb-6 p-4 rounded-lg bg-red-500 bg-opacity-10 border border-red-500 border-opacity-30';
    alertDiv.innerHTML = '<p class="text-red-400 text-sm"><i class="fas fa-exclamation-circle mr-2"></i>' + message + '</p>';
    alertDiv.classList.remove('hidden');
  }
  </script>
  `;
  
  return c.html(getLayout(content, 'ì „ë¬¸ê°€ ì‹ ì²­ - GALLERYPIA'))
})

app.get('/about', (c) => {
  const content = `
  <section class="py-16">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-16">
              <h1 class="text-6xl font-black mb-4">
                  <span class="text-gradient">GALLERYPIA</span>
              </h1>
              <p class="text-xl text-gray-400">NFT Art Museum Platform</p>
          </div>
          
          <div class="card-nft rounded-3xl p-12 mb-12">
              <h2 class="text-3xl font-bold text-white mb-6 text-center">Our Mission</h2>
              <p class="text-gray-300 text-lg leading-relaxed text-center">
                  ê°¤ëŸ¬ë¦¬í”¼ì•„ëŠ” ë¸”ë¡ì²´ì¸ ê¸°ìˆ ì„ í™œìš©í•˜ì—¬ ë¯¸ìˆ í’ˆì˜ ê°€ì¹˜ë¥¼ ì •ëŸ‰ì , ì •ì„±ì ìœ¼ë¡œ í‰ê°€í•˜ê³ <br>
                  íˆ¬ëª…í•˜ê³  ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” NFT ê±°ë˜ í”Œë«í¼ì„ ì œê³µí•©ë‹ˆë‹¤.
              </p>
          </div>
          
          <div class="mb-16">
              <h2 class="text-3xl font-bold text-white mb-8 text-center">Core Features</h2>
              <div class="grid md:grid-cols-3 gap-8">
                  <div class="card-nft rounded-2xl p-8 text-center">
                      <div class="w-16 h-16 bg-gradient-to-br from-purple-600 to-cyan-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                          <i class="fas fa-calculator text-white text-2xl"></i>
                      </div>
                      <h3 class="text-xl font-bold text-white mb-3">AI ê°€ì¹˜ì‚°ì •</h3>
                      <p class="text-gray-400 text-sm">ì •ëŸ‰ì /ì •ì„±ì  í‰ê°€ë¥¼ í†µí•œ ê³µì •í•œ ì‘í’ˆ ê°€ì¹˜ ì‚°ì •</p>
                  </div>
                  
                  <div class="card-nft rounded-2xl p-8 text-center">
                      <div class="w-16 h-16 bg-gradient-to-br from-purple-600 to-cyan-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                          <i class="fas fa-cube text-white text-2xl"></i>
                      </div>
                      <h3 class="text-xl font-bold text-white mb-3">NFT ë¯¼íŒ…</h3>
                      <p class="text-gray-400 text-sm">ë¸”ë¡ì²´ì¸ ê¸°ë°˜ì˜ ì•ˆì „í•œ NFT ë°œí–‰ ì‹œìŠ¤í…œ</p>
                  </div>
                  
                  <div class="card-nft rounded-2xl p-8 text-center">
                      <div class="w-16 h-16 bg-gradient-to-br from-purple-600 to-cyan-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                          <i class="fas fa-shield-alt text-white text-2xl"></i>
                      </div>
                      <h3 class="text-xl font-bold text-white mb-3">ì €ì‘ê¶Œ ë³´í˜¸</h3>
                      <p class="text-gray-400 text-sm">ë¸”ë¡ì²´ì¸ì„ í†µí•œ íˆ¬ëª…í•œ ì €ì‘ê¶Œ ê´€ë¦¬</p>
                  </div>
              </div>
          </div>
          
          <!-- ì›”ë“œí´ë˜ìŠ¤ ì°¨ë³„í™” ê¸°ëŠ¥ -->
          <div class="mb-16">
              <div class="text-center mb-12">
                  <div class="inline-block mb-4 px-6 py-2 bg-gradient-to-r from-purple-600/20 to-pink-600/20 backdrop-blur-sm rounded-full border border-purple-500/30">
                      <span class="text-gradient font-bold text-sm">ğŸŒŸ WORLD-CLASS PLATFORM</span>
                  </div>
                  <h2 class="text-4xl md:text-5xl font-black mb-6">
                      <span class="text-white">íƒ€ NFT í”Œë«í¼ê³¼ì˜</span><br/>
                      <span class="text-gradient">ê²°ì •ì  ì°¨ë³„í™”</span>
                  </h2>
                  <p class="text-xl text-gray-400 max-w-3xl mx-auto">
                      GalleryPiaë§Œì˜ í˜ì‹ ì ì¸ ê¸°ìˆ ë¡œ NFT ì‹œì¥ì˜ ìƒˆë¡œìš´ ê¸°ì¤€ì„ ì œì‹œí•©ë‹ˆë‹¤
                  </p>
              </div>
              
              <div class="space-y-8">
                  <!-- 1. AI ì§„ìœ„ ê²€ì¦ ì‹œìŠ¤í…œ -->
                  <div class="card-nft rounded-3xl p-8 md:p-10 border-2 border-purple-500/30 hover:border-purple-500/60 transition-all duration-500 group">
                      <div class="flex flex-col md:flex-row gap-8 items-start">
                          <div class="flex-shrink-0">
                              <div class="w-20 h-20 bg-gradient-to-br from-purple-600 to-pink-600 rounded-3xl flex items-center justify-center group-hover:rotate-12 transition-transform duration-500">
                                  <i class="fas fa-robot text-white text-4xl"></i>
                              </div>
                          </div>
                          <div class="flex-1">
                              <div class="flex items-center gap-3 mb-4">
                                  <h3 class="text-2xl md:text-3xl font-bold text-white">AI ì§„ìœ„ ê²€ì¦ ì‹œìŠ¤í…œ</h3>
                                  <span class="px-3 py-1 bg-purple-600/30 text-purple-300 rounded-full text-xs font-bold">ì„¸ê³„ ìµœì´ˆ</span>
                              </div>
                              <p class="text-gray-300 mb-6 leading-relaxed">
                                  ë”¥ëŸ¬ë‹ ê¸°ë°˜ ì´ë¯¸ì§€ ë¶„ì„ê³¼ ë¸”ë¡ì²´ì¸ ì´ë ¥ ì¶”ì ì„ ê²°í•©í•œ ì„¸ê³„ ìµœì´ˆì˜ ì™„ì „ ìë™í™” ì§„ìœ„ ê²€ì¦ ì‹œìŠ¤í…œ
                              </p>
                              <div class="grid md:grid-cols-3 gap-4">
                                  <div class="bg-purple-900/20 rounded-xl p-4 border border-purple-500/20">
                                      <div class="flex items-center gap-2 mb-2">
                                          <i class="fas fa-brain text-purple-400"></i>
                                          <span class="text-white font-semibold text-sm">AI ë¶„ì„</span>
                                      </div>
                                      <p class="text-xs text-gray-400">ë”¥ëŸ¬ë‹ ê¸°ë°˜ ì‹¤ì‹œê°„ ìœ„ì¡°í’ˆ íƒì§€</p>
                                  </div>
                                  <div class="bg-purple-900/20 rounded-xl p-4 border border-purple-500/20">
                                      <div class="flex items-center gap-2 mb-2">
                                          <i class="fas fa-link text-purple-400"></i>
                                          <span class="text-white font-semibold text-sm">ë¸”ë¡ì²´ì¸ ì¶”ì </span>
                                      </div>
                                      <p class="text-xs text-gray-400">ëª¨ë“  ê±°ë˜ ì´ë ¥ ìë™ ê²€ì¦</p>
                                  </div>
                                  <div class="bg-purple-900/20 rounded-xl p-4 border border-purple-500/20">
                                      <div class="flex items-center gap-2 mb-2">
                                          <i class="fas fa-user-shield text-purple-400"></i>
                                          <span class="text-white font-semibold text-sm">ì „ë¬¸ê°€ ê²€ì¦</span>
                                      </div>
                                      <p class="text-xs text-gray-400">2ì°¨ ì „ë¬¸ê°€ ê²€ìˆ˜ ì‹œìŠ¤í…œ</p>
                                  </div>
                              </div>
                              <div class="mt-4 flex items-center gap-2 text-sm text-purple-300">
                                  <i class="fas fa-check-circle"></i>
                                  <span class="font-semibold">íƒ€ í”Œë«í¼ ëŒ€ë¹„:</span>
                                  <span class="text-gray-400">OpenSea, Rarible ë“±ì€ ìˆ˜ë™ ê²€ì¦ë§Œ ì œê³µ</span>
                              </div>
                          </div>
                      </div>
                  </div>
                  
                  <!-- 2. ê³¼í•™ì  ê°€ì¹˜ì‚°ì • ì‹œìŠ¤í…œ -->
                  <div class="card-nft rounded-3xl p-8 md:p-10 border-2 border-blue-500/30 hover:border-blue-500/60 transition-all duration-500 group">
                      <div class="flex flex-col md:flex-row gap-8 items-start">
                          <div class="flex-shrink-0">
                              <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-cyan-600 rounded-3xl flex items-center justify-center group-hover:rotate-12 transition-transform duration-500">
                                  <i class="fas fa-chart-line text-white text-4xl"></i>
                              </div>
                          </div>
                          <div class="flex-1">
                              <div class="flex items-center gap-3 mb-4">
                                  <h3 class="text-2xl md:text-3xl font-bold text-white">83ê°œ ë³€ìˆ˜ ê³¼í•™ì  ê°€ì¹˜ì‚°ì •</h3>
                                  <span class="px-3 py-1 bg-blue-600/30 text-blue-300 rounded-full text-xs font-bold">í•™ìˆ  ê²€ì¦</span>
                              </div>
                              <p class="text-gray-300 mb-6 leading-relaxed">
                                  5ê°œ ì¹´í…Œê³ ë¦¬ 83ê°œ ë³€ìˆ˜ë¥¼ ë¶„ì„í•˜ëŠ” ì„¸ê³„ ìœ ì¼ì˜ í•™ìˆ  ë…¼ë¬¸ ê¸°ë°˜ NFT ê°€ì¹˜í‰ê°€ ì‹œìŠ¤í…œ
                              </p>
                              <div class="grid md:grid-cols-5 gap-3 mb-4">
                                  <div class="bg-blue-900/20 rounded-lg p-3 border border-blue-500/20 text-center">
                                      <div class="text-2xl font-bold text-blue-400 mb-1">20%</div>
                                      <div class="text-xs text-gray-400">ì‘ê°€ ì„±ì·¨ë„</div>
                                  </div>
                                  <div class="bg-blue-900/20 rounded-lg p-3 border border-blue-500/20 text-center">
                                      <div class="text-2xl font-bold text-blue-400 mb-1">20%</div>
                                      <div class="text-xs text-gray-400">ì‘í’ˆ ë‚´ìš©</div>
                                  </div>
                                  <div class="bg-blue-900/20 rounded-lg p-3 border border-blue-500/20 text-center">
                                      <div class="text-2xl font-bold text-blue-400 mb-1">20%</div>
                                      <div class="text-xs text-gray-400">ì¸ì¦ë„</div>
                                  </div>
                                  <div class="bg-blue-900/20 rounded-lg p-3 border border-blue-500/20 text-center">
                                      <div class="text-2xl font-bold text-blue-400 mb-1">20%</div>
                                      <div class="text-xs text-gray-400">ì „ë¬¸ê°€ í‰ê°€</div>
                                  </div>
                                  <div class="bg-blue-900/20 rounded-lg p-3 border border-blue-500/20 text-center">
                                      <div class="text-2xl font-bold text-blue-400 mb-1">20%</div>
                                      <div class="text-xs text-gray-400">ëŒ€ì¤‘ì„±</div>
                                  </div>
                              </div>
                              <div class="mt-4 flex items-center gap-2 text-sm text-blue-300">
                                  <i class="fas fa-check-circle"></i>
                                  <span class="font-semibold">íƒ€ í”Œë«í¼ ëŒ€ë¹„:</span>
                                  <span class="text-gray-400">Foundation, SuperRareëŠ” ì£¼ê´€ì  íë ˆì´ì…˜ë§Œ ì œê³µ</span>
                              </div>
                          </div>
                      </div>
                  </div>
                  
                  <!-- 3. ì™„ì „ ìë™í™” ë¡œì—´í‹° ì‹œìŠ¤í…œ -->
                  <div class="card-nft rounded-3xl p-8 md:p-10 border-2 border-green-500/30 hover:border-green-500/60 transition-all duration-500 group">
                      <div class="flex flex-col md:flex-row gap-8 items-start">
                          <div class="flex-shrink-0">
                              <div class="w-20 h-20 bg-gradient-to-br from-green-600 to-emerald-600 rounded-3xl flex items-center justify-center group-hover:rotate-12 transition-transform duration-500">
                                  <i class="fas fa-coins text-white text-4xl"></i>
                              </div>
                          </div>
                          <div class="flex-1">
                              <div class="flex items-center gap-3 mb-4">
                                  <h3 class="text-2xl md:text-3xl font-bold text-white">ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸ ë¡œì—´í‹° ìë™í™”</h3>
                                  <span class="px-3 py-1 bg-green-600/30 text-green-300 rounded-full text-xs font-bold">ì™„ì „ ìë™</span>
                              </div>
                              <p class="text-gray-300 mb-6 leading-relaxed">
                                  ê±°ë˜ ë°œìƒ ì¦‰ì‹œ ì‘ê°€, ê°¤ëŸ¬ë¦¬, íë ˆì´í„°ì—ê²Œ ìë™ ì •ì‚°ë˜ëŠ” ì™„ì „ íˆ¬ëª…í•œ ìˆ˜ìµ ë¶„ë°° ì‹œìŠ¤í…œ
                              </p>
                              <div class="grid md:grid-cols-3 gap-4">
                                  <div class="bg-green-900/20 rounded-xl p-4 border border-green-500/20">
                                      <div class="flex items-center gap-2 mb-2">
                                          <i class="fas fa-bolt text-green-400"></i>
                                          <span class="text-white font-semibold text-sm">ì¦‰ì‹œ ì •ì‚°</span>
                                      </div>
                                      <p class="text-xs text-gray-400">ê±°ë˜ ì™„ë£Œì™€ ë™ì‹œì— ìë™ ë¶„ë°°</p>
                                  </div>
                                  <div class="bg-green-900/20 rounded-xl p-4 border border-green-500/20">
                                      <div class="flex items-center gap-2 mb-2">
                                          <i class="fas fa-eye text-green-400"></i>
                                          <span class="text-white font-semibold text-sm">ì™„ì „ íˆ¬ëª…</span>
                                      </div>
                                      <p class="text-xs text-gray-400">ëª¨ë“  ê±°ë˜ ë‚´ì—­ ë¸”ë¡ì²´ì¸ ê¸°ë¡</p>
                                  </div>
                                  <div class="bg-green-900/20 rounded-xl p-4 border border-green-500/20">
                                      <div class="flex items-center gap-2 mb-2">
                                          <i class="fas fa-users text-green-400"></i>
                                          <span class="text-white font-semibold text-sm">ë‹¤ìê°„ ë¶„ë°°</span>
                                      </div>
                                      <p class="text-xs text-gray-400">ì‘ê°€/ê°¤ëŸ¬ë¦¬/íë ˆì´í„° ìë™ ë°°ë¶„</p>
                                  </div>
                              </div>
                              <div class="mt-4 flex items-center gap-2 text-sm text-green-300">
                                  <i class="fas fa-check-circle"></i>
                                  <span class="font-semibold">íƒ€ í”Œë«í¼ ëŒ€ë¹„:</span>
                                  <span class="text-gray-400">Nifty GatewayëŠ” ì‘ê°€ ë¡œì—´í‹°ë§Œ ì œê³µ, ì¤‘ê°œì¸ ë¶„ë°° ì—†ìŒ</span>
                              </div>
                          </div>
                      </div>
                  </div>
                  
                  <!-- 4. ê¸€ë¡œë²Œ íŒŒíŠ¸ë„ˆì‹­ ë„¤íŠ¸ì›Œí¬ -->
                  <div class="card-nft rounded-3xl p-8 md:p-10 border-2 border-amber-500/30 hover:border-amber-500/60 transition-all duration-500 group">
                      <div class="flex flex-col md:flex-row gap-8 items-start">
                          <div class="flex-shrink-0">
                              <div class="w-20 h-20 bg-gradient-to-br from-amber-600 to-orange-600 rounded-3xl flex items-center justify-center group-hover:rotate-12 transition-transform duration-500">
                                  <i class="fas fa-handshake text-white text-4xl"></i>
                              </div>
                          </div>
                          <div class="flex-1">
                              <div class="flex items-center gap-3 mb-4">
                                  <h3 class="text-2xl md:text-3xl font-bold text-white">MuseumÂ·GalleryÂ·Dealer í†µí•©</h3>
                                  <span class="px-3 py-1 bg-amber-600/30 text-amber-300 rounded-full text-xs font-bold">ê¸€ë¡œë²Œ</span>
                              </div>
                              <p class="text-gray-300 mb-6 leading-relaxed">
                                  ë¯¸ìˆ ê´€, ê°¤ëŸ¬ë¦¬, ì•„íŠ¸ë”œëŸ¬ê°€ ëª¨ë‘ ì°¸ì—¬í•˜ëŠ” ì„¸ê³„ ìµœì´ˆì˜ í†µí•© NFT íë ˆì´ì…˜ í”Œë«í¼
                              </p>
                              <div class="grid md:grid-cols-3 gap-4">
                                  <div class="bg-amber-900/20 rounded-xl p-4 border border-amber-500/20">
                                      <div class="flex items-center gap-2 mb-2">
                                          <i class="fas fa-landmark text-amber-400"></i>
                                          <span class="text-white font-semibold text-sm">Museum</span>
                                      </div>
                                      <p class="text-xs text-gray-400">ì„¸ê³„ì  ë¯¸ìˆ ê´€ ì—°ê³„ ì „ì‹œ</p>
                                  </div>
                                  <div class="bg-amber-900/20 rounded-xl p-4 border border-amber-500/20">
                                      <div class="flex items-center gap-2 mb-2">
                                          <i class="fas fa-palette text-amber-400"></i>
                                          <span class="text-white font-semibold text-sm">Gallery</span>
                                      </div>
                                      <p class="text-xs text-gray-400">ì „ë¬¸ ê°¤ëŸ¬ë¦¬ íë ˆì´ì…˜</p>
                                  </div>
                                  <div class="bg-amber-900/20 rounded-xl p-4 border border-amber-500/20">
                                      <div class="flex items-center gap-2 mb-2">
                                          <i class="fas fa-briefcase text-amber-400"></i>
                                          <span class="text-white font-semibold text-sm">Art Dealer</span>
                                      </div>
                                      <p class="text-xs text-gray-400">ê²€ì¦ëœ ë”œëŸ¬ ë„¤íŠ¸ì›Œí¬</p>
                                  </div>
                              </div>
                              <div class="mt-4 flex items-center gap-2 text-sm text-amber-300">
                                  <i class="fas fa-check-circle"></i>
                                  <span class="font-semibold">íƒ€ í”Œë«í¼ ëŒ€ë¹„:</span>
                                  <span class="text-gray-400">Async Art, KnownOriginì€ ê°œë³„ ì‘ê°€ ì¤‘ì‹¬ë§Œ ì§€ì›</span>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
              
              <!-- ë¹„êµ ìš”ì•½ í…Œì´ë¸” -->
              <div class="mt-12 card-nft rounded-3xl p-8 border-2 border-purple-500/30">
                  <h3 class="text-2xl font-bold text-white mb-6 text-center">
                      <i class="fas fa-trophy text-gradient mr-2"></i>
                      ê²½ìŸì‚¬ ë¹„êµ
                  </h3>
                  <div class="overflow-x-auto">
                      <table class="w-full text-sm">
                          <thead>
                              <tr class="border-b border-gray-700">
                                  <th class="text-left py-4 px-4 text-gray-400 font-semibold">ê¸°ëŠ¥</th>
                                  <th class="text-center py-4 px-4 text-gradient font-bold">GalleryPia</th>
                                  <th class="text-center py-4 px-4 text-gray-400">OpenSea</th>
                                  <th class="text-center py-4 px-4 text-gray-400">Rarible</th>
                                  <th class="text-center py-4 px-4 text-gray-400">Foundation</th>
                              </tr>
                          </thead>
                          <tbody class="text-gray-300">
                              <tr class="border-b border-gray-800">
                                  <td class="py-4 px-4">AI ì§„ìœ„ ê²€ì¦</td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-check-circle text-green-400 text-xl"></i></td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-times-circle text-red-400"></i></td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-times-circle text-red-400"></i></td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-times-circle text-red-400"></i></td>
                              </tr>
                              <tr class="border-b border-gray-800">
                                  <td class="py-4 px-4">ê³¼í•™ì  ê°€ì¹˜ì‚°ì •</td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-check-circle text-green-400 text-xl"></i></td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-times-circle text-red-400"></i></td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-times-circle text-red-400"></i></td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-minus-circle text-yellow-400"></i></td>
                              </tr>
                              <tr class="border-b border-gray-800">
                                  <td class="py-4 px-4">ìë™ ë¡œì—´í‹° ë¶„ë°°</td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-check-circle text-green-400 text-xl"></i></td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-minus-circle text-yellow-400"></i></td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-minus-circle text-yellow-400"></i></td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-minus-circle text-yellow-400"></i></td>
                              </tr>
                              <tr class="border-b border-gray-800">
                                  <td class="py-4 px-4">Museum íŒŒíŠ¸ë„ˆì‹­</td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-check-circle text-green-400 text-xl"></i></td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-times-circle text-red-400"></i></td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-times-circle text-red-400"></i></td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-times-circle text-red-400"></i></td>
                              </tr>
                              <tr>
                                  <td class="py-4 px-4">í•™ìˆ  ë…¼ë¬¸ ê¸°ë°˜</td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-check-circle text-green-400 text-xl"></i></td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-times-circle text-red-400"></i></td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-times-circle text-red-400"></i></td>
                                  <td class="text-center py-4 px-4"><i class="fas fa-times-circle text-red-400"></i></td>
                              </tr>
                          </tbody>
                      </table>
                  </div>
                  <div class="mt-6 text-center">
                      <p class="text-gray-400 text-sm">
                          <i class="fas fa-check-circle text-green-400"></i> ì™„ì „ ì§€ì› &nbsp;&nbsp;
                          <i class="fas fa-minus-circle text-yellow-400"></i> ë¶€ë¶„ ì§€ì› &nbsp;&nbsp;
                          <i class="fas fa-times-circle text-red-400"></i> ë¯¸ì§€ì›
                      </p>
                  </div>
              </div>
          </div>
          
          <div class="card-nft rounded-3xl p-12 mb-12">
              <h2 class="text-3xl font-bold text-white mb-6">Research Background</h2>
              <div class="space-y-6 text-gray-300">
                  <p class="leading-relaxed">ê°¤ëŸ¬ë¦¬í”¼ì•„ëŠ” ë¸”ë¡ì²´ì¸ ê¸°ë°˜ì˜ ë¯¸ìˆ í’ˆ ê°€ì¹˜ í‰ê°€ í”„ë ˆì„ì›Œí¬ ì—°êµ¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê°œë°œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                  <div class="bg-white bg-opacity-5 rounded-xl p-6 mb-6">
                      <h3 class="text-xl font-bold text-white mb-4"><i class="fas fa-presentation mr-2 text-gradient"></i>Conference Presentations</h3>
                      <ul class="space-y-3 text-sm">
                          <li class="flex items-start"><i class="fas fa-check-circle text-gradient mr-3 mt-1"></i><span>A Study on the Framework Process for Modular Services of Art NFT</span></li>
                          <li class="flex items-start"><i class="fas fa-check-circle text-gradient mr-3 mt-1"></i><span>Research into the valuation and ownership of artworks in the NFT market</span></li>
                          <li class="flex items-start"><i class="fas fa-check-circle text-gradient mr-3 mt-1"></i><span>Approach to NFT Service Framework Based on Art Value Calculation</span></li>
                          <li class="flex items-start"><i class="fas fa-check-circle text-gradient mr-3 mt-1"></i><span>Reflections on the perceived problems with Art NFTs</span></li>
                          <li class="flex items-start"><i class="fas fa-check-circle text-gradient mr-3 mt-1"></i><span>Research on NFT Artwork Ownership/Copyright Service Framework</span></li>
                          <li class="flex items-start"><i class="fas fa-check-circle text-gradient mr-3 mt-1"></i><span>Researching a Framework for Valuing NFT Artwork</span></li>
                      </ul>
                  </div>
                  <div class="bg-white bg-opacity-5 rounded-xl p-6">
                      <h3 class="text-xl font-bold text-white mb-4"><i class="fas fa-file-alt mr-2 text-gradient"></i>Published Papers</h3>
                      <ul class="space-y-3 text-sm">
                          <li class="flex items-start"><i class="fas fa-check-circle text-gradient mr-3 mt-1"></i><span>ë¯¸ìˆ í’ˆ NFT ì„œë¹„ìŠ¤ ëª¨ë“ˆë³„ ê¸°ëŠ¥ í”„ë ˆì„ì›Œí¬ ì—°êµ¬</span></li>
                          <li class="flex items-start"><i class="fas fa-check-circle text-gradient mr-3 mt-1"></i><span>NFT ë¯¸ìˆ í’ˆ êµ¬ë§¤/íˆ¬ìì— ë”°ë¥¸ ë¬¸ì œì  ë¶„ì„ê³¼ í•´ê²°ë°©ì•ˆ ì—°êµ¬</span></li>
                          <li class="flex items-start"><i class="fas fa-check-circle text-gradient mr-3 mt-1"></i><span>NFT ë¯¸ìˆ ì‘í’ˆ ê°€ì¹˜ í‰ê°€ ê¸°ë°˜í•˜ì˜ ë­í¬ í”„ë ˆì„ì›Œí¬ ì—°êµ¬</span></li>
                      </ul>
                  </div>
              </div>
          </div>
          
          <div class="mb-12">
              <h2 class="text-3xl font-bold text-white mb-8 text-center">Research Team</h2>
              <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                  <div class="card-nft rounded-2xl p-6 text-center">
                      <div class="text-xl font-bold text-gradient mb-2">ë‚¨í˜„ìš°</div>
                      <div class="text-gray-400 text-sm">ì„œê²½ëŒ€í•™êµ êµìˆ˜</div>
                      <div class="text-purple-400 text-xs mt-1">ì—°êµ¬ì±…ì„ì</div>
                  </div>
                  <div class="card-nft rounded-2xl p-6 text-center">
                      <div class="text-xl font-bold text-gradient mb-2">ë‚¨ì˜ìš°</div>
                      <div class="text-gray-400 text-sm">ìƒì›ë¯¸ìˆ ê´€ ê´€ì¥</div>
                  </div>
                  <div class="card-nft rounded-2xl p-6 text-center">
                      <div class="text-xl font-bold text-gradient mb-2">ê³ ì£¼í¬</div>
                      <div class="text-gray-400 text-sm">ì—°êµ¬ì›</div>
                  </div>
                  <div class="card-nft rounded-2xl p-6 text-center">
                      <div class="text-xl font-bold text-gradient mb-2">ê¹€ì‹œìœ¤</div>
                      <div class="text-gray-400 text-sm">ì—°êµ¬ì›</div>
                  </div>
                  <div class="card-nft rounded-2xl p-6 text-center">
                      <div class="text-xl font-bold text-gradient mb-2">ì•ˆì„œì˜</div>
                      <div class="text-gray-400 text-sm">ì—°êµ¬ì›</div>
                  </div>
                  <div class="card-nft rounded-2xl p-6 text-center">
                      <div class="text-xl font-bold text-gradient mb-2">ê¹€ì˜¤ìœ¤</div>
                      <div class="text-gray-400 text-sm">ì—°êµ¬ì›</div>
                  </div>
              </div>
              
              <h3 class="text-2xl font-bold text-white mb-6 text-center">Advisory Board</h3>
              <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div class="card-nft rounded-xl p-5 text-center">
                      <div class="text-lg font-semibold text-white mb-1">ì–‘ì—°ê²½ êµìˆ˜</div>
                      <div class="text-gray-400 text-xs">ìƒëª…ëŒ€í•™êµ í¬ë¦¬ì—ì´í‹°ë¸Œì½˜í…ì¸ ì—°êµ¬ì†Œ ì „ì„ì—°êµ¬êµìˆ˜</div>
                  </div>
                  <div class="card-nft rounded-xl p-5 text-center">
                      <div class="text-lg font-semibold text-white mb-1">ìœ í•´ì˜ ëª…ì˜ˆêµìˆ˜</div>
                      <div class="text-gray-400 text-xs">ë‹¨êµ­ëŒ€í•™êµ ì»´í“¨í„°ê³µí•™ê³¼</div>
                  </div>
                  <div class="card-nft rounded-xl p-5 text-center">
                      <div class="text-lg font-semibold text-white mb-1">ê¹€ì¢…ì› êµìˆ˜</div>
                      <div class="text-gray-400 text-xs">ìƒëª…ëŒ€í•™êµ ì§€ëŠ¥ IoT, ë¸”ë¡ì²´ì¸</div>
                  </div>
                  <div class="card-nft rounded-xl p-5 text-center">
                      <div class="text-lg font-semibold text-white mb-1">ì´ì¢…ë¹ˆ ëŒ€í‘œ</div>
                      <div class="text-gray-400 text-xs">ê´€í›ˆì•„ë¥´í…Œ</div>
                  </div>
                  <div class="card-nft rounded-xl p-5 text-center">
                      <div class="text-lg font-semibold text-white mb-1">ì„ì˜ìˆœ ëŒ€í‘œ</div>
                      <div class="text-gray-400 text-xs">(ì£¼)ì½”ì  í™€ë”©ìŠ¤</div>
                  </div>
                  <div class="card-nft rounded-xl p-5 text-center">
                      <div class="text-lg font-semibold text-white mb-1">ìœ¡íƒœì„ í•™ì˜ˆì‚¬</div>
                      <div class="text-gray-400 text-xs">ì „ìŸê³¼ì—¬ì„±ì¸ê¶Œ ë°•ë¬¼ê´€</div>
                  </div>
              </div>
          </div>
          
          <!-- ì§€ì ì¬ì‚°ê¶Œ ë³´í˜¸ ë° ê¸°ìˆ ì´ì „ ì•ˆë‚´ -->
          <div class="card-nft rounded-3xl p-8 border-2 border-amber-500/40">
              <div class="flex items-start gap-6">
                  <div class="flex-shrink-0">
                      <div class="w-16 h-16 bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl flex items-center justify-center">
                          <i class="fas fa-shield-alt text-white text-2xl"></i>
                      </div>
                  </div>
                  <div class="flex-1">
                      <div class="flex items-center gap-3 mb-4">
                          <i class="fas fa-copyright text-amber-400 text-xl"></i>
                          <h3 class="text-2xl font-bold text-amber-300">ì§€ì ì¬ì‚°ê¶Œ ë³´í˜¸ ì•ˆë‚´</h3>
                      </div>
                      <div class="space-y-3 text-gray-300 leading-relaxed">
                          <p class="text-base">
                              <span class="text-white font-semibold">ìƒê¸° ì—°êµ¬ í”„ë¡œì íŠ¸ëŠ” í•™ìˆ ë…¼ë¬¸ ê¸°ë°˜ìœ¼ë¡œ ì €ì‘ê¶Œ, íŠ¹í—ˆì˜ ë³´í˜¸ë¥¼ ë°›ê³  ìˆìŠµë‹ˆë‹¤.</span>
                          </p>
                          <div class="flex items-center gap-2 text-red-300">
                              <i class="fas fa-exclamation-triangle"></i>
                              <p class="text-sm font-semibold">ë¬´ë‹¨ ë³µì œë¥¼ ê¸ˆí•©ë‹ˆë‹¤.</p>
                          </div>
                      </div>
                      
                      <div class="mt-6 pt-6 border-t border-amber-500/30">
                          <div class="flex items-start gap-3">
                              <i class="fas fa-handshake text-cyan-400 text-xl mt-1"></i>
                              <div>
                                  <h4 class="text-lg font-bold text-cyan-300 mb-2">ê¸°ìˆ ì´ì „ ë¬¸ì˜</h4>
                                  <p class="text-gray-300 text-sm mb-3">
                                      ê¸°ìˆ ì´ì „ì„ ì›í•˜ì‹œë©´ ì•„ë˜ ì—°ë½ì²˜ë¡œ ë¬¸ì˜í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
                                  </p>
                                  <div class="flex flex-wrap gap-4">
                                      <div class="flex items-center gap-2 text-sm">
                                          <i class="fas fa-envelope text-purple-400"></i>
                                          <span class="text-gray-300">gallerypia@gmail.com</span>
                                      </div>
                                      <div class="flex items-center gap-2 text-sm">
                                          <i class="fas fa-phone text-green-400"></i>
                                          <span class="text-gray-300">ë¬¸ì˜ ê°€ëŠ¥</span>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                      
                      <div class="mt-6 p-4 bg-gradient-to-r from-amber-900/30 via-orange-900/20 to-yellow-900/30 rounded-xl border border-amber-500/20">
                          <div class="flex items-center gap-2 text-amber-300 text-sm">
                              <i class="fas fa-award"></i>
                              <span class="font-semibold">ë³´í˜¸ í•­ëª©:</span>
                              <span class="text-gray-300">NFT ë¯¸ìˆ í’ˆ ê°€ì¹˜í‰ê°€ ì‹œìŠ¤í…œ, ë­í‚¹ ì•Œê³ ë¦¬ì¦˜, ë¸”ë¡ì²´ì¸ ê¸°ë°˜ ì €ì‘ê¶Œ ê´€ë¦¬ ì‹œìŠ¤í…œ</span>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
          
          <!-- í”Œë«í¼ ì—…ë°ì´íŠ¸ ë‚´ì—­ -->
          <div class="mb-16">
              <div class="text-center mb-12">
                  <div class="inline-block mb-4 px-6 py-2 bg-gradient-to-r from-cyan-600/20 to-blue-600/20 backdrop-blur-sm rounded-full border border-cyan-500/30">
                      <span class="text-gradient font-bold text-sm">ğŸ“‹ UPDATE HISTORY</span>
                  </div>
                  <h2 class="text-4xl md:text-5xl font-black mb-6">
                      <span class="text-white">í”Œë«í¼</span>
                      <span class="text-gradient"> ì—…ë°ì´íŠ¸ ë‚´ì—­</span>
                  </h2>
                  <p class="text-xl text-gray-400 max-w-3xl mx-auto">
                      ì§€ì†ì ì¸ ê°œì„ ê³¼ í˜ì‹ ìœ¼ë¡œ ìµœê³ ì˜ NFT í”Œë«í¼ì„ ë§Œë“¤ì–´ê°‘ë‹ˆë‹¤
                  </p>
              </div>
              
              <div class="space-y-6">
                  <!-- v11.1.2 Critical Security Patch -->
                  <div class="card-nft rounded-2xl p-6 border-2 border-red-500/40 hover:border-red-500/60 transition-all bg-red-900/10">
                      <div class="flex items-start gap-4 mb-4">
                          <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-br from-red-600 to-pink-600 rounded-xl flex items-center justify-center animate-pulse">
                              <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                          </div>
                          <div class="flex-1">
                              <div class="flex items-center gap-3 mb-2">
                                  <h3 class="text-xl font-bold text-white">v11.1.2 Critical Security Patch</h3>
                                  <span class="px-2 py-1 bg-red-600/30 text-red-300 rounded-full text-xs font-bold">2025-11-25</span>
                                  <span class="px-2 py-1 bg-yellow-600/30 text-yellow-300 rounded-full text-xs font-bold">URGENT</span>
                              </div>
                              <p class="text-sm text-gray-400 mb-3">ì‹¬ê°í•œ ë³´ì•ˆ ì·¨ì•½ì  ê¸´ê¸‰ íŒ¨ì¹˜ (ëª¨ë“  ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ê¶Œì¥)</p>
                              <div class="grid md:grid-cols-2 gap-3 text-sm">
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-shield text-red-400 mt-1"></i>
                                      <span class="text-gray-300"><strong class="text-red-300">bcrypt ë¹„ë°€ë²ˆí˜¸ í•´ì‹±</strong> (í‰ë¬¸ ì €ì¥ ì·¨ì•½ì  ìˆ˜ì •)</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-cookie-bite text-red-400 mt-1"></i>
                                      <span class="text-gray-300"><strong class="text-red-300">HttpOnly ì¿ í‚¤</strong> ì„¸ì…˜ í† í° (XSS ë°©ì§€)</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-lock text-red-400 mt-1"></i>
                                      <span class="text-gray-300">ë°±ì—”ë“œ ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ê²€ì¦ (8ì+ëŒ€ì†Œë¬¸ì+ìˆ«ì+íŠ¹ìˆ˜ë¬¸ì)</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-database text-red-400 mt-1"></i>
                                      <span class="text-gray-300">ì´ë©”ì¼/ìœ ì €ëª… Unique Constraint (ì¤‘ë³µ ë°©ì§€)</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-user-shield text-red-400 mt-1"></i>
                                      <span class="text-gray-300">Timing Attack ë°©ì§€ (ì•ˆì „í•œ ë¹„ë°€ë²ˆí˜¸ ë¹„êµ)</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-check-double text-red-400 mt-1"></i>
                                      <span class="text-gray-300">OWASP Top 10 ë³´ì•ˆ ê¸°ì¤€ ì¤€ìˆ˜</span>
                                  </div>
                              </div>
                              <div class="mt-4 p-3 bg-yellow-900/20 border border-yellow-500/30 rounded-xl">
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-info-circle text-yellow-400 mt-0.5"></i>
                                      <div class="text-xs text-gray-300">
                                          <strong class="text-yellow-300">Breaking Change:</strong> ê¸°ì¡´ ì‚¬ìš©ìëŠ” ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. 
                                          ìƒˆë¡œìš´ bcrypt í•´ì‹±ìœ¼ë¡œ ë³´ì•ˆì´ ëŒ€í­ ê°•í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
                  
                  <!-- v11.1 Security & UX Update -->
                  <div class="card-nft rounded-2xl p-6 border border-cyan-500/20 hover:border-cyan-500/40 transition-all">
                      <div class="flex items-start gap-4 mb-4">
                          <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-br from-cyan-600 to-blue-600 rounded-xl flex items-center justify-center">
                              <i class="fas fa-shield-alt text-white text-xl"></i>
                          </div>
                          <div class="flex-1">
                              <div class="flex items-center gap-3 mb-2">
                                  <h3 class="text-xl font-bold text-white">v11.1 Security & UX Enhancement</h3>
                                  <span class="px-2 py-1 bg-cyan-600/30 text-cyan-300 rounded-full text-xs font-bold">2025-11</span>
                              </div>
                              <div class="grid md:grid-cols-2 gap-3 text-sm">
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-lock text-cyan-400 mt-1"></i>
                                      <span class="text-gray-300">httpOnly Cookie JWT ì¸ì¦ (XSS ë°©ì§€)</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-key text-cyan-400 mt-1"></i>
                                      <span class="text-gray-300">ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ê²€ì¦ ê³ ë„í™”</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-tachometer-alt text-cyan-400 mt-1"></i>
                                      <span class="text-gray-300">Rate Limiting (API ë³´í˜¸)</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-check-circle text-cyan-400 mt-1"></i>
                                      <span class="text-gray-300">ì‹¤ì‹œê°„ í¼ ê²€ì¦ ì‹œìŠ¤í…œ</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-envelope text-cyan-400 mt-1"></i>
                                      <span class="text-gray-300">ì´ë©”ì¼ ì˜¤íƒ€ ìë™ ê°ì§€</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-spinner text-cyan-400 mt-1"></i>
                                      <span class="text-gray-300">ë¡œë”© ìŠ¤ì¼ˆë ˆí†¤ UX ê°œì„ </span>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
                  
                  <!-- v11.0 Complete Platform -->
                  <div class="card-nft rounded-2xl p-6 border border-purple-500/20 hover:border-purple-500/40 transition-all">
                      <div class="flex items-start gap-4 mb-4">
                          <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-br from-purple-600 to-pink-600 rounded-xl flex items-center justify-center">
                              <i class="fas fa-rocket text-white text-xl"></i>
                          </div>
                          <div class="flex-1">
                              <div class="flex items-center gap-3 mb-2">
                                  <h3 class="text-xl font-bold text-white">v11.0 Full Platform Completion</h3>
                                  <span class="px-2 py-1 bg-purple-600/30 text-purple-300 rounded-full text-xs font-bold">2025-11</span>
                              </div>
                              <div class="grid md:grid-cols-2 gap-3 text-sm">
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-star text-purple-400 mt-1"></i>
                                      <span class="text-gray-300">57ê°œ í•µì‹¬ ê¸°ëŠ¥ 100% êµ¬í˜„ ì™„ë£Œ</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-brain text-purple-400 mt-1"></i>
                                      <span class="text-gray-300">AI ê°€ê²© ì˜ˆì¸¡ ì‹œìŠ¤í…œ</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-vr-cardboard text-purple-400 mt-1"></i>
                                      <span class="text-gray-300">AR/VR ê°€ìƒ ì „ì‹œê´€</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-comments text-purple-400 mt-1"></i>
                                      <span class="text-gray-300">ì‹¤ì‹œê°„ ì±„íŒ… ì‹œìŠ¤í…œ</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-chart-line text-purple-400 mt-1"></i>
                                      <span class="text-gray-300">ê³ ê¸‰ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-globe text-purple-400 mt-1"></i>
                                      <span class="text-gray-300">ë‹¤êµ­ì–´ ì§€ì› (5ê°œ ì–¸ì–´)</span>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
                  
                  <!-- Algorithm & Performance -->
                  <div class="card-nft rounded-2xl p-6 border border-amber-500/20 hover:border-amber-500/40 transition-all">
                      <div class="flex items-start gap-4 mb-4">
                          <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-br from-amber-600 to-orange-600 rounded-xl flex items-center justify-center">
                              <i class="fas fa-cogs text-white text-xl"></i>
                          </div>
                          <div class="flex-1">
                              <div class="flex items-center gap-3 mb-2">
                                  <h3 class="text-xl font-bold text-white">Algorithm & Performance Optimization</h3>
                                  <span class="px-2 py-1 bg-amber-600/30 text-amber-300 rounded-full text-xs font-bold">Ongoing</span>
                              </div>
                              <div class="grid md:grid-cols-2 gap-3 text-sm">
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-calculator text-amber-400 mt-1"></i>
                                      <span class="text-gray-300">NFT ê°€ì¹˜ì‚°ì • ì•Œê³ ë¦¬ì¦˜ ê³ ë„í™”</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-database text-amber-400 mt-1"></i>
                                      <span class="text-gray-300">ì‘ê°€/ì‘í’ˆ ë©”íƒ€ë°ì´í„° í™•ì¥</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-bolt text-amber-400 mt-1"></i>
                                      <span class="text-gray-300">í˜ì´ì§€ ë¡œë”© ì†ë„ 44% í–¥ìƒ</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-compress text-amber-400 mt-1"></i>
                                      <span class="text-gray-300">ë²ˆë“¤ í¬ê¸° 38% ìµœì í™”</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-image text-amber-400 mt-1"></i>
                                      <span class="text-gray-300">ì´ë¯¸ì§€ ì²˜ë¦¬ ì•ˆì •ì„± ê°œì„ </span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-mobile-alt text-amber-400 mt-1"></i>
                                      <span class="text-gray-300">ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ ì „ë©´ ê°œí¸</span>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
                  
                  <!-- User Experience -->
                  <div class="card-nft rounded-2xl p-6 border border-emerald-500/20 hover:border-emerald-500/40 transition-all">
                      <div class="flex items-start gap-4 mb-4">
                          <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-br from-emerald-600 to-teal-600 rounded-xl flex items-center justify-center">
                              <i class="fas fa-heart text-white text-xl"></i>
                          </div>
                          <div class="flex-1">
                              <div class="flex items-center gap-3 mb-2">
                                  <h3 class="text-xl font-bold text-white">User Experience Enhancement</h3>
                                  <span class="px-2 py-1 bg-emerald-600/30 text-emerald-300 rounded-full text-xs font-bold">Continuous</span>
                              </div>
                              <div class="grid md:grid-cols-2 gap-3 text-sm">
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-users text-emerald-400 mt-1"></i>
                                      <span class="text-gray-300">ì‚¬ìš©ì í”¼ë“œë°± ê¸°ë°˜ UI ê°œì„ </span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-universal-access text-emerald-400 mt-1"></i>
                                      <span class="text-gray-300">ì ‘ê·¼ì„±(WCAG) í‘œì¤€ ì¤€ìˆ˜</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-palette text-emerald-400 mt-1"></i>
                                      <span class="text-gray-300">ë‹¤í¬ ëª¨ë“œ ìµœì í™”</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-keyboard text-emerald-400 mt-1"></i>
                                      <span class="text-gray-300">í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì§€ì›</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-bell text-emerald-400 mt-1"></i>
                                      <span class="text-gray-300">Toast ì•Œë¦¼ ì‹œìŠ¤í…œ ë„ì…</span>
                                  </div>
                                  <div class="flex items-start gap-2">
                                      <i class="fas fa-exclamation-triangle text-emerald-400 mt-1"></i>
                                      <span class="text-gray-300">404 í˜ì´ì§€ UX ê°œì„ </span>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </section>
  `;
  
  return c.html(getLayout(content, 'ì†Œê°œ - GALLERYPIA'))
})

// ============================================
// ê±°ë˜ ë‚´ì—­ í˜ì´ì§€
// ============================================
app.get('/transactions', (c) => {
  const content = `
    <section class="py-20">
      <div class="max-w-7xl mx-auto px-4">
        <h1 class="text-4xl font-bold mb-8 text-white">
          <i class="fas fa-exchange-alt mr-3 text-purple-400"></i>
          ê±°ë˜ ë‚´ì—­
        </h1>
        
        <div class="card-nft rounded-2xl p-8">
          <!-- í•„í„° ë²„íŠ¼ -->
          <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="filterTransactions('all')" id="filter-all" class="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold transition-colors">ì „ì²´</button>
            <button onclick="filterTransactions('purchase')" id="filter-purchase" class="px-4 py-2 bg-gray-800 text-gray-300 hover:bg-gray-700 rounded-lg font-semibold transition-colors">êµ¬ë§¤</button>
            <button onclick="filterTransactions('sale')" id="filter-sale" class="px-4 py-2 bg-gray-800 text-gray-300 hover:bg-gray-700 rounded-lg font-semibold transition-colors">íŒë§¤</button>
            <button onclick="filterTransactions('bid')" id="filter-bid" class="px-4 py-2 bg-gray-800 text-gray-300 hover:bg-gray-700 rounded-lg font-semibold transition-colors">ì…ì°°</button>
            <button onclick="filterTransactions('offer')" id="filter-offer" class="px-4 py-2 bg-gray-800 text-gray-300 hover:bg-gray-700 rounded-lg font-semibold transition-colors">ì œì•ˆ</button>
          </div>
          
          <!-- ë¡œë”© ìƒíƒœ -->
          <div id="loadingState" class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mx-auto mb-4"></div>
            <p class="text-gray-400">ê±°ë˜ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
          
          <!-- ê±°ë˜ ë‚´ì—­ ëª©ë¡ -->
          <div id="transactionsList" class="hidden space-y-4"></div>
          
          <!-- ë¹ˆ ìƒíƒœ -->
          <div id="emptyState" class="hidden text-center py-12 text-gray-400">
            <i class="fas fa-receipt text-5xl mb-4 opacity-50"></i>
            <p class="text-lg">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
            <a href="/gallery" class="inline-block mt-4 px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl transition-colors">
              ê°¤ëŸ¬ë¦¬ ë‘˜ëŸ¬ë³´ê¸°
            </a>
          </div>
          
          <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
          <div id="paginationContainer" class="hidden mt-8 flex justify-center items-center gap-2">
            <button onclick="changePage(-1)" id="prevPage" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
              <i class="fas fa-chevron-left"></i>
            </button>
            <span id="pageInfo" class="px-4 text-gray-300">1 / 1</span>
            <button onclick="changePage(1)" id="nextPage" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </section>
    
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
      const token = localStorage.getItem('auth_token');
      if (!token) {
        window.location.href = '/login';
      }
      
      let currentFilter = 'all';
      let currentPage = 1;
      let totalPages = 1;
      let allTransactions = [];
      
      // ê±°ë˜ ë‚´ì—­ ë¡œë“œ
      async function loadTransactions() {
        try {
          const response = await axios.get('/api/transactions', {
            headers: { 'Authorization': \`Bearer \${token}\` }
          });
          
          if (response.data.success) {
            allTransactions = response.data.transactions || [];
            renderTransactions();
          } else {
            showError('ê±°ë˜ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          }
        } catch (error) {
          console.error('ê±°ë˜ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', error);
          showError('ê±°ë˜ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        }
      }
      
      // ê±°ë˜ ë‚´ì—­ ë Œë”ë§
      function renderTransactions() {
        document.getElementById('loadingState').classList.add('hidden');
        
        // í•„í„°ë§
        let filtered = allTransactions;
        if (currentFilter !== 'all') {
          filtered = allTransactions.filter(t => t.type === currentFilter);
        }
        
        // ë‚ ì§œìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
        filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        
        // í˜ì´ì§€ë„¤ì´ì…˜
        const itemsPerPage = 10;
        totalPages = Math.ceil(filtered.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedTransactions = filtered.slice(startIndex, endIndex);
        
        // ë¹ˆ ìƒíƒœ ì²´í¬
        if (filtered.length === 0) {
          document.getElementById('transactionsList').classList.add('hidden');
          document.getElementById('emptyState').classList.remove('hidden');
          document.getElementById('paginationContainer').classList.add('hidden');
          return;
        }
        
        // ê±°ë˜ ë‚´ì—­ ë Œë”ë§
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('transactionsList').classList.remove('hidden');
        
        const html = paginatedTransactions.map(tx => {
          const typeIcon = {
            'purchase': 'fa-shopping-cart',
            'sale': 'fa-tag',
            'bid': 'fa-gavel',
            'offer': 'fa-handshake'
          }[tx.type] || 'fa-exchange-alt';
          
          const typeName = {
            'purchase': 'êµ¬ë§¤',
            'sale': 'íŒë§¤',
            'bid': 'ì…ì°°',
            'offer': 'ì œì•ˆ'
          }[tx.type] || 'ê±°ë˜';
          
          const typeColor = {
            'purchase': 'text-green-400',
            'sale': 'text-blue-400',
            'bid': 'text-yellow-400',
            'offer': 'text-purple-400'
          }[tx.type] || 'text-gray-400';
          
          const date = new Date(tx.created_at).toLocaleString('ko-KR');
          
          return \`
            <div class="flex items-center justify-between p-4 bg-gray-800 rounded-xl hover:bg-gray-750 transition-colors">
              <div class="flex items-center gap-4">
                <div class="w-16 h-16 rounded-lg overflow-hidden bg-gray-700">
                  <img src="\${tx.artwork_image || '/static/placeholder.jpg'}" alt="\${tx.artwork_title}" class="w-full h-full object-cover" />
                </div>
                <div>
                  <div class="flex items-center gap-2 mb-1">
                    <i class="fas \${typeIcon} \${typeColor}"></i>
                    <span class="\${typeColor} font-semibold">\${typeName}</span>
                  </div>
                  <h3 class="text-white font-bold">\${tx.artwork_title}</h3>
                  <p class="text-sm text-gray-400">\${date}</p>
                </div>
              </div>
              <div class="text-right">
                <p class="text-lg font-bold text-white">\${tx.price ? 'â‚©' + tx.price.toLocaleString() : '-'}</p>
                <p class="text-sm text-gray-400">\${tx.status || 'ì™„ë£Œ'}</p>
              </div>
            </div>
          \`;
        }).join('');
        
        document.getElementById('transactionsList').innerHTML = html;
        
        // í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
        if (totalPages > 1) {
          document.getElementById('paginationContainer').classList.remove('hidden');
          document.getElementById('pageInfo').textContent = \`\${currentPage} / \${totalPages}\`;
          document.getElementById('prevPage').disabled = currentPage === 1;
          document.getElementById('nextPage').disabled = currentPage === totalPages;
        } else {
          document.getElementById('paginationContainer').classList.add('hidden');
        }
      }
      
      // í•„í„° ë³€ê²½
      function filterTransactions(type) {
        currentFilter = type;
        currentPage = 1;
        
        // í•„í„° ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        ['all', 'purchase', 'sale', 'bid', 'offer'].forEach(t => {
          const btn = document.getElementById(\`filter-\${t}\`);
          if (t === type) {
            btn.classList.remove('bg-gray-800', 'text-gray-300');
            btn.classList.add('bg-purple-600', 'text-white');
          } else {
            btn.classList.remove('bg-purple-600', 'text-white');
            btn.classList.add('bg-gray-800', 'text-gray-300');
          }
        });
        
        renderTransactions();
      }
      
      // í˜ì´ì§€ ë³€ê²½
      function changePage(direction) {
        const newPage = currentPage + direction;
        if (newPage >= 1 && newPage <= totalPages) {
          currentPage = newPage;
          renderTransactions();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      }
      
      // ì—ëŸ¬ í‘œì‹œ
      function showError(message) {
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('transactionsList').classList.add('hidden');
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('emptyState').innerHTML = \`
          <i class="fas fa-exclamation-triangle text-5xl mb-4 text-red-500"></i>
          <p class="text-lg text-red-400">\${message}</p>
        \`;
      }
      
      // ì´ˆê¸° ë¡œë“œ
      loadTransactions();
    </script>
  `;
  return c.html(getLayout(content, 'ê±°ë˜ ë‚´ì—­ - GALLERYPIA'))
})

// ============================================
// ë²ˆë“¤ í˜ì´ì§€
// ============================================
app.get('/bundles', (c) => {
  const content = `
    <section class="py-20">
      <div class="max-w-7xl mx-auto px-4">
        <div class="text-center mb-12">
          <h1 class="text-5xl font-bold mb-4 text-white">NFT ë²ˆë“¤</h1>
          <p class="text-gray-400 text-lg">ì—¬ëŸ¬ ì‘í’ˆì„ ë¬¶ì–´ íŠ¹ë³„í•œ ê°€ê²©ìœ¼ë¡œ ë§Œë‚˜ë³´ì„¸ìš”</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="col-span-full text-center py-20 text-gray-400">
            <i class="fas fa-box-open text-6xl mb-4 opacity-50"></i>
            <p class="text-xl">ì¤€ë¹„ëœ ë²ˆë“¤ì´ ì—†ìŠµë‹ˆë‹¤</p>
            <p class="text-sm mt-2">ê³§ ë©‹ì§„ ë²ˆë“¤ë¡œ ì°¾ì•„ëµ™ê² ìŠµë‹ˆë‹¤</p>
          </div>
        </div>
      </div>
    </section>
  `;
  return c.html(getLayout(content, 'NFT ë²ˆë“¤ - GALLERYPIA'))
})

// ============================================
// í™œë™ í˜ì´ì§€
// ============================================
app.get('/activity', (c) => {
  const content = `
    <section class="py-20">
      <div class="max-w-7xl mx-auto px-4">
        <h1 class="text-4xl font-bold mb-8 text-white">ìµœê·¼ í™œë™</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2">
            <div class="card-nft rounded-2xl p-8">
              <h2 class="text-xl font-bold text-white mb-6">ì „ì²´ í™œë™</h2>
              <div id="activityList" class="space-y-4">
                <div class="text-center py-12 text-gray-400">
                  <i class="fas fa-clock text-5xl mb-4 opacity-50"></i>
                  <p class="text-lg">ìµœê·¼ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
              </div>
            </div>
          </div>
          
          <div>
            <div class="card-nft rounded-2xl p-6 mb-6">
              <h3 class="text-lg font-bold text-white mb-4">í•„í„°</h3>
              <div class="space-y-2">
                <label class="flex items-center text-gray-300">
                  <input type="checkbox" checked class="mr-2"> êµ¬ë§¤
                </label>
                <label class="flex items-center text-gray-300">
                  <input type="checkbox" checked class="mr-2"> íŒë§¤
                </label>
                <label class="flex items-center text-gray-300">
                  <input type="checkbox" checked class="mr-2"> ì…ì°°
                </label>
                <label class="flex items-center text-gray-300">
                  <input type="checkbox" checked class="mr-2"> ê´€ì‹¬ì‘í’ˆ
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <script>
      const token = localStorage.getItem('auth_token');
      if (!token) window.location.href = '/login';
    </script>
  `;
  return c.html(getLayout(content, 'ìµœê·¼ í™œë™ - GALLERYPIA'))
})

// ============================================
// ê´€ë¦¬ì ë¡œê·¸ì¸ í˜ì´ì§€
// ============================================
app.get('/admin/login', (c) => {
  const content = `
  <section class="min-h-screen flex items-center justify-center py-20">
      <div class="w-full max-w-md">
          <div class="card-nft rounded-3xl p-8 neon-border">
              <div class="text-center mb-8">
                  <div class="inline-block p-4 rounded-full gradient-primary mb-4">
                      <i class="fas fa-shield-halved text-4xl text-white"></i>
                  </div>
                  <h1 class="text-3xl font-bold text-white mb-2">ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
                  <p class="text-gray-400">GALLERYPIA Admin Portal</p>
              </div>
              
              <div id="loginError" class="hidden mb-4 p-4 rounded-lg bg-red-500 bg-opacity-10 border border-red-500 border-opacity-30">
                  <p class="text-red-400 text-sm"><i class="fas fa-exclamation-circle mr-2"></i><span id="errorMessage"></span></p>
              </div>
              
              <form id="loginForm" class="space-y-6">
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">
                          <i class="fas fa-user mr-2"></i>ì‚¬ìš©ìëª…
                      </label>
                      <input 
                          type="text" 
                          id="username" 
                          name="username" 
                          required
                          class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                          placeholder="ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                      />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">
                          <i class="fas fa-lock mr-2"></i>ë¹„ë°€ë²ˆí˜¸
                      </label>
                      <input 
                          type="password" 
                          id="password" 
                          name="password" 
                          required
                          class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition"
                          placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                      />
                  </div>
                  
                  <div class="flex items-center justify-between">
                      <label class="flex items-center">
                          <input type="checkbox" class="w-4 h-4 rounded bg-white bg-opacity-5 border-white border-opacity-10 text-purple-600 focus:ring-purple-500" />
                          <span class="ml-2 text-sm text-gray-400">ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€</span>
                      </label>
                  </div>
                  
                  <button 
                      type="submit" 
                      class="w-full gradient-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition transform hover:scale-105"
                  >
                      <i class="fas fa-sign-in-alt mr-2"></i>ë¡œê·¸ì¸
                  </button>
              </form>
              
              <div class="mt-6 text-center">
                  <p class="text-sm text-gray-500">
                      <i class="fas fa-info-circle mr-1"></i>
                      ê¸°ë³¸ ê³„ì •: admin / admin123
                  </p>
              </div>
          </div>
          
          <div class="mt-6 text-center">
              <a href="/" class="text-sm text-gray-400 hover:text-white transition">
                  <i class="fas fa-arrow-left mr-2"></i>ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
              </a>
          </div>
      </div>
  </section>
  
  <script>
      document.getElementById('loginForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;
          const errorDiv = document.getElementById('loginError');
          const errorMsg = document.getElementById('errorMessage');
          
          try {
              const response = await fetch('/api/admin/login', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ username, password })
              });
              
              const data = await response.json();
              
              if (data.success) {
                  localStorage.setItem('admin_session', data.session_token);
                  window.location.href = '/admin/dashboard';
              } else {
                  errorDiv.classList.remove('hidden');
                  errorMsg.textContent = data.message || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
              }
          } catch (error) {
              errorDiv.classList.remove('hidden');
              errorMsg.textContent = 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          }
      });
  </script>
  `;
  
  return c.html(getLayout(content, 'ê´€ë¦¬ì ë¡œê·¸ì¸ - GALLERYPIA'))
})

// ============================================
// ì•„í‹°ìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ í˜ì´ì§€
// ============================================
app.get('/dashboard/artist', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  // ì¸ì¦ í™•ì¸
  if (!token) {
    return c.redirect('/login')
  }
  
  let userId: number
  let artistId: number | null = null
  
  try {
    const session = await db.prepare(`
      SELECT user_id, role FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!session) {
      return c.redirect('/login')
    }
    
    userId = session.user_id as number
    
    // ì•„í‹°ìŠ¤íŠ¸ ID ì¡°íšŒ
    const artist = await db.prepare(`
      SELECT id FROM artists WHERE user_id = ?
    `).bind(userId).first()
    
    artistId = artist ? artist.id as number : null
  } catch (error) {
    console.error('Dashboard auth error:', error)
    return c.redirect('/login')
  }
  
  // í†µê³„ ë°ì´í„° ì¿¼ë¦¬
  let totalArtworks = 0
  let mintedCount = 0
  let totalViews = 0
  let totalSales = 0
  
  if (artistId) {
    try {
      // ë“±ë¡ëœ ì‘í’ˆ ìˆ˜
      const artworksResult = await db.prepare(`
        SELECT COUNT(*) as count FROM artworks WHERE artist_id = ?
      `).bind(artistId).first()
      totalArtworks = artworksResult?.count as number || 0
      
      // NFT ë¯¼íŒ… ì™„ë£Œ ìˆ˜ (is_minted = 1)
      const mintedResult = await db.prepare(`
        SELECT COUNT(*) as count FROM artworks WHERE artist_id = ? AND is_minted = 1
      `).bind(artistId).first()
      mintedCount = mintedResult?.count as number || 0
      
      // ì´ ì¡°íšŒìˆ˜
      const viewsResult = await db.prepare(`
        SELECT SUM(views) as total FROM artworks WHERE artist_id = ?
      `).bind(artistId).first()
      totalViews = viewsResult?.total as number || 0
      
      // ì´ íŒë§¤ì•¡ (sold_price í•©ê³„)
      const salesResult = await db.prepare(`
        SELECT SUM(sold_price) as total FROM artworks WHERE artist_id = ? AND status = 'sold'
      `).bind(artistId).first()
      totalSales = salesResult?.total as number || 0
    } catch (error) {
      console.error('Dashboard stats error:', error)
    }
  }
  
  const content = `
  <section class="min-h-screen py-20">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <!-- í—¤ë” -->
          <div class="mb-8">
              <h1 class="text-4xl font-bold text-white mb-2">
                  <i class="fas fa-palette mr-3 text-gradient"></i>
                  ì•„í‹°ìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ
              </h1>
              <p class="text-gray-400">ì‘í’ˆ ê´€ë¦¬ ë° NFT ë¯¼íŒ…ì„ í•œ ê³³ì—ì„œ</p>
          </div>
          
          <!-- í†µê³„ ì¹´ë“œ -->
          <div class="grid md:grid-cols-4 gap-6 mb-8">
              <div class="card-nft rounded-2xl p-6">
                  <div class="flex items-center justify-between mb-4">
                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center">
                          <i class="fas fa-images text-white text-xl"></i>
                      </div>
                      <span class="text-2xl font-bold text-white">${totalArtworks}</span>
                  </div>
                  <p class="text-gray-400 text-sm">ë“±ë¡ëœ ì‘í’ˆ</p>
              </div>
              
              <div class="card-nft rounded-2xl p-6">
                  <div class="flex items-center justify-between mb-4">
                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 flex items-center justify-center">
                          <i class="fas fa-certificate text-white text-xl"></i>
                      </div>
                      <span class="text-2xl font-bold text-white">${mintedCount}</span>
                  </div>
                  <p class="text-gray-400 text-sm">NFT ë¯¼íŒ… ì™„ë£Œ</p>
              </div>
              
              <div class="card-nft rounded-2xl p-6">
                  <div class="flex items-center justify-between mb-4">
                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 flex items-center justify-center">
                          <i class="fas fa-chart-line text-white text-xl"></i>
                      </div>
                      <span class="text-2xl font-bold text-white">${totalViews.toLocaleString()}</span>
                  </div>
                  <p class="text-gray-400 text-sm">ì´ ì¡°íšŒìˆ˜</p>
              </div>
              
              <div class="card-nft rounded-2xl p-6">
                  <div class="flex items-center justify-between mb-4">
                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-amber-500 to-orange-500 flex items-center justify-center">
                          <i class="fas fa-won-sign text-white text-xl"></i>
                      </div>
                      <span class="text-2xl font-bold text-white">â‚©${totalSales.toLocaleString()}</span>
                  </div>
                  <p class="text-gray-400 text-sm">ì´ íŒë§¤ì•¡</p>
              </div>
          </div>
          
          <!-- ë¹ ë¥¸ ì•¡ì…˜ -->
          <div class="grid md:grid-cols-3 gap-6 mb-8">
              <a href="/mint" class="card-nft rounded-2xl p-6 hover:scale-105 transition group">
                  <div class="flex items-center mb-4">
                      <div class="w-12 h-12 rounded-full gradient-primary flex items-center justify-center mr-4">
                          <i class="fas fa-plus text-white text-xl"></i>
                      </div>
                      <div>
                          <h3 class="text-lg font-bold text-white group-hover:text-gradient">NFT ë¯¼íŒ…</h3>
                          <p class="text-sm text-gray-400">ìƒˆ ì‘í’ˆ ë“±ë¡í•˜ê¸°</p>
                      </div>
                  </div>
              </a>
              
              <a href="/mypage" class="card-nft rounded-2xl p-6 hover:scale-105 transition group">
                  <div class="flex items-center mb-4">
                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-amber-500 to-orange-500 flex items-center justify-center mr-4">
                          <i class="fas fa-trophy text-white text-xl"></i>
                      </div>
                      <div>
                          <h3 class="text-lg font-bold text-white group-hover:text-gradient">ë­í¬ ê´€ë¦¬</h3>
                          <p class="text-sm text-gray-400">ê²½ë ¥ ë° ë­í¬ í™•ì¸</p>
                      </div>
                  </div>
              </a>
              
              <a href="/gallery" class="card-nft rounded-2xl p-6 hover:scale-105 transition group">
                  <div class="flex items-center mb-4">
                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 flex items-center justify-center mr-4">
                          <i class="fas fa-images text-white text-xl"></i>
                      </div>
                      <div>
                          <h3 class="text-lg font-bold text-white group-hover:text-gradient">ê°¤ëŸ¬ë¦¬</h3>
                          <p class="text-sm text-gray-400">ë‚´ ì‘í’ˆ ë³´ê¸°</p>
                      </div>
                  </div>
              </a>
          </div>
          
          <!-- ìµœê·¼ í™œë™ -->
          <div class="card-nft rounded-2xl p-6">
              <h2 class="text-2xl font-bold text-white mb-6">
                  <i class="fas fa-clock mr-3"></i>ìµœê·¼ í™œë™
              </h2>
              <div class="text-center py-12">
                  <i class="fas fa-inbox text-gray-600 text-5xl mb-4"></i>
                  <p class="text-gray-400">ì•„ì§ í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
                  <p class="text-gray-500 text-sm mt-2">ì‘í’ˆì„ ë“±ë¡í•˜ê³  NFTë¥¼ ë¯¼íŒ…í•´ë³´ì„¸ìš”!</p>
              </div>
          </div>
      </div>
  </section>
  `;
  
  return c.html(getLayout(content, 'ì•„í‹°ìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ - GALLERYPIA'))
})

// ============================================
// ì „ë¬¸ê°€ ëŒ€ì‹œë³´ë“œ í˜ì´ì§€
// ============================================
app.get('/dashboard/expert', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  // ì¸ì¦ í™•ì¸
  if (!token) {
    return c.redirect('/login')
  }
  
  let userId: number
  
  try {
    const session = await db.prepare(`
      SELECT user_id, role FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!session) {
      return c.redirect('/login')
    }
    
    userId = session.user_id as number
  } catch (error) {
    console.error('Dashboard auth error:', error)
    return c.redirect('/login')
  }
  
  // í†µê³„ ë°ì´í„° ì¿¼ë¦¬
  let evaluatedCount = 0
  let totalRewards = 0
  let avgScore = 0
  let pendingCount = 0
  
  try {
    // í‰ê°€í•œ ì‘í’ˆ ìˆ˜
    const evaluatedResult = await db.prepare(`
      SELECT COUNT(*) as count FROM expert_evaluations WHERE expert_user_id = ?
    `).bind(userId).first()
    evaluatedCount = evaluatedResult?.count as number || 0
    
    // ëˆ„ì  ë³´ìƒ (ê°€ì •: 0.05 ETH per evaluation)
    totalRewards = evaluatedCount * 0.05
    
    // í‰ê°€ ì ìˆ˜ í‰ê·  (final_score í‰ê· )
    const avgScoreResult = await db.prepare(`
      SELECT AVG(final_score) as avg FROM expert_evaluations WHERE expert_user_id = ?
    `).bind(userId).first()
    avgScore = Math.round(avgScoreResult?.avg as number || 0)
    
    // í‰ê°€ ëŒ€ê¸° ì¤‘ ì‘í’ˆ (í‰ê°€ê°€ 0ê°œì¸ ì‘í’ˆ)
    const pendingResult = await db.prepare(`
      SELECT COUNT(*) as count FROM artworks WHERE status = 'active' AND id NOT IN (
        SELECT DISTINCT artwork_id FROM expert_evaluations
      )
    `).first()
    pendingCount = pendingResult?.count as number || 0
  } catch (error) {
    console.error('Dashboard stats error:', error)
  }
  
  const content = `
  <section class="min-h-screen py-20">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <!-- í—¤ë” -->
          <div class="mb-8">
              <h1 class="text-4xl font-bold text-white mb-2">
                  <i class="fas fa-user-tie mr-3 text-gradient"></i>
                  ì „ë¬¸ê°€ ëŒ€ì‹œë³´ë“œ
              </h1>
              <p class="text-gray-400">ì‘í’ˆ í‰ê°€ ë° ë³´ìƒ ê´€ë¦¬</p>
          </div>
          
          <!-- í†µê³„ ì¹´ë“œ -->
          <div class="grid md:grid-cols-4 gap-6 mb-8">
              <div class="card-nft rounded-2xl p-6">
                  <div class="flex items-center justify-between mb-4">
                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-amber-500 to-orange-500 flex items-center justify-center">
                          <i class="fas fa-star text-white text-xl"></i>
                      </div>
                      <span class="text-2xl font-bold text-white">${evaluatedCount}</span>
                  </div>
                  <p class="text-gray-400 text-sm">í‰ê°€í•œ ì‘í’ˆ</p>
              </div>
              
              <div class="card-nft rounded-2xl p-6">
                  <div class="flex items-center justify-between mb-4">
                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 flex items-center justify-center">
                          <i class="fas fa-coins text-white text-xl"></i>
                      </div>
                      <span class="text-2xl font-bold text-white">${totalRewards.toFixed(2)} ETH</span>
                  </div>
                  <p class="text-gray-400 text-sm">ëˆ„ì  ë³´ìƒ</p>
              </div>
              
              <div class="card-nft rounded-2xl p-6">
                  <div class="flex items-center justify-between mb-4">
                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 flex items-center justify-center">
                          <i class="fas fa-chart-line text-white text-xl"></i>
                      </div>
                      <span class="text-2xl font-bold text-white">${avgScore}</span>
                  </div>
                  <p class="text-gray-400 text-sm">í‰ê°€ ì ìˆ˜ í‰ê· </p>
              </div>
              
              <div class="card-nft rounded-2xl p-6">
                  <div class="flex items-center justify-between mb-4">
                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center">
                          <i class="fas fa-trophy text-white text-xl"></i>
                      </div>
                      <span class="text-2xl font-bold text-white">ì´ˆê¸‰</span>
                  </div>
                  <p class="text-gray-400 text-sm">ì „ë¬¸ê°€ ë“±ê¸‰</p>
              </div>
          </div>
          
          <!-- ë³´ìƒ ì•ˆë‚´ -->
          <div class="bg-amber-500 bg-opacity-10 border border-amber-500 border-opacity-30 rounded-2xl p-6 mb-8">
              <h3 class="text-xl font-bold text-amber-400 mb-3 flex items-center">
                  <i class="fas fa-coins mr-3"></i>
                  ì „ë¬¸ê°€ í‰ê°€ ë³´ìƒ ì‹œìŠ¤í…œ
              </h3>
              <div class="grid md:grid-cols-3 gap-4">
                  <div class="bg-white bg-opacity-5 rounded-lg p-4">
                      <p class="text-sm text-gray-400 mb-2">ì‘í’ˆë‹¹ ë³´ìƒ</p>
                      <p class="text-2xl font-bold text-green-400">0.01-0.1 ETH</p>
                  </div>
                  <div class="bg-white bg-opacity-5 rounded-lg p-4">
                      <p class="text-sm text-gray-400 mb-2">ì´ë²ˆ ë‹¬ ë³´ìƒ</p>
                      <p class="text-2xl font-bold text-blue-400">${(totalRewards * 0.3).toFixed(2)} ETH</p>
                  </div>
                  <div class="bg-white bg-opacity-5 rounded-lg p-4">
                      <p class="text-sm text-gray-400 mb-2">í‰ê°€ ëŒ€ê¸° ì¤‘</p>
                      <p class="text-2xl font-bold text-purple-400">${pendingCount}ê±´</p>
                  </div>
              </div>
          </div>
          
          <!-- ë¹ ë¥¸ ì•¡ì…˜ -->
          <div class="grid md:grid-cols-3 gap-6 mb-8">
              <a href="/gallery" class="card-nft rounded-2xl p-6 hover:scale-105 transition group">
                  <div class="flex items-center mb-4">
                      <div class="w-12 h-12 rounded-full gradient-primary flex items-center justify-center mr-4">
                          <i class="fas fa-search text-white text-xl"></i>
                      </div>
                      <div>
                          <h3 class="text-lg font-bold text-white group-hover:text-gradient">ì‘í’ˆ í‰ê°€í•˜ê¸°</h3>
                          <p class="text-sm text-gray-400">ìƒˆ ì‘í’ˆ ì°¾ì•„ë³´ê¸°</p>
                      </div>
                  </div>
              </a>
              
              <a href="/mypage" class="card-nft rounded-2xl p-6 hover:scale-105 transition group">
                  <div class="flex items-center mb-4">
                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-amber-500 to-orange-500 flex items-center justify-center mr-4">
                          <i class="fas fa-wallet text-white text-xl"></i>
                      </div>
                      <div>
                          <h3 class="text-lg font-bold text-white group-hover:text-gradient">ë³´ìƒ ë‚´ì—­</h3>
                          <p class="text-sm text-gray-400">ETH ë³´ìƒ í™•ì¸</p>
                      </div>
                  </div>
              </a>
              
              <a href="/expert/apply" class="card-nft rounded-2xl p-6 hover:scale-105 transition group">
                  <div class="flex items-center mb-4">
                      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 flex items-center justify-center mr-4">
                          <i class="fas fa-graduation-cap text-white text-xl"></i>
                      </div>
                      <div>
                          <h3 class="text-lg font-bold text-white group-hover:text-gradient">ë“±ê¸‰ ì—…ê·¸ë ˆì´ë“œ</h3>
                          <p class="text-sm text-gray-400">ì „ë¬¸ê°€ ë“±ê¸‰ ì‹ ì²­</p>
                      </div>
                  </div>
              </a>
          </div>
          
          <!-- ìµœê·¼ í‰ê°€ -->
          <div class="card-nft rounded-2xl p-6">
              <h2 class="text-2xl font-bold text-white mb-6">
                  <i class="fas fa-history mr-3"></i>ìµœê·¼ í‰ê°€ ë‚´ì—­
              </h2>
              <div class="text-center py-12">
                  <i class="fas fa-inbox text-gray-600 text-5xl mb-4"></i>
                  <p class="text-gray-400">ì•„ì§ í‰ê°€í•œ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤</p>
                  <p class="text-gray-500 text-sm mt-2">ê°¤ëŸ¬ë¦¬ì—ì„œ ì‘í’ˆì„ í‰ê°€í•˜ê³  ETH ë³´ìƒì„ ë°›ì•„ë³´ì„¸ìš”!</p>
              </div>
          </div>
      </div>
  </section>
  `;
  
  return c.html(getLayout(content, 'ì „ë¬¸ê°€ ëŒ€ì‹œë³´ë“œ - GALLERYPIA'))
})

// ============================================
// ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ í˜ì´ì§€
// ============================================
app.get('/admin/dashboard', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  // ì¸ì¦ í™•ì¸
  if (!token) {
    return c.redirect('/login')
  }
  
  try {
    const session = await db.prepare(`
      SELECT user_id, role FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!session || (session.role !== 'admin' && session.role !== 'super_admin')) {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' }, 403)
    }
  } catch (error) {
    console.error('Dashboard auth error:', error)
    return c.redirect('/login')
  }
  
  // í†µê³„ ë°ì´í„° ì¾¼ë¦¬
  let totalArtworks = 0
  let mintedCount = 0
  let totalArtists = 0
  let totalVolume = 0
  let pendingCount = 0
  
  try {
    // ì´ ì‘í’ˆ ìˆ˜
    const artworksResult = await db.prepare(`
      SELECT COUNT(*) as count FROM artworks
    `).first()
    totalArtworks = artworksResult?.count as number || 0
    
    // ë¯¼íŒ…ëœ ì‘í’ˆ ìˆ˜
    const mintedResult = await db.prepare(`
      SELECT COUNT(*) as count FROM artworks WHERE is_minted = 1
    `).first()
    mintedCount = mintedResult?.count as number || 0
    
    // ë“±ë¡ ì‘ê°€ ìˆ˜
    const artistsResult = await db.prepare(`
      SELECT COUNT(*) as count FROM artists
    `).first()
    totalArtists = artistsResult?.count as number || 0
    
    // ì´ ê±°ë˜ì•¡ (sold_price í•©ê³„)
    const volumeResult = await db.prepare(`
      SELECT SUM(sold_price) as total FROM artworks WHERE status = 'sold'
    `).first()
    const totalSalesKRW = volumeResult?.total as number || 0
    totalVolume = totalSalesKRW / 1500000 // ê°€ì •: 1 ETH = 1,500,000 KRW
    
    // í‰ê°€ ëŒ€ê¸° ì¤‘ ì‘í’ˆ
    const pendingResult = await db.prepare(`
      SELECT COUNT(*) as count FROM artworks WHERE status = 'active' AND id NOT IN (
        SELECT DISTINCT artwork_id FROM expert_evaluations
      )
    `).first()
    pendingCount = pendingResult?.count as number || 0
  } catch (error) {
    console.error('Dashboard stats error:', error)
  }
  
  const content = `
  <section class="py-8">
      <div class="container mx-auto px-4">
          <!-- í—¤ë” -->
          <div class="flex justify-between items-center mb-8">
              <div>
                  <h1 class="text-4xl font-bold text-white mb-2">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
                  <p class="text-gray-400">GALLERYPIA Admin Portal</p>
              </div>
              <div class="flex items-center gap-4">
                  <!-- ì•Œë¦¼ ì•„ì´ì½˜ -->
                  <div class="relative">
                      <button id="notificationButton" onclick="toggleNotifications()" class="relative px-3 py-2 text-gray-400 hover:text-white transition">
                          <i class="fas fa-bell text-xl"></i>
                          <span id="notificationBadge" class="hidden absolute top-0 right-0 w-5 h-5 bg-red-500 rounded-full text-xs text-white flex items-center justify-center">0</span>
                      </button>
                      
                      <!-- ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ -->
                      <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-96 bg-black border border-white border-opacity-10 rounded-2xl shadow-2xl z-50 max-h-96 overflow-y-auto">
                          <div class="p-4 border-b border-white border-opacity-10">
                              <div class="flex justify-between items-center">
                                  <h3 class="text-lg font-bold text-white">ì•Œë¦¼</h3>
                                  <button onclick="markAllNotificationsRead()" class="text-xs text-purple-400 hover:text-purple-300 transition">
                                      ëª¨ë‘ ì½ìŒ í‘œì‹œ
                                  </button>
                              </div>
                          </div>
                          <div id="notificationList" class="divide-y divide-white divide-opacity-5">
                              <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                          </div>
                      </div>
                  </div>
                  
                  <div class="text-right">
                      <p class="text-sm text-gray-400">ë¡œê·¸ì¸: <span id="adminName" class="text-white font-semibold">ì‹œìŠ¤í…œ ê´€ë¦¬ì</span></p>
                      <p class="text-xs text-gray-500">Role: <span id="adminRole" class="text-purple-400">super_admin</span></p>
                  </div>
                  <button onclick="logout()" class="px-4 py-2 bg-red-500 bg-opacity-20 hover:bg-opacity-30 text-red-400 rounded-lg transition">
                      <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
                  </button>
              </div>
          </div>
          
          <!-- í†µê³„ ì¹´ë“œ -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
              <div class="card-nft rounded-2xl p-6 border-l-4 border-purple-500">
                  <div class="flex items-center justify-between mb-2">
                      <h3 class="text-gray-400 text-sm font-medium">ì´ ì‘í’ˆ ìˆ˜</h3>
                      <i class="fas fa-palette text-2xl text-purple-500"></i>
                  </div>
                  <p class="text-3xl font-bold text-white mb-1" id="totalArtworks">${totalArtworks}</p>
                  <p class="text-xs text-gray-500"><i class="fas fa-arrow-up text-green-400 mr-1"></i>ë¯¼íŒ…ë¨: <span id="mintedCount">${mintedCount}</span></p>
              </div>
              
              <div class="card-nft rounded-2xl p-6 border-l-4 border-cyan-500">
                  <div class="flex items-center justify-between mb-2">
                      <h3 class="text-gray-400 text-sm font-medium">ë“±ë¡ ì‘ê°€ ìˆ˜</h3>
                      <i class="fas fa-users text-2xl text-cyan-500"></i>
                  </div>
                  <p class="text-3xl font-bold text-white mb-1" id="totalArtists">${totalArtists}</p>
                  <p class="text-xs text-gray-500"><i class="fas fa-user-plus text-green-400 mr-1"></i>í™œë™ ì¤‘</p>
              </div>
              
              <div class="card-nft rounded-2xl p-6 border-l-4 border-yellow-500">
                  <div class="flex items-center justify-between mb-2">
                      <h3 class="text-gray-400 text-sm font-medium">ì´ ê±°ë˜ì•¡</h3>
                      <i class="fas fa-coins text-2xl text-yellow-500"></i>
                  </div>
                  <p class="text-3xl font-bold text-white mb-1" id="totalVolume">${totalVolume.toFixed(2)} ETH</p>
                  <p class="text-xs text-gray-500"><i class="fas fa-chart-line text-green-400 mr-1"></i>ì´ë²ˆ ë‹¬</p>
              </div>
              
              <div class="card-nft rounded-2xl p-6 border-l-4 border-green-500">
                  <div class="flex items-center justify-between mb-2">
                      <h3 class="text-gray-400 text-sm font-medium">í‰ê°€ ëŒ€ê¸°</h3>
                      <i class="fas fa-clock text-2xl text-green-500"></i>
                  </div>
                  <p class="text-3xl font-bold text-white mb-1" id="pendingCount">${pendingCount}</p>
                  <p class="text-xs text-gray-500"><i class="fas fa-exclamation-circle text-yellow-400 mr-1"></i>ê²€í†  í•„ìš”</p>
              </div>
          </div>
          
          <!-- v8.40 ì›”ë“œí´ë˜ìŠ¤ ì‹ ê¸°ëŠ¥ -->
          <div class="mb-8">
              <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                  <i class="fas fa-rocket text-purple-500 mr-3"></i>
                  v8.40 ì›”ë“œí´ë˜ìŠ¤ ì‹ ê¸°ëŠ¥
              </h2>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <!-- AI ì§„ìœ„ ê²€ì¦ -->
                  <a href="/admin/authenticity" class="card-nft rounded-2xl p-6 hover:border-purple-500 transition group">
                      <div class="flex items-center justify-between mb-4">
                          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center">
                              <i class="fas fa-robot text-white text-xl"></i>
                          </div>
                          <span class="px-3 py-1 bg-purple-500 bg-opacity-20 text-purple-400 text-xs rounded-full">NEW</span>
                      </div>
                      <h3 class="text-lg font-bold text-white mb-2 group-hover:text-purple-400 transition">AI ì‘í’ˆ ì§„ìœ„ ê²€ì¦</h3>
                      <p class="text-sm text-gray-400 mb-4">ì»´í“¨í„° ë¹„ì „ ê¸°ë°˜ ìœ„ì‘ íƒì§€ ë° ìŠ¤íƒ€ì¼ fingerprinting</p>
                      <div class="flex items-center justify-between text-xs">
                          <span class="text-gray-500">ëŒ€ê¸° ì¤‘: <span id="pendingVerifications" class="text-yellow-400 font-bold">0</span></span>
                          <i class="fas fa-arrow-right text-gray-600 group-hover:text-purple-500 transition"></i>
                      </div>
                  </a>
                  
                  <!-- ë¡œì—´í‹° ìë™í™” -->
                  <a href="/admin/royalty" class="card-nft rounded-2xl p-6 hover:border-cyan-500 transition group">
                      <div class="flex items-center justify-between mb-4">
                          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-cyan-600 to-emerald-600 flex items-center justify-center">
                              <i class="fas fa-coins text-white text-xl"></i>
                          </div>
                          <span class="px-3 py-1 bg-cyan-500 bg-opacity-20 text-cyan-400 text-xs rounded-full">NEW</span>
                      </div>
                      <h3 class="text-lg font-bold text-white mb-2 group-hover:text-cyan-400 transition">ë¡œì—´í‹° ìë™í™”</h3>
                      <p class="text-sm text-gray-400 mb-4">2ì°¨/3ì°¨ íŒë§¤ ì¶”ì  ë° ë³µì¡ ìˆ˜ìµ ë¶„ë°°</p>
                      <div class="flex items-center justify-between text-xs">
                          <span class="text-gray-500">ëŒ€ê¸° ì§€ê¸‰: <span id="pendingPayments" class="text-green-400 font-bold">0 ETH</span></span>
                          <i class="fas fa-arrow-right text-gray-600 group-hover:text-cyan-500 transition"></i>
                      </div>
                  </a>
                  
                  <!-- Museum Partnership -->
                  <a href="/admin/museum" class="card-nft rounded-2xl p-6 hover:border-amber-500 transition group">
                      <div class="flex items-center justify-between mb-4">
                          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-600 to-orange-600 flex items-center justify-center">
                              <i class="fas fa-landmark text-white text-xl"></i>
                          </div>
                          <span class="px-3 py-1 bg-amber-500 bg-opacity-20 text-amber-400 text-xs rounded-full">NEW</span>
                      </div>
                      <h3 class="text-lg font-bold text-white mb-2 group-hover:text-amber-400 transition">Museum Partnership</h3>
                      <p class="text-sm text-gray-400 mb-4">ë¯¸ìˆ ê´€ íŒŒíŠ¸ë„ˆ ê´€ë¦¬ ë° NFT ì»¬ë ‰ì…˜ ë°œí–‰</p>
                      <div class="flex items-center justify-between text-xs">
                          <span class="text-gray-500">ì‹ ê·œ ì‹ ì²­: <span id="pendingApplications" class="text-amber-400 font-bold">0</span></span>
                          <i class="fas fa-arrow-right text-gray-600 group-hover:text-amber-500 transition"></i>
                      </div>
                  </a>
              </div>
          </div>
          
          <!-- êµ¬ë§¤/ê²½ë§¤ ëª¨ë‹ˆí„°ë§ ì„¹ì…˜ -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
              <!-- ìµœê·¼ êµ¬ë§¤ ì œì•ˆ -->
              <div class="card-nft rounded-2xl p-6">
                  <div class="flex justify-between items-center mb-4">
                      <h3 class="text-lg font-bold text-white flex items-center">
                          <i class="fas fa-shopping-cart text-purple-500 mr-2"></i>
                          ìµœê·¼ êµ¬ë§¤ ì œì•ˆ
                      </h3>
                      <button onclick="refreshPurchaseOffers()" class="text-sm text-gray-400 hover:text-white transition">
                          <i class="fas fa-sync-alt mr-1"></i>ìƒˆë¡œê³ ì¹¨
                      </button>
                  </div>
                  <div id="purchaseOffersList" class="space-y-3">
                      <div class="text-center py-4 text-gray-500">
                          <i class="fas fa-spinner fa-spin"></i>
                      </div>
                  </div>
              </div>
              
              <!-- ì§„í–‰ ì¤‘ì¸ ê²½ë§¤ -->
              <div class="card-nft rounded-2xl p-6">
                  <div class="flex justify-between items-center mb-4">
                      <h3 class="text-lg font-bold text-white flex items-center">
                          <i class="fas fa-gavel text-amber-500 mr-2"></i>
                          ì§„í–‰ ì¤‘ì¸ ê²½ë§¤
                      </h3>
                      <button onclick="refreshAuctions()" class="text-sm text-gray-400 hover:text-white transition">
                          <i class="fas fa-sync-alt mr-1"></i>ìƒˆë¡œê³ ì¹¨
                      </button>
                  </div>
                  <div id="auctionsList" class="space-y-3">
                      <div class="text-center py-4 text-gray-500">
                          <i class="fas fa-spinner fa-spin"></i>
                      </div>
                  </div>
              </div>
              
              <!-- ìµœê·¼ ê±°ë˜ ë‚´ì—­ -->
              <div class="card-nft rounded-2xl p-6 lg:col-span-2">
                  <div class="flex justify-between items-center mb-4">
                      <h3 class="text-lg font-bold text-white flex items-center">
                          <i class="fas fa-exchange-alt text-cyan-500 mr-2"></i>
                          ìµœê·¼ ê±°ë˜ ë‚´ì—­
                      </h3>
                      <div class="flex gap-2">
                          <select id="transactionStatusFilter" onchange="refreshTransactions()" class="px-3 py-1 bg-gray-900 border border-gray-700 rounded-lg text-sm text-white">
                              <option value="">ì „ì²´ ìƒíƒœ</option>
                              <option value="pending">ëŒ€ê¸° ì¤‘</option>
                              <option value="completed">ì™„ë£Œ</option>
                              <option value="failed">ì‹¤íŒ¨</option>
                          </select>
                          <button onclick="refreshTransactions()" class="text-sm text-gray-400 hover:text-white transition">
                              <i class="fas fa-sync-alt mr-1"></i>ìƒˆë¡œê³ ì¹¨
                          </button>
                      </div>
                  </div>
                  <div id="transactionsList" class="overflow-x-auto">
                      <div class="text-center py-4 text-gray-500">
                          <i class="fas fa-spinner fa-spin"></i>
                      </div>
                  </div>
              </div>
          </div>
          
          <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
              <div class="card-nft rounded-2xl p-6">
                  <h3 class="text-lg font-bold text-white mb-4">ì›”ë³„ ì‘í’ˆ ë“±ë¡ ì¶”ì´</h3>
                  <div style="position: relative; height: 250px;">
                      <canvas id="monthlyChart"></canvas>
                  </div>
              </div>
              
              <div class="card-nft rounded-2xl p-6">
                  <h3 class="text-lg font-bold text-white mb-4">ì¹´í…Œê³ ë¦¬ë³„ ë¶„í¬</h3>
                  <div style="position: relative; height: 250px;">
                      <canvas id="categoryChart"></canvas>
                  </div>
              </div>
              
              <div class="card-nft rounded-2xl p-6">
                  <h3 class="text-lg font-bold text-white mb-4">ê°€ê²©ëŒ€ë³„ ë¶„í¬</h3>
                  <div style="position: relative; height: 250px;">
                      <canvas id="priceChart"></canvas>
                  </div>
              </div>
              
              <div class="card-nft rounded-2xl p-6">
                  <h3 class="text-lg font-bold text-white mb-4">ìƒíƒœë³„ ì‘í’ˆ í˜„í™©</h3>
                  <div style="position: relative; height: 250px;">
                      <canvas id="statusChart"></canvas>
                  </div>
              </div>
          </div>
          
          <!-- íƒ­ ë©”ë‰´ -->
          <div class="mb-6">
              <div class="flex gap-2 border-b border-white border-opacity-10">
                  <button onclick="switchTab('artworks')" id="tab-artworks" class="tab-button active px-6 py-3 font-semibold transition">
                      <i class="fas fa-palette mr-2"></i>ì‘í’ˆ ê´€ë¦¬
                  </button>
                  <button onclick="switchTab('artists')" id="tab-artists" class="tab-button px-6 py-3 font-semibold transition">
                      <i class="fas fa-users mr-2"></i>ì‘ê°€ ê´€ë¦¬
                  </button>
                  <button onclick="switchTab('valuations')" id="tab-valuations" class="tab-button px-6 py-3 font-semibold transition">
                      <i class="fas fa-chart-line mr-2"></i>ê°€ì¹˜ í‰ê°€
                  </button>
                  <button onclick="switchTab('transactions')" id="tab-transactions" class="tab-button px-6 py-3 font-semibold transition">
                      <i class="fas fa-exchange-alt mr-2"></i>ê±°ë˜ ë‚´ì—­
                  </button>
                  <button onclick="switchTab('logs')" id="tab-logs" class="tab-button px-6 py-3 font-semibold transition">
                      <i class="fas fa-history mr-2"></i>í™œë™ ë¡œê·¸
                  </button>
              </div>
          </div>
          
          <!-- ì‘í’ˆ ê´€ë¦¬ íƒ­ -->
          <div id="content-artworks" class="tab-content">
              <div class="flex justify-between items-center mb-4">
                  <h2 class="text-2xl font-bold text-white">ì‘í’ˆ ëª©ë¡</h2>
                  <div class="flex gap-2">
                      <button onclick="showOpenSeaModal()" class="px-4 py-2 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white rounded-lg transition flex items-center shadow-lg hover:shadow-cyan-500/50">
                          <i class="fab fa-ethereum mr-2"></i>OpenSea ì»¬ë ‰ì…˜ ê°€ì ¸ì˜¤ê¸°
                      </button>
                      <button onclick="updateOpenSeaPrices()" class="px-4 py-2 bg-green-500 bg-opacity-20 hover:bg-opacity-30 text-green-400 rounded-lg transition" title="OpenSea ê°€ê²© ì—…ë°ì´íŠ¸">
                          <i class="fas fa-sync-alt mr-2"></i>ê°€ê²© ì—…ë°ì´íŠ¸
                      </button>
                      <button onclick="showAddArtworkModal()" class="px-4 py-2 gradient-primary text-white rounded-lg hover:opacity-90 transition">
                          <i class="fas fa-plus mr-2"></i>ìƒˆ ì‘í’ˆ ë“±ë¡
                      </button>
                  </div>
              </div>
              
              <!-- ê²€ìƒ‰ ë° í•„í„° -->
              <div class="card-nft rounded-2xl p-4 mb-4">
                  <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                      <div class="md:col-span-2">
                          <div class="relative">
                              <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                              <input type="text" id="artworkSearchInput" placeholder="ì‘í’ˆëª…, ì‘ê°€ëª… ê²€ìƒ‰..." 
                                  class="w-full pl-12 pr-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500"
                                  onkeyup="searchArtworks()">
                          </div>
                      </div>
                      
                      <select id="artworkCategoryFilter" onchange="filterArtworks()" class="px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white">
                          <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                          <option value="ë””ì§€í„¸ì•„íŠ¸">ë””ì§€í„¸ì•„íŠ¸</option>
                          <option value="íšŒí™”">íšŒí™”</option>
                          <option value="ì¡°ê°">ì¡°ê°</option>
                          <option value="ì‚¬ì§„">ì‚¬ì§„</option>
                          <option value="íŒí™”">íŒí™”</option>
                          <option value="ì„¤ì¹˜ë¯¸ìˆ ">ì„¤ì¹˜ë¯¸ìˆ </option>
                      </select>
                      
                      <select id="artworkStatusFilter" onchange="filterArtworks()" class="px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white">
                          <option value="">ì „ì²´ ìƒíƒœ</option>
                          <option value="draft">ì´ˆì•ˆ</option>
                          <option value="pending_review">ê²€í†  ì¤‘</option>
                          <option value="approved">ìŠ¹ì¸ë¨</option>
                          <option value="minted">ë¯¼íŒ…ë¨</option>
                          <option value="sold">íŒë§¤ë¨</option>
                      </select>
                  </div>
                  
                  <div class="flex justify-between items-center mt-3 pt-3 border-t border-white border-opacity-10">
                      <div class="flex gap-2">
                          <button onclick="selectAllArtworks()" class="text-sm text-gray-400 hover:text-white transition">
                              <i class="fas fa-check-double mr-1"></i>ì „ì²´ ì„ íƒ
                          </button>
                          <button onclick="deselectAllArtworks()" class="text-sm text-gray-400 hover:text-white transition">
                              <i class="fas fa-times mr-1"></i>ì„ íƒ í•´ì œ
                          </button>
                          <div id="bulkActions" class="hidden flex gap-2 ml-4 pl-4 border-l border-white border-opacity-10">
                              <select id="bulkStatusChange" class="px-3 py-1 bg-white bg-opacity-5 border border-white border-opacity-10 rounded text-sm text-white">
                                  <option value="">ìƒíƒœ ì¼ê´„ ë³€ê²½</option>
                                  <option value="draft">ì´ˆì•ˆ</option>
                                  <option value="pending_review">ê²€í†  ì¤‘</option>
                                  <option value="approved">ìŠ¹ì¸ë¨</option>
                                  <option value="minted">ë¯¼íŒ…ë¨</option>
                                  <option value="sold">íŒë§¤ë¨</option>
                              </select>
                              <button onclick="applyBulkAction()" class="px-3 py-1 bg-purple-500 bg-opacity-20 hover:bg-opacity-30 text-purple-400 rounded text-sm transition">
                                  <i class="fas fa-check mr-1"></i>ì ìš©
                              </button>
                              <button onclick="bulkDeleteArtworks()" class="px-3 py-1 bg-red-500 bg-opacity-20 hover:bg-opacity-30 text-red-400 rounded text-sm transition">
                                  <i class="fas fa-trash mr-1"></i>ì„ íƒ ì‚­ì œ
                              </button>
                          </div>
                      </div>
                      
                      <select id="artworkSortOrder" onchange="sortArtworks()" class="px-3 py-1 bg-white bg-opacity-5 border border-white border-opacity-10 rounded text-sm text-white">
                          <option value="newest">ìµœì‹ ìˆœ</option>
                          <option value="oldest">ì˜¤ë˜ëœìˆœ</option>
                          <option value="price_high">ê°€ê²© ë†’ì€ìˆœ</option>
                          <option value="price_low">ê°€ê²© ë‚®ì€ìˆœ</option>
                          <option value="name">ì´ë¦„ìˆœ</option>
                      </select>
                  </div>
              </div>
              
              <div class="card-nft rounded-2xl overflow-hidden">
                  <div class="overflow-x-auto">
                      <table class="w-full">
                          <thead class="bg-white bg-opacity-5">
                              <tr>
                                  <th class="px-6 py-4 w-12">
                                      <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" 
                                          class="w-4 h-4 rounded bg-white bg-opacity-5 border-white border-opacity-10 text-purple-600">
                                  </th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ì‘í’ˆ</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ì‘ê°€</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ì¹´í…Œê³ ë¦¬</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ê°€ê²©</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ìƒíƒœ</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ì‘ì—…</th>
                              </tr>
                          </thead>
                          <tbody id="artworksTableBody" class="divide-y divide-white divide-opacity-5">
                              <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
          
          <!-- ì‘ê°€ ê´€ë¦¬ íƒ­ -->
          <div id="content-artists" class="tab-content hidden">
              <div class="flex justify-between items-center mb-6">
                  <h2 class="text-2xl font-bold text-white">ì‘ê°€ ëª©ë¡</h2>
                  <button onclick="showAddArtistModal()" class="px-4 py-2 gradient-primary text-white rounded-lg hover:opacity-90 transition">
                      <i class="fas fa-plus mr-2"></i>ìƒˆ ì‘ê°€ ë“±ë¡
                  </button>
              </div>
              
              <div class="card-nft rounded-2xl overflow-hidden">
                  <div class="overflow-x-auto">
                      <table class="w-full">
                          <thead class="bg-white bg-opacity-5">
                              <tr>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ì‘ê°€ëª…</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ì´ë©”ì¼</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ê²½ë ¥</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ì‘í’ˆ ìˆ˜</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ì§€ê°‘ ì£¼ì†Œ</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ì‘ì—…</th>
                              </tr>
                          </thead>
                          <tbody id="artistsTableBody" class="divide-y divide-white divide-opacity-5">
                              <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
          
          <!-- ê°€ì¹˜ í‰ê°€ íƒ­ -->
          <div id="content-valuations" class="tab-content hidden">
              <h2 class="text-2xl font-bold text-white mb-6">ê°€ì¹˜ í‰ê°€ ëŒ€ê¸° ëª©ë¡</h2>
              
              <div id="valuationsList" class="space-y-4">
                  <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
              </div>
          </div>
          
          <!-- ê±°ë˜ ë‚´ì—­ íƒ­ -->
          <div id="content-transactions" class="tab-content hidden">
              <h2 class="text-2xl font-bold text-white mb-6">ê±°ë˜ ë‚´ì—­</h2>
              
              <div class="card-nft rounded-2xl overflow-hidden">
                  <div class="overflow-x-auto">
                      <table class="w-full">
                          <thead class="bg-white bg-opacity-5">
                              <tr>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ê±°ë˜ ID</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ì‘í’ˆ</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ìœ í˜•</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ê°€ê²©</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ìƒíƒœ</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ë‚ ì§œ</th>
                              </tr>
                          </thead>
                          <tbody id="transactionsTableBody" class="divide-y divide-white divide-opacity-5">
                              <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
          
          <!-- í™œë™ ë¡œê·¸ íƒ­ -->
          <div id="content-logs" class="tab-content hidden">
              <div class="flex justify-between items-center mb-6">
                  <h2 class="text-2xl font-bold text-white">í™œë™ ë¡œê·¸</h2>
                  <div class="flex gap-2">
                      <select id="logActionFilter" onchange="loadActivityLogs()" class="px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white text-sm">
                          <option value="">ëª¨ë“  í™œë™</option>
                          <option value="login">ë¡œê·¸ì¸</option>
                          <option value="logout">ë¡œê·¸ì•„ì›ƒ</option>
                          <option value="create_artwork">ì‘í’ˆ ì¶”ê°€</option>
                          <option value="update_artwork">ì‘í’ˆ ìˆ˜ì •</option>
                          <option value="delete_artwork">ì‘í’ˆ ì‚­ì œ</option>
                          <option value="create_artist">ì‘ê°€ ì¶”ê°€</option>
                          <option value="update_artist">ì‘ê°€ ìˆ˜ì •</option>
                          <option value="delete_artist">ì‘ê°€ ì‚­ì œ</option>
                      </select>
                  </div>
              </div>
              
              <div class="card-nft rounded-2xl overflow-hidden">
                  <div class="overflow-x-auto">
                      <table class="w-full">
                          <thead class="bg-white bg-opacity-5">
                              <tr>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ì‹œê°„</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ê´€ë¦¬ì</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">í™œë™</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ëŒ€ìƒ</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">ìƒì„¸</th>
                                  <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase">IP ì£¼ì†Œ</th>
                              </tr>
                          </thead>
                          <tbody id="logsTableBody" class="divide-y divide-white divide-opacity-5">
                              <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      </div>
  </section>
  
  <style>
      .tab-button {
          color: #9ca3af;
          border-bottom: 2px solid transparent;
      }
      
      .tab-button.active {
          color: #8b5cf6;
          border-bottom-color: #8b5cf6;
      }
      
      .tab-button:hover {
          color: #ffffff;
      }
  </style>
  
  <!-- ì‘í’ˆ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="artworkModal" class="hidden fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div class="bg-black border border-white border-opacity-10 rounded-3xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
              <h2 id="artworkModalTitle" class="text-2xl font-bold text-white">ìƒˆ ì‘í’ˆ ë“±ë¡</h2>
              <button onclick="closeArtworkModal()" class="text-gray-400 hover:text-white transition">
                  <i class="fas fa-times text-2xl"></i>
              </button>
          </div>
          
          <form id="artworkForm" class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                  <div class="col-span-2">
                      <label class="block text-sm font-medium text-gray-300 mb-2">ì‘í’ˆëª… *</label>
                      <input type="text" id="artwork_title" name="title" required class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">ì‘ê°€ ì„ íƒ *</label>
                      <select id="artwork_artist_id" name="artist_id" required class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white">
                          <option value="">ì‘ê°€ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                      </select>
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">ì¹´í…Œê³ ë¦¬ *</label>
                      <select id="artwork_category" name="category" required class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white">
                          <option value="ë””ì§€í„¸ì•„íŠ¸">ë””ì§€í„¸ì•„íŠ¸</option>
                          <option value="íšŒí™”">íšŒí™”</option>
                          <option value="ì¡°ê°">ì¡°ê°</option>
                          <option value="ì‚¬ì§„">ì‚¬ì§„</option>
                          <option value="íŒí™”">íŒí™”</option>
                          <option value="ì„¤ì¹˜ë¯¸ìˆ ">ì„¤ì¹˜ë¯¸ìˆ </option>
                      </select>
                  </div>
                  
                  <div class="col-span-2">
                      <label class="block text-sm font-medium text-gray-300 mb-2">ì„¤ëª…</label>
                      <textarea id="artwork_description" name="description" rows="3" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white"></textarea>
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">ê¸°ë²•</label>
                      <input type="text" id="artwork_technique" name="technique" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">ì œì‘ë…„ë„</label>
                      <input type="number" id="artwork_creation_year" name="creation_year" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">ê°€ë¡œ (cm)</label>
                      <input type="number" id="artwork_size_width" name="size_width" step="0.1" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">ì„¸ë¡œ (cm)</label>
                      <input type="number" id="artwork_size_height" name="size_height" step="0.1" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div class="col-span-2">
                      <label class="block text-sm font-medium text-gray-300 mb-2">ì´ë¯¸ì§€ *</label>
                      
                      <!-- íƒ­ ì„ íƒ -->
                      <div class="flex gap-2 mb-3">
                          <button type="button" id="uploadTabBtn" onclick="switchImageTab('upload')" class="flex-1 px-4 py-2 bg-purple-500 bg-opacity-20 text-purple-400 rounded-lg text-sm font-semibold transition">
                              <i class="fas fa-upload mr-2"></i>íŒŒì¼ ì—…ë¡œë“œ
                          </button>
                          <button type="button" id="urlTabBtn" onclick="switchImageTab('url')" class="flex-1 px-4 py-2 bg-white bg-opacity-5 text-gray-400 rounded-lg text-sm font-semibold transition">
                              <i class="fas fa-link mr-2"></i>URL ì…ë ¥
                          </button>
                      </div>
                      
                      <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ -->
                      <div id="uploadArea" class="upload-area">
                          <div id="dropZone" class="border-2 border-dashed border-white border-opacity-20 rounded-lg p-8 text-center hover:border-purple-500 hover:bg-purple-500 hover:bg-opacity-5 transition cursor-pointer">
                              <i class="fas fa-cloud-upload-alt text-4xl text-purple-500 mb-3"></i>
                              <p class="text-white mb-2">ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë˜ëŠ” í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</p>
                              <p class="text-sm text-gray-500">JPG, PNG, GIF, WebP (ìµœëŒ€ 10MB)</p>
                              <input type="file" id="artwork_image_file" accept="image/*" class="hidden" onchange="handleFileSelect(event)" />
                          </div>
                          
                          <div id="uploadProgress" class="hidden mt-3">
                              <div class="flex items-center justify-between mb-2">
                                  <span class="text-sm text-gray-400">ì—…ë¡œë“œ ì¤‘...</span>
                                  <span id="uploadPercent" class="text-sm text-purple-400">0%</span>
                              </div>
                              <div class="w-full bg-white bg-opacity-10 rounded-full h-2">
                                  <div id="uploadBar" class="bg-gradient-to-r from-purple-500 to-cyan-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                              </div>
                          </div>
                      </div>
                      
                      <!-- URL ì…ë ¥ ì˜ì—­ -->
                      <div id="urlArea" class="hidden">
                          <input type="url" id="artwork_image_url" name="image_url" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" placeholder="https://..." />
                      </div>
                      
                      <input type="hidden" id="artwork_final_image_url" name="final_image_url" required />
                  </div>
                  
                  <div id="imagePreviewContainer" class="col-span-2 hidden">
                      <label class="block text-sm font-medium text-gray-300 mb-2">ë¯¸ë¦¬ë³´ê¸°</label>
                      <div class="relative">
                          <img id="imagePreview" src="" alt="ë¯¸ë¦¬ë³´ê¸°" class="w-full h-64 object-cover rounded-lg" />
                          <button type="button" onclick="removeImage()" class="absolute top-2 right-2 w-8 h-8 bg-red-500 bg-opacity-80 hover:bg-opacity-100 text-white rounded-full transition">
                              <i class="fas fa-times"></i>
                          </button>
                      </div>
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">ê°€ê²© (ì›)</label>
                      <input type="number" id="artwork_current_price" name="current_price" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">ìƒíƒœ</label>
                      <select id="artwork_status" name="status" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white">
                          <option value="draft">ì´ˆì•ˆ</option>
                          <option value="pending_review">ê²€í†  ì¤‘</option>
                          <option value="approved">ìŠ¹ì¸ë¨</option>
                          <option value="minted">ë¯¼íŒ…ë¨</option>
                          <option value="sold">íŒë§¤ë¨</option>
                      </select>
                  </div>
              </div>
              
              <div class="flex gap-3 pt-4">
                  <button type="button" onclick="saveArtwork()" class="flex-1 gradient-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
                      <i class="fas fa-save mr-2"></i>ì €ì¥
                  </button>
                  <button type="button" onclick="closeArtworkModal()" class="px-6 py-3 bg-gray-500 bg-opacity-20 text-gray-300 rounded-lg hover:bg-opacity-30 transition">
                      ì·¨ì†Œ
                  </button>
              </div>
          </form>
      </div>
  </div>
  
  <!-- ì‘ê°€ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="artistModal" class="hidden fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div class="bg-black border border-white border-opacity-10 rounded-3xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
              <h2 id="artistModalTitle" class="text-2xl font-bold text-white">ìƒˆ ì‘ê°€ ë“±ë¡</h2>
              <button onclick="closeArtistModal()" class="text-gray-400 hover:text-white transition">
                  <i class="fas fa-times text-2xl"></i>
              </button>
          </div>
          
          <form id="artistForm" class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">ì‘ê°€ëª… *</label>
                      <input type="text" id="artist_name" name="name" required class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">ì´ë©”ì¼ *</label>
                      <input type="email" id="artist_email" name="email" required class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div class="col-span-2">
                      <label class="block text-sm font-medium text-gray-300 mb-2">ì•½ë ¥</label>
                      <textarea id="artist_bio" name="bio" rows="3" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white"></textarea>
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">ê²½ë ¥ (ë…„)</label>
                      <input type="number" id="artist_career_years" name="career_years" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">í•™ë ¥</label>
                      <input type="text" id="artist_education" name="education" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">ê°œì¸ì „ íšŸìˆ˜</label>
                      <input type="number" id="artist_solo_exhibitions" name="solo_exhibitions" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">ë‹¨ì²´ì „ íšŸìˆ˜</label>
                      <input type="number" id="artist_group_exhibitions" name="group_exhibitions" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">ê³µëª¨ì „ ìˆ˜ìƒ</label>
                      <input type="number" id="artist_awards" name="awards" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white" />
                  </div>
                  
                  <div class="col-span-2">
                      <label class="block text-sm font-medium text-gray-300 mb-2">ì§€ê°‘ ì£¼ì†Œ</label>
                      <input type="text" id="artist_wallet_address" name="wallet_address" class="w-full px-4 py-2 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white font-mono text-sm" placeholder="0x..." />
                  </div>
              </div>
              
              <div class="flex gap-3 pt-4">
                  <button type="button" onclick="saveArtist()" class="flex-1 gradient-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
                      <i class="fas fa-save mr-2"></i>ì €ì¥
                  </button>
                  <button type="button" onclick="closeArtistModal()" class="px-6 py-3 bg-gray-500 bg-opacity-20 text-gray-300 rounded-lg hover:bg-opacity-30 transition">
                      ì·¨ì†Œ
                  </button>
              </div>
          </form>
      </div>
  </div>
  
  <!-- OpenSea ê°€ì ¸ì˜¤ê¸° ëª¨ë‹¬ -->
  <div id="openSeaModal" class="hidden fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div class="bg-black border border-white border-opacity-10 rounded-3xl p-8 max-w-6xl w-full max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold text-white">
                  <i class="fab fa-ethereum text-cyan-500 mr-2"></i>
                  OpenSeaì—ì„œ NFT ê°€ì ¸ì˜¤ê¸°
              </h2>
              <button onclick="closeOpenSeaModal()" class="text-gray-400 hover:text-white transition">
                  <i class="fas fa-times text-2xl"></i>
              </button>
          </div>
          
          <!-- Step 1: API ì„¤ì • ë° URL ì…ë ¥ -->
          <div id="openSeaStep1" class="space-y-4">
              <div class="bg-gradient-to-r from-purple-900/30 to-cyan-900/30 border border-purple-500 border-opacity-30 rounded-xl p-5 mb-4">
                  <div class="flex items-start gap-3">
                      <i class="fas fa-magic text-cyan-400 text-xl mt-0.5"></i>
                      <div class="text-sm text-gray-200">
                          <p class="font-bold mb-2 text-white">ğŸš€ ê°„ë‹¨í•œ ì‚¬ìš© ë°©ë²•</p>
                          <div class="space-y-2 text-xs text-gray-300">
                              <div class="flex items-start gap-2">
                                  <span class="text-cyan-400 font-bold">1.</span>
                                  <span>OpenSeaì—ì„œ ì›í•˜ëŠ” ì»¬ë ‰ì…˜ í˜ì´ì§€ë¥¼ ì—½ë‹ˆë‹¤</span>
                              </div>
                              <div class="flex items-start gap-2">
                                  <span class="text-cyan-400 font-bold">2.</span>
                                  <span>ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ì˜ <span class="bg-black/50 px-2 py-0.5 rounded font-mono text-cyan-300">URLì„ ë³µì‚¬</span>í•˜ì—¬ ì•„ë˜ì— ë¶™ì—¬ë„£ê¸°</span>
                              </div>
                              <div class="flex items-start gap-2 pl-5">
                                  <i class="fas fa-arrow-right text-yellow-400 text-xs mt-1"></i>
                                  <div>
                                      <span class="text-yellow-300 font-semibold">ì˜ˆì‹œ:</span>
                                      <div class="bg-black/50 px-3 py-1 rounded mt-1 font-mono text-xs text-cyan-300 break-all">
                                          https://opensea.io/collection/azuki
                                      </div>
                                  </div>
                              </div>
                              <div class="flex items-start gap-2">
                                  <span class="text-cyan-400 font-bold">3.</span>
                                  <span>ì»¬ë ‰ì…˜ ì´ë¦„ë§Œ ì…ë ¥í•´ë„ ë©ë‹ˆë‹¤ (ì˜ˆ: <span class="bg-black/50 px-2 py-0.5 rounded font-mono text-cyan-300">azuki</span>)</span>
                              </div>
                              <div class="flex items-start gap-2">
                                  <span class="text-cyan-400 font-bold">4.</span>
                                  <span><span class="text-green-400 font-semibold">API í‚¤ ì—†ì´ë„</span> ë°ëª¨ ë°ì´í„°ë¡œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥!</span>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
              
              <div>
                  <label class="block text-sm font-medium text-white mb-2 flex items-center gap-2">
                      <i class="fas fa-key text-yellow-400"></i>
                      OpenSea API Key (ì„ íƒì‚¬í•­)
                  </label>
                  <input type="text" id="openSeaApiKey" placeholder="your-opensea-api-key-here (ì‹¤ì œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ë ¤ë©´ ì…ë ¥)" class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white font-mono text-sm focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/50 transition" />
                  <div class="flex items-center gap-2 mt-2">
                      <i class="fas fa-info-circle text-cyan-400"></i>
                      <p class="text-xs text-gray-400">
                          API í‚¤ê°€ ì—†ìœ¼ë©´ <span class="text-yellow-300">ë°ëª¨ ë°ì´í„°</span>ê°€ í‘œì‹œë©ë‹ˆë‹¤.
                          <a href="https://opensea.io/account/settings/developer" target="_blank" class="text-cyan-400 hover:text-cyan-300 underline ml-1">
                              ë¬´ë£Œë¡œ API í‚¤ ë°›ê¸° <i class="fas fa-external-link-alt text-xs"></i>
                          </a>
                      </p>
                  </div>
              </div>
              
              <div>
                  <label class="block text-sm font-medium text-white mb-2 flex items-center gap-2">
                      <i class="fas fa-link text-purple-400"></i>
                      OpenSea ì»¬ë ‰ì…˜ URL ë˜ëŠ” ì´ë¦„ <span class="text-red-400">*</span>
                  </label>
                  <input type="text" id="openSeaCollectionUrl" placeholder="ì˜ˆ: https://opensea.io/collection/azuki ë˜ëŠ” azuki" class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white focus:border-purple-500 focus:ring-2 focus:ring-purple-500/50 transition" />
                  <div class="grid grid-cols-2 gap-2 mt-2">
                      <button type="button" onclick="document.getElementById('openSeaCollectionUrl').value='azuki'" class="px-3 py-1 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded text-xs transition">
                          <i class="fas fa-fill-drip mr-1"></i>ì˜ˆì‹œ: Azuki
                      </button>
                      <button type="button" onclick="document.getElementById('openSeaCollectionUrl').value='cryptopunks'" class="px-3 py-1 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded text-xs transition">
                          <i class="fas fa-fill-drip mr-1"></i>ì˜ˆì‹œ: CryptoPunks
                      </button>
                  </div>
              </div>
              
              <div>
                  <label class="block text-sm font-medium text-white mb-2 flex items-center gap-2">
                      <i class="fas fa-list-ol text-green-400"></i>
                      ì¡°íšŒí•  ì‘í’ˆ ìˆ˜
                  </label>
                  <select id="openSeaLimit" class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white focus:border-green-500 focus:ring-2 focus:ring-green-500/50 transition">
                      <option value="10">10ê°œ (ë¹ ë¦„)</option>
                      <option value="20">20ê°œ</option>
                      <option value="50" selected>50ê°œ (ì¶”ì²œ)</option>
                      <option value="100">100ê°œ (ëŠë¦¼)</option>
                  </select>
                  <p class="text-xs text-gray-500 mt-1">
                      <i class="fas fa-lightbulb text-yellow-400"></i> 
                      ë§ì€ ìˆ˜ë¥¼ ì„ íƒí•˜ë©´ ë¡œë”© ì‹œê°„ì´ ê¸¸ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤
                  </p>
              </div>
              
              <div class="flex gap-3 pt-4">
                  <button type="button" onclick="loadOpenSeaArtworks()" class="flex-1 bg-gradient-to-r from-purple-600 to-cyan-600 hover:from-purple-500 hover:to-cyan-500 text-white py-4 rounded-xl font-bold transition-all transform hover:scale-105 shadow-lg hover:shadow-purple-500/50">
                      <i class="fas fa-rocket mr-2"></i>ì‘í’ˆ ì¡°íšŒí•˜ê¸°
                  </button>
                  <button type="button" onclick="closeOpenSeaModal()" class="px-6 py-4 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-xl transition">
                      ì·¨ì†Œ
                  </button>
              </div>
          </div>
          
          <!-- Step 2: ì‘í’ˆ ì„ íƒ -->
          <div id="openSeaStep2" class="hidden space-y-4">
              <div class="flex justify-between items-center mb-4">
                  <div>
                      <h3 class="text-lg font-bold text-white">ì‘í’ˆ ì„ íƒ</h3>
                      <p class="text-sm text-gray-400">ê°€ì ¸ì˜¬ ì‘í’ˆì„ ì„ íƒí•˜ì„¸ìš” (<span id="selectedCount">0</span>ê°œ ì„ íƒë¨)</p>
                  </div>
                  <div class="flex gap-2">
                      <button type="button" onclick="selectAllArtworks()" class="px-4 py-2 bg-purple-500 bg-opacity-20 text-purple-400 rounded-lg hover:bg-opacity-30 transition text-sm">
                          <i class="fas fa-check-double mr-1"></i>ì „ì²´ ì„ íƒ
                      </button>
                      <button type="button" onclick="deselectAllArtworks()" class="px-4 py-2 bg-gray-500 bg-opacity-20 text-gray-400 rounded-lg hover:bg-opacity-30 transition text-sm">
                          <i class="fas fa-times mr-1"></i>ì „ì²´ í•´ì œ
                      </button>
                  </div>
              </div>
              
              <div id="openSeaArtworksList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-96 overflow-y-auto p-2">
                  <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
              </div>
              
              <div class="flex gap-3 pt-4 border-t border-white border-opacity-10">
                  <button type="button" onclick="backToStep1()" class="px-6 py-3 bg-gray-500 bg-opacity-20 text-gray-300 rounded-lg hover:bg-opacity-30 transition">
                      <i class="fas fa-arrow-left mr-2"></i>ì´ì „
                  </button>
                  <button type="button" onclick="importSelectedArtworks()" class="flex-1 gradient-primary text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
                      <i class="fas fa-download mr-2"></i>ì„ íƒí•œ ì‘í’ˆ ê°€ì ¸ì˜¤ê¸°
                  </button>
                  <button type="button" onclick="closeOpenSeaModal()" class="px-6 py-3 bg-gray-500 bg-opacity-20 text-gray-300 rounded-lg hover:bg-opacity-30 transition">
                      ì·¨ì†Œ
                  </button>
              </div>
          </div>
      </div>
  </div>
  
  <script src="/static/admin-dashboard.js"></script>
  <script src="/static/admin-modals.js"></script>
  <script src="/static/admin-valuation.js"></script>
  <script>
      // ì‘ê°€ ëª©ë¡ ë¡œë“œí•˜ì—¬ ì…€ë ‰íŠ¸ë°•ìŠ¤ ì±„ìš°ê¸°
      async function loadArtistOptions() {
          try {
              const response = await fetch('/api/admin/artists');
              const data = await response.json();
              
              if (data.success) {
                  const select = document.getElementById('artwork_artist_id');
                  select.innerHTML = '<option value="">ì‘ê°€ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                  
                  data.data.forEach(artist => {
                      const option = document.createElement('option');
                      option.value = artist.id;
                      option.textContent = artist.name;
                      select.appendChild(option);
                  });
              }
          } catch (error) {
              console.error('ì‘ê°€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
          }
      }
      
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‘ê°€ ëª©ë¡ ë¡œë“œ
      loadArtistOptions();
      
      // ========== êµ¬ë§¤/ê²½ë§¤ ëª¨ë‹ˆí„°ë§ í•¨ìˆ˜ ==========
      
      // ìµœê·¼ ê±°ë˜ ë‚´ì—­ ë¡œë“œ
      async function refreshTransactions() {
        const sessionToken = localStorage.getItem('admin_session_token');
        if (!sessionToken) return;
        
        const status = document.getElementById('transactionStatusFilter').value;
        
        try {
          const response = await axios.get('/api/admin/transactions', {
            params: { status, limit: 10 },
            headers: { 'Authorization': 'Bearer ' + sessionToken }
          });
          
          if (response.data.success && response.data.data.length > 0) {
            document.getElementById('transactionsList').innerHTML = \`
              <table class="w-full text-sm">
                <thead class="border-b border-gray-700">
                  <tr class="text-left text-gray-400">
                    <th class="py-2">ì‘í’ˆ</th>
                    <th class="py-2">êµ¬ë§¤ì</th>
                    <th class="py-2">íŒë§¤ì</th>
                    <th class="py-2">ê°€ê²©</th>
                    <th class="py-2">ìƒíƒœ</th>
                    <th class="py-2">ë‚ ì§œ</th>
                  </tr>
                </thead>
                <tbody>
                  \${response.data.data.map(tx => \`
                    <tr class="border-b border-gray-800 hover:bg-gray-900">
                      <td class="py-3">
                        <div class="flex items-center gap-2">
                          <img src="\${tx.artwork_image}" class="w-10 h-10 rounded-lg object-cover" loading="lazy" />
                          <span class="text-white">\${tx.artwork_title}</span>
                        </div>
                      </td>
                      <td class="py-3 text-gray-300">\${tx.buyer_name || tx.buyer_username || '-'}</td>
                      <td class="py-3 text-gray-300">\${tx.seller_name || tx.seller_username || '-'}</td>
                      <td class="py-3 text-white font-semibold">\${tx.price} \${tx.currency}</td>
                      <td class="py-3">
                        <span class="px-2 py-1 rounded-full text-xs \${
                          tx.status === 'completed' ? 'bg-green-500 bg-opacity-20 text-green-400' :
                          tx.status === 'pending' ? 'bg-yellow-500 bg-opacity-20 text-yellow-400' :
                          'bg-red-500 bg-opacity-20 text-red-400'
                        }">
                          \${tx.status === 'completed' ? 'ì™„ë£Œ' : tx.status === 'pending' ? 'ëŒ€ê¸°ì¤‘' : 'ì‹¤íŒ¨'}
                        </span>
                      </td>
                      <td class="py-3 text-gray-400 text-xs">\${new Date(tx.created_at).toLocaleDateString('ko-KR')}</td>
                    </tr>
                  \`).join('')}
                </tbody>
              </table>
            \`;
          } else {
            document.getElementById('transactionsList').innerHTML = \`
              <div class="text-center py-8 text-gray-500">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>
            \`;
          }
        } catch (error) {
          console.error('Transactions fetch error:', error);
          document.getElementById('transactionsList').innerHTML = \`
            <div class="text-center py-4 text-red-400">ê±°ë˜ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
          \`;
        }
      }
      
      // ì§„í–‰ ì¤‘ì¸ ê²½ë§¤ ë¡œë“œ
      async function refreshAuctions() {
        const sessionToken = localStorage.getItem('admin_session_token');
        if (!sessionToken) return;
        
        try {
          const response = await axios.get('/api/admin/auctions', {
            params: { status: 'active', limit: 5 },
            headers: { 'Authorization': 'Bearer ' + sessionToken }
          });
          
          if (response.data.success && response.data.data.length > 0) {
            document.getElementById('auctionsList').innerHTML = response.data.data.map(auction => {
              const endTime = new Date(auction.end_time);
              const now = new Date();
              const timeLeft = endTime - now;
              const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
              const daysLeft = Math.floor(hoursLeft / 24);
              
              let timeLeftText = '';
              if (timeLeft < 0) {
                timeLeftText = '<span class="text-red-400">ì¢…ë£Œë¨</span>';
              } else if (daysLeft > 0) {
                timeLeftText = daysLeft + 'ì¼ ' + (hoursLeft % 24) + 'ì‹œê°„';
              } else {
                timeLeftText = hoursLeft + 'ì‹œê°„';
              }
              
              return \`
                <div class="bg-gray-900 rounded-lg p-4">
                  <div class="flex items-center gap-3 mb-3">
                    <img src="\${auction.artwork_image}" class="w-16 h-16 rounded-lg object-cover" loading="lazy" />
                    <div class="flex-1">
                      <div class="text-white font-semibold">\${auction.artwork_title}</div>
                      <div class="text-xs text-gray-400">íŒë§¤ì: \${auction.seller_name || auction.seller_username}</div>
                    </div>
                  </div>
                  <div class="grid grid-cols-3 gap-2 text-xs">
                    <div>
                      <div class="text-gray-500">í˜„ì¬ê°€</div>
                      <div class="text-white font-bold">\${auction.current_price} ETH</div>
                    </div>
                    <div>
                      <div class="text-gray-500">ì…ì°° ìˆ˜</div>
                      <div class="text-white font-bold">\${auction.total_bids}íšŒ</div>
                    </div>
                    <div>
                      <div class="text-gray-500">ë‚¨ì€ì‹œê°„</div>
                      <div class="text-white font-bold">\${timeLeftText}</div>
                    </div>
                  </div>
                </div>
              \`;
            }).join('');
          } else {
            document.getElementById('auctionsList').innerHTML = \`
              <div class="text-center py-8 text-gray-500">ì§„í–‰ ì¤‘ì¸ ê²½ë§¤ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            \`;
          }
        } catch (error) {
          console.error('Auctions fetch error:', error);
          document.getElementById('auctionsList').innerHTML = \`
            <div class="text-center py-4 text-red-400">ê²½ë§¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
          \`;
        }
      }
      
      // êµ¬ë§¤ ì œì•ˆ ëª©ë¡ ë¡œë“œ  
      async function refreshPurchaseOffers() {
        // Purchase offersëŠ” ì•„ì§ APIê°€ ì—†ìœ¼ë¯€ë¡œ placeholder í‘œì‹œ
        document.getElementById('purchaseOffersList').innerHTML = \`
          <div class="text-center py-8 text-gray-500">
            êµ¬ë§¤ ì œì•ˆ ê¸°ëŠ¥ì€ ì¶”í›„ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤
          </div>
        \`;
      }
      
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë‹ˆí„°ë§ ë°ì´í„° ë¡œë“œ
      refreshTransactions();
      refreshAuctions();
      refreshPurchaseOffers();
  </script>
  
  <!-- OpenSea Import Modal -->
  <div id="openSeaImportModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
      <div class="card-nft rounded-3xl p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
              <h3 class="text-2xl font-black text-white flex items-center">
                  <i class="fas fa-download text-cyan-400 mr-3"></i>
                  OpenSeaì—ì„œ ì‘í’ˆ ê°€ì ¸ì˜¤ê¸°
              </h3>
              <button onclick="closeOpenSeaImportModal()" class="text-gray-400 hover:text-white text-2xl transition">
                  <i class="fas fa-times"></i>
              </button>
          </div>
          
          <div class="space-y-6">
              <!-- URL ì…ë ¥ -->
              <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">
                      <i class="fas fa-link mr-2"></i>OpenSea NFT URL
                  </label>
                  <input type="text" id="openSeaUrl" 
                         class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-cyan-500 focus:outline-none"
                         placeholder="https://opensea.io/assets/ethereum/0x.../123">
                  <p class="text-xs text-gray-500 mt-2">
                      <i class="fas fa-info-circle mr-1"></i>
                      OpenSea NFT ìƒì„¸ í˜ì´ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”
                  </p>
              </div>
              
              <!-- ë˜ëŠ” ì§ì ‘ ì…ë ¥ -->
              <div class="relative">
                  <div class="absolute inset-0 flex items-center">
                      <div class="w-full border-t border-white border-opacity-10"></div>
                  </div>
                  <div class="relative flex justify-center text-sm">
                      <span class="px-4 bg-black text-gray-500">ë˜ëŠ” ì§ì ‘ ì…ë ¥</span>
                  </div>
              </div>
              
              <!-- Contract Address & Token ID -->
              <div class="grid grid-cols-2 gap-4">
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">
                          <i class="fas fa-file-contract mr-2"></i>Contract Address
                      </label>
                      <input type="text" id="contractAddress" 
                             class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-cyan-500 focus:outline-none"
                             placeholder="0x...">
                  </div>
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">
                          <i class="fas fa-hashtag mr-2"></i>Token ID
                      </label>
                      <input type="text" id="tokenId" 
                             class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-cyan-500 focus:outline-none"
                             placeholder="123">
                  </div>
              </div>
              
              <!-- Chain Selection -->
              <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">
                      <i class="fas fa-link mr-2"></i>ë¸”ë¡ì²´ì¸ ë„¤íŠ¸ì›Œí¬
                  </label>
                  <select id="chainSelect" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-cyan-500 focus:outline-none">
                      <option value="ethereum">Ethereum</option>
                      <option value="polygon">Polygon</option>
                      <option value="arbitrum">Arbitrum</option>
                      <option value="optimism">Optimism</option>
                      <option value="base">Base</option>
                  </select>
              </div>
              
              <!-- ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
              <div id="nftPreview" class="hidden bg-gradient-to-br from-cyan-900/20 via-blue-900/20 to-purple-900/20 rounded-2xl p-6 border border-cyan-500/30">
                  <h4 class="text-white font-bold mb-4 flex items-center">
                      <i class="fas fa-eye text-cyan-400 mr-2"></i>
                      NFT ë¯¸ë¦¬ë³´ê¸°
                  </h4>
                  <div id="nftPreviewContent" class="space-y-4">
                      <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                  </div>
              </div>
              
              <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
              <div id="importError" class="hidden p-4 bg-red-900/30 border border-red-500/50 rounded-xl text-red-300 text-sm">
                  <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
              </div>
              
              <!-- ë²„íŠ¼ -->
              <div class="flex gap-3 pt-4">
                  <button onclick="fetchOpenSeaNFT()" class="flex-1 px-6 py-3 bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-xl font-semibold hover:opacity-90 transition flex items-center justify-center">
                      <i class="fas fa-search mr-2"></i>
                      NFT ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                  </button>
                  <button onclick="importNFTToGallery()" id="importBtn" disabled class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-semibold hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                      <i class="fas fa-plus mr-2"></i>
                      ê°¤ëŸ¬ë¦¬ì— ë“±ë¡
                  </button>
              </div>
          </div>
      </div>
  </div>
  
  <script>
    // OpenSea Import Modal Functions
    let currentNFTData = null;
    
    function showOpenSeaImportModal() {
      document.getElementById('openSeaImportModal').classList.remove('hidden');
      // ì´ˆê¸°í™”
      document.getElementById('openSeaUrl').value = '';
      document.getElementById('contractAddress').value = '';
      document.getElementById('tokenId').value = '';
      document.getElementById('nftPreview').classList.add('hidden');
      document.getElementById('importError').classList.add('hidden');
      document.getElementById('importBtn').disabled = true;
      currentNFTData = null;
    }
    
    function closeOpenSeaImportModal() {
      document.getElementById('openSeaImportModal').classList.remove('hidden');
      document.getElementById('openSeaImportModal').classList.add('hidden');
    }
    
    // Parse OpenSea URL
    function parseOpenSeaUrl(url) {
      try {
        // Format: https://opensea.io/assets/ethereum/0xcontractaddress/tokenid
        const urlObj = new URL(url);
        const pathParts = urlObj.pathname.split('/').filter(p => p);
        
        if (pathParts[0] === 'assets' && pathParts.length >= 4) {
          return {
            chain: pathParts[1],
            contractAddress: pathParts[2],
            tokenId: pathParts[3]
          };
        }
        return null;
      } catch (e) {
        return null;
      }
    }
    
    // Fetch NFT from OpenSea
    async function fetchOpenSeaNFT() {
      const url = document.getElementById('openSeaUrl').value.trim();
      let chain = document.getElementById('chainSelect').value;
      let contractAddress = document.getElementById('contractAddress').value.trim();
      let tokenId = document.getElementById('tokenId').value.trim();
      
      // URLì´ ìˆìœ¼ë©´ íŒŒì‹±
      if (url) {
        const parsed = parseOpenSeaUrl(url);
        if (parsed) {
          chain = parsed.chain;
          contractAddress = parsed.contractAddress;
          tokenId = parsed.tokenId;
          
          // ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
          document.getElementById('chainSelect').value = chain;
          document.getElementById('contractAddress').value = contractAddress;
          document.getElementById('tokenId').value = tokenId;
        } else {
          showImportError('ì˜¬ë°”ë¥¸ OpenSea URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
          return;
        }
      }
      
      // í•„ìˆ˜ ì •ë³´ ì²´í¬
      if (!contractAddress || !tokenId) {
        showImportError('Contract Addressì™€ Token IDë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ë¡œë”© í‘œì‹œ
      document.getElementById('nftPreviewContent').innerHTML = \`
        <div class="text-center py-8">
          <i class="fas fa-spinner fa-spin text-3xl text-cyan-400 mb-3"></i>
          <p class="text-gray-300">OpenSeaì—ì„œ NFT ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</p>
        </div>
      \`;
      document.getElementById('nftPreview').classList.remove('hidden');
      document.getElementById('importError').classList.add('hidden');
      
      try {
        // ë°±ì—”ë“œ API í˜¸ì¶œ
        const response = await axios.post('/api/admin/opensea/fetch', {
          chain: chain,
          contract_address: contractAddress,
          token_id: tokenId
        });
        
        if (response.data.success) {
          currentNFTData = response.data.data;
          displayNFTPreview(currentNFTData);
          document.getElementById('importBtn').disabled = false;
        } else {
          throw new Error(response.data.error || 'NFT ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('OpenSea fetch error:', error);
        showImportError(error.response?.data?.error || error.message || 'NFT ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        document.getElementById('nftPreview').classList.add('hidden');
      }
    }
    
    // Display NFT Preview
    function displayNFTPreview(nft) {
      const html = \`
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <img src="\${nft.image_url || nft.image || 'https://via.placeholder.com/400'}" loading="lazy" 
                 alt="\${nft.name}" 
                 class="w-full rounded-xl object-cover aspect-square">
          </div>
          <div class="space-y-4">
            <div>
              <div class="text-xs text-cyan-400 mb-1">ì‘í’ˆëª…</div>
              <div class="text-white font-bold text-xl">\${nft.name || 'Untitled'}</div>
            </div>
            
            <div>
              <div class="text-xs text-cyan-400 mb-1">ì‘ê°€</div>
              <div class="text-white">\${nft.creator || nft.collection?.name || 'Unknown'}</div>
            </div>
            
            <div>
              <div class="text-xs text-cyan-400 mb-1">ì„¤ëª…</div>
              <div class="text-gray-300 text-sm max-h-24 overflow-y-auto">
                \${nft.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}
              </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-black/30 rounded-lg p-3">
                <div class="text-xs text-gray-400 mb-1">Contract</div>
                <div class="text-white text-xs font-mono truncate">\${nft.contract_address}</div>
              </div>
              <div class="bg-black/30 rounded-lg p-3">
                <div class="text-xs text-gray-400 mb-1">Token ID</div>
                <div class="text-white text-sm font-bold">\${nft.token_id}</div>
              </div>
            </div>
            
            \${nft.traits && nft.traits.length > 0 ? \`
              <div>
                <div class="text-xs text-cyan-400 mb-2">ì†ì„±</div>
                <div class="flex flex-wrap gap-2">
                  \${nft.traits.slice(0, 6).map(trait => \`
                    <span class="px-2 py-1 bg-purple-900/30 border border-purple-500/30 rounded text-xs text-purple-300">
                      \${trait.trait_type}: \${trait.value}
                    </span>
                  \`).join('')}
                </div>
              </div>
            \` : ''}
          </div>
        </div>
      \`;
      
      document.getElementById('nftPreviewContent').innerHTML = html;
    }
    
    // Import NFT to Gallery
    async function importNFTToGallery() {
      if (!currentNFTData) {
        alert('ë¨¼ì € NFT ì •ë³´ë¥¼ ê°€ì ¸ì™€ì£¼ì„¸ìš”.');
        return;
      }
      
      if (!confirm('ì´ NFTë¥¼ ê°¤ëŸ¬ë¦¬í”¼ì•„ì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      // ë²„íŠ¼ ë¹„í™œì„±í™”
      const importBtn = document.getElementById('importBtn');
      const originalText = importBtn.innerHTML;
      importBtn.disabled = true;
      importBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ë“±ë¡ ì¤‘...';
      
      try {
        const response = await axios.post('/api/admin/opensea/import', {
          nft_data: currentNFTData
        });
        
        if (response.data.success) {
          alert('NFTê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
          closeOpenSeaImportModal();
          // ì‘í’ˆ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          loadArtworks();
        } else {
          throw new Error(response.data.error || 'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('Import error:', error);
        alert(error.response?.data?.error || error.message || 'NFT ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      } finally {
        importBtn.disabled = false;
        importBtn.innerHTML = originalText;
      }
    }
    
    function showImportError(message) {
      const errorDiv = document.getElementById('importError');
      errorDiv.innerHTML = \`
        <div class="flex items-start gap-3">
          <i class="fas fa-exclamation-triangle text-red-400 mt-0.5"></i>
          <div class="flex-1">
            <div class="font-semibold mb-1">ì˜¤ë¥˜ ë°œìƒ</div>
            <div class="text-sm">\${message}</div>
          </div>
        </div>
      \`;
      errorDiv.classList.remove('hidden');
    }
    
    // OpenSea Menu Toggle
    function toggleOpenSeaMenu() {
      const menu = document.getElementById('openSeaMenu');
      menu.classList.toggle('hidden');
    }
    
    function hideOpenSeaMenu() {
      document.getElementById('openSeaMenu').classList.add('hidden');
    }
    
    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      const menu = document.getElementById('openSeaMenu');
      const button = e.target.closest('button');
      if (menu && !menu.contains(e.target) && !button?.textContent?.includes('OpenSea')) {
        menu.classList.add('hidden');
      }
    });
    
    // Price Update Function
    async function updateOpenSeaPrices() {
      if (!confirm('OpenSeaì—ì„œ ìµœì‹  ê°€ê²© ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ ì‘í’ˆ ê°€ê²©ì„ ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      try {
        const response = await axios.post('/api/admin/opensea/update-prices');
        if (response.data.success) {
          alert('âœ… ' + response.data.updated + 'ê°œ ì‘í’ˆì˜ ê°€ê²©ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadArtworks();
        } else {
          alert('ê°€ê²© ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + response.data.error);
        }
      } catch (error) {
        console.error('Price update error:', error);
        alert('ê°€ê²© ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
  </script>
  
  <!-- Batch Import Modal -->
  <div id="batchImportModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
      <div class="card-nft rounded-3xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
              <h3 class="text-2xl font-black text-white flex items-center">
                  <i class="fas fa-layer-group text-cyan-400 mr-3"></i>
                  ë°°ì¹˜ Import - ì—¬ëŸ¬ NFT ë™ì‹œ ê°€ì ¸ì˜¤ê¸°
              </h3>
              <button onclick="closeBatchImportModal()" class="text-gray-400 hover:text-white text-2xl transition">
                  <i class="fas fa-times"></i>
              </button>
          </div>
          
          <div class="space-y-6">
              <div class="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                  <div class="flex items-start gap-3">
                      <i class="fas fa-info-circle text-blue-400 mt-0.5"></i>
                      <div class="text-sm text-gray-300">
                          <p class="font-semibold text-blue-300 mb-2">ë°°ì¹˜ Import ì‚¬ìš© ë°©ë²•</p>
                          <ul class="space-y-1 text-xs">
                              <li>â€¢ í•œ ë²ˆì— ìµœëŒ€ 50ê°œ NFTë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                              <li>â€¢ ê° ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥: contract_address,token_id</li>
                              <li>â€¢ ì˜ˆ: 0xbc4ca0eda7647a8ab7c2061c2e118a18a936f13d,1</li>
                          </ul>
                      </div>
                  </div>
              </div>
              
              <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">
                      <i class="fas fa-list mr-2"></i>NFT ëª©ë¡ (Contract,TokenID)
                  </label>
                  <textarea id="batchNftList" rows="10"
                            class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white font-mono text-sm focus:border-cyan-500 focus:outline-none"
                            placeholder="0xbc4ca0eda7647a8ab7c2061c2e118a18a936f13d,1
0xbc4ca0eda7647a8ab7c2061c2e118a18a936f13d,2
0xbc4ca0eda7647a8ab7c2061c2e118a18a936f13d,3"></textarea>
              </div>
              
              <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">ë¸”ë¡ì²´ì¸ ë„¤íŠ¸ì›Œí¬</label>
                  <select id="batchChainSelect" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white">
                      <option value="ethereum">Ethereum</option>
                      <option value="polygon">Polygon</option>
                      <option value="arbitrum">Arbitrum</option>
                      <option value="optimism">Optimism</option>
                      <option value="base">Base</option>
                  </select>
              </div>
              
              <div id="batchProgress" class="hidden">
                  <div class="bg-gradient-to-r from-cyan-900/20 to-purple-900/20 rounded-xl p-6 border border-cyan-500/30">
                      <div class="flex items-center justify-between mb-4">
                          <span class="text-white font-semibold">ì§„í–‰ ìƒí™©</span>
                          <span class="text-cyan-400" id="batchProgressText">0 / 0</span>
                      </div>
                      <div class="w-full bg-gray-800 rounded-full h-3 overflow-hidden">
                          <div id="batchProgressBar" class="h-full bg-gradient-to-r from-cyan-500 to-purple-500 transition-all duration-300" style="width: 0%"></div>
                      </div>
                  </div>
              </div>
              
              <div id="batchResults" class="hidden space-y-3">
                  <!-- Results will be shown here -->
              </div>
              
              <div class="flex gap-3">
                  <button onclick="startBatchImport()" id="batchImportBtn" class="flex-1 px-6 py-3 bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-xl font-semibold hover:opacity-90 transition">
                      <i class="fas fa-download mr-2"></i>ë°°ì¹˜ ê°€ì ¸ì˜¤ê¸° ì‹œì‘
                  </button>
                  <button onclick="importBatchToGallery()" id="batchSaveBtn" disabled class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-semibold hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed">
                      <i class="fas fa-save mr-2"></i>ê°¤ëŸ¬ë¦¬ì— ë“±ë¡
                  </button>
              </div>
          </div>
      </div>
  </div>
  
  <!-- Collection Import Modal -->
  <div id="collectionImportModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
      <div class="card-nft rounded-3xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
              <h3 class="text-2xl font-black text-white flex items-center">
                  <i class="fas fa-th text-cyan-400 mr-3"></i>
                  ì»¬ë ‰ì…˜ Import - ì „ì²´ ê°€ì ¸ì˜¤ê¸°
              </h3>
              <button onclick="closeCollectionImportModal()" class="text-gray-400 hover:text-white text-2xl transition">
                  <i class="fas fa-times"></i>
              </button>
          </div>
          
          <div class="space-y-6">
              <div class="bg-purple-900/20 border border-purple-500/30 rounded-xl p-4">
                  <div class="flex items-start gap-3">
                      <i class="fas fa-lightbulb text-purple-400 mt-0.5"></i>
                      <div class="text-sm text-gray-300">
                          <p class="font-semibold text-purple-300 mb-2">ì»¬ë ‰ì…˜ ìŠ¬ëŸ¬ê·¸ ì°¾ê¸°</p>
                          <p class="text-xs">OpenSea URLì—ì„œ ì»¬ë ‰ì…˜ ìŠ¬ëŸ¬ê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
                          <p class="text-xs text-gray-500 mt-1">ì˜ˆ: opensea.io/collection/<span class="text-purple-400 font-mono">boredapeyachtclub</span></p>
                      </div>
                  </div>
              </div>
              
              <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">
                      <i class="fas fa-tag mr-2"></i>ì»¬ë ‰ì…˜ ìŠ¬ëŸ¬ê·¸
                  </label>
                  <input type="text" id="collectionSlug"
                         class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-cyan-500 focus:outline-none"
                         placeholder="boredapeyachtclub">
              </div>
              
              <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">
                      <i class="fas fa-hashtag mr-2"></i>ê°€ì ¸ì˜¬ ê°œìˆ˜
                  </label>
                  <input type="number" id="collectionLimit" min="1" max="200" value="20"
                         class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-xl text-white focus:border-cyan-500 focus:outline-none">
                  <p class="text-xs text-gray-500 mt-1">ìµœëŒ€ 200ê°œê¹Œì§€ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
              </div>
              
              <div id="collectionPreview" class="hidden bg-gradient-to-br from-purple-900/20 via-pink-900/20 to-orange-900/20 rounded-2xl p-6 border border-purple-500/30">
                  <h4 class="text-white font-bold mb-4 flex items-center">
                      <i class="fas fa-eye text-purple-400 mr-2"></i>ì»¬ë ‰ì…˜ ë¯¸ë¦¬ë³´ê¸°
                  </h4>
                  <div id="collectionPreviewContent">
                      <!-- Collection info will be shown here -->
                  </div>
              </div>
              
              <div class="flex gap-3">
                  <button onclick="fetchCollection()" class="flex-1 px-6 py-3 bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-xl font-semibold hover:opacity-90 transition">
                      <i class="fas fa-search mr-2"></i>ì»¬ë ‰ì…˜ ì¡°íšŒ
                  </button>
                  <button onclick="importCollectionToGallery()" id="collectionImportBtn" disabled class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-semibold hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed">
                      <i class="fas fa-download mr-2"></i>ì „ì²´ Import
                  </button>
              </div>
          </div>
      </div>
  </div>
  
  <script>
    // Batch Import Functions
    let batchNftData = [];
    
    function showBatchImportModal() {
      document.getElementById('batchImportModal').classList.remove('hidden');
      document.getElementById('batchNftList').value = '';
      document.getElementById('batchProgress').classList.add('hidden');
      document.getElementById('batchResults').classList.add('hidden');
      document.getElementById('batchSaveBtn').disabled = true;
      batchNftData = [];
    }
    
    function closeBatchImportModal() {
      document.getElementById('batchImportModal').classList.add('hidden');
    }
    
    async function startBatchImport() {
      const listText = document.getElementById('batchNftList').value.trim();
      const chain = document.getElementById('batchChainSelect').value;
      
      if (!listText) {
        alert('NFT ëª©ë¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // Parse input
      const lines = listText.split('\\n').filter(l => l.trim());
      const nfts = [];
      
      for (const line of lines) {
        const parts = line.trim().split(',');
        if (parts.length >= 2) {
          nfts.push({
            chain: chain,
            contract_address: parts[0].trim(),
            token_id: parts[1].trim()
          });
        }
      }
      
      if (nfts.length === 0) {
        alert('ì˜¬ë°”ë¥¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (nfts.length > 50) {
        alert('ìµœëŒ€ 50ê°œê¹Œì§€ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      // Show progress
      document.getElementById('batchProgress').classList.remove('hidden');
      document.getElementById('batchResults').classList.add('hidden');
      document.getElementById('batchImportBtn').disabled = true;
      
      try {
        const response = await axios.post('/api/admin/opensea/batch-fetch', { nfts });
        
        if (response.data.success) {
          batchNftData = response.data.data.nfts;
          
          // Update progress
          document.getElementById('batchProgressText').textContent = response.data.data.successful + ' / ' + response.data.data.total;
          document.getElementById('batchProgressBar').style.width = ((response.data.data.successful / response.data.data.total) * 100) + '%';
          
          // Show results
          const nftCards = batchNftData.slice(0, 8).map(nft => 
            '<div class="bg-black/30 rounded-lg p-2">' +
              '<img src="' + nft.image_url + '" class="w-full aspect-square object-cover rounded mb-1" loading="lazy" />' +
              '<div class="text-xs text-white truncate">' + nft.name + '</div>' +
            '</div>'
          ).join('');
          
          const moreText = batchNftData.length > 8 ? 
            '<p class="text-xs text-gray-400 mt-2">ê·¸ ì™¸ ' + (batchNftData.length - 8) + 'ê°œ...</p>' : '';
          
          const failedSection = response.data.data.failed > 0 ? 
            '<div class="bg-red-900/20 border border-red-500/30 rounded-xl p-4">' +
              '<div class="text-red-300 font-semibold">' +
                '<i class="fas fa-exclamation-circle mr-2"></i>ì‹¤íŒ¨: ' + response.data.data.failed + 'ê°œ' +
              '</div>' +
            '</div>' : '';
          
          const resultsHtml = 
            '<div class="bg-green-900/20 border border-green-500/30 rounded-xl p-4">' +
              '<div class="text-green-300 font-semibold mb-2">' +
                '<i class="fas fa-check-circle mr-2"></i>ì„±ê³µ: ' + response.data.data.successful + 'ê°œ' +
              '</div>' +
              '<div class="grid grid-cols-2 md:grid-cols-4 gap-2">' + nftCards + '</div>' +
              moreText +
            '</div>' + failedSection;
          
          document.getElementById('batchResults').innerHTML = resultsHtml;
          document.getElementById('batchResults').classList.remove('hidden');
          document.getElementById('batchSaveBtn').disabled = false;
        }
      } catch (error) {
        alert('ë°°ì¹˜ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ' + (error.response?.data?.error || error.message));
      } finally {
        document.getElementById('batchImportBtn').disabled = false;
      }
    }
    
    async function importBatchToGallery() {
      if (batchNftData.length === 0) {
        alert('ë¨¼ì € NFTë¥¼ ê°€ì ¸ì™€ì£¼ì„¸ìš”.');
        return;
      }
      
      if (!confirm(batchNftData.length + 'ê°œì˜ NFTë¥¼ ê°¤ëŸ¬ë¦¬ì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      const btn = document.getElementById('batchSaveBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ë“±ë¡ ì¤‘...';
      
      try {
        let success = 0;
        for (const nft of batchNftData) {
          try {
            const response = await axios.post('/api/admin/opensea/import', { nft_data: nft });
            if (response.data.success) success++;
            await new Promise(resolve => setTimeout(resolve, 100));
          } catch (e) {
            console.error('Import error:', e);
          }
        }
        
        alert('âœ… ' + success + 'ê°œì˜ NFTê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        closeBatchImportModal();
        loadArtworks();
      } catch (error) {
        alert('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save mr-2"></i>ê°¤ëŸ¬ë¦¬ì— ë“±ë¡';
      }
    }
    
    // Collection Import Functions
    let collectionData = null;
    
    function showCollectionImportModal() {
      document.getElementById('collectionImportModal').classList.remove('hidden');
      document.getElementById('collectionSlug').value = '';
      document.getElementById('collectionPreview').classList.add('hidden');
      document.getElementById('collectionImportBtn').disabled = true;
      collectionData = null;
    }
    
    function closeCollectionImportModal() {
      document.getElementById('collectionImportModal').classList.add('hidden');
    }
    
    async function fetchCollection() {
      const slug = document.getElementById('collectionSlug').value.trim();
      const limit = parseInt(document.getElementById('collectionLimit').value) || 20;
      
      if (!slug) {
        alert('ì»¬ë ‰ì…˜ ìŠ¬ëŸ¬ê·¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      try {
        const response = await axios.post('/api/admin/opensea/collection-fetch', {
          collection_slug: slug,
          limit: limit
        });
        
        if (response.data.success) {
          collectionData = response.data.data;
          
          // Show collection preview
          const html = 
            '<div class="grid md:grid-cols-2 gap-4">' +
              '<div>' +
                '<img src="' + collectionData.collection.image_url + '" class="w-full rounded-xl" loading="lazy" />' +
              '</div>' +
              '<div class="space-y-3">' +
                '<div>' +
                  '<div class="text-xs text-purple-400 mb-1">ì»¬ë ‰ì…˜ëª…</div>' +
                  '<div class="text-white font-bold text-lg">' + collectionData.collection.name + '</div>' +
                '</div>' +
                '<div>' +
                  '<div class="text-xs text-purple-400 mb-1">ì„¤ëª…</div>' +
                  '<div class="text-gray-300 text-sm max-h-20 overflow-y-auto">' + (collectionData.collection.description || 'ì„¤ëª… ì—†ìŒ') + '</div>' +
                '</div>' +
                '<div>' +
                  '<div class="text-xs text-purple-400 mb-1">ì´ ê³µê¸‰ëŸ‰</div>' +
                  '<div class="text-white font-semibold">' + (collectionData.collection.total_supply || 'N/A') + '</div>' +
                '</div>' +
                '<div>' +
                  '<div class="text-xs text-purple-400 mb-1">ê°€ì ¸ì˜¬ NFT ìˆ˜</div>' +
                  '<div class="text-white font-bold text-xl">' + collectionData.total + 'ê°œ</div>' +
                '</div>' +
              '</div>' +
            '</div>';
          
          document.getElementById('collectionPreviewContent').innerHTML = html;
          document.getElementById('collectionPreview').classList.remove('hidden');
          document.getElementById('collectionImportBtn').disabled = false;
        }
      } catch (error) {
        alert('ì»¬ë ‰ì…˜ ì¡°íšŒ ì‹¤íŒ¨: ' + (error.response?.data?.error || error.message));
      }
    }
    
    async function importCollectionToGallery() {
      if (!collectionData) {
        alert('ë¨¼ì € ì»¬ë ‰ì…˜ì„ ì¡°íšŒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (!confirm(collectionData.total + 'ê°œì˜ NFTë¥¼ ê°¤ëŸ¬ë¦¬ì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‹œê°„ì´ ë‹¤ì†Œ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
        return;
      }
      
      const btn = document.getElementById('collectionImportBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ë“±ë¡ ì¤‘...';
      
      try {
        let success = 0;
        for (const nft of collectionData.nfts) {
          try {
            // Convert OpenSea NFT format to our format
            const nftData = {
              name: nft.name || nft.identifier,
              description: nft.description || '',
              image_url: nft.image_url || nft.display_image_url,
              contract_address: nft.contract,
              token_id: nft.identifier,
              chain: 'ethereum',
              creator: nft.creator || 'Unknown',
              collection: {
                name: collectionData.collection.name,
                slug: document.getElementById('collectionSlug').value
              },
              traits: nft.traits || [],
              opensea_url: 'https://opensea.io/assets/ethereum/' + nft.contract + '/' + nft.identifier
            };
            
            const response = await axios.post('/api/admin/opensea/import', { nft_data: nftData });
            if (response.data.success) success++;
            await new Promise(resolve => setTimeout(resolve, 200));
          } catch (e) {
            console.error('Import error:', e);
          }
        }
        
        alert('âœ… ' + success + 'ê°œì˜ NFTê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        closeCollectionImportModal();
        loadArtworks();
      } catch (error) {
        alert('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-download mr-2"></i>ì „ì²´ Import';
      }
    }
    
    // =====================================================
    // Ownership Tracking Modal & Functions
    // =====================================================
    
    function showOwnershipTrackingModal() {
      document.getElementById('ownershipTrackingModal').classList.remove('hidden');
      loadOwnershipList();
    }
    
    function closeOwnershipTrackingModal() {
      document.getElementById('ownershipTrackingModal').classList.add('hidden');
    }
    
    async function loadOwnershipList() {
      try {
        const response = await axios.get('/api/admin/opensea/owners');
        const owners = response.data.data;
        
        const html = owners.map(owner => 
          '<div class="bg-black/30 rounded-lg p-4 flex items-center justify-between border border-white/10">' +
            '<div class="flex-1">' +
              '<div class="text-white font-semibold">' + (owner.artwork_title || 'Untitled') + '</div>' +
              '<div class="text-sm text-gray-400 mt-1">' +
                '<span class="font-mono">' + (owner.token_id || 'N/A') + '</span>' +
              '</div>' +
              '<div class="text-xs text-gray-500 mt-1">' +
                'ì†Œìœ ì: ' + (owner.current_owner_address ? owner.current_owner_address.substring(0, 10) + '...' : 'ì•Œ ìˆ˜ ì—†ìŒ') +
              '</div>' +
              '<div class="text-xs text-gray-500">' +
                'ì „ì†¡ íšŸìˆ˜: ' + (owner.total_transfers || 0) + 'íšŒ' +
              '</div>' +
            '</div>' +
            '<button onclick="viewOwnershipHistory(' + owner.artwork_id + ')" class="px-3 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700 transition">' +
              '<i class="fas fa-history mr-1"></i>ì´ë ¥ ë³´ê¸°' +
            '</button>' +
          '</div>'
        ).join('');
        
        document.getElementById('ownershipList').innerHTML = html || '<div class="text-gray-500 text-center py-8">ì†Œìœ ê¶Œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        
      } catch (error) {
        console.error('Ownership list error:', error);
        alert('ì†Œìœ ê¶Œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    async function viewOwnershipHistory(artworkId) {
      try {
        const response = await axios.get('/api/admin/opensea/ownership/' + artworkId);
        const { history, status } = response.data.data;
        
        let html = '';
        
        // Current owner info
        if (status) {
          html += '<div class="bg-purple-900/20 border border-purple-500/30 rounded-xl p-4 mb-4">' +
            '<div class="text-purple-300 font-semibold mb-2"><i class="fas fa-crown mr-2"></i>í˜„ì¬ ì†Œìœ ì</div>' +
            '<div class="text-white font-mono text-sm">' + (status.current_owner_address || 'ì•Œ ìˆ˜ ì—†ìŒ') + '</div>' +
            '<div class="text-xs text-gray-400 mt-2">ë§ˆì§€ë§‰ ë™ê¸°í™”: ' + (status.last_synced_at || 'N/A') + '</div>' +
          '</div>';
        }
        
        // History timeline
        html += '<div class="text-white font-semibold mb-3"><i class="fas fa-history mr-2"></i>ì†Œìœ ê¶Œ ì´ë ¥ (' + history.length + 'ê±´)</div>';
        
        if (history.length === 0) {
          html += '<div class="text-gray-500 text-center py-8">ì†Œìœ ê¶Œ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        } else {
          html += '<div class="space-y-2 max-h-96 overflow-y-auto">';
          history.forEach((item, index) => {
            html += '<div class="bg-black/30 rounded-lg p-3 border-l-4 ' + 
              (item.transfer_type === 'sale' ? 'border-green-500' : 'border-blue-500') + '">' +
              '<div class="flex items-center justify-between mb-2">' +
                '<span class="text-xs text-gray-500">#' + (index + 1) + '</span>' +
                '<span class="text-xs px-2 py-1 rounded ' + 
                  (item.transfer_type === 'sale' ? 'bg-green-500/20 text-green-300' : 'bg-blue-500/20 text-blue-300') + '">' +
                  (item.transfer_type === 'sale' ? 'íŒë§¤' : 'ì „ì†¡') +
                '</span>' +
              '</div>' +
              '<div class="text-sm text-gray-300">' +
                '<div class="flex items-center gap-2 mb-1">' +
                  '<span class="text-gray-500">From:</span>' +
                  '<span class="font-mono text-xs">' + (item.from_address ? item.from_address.substring(0, 12) + '...' : 'Mint') + '</span>' +
                '</div>' +
                '<div class="flex items-center gap-2">' +
                  '<span class="text-gray-500">To:</span>' +
                  '<span class="font-mono text-xs">' + (item.to_address ? item.to_address.substring(0, 12) + '...' : 'N/A') + '</span>' +
                '</div>' +
              '</div>' +
              (item.price_eth ? '<div class="text-sm text-green-400 mt-2"><i class="fas fa-tag mr-1"></i>' + item.price_eth + ' ETH</div>' : '') +
              '<div class="text-xs text-gray-500 mt-2">' + (item.created_at || 'N/A') + '</div>' +
            '</div>';
          });
          html += '</div>';
        }
        
        document.getElementById('ownershipHistoryContent').innerHTML = html;
        document.getElementById('ownershipHistoryModal').classList.remove('hidden');
        
      } catch (error) {
        console.error('Ownership history error:', error);
        alert('ì†Œìœ ê¶Œ ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    function closeOwnershipHistoryModal() {
      document.getElementById('ownershipHistoryModal').classList.add('hidden');
    }
    
    // =====================================================
    // Transaction History Modal & Functions
    // =====================================================
    
    function showTransactionHistoryModal() {
      document.getElementById('transactionHistoryModal').classList.remove('hidden');
      document.getElementById('transactionImportForm').classList.remove('hidden');
      document.getElementById('transactionResults').classList.add('hidden');
    }
    
    function closeTransactionHistoryModal() {
      document.getElementById('transactionHistoryModal').classList.add('hidden');
    }
    
    async function importNFTTransactions() {
      const contractAddress = document.getElementById('txContractAddress').value.trim();
      const tokenId = document.getElementById('txTokenId').value.trim();
      const chain = document.getElementById('txChainSelect').value;
      
      if (!contractAddress || !tokenId) {
        alert('Contract Addressì™€ Token IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const btn = document.getElementById('importTxBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
      
      try {
        // Find artwork_id if exists
        const artworksResponse = await axios.get('/api/admin/artworks');
        const artworks = artworksResponse.data.data || [];
        const artwork = artworks.find(a => 
          a.nft_contract_address === contractAddress && a.nft_token_id === tokenId
        );
        
        const response = await axios.post('/api/admin/opensea/import-transactions', {
          artwork_id: artwork?.id || null,
          contract_address: contractAddress,
          token_id: tokenId,
          chain: chain
        });
        
        if (response.data.success) {
          alert('âœ… ' + response.data.message);
          await loadTransactionHistory();
          document.getElementById('transactionImportForm').classList.add('hidden');
          document.getElementById('transactionResults').classList.remove('hidden');
        }
        
      } catch (error) {
        console.error('Transaction import error:', error);
        alert('ê±°ë˜ ì´ë ¥ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ' + (error.response?.data?.error || error.message));
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-download mr-2"></i>ê±°ë˜ ì´ë ¥ ê°€ì ¸ì˜¤ê¸°';
      }
    }
    
    async function importCollectionTransactions() {
      const collectionSlug = document.getElementById('txCollectionSlug').value.trim();
      const limit = parseInt(document.getElementById('txCollectionLimit').value) || 50;
      
      if (!collectionSlug) {
        alert('ì»¬ë ‰ì…˜ ìŠ¬ëŸ¬ê·¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const btn = document.getElementById('importCollectionTxBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
      
      try {
        const response = await axios.post('/api/admin/opensea/import-collection-transactions', {
          collection_slug: collectionSlug,
          limit: limit
        });
        
        if (response.data.success) {
          alert('âœ… ' + response.data.message);
          await loadTransactionHistory();
          document.getElementById('transactionImportForm').classList.add('hidden');
          document.getElementById('transactionResults').classList.remove('hidden');
        }
        
      } catch (error) {
        console.error('Collection transaction import error:', error);
        alert('ê±°ë˜ ì´ë ¥ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ' + (error.response?.data?.error || error.message));
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-download mr-2"></i>ì»¬ë ‰ì…˜ ê±°ë˜ ì´ë ¥ ê°€ì ¸ì˜¤ê¸°';
      }
    }
    
    async function loadTransactionHistory() {
      try {
        const response = await axios.get('/api/admin/opensea/transactions?limit=20');
        const transactions = response.data.data;
        
        const html = transactions.map((tx, index) => 
          '<div class="bg-black/30 rounded-lg p-4 border border-white/10">' +
            '<div class="flex items-center justify-between mb-2">' +
              '<span class="text-xs text-gray-500">#' + (index + 1) + '</span>' +
              '<span class="text-xs px-2 py-1 rounded ' + 
                (tx.event_type === 'successful' ? 'bg-green-500/20 text-green-300' : 'bg-blue-500/20 text-blue-300') + '">' +
                tx.event_type +
              '</span>' +
            '</div>' +
            '<div class="text-white font-semibold mb-1">' + (tx.nft_name || tx.artwork_title || 'Unknown NFT') + '</div>' +
            '<div class="text-sm text-gray-400 mb-2">' + (tx.collection_name || 'Unknown Collection') + '</div>' +
            (tx.price_eth ? '<div class="text-green-400 font-semibold mb-2"><i class="fas fa-tag mr-1"></i>' + tx.price_eth + ' ETH' + 
              (tx.price_krw ? ' (â‚©' + tx.price_krw.toLocaleString() + ')' : '') + 
            '</div>' : '') +
            '<div class="text-xs text-gray-500 space-y-1">' +
              (tx.seller_address ? '<div>Seller: ' + tx.seller_address.substring(0, 12) + '...</div>' : '') +
              (tx.buyer_address ? '<div>Buyer: ' + tx.buyer_address.substring(0, 12) + '...</div>' : '') +
              '<div>ì‹œê°„: ' + (tx.imported_at || 'N/A') + '</div>' +
            '</div>' +
          '</div>'
        ).join('');
        
        document.getElementById('transactionList').innerHTML = html || 
          '<div class="text-gray-500 text-center py-8">ê±°ë˜ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        
      } catch (error) {
        console.error('Transaction history error:', error);
        document.getElementById('transactionList').innerHTML = 
          '<div class="text-red-500 text-center py-8">ê±°ë˜ ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }
    
    function showTransactionImportForm() {
      document.getElementById('transactionImportForm').classList.remove('hidden');
      document.getElementById('transactionResults').classList.add('hidden');
    }
  </script>
  
  <!-- Ownership Tracking Modal -->
  <div id="ownershipTrackingModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
      <div class="bg-gradient-to-br from-gray-900 to-black border border-purple-500/30 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
          <div class="p-6 border-b border-white/10 flex items-center justify-between">
              <h2 class="text-2xl font-bold text-white flex items-center">
                  <i class="fas fa-user-shield text-purple-400 mr-3"></i>
                  NFT ì†Œìœ ê¶Œ ì¶”ì 
              </h2>
              <button onclick="closeOwnershipTrackingModal()" class="text-gray-400 hover:text-white transition">
                  <i class="fas fa-times text-xl"></i>
              </button>
          </div>
          
          <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
              <div id="ownershipList" class="space-y-3">
                  <div class="text-gray-500 text-center py-8">
                      <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                      <div>ë¡œë”© ì¤‘...</div>
                  </div>
              </div>
          </div>
      </div>
  </div>
  
  <!-- Ownership History Detail Modal -->
  <div id="ownershipHistoryModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
      <div class="bg-gradient-to-br from-gray-900 to-black border border-purple-500/30 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
          <div class="p-6 border-b border-white/10 flex items-center justify-between">
              <h2 class="text-2xl font-bold text-white flex items-center">
                  <i class="fas fa-history text-purple-400 mr-3"></i>
                  ì†Œìœ ê¶Œ ì´ë ¥
              </h2>
              <button onclick="closeOwnershipHistoryModal()" class="text-gray-400 hover:text-white transition">
                  <i class="fas fa-times text-xl"></i>
              </button>
          </div>
          
          <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
              <div id="ownershipHistoryContent"></div>
          </div>
      </div>
  </div>
  
  <!-- Transaction History Modal -->
  <div id="transactionHistoryModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
      <div class="bg-gradient-to-br from-gray-900 to-black border border-amber-500/30 rounded-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
          <div class="p-6 border-b border-white/10 flex items-center justify-between">
              <h2 class="text-2xl font-bold text-white flex items-center">
                  <i class="fas fa-exchange-alt text-amber-400 mr-3"></i>
                  OpenSea ê±°ë˜ ì´ë ¥
              </h2>
              <button onclick="closeTransactionHistoryModal()" class="text-gray-400 hover:text-white transition">
                  <i class="fas fa-times text-xl"></i>
              </button>
          </div>
          
          <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
              <!-- Import Form -->
              <div id="transactionImportForm" class="mb-6">
                  <div class="bg-amber-900/20 border border-amber-500/30 rounded-xl p-4 mb-4">
                      <div class="text-amber-300 font-semibold mb-3">
                          <i class="fas fa-info-circle mr-2"></i>ê±°ë˜ ì´ë ¥ ê°€ì ¸ì˜¤ê¸°
                      </div>
                      
                      <!-- Single NFT Import -->
                      <div class="mb-6">
                          <div class="text-white font-semibold mb-3">ë‹¨ì¼ NFT ê±°ë˜ ì´ë ¥</div>
                          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                              <input type="text" id="txContractAddress" placeholder="Contract Address" 
                                  class="bg-black/50 border border-white/20 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:border-amber-500 focus:outline-none">
                              <input type="text" id="txTokenId" placeholder="Token ID" 
                                  class="bg-black/50 border border-white/20 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:border-amber-500 focus:outline-none">
                              <select id="txChainSelect" class="bg-black/50 border border-white/20 rounded-lg px-4 py-2 text-white focus:border-amber-500 focus:outline-none">
                                  <option value="ethereum">Ethereum</option>
                                  <option value="polygon">Polygon</option>
                                  <option value="arbitrum">Arbitrum</option>
                                  <option value="optimism">Optimism</option>
                              </select>
                          </div>
                          <button onclick="importNFTTransactions()" id="importTxBtn" 
                              class="w-full px-6 py-3 bg-gradient-to-r from-amber-600 to-orange-600 text-white rounded-xl font-semibold hover:opacity-90 transition">
                              <i class="fas fa-download mr-2"></i>ê±°ë˜ ì´ë ¥ ê°€ì ¸ì˜¤ê¸°
                          </button>
                      </div>
                      
                      <!-- Collection Import -->
                      <div>
                          <div class="text-white font-semibold mb-3">ì»¬ë ‰ì…˜ ê±°ë˜ ì´ë ¥</div>
                          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                              <input type="text" id="txCollectionSlug" placeholder="Collection Slug (e.g., boredapeyachtclub)" 
                                  class="bg-black/50 border border-white/20 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:border-amber-500 focus:outline-none">
                              <input type="number" id="txCollectionLimit" placeholder="Limit (max 300)" value="50" min="1" max="300"
                                  class="bg-black/50 border border-white/20 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:border-amber-500 focus:outline-none">
                          </div>
                          <button onclick="importCollectionTransactions()" id="importCollectionTxBtn" 
                              class="w-full px-6 py-3 bg-gradient-to-r from-amber-600 to-orange-600 text-white rounded-xl font-semibold hover:opacity-90 transition">
                              <i class="fas fa-download mr-2"></i>ì»¬ë ‰ì…˜ ê±°ë˜ ì´ë ¥ ê°€ì ¸ì˜¤ê¸°
                          </button>
                      </div>
                  </div>
              </div>
              
              <!-- Results -->
              <div id="transactionResults" class="hidden">
                  <div class="flex items-center justify-between mb-4">
                      <div class="text-white font-semibold">
                          <i class="fas fa-list mr-2"></i>ê±°ë˜ ì´ë ¥ ëª©ë¡
                      </div>
                      <button onclick="showTransactionImportForm()" class="px-4 py-2 bg-amber-500/20 text-amber-400 rounded-lg hover:bg-amber-500/30 transition">
                          <i class="fas fa-plus mr-2"></i>ë” ê°€ì ¸ì˜¤ê¸°
                      </button>
                  </div>
                  
                  <div id="transactionList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div class="text-gray-500 text-center py-8">
                          <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                          <div>ë¡œë”© ì¤‘...</div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>
  
  `;
  
  return c.html(getLayout(content, 'ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ - GALLERYPIA'))
})

// ============================================
// ê´€ë¦¬ì API ì—”ë“œí¬ì¸íŠ¸
// ============================================

// OpenSea NFT Fetch API (ê°œì„ ëœ ë²„ì „ with API Key)
app.post('/api/admin/opensea/fetch-nft', async (c) => {
  try {
    const { chain, contract_address, token_id } = await c.req.json()
    
    if (!contract_address || !token_id) {
      return c.json({ success: false, error: 'Contract addressì™€ token IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    // API Key ê°€ì ¸ì˜¤ê¸° (í™˜ê²½ë³€ìˆ˜)
    const apiKey = c.env.OPENSEA_API_KEY || ''
    
    // OpenSea API v2 í˜¸ì¶œ (ë‹¤ì–‘í•œ ë°©ë²• ì‹œë„)
    const methods = [
      // Method 1: OpenSea API v2 with API Key (best)
      async () => {
        if (!apiKey) throw new Error('No API key')
        const url = `https://api.opensea.io/api/v2/chain/${chain}/contract/${contract_address}/nfts/${token_id}`
        const response = await fetch(url, {
          headers: {
            'Accept': 'application/json',
            'X-API-KEY': apiKey,
            'User-Agent': 'GalleryPia/2.0'
          }
        })
        if (response.ok) return await response.json()
        throw new Error('API v2 with key failed')
      },
      
      // Method 2: OpenSea API v2 without auth
      async () => {
        const url = `https://api.opensea.io/api/v2/chain/${chain}/contract/${contract_address}/nfts/${token_id}`
        const response = await fetch(url, {
          headers: {
            'Accept': 'application/json',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
          }
        })
        if (response.ok) return await response.json()
        throw new Error('API v2 failed')
      },
      
      // Method 3: OpenSea API v1 endpoint (backup)
      async () => {
        const url = `https://api.opensea.io/api/v1/asset/${contract_address}/${token_id}`
        const headers: any = {
          'Accept': 'application/json',
          'User-Agent': 'Mozilla/5.0'
        }
        if (apiKey) headers['X-API-KEY'] = apiKey
        
        const response = await fetch(url, { headers })
        if (response.ok) return await response.json()
        throw new Error('API v1 failed')
      },
      
      // Method 4: Alchemy NFT API (if key available)
      async () => {
        const alchemyKey = c.env.ALCHEMY_API_KEY
        if (!alchemyKey) throw new Error('No Alchemy key')
        
        const alchemyUrl = `https://eth-mainnet.g.alchemy.com/nft/v3/${alchemyKey}/getNFTMetadata`
        const response = await fetch(`${alchemyUrl}?contractAddress=${contract_address}&tokenId=${token_id}`)
        if (response.ok) return await response.json()
        throw new Error('Alchemy failed')
      }
    ]
    
    // ê° ë°©ë²•ì„ ìˆœì°¨ì ìœ¼ë¡œ ì‹œë„
    let rawData = null
    let usedMethod = ''
    
    for (let i = 0; i < methods.length; i++) {
      try {
        rawData = await methods[i]()
        usedMethod = `method_${i + 1}`
        console.log(`âœ… Method ${i + 1} succeeded`)
        break
      } catch (e) {
        console.log(`âŒ Method ${i + 1} failed, trying next...`)
        continue
      }
    }
    
    // ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìœ¼ë©´ ì •ê·œí™”
    if (rawData) {
      // ë‹¤ì–‘í•œ API ì‘ë‹µ í˜•ì‹ì„ ì •ê·œí™”
      const nft = rawData.nft || rawData.asset || rawData
      
      const nftData = {
        name: nft.name || nft.title || nft.identifier || `Token #${token_id}`,
        description: nft.description || nft.rawMetadata?.description || '',
        image_url: nft.image_url || nft.image || nft.image_original_url || 
                   nft.media?.[0]?.gateway || nft.display_image_url || 
                   `https://via.placeholder.com/400?text=Token+${token_id}`,
        animation_url: nft.animation_url || nft.animation_original_url || '',
        contract_address: contract_address,
        token_id: token_id,
        chain: chain,
        creator: nft.creator?.user?.username || nft.creator?.address || 
                nft.contract?.contract_deployer || 'Unknown Artist',
        collection: {
          name: nft.collection?.name || nft.contract?.name || 'Unknown Collection',
          slug: nft.collection?.slug || ''
        },
        traits: nft.traits || nft.attributes || nft.rawMetadata?.attributes || [],
        external_url: nft.external_url || nft.external_link || '',
        opensea_url: `https://opensea.io/assets/${chain}/${contract_address}/${token_id}`,
        metadata_source: usedMethod,
        // ì¶”ê°€ ì •ë³´
        owner: nft.owner || nft.owners?.[0] || null,
        last_sale: nft.last_sale || null,
        floor_price: nft.collection?.stats?.floor_price || null
      }
      
      return c.json({ success: true, data: nftData })
    }
    
    // ëª¨ë“  ë°©ë²• ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ë°ì´í„° ë°˜í™˜
    return c.json({
      success: true,
      data: {
        name: `Token #${token_id}`,
        description: `Contract: ${contract_address}\nToken ID: ${token_id}\n\nì´ NFTëŠ” ${chain} ë„¤íŠ¸ì›Œí¬ì— ìˆìŠµë‹ˆë‹¤. OpenSea APIë¥¼ í†µí•´ ìì„¸í•œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤.\n\nìˆ˜ë™ìœ¼ë¡œ ì‘í’ˆ ì •ë³´ë¥¼ ì…ë ¥í•˜ê±°ë‚˜, OpenSeaì—ì„œ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.`,
        image_url: `https://via.placeholder.com/400?text=NFT+%23${token_id}`,
        contract_address: contract_address,
        token_id: token_id,
        chain: chain,
        creator: 'Unknown Artist',
        collection: {
          name: 'Unknown Collection',
          slug: ''
        },
        traits: [],
        external_url: '',
        opensea_url: `https://opensea.io/assets/${chain}/${contract_address}/${token_id}`,
        note: 'âš ï¸ APIë¥¼ í†µí•´ ë©”íƒ€ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ ì •ë³´ë¡œ ë“±ë¡í•œ í›„ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.',
        warning: true
      }
    })
    
  } catch (error: any) {
    console.error('OpenSea fetch error:', error)
    return c.json({ 
      success: false, 
      error: error.message || 'NFT ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' 
    }, 500)
  }
})

// Batch Import API - ì—¬ëŸ¬ NFT ë™ì‹œ ê°€ì ¸ì˜¤ê¸°
app.post('/api/admin/opensea/batch-fetch', async (c) => {
  try {
    const { nfts } = await c.req.json()
    
    if (!nfts || !Array.isArray(nfts) || nfts.length === 0) {
      return c.json({ success: false, error: 'NFT ëª©ë¡ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    if (nfts.length > 50) {
      return c.json({ success: false, error: 'í•œ ë²ˆì— ìµœëŒ€ 50ê°œê¹Œì§€ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.' }, 400)
    }
    
    // ê° NFTì— ëŒ€í•´ fetch ì‹œë„
    const results = await Promise.allSettled(
      nfts.map(async (nft: any) => {
        const response = await fetch(`${c.req.url.replace('/batch-fetch', '/fetch')}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chain: nft.chain || 'ethereum',
            contract_address: nft.contract_address,
            token_id: nft.token_id
          })
        })
        return await response.json()
      })
    )
    
    // ê²°ê³¼ ì •ë¦¬
    const successful = results.filter(r => r.status === 'fulfilled' && r.value.success).map(r => (r as any).value.data)
    const failed = results.filter(r => r.status === 'rejected' || !r.value.success)
    
    return c.json({
      success: true,
      data: {
        total: nfts.length,
        successful: successful.length,
        failed: failed.length,
        nfts: successful
      }
    })
    
  } catch (error: any) {
    console.error('Batch fetch error:', error)
    return c.json({ 
      success: false, 
      error: error.message || 'ë°°ì¹˜ ê°€ì ¸ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' 
    }, 500)
  }
})

// Collection Import API - ì»¬ë ‰ì…˜ ì „ì²´ ê°€ì ¸ì˜¤ê¸°
app.post('/api/admin/opensea/collection-fetch', async (c) => {
  try {
    const { collection_slug, limit = 20 } = await c.req.json()
    
    if (!collection_slug) {
      return c.json({ success: false, error: 'ì»¬ë ‰ì…˜ ìŠ¬ëŸ¬ê·¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    const apiKey = c.env.OPENSEA_API_KEY || ''
    
    // OpenSea Collection API í˜¸ì¶œ
    const headers: any = {
      'Accept': 'application/json',
      'User-Agent': 'GalleryPia/2.0'
    }
    if (apiKey) headers['X-API-KEY'] = apiKey
    
    // ì»¬ë ‰ì…˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const collectionUrl = `https://api.opensea.io/api/v2/collections/${collection_slug}`
    const collectionResponse = await fetch(collectionUrl, { headers })
    
    if (!collectionResponse.ok) {
      throw new Error('ì»¬ë ‰ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
    }
    
    const collectionData = await collectionResponse.json()
    
    // ì»¬ë ‰ì…˜ NFT ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const nftsUrl = `https://api.opensea.io/api/v2/collection/${collection_slug}/nfts?limit=${Math.min(limit, 200)}`
    const nftsResponse = await fetch(nftsUrl, { headers })
    
    if (!nftsResponse.ok) {
      throw new Error('ì»¬ë ‰ì…˜ NFTë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
    }
    
    const nftsData = await nftsResponse.json()
    
    return c.json({
      success: true,
      data: {
        collection: {
          name: collectionData.name,
          description: collectionData.description,
          image_url: collectionData.image_url,
          banner_image_url: collectionData.banner_image_url,
          owner: collectionData.owner,
          total_supply: collectionData.total_supply,
          contracts: collectionData.contracts
        },
        nfts: nftsData.nfts || [],
        total: nftsData.nfts?.length || 0
      }
    })
    
  } catch (error: any) {
    console.error('Collection fetch error:', error)
    return c.json({ 
      success: false, 
      error: error.message || 'ì»¬ë ‰ì…˜ ê°€ì ¸ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' 
    }, 500)
  }
})

// Price Update API - ê°€ê²© ì •ë³´ ì—…ë°ì´íŠ¸
app.post('/api/admin/opensea/update-prices', async (c) => {
  try {
    const db = c.env.DB
    const apiKey = c.env.OPENSEA_API_KEY || ''
    
    // DBì—ì„œ OpenSea NFT ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const artworks = await db.prepare(`
      SELECT id, nft_contract_address, nft_token_id, blockchain_network
      FROM artworks
      WHERE is_minted = 1 AND nft_contract_address IS NOT NULL
      LIMIT 100
    `).all()
    
    if (!artworks.results || artworks.results.length === 0) {
      return c.json({ success: true, message: 'ì—…ë°ì´íŠ¸í•  NFTê°€ ì—†ìŠµë‹ˆë‹¤.', updated: 0 })
    }
    
    const headers: any = {
      'Accept': 'application/json',
      'User-Agent': 'GalleryPia/2.0'
    }
    if (apiKey) headers['X-API-KEY'] = apiKey
    
    let updated = 0
    
    // ê° NFTì˜ ê°€ê²© ì •ë³´ ì—…ë°ì´íŠ¸
    for (const artwork of artworks.results) {
      try {
        const url = `https://api.opensea.io/api/v2/chain/${artwork.blockchain_network}/contract/${artwork.nft_contract_address}/nfts/${artwork.nft_token_id}`
        const response = await fetch(url, { headers })
        
        if (response.ok) {
          const data = await response.json()
          const nft = data.nft || data
          
          // Floor price ì—…ë°ì´íŠ¸
          if (nft.collection?.stats?.floor_price) {
            const floorPriceKRW = Math.round(nft.collection.stats.floor_price * 3000000) // 1 ETH = 3M KRW
            
            await db.prepare(`
              UPDATE artworks 
              SET estimated_value = ?,
                  updated_at = datetime('now')
              WHERE id = ?
            `).bind(floorPriceKRW, artwork.id).run()
            
            updated++
          }
        }
        
        // Rate limit ë°©ì§€
        await new Promise(resolve => setTimeout(resolve, 200))
        
      } catch (error) {
        console.error(`Failed to update artwork ${artwork.id}:`, error)
      }
    }
    
    return c.json({ 
      success: true, 
      message: `${updated}ê°œ ì‘í’ˆì˜ ê°€ê²©ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`,
      updated: updated,
      total: artworks.results.length
    })
    
  } catch (error: any) {
    console.error('Price update error:', error)
    return c.json({ 
      success: false, 
      error: error.message || 'ê°€ê²© ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' 
    }, 500)
  }
})

// OpenSea NFT Import API
app.post('/api/admin/opensea/import', async (c) => {
  try {
    const db = c.env.DB
    const { nft_data } = await c.req.json()
    
    if (!nft_data) {
      return c.json({ success: false, error: 'NFT ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    // ê¸°ë³¸ ì‘ê°€ ì •ë³´ (OpenSea creator ë˜ëŠ” Unknown Artist)
    let artistId = 1 // ê¸°ë³¸ ì‘ê°€ ID
    
    // ì‘ê°€ê°€ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
    if (nft_data.creator) {
      const existingArtist = await db.prepare(`
        SELECT id FROM artists WHERE name = ? OR wallet_address = ?
      `).bind(nft_data.creator, nft_data.creator).first()
      
      if (existingArtist) {
        artistId = existingArtist.id as number
      } else {
        // ìƒˆ ì‘ê°€ ìƒì„±
        const artistResult = await db.prepare(`
          INSERT INTO artists (name, bio, profile_image, wallet_address, created_at)
          VALUES (?, ?, ?, ?, datetime('now'))
        `).bind(
          nft_data.creator,
          `OpenSea creator: ${nft_data.collection?.name || 'Unknown Collection'}`,
          nft_data.image_url || 'https://via.placeholder.com/100',
          nft_data.creator
        ).run()
        
        artistId = artistResult.meta.last_row_id as number
      }
    }
    
    // ì‘í’ˆ ë“±ë¡
    const artworkResult = await db.prepare(`
      INSERT INTO artworks (
        title, description, image_url, artist_id, 
        category, creation_year, 
        nft_contract_address, nft_token_id, blockchain_network,
        is_minted, status,
        base_material_cost, labor_hours,
        market_demand_score, rarity_score,
        artistic_quality_score, originality_score,
        cultural_significance_score, technical_excellence_score,
        estimated_value,
        created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
    `).bind(
      nft_data.name || 'Untitled',
      nft_data.description || 'OpenSeaì—ì„œ ê°€ì ¸ì˜¨ NFT ì‘í’ˆì…ë‹ˆë‹¤.',
      nft_data.image_url || 'https://via.placeholder.com/400',
      artistId,
      'ë””ì§€í„¸ì•„íŠ¸', // OpenSea NFTëŠ” ë””ì§€í„¸ì•„íŠ¸ë¡œ ë¶„ë¥˜
      new Date().getFullYear(),
      nft_data.contract_address,
      nft_data.token_id,
      nft_data.chain || 'ethereum',
      1, // is_minted = true
      'approved', // ë°”ë¡œ ìŠ¹ì¸ ìƒíƒœë¡œ
      100000, // ê¸°ë³¸ ì¬ë£Œë¹„
      10, // ê¸°ë³¸ ì‘ì—…ì‹œê°„
      70, // ê¸°ë³¸ ì‹œì¥ìˆ˜ìš” ì ìˆ˜
      75, // ê¸°ë³¸ í¬ì†Œì„± ì ìˆ˜
      80, // ê¸°ë³¸ ì˜ˆìˆ ì„± ì ìˆ˜
      75, // ê¸°ë³¸ ë…ì°½ì„± ì ìˆ˜
      70, // ê¸°ë³¸ ë¬¸í™”ì˜ì˜ ì ìˆ˜
      80, // ê¸°ë³¸ ê¸°ìˆ ìš°ìˆ˜ì„± ì ìˆ˜
      5000000 // ê¸°ë³¸ ì˜ˆìƒê°€ (5ë°±ë§Œì›)
    ).run()
    
    const artworkId = artworkResult.meta.last_row_id
    
    // Extended info ì¶”ê°€
    if (nft_data.external_url || nft_data.opensea_url) {
      await db.prepare(`
        INSERT INTO artwork_extended_info (
          artwork_id, external_links, source_platform, created_at
        ) VALUES (?, ?, ?, datetime('now'))
      `).bind(
        artworkId,
        JSON.stringify({
          opensea: nft_data.opensea_url,
          external: nft_data.external_url
        }),
        'opensea'
      ).run()
    }
    
    return c.json({ 
      success: true, 
      message: 'NFTê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
      artwork_id: artworkId
    })
    
  } catch (error: any) {
    console.error('OpenSea import error:', error)
    return c.json({ 
      success: false, 
      error: error.message || 'NFT ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' 
    }, 500)
  }
})

// =====================================================
// NFT Ownership Tracking APIs
// =====================================================

// Get ownership history for an NFT
app.get('/api/admin/opensea/ownership/:artworkId', async (c) => {
  try {
    const db = c.env.DB
    const artworkId = c.req.param('artworkId')
    
    // Get ownership history
    const history = await db.prepare(`
      SELECT 
        oh.*,
        a.title as artwork_title,
        a.nft_contract_address,
        a.nft_token_id
      FROM nft_ownership_history oh
      JOIN artworks a ON oh.artwork_id = a.id
      WHERE oh.artwork_id = ?
      ORDER BY oh.block_timestamp DESC, oh.created_at DESC
    `).bind(artworkId).all()
    
    // Get current ownership status
    const status = await db.prepare(`
      SELECT * FROM nft_ownership_sync_status
      WHERE artwork_id = ?
    `).bind(artworkId).first()
    
    return c.json({
      success: true,
      data: {
        history: history.results || [],
        status: status || null,
        total: history.results?.length || 0
      }
    })
    
  } catch (error: any) {
    console.error('Ownership history error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// Sync ownership from OpenSea or blockchain
app.post('/api/admin/opensea/sync-ownership/:artworkId', async (c) => {
  try {
    const db = c.env.DB
    const artworkId = c.req.param('artworkId')
    const apiKey = c.env.OPENSEA_API_KEY || ''
    
    // Get artwork info
    const artwork = await db.prepare(`
      SELECT id, nft_contract_address, nft_token_id, blockchain_network
      FROM artworks
      WHERE id = ? AND is_minted = 1
    `).bind(artworkId).first()
    
    if (!artwork) {
      return c.json({ success: false, error: 'NFTë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    // Update sync status to 'syncing'
    await db.prepare(`
      INSERT OR REPLACE INTO nft_ownership_sync_status 
        (artwork_id, contract_address, token_id, chain, sync_status, last_synced_at)
      VALUES (?, ?, ?, ?, 'syncing', datetime('now'))
    `).bind(
      artwork.id,
      artwork.nft_contract_address,
      artwork.nft_token_id,
      artwork.blockchain_network
    ).run()
    
    try {
      // Try to get current owner from OpenSea
      const headers: any = {
        'Accept': 'application/json',
        'User-Agent': 'GalleryPia/2.0'
      }
      if (apiKey) headers['X-API-KEY'] = apiKey
      
      const url = `https://api.opensea.io/api/v2/chain/${artwork.blockchain_network}/contract/${artwork.nft_contract_address}/nfts/${artwork.nft_token_id}`
      const response = await fetch(url, { headers })
      
      if (response.ok) {
        const data = await response.json()
        const nft = data.nft || data
        
        // Get owners (OpenSea v2 may have owners array or single owner)
        const owners = nft.owners || (nft.owner ? [nft.owner] : [])
        
        if (owners.length > 0) {
          const owner = owners[0]
          const ownerAddress = owner.address || owner
          
          // Update current owner
          await db.prepare(`
            UPDATE nft_ownership_sync_status
            SET 
              current_owner_address = ?,
              sync_status = 'completed',
              sync_error = NULL,
              last_synced_at = datetime('now'),
              updated_at = datetime('now')
            WHERE artwork_id = ?
          `).bind(ownerAddress, artwork.id).run()
          
          return c.json({
            success: true,
            message: 'ì†Œìœ ê¶Œ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.',
            data: {
              current_owner: ownerAddress,
              synced_at: new Date().toISOString()
            }
          })
        } else {
          throw new Error('ì†Œìœ ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
        }
      } else {
        throw new Error('OpenSea API ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
      }
      
    } catch (error: any) {
      // Update sync status to 'failed'
      await db.prepare(`
        UPDATE nft_ownership_sync_status
        SET 
          sync_status = 'failed',
          sync_error = ?,
          updated_at = datetime('now')
        WHERE artwork_id = ?
      `).bind(error.message, artwork.id).run()
      
      throw error
    }
    
  } catch (error: any) {
    console.error('Ownership sync error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// Get current owners for all minted NFTs
app.get('/api/admin/opensea/owners', async (c) => {
  try {
    const db = c.env.DB
    
    const owners = await db.prepare(`
      SELECT * FROM v_current_nft_owners
      ORDER BY last_synced_at DESC
    `).all()
    
    return c.json({
      success: true,
      data: owners.results || [],
      total: owners.results?.length || 0
    })
    
  } catch (error: any) {
    console.error('Owners list error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// =====================================================
// OpenSea Transaction History APIs
// =====================================================

// Import transaction history for an NFT
app.post('/api/admin/opensea/import-transactions', async (c) => {
  try {
    const db = c.env.DB
    const { artwork_id, contract_address, token_id, chain } = await c.req.json()
    const apiKey = c.env.OPENSEA_API_KEY || ''
    
    if (!apiKey) {
      return c.json({ 
        success: false, 
        error: 'OpenSea API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤. í™˜ê²½ ë³€ìˆ˜ì— OPENSEA_API_KEYë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.' 
      }, 400)
    }
    
    const headers = {
      'Accept': 'application/json',
      'X-API-KEY': apiKey,
      'User-Agent': 'GalleryPia/2.0'
    }
    
    // Create import job
    const jobResult = await db.prepare(`
      INSERT INTO opensea_import_jobs 
        (job_type, contract_address, token_id, chain, job_status, started_at)
      VALUES ('nft_transactions', ?, ?, ?, 'running', datetime('now'))
    `).bind(contract_address, token_id, chain || 'ethereum').run()
    
    const jobId = jobResult.meta.last_row_id
    
    try {
      // Fetch events from OpenSea API v2
      const eventsUrl = `https://api.opensea.io/api/v2/events/chain/${chain || 'ethereum'}/contract/${contract_address}/nfts/${token_id}`
      const response = await fetch(eventsUrl, { headers })
      
      if (!response.ok) {
        throw new Error('OpenSea Events API ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
      }
      
      const data = await response.json()
      const events = data.asset_events || []
      
      let imported = 0
      let failed = 0
      
      for (const event of events) {
        try {
          // Parse event data
          const eventType = event.event_type
          const transaction = event.transaction || {}
          const payment = event.payment || {}
          
          // Calculate price in different currencies
          const priceETH = payment.quantity ? parseFloat(payment.quantity) / 1e18 : null
          const priceUSD = payment.usd_price || null
          const priceKRW = priceETH ? Math.round(priceETH * 3000000) : null
          
          // Insert transaction record
          await db.prepare(`
            INSERT OR IGNORE INTO opensea_transaction_history (
              opensea_event_id,
              event_type,
              contract_address,
              token_id,
              chain,
              artwork_id,
              transaction_hash,
              block_number,
              block_timestamp,
              seller_address,
              buyer_address,
              from_account,
              to_account,
              price_eth,
              price_usd,
              price_krw,
              payment_token,
              quantity,
              collection_slug,
              collection_name,
              nft_name,
              nft_image_url,
              nft_permalink,
              raw_event_data
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          `).bind(
            event.event_id || `${transaction.hash}_${event.event_type}`,
            eventType,
            contract_address,
            token_id,
            chain || 'ethereum',
            artwork_id || null,
            transaction.hash || null,
            transaction.block_number || null,
            event.event_timestamp || null,
            event.seller?.address || null,
            event.buyer?.address || null,
            event.from_account?.address || null,
            event.to_account?.address || null,
            priceETH,
            priceUSD,
            priceKRW,
            payment.symbol || 'ETH',
            event.quantity || 1,
            event.collection?.slug || null,
            event.collection?.name || null,
            event.nft?.name || null,
            event.nft?.image_url || null,
            event.nft?.permalink || null,
            JSON.stringify(event)
          ).run()
          
          // If it's a transfer or sale, also record in ownership history
          if (['transfer', 'sale', 'successful'].includes(eventType) && artwork_id) {
            await db.prepare(`
              INSERT INTO nft_ownership_history (
                artwork_id,
                contract_address,
                token_id,
                chain,
                from_address,
                to_address,
                transaction_hash,
                block_number,
                block_timestamp,
                transfer_type,
                price_eth,
                price_krw,
                marketplace,
                marketplace_url,
                event_source
              ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            `).bind(
              artwork_id,
              contract_address,
              token_id,
              chain || 'ethereum',
              event.from_account?.address || event.seller?.address || null,
              event.to_account?.address || event.buyer?.address || null,
              transaction.hash || null,
              transaction.block_number || null,
              event.event_timestamp || null,
              eventType === 'successful' ? 'sale' : 'transfer',
              priceETH,
              priceKRW,
              'opensea',
              event.nft?.permalink || null,
              'opensea_api'
            ).run()
          }
          
          imported++
          
        } catch (error) {
          console.error('Failed to import event:', error)
          failed++
        }
      }
      
      // Update job status
      await db.prepare(`
        UPDATE opensea_import_jobs
        SET 
          job_status = 'completed',
          total_events = ?,
          processed_events = ?,
          failed_events = ?,
          imported_transactions = ?,
          completed_at = datetime('now')
        WHERE id = ?
      `).bind(events.length, imported + failed, failed, imported, jobId).run()
      
      return c.json({
        success: true,
        message: `${imported}ê°œì˜ ê±°ë˜ ì´ë ¥ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.`,
        data: {
          job_id: jobId,
          total_events: events.length,
          imported: imported,
          failed: failed
        }
      })
      
    } catch (error: any) {
      // Update job status to failed
      await db.prepare(`
        UPDATE opensea_import_jobs
        SET 
          job_status = 'failed',
          error_message = ?,
          completed_at = datetime('now')
        WHERE id = ?
      `).bind(error.message, jobId).run()
      
      throw error
    }
    
  } catch (error: any) {
    console.error('Transaction import error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// Import transaction history for a collection
app.post('/api/admin/opensea/import-collection-transactions', async (c) => {
  try {
    const db = c.env.DB
    const { collection_slug, limit = 50 } = await c.req.json()
    const apiKey = c.env.OPENSEA_API_KEY || ''
    
    if (!apiKey) {
      return c.json({ 
        success: false, 
        error: 'OpenSea API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.' 
      }, 400)
    }
    
    const headers = {
      'Accept': 'application/json',
      'X-API-KEY': apiKey,
      'User-Agent': 'GalleryPia/2.0'
    }
    
    // Create import job
    const jobResult = await db.prepare(`
      INSERT INTO opensea_import_jobs 
        (job_type, collection_slug, job_status, started_at)
      VALUES ('collection_transactions', ?, 'running', datetime('now'))
    `).bind(collection_slug).run()
    
    const jobId = jobResult.meta.last_row_id
    
    try {
      // Fetch collection events
      const eventsUrl = `https://api.opensea.io/api/v2/events/collection/${collection_slug}?limit=${Math.min(limit, 300)}`
      const response = await fetch(eventsUrl, { headers })
      
      if (!response.ok) {
        throw new Error('OpenSea Events API ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
      }
      
      const data = await response.json()
      const events = data.asset_events || []
      
      let imported = 0
      let failed = 0
      
      for (const event of events) {
        try {
          const eventType = event.event_type
          const transaction = event.transaction || {}
          const payment = event.payment || {}
          const nft = event.nft || {}
          
          const priceETH = payment.quantity ? parseFloat(payment.quantity) / 1e18 : null
          const priceUSD = payment.usd_price || null
          const priceKRW = priceETH ? Math.round(priceETH * 3000000) : null
          
          // Find artwork_id if exists in our database
          const artwork = await db.prepare(`
            SELECT id FROM artworks
            WHERE nft_contract_address = ? AND nft_token_id = ?
          `).bind(nft.contract, nft.identifier).first()
          
          const artworkId = artwork?.id || null
          
          // Insert transaction record
          await db.prepare(`
            INSERT OR IGNORE INTO opensea_transaction_history (
              opensea_event_id,
              event_type,
              contract_address,
              token_id,
              chain,
              artwork_id,
              transaction_hash,
              block_number,
              block_timestamp,
              seller_address,
              buyer_address,
              from_account,
              to_account,
              price_eth,
              price_usd,
              price_krw,
              payment_token,
              quantity,
              collection_slug,
              collection_name,
              nft_name,
              nft_image_url,
              nft_permalink,
              raw_event_data
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          `).bind(
            event.event_id || `${transaction.hash}_${event.event_type}`,
            eventType,
            nft.contract || null,
            nft.identifier || null,
            event.chain || 'ethereum',
            artworkId,
            transaction.hash || null,
            transaction.block_number || null,
            event.event_timestamp || null,
            event.seller?.address || null,
            event.buyer?.address || null,
            event.from_account?.address || null,
            event.to_account?.address || null,
            priceETH,
            priceUSD,
            priceKRW,
            payment.symbol || 'ETH',
            event.quantity || 1,
            collection_slug,
            event.collection?.name || null,
            nft.name || null,
            nft.image_url || null,
            nft.opensea_url || null,
            JSON.stringify(event)
          ).run()
          
          imported++
          
        } catch (error) {
          console.error('Failed to import event:', error)
          failed++
        }
        
        // Rate limit protection
        await new Promise(resolve => setTimeout(resolve, 100))
      }
      
      // Update job status
      await db.prepare(`
        UPDATE opensea_import_jobs
        SET 
          job_status = 'completed',
          total_events = ?,
          processed_events = ?,
          failed_events = ?,
          imported_transactions = ?,
          completed_at = datetime('now')
        WHERE id = ?
      `).bind(events.length, imported + failed, failed, imported, jobId).run()
      
      return c.json({
        success: true,
        message: `${imported}ê°œì˜ ê±°ë˜ ì´ë ¥ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.`,
        data: {
          job_id: jobId,
          collection_slug: collection_slug,
          total_events: events.length,
          imported: imported,
          failed: failed
        }
      })
      
    } catch (error: any) {
      await db.prepare(`
        UPDATE opensea_import_jobs
        SET 
          job_status = 'failed',
          error_message = ?,
          completed_at = datetime('now')
        WHERE id = ?
      `).bind(error.message, jobId).run()
      
      throw error
    }
    
  } catch (error: any) {
    console.error('Collection transaction import error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// Get transaction history
app.get('/api/admin/opensea/transactions', async (c) => {
  try {
    const db = c.env.DB
    const limit = parseInt(c.req.query('limit') || '50')
    const offset = parseInt(c.req.query('offset') || '0')
    const event_type = c.req.query('event_type')
    const collection_slug = c.req.query('collection_slug')
    
    let query = 'SELECT * FROM v_opensea_transaction_summary WHERE 1=1'
    const bindings: any[] = []
    
    if (event_type) {
      query += ' AND event_type = ?'
      bindings.push(event_type)
    }
    
    if (collection_slug) {
      query += ' AND collection_slug = ?'
      bindings.push(collection_slug)
    }
    
    query += ' ORDER BY block_timestamp DESC LIMIT ? OFFSET ?'
    bindings.push(limit, offset)
    
    const transactions = await db.prepare(query).bind(...bindings).all()
    
    // Get total count
    let countQuery = 'SELECT COUNT(*) as count FROM opensea_transaction_history WHERE 1=1'
    const countBindings: any[] = []
    
    if (event_type) {
      countQuery += ' AND event_type = ?'
      countBindings.push(event_type)
    }
    
    if (collection_slug) {
      countQuery += ' AND collection_slug = ?'
      countBindings.push(collection_slug)
    }
    
    const countResult = await db.prepare(countQuery).bind(...countBindings).first()
    
    return c.json({
      success: true,
      data: transactions.results || [],
      pagination: {
        limit: limit,
        offset: offset,
        total: countResult?.count || 0
      }
    })
    
  } catch (error: any) {
    console.error('Transactions list error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// Get import jobs list
app.get('/api/admin/opensea/import-jobs', async (c) => {
  try {
    const db = c.env.DB
    const limit = parseInt(c.req.query('limit') || '20')
    
    const jobs = await db.prepare(`
      SELECT * FROM opensea_import_jobs
      ORDER BY created_at DESC
      LIMIT ?
    `).bind(limit).all()
    
    return c.json({
      success: true,
      data: jobs.results || [],
      total: jobs.results?.length || 0
    })
    
  } catch (error: any) {
    console.error('Import jobs list error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ë¡œê·¸ì¸ API
app.post('/api/admin/login', async (c) => {
  const { username, password } = await c.req.json()
  
  // SHA-256 í•´ì‹œ ìƒì„± (ê°„ë‹¨í•œ ì˜ˆì‹œ, ì‹¤ì œë¡œëŠ” bcrypt ì‚¬ìš© ê¶Œì¥)
  const encoder = new TextEncoder()
  const data = encoder.encode(password)
  const hashBuffer = await crypto.subtle.digest('SHA-256', data)
  const hashArray = Array.from(new Uint8Array(hashBuffer))
  const passwordHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('')
  
  const db = c.env.DB
  
  // ì‚¬ìš©ì í™•ì¸
  const user = await db.prepare(`
    SELECT * FROM admin_users 
    WHERE username = ? AND password_hash = ? AND is_active = 1
  `).bind(username, passwordHash).first()
  
  if (!user) {
    return c.json({ success: false, message: 'ì‚¬ìš©ìëª… ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' })
  }
  
  // ì„¸ì…˜ í† í° ìƒì„±
  const sessionToken = crypto.randomUUID()
  const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString() // 24ì‹œê°„
  
  // ì„¸ì…˜ ì €ì¥
  await db.prepare(`
    INSERT INTO admin_sessions (session_token, admin_user_id, expires_at)
    VALUES (?, ?, ?)
  `).bind(sessionToken, user.id, expiresAt).run()
  
  // ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê°„ ì—…ë°ì´íŠ¸
  await db.prepare(`
    UPDATE admin_users SET last_login_at = CURRENT_TIMESTAMP WHERE id = ?
  `).bind(user.id).run()
  
  // í™œë™ ë¡œê·¸ ê¸°ë¡
  await db.prepare(`
    INSERT INTO admin_activity_logs (admin_user_id, action, details)
    VALUES (?, 'login', ?)
  `).bind(user.id, JSON.stringify({ username })).run()
  
  return c.json({ 
    success: true, 
    session_token: sessionToken,
    user: {
      id: user.id,
      username: user.username,
      email: user.email,
      full_name: user.full_name,
      role: user.role
    }
  })
})

// ë¡œê·¸ì•„ì›ƒ API
app.post('/api/admin/logout', async (c) => {
  const sessionToken = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!sessionToken) {
    return c.json({ success: false, message: 'ì„¸ì…˜ í† í°ì´ ì—†ìŠµë‹ˆë‹¤.' })
  }
  
  const db = c.env.DB
  
  // ì„¸ì…˜ ì‚­ì œ
  await db.prepare(`
    DELETE FROM admin_sessions WHERE session_token = ?
  `).bind(sessionToken).run()
  
  return c.json({ success: true })
})

// ============================================
// ğŸ” Admin API Security Middleware
// ============================================
async function requireAdminAuth(c: any, next?: any) {
  const token = c.req.header('Authorization')?.replace('Bearer ', '') || getCookie(c, 'auth_token')
  
  if (!token) {
    return c.json({ error: 'Unauthorized', message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  const session = await verifySession(c.env.DB, token)
  if (!session) {
    return c.json({ error: 'Unauthorized', message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
  }
  
  const allowedRoles = ['admin', 'super_admin']
  if (!session.role || !allowedRoles.includes(session.role)) {
    return c.json({ error: 'Forbidden', message: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' }, 403)
  }
  
  // If called as middleware, continue to next handler
  if (next) {
    c.set('adminSession', session) // Store session for later use
    return next()
  }
  
  return null // No error, continue (for manual checks)
}

// ê´€ë¦¬ì í†µê³„ API
app.get('/api/admin/stats', async (c) => {
  // âœ… Admin authentication check
  const authError = await requireAdminAuth(c)
  if (authError) return authError
  
  const db = c.env.DB
  
  const totalArtworks = await db.prepare('SELECT COUNT(*) as count FROM artworks').first()
  const mintedArtworks = await db.prepare('SELECT COUNT(*) as count FROM artworks WHERE is_minted = 1').first()
  const totalArtists = await db.prepare('SELECT COUNT(*) as count FROM artists').first()
  const pendingArtworks = await db.prepare("SELECT COUNT(*) as count FROM artworks WHERE status = 'pending_review'").first()
  
  return c.json({
    success: true,
    data: {
      totalArtworks: totalArtworks?.count || 0,
      mintedCount: mintedArtworks?.count || 0,
      totalArtists: totalArtists?.count || 0,
      pendingCount: pendingArtworks?.count || 0,
      totalVolume: '0'
    }
  })
})

// ì‘í’ˆ ëª©ë¡ ì¡°íšŒ API (ê´€ë¦¬ììš©)
app.get('/api/admin/artworks', async (c) => {
  // âœ… Admin authentication check
  const authError = await requireAdminAuth(c)
  if (authError) return authError
  
  const db = c.env.DB
  
  const artworks = await db.prepare(`
    SELECT 
      a.*,
      ar.name as artist_name
    FROM artworks a
    LEFT JOIN artists ar ON a.artist_id = ar.id
    ORDER BY a.created_at DESC
    LIMIT 50
  `).all()
  
  return c.json({ success: true, data: artworks.results })
})

// ì‘ê°€ ëª©ë¡ ì¡°íšŒ API (ê´€ë¦¬ììš©)
app.get('/api/admin/artists', async (c) => {
  // âœ… Admin authentication check
  const authError = await requireAdminAuth(c)
  if (authError) return authError
  
  const db = c.env.DB
  
  const artists = await db.prepare(`
    SELECT 
      a.*,
      COUNT(aw.id) as artwork_count
    FROM artists a
    LEFT JOIN artworks aw ON a.id = aw.artist_id
    GROUP BY a.id
    ORDER BY a.created_at DESC
  `).all()
  
  return c.json({ success: true, data: artists.results })
})

// ë‹¨ì¼ ì‘í’ˆ ì¡°íšŒ API
app.get('/api/admin/artworks/:id', async (c) => {
  // âœ… Admin authentication check
  const authError = await requireAdminAuth(c)
  if (authError) return authError
  
  const id = c.req.param('id')
  const db = c.env.DB
  
  const artwork = await db.prepare(`
    SELECT a.*, ar.name as artist_name
    FROM artworks a
    LEFT JOIN artists ar ON a.artist_id = ar.id
    WHERE a.id = ?
  `).bind(id).first()
  
  if (!artwork) {
    return c.json({ success: false, message: 'ì‘í’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' })
  }
  
  return c.json({ success: true, data: artwork })
})

// ì‘í’ˆ ì¶”ê°€ API
app.post('/api/admin/artworks', async (c) => {
  // âœ… Admin authentication check
  const authError = await requireAdminAuth(c)
  if (authError) return authError
  
  const data = await c.req.json()
  const db = c.env.DB
  
  try {
    const result = await db.prepare(`
      INSERT INTO artworks (
        artist_id, title, description, category, technique,
        size_width, size_height, creation_year, image_url,
        current_price, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      data.artist_id,
      data.title,
      data.description || '',
      data.category,
      data.technique || '',
      data.size_width || 0,
      data.size_height || 0,
      data.creation_year || new Date().getFullYear(),
      data.image_url,
      data.current_price || 0,
      data.status || 'draft'
    ).run()
    
    // í™œë™ ë¡œê·¸ ê¸°ë¡
    await db.prepare(`
      INSERT INTO admin_activity_logs (admin_user_id, action, entity_type, entity_id, details)
      VALUES (1, 'create_artwork', 'artwork', ?, ?)
    `).bind(result.meta.last_row_id, JSON.stringify({ title: data.title })).run()
    
    // ì•Œë¦¼ ìƒì„±
    await db.prepare(`
      INSERT INTO notifications (type, title, message, related_entity_type, related_entity_id)
      VALUES ('new_artwork', ?, ?, 'artwork', ?)
    `).bind(
      'ìƒˆ ì‘í’ˆ ë“±ë¡',
      `"${data.title}" ì‘í’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`,
      result.meta.last_row_id
    ).run()
    
    return c.json({ success: true, data: { id: result.meta.last_row_id } })
  } catch (error) {
    return c.json({ success: false, message: 'ì‘í’ˆ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' })
  }
})

// ì‘í’ˆ ìˆ˜ì • API
app.put('/api/admin/artworks/:id', async (c) => {
  const id = c.req.param('id')
  const data = await c.req.json()
  const db = c.env.DB
  
  try {
    await db.prepare(`
      UPDATE artworks SET
        artist_id = ?,
        title = ?,
        description = ?,
        category = ?,
        technique = ?,
        size_width = ?,
        size_height = ?,
        creation_year = ?,
        image_url = ?,
        current_price = ?,
        status = ?,
        updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(
      data.artist_id,
      data.title,
      data.description || '',
      data.category,
      data.technique || '',
      data.size_width || 0,
      data.size_height || 0,
      data.creation_year,
      data.image_url,
      data.current_price || 0,
      data.status || 'draft',
      id
    ).run()
    
    return c.json({ success: true })
  } catch (error) {
    return c.json({ success: false, message: 'ì‘í’ˆ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' })
  }
})

// ì‘í’ˆ ì‚­ì œ API
app.delete('/api/admin/artworks/:id', async (c) => {
  const id = c.req.param('id')
  const db = c.env.DB
  
  try {
    await db.prepare('DELETE FROM artworks WHERE id = ?').bind(id).run()
    return c.json({ success: true })
  } catch (error) {
    return c.json({ success: false, message: 'ì‘í’ˆ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' })
  }
})

// ì¼ê´„ ìƒíƒœ ë³€ê²½ API
app.put('/api/admin/artworks/bulk/status', async (c) => {
  const { ids, status } = await c.req.json()
  const db = c.env.DB
  
  if (!ids || ids.length === 0) {
    return c.json({ success: false, message: 'ì„ íƒëœ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.' })
  }
  
  try {
    for (const id of ids) {
      await db.prepare(`
        UPDATE artworks SET status = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?
      `).bind(status, id).run()
    }
    
    return c.json({ success: true, updated: ids.length })
  } catch (error) {
    return c.json({ success: false, message: 'ì¼ê´„ ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' })
  }
})

// ì¼ê´„ ì‚­ì œ API
app.delete('/api/admin/artworks/bulk/delete', async (c) => {
  const { ids } = await c.req.json()
  const db = c.env.DB
  
  if (!ids || ids.length === 0) {
    return c.json({ success: false, message: 'ì„ íƒëœ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.' })
  }
  
  try {
    for (const id of ids) {
      await db.prepare('DELETE FROM artworks WHERE id = ?').bind(id).run()
    }
    
    return c.json({ success: true, deleted: ids.length })
  } catch (error) {
    return c.json({ success: false, message: 'ì¼ê´„ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' })
  }
})

// ë‹¨ì¼ ì‘ê°€ ì¡°íšŒ API
app.get('/api/admin/artists/:id', async (c) => {
  const id = c.req.param('id')
  const db = c.env.DB
  
  const artist = await db.prepare('SELECT * FROM artists WHERE id = ?').bind(id).first()
  
  if (!artist) {
    return c.json({ success: false, message: 'ì‘ê°€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' })
  }
  
  return c.json({ success: true, data: artist })
})

// ì‘ê°€ ì¶”ê°€ API
app.post('/api/admin/artists', async (c) => {
  const data = await c.req.json()
  const db = c.env.DB
  
  try {
    const result = await db.prepare(`
      INSERT INTO artists (
        name, email, bio, career_years, education,
        solo_exhibitions_count, group_exhibitions_count,
        competition_awards_count, wallet_address
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      data.name,
      data.email,
      data.bio || '',
      data.career_years || 0,
      data.education || '',
      data.solo_exhibitions_count || 0,
      data.group_exhibitions_count || 0,
      data.competition_awards_count || 0,
      data.wallet_address || ''
    ).run()
    
    return c.json({ success: true, data: { id: result.meta.last_row_id } })
  } catch (error) {
    return c.json({ success: false, message: 'ì‘ê°€ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' })
  }
})

// ì‘ê°€ ìˆ˜ì • API
app.put('/api/admin/artists/:id', async (c) => {
  const id = c.req.param('id')
  const data = await c.req.json()
  const db = c.env.DB
  
  try {
    await db.prepare(`
      UPDATE artists SET
        name = ?,
        email = ?,
        bio = ?,
        career_years = ?,
        education = ?,
        solo_exhibitions_count = ?,
        group_exhibitions_count = ?,
        competition_awards_count = ?,
        wallet_address = ?,
        updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(
      data.name,
      data.email,
      data.bio || '',
      data.career_years || 0,
      data.education || '',
      data.solo_exhibitions_count || 0,
      data.group_exhibitions_count || 0,
      data.competition_awards_count || 0,
      data.wallet_address || '',
      id
    ).run()
    
    return c.json({ success: true })
  } catch (error) {
    return c.json({ success: false, message: 'ì‘ê°€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' })
  }
})

// ì‘ê°€ ì‚­ì œ API
app.delete('/api/admin/artists/:id', async (c) => {
  const id = c.req.param('id')
  const db = c.env.DB
  
  try {
    // ê´€ë ¨ ì‘í’ˆë„ í•¨ê»˜ ì‚­ì œ
    await db.prepare('DELETE FROM artworks WHERE artist_id = ?').bind(id).run()
    await db.prepare('DELETE FROM artists WHERE id = ?').bind(id).run()
    return c.json({ success: true })
  } catch (error) {
    return c.json({ success: false, message: 'ì‘ê°€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' })
  }
})

// í‰ê°€ ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ API
app.get('/api/admin/valuations/pending', async (c) => {
  const db = c.env.DB
  
  const artworks = await db.prepare(`
    SELECT 
      a.*,
      ar.name as artist_name
    FROM artworks a
    LEFT JOIN artists ar ON a.artist_id = ar.id
    WHERE a.status = 'pending_review'
    ORDER BY a.created_at DESC
  `).all()
  
  return c.json({ success: true, data: artworks.results })
})

// í‰ê°€ ìŠ¹ì¸ API
app.post('/api/admin/artworks/:id/approve', async (c) => {
  const id = c.req.param('id')
  const db = c.env.DB
  
  try {
    // ì‘í’ˆ ì •ë³´ ì¡°íšŒ
    const artwork = await db.prepare('SELECT title FROM artworks WHERE id = ?').bind(id).first()
    
    await db.prepare(`
      UPDATE artworks SET status = 'approved', updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(id).run()
    
    // ì•Œë¦¼ ìƒì„±
    await db.prepare(`
      INSERT INTO notifications (type, title, message, related_entity_type, related_entity_id)
      VALUES ('approved', ?, ?, 'artwork', ?)
    `).bind(
      'ì‘í’ˆ í‰ê°€ ìŠ¹ì¸',
      `"${artwork?.title || 'ì‘í’ˆ'}" í‰ê°€ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`,
      id
    ).run()
    
    return c.json({ success: true })
  } catch (error) {
    return c.json({ success: false, message: 'í‰ê°€ ìŠ¹ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' })
  }
})

// í‰ê°€ ë°˜ë ¤ API
app.post('/api/admin/artworks/:id/reject', async (c) => {
  const id = c.req.param('id')
  const { reason } = await c.req.json()
  const db = c.env.DB
  
  try {
    await db.prepare(`
      UPDATE artworks SET status = 'draft', updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(id).run()
    
    // ë°˜ë ¤ ì‚¬ìœ ë¥¼ í‰ê°€ ì´ë ¥ì— ê¸°ë¡
    await db.prepare(`
      INSERT INTO valuation_history (artwork_id, evaluator_name, evaluator_role, evaluation_notes)
      VALUES (?, 'Admin', 'system', ?)
    `).bind(id, `ë°˜ë ¤: ${reason}`).run()
    
    return c.json({ success: true })
  } catch (error) {
    return c.json({ success: false, message: 'í‰ê°€ ë°˜ë ¤ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' })
  }
})

// ì°¨íŠ¸ ë°ì´í„° API
app.get('/api/admin/charts', async (c) => {
  const db = c.env.DB
  
  try {
    // ì›”ë³„ ì‘í’ˆ ë“±ë¡ ì¶”ì´ (ìµœê·¼ 6ê°œì›”)
    const monthlyData = await db.prepare(`
      SELECT strftime('%Y-%m', created_at) as month, COUNT(*) as count
      FROM artworks
      WHERE created_at >= date('now', '-6 months')
      GROUP BY month
      ORDER BY month
    `).all()
    
    // ì¹´í…Œê³ ë¦¬ë³„ ë¶„í¬
    const categoryData = await db.prepare(`
      SELECT category, COUNT(*) as count
      FROM artworks
      GROUP BY category
    `).all()
    
    // ê°€ê²©ëŒ€ë³„ ë¶„í¬
    const priceData = await db.prepare(`
      SELECT 
        CASE
          WHEN current_price < 1000000 THEN '~100ë§Œì›'
          WHEN current_price < 5000000 THEN '100~500ë§Œì›'
          WHEN current_price < 10000000 THEN '500~1000ë§Œì›'
          WHEN current_price < 50000000 THEN '1000~5000ë§Œì›'
          ELSE '5000ë§Œì›~'
        END as price_range,
        COUNT(*) as count
      FROM artworks
      WHERE current_price > 0
      GROUP BY price_range
    `).all()
    
    // ìƒíƒœë³„ í˜„í™©
    const statusData = await db.prepare(`
      SELECT status, COUNT(*) as count
      FROM artworks
      GROUP BY status
    `).all()
    
    // í•œêµ­ì–´ ìƒíƒœëª… ë§¤í•‘
    const statusMap = {
      'draft': 'ì´ˆì•ˆ',
      'pending_review': 'ê²€í†  ì¤‘',
      'approved': 'ìŠ¹ì¸ë¨',
      'minted': 'ë¯¼íŒ…ë¨',
      'sold': 'íŒë§¤ë¨'
    }
    
    return c.json({
      success: true,
      data: {
        monthly: {
          labels: monthlyData.results.map(r => r.month),
          values: monthlyData.results.map(r => r.count)
        },
        category: {
          labels: categoryData.results.map(r => r.category),
          values: categoryData.results.map(r => r.count)
        },
        price: {
          labels: priceData.results.map(r => r.price_range),
          values: priceData.results.map(r => r.count)
        },
        status: {
          labels: statusData.results.map(r => statusMap[r.status] || r.status),
          values: statusData.results.map(r => r.count)
        }
      }
    })
  } catch (error) {
    return c.json({
      success: true,
      data: {
        monthly: { labels: [], values: [] },
        category: { labels: [], values: [] },
        price: { labels: [], values: [] },
        status: { labels: [], values: [] }
      }
    })
  }
})

// ì´ë¯¸ì§€ ì—…ë¡œë“œ API (R2)
app.post('/api/admin/upload/image', async (c) => {
  try {
    const formData = await c.req.formData()
    const file = formData.get('file') as File
    
    if (!file) {
      return c.json({ success: false, message: 'íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.' })
    }
    
    // íŒŒì¼ í™•ì¥ì ì¶”ì¶œ
    const fileName = file.name
    const fileExt = fileName.split('.').pop()
    const uniqueName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`
    
    // R2ì— ì—…ë¡œë“œ (ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œëŠ” ì‹œë®¬ë ˆì´ì…˜)
    // ì‹¤ì œ ë°°í¬ ì‹œì—ëŠ” c.env.R2ë¥¼ ì‚¬ìš©
    const imageUrl = `https://gallerypia-images.r2.cloudflarestorage.com/${uniqueName}`
    
    // ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œëŠ” base64ë¡œ ë³€í™˜í•˜ì—¬ ë°˜í™˜
    const arrayBuffer = await file.arrayBuffer()
    const base64 = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)))
    const dataUrl = `data:${file.type};base64,${base64}`
    
    return c.json({ 
      success: true, 
      url: dataUrl, // ë¡œì»¬ì—ì„œëŠ” data URL ì‚¬ìš©
      filename: uniqueName
    })
  } catch (error) {
    console.error('Upload error:', error)
    return c.json({ success: false, message: 'ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' })
  }
})

// ì•Œë¦¼ ì¡°íšŒ API
app.get('/api/admin/notifications', async (c) => {
  const db = c.env.DB
  
  const notifications = await db.prepare(`
    SELECT * FROM notifications
    ORDER BY created_at DESC
    LIMIT 50
  `).all()
  
  return c.json({ success: true, data: notifications.results || [] })
})

// ì•Œë¦¼ ì½ìŒ í‘œì‹œ API
app.put('/api/admin/notifications/:id/read', async (c) => {
  const id = c.req.param('id')
  const db = c.env.DB
  
  await db.prepare(`
    UPDATE notifications SET is_read = 1 WHERE id = ?
  `).bind(id).run()
  
  return c.json({ success: true })
})

// ëª¨ë“  ì•Œë¦¼ ì½ìŒ í‘œì‹œ API
app.put('/api/admin/notifications/read-all', async (c) => {
  const db = c.env.DB
  
  await db.prepare(`
    UPDATE notifications SET is_read = 1
  `).run()
  
  return c.json({ success: true })
})

// í™œë™ ë¡œê·¸ ì¡°íšŒ API
app.get('/api/admin/logs', async (c) => {
  const db = c.env.DB
  const action = c.req.query('action')
  
  let query = `
    SELECT 
      l.*,
      u.username as admin_username
    FROM admin_activity_logs l
    LEFT JOIN admin_users u ON l.admin_user_id = u.id
  `
  
  if (action) {
    query += ` WHERE l.action = '${action}'`
  }
  
  query += ` ORDER BY l.created_at DESC LIMIT 100`
  
  const logs = await db.prepare(query).all()
  
  return c.json({ success: true, data: logs.results })
})

// OpenSea ì‘í’ˆ ì¡°íšŒ API (ì„ íƒìš©) - ì‹¤ì œ OpenSea API v2 í˜¸ì¶œ
app.post('/api/admin/opensea/fetch', async (c) => {
  const { slug, limit = 100, apiKey } = await c.req.json()
  
  if (!slug) {
    return c.json({ 
      success: false, 
      message: 'OpenSea ì»¬ë ‰ì…˜ ìŠ¬ëŸ¬ê·¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.' 
    })
  }
  
  try {
    // API í‚¤ê°€ ì—†ìœ¼ë©´ ë°ëª¨ ë°ì´í„° ìƒì„±
    if (!apiKey || !apiKey.trim()) {
      console.log('API í‚¤ ì—†ìŒ - ë°ëª¨ ë°ì´í„° ìƒì„±:', slug)
      
      const requestLimit = Math.min(limit, 100)
      const artworks = []
      
      for (let i = 0; i < requestLimit; i++) {
        artworks.push({
          name: `${slug} #${i + 1}`,
          description: `NFT artwork from ${slug} collection (Demo Data)`,
          collection: slug,
          image_url: `https://picsum.photos/seed/${slug}${i}/400/400`,
          token_id: `${i + 1}`,
          contract_address: '0x' + Math.random().toString(16).substring(2, 42),
          metadata: {
            opensea_url: `https://opensea.io/collection/${slug}`,
            attributes: []
          }
        })
      }
      
      return c.json({ 
        success: true, 
        artworks,
        total: artworks.length,
        message: `${artworks.length}ê°œì˜ ë°ëª¨ ì‘í’ˆì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤. (ì‹¤ì œ OpenSea ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ë ¤ë©´ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”)`,
        isDemo: true
      })
    }
    
    // OpenSea API v2 í—¤ë” ì„¤ì •
    const headers: any = {
      'Accept': 'application/json',
      'Content-Type': 'application/json',
      'X-API-KEY': apiKey.trim()
    }
    
    // OpenSea API v2 í˜¸ì¶œ (ìµœëŒ€ 200ê°œê¹Œì§€ ì¡°íšŒ ê°€ëŠ¥)
    const requestLimit = Math.min(limit, 200)
    const apiUrl = `https://api.opensea.io/api/v2/collection/${slug}/nfts?limit=${requestLimit}`
    
    console.log('OpenSea API í˜¸ì¶œ:', apiUrl)
    
    const response = await fetch(apiUrl, {
      method: 'GET',
      headers: headers
    })
    
    if (!response.ok) {
      const errorText = await response.text()
      console.error('OpenSea API ì—ëŸ¬:', response.status, errorText)
      
      // API í‚¤ê°€ ì˜ëª»ëœ ê²½ìš° - ë°ëª¨ ë°ì´í„°ë¡œ fallback
      if (response.status === 401 || response.status === 403) {
        console.log('API ì¸ì¦ ì‹¤íŒ¨ - ë°ëª¨ ë°ì´í„°ë¡œ fallback')
        
        const requestLimit = Math.min(limit, 100)
        const artworks = []
        
        for (let i = 0; i < requestLimit; i++) {
          artworks.push({
            name: `${slug} #${i + 1}`,
            description: `NFT artwork from ${slug} collection (Demo Data - Invalid API Key)`,
            collection: slug,
            image_url: `https://picsum.photos/seed/${slug}${i}/400/400`,
            token_id: `${i + 1}`,
            contract_address: '0x' + Math.random().toString(16).substring(2, 42),
            metadata: {
              opensea_url: `https://opensea.io/collection/${slug}`,
              attributes: []
            }
          })
        }
        
        return c.json({ 
          success: true, 
          artworks,
          total: artworks.length,
          message: `OpenSea API ì¸ì¦ ì‹¤íŒ¨ - ${artworks.length}ê°œì˜ ë°ëª¨ ì‘í’ˆì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤. ìœ íš¨í•œ API í‚¤ë¥¼ ì…ë ¥í•˜ë©´ ì‹¤ì œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
          isDemo: true,
          authError: true
        })
      }
      
      return c.json({ 
        success: false, 
        message: `OpenSea API ì˜¤ë¥˜ (${response.status}): ${errorText}` 
      })
    }
    
    const data = await response.json()
    
    // OpenSea API ì‘ë‹µ íŒŒì‹±
    if (!data.nfts || !Array.isArray(data.nfts)) {
      return c.json({ 
        success: false, 
        message: 'OpenSea API ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' 
      })
    }
    
    // ìš°ë¦¬ ì‹œìŠ¤í…œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    const artworks = data.nfts.map((nft: any) => ({
      name: nft.name || `${slug} #${nft.identifier}`,
      description: nft.description || `NFT from ${slug} collection`,
      collection: slug,
      image_url: nft.image_url || nft.display_image_url || 'https://via.placeholder.com/400?text=No+Image',
      token_id: nft.identifier,
      contract_address: nft.contract || null,
      metadata: {
        opensea_url: `https://opensea.io/assets/ethereum/${nft.contract}/${nft.identifier}`,
        attributes: nft.traits || []
      }
    }))
    
    return c.json({ 
      success: true, 
      artworks,
      total: artworks.length,
      message: `${artworks.length}ê°œì˜ ì‹¤ì œ OpenSea ì‘í’ˆì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`,
      isDemo: false
    })
    
  } catch (error: any) {
    console.error('OpenSea fetch error:', error)
    return c.json({ 
      success: false, 
      message: 'OpenSea ì‘í’ˆ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message 
    })
  }
})

// OpenSea ì„ íƒí•œ ì‘í’ˆ import API
app.post('/api/admin/import/opensea', async (c) => {
  const { artworks } = await c.req.json()
  const db = c.env.DB
  
  if (!artworks || !Array.isArray(artworks) || artworks.length === 0) {
    return c.json({ success: false, message: 'ê°€ì ¸ì˜¬ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.' })
  }
  
  try {
    // ê¸°ë³¸ ì‘ê°€ ì°¾ê¸° ë˜ëŠ” ìƒì„±
    const collectionName = artworks[0]?.collection || 'OpenSea Collection'
    let artist = await db.prepare(`
      SELECT id FROM artists WHERE name = ?
    `).bind(collectionName).first()
    
    if (!artist) {
      const result = await db.prepare(`
        INSERT INTO artists (name, email, bio, profile_image)
        VALUES (?, ?, ?, ?)
      `).bind(
        collectionName,
        `${collectionName.toLowerCase().replace(/\s+/g, '')}@opensea.io`,
        `Imported from OpenSea collection: ${collectionName}`,
        artworks[0]?.image_url || null
      ).run()
      artist = { id: result.meta.last_row_id }
    }
    
    // ì„ íƒí•œ ì‘í’ˆë“¤ import
    let imported = 0
    for (const artwork of artworks) {
      try {
        // ì¤‘ë³µ ì²´í¬ (token_id ê¸°ì¤€)
        const existing = await db.prepare(`
          SELECT id FROM artworks WHERE nft_token_id = ?
        `).bind(artwork.token_id).first()
        
        if (existing) {
          continue // ì´ë¯¸ ì¡´ì¬í•˜ë©´ ìŠ¤í‚µ
        }
        
        await db.prepare(`
          INSERT INTO artworks (
            artist_id, title, description, category, image_url,
            current_price, status, is_minted, 
            nft_token_id, nft_contract_address, blockchain_network
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(
          artist.id,
          artwork.name,
          artwork.description || `NFT from ${collectionName}`,
          'ë””ì§€í„¸ì•„íŠ¸',
          artwork.image_url,
          Math.floor(Math.random() * 5000000) + 500000, // 50ë§Œì› ~ 500ë§Œì›
          'approved',
          1, // is_minted
          artwork.token_id,
          artwork.contract_address || null,
          'Ethereum'
        ).run()
        
        imported++
      } catch (itemError) {
        console.error('Failed to import artwork:', artwork.name, itemError)
        // ê°œë³„ ì‘í’ˆ ì‹¤íŒ¨ëŠ” ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
      }
    }
    
    return c.json({ 
      success: true, 
      imported,
      total: artworks.length,
      message: `${imported}ê°œ ì‘í’ˆì„ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.`
    })
  } catch (error: any) {
    console.error('OpenSea import error:', error)
    return c.json({ 
      success: false, 
      message: 'OpenSea ê°€ì ¸ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message 
    })
  }
})

// ============================================
// ê°€ì¹˜ì‚°ì • ì•Œê³ ë¦¬ì¦˜ API (ë…¼ë¬¸ ê¸°ë°˜)
// ============================================

// ëª¨ë“ˆ1: ì‘ê°€ ì—…ì  í‰ê°€ ì ìˆ˜ ê³„ì‚°
app.post('/api/valuation/calculate-artist-achievement/:artistId', async (c) => {
  const artistId = c.req.param('artistId')
  const db = c.env.DB
  
  try {
    // ì „ì‹œ ì´ë ¥ ì ìˆ˜ ê³„ì‚°: âˆ‘(ì „ì‹œì ìˆ˜ Ã— ê¶Œìœ„ë„ê°€ì¤‘ì¹˜ Ã— ìµœì‹ ì„±ê³„ìˆ˜)
    const exhibitions = await db.prepare(`
      SELECT 
        exhibition_type,
        authority_level,
        recency_coefficient,
        exhibition_score
      FROM artist_exhibitions
      WHERE artist_id = ?
    `).bind(artistId).all()
    
    let exhibitionScore = 0
    exhibitions.results.forEach((ex: any) => {
      const baseScore = ex.exhibition_type === 'solo' ? 20 : 10 // ê°œì¸ì „ 20ì , ë‹¨ì²´ì „ 10ì 
      const authorityWeight = ex.authority_level / 5 // ê¶Œìœ„ë„ ì •ê·œí™” (0.2 ~ 1.0)
      const recencyCoeff = ex.recency_coefficient || 1.0
      exhibitionScore += baseScore * authorityWeight * recencyCoeff
    })
    
    // ìˆ˜ìƒ ì´ë ¥ ì ìˆ˜ ê³„ì‚°
    const awards = await db.prepare(`
      SELECT 
        award_rank,
        authority_level,
        recency_coefficient
      FROM artist_awards
      WHERE artist_id = ?
    `).bind(artistId).all()
    
    let awardScore = 0
    awards.results.forEach((award: any) => {
      let baseScore = 10
      if (award.award_rank === 'ëŒ€ìƒ') baseScore = 30
      else if (award.award_rank === 'ê¸ˆìƒ') baseScore = 25
      else if (award.award_rank === 'ì€ìƒ') baseScore = 20
      else if (award.award_rank === 'ë™ìƒ') baseScore = 15
      
      const authorityWeight = award.authority_level / 5
      const recencyCoeff = award.recency_coefficient || 1.0
      awardScore += baseScore * authorityWeight * recencyCoeff
    })
    
    // ìµœì¢… ì ìˆ˜ ì •ê·œí™” (0~100)
    const totalScore = Math.min(100, (exhibitionScore + awardScore) / 2)
    
    // ì‘ê°€ ì—…ì  ì ìˆ˜ ì—…ë°ì´íŠ¸
    await db.prepare(`
      UPDATE artists 
      SET artist_achievement_score = ?,
          total_exhibitions = ?,
          solo_exhibitions = ?,
          group_exhibitions = ?,
          total_awards = ?
      WHERE id = ?
    `).bind(
      totalScore,
      exhibitions.results.length,
      exhibitions.results.filter((ex: any) => ex.exhibition_type === 'solo').length,
      exhibitions.results.filter((ex: any) => ex.exhibition_type === 'group').length,
      awards.results.length,
      artistId
    ).run()
    
    return c.json({ 
      success: true, 
      score: totalScore,
      details: {
        exhibitionScore,
        awardScore,
        totalExhibitions: exhibitions.results.length,
        totalAwards: awards.results.length
      }
    })
  } catch (error) {
    return c.json({ success: false, message: 'ì‘ê°€ ì—…ì  ì ìˆ˜ ê³„ì‚° ì‹¤íŒ¨' })
  }
})

// ëª¨ë“ˆ2: ì‘í’ˆ ë‚´ìš© í‰ê°€ ì ìˆ˜ ê³„ì‚°
app.post('/api/valuation/calculate-artwork-content/:artworkId', async (c) => {
  const artworkId = c.req.param('artworkId')
  const body = await c.req.json()
  const db = c.env.DB
  
  try {
    const {
      content_depth_score = 0,
      content_comment = '',
      expression_score = 0,
      expression_comment = '',
      originality_score = 0,
      originality_comment = '',
      collection_value_score = 0,
      collection_value_comment = ''
    } = body
    
    // 4ê°€ì§€ í•­ëª© í•©ì‚° (ê° 0~25ì )
    const finalScore = content_depth_score + expression_score + originality_score + collection_value_score
    
    // ì‘í’ˆ ë‚´ìš© í‰ê°€ ì €ì¥/ì—…ë°ì´íŠ¸
    await db.prepare(`
      INSERT INTO artwork_content_evaluation (
        artwork_id,
        content_depth_score, content_comment,
        expression_score, expression_comment,
        originality_score, originality_comment,
        collection_value_score, collection_value_comment,
        artwork_content_final_score,
        evaluated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
      ON CONFLICT(artwork_id) DO UPDATE SET
        content_depth_score = excluded.content_depth_score,
        content_comment = excluded.content_comment,
        expression_score = excluded.expression_score,
        expression_comment = excluded.expression_comment,
        originality_score = excluded.originality_score,
        originality_comment = excluded.originality_comment,
        collection_value_score = excluded.collection_value_score,
        collection_value_comment = excluded.collection_value_comment,
        artwork_content_final_score = excluded.artwork_content_final_score,
        updated_at = CURRENT_TIMESTAMP
    `).bind(
      artworkId,
      content_depth_score, content_comment,
      expression_score, expression_comment,
      originality_score, originality_comment,
      collection_value_score, collection_value_comment,
      finalScore
    ).run()
    
    return c.json({ success: true, score: finalScore })
  } catch (error) {
    return c.json({ success: false, message: 'ì‘í’ˆ ë‚´ìš© í‰ê°€ ì €ì¥ ì‹¤íŒ¨' })
  }
})

// ëª¨ë“ˆ3: ì €ì‘ê¶Œ ì¸ì¦ ì ìˆ˜ ê³„ì‚°
app.post('/api/valuation/calculate-certification/:artworkId', async (c) => {
  const artworkId = c.req.param('artworkId')
  const body = await c.req.json()
  const db = c.env.DB
  
  try {
    const {
      blockchain_hash = '',
      blockchain_network = '',
      copyright_registered = false,
      copyright_registration_number = '',
      license_type = 'exclusive'
    } = body
    
    // ì¸ì¦ ì ìˆ˜ ê³„ì‚°
    let certScore = 0
    if (blockchain_hash) certScore += 40 // ë¸”ë¡ì²´ì¸ í•´ì‹œ ì¡´ì¬
    if (copyright_registered && copyright_registration_number) certScore += 40 // ì €ì‘ê¶Œ ë“±ë¡
    if (license_type) certScore += 20 // ë¼ì´ì„ ìŠ¤ ëª…ì‹œ
    
    // ì €ì‘ê¶Œ ì¸ì¦ ì •ë³´ ì €ì¥/ì—…ë°ì´íŠ¸
    await db.prepare(`
      INSERT INTO artwork_certification (
        artwork_id,
        blockchain_hash, blockchain_network,
        copyright_registered, copyright_registration_number,
        license_type,
        certification_score,
        created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
      ON CONFLICT(artwork_id) DO UPDATE SET
        blockchain_hash = excluded.blockchain_hash,
        blockchain_network = excluded.blockchain_network,
        copyright_registered = excluded.copyright_registered,
        copyright_registration_number = excluded.copyright_registration_number,
        license_type = excluded.license_type,
        certification_score = excluded.certification_score,
        updated_at = CURRENT_TIMESTAMP
    `).bind(
      artworkId,
      blockchain_hash, blockchain_network,
      copyright_registered, copyright_registration_number,
      license_type,
      certScore
    ).run()
    
    return c.json({ success: true, score: certScore })
  } catch (error) {
    return c.json({ success: false, message: 'ì €ì‘ê¶Œ ì¸ì¦ ì •ë³´ ì €ì¥ ì‹¤íŒ¨' })
  }
})

// ëª¨ë“ˆ4: ì „ë¬¸ê°€ í‰ê°€ ì¶”ê°€
app.post('/api/valuation/add-expert-evaluation/:artworkId', async (c) => {
  const artworkId = c.req.param('artworkId')
  const body = await c.req.json()
  const db = c.env.DB
  
  try {
    const {
      expert_name,
      expert_level, // 'curator', 'director', 'critic', 'graduate'
      expert_institution = '',
      technique_mastery_score = 0,
      art_historical_significance_score = 0,
      marketability_score = 0,
      development_potential_score = 0,
      evaluation_comment = ''
    } = body
    
    // ì „ë¬¸ê°€ ë“±ê¸‰ë³„ ê°€ì¤‘ì¹˜
    const expertWeights: { [key: string]: number } = {
      'curator': 1.5,
      'director': 1.3,
      'critic': 1.2,
      'graduate': 1.0
    }
    const expertWeight = expertWeights[expert_level] || 1.0
    
    // ì¢…í•© ì ìˆ˜ ê³„ì‚°
    const overallScore = technique_mastery_score + art_historical_significance_score + 
                         marketability_score + development_potential_score
    
    // ì „ë¬¸ê°€ í‰ê°€ ì¶”ê°€
    await db.prepare(`
      INSERT INTO expert_evaluations (
        artwork_id, expert_name, expert_level, expert_institution, expert_weight,
        technique_mastery_score, art_historical_significance_score,
        marketability_score, development_potential_score,
        overall_score, evaluation_comment, evaluated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
    `).bind(
      artworkId, expert_name, expert_level, expert_institution, expertWeight,
      technique_mastery_score, art_historical_significance_score,
      marketability_score, development_potential_score,
      overallScore, evaluation_comment
    ).run()
    
    return c.json({ success: true, score: overallScore })
  } catch (error) {
    return c.json({ success: false, message: 'ì „ë¬¸ê°€ í‰ê°€ ì¶”ê°€ ì‹¤íŒ¨' })
  }
})

// ëª¨ë“ˆ4: ì „ë¬¸ê°€ í‰ê°€ ê°€ì¤‘ í‰ê·  ê³„ì‚°
app.get('/api/valuation/calculate-expert-average/:artworkId', async (c) => {
  const artworkId = c.req.param('artworkId')
  const db = c.env.DB
  
  try {
    const evaluations = await db.prepare(`
      SELECT overall_score, expert_weight
      FROM expert_evaluations
      WHERE artwork_id = ?
    `).bind(artworkId).all()
    
    if (evaluations.results.length === 0) {
      return c.json({ success: true, score: 0, count: 0 })
    }
    
    // ê°€ì¤‘ í‰ê·  ê³„ì‚°
    let weightedSum = 0
    let totalWeight = 0
    
    evaluations.results.forEach((ev: any) => {
      weightedSum += ev.overall_score * ev.expert_weight
      totalWeight += ev.expert_weight
    })
    
    const averageScore = totalWeight > 0 ? weightedSum / totalWeight : 0
    
    return c.json({ 
      success: true, 
      score: averageScore,
      count: evaluations.results.length 
    })
  } catch (error) {
    return c.json({ success: false, message: 'ì „ë¬¸ê°€ í‰ê°€ í‰ê·  ê³„ì‚° ì‹¤íŒ¨' })
  }
})

// ì „ë¬¸ê°€ í‰ê°€ ë³´ìƒê¸ˆ ì§€ê¸‰ API
app.post('/api/expert/pay-reward/:evaluationId', async (c) => {
  const evaluationId = c.req.param('evaluationId')
  const { reward_eth, tx_hash, expert_id } = await c.req.json()
  const db = c.env.DB
  
  try {
    // í‰ê°€ ì •ë³´ ì—…ë°ì´íŠ¸
    await db.prepare(`
      UPDATE expert_evaluations 
      SET reward_eth = ?,
          reward_status = 'paid',
          reward_tx_hash = ?,
          reward_paid_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(reward_eth, tx_hash, evaluationId).run()
    
    // ë³´ìƒ ì´ë ¥ ê¸°ë¡
    const evaluation = await db.prepare(`
      SELECT artwork_id FROM expert_evaluations WHERE id = ?
    `).bind(evaluationId).first()
    
    await db.prepare(`
      INSERT INTO expert_rewards_history (
        expert_id, evaluation_id, artwork_id, reward_eth, tx_hash, status
      ) VALUES (?, ?, ?, ?, ?, 'completed')
    `).bind(expert_id, evaluationId, evaluation?.artwork_id, reward_eth, tx_hash).run()
    
    return c.json({ 
      success: true, 
      message: `${reward_eth} ETH ë³´ìƒì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.`,
      tx_hash 
    })
  } catch (error: any) {
    return c.json({ success: false, message: 'ë³´ìƒê¸ˆ ì§€ê¸‰ ì‹¤íŒ¨: ' + error.message })
  }
})

// ì „ë¬¸ê°€ ë³´ìƒê¸ˆ ë‚´ì—­ ì¡°íšŒ API
app.get('/api/expert/rewards/:expertId', async (c) => {
  const expertId = c.req.param('expertId')
  const db = c.env.DB
  
  try {
    const rewards = await db.prepare(`
      SELECT 
        rh.*,
        a.title as artwork_title,
        a.image_url as artwork_image
      FROM expert_rewards_history rh
      LEFT JOIN artworks a ON rh.artwork_id = a.id
      WHERE rh.expert_id = ?
      ORDER BY rh.paid_at DESC
    `).bind(expertId).all()
    
    // ì´ ë³´ìƒê¸ˆ ê³„ì‚°
    const totalRewards = await db.prepare(`
      SELECT SUM(reward_eth) as total FROM expert_rewards_history WHERE expert_id = ?
    `).bind(expertId).first()
    
    return c.json({ 
      success: true, 
      rewards: rewards.results,
      total_eth: totalRewards?.total || 0
    })
  } catch (error: any) {
    return c.json({ success: false, message: 'ë³´ìƒ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message })
  }
})

// ========== Museum/Gallery APIs ==========

// ì „ì‹œ ëª©ë¡ ì¡°íšŒ (ë®¤ì§€ì—„/ê°¤ëŸ¬ë¦¬)
app.get('/api/exhibitions', async (c) => {
  const db = c.env.DB
  const organizerId = c.req.query('organizer_id')
  const status = c.req.query('status')
  
  try {
    let query = `
      SELECT e.*, u.organization_name, u.username,
             (SELECT COUNT(*) FROM exhibition_artworks WHERE exhibition_id = e.id) as artwork_count
      FROM exhibitions e
      LEFT JOIN users u ON e.organizer_id = u.id
      WHERE 1=1
    `
    const params: any[] = []
    
    if (organizerId) {
      query += ` AND e.organizer_id = ?`
      params.push(organizerId)
    }
    
    if (status) {
      query += ` AND e.status = ?`
      params.push(status)
    }
    
    query += ` ORDER BY e.created_at DESC`
    
    const exhibitions = await db.prepare(query).bind(...params).all()
    
    return c.json({ success: true, exhibitions: exhibitions.results })
  } catch (error: any) {
    return c.json({ success: false, message: 'ì „ì‹œ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message })
  }
})

// ì „ì‹œ ìƒì„¸ ì¡°íšŒ
app.get('/api/exhibitions/:id', async (c) => {
  const db = c.env.DB
  const exhibitionId = c.req.param('id')
  
  try {
    const exhibition = await db.prepare(`
      SELECT e.*, u.organization_name, u.username, u.organization_description
      FROM exhibitions e
      LEFT JOIN users u ON e.organizer_id = u.id
      WHERE e.id = ?
    `).bind(exhibitionId).first()
    
    if (!exhibition) {
      return c.json({ success: false, message: 'ì „ì‹œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' })
    }
    
    // ì „ì‹œ ì‘í’ˆ ëª©ë¡
    const artworks = await db.prepare(`
      SELECT ea.*, a.title, a.image_url, a.artist_id, ar.name as artist_name
      FROM exhibition_artworks ea
      LEFT JOIN artworks a ON ea.artwork_id = a.id
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE ea.exhibition_id = ?
      ORDER BY ea.display_order, ea.added_at
    `).bind(exhibitionId).all()
    
    return c.json({ 
      success: true, 
      exhibition,
      artworks: artworks.results
    })
  } catch (error: any) {
    return c.json({ success: false, message: 'ì „ì‹œ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message })
  }
})

// ì „ì‹œ ìƒì„±
app.post('/api/exhibitions', async (c) => {
  const db = c.env.DB
  const { organizer_id, title, description, theme, start_date, end_date, location, venue_type, max_artworks } = await c.req.json()
  
  try {
    const result = await db.prepare(`
      INSERT INTO exhibitions (
        organizer_id, title, description, theme, start_date, end_date, 
        location, venue_type, max_artworks, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'planning')
    `).bind(organizer_id, title, description, theme, start_date, end_date, location, venue_type || 'physical', max_artworks || 50).run()
    
    return c.json({ success: true, exhibition_id: result.meta.last_row_id })
  } catch (error: any) {
    return c.json({ success: false, message: 'ì „ì‹œ ìƒì„± ì‹¤íŒ¨: ' + error.message })
  }
})

// ì „ì‹œ ìˆ˜ì •
app.put('/api/exhibitions/:id', async (c) => {
  const db = c.env.DB
  const exhibitionId = c.req.param('id')
  const { title, description, theme, start_date, end_date, location, venue_type, max_artworks, status } = await c.req.json()
  
  try {
    await db.prepare(`
      UPDATE exhibitions 
      SET title = ?, description = ?, theme = ?, start_date = ?, end_date = ?,
          location = ?, venue_type = ?, max_artworks = ?, status = ?,
          updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(title, description, theme, start_date, end_date, location, venue_type, max_artworks, status, exhibitionId).run()
    
    return c.json({ success: true, message: 'ì „ì‹œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (error: any) {
    return c.json({ success: false, message: 'ì „ì‹œ ìˆ˜ì • ì‹¤íŒ¨: ' + error.message })
  }
})

// ì „ì‹œ ì‚­ì œ
app.delete('/api/exhibitions/:id', async (c) => {
  const db = c.env.DB
  const exhibitionId = c.req.param('id')
  
  try {
    // ì „ì‹œ ì‘í’ˆ ë¨¼ì € ì‚­ì œ
    await db.prepare(`DELETE FROM exhibition_artworks WHERE exhibition_id = ?`).bind(exhibitionId).run()
    
    // ì „ì‹œ ì‚­ì œ
    await db.prepare(`DELETE FROM exhibitions WHERE id = ?`).bind(exhibitionId).run()
    
    return c.json({ success: true, message: 'ì „ì‹œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (error: any) {
    return c.json({ success: false, message: 'ì „ì‹œ ì‚­ì œ ì‹¤íŒ¨: ' + error.message })
  }
})

// ì „ì‹œì— ì‘í’ˆ ì¶”ê°€
app.post('/api/exhibitions/:id/artworks', async (c) => {
  const db = c.env.DB
  const exhibitionId = c.req.param('id')
  const { artwork_id, display_order, is_featured, curator_notes } = await c.req.json()
  
  try {
    await db.prepare(`
      INSERT INTO exhibition_artworks (exhibition_id, artwork_id, display_order, is_featured, curator_notes)
      VALUES (?, ?, ?, ?, ?)
    `).bind(exhibitionId, artwork_id, display_order || 0, is_featured || 0, curator_notes || null).run()
    
    return c.json({ success: true, message: 'ì‘í’ˆì´ ì „ì‹œì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (error: any) {
    return c.json({ success: false, message: 'ì‘í’ˆ ì¶”ê°€ ì‹¤íŒ¨: ' + error.message })
  }
})

// ì „ì‹œì—ì„œ ì‘í’ˆ ì œê±°
app.delete('/api/exhibitions/:exhibitionId/artworks/:artworkId', async (c) => {
  const db = c.env.DB
  const exhibitionId = c.req.param('exhibitionId')
  const artworkId = c.req.param('artworkId')
  
  try {
    await db.prepare(`
      DELETE FROM exhibition_artworks 
      WHERE exhibition_id = ? AND artwork_id = ?
    `).bind(exhibitionId, artworkId).run()
    
    return c.json({ success: true, message: 'ì‘í’ˆì´ ì „ì‹œì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (error: any) {
    return c.json({ success: false, message: 'ì‘í’ˆ ì œê±° ì‹¤íŒ¨: ' + error.message })
  }
})

// íë ˆì´ì…˜ ìš”ì²­ ëª©ë¡ ì¡°íšŒ
app.get('/api/curation-requests', async (c) => {
  const db = c.env.DB
  const galleryId = c.req.query('gallery_id')
  const artistId = c.req.query('artist_id')
  const status = c.req.query('status')
  
  try {
    let query = `
      SELECT cr.*, 
             a.title as artwork_title, a.image_url as artwork_image,
             ar.name as artist_name,
             u.organization_name as gallery_name
      FROM curation_requests cr
      LEFT JOIN artworks a ON cr.artwork_id = a.id
      LEFT JOIN artists ar ON cr.artist_id = ar.id
      LEFT JOIN users u ON cr.gallery_id = u.id
      WHERE 1=1
    `
    const params: any[] = []
    
    if (galleryId) {
      query += ` AND cr.gallery_id = ?`
      params.push(galleryId)
    }
    
    if (artistId) {
      query += ` AND cr.artist_id = ?`
      params.push(artistId)
    }
    
    if (status) {
      query += ` AND cr.status = ?`
      params.push(status)
    }
    
    query += ` ORDER BY cr.requested_at DESC`
    
    const requests = await db.prepare(query).bind(...params).all()
    
    return c.json({ success: true, requests: requests.results })
  } catch (error: any) {
    return c.json({ success: false, message: 'ìš”ì²­ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message })
  }
})

// íë ˆì´ì…˜ ìš”ì²­ ìƒì„±
app.post('/api/curation-requests', async (c) => {
  const db = c.env.DB
  const { gallery_id, artwork_id, artist_id, request_message, offer_percentage, duration_months } = await c.req.json()
  
  try {
    const result = await db.prepare(`
      INSERT INTO curation_requests (
        gallery_id, artwork_id, artist_id, request_message, 
        offer_percentage, duration_months, status
      ) VALUES (?, ?, ?, ?, ?, ?, 'pending')
    `).bind(gallery_id, artwork_id, artist_id, request_message, offer_percentage, duration_months).run()
    
    return c.json({ success: true, request_id: result.meta.last_row_id })
  } catch (error: any) {
    return c.json({ success: false, message: 'ìš”ì²­ ìƒì„± ì‹¤íŒ¨: ' + error.message })
  }
})

// íë ˆì´ì…˜ ìš”ì²­ ì‘ë‹µ
app.put('/api/curation-requests/:id/respond', async (c) => {
  const db = c.env.DB
  const requestId = c.req.param('id')
  const { status, response_message } = await c.req.json()
  
  try {
    await db.prepare(`
      UPDATE curation_requests 
      SET status = ?, response_message = ?, responded_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(status, response_message, requestId).run()
    
    return c.json({ success: true, message: 'ìš”ì²­ì— ì‘ë‹µí–ˆìŠµë‹ˆë‹¤.' })
  } catch (error: any) {
    return c.json({ success: false, message: 'ì‘ë‹µ ì‹¤íŒ¨: ' + error.message })
  }
})

// ëª¨ë“ˆ5: ëŒ€ì¤‘ ì¸ê¸°ë„ ì ìˆ˜ ì—…ë°ì´íŠ¸
app.post('/api/valuation/update-popularity/:artworkId', async (c) => {
  const artworkId = c.req.param('artworkId')
  const body = await c.req.json()
  const db = c.env.DB
  
  try {
    const {
      youtube_views = 0,
      instagram_likes = 0,
      instagram_comments = 0,
      instagram_shares = 0,
      platform_likes = 0,
      platform_comments = 0,
      platform_shares = 0,
      google_trends_score = 0,
      media_coverage_count = 0
    } = body
    
    // Instagram ì¸ê²Œì´ì§€ë¨¼íŠ¸ ê³„ì‚°
    const instagram_engagement = instagram_likes + instagram_comments + instagram_shares
    
    // ì¸ê¸°ë„ ì ìˆ˜ ê³„ì‚° (0~100)
    const popularityScore = Math.min(100, 
      (youtube_views / 10000) * 20 + // YouTube ì¡°íšŒìˆ˜ (ìµœëŒ€ 20ì )
      (instagram_engagement / 1000) * 20 + // Instagram ì¸ê²Œì´ì§€ë¨¼íŠ¸ (ìµœëŒ€ 20ì )
      (platform_likes / 100) * 15 + // í”Œë«í¼ ì¢‹ì•„ìš” (ìµœëŒ€ 15ì )
      google_trends_score * 0.25 + // Google Trends (ìµœëŒ€ 25ì )
      (media_coverage_count * 4) // ì–¸ë¡  ë³´ë„ (ìµœëŒ€ 20ì )
    )
    
    // ì¸ê¸°ë„ ì •ë³´ ì €ì¥/ì—…ë°ì´íŠ¸
    await db.prepare(`
      INSERT INTO artwork_popularity (
        artwork_id,
        youtube_views, instagram_likes, instagram_comments, instagram_shares,
        instagram_engagement, platform_likes, platform_comments, platform_shares,
        google_trends_score, media_coverage_count,
        popularity_final_score, last_updated
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
      ON CONFLICT(artwork_id) DO UPDATE SET
        youtube_views = excluded.youtube_views,
        instagram_likes = excluded.instagram_likes,
        instagram_comments = excluded.instagram_comments,
        instagram_shares = excluded.instagram_shares,
        instagram_engagement = excluded.instagram_engagement,
        platform_likes = excluded.platform_likes,
        platform_comments = excluded.platform_comments,
        platform_shares = excluded.platform_shares,
        google_trends_score = excluded.google_trends_score,
        media_coverage_count = excluded.media_coverage_count,
        popularity_final_score = excluded.popularity_final_score,
        last_updated = CURRENT_TIMESTAMP
    `).bind(
      artworkId,
      youtube_views, instagram_likes, instagram_comments, instagram_shares,
      instagram_engagement, platform_likes, platform_comments, platform_shares,
      google_trends_score, media_coverage_count,
      popularityScore
    ).run()
    
    return c.json({ success: true, score: popularityScore })
  } catch (error) {
    return c.json({ success: false, message: 'ì¸ê¸°ë„ ì •ë³´ ì €ì¥ ì‹¤íŒ¨' })
  }
})

// ìµœì¢… ê°€ì¹˜ ì ìˆ˜ ê³„ì‚° (5ê°œ ëª¨ë“ˆ í†µí•©)
app.post('/api/valuation/calculate-final/:artworkId', async (c) => {
  const artworkId = c.req.param('artworkId')
  const db = c.env.DB
  
  try {
    // 1. ì‘ê°€ ì—…ì  ì ìˆ˜ (ëª¨ë“ˆ1)
    const artwork = await db.prepare(`
      SELECT ar.artist_achievement_score
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.id = ?
    `).bind(artworkId).first() as any
    
    const module1Score = artwork?.artist_achievement_score || 0
    
    // 2. ì‘í’ˆ ë‚´ìš© í‰ê°€ (ëª¨ë“ˆ2)
    const module2 = await db.prepare(`
      SELECT artwork_content_final_score
      FROM artwork_content_evaluation
      WHERE artwork_id = ?
    `).bind(artworkId).first() as any
    
    const module2Score = module2?.artwork_content_final_score || 0
    
    // 3. ì €ì‘ê¶Œ ì¸ì¦ (ëª¨ë“ˆ3)
    const module3 = await db.prepare(`
      SELECT certification_score
      FROM artwork_certification
      WHERE artwork_id = ?
    `).bind(artworkId).first() as any
    
    const module3Score = module3?.certification_score || 0
    
    // 4. ì „ë¬¸ê°€ í‰ê°€ (ëª¨ë“ˆ4)
    const expertEvals = await db.prepare(`
      SELECT overall_score, expert_weight
      FROM expert_evaluations
      WHERE artwork_id = ?
    `).bind(artworkId).all()
    
    let module4Score = 0
    if (expertEvals.results.length > 0) {
      let weightedSum = 0
      let totalWeight = 0
      expertEvals.results.forEach((ev: any) => {
        weightedSum += ev.overall_score * ev.expert_weight
        totalWeight += ev.expert_weight
      })
      module4Score = totalWeight > 0 ? weightedSum / totalWeight : 0
    }
    
    // 5. ëŒ€ì¤‘ ì¸ê¸°ë„ (ëª¨ë“ˆ5)
    const module5 = await db.prepare(`
      SELECT popularity_final_score
      FROM artwork_popularity
      WHERE artwork_id = ?
    `).bind(artworkId).first() as any
    
    const module5Score = module5?.popularity_final_score || 0
    
    // ê°€ì¤‘ì¹˜ (ë…¼ë¬¸ ê¸°ì¤€)
    const alpha1 = 0.25 // ì‘ê°€ ì—…ì 
    const alpha2 = 0.30 // ì‘í’ˆ í‰ê°€
    const alpha3 = 0.20 // ì¸ì¦
    const alpha4 = 0.15 // ì „ë¬¸ê°€
    const alpha5 = 0.10 // ì¸ê¸°ë„
    
    // ìµœì¢… ê°€ì¹˜ ì ìˆ˜ ê³„ì‚°
    const finalScore = 
      alpha1 * module1Score +
      alpha2 * module2Score +
      alpha3 * module3Score +
      alpha4 * module4Score +
      alpha5 * module5Score
    
    // AVI (Art Value Index) ê³„ì‚° (0~1000)
    const artValueIndex = finalScore * 10
    
    // ì¶”ì²œ ê°€ê²© ë²”ìœ„ ê³„ì‚° (ì˜ˆì‹œ: ì ìˆ˜ ê¸°ë°˜)
    const basePrice = 1000000 // 100ë§Œì› ê¸°ì¤€
    const recommendedPriceAvg = Math.floor(basePrice * (finalScore / 20))
    const recommendedPriceMin = Math.floor(recommendedPriceAvg * 0.8)
    const recommendedPriceMax = Math.floor(recommendedPriceAvg * 1.2)
    
    // ì‹œì¥ íˆ¬ëª…ë„ ì§€ìˆ˜ (ëª¨ë“  ëª¨ë“ˆì´ í‰ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸)
    let transparencyIndex = 0
    if (module1Score > 0) transparencyIndex += 20
    if (module2Score > 0) transparencyIndex += 20
    if (module3Score > 0) transparencyIndex += 20
    if (module4Score > 0) transparencyIndex += 20
    if (module5Score > 0) transparencyIndex += 20
    
    // ìµœì¢… ê°€ì¹˜ ì •ë³´ ì €ì¥/ì—…ë°ì´íŠ¸
    await db.prepare(`
      INSERT INTO artwork_final_valuation (
        artwork_id,
        module1_artist_achievement,
        module2_artwork_content,
        module3_certification,
        module4_expert_evaluation,
        module5_popularity,
        weight_alpha1, weight_alpha2, weight_alpha3, weight_alpha4, weight_alpha5,
        final_value_score,
        recommended_price_min, recommended_price_max, recommended_price_avg,
        art_value_index,
        market_transparency_index,
        calculated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
      ON CONFLICT(artwork_id) DO UPDATE SET
        module1_artist_achievement = excluded.module1_artist_achievement,
        module2_artwork_content = excluded.module2_artwork_content,
        module3_certification = excluded.module3_certification,
        module4_expert_evaluation = excluded.module4_expert_evaluation,
        module5_popularity = excluded.module5_popularity,
        final_value_score = excluded.final_value_score,
        recommended_price_min = excluded.recommended_price_min,
        recommended_price_max = excluded.recommended_price_max,
        recommended_price_avg = excluded.recommended_price_avg,
        art_value_index = excluded.art_value_index,
        market_transparency_index = excluded.market_transparency_index,
        updated_at = CURRENT_TIMESTAMP
    `).bind(
      artworkId,
      module1Score, module2Score, module3Score, module4Score, module5Score,
      alpha1, alpha2, alpha3, alpha4, alpha5,
      finalScore,
      recommendedPriceMin, recommendedPriceMax, recommendedPriceAvg,
      artValueIndex,
      transparencyIndex
    ).run()
    
    return c.json({ 
      success: true,
      finalScore,
      modules: {
        module1: module1Score,
        module2: module2Score,
        module3: module3Score,
        module4: module4Score,
        module5: module5Score
      },
      weights: { alpha1, alpha2, alpha3, alpha4, alpha5 },
      recommendedPrice: {
        min: recommendedPriceMin,
        max: recommendedPriceMax,
        avg: recommendedPriceAvg
      },
      artValueIndex,
      marketTransparencyIndex: transparencyIndex
    })
  } catch (error) {
    console.error('Final valuation error:', error)
    return c.json({ success: false, message: 'ìµœì¢… ê°€ì¹˜ ê³„ì‚° ì‹¤íŒ¨' })
  }
})

// ì‘í’ˆì˜ ì „ì²´ ê°€ì¹˜ì‚°ì • ì •ë³´ ì¡°íšŒ
app.get('/api/valuation/full-report/:artworkId', async (c) => {
  const artworkId = c.req.param('artworkId')
  const db = c.env.DB
  
  try {
    // ê¸°ë³¸ ì‘í’ˆ ì •ë³´
    const artwork = await db.prepare(`
      SELECT a.*, ar.name as artist_name, ar.artist_achievement_score
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.id = ?
    `).bind(artworkId).first()
    
    // ëª¨ë“ˆ2: ì‘í’ˆ ë‚´ìš© í‰ê°€
    const contentEval = await db.prepare(`
      SELECT * FROM artwork_content_evaluation WHERE artwork_id = ?
    `).bind(artworkId).first()
    
    // ëª¨ë“ˆ3: ì¸ì¦ ì •ë³´
    const certification = await db.prepare(`
      SELECT * FROM artwork_certification WHERE artwork_id = ?
    `).bind(artworkId).first()
    
    // ëª¨ë“ˆ4: ì „ë¬¸ê°€ í‰ê°€ ëª©ë¡
    const expertEvals = await db.prepare(`
      SELECT * FROM expert_evaluations WHERE artwork_id = ? ORDER BY evaluated_at DESC
    `).bind(artworkId).all()
    
    // ëª¨ë“ˆ5: ì¸ê¸°ë„ ì •ë³´
    const popularity = await db.prepare(`
      SELECT * FROM artwork_popularity WHERE artwork_id = ?
    `).bind(artworkId).first()
    
    // ìµœì¢… ê°€ì¹˜ ì •ë³´
    const finalValuation = await db.prepare(`
      SELECT * FROM artwork_final_valuation WHERE artwork_id = ?
    `).bind(artworkId).first()
    
    return c.json({
      success: true,
      artwork,
      contentEvaluation: contentEval,
      certification,
      expertEvaluations: expertEvals.results,
      popularity,
      finalValuation
    })
  } catch (error) {
    return c.json({ success: false, message: 'ê°€ì¹˜ì‚°ì • ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨' })
  }
})

// ====================================
// USER AUTHENTICATION & MANAGEMENT APIs
// ====================================

// Note: generateSessionToken is defined earlier in the file

// Helper: Simple password hash (for demo - use bcrypt in production)
async function hashPassword(password: string): Promise<string> {
  const encoder = new TextEncoder()
  const data = encoder.encode(password)
  const hash = await crypto.subtle.digest('SHA-256', data)
  return Array.from(new Uint8Array(hash))
    .map(b => b.toString(16).padStart(2, '0'))
    .join('')
}

// Helper: Verify session token
async function verifySession(db: any, token: string) {
  const session = await db.prepare(`
    SELECT s.*, u.* 
    FROM user_sessions s
    JOIN users u ON s.user_id = u.id
    WHERE s.session_token = ? AND s.expires_at > datetime('now') AND u.is_active = 1
  `).bind(token).first()
  
  return session
}

// 1. User Registration
app.post('/api/auth/register', async (c) => {
  const db = c.env.DB
  const body = await c.req.json()
  
  try {
    const {
      email,
      password,
      username,
      full_name,
      role = 'artist', // 'artist', 'curator', 'dealer', 'expert', 'admin'
      phone,
      bio
    } = body
    
    // Validate required fields
    if (!email || !password || !username || !full_name) {
      return c.json({ success: false, message: 'í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”' }, 400)
    }
    
    // Check if email or username already exists
    const existingUser = await db.prepare(`
      SELECT id FROM users WHERE email = ? OR username = ?
    `).bind(email, username).first()
    
    if (existingUser) {
      return c.json({ success: false, message: 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ ë˜ëŠ” ì‚¬ìš©ìëª…ì…ë‹ˆë‹¤' }, 400)
    }
    
    // Hash password with bcrypt (SECURITY FIX)
    const passwordHash = await bcrypt.hash(password, 10)
    
    // Insert user
    const result = await db.prepare(`
      INSERT INTO users (email, password_hash, username, full_name, role, phone, bio, created_at, updated_at)
      VALUES (?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    `).bind(email, passwordHash, username, full_name, role, phone || null, bio || null).run()
    
    const userId = result.meta.last_row_id
    
    // Create profile based on role
    if (role === 'artist') {
      await db.prepare(`
        INSERT INTO artist_profiles (user_id, created_at, updated_at)
        VALUES (?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
      `).bind(userId).run()
    } else if (['curator', 'dealer', 'expert'].includes(role)) {
      await db.prepare(`
        INSERT INTO expert_profiles (user_id, expert_type, created_at, updated_at)
        VALUES (?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
      `).bind(userId, role).run()
    }
    
    return c.json({ 
      success: true, 
      message: 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤',
      user: { id: userId, email, username, full_name, role }
    })
  } catch (error) {
    console.error('Registration error:', error)
    return c.json({ success: false, message: 'íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 3. Verify Session / Get Current User
app.get('/api/auth/me', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    return c.json({
      success: true,
      user: {
        id: session.user_id,
        email: session.email,
        username: session.username,
        full_name: session.full_name,
        role: session.role,
        profile_image: session.profile_image,
        bio: session.bio
      }
    })
  } catch (error) {
    return c.json({ success: false, message: 'ì„¸ì…˜ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 4. Logout
app.post('/api/auth/logout', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤' }, 401)
  }
  
  try {
    await db.prepare(`DELETE FROM user_sessions WHERE session_token = ?`).bind(token).run()
    return c.json({ success: true, message: 'ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤' })
  } catch (error) {
    return c.json({ success: false, message: 'ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ====================================
// ARTWORK SUBMISSION APIs (For Artists)
// ====================================

// 5. Submit Artwork
app.post('/api/submissions/create', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session || session.role !== 'artist') {
      return c.json({ success: false, message: 'ì‘ê°€ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' }, 403)
    }
    
    const body = await c.req.json()
    const {
      title,
      description,
      category,
      technique,
      size_width,
      size_height,
      size_depth,
      creation_year,
      image_url,
      estimated_price,
      exhibitions,
      awards,
      copyright_registration,
      blockchain_hash,
      license_type,
      // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œë“¤ (v6.0)
      exhibition_name,
      exhibition_start_date,
      exhibition_end_date,
      originality_description,
      collection_value_description,
      youtube_url,
      instagram_url,
      nft_platform_url,
      press_release_url
    } = body
    
    if (!title || !image_url) {
      return c.json({ success: false, message: 'ì œëª©ê³¼ ì´ë¯¸ì§€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤' }, 400)
    }
    
    const result = await db.prepare(`
      INSERT INTO artwork_submissions (
        user_id, title, description, category, technique,
        size_width, size_height, size_depth, creation_year,
        image_url, estimated_price,
        exhibitions, awards, copyright_registration, blockchain_hash, license_type,
        submission_status, submitted_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending', CURRENT_TIMESTAMP)
    `).bind(
      session.user_id, title, description, category, technique,
      size_width, size_height, size_depth, creation_year,
      image_url, estimated_price,
      exhibitions ? JSON.stringify(exhibitions) : null,
      awards ? JSON.stringify(awards) : null,
      copyright_registration, blockchain_hash, license_type
    ).run()
    
    const submissionId = result.meta.last_row_id
    
    // Insert extended info if any additional fields are provided
    if (exhibition_name || originality_description || collection_value_description || 
        youtube_url || instagram_url || nft_platform_url || press_release_url) {
      await db.prepare(`
        INSERT INTO artwork_extended_info (
          submission_id,
          exhibition_name,
          exhibition_start_date,
          exhibition_end_date,
          originality_description,
          collection_value_description,
          youtube_url,
          instagram_url,
          nft_platform_url,
          press_release_url,
          created_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
      `).bind(
        submissionId,
        exhibition_name || null,
        exhibition_start_date || null,
        exhibition_end_date || null,
        originality_description || null,
        collection_value_description || null,
        youtube_url || null,
        instagram_url || null,
        nft_platform_url || null,
        press_release_url || null
      ).run()
    }
    
    // Log activity
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, entity_id, created_at)
      VALUES (?, 'submit_artwork', 'submission', ?, CURRENT_TIMESTAMP)
    `).bind(session.user_id, submissionId).run()
    
    // Create notification for admin
    await db.prepare(`
      INSERT INTO notifications (user_id, notification_type, title, message, created_at)
      SELECT id, 'new_submission', 'ìƒˆ ì‘í’ˆ ì œì¶œ', ?, CURRENT_TIMESTAMP
      FROM users WHERE role = 'admin'
    `).bind(`${session.full_name}ë‹˜ì´ ìƒˆ ì‘í’ˆì„ ì œì¶œí–ˆìŠµë‹ˆë‹¤: ${title}`).run()
    
    return c.json({
      success: true,
      message: 'ì‘í’ˆì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤',
      submission_id: submissionId
    })
  } catch (error) {
    console.error('Submission error:', error)
    return c.json({ success: false, message: 'ì‘í’ˆ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 6. Get My Submissions
app.get('/api/submissions/my-submissions', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const submissions = await db.prepare(`
      SELECT * FROM artwork_submissions 
      WHERE user_id = ? 
      ORDER BY submitted_at DESC
    `).bind(session.user_id).all()
    
    return c.json({ success: true, data: submissions.results })
  } catch (error) {
    return c.json({ success: false, message: 'ì œì¶œ ë‚´ì—­ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 7. Get All Submissions (Admin)
app.get('/api/submissions/all', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const status = c.req.query('status') // 'pending', 'approved', 'rejected'
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session || session.role !== 'admin') {
      return c.json({ success: false, message: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' }, 403)
    }
    
    let query = `
      SELECT s.*, u.username, u.full_name, u.email
      FROM artwork_submissions s
      JOIN users u ON s.user_id = u.id
    `
    
    if (status) {
      query += ` WHERE s.submission_status = ?`
    }
    
    query += ` ORDER BY s.submitted_at DESC`
    
    const submissions = status 
      ? await db.prepare(query).bind(status).all()
      : await db.prepare(query).all()
    
    return c.json({ success: true, data: submissions.results })
  } catch (error) {
    return c.json({ success: false, message: 'ì œì¶œ ë‚´ì—­ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 8. Approve/Reject Submission (Admin)
app.post('/api/submissions/:submissionId/review', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const submissionId = c.req.param('submissionId')
  const body = await c.req.json()
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session || session.role !== 'admin') {
      return c.json({ success: false, message: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' }, 403)
    }
    
    const { status, admin_notes, rejection_reason } = body
    
    if (!['approved', 'rejected'].includes(status)) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ìƒíƒœì…ë‹ˆë‹¤' }, 400)
    }
    
    // Get submission details
    const submission = await db.prepare(`
      SELECT * FROM artwork_submissions WHERE id = ?
    `).bind(submissionId).first()
    
    if (!submission) {
      return c.json({ success: false, message: 'ì œì¶œ ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 404)
    }
    
    // Update submission status
    await db.prepare(`
      UPDATE artwork_submissions
      SET submission_status = ?, admin_notes = ?, rejection_reason = ?, reviewed_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(status, admin_notes, rejection_reason, submissionId).run()
    
    // If approved, create artwork and artist if needed
    if (status === 'approved') {
      // Check if artist exists for this user
      let artist = await db.prepare(`
        SELECT id FROM artists WHERE email = (SELECT email FROM users WHERE id = ?)
      `).bind(submission.user_id).first()
      
      let artistId
      if (!artist) {
        // Create artist from user profile
        const user = await db.prepare(`SELECT * FROM users WHERE id = ?`).bind(submission.user_id).first()
        const artistResult = await db.prepare(`
          INSERT INTO artists (name, email, bio, profile_image, created_at)
          VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP)
        `).bind(user.full_name, user.email, user.bio, user.profile_image).run()
        artistId = artistResult.meta.last_row_id
      } else {
        artistId = artist.id
      }
      
      // Create artwork
      const artworkResult = await db.prepare(`
        INSERT INTO artworks (
          artist_id, title, description, category, technique,
          size_width, size_height, size_depth, creation_year,
          image_url, current_price, status, created_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'minted', CURRENT_TIMESTAMP)
      `).bind(
        artistId, submission.title, submission.description, submission.category, submission.technique,
        submission.size_width, submission.size_height, submission.size_depth, submission.creation_year,
        submission.image_url, submission.estimated_price
      ).run()
      
      const artworkId = artworkResult.meta.last_row_id
      
      // Update submission with approved_at
      await db.prepare(`
        UPDATE artwork_submissions SET approved_at = CURRENT_TIMESTAMP WHERE id = ?
      `).bind(submissionId).run()
      
      // Create notification for artist
      await db.prepare(`
        INSERT INTO notifications (user_id, notification_type, title, message, link_url, created_at)
        VALUES (?, 'submission_approved', 'ì‘í’ˆ ìŠ¹ì¸', ?, ?, CURRENT_TIMESTAMP)
      `).bind(
        submission.user_id,
        `ì‘í’ˆ "${submission.title}"ì´(ê°€) ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤`,
        `/artwork/${artworkId}`
      ).run()
    } else {
      // Create notification for rejection
      await db.prepare(`
        INSERT INTO notifications (user_id, notification_type, title, message, created_at)
        VALUES (?, 'submission_rejected', 'ì‘í’ˆ ë°˜ë ¤', ?, CURRENT_TIMESTAMP)
      `).bind(
        submission.user_id,
        `ì‘í’ˆ "${submission.title}"ì´(ê°€) ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìœ : ${rejection_reason}`
      ).run()
    }
    
    return c.json({ success: true, message: `ì œì¶œì´ ${status === 'approved' ? 'ìŠ¹ì¸' : 'ë°˜ë ¤'}ë˜ì—ˆìŠµë‹ˆë‹¤` })
  } catch (error) {
    console.error('Review error:', error)
    return c.json({ success: false, message: 'ê²€í†  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ====================================
// EXPERT EVALUATION APIs
// ====================================

// 9. Create Expert Evaluation
app.post('/api/evaluations/create', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session || !['curator', 'dealer', 'expert', 'admin'].includes(session.role)) {
      return c.json({ success: false, message: 'ì „ë¬¸ê°€ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' }, 403)
    }
    
    const body = await c.req.json()
    const {
      artwork_id,
      artistic_value_score,
      technical_skill_score,
      originality_score,
      market_potential_score,
      collection_value_score,
      recommended_price_min,
      recommended_price_max,
      evaluation_status = 'draft'
    } = body
    
    if (!artwork_id) {
      return c.json({ success: false, message: 'ì‘í’ˆ IDê°€ í•„ìš”í•©ë‹ˆë‹¤' }, 400)
    }
    
    // Calculate overall score
    const overallScore = Math.round(
      (artistic_value_score + technical_skill_score + originality_score + 
       market_potential_score + collection_value_score) / 5
    )
    
    // Get expert profile
    const expertProfile = await db.prepare(`
      SELECT * FROM expert_profiles WHERE user_id = ?
    `).bind(session.user_id).first()
    
    const expertType = expertProfile?.expert_type || session.role
    const authorityLevel = expertProfile?.authority_level || 3
    
    const result = await db.prepare(`
      INSERT INTO user_expert_evaluations (
        artwork_id, expert_user_id, expert_type, expert_authority_level,
        artistic_value_score, technical_skill_score, originality_score,
        market_potential_score, collection_value_score, overall_score,
        recommended_price_min, recommended_price_max,
        evaluation_status, created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    `).bind(
      artwork_id, session.user_id, expertType, authorityLevel,
      artistic_value_score, technical_skill_score, originality_score,
      market_potential_score, collection_value_score, overallScore,
      recommended_price_min, recommended_price_max, evaluation_status
    ).run()
    
    // Log activity
    await db.prepare(`
      INSERT INTO activity_logs (user_id, action_type, entity_type, entity_id, created_at)
      VALUES (?, 'create_evaluation', 'evaluation', ?, CURRENT_TIMESTAMP)
    `).bind(session.user_id, result.meta.last_row_id).run()
    
    return c.json({
      success: true,
      message: 'í‰ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤',
      evaluation_id: result.meta.last_row_id
    })
  } catch (error) {
    console.error('Evaluation error:', error)
    return c.json({ success: false, message: 'í‰ê°€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 10. Update Expert Evaluation
app.put('/api/evaluations/:evaluationId', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const evaluationId = c.req.param('evaluationId')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    // Check ownership
    const evaluation = await db.prepare(`
      SELECT * FROM user_expert_evaluations WHERE id = ? AND expert_user_id = ?
    `).bind(evaluationId, session.user_id).first()
    
    if (!evaluation) {
      return c.json({ success: false, message: 'í‰ê°€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤' }, 404)
    }
    
    const body = await c.req.json()
    const {
      artistic_value_score,
      technical_skill_score,
      originality_score,
      market_potential_score,
      collection_value_score,
      recommended_price_min,
      recommended_price_max,
      evaluation_status
    } = body
    
    // Calculate overall score
    const overallScore = Math.round(
      (artistic_value_score + technical_skill_score + originality_score + 
       market_potential_score + collection_value_score) / 5
    )
    
    await db.prepare(`
      UPDATE user_expert_evaluations
      SET artistic_value_score = ?, technical_skill_score = ?, originality_score = ?,
          market_potential_score = ?, collection_value_score = ?, overall_score = ?,
          recommended_price_min = ?, recommended_price_max = ?,
          evaluation_status = ?, updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(
      artistic_value_score, technical_skill_score, originality_score,
      market_potential_score, collection_value_score, overallScore,
      recommended_price_min, recommended_price_max, evaluation_status,
      evaluationId
    ).run()
    
    if (evaluation_status === 'submitted' && evaluation.evaluation_status !== 'submitted') {
      await db.prepare(`
        UPDATE user_expert_evaluations SET submitted_at = CURRENT_TIMESTAMP WHERE id = ?
      `).bind(evaluationId).run()
    }
    
    return c.json({ success: true, message: 'í‰ê°€ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤' })
  } catch (error) {
    return c.json({ success: false, message: 'í‰ê°€ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 11. Get Evaluations for Artwork
app.get('/api/evaluations/artwork/:artworkId', async (c) => {
  const db = c.env.DB
  const artworkId = c.req.param('artworkId')
  
  try {
    const evaluations = await db.prepare(`
      SELECT e.*, u.full_name, u.username, u.profile_image
      FROM user_expert_evaluations e
      JOIN users u ON e.expert_user_id = u.id
      WHERE e.artwork_id = ? AND e.evaluation_status = 'published'
      ORDER BY e.submitted_at DESC
    `).bind(artworkId).all()
    
    return c.json({ success: true, data: evaluations.results })
  } catch (error) {
    return c.json({ success: false, message: 'í‰ê°€ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 12. Create Expert Comment
app.post('/api/evaluations/:evaluationId/comments', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const evaluationId = c.req.param('evaluationId')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    // Check if user owns this evaluation
    const evaluation = await db.prepare(`
      SELECT * FROM user_expert_evaluations WHERE id = ? AND expert_user_id = ?
    `).bind(evaluationId, session.user_id).first()
    
    if (!evaluation) {
      return c.json({ success: false, message: 'í‰ê°€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤' }, 404)
    }
    
    const body = await c.req.json()
    const { comment_type, comment_text, is_public = 1 } = body
    
    if (!comment_text) {
      return c.json({ success: false, message: 'ì½”ë©˜íŠ¸ ë‚´ìš©ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 400)
    }
    
    const result = await db.prepare(`
      INSERT INTO user_expert_comments (
        evaluation_id, artwork_id, expert_user_id,
        comment_type, comment_text, is_public,
        created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    `).bind(
      evaluationId, evaluation.artwork_id, session.user_id,
      comment_type, comment_text, is_public
    ).run()
    
    return c.json({
      success: true,
      message: 'ì½”ë©˜íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤',
      comment_id: result.meta.last_row_id
    })
  } catch (error) {
    return c.json({ success: false, message: 'ì½”ë©˜íŠ¸ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 13. Get Comments for Evaluation
app.get('/api/evaluations/:evaluationId/comments', async (c) => {
  const db = c.env.DB
  const evaluationId = c.req.param('evaluationId')
  
  try {
    const comments = await db.prepare(`
      SELECT c.*, u.full_name, u.username, u.profile_image
      FROM user_expert_comments c
      JOIN users u ON c.expert_user_id = u.id
      WHERE c.evaluation_id = ? AND c.is_public = 1
      ORDER BY c.created_at DESC
    `).bind(evaluationId).all()
    
    return c.json({ success: true, data: comments.results })
  } catch (error) {
    return c.json({ success: false, message: 'ì½”ë©˜íŠ¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 14. Get My Evaluations (for experts)
app.get('/api/evaluations/my-evaluations', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const evaluations = await db.prepare(`
      SELECT e.*, a.title as artwork_title, a.image_url as artwork_image,
             ar.name as artist_name
      FROM user_expert_evaluations e
      JOIN artworks a ON e.artwork_id = a.id
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE e.expert_user_id = ?
      ORDER BY e.created_at DESC
    `).bind(session.user_id).all()
    
    return c.json({ success: true, data: evaluations.results })
  } catch (error) {
    return c.json({ success: false, message: 'í‰ê°€ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 15. Get Notifications
app.get('/api/notifications', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const notifications = await db.prepare(`
      SELECT * FROM notifications
      WHERE user_id = ?
      ORDER BY created_at DESC
      LIMIT 50
    `).bind(session.user_id).all()
    
    return c.json({ success: true, data: notifications.results })
  } catch (error) {
    return c.json({ success: false, message: 'ì•Œë¦¼ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 16. Mark Notification as Read
app.put('/api/notifications/:notificationId/read', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const notificationId = c.req.param('notificationId')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    await db.prepare(`
      UPDATE notifications SET is_read = 1
      WHERE id = ? AND user_id = ?
    `).bind(notificationId, session.user_id).run()
    
    return c.json({ success: true, message: 'ì•Œë¦¼ì„ ì½ìŒìœ¼ë¡œ í‘œì‹œí–ˆìŠµë‹ˆë‹¤' })
  } catch (error) {
    return c.json({ success: false, message: 'ì•Œë¦¼ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ==================== êµ¬ë§¤ ë° ê²½ë§¤ ì‹œìŠ¤í…œ API ====================

// 17. ì§ì ‘ êµ¬ë§¤ ìš”ì²­ (Direct Purchase)
app.post('/api/artworks/:id/purchase', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const artworkId = c.req.param('id')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const { offer_price, message, payment_method } = await c.req.json()
    
    // ì‘í’ˆ ì •ë³´ ì¡°íšŒ
    const artwork = await db.prepare(`
      SELECT a.*, ao.owner_id as current_owner_id
      FROM artworks a
      LEFT JOIN artwork_ownership ao ON a.id = ao.artwork_id AND ao.is_current_owner = 1
      WHERE a.id = ?
    `).bind(artworkId).first()
    
    if (!artwork) {
      return c.json({ success: false, message: 'ì‘í’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 404)
    }
    
    if (!artwork.current_owner_id) {
      return c.json({ success: false, message: 'ì†Œìœ ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤' }, 400)
    }
    
    if (artwork.current_owner_id === session.user_id) {
      return c.json({ success: false, message: 'ë³¸ì¸ì˜ ì‘í’ˆì€ êµ¬ë§¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 400)
    }
    
    // êµ¬ë§¤ ì œì•ˆ ìƒì„±
    const expiresAt = new Date()
    expiresAt.setDate(expiresAt.getDate() + 7) // 7ì¼ í›„ ë§Œë£Œ
    
    const result = await db.prepare(`
      INSERT INTO purchase_offers (artwork_id, buyer_id, seller_id, offer_price, message, status, expires_at)
      VALUES (?, ?, ?, ?, ?, 'pending', ?)
    `).bind(artworkId, session.user_id, artwork.current_owner_id, offer_price, message || null, expiresAt.toISOString()).run()
    
    // íŒë§¤ìì—ê²Œ ì•Œë¦¼ ìƒì„±
    await db.prepare(`
      INSERT INTO notifications (user_id, type, title, message, link)
      VALUES (?, 'purchase_offer', 'êµ¬ë§¤ ì œì•ˆ ë„ì°©', ?, ?)
    `).bind(
      artwork.current_owner_id,
      `íšŒì›ë‹˜ì˜ ì‘í’ˆ "${artwork.title}"ì— ëŒ€í•œ êµ¬ë§¤ ì œì•ˆì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤. ì œì•ˆ ê¸ˆì•¡: ${offer_price} ETH`,
      `/mypage?tab=offers`
    ).run()
    
    return c.json({ 
      success: true, 
      message: 'êµ¬ë§¤ ì œì•ˆì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤',
      offer_id: result.meta.last_row_id 
    })
  } catch (error: any) {
    console.error('Purchase offer error:', error)
    return c.json({ success: false, message: 'êµ¬ë§¤ ì œì•ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message }, 500)
  }
})

// ============================================
// Dashboard Data APIs
// ============================================

// ì¦ê²¨ì°¾ê¸° ëª©ë¡ API
app.get('/api/artworks/favorites', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, artworks: [] })
  }
  
  try {
    const session = await db.prepare(`
      SELECT user_id FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!session) {
      return c.json({ success: false, artworks: [] })
    }
    
    // favorites í…Œì´ë¸”ì—ì„œ ì¦ê²¨ì°¾ê¸°í•œ ì‘í’ˆ ì¡°íšŒ
    const favorites = await db.prepare(`
      SELECT a.*, ar.name as artist_name, f.created_at as favorited_at
      FROM favorites f
      JOIN artworks a ON f.artwork_id = a.id
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE f.user_id = ?
      ORDER BY f.created_at DESC
      LIMIT ?
    `).bind(session.user_id, parseInt(c.req.query('limit') || '10')).all()
    
    return c.json({ success: true, artworks: favorites.results || [] })
  } catch (error) {
    console.error('Favorites API error:', error)
    return c.json({ success: false, artworks: [] })
  }
})

// ì¶”ì²œ ì‘í’ˆ API (ê°„ë‹¨í•œ ê·œì¹™ ê¸°ë°˜)
app.get('/api/recommendations/artworks', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  try {
    let userId: number | null = null
    
    if (token) {
      const session = await db.prepare(`
        SELECT user_id FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
      `).bind(token).first()
      userId = session ? session.user_id as number : null
    }
    
    // ì¶”ì²œ ë¡œì§: í‰ê°€ ì ìˆ˜ ë†’ì€ ì‘í’ˆ + ëœë¤
    const recommendations = await db.prepare(`
      SELECT a.*, ar.name as artist_name
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.status = 'active'
      ORDER BY a.final_score DESC, RANDOM()
      LIMIT ?
    `).bind(parseInt(c.req.query('limit') || '6')).all()
    
    return c.json({ success: true, artworks: recommendations.results || [] })
  } catch (error) {
    console.error('Recommendations API error:', error)
    return c.json({ success: false, artworks: [] })
  }
})

// êµ¬ë§¤ ë‚´ì—­ API
app.get('/api/purchases', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, purchases: [] })
  }
  
  try {
    const session = await db.prepare(`
      SELECT user_id FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!session) {
      return c.json({ success: false, purchases: [] })
    }
    
    // artwork_ownership í…Œì´ë¸”ì—ì„œ êµ¬ë§¤ ë‚´ì—­ ì¡°íšŒ
    const purchases = await db.prepare(`
      SELECT ao.*, a.title, a.image_url, ar.name as artist_name
      FROM artwork_ownership ao
      JOIN artworks a ON ao.artwork_id = a.id
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE ao.owner_id = ? AND ao.is_current_owner = 1
      ORDER BY ao.acquired_at DESC
    `).bind(session.user_id).all()
    
    return c.json({ success: true, purchases: purchases.results || [] })
  } catch (error) {
    console.error('Purchases API error:', error)
    return c.json({ success: false, purchases: [] })
  }
})

// ì „ì‹œíšŒ ëª©ë¡ API
app.get('/api/exhibitions', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, exhibitions: [] })
  }
  
  try {
    const session = await db.prepare(`
      SELECT user_id FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!session) {
      return c.json({ success: false, exhibitions: [] })
    }
    
    // exhibitions í…Œì´ë¸”ì—ì„œ ì „ì‹œíšŒ ì¡°íšŒ (ê¸°ê´€ì´ ìƒì„±í•œ ê²ƒë§Œ)
    const exhibitions = await db.prepare(`
      SELECT e.*, COUNT(ea.artwork_id) as artwork_count
      FROM exhibitions e
      LEFT JOIN exhibition_artworks ea ON e.id = ea.exhibition_id
      WHERE e.created_by = ?
      GROUP BY e.id
      ORDER BY e.created_at DESC
      LIMIT ?
    `).bind(session.user_id, parseInt(c.req.query('limit') || '10')).all()
    
    return c.json({ success: true, exhibitions: exhibitions.results || [] })
  } catch (error) {
    console.error('Exhibitions API error:', error)
    return c.json({ success: false, exhibitions: [] })
  }
})

// ê¸°ê´€ í†µê³„ API (ë°©ë¬¸ì ìˆ˜, íŒŒíŠ¸ë„ˆì‹­)
app.get('/api/museum/stats', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, visitors: 0, partnerships: 0 })
  }
  
  try {
    const session = await db.prepare(`
      SELECT user_id FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!session) {
      return c.json({ success: false, visitors: 0, partnerships: 0 })
    }
    
    // ë°©ë¬¸ì ìˆ˜ ê³„ì‚° (ì „ì‹œíšŒì˜ ì´ ì¡°íšŒìˆ˜)
    const visitorsResult = await db.prepare(`
      SELECT SUM(e.view_count) as total
      FROM exhibitions e
      WHERE e.created_by = ?
    `).bind(session.user_id).first()
    
    const visitors = visitorsResult?.total as number || 0
    
    // íŒŒíŠ¸ë„ˆì‹­ ìˆ˜ (partnerships í…Œì´ë¸”, ì—†ìœ¼ë©´ 0)
    const partnershipsResult = await db.prepare(`
      SELECT COUNT(*) as count
      FROM partnerships
      WHERE museum_id = ? AND status = 'active'
    `).bind(session.user_id).first()
    
    const partnerships = partnershipsResult?.count as number || 0
    
    return c.json({ success: true, visitors, partnerships })
  } catch (error) {
    console.error('Museum stats API error:', error)
    return c.json({ success: false, visitors: 0, partnerships: 0 })
  }
})

// ============================================
// User Profile APIs
// ============================================

// í”„ë¡œí•„ ì—…ë°ì´íŠ¸ API
app.put('/api/users/profile', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await db.prepare(`
      SELECT user_id FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const { full_name, username, bio, profile_image_url } = await c.req.json()
    
    // ì‚¬ìš©ìëª… ì¤‘ë³µ ì²´í¬ (ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ì§€)
    if (username) {
      const existingUser = await db.prepare(`
        SELECT id FROM users WHERE username = ? AND id != ?
      `).bind(username, session.user_id).first()
      
      if (existingUser) {
        return c.json({ success: false, message: 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì‚¬ìš©ìëª…ì…ë‹ˆë‹¤' }, 400)
      }
    }
    
    // í”„ë¡œí•„ ì—…ë°ì´íŠ¸
    await db.prepare(`
      UPDATE users 
      SET full_name = ?, username = ?, bio = ?, profile_image_url = ?
      WHERE id = ?
    `).bind(
      full_name || null,
      username || null,
      bio || null,
      profile_image_url || null,
      session.user_id
    ).run()
    
    // ì—…ë°ì´íŠ¸ëœ ì‚¬ìš©ì ì •ë³´ ë°˜í™˜
    const updatedUser = await db.prepare(`
      SELECT id, email, username, full_name, role, wallet_address, bio, profile_image_url
      FROM users WHERE id = ?
    `).bind(session.user_id).first()
    
    return c.json({ success: true, user: updatedUser })
  } catch (error: any) {
    console.error('Profile update error:', error)
    return c.json({ success: false, message: 'í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message }, 500)
  }
})

// ì•Œë¦¼ ì„¤ì • ì¡°íšŒ API
app.get('/api/users/notification-settings', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await db.prepare(`
      SELECT user_id FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    // notification_settings í…Œì´ë¸”ì—ì„œ ì„¤ì • ì¡°íšŒ
    const settings = await db.prepare(`
      SELECT notify_new_artwork, notify_price_change, notify_bid, notify_evaluation
      FROM notification_settings WHERE user_id = ?
    `).bind(session.user_id).first()
    
    // ì„¤ì •ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ë°˜í™˜
    if (!settings) {
      return c.json({ 
        success: true, 
        settings: {
          notify_new_artwork: true,
          notify_price_change: true,
          notify_bid: true,
          notify_evaluation: true
        }
      })
    }
    
    return c.json({ success: true, settings })
  } catch (error: any) {
    console.error('Notification settings fetch error:', error)
    return c.json({ success: false, message: 'ì•Œë¦¼ ì„¤ì • ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message }, 500)
  }
})

// ì•Œë¦¼ ì„¤ì • ì €ì¥ API
app.put('/api/users/notification-settings', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await db.prepare(`
      SELECT user_id FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const { notify_new_artwork, notify_price_change, notify_bid, notify_evaluation } = await c.req.json()
    
    // UPSERT (INSERT OR REPLACE)
    await db.prepare(`
      INSERT INTO notification_settings (user_id, notify_new_artwork, notify_price_change, notify_bid, notify_evaluation)
      VALUES (?, ?, ?, ?, ?)
      ON CONFLICT(user_id) DO UPDATE SET
        notify_new_artwork = excluded.notify_new_artwork,
        notify_price_change = excluded.notify_price_change,
        notify_bid = excluded.notify_bid,
        notify_evaluation = excluded.notify_evaluation
    `).bind(
      session.user_id,
      notify_new_artwork ? 1 : 0,
      notify_price_change ? 1 : 0,
      notify_bid ? 1 : 0,
      notify_evaluation ? 1 : 0
    ).run()
    
    return c.json({ success: true, message: 'ì•Œë¦¼ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤' })
  } catch (error: any) {
    console.error('Notification settings save error:', error)
    return c.json({ success: false, message: 'ì•Œë¦¼ ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message }, 500)
  }
})

// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ API
app.put('/api/users/password', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await db.prepare(`
      SELECT user_id FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const { current_password, new_password } = await c.req.json()
    
    // âœ… Backend password strength validation
    const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/
    if (!passwordRegex.test(new_password)) {
      return c.json({ 
        success: false, 
        message: 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒ, ëŒ€ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤' 
      }, 400)
    }
    
    // í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    const user = await db.prepare(`
      SELECT password_hash FROM users WHERE id = ?
    `).bind(session.user_id).first()
    
    if (!user) {
      return c.json({ success: false, message: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 404)
    }
    
    // âœ… bcryptë¥¼ ì‚¬ìš©í•œ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ (Timing Attack ë°©ì§€)
    const isValidPassword = await bcrypt.compare(current_password, user.password_hash as string)
    if (!isValidPassword) {
      return c.json({ success: false, message: 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤' }, 401)
    }
    
    // âœ… bcryptë¡œ ìƒˆ ë¹„ë°€ë²ˆí˜¸ í•´ì‹±
    const hashedNewPassword = await bcrypt.hash(new_password, 10)
    await db.prepare(`
      UPDATE users SET password_hash = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?
    `).bind(hashedNewPassword, session.user_id).run()
    
    return c.json({ success: true, message: 'ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤' })
  } catch (error: any) {
    console.error('Password change error:', error)
    return c.json({ success: false, message: 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message }, 500)
  }
})

// ì§€ê°‘ ì£¼ì†Œ ì €ì¥ API
app.put('/api/users/wallet', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await db.prepare(`
      SELECT user_id FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const { wallet_address } = await c.req.json()
    
    // ì§€ê°‘ ì£¼ì†Œ ì¤‘ë³µ ì²´í¬
    const existingWallet = await db.prepare(`
      SELECT id FROM users WHERE wallet_address = ? AND id != ?
    `).bind(wallet_address, session.user_id).first()
    
    if (existingWallet) {
      return c.json({ success: false, message: 'ì´ë¯¸ ë‹¤ë¥¸ ê³„ì •ì—ì„œ ì‚¬ìš© ì¤‘ì¸ ì§€ê°‘ ì£¼ì†Œì…ë‹ˆë‹¤' }, 400)
    }
    
    // ì§€ê°‘ ì£¼ì†Œ ì €ì¥
    await db.prepare(`
      UPDATE users SET wallet_address = ? WHERE id = ?
    `).bind(wallet_address, session.user_id).run()
    
    return c.json({ success: true, message: 'ì§€ê°‘ ì£¼ì†Œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', wallet_address })
  } catch (error: any) {
    console.error('Wallet save error:', error)
    return c.json({ success: false, message: 'ì§€ê°‘ ì£¼ì†Œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message }, 500)
  }
})

// âœ… ê³„ì • ì‚­ì œ API (GDPR Compliant)
app.delete('/api/users/account', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const { password } = await c.req.json()
    
    // âœ… ë¹„ë°€ë²ˆí˜¸ í™•ì¸ (bcrypt)
    const user = await db.prepare(`
      SELECT password_hash FROM users WHERE id = ?
    `).bind(session.user_id).first()
    
    if (!user) {
      return c.json({ success: false, message: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 404)
    }
    
    const isValidPassword = await bcrypt.compare(password, user.password_hash as string)
    if (!isValidPassword) {
      return c.json({ success: false, message: 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤' }, 401)
    }
    
    // âœ… ì—°ê´€ ë°ì´í„° ì‚­ì œ (GDPR Right to Erasure)
    // Delete data from tables that exist (safe deletion with try-catch)
    try { await db.prepare('DELETE FROM user_sessions WHERE user_id = ?').bind(session.user_id).run() } catch(e) {}
    try { await db.prepare('DELETE FROM activity_logs WHERE user_id = ?').bind(session.user_id).run() } catch(e) {}
    try { await db.prepare('DELETE FROM artist_profiles WHERE user_id = ?').bind(session.user_id).run() } catch(e) {}
    try { await db.prepare('DELETE FROM expert_profiles WHERE user_id = ?').bind(session.user_id).run() } catch(e) {}
    
    // Log deletion before removing user (for audit trail)
    try {
      await db.prepare(`
        INSERT INTO activity_logs (user_id, action, details, ip_address, user_agent, created_at)
        VALUES (?, 'account_deleted', ?, ?, ?, CURRENT_TIMESTAMP)
      `).bind(session.user_id, JSON.stringify({ reason: 'user_request' }), c.req.header('CF-Connecting-IP') || '', c.req.header('User-Agent') || '').run()
    } catch(e) {
      // If activity_logs table doesn't exist, that's ok
    }
    
    // Finally, delete the user (cascade will handle remaining dependencies if configured)
    await db.prepare('DELETE FROM users WHERE id = ?').bind(session.user_id).run()
    
    return c.json({ 
      success: true, 
      message: 'ê³„ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤',
      gdpr_compliant: true
    })
  } catch (error: any) {
    console.error('Account deletion error:', error)
    return c.json({ success: false, message: 'ê³„ì • ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message }, 500)
  }
})

// ============================================
// Favorites API
// ============================================

// ì¦ê²¨ì°¾ê¸° í† ê¸€ API
app.post('/api/artworks/:id/favorite', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const artworkId = c.req.param('id')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await db.prepare(`
      SELECT user_id FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    // í˜„ì¬ ì¦ê²¨ì°¾ê¸° ìƒíƒœ í™•ì¸
    const existing = await db.prepare(`
      SELECT id FROM favorites WHERE user_id = ? AND artwork_id = ?
    `).bind(session.user_id, artworkId).first()
    
    if (existing) {
      // ì´ë¯¸ ì¦ê²¨ì°¾ê¸° ë˜ì–´ìˆìŒ -> ì œê±°
      await db.prepare(`
        DELETE FROM favorites WHERE user_id = ? AND artwork_id = ?
      `).bind(session.user_id, artworkId).run()
      
      // ì‘í’ˆì˜ likes_count ê°ì†Œ
      await db.prepare(`
        UPDATE artworks SET likes_count = likes_count - 1 WHERE id = ? AND likes_count > 0
      `).bind(artworkId).run()
      
      return c.json({ success: true, is_favorited: false, message: 'ê´€ì‹¬ì‘í’ˆì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤' })
    } else {
      // ì¦ê²¨ì°¾ê¸° ì¶”ê°€
      await db.prepare(`
        INSERT INTO favorites (user_id, artwork_id) VALUES (?, ?)
      `).bind(session.user_id, artworkId).run()
      
      // ì‘í’ˆì˜ likes_count ì¦ê°€
      await db.prepare(`
        UPDATE artworks SET likes_count = likes_count + 1 WHERE id = ?
      `).bind(artworkId).run()
      
      return c.json({ success: true, is_favorited: true, message: 'ê´€ì‹¬ì‘í’ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤' })
    }
  } catch (error: any) {
    console.error('Favorite toggle error:', error)
    return c.json({ success: false, message: 'ì¦ê²¨ì°¾ê¸° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message }, 500)
  }
})

// ì¦ê²¨ì°¾ê¸° ìƒíƒœ í™•ì¸ API
app.get('/api/artworks/:id/favorite-status', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const artworkId = c.req.param('id')
  
  if (!token) {
    return c.json({ success: false, is_favorited: false })
  }
  
  try {
    const session = await db.prepare(`
      SELECT user_id FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!session) {
      return c.json({ success: false, is_favorited: false })
    }
    
    const favorite = await db.prepare(`
      SELECT id FROM favorites WHERE user_id = ? AND artwork_id = ?
    `).bind(session.user_id, artworkId).first()
    
    return c.json({ success: true, is_favorited: !!favorite })
  } catch (error: any) {
    console.error('Favorite status check error:', error)
    return c.json({ success: false, is_favorited: false })
  }
})

// ============================================
// Notifications API
// ============================================

// ì•Œë¦¼ ëª©ë¡ ì¡°íšŒ API
app.get('/api/notifications', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', notifications: [] }, 401)
  }
  
  try {
    const session = await db.prepare(`
      SELECT user_id FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤', notifications: [] }, 401)
    }
    
    const limit = parseInt(c.req.query('limit') || '20')
    
    const notifications = await db.prepare(`
      SELECT id, user_id, type, title, message, link, is_read, created_at
      FROM notifications
      WHERE user_id = ?
      ORDER BY created_at DESC
      LIMIT ?
    `).bind(session.user_id, limit).all()
    
    return c.json({ success: true, notifications: notifications.results || [] })
  } catch (error: any) {
    console.error('Notifications fetch error:', error)
    return c.json({ success: false, message: 'ì•Œë¦¼ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, notifications: [] }, 500)
  }
})

// ì½ì§€ ì•Šì€ ì•Œë¦¼ ê°œìˆ˜ API
app.get('/api/notifications/unread-count', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, count: 0 })
  }
  
  try {
    const session = await db.prepare(`
      SELECT user_id FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!session) {
      return c.json({ success: false, count: 0 })
    }
    
    const result = await db.prepare(`
      SELECT COUNT(*) as count FROM notifications
      WHERE user_id = ? AND is_read = 0
    `).bind(session.user_id).first()
    
    return c.json({ success: true, count: result?.count || 0 })
  } catch (error: any) {
    console.error('Unread count fetch error:', error)
    return c.json({ success: false, count: 0 })
  }
})

// ì•Œë¦¼ ì½ìŒ í‘œì‹œ API
app.put('/api/notifications/:id/read', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const notificationId = c.req.param('id')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await db.prepare(`
      SELECT user_id FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    await db.prepare(`
      UPDATE notifications SET is_read = 1
      WHERE id = ? AND user_id = ?
    `).bind(notificationId, session.user_id).run()
    
    return c.json({ success: true, message: 'ì•Œë¦¼ì´ ì½ìŒ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤' })
  } catch (error: any) {
    console.error('Notification mark read error:', error)
    return c.json({ success: false, message: 'ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message }, 500)
  }
})

// ëª¨ë“  ì•Œë¦¼ ì½ìŒ í‘œì‹œ API
app.put('/api/notifications/mark-all-read', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await db.prepare(`
      SELECT user_id FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    await db.prepare(`
      UPDATE notifications SET is_read = 1
      WHERE user_id = ? AND is_read = 0
    `).bind(session.user_id).run()
    
    return c.json({ success: true, message: 'ëª¨ë“  ì•Œë¦¼ì´ ì½ìŒ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤' })
  } catch (error: any) {
    console.error('Mark all read error:', error)
    return c.json({ success: false, message: 'ëª¨ë“  ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message }, 500)
  }
})

// ============================================
// Transactions API
// ============================================

// ê±°ë˜ ë‚´ì—­ ì¡°íšŒ API
app.get('/api/transactions', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', transactions: [] }, 401)
  }
  
  try {
    const session = await db.prepare(`
      SELECT user_id FROM user_sessions WHERE session_token = ? AND expires_at > datetime('now')
    `).bind(token).first()
    
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤', transactions: [] }, 401)
    }
    
    const userId = session.user_id as number
    const transactions = []
    
    // 1. êµ¬ë§¤ ë‚´ì—­ (artwork_ownership í…Œì´ë¸”)
    const purchases = await db.prepare(`
      SELECT 
        ao.id,
        ao.artwork_id,
        ao.acquired_at as created_at,
        ao.purchase_price as price,
        'purchase' as type,
        'completed' as status,
        a.title as artwork_title,
        a.image_url as artwork_image
      FROM artwork_ownership ao
      JOIN artworks a ON ao.artwork_id = a.id
      WHERE ao.owner_id = ?
      ORDER BY ao.acquired_at DESC
    `).bind(userId).all()
    
    if (purchases.results) {
      transactions.push(...purchases.results)
    }
    
    // 2. íŒë§¤ ë‚´ì—­ (artwork_ownership í…Œì´ë¸” - ì´ì „ ì†Œìœ ì)
    const sales = await db.prepare(`
      SELECT 
        ao.id,
        ao.artwork_id,
        ao.acquired_at as created_at,
        ao.purchase_price as price,
        'sale' as type,
        'completed' as status,
        a.title as artwork_title,
        a.image_url as artwork_image
      FROM artwork_ownership ao
      JOIN artworks a ON ao.artwork_id = a.id
      JOIN artwork_ownership previous_ao ON ao.artwork_id = previous_ao.artwork_id
      WHERE previous_ao.owner_id = ? AND previous_ao.is_current_owner = 0
      ORDER BY ao.acquired_at DESC
    `).bind(userId).all()
    
    if (sales.results) {
      transactions.push(...sales.results)
    }
    
    // 3. ì…ì°° ë‚´ì—­ (auction_bids í…Œì´ë¸”)
    const bids = await db.prepare(`
      SELECT 
        ab.id,
        ab.artwork_id,
        ab.created_at,
        ab.bid_amount as price,
        'bid' as type,
        ab.status,
        a.title as artwork_title,
        a.image_url as artwork_image
      FROM auction_bids ab
      JOIN artworks a ON ab.artwork_id = a.id
      WHERE ab.bidder_id = ?
      ORDER BY ab.created_at DESC
    `).bind(userId).all()
    
    if (bids.results) {
      transactions.push(...bids.results)
    }
    
    // 4. êµ¬ë§¤ ì œì•ˆ ë‚´ì—­ (purchase_offers í…Œì´ë¸”)
    const offers = await db.prepare(`
      SELECT 
        po.id,
        po.artwork_id,
        po.created_at,
        po.offer_price as price,
        'offer' as type,
        po.status,
        a.title as artwork_title,
        a.image_url as artwork_image
      FROM purchase_offers po
      JOIN artworks a ON po.artwork_id = a.id
      WHERE po.buyer_id = ? OR po.seller_id = ?
      ORDER BY po.created_at DESC
    `).bind(userId, userId).all()
    
    if (offers.results) {
      transactions.push(...offers.results)
    }
    
    return c.json({ success: true, transactions })
  } catch (error: any) {
    console.error('Transactions fetch error:', error)
    return c.json({ success: false, message: 'ê±°ë˜ ë‚´ì—­ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, transactions: [] }, 500)
  }
})

// 18. ê²½ë§¤ ìƒì„±
app.post('/api/artworks/:id/auction/create', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const artworkId = c.req.param('id')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const { starting_price, reserve_price, duration_days } = await c.req.json()
    
    // ì‘í’ˆ ì†Œìœ ê¶Œ í™•ì¸
    const ownership = await db.prepare(`
      SELECT * FROM artwork_ownership
      WHERE artwork_id = ? AND owner_id = ? AND is_current_owner = 1
    `).bind(artworkId, session.user_id).first()
    
    if (!ownership) {
      return c.json({ success: false, message: 'ì‘í’ˆ ì†Œìœ ìë§Œ ê²½ë§¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' }, 403)
    }
    
    // ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ ê²½ë§¤ê°€ ìˆëŠ”ì§€ í™•ì¸
    const existingAuction = await db.prepare(`
      SELECT * FROM auctions WHERE artwork_id = ? AND status = 'active'
    `).bind(artworkId).first()
    
    if (existingAuction) {
      return c.json({ success: false, message: 'ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ ê²½ë§¤ê°€ ìˆìŠµë‹ˆë‹¤' }, 400)
    }
    
    // ê²½ë§¤ ì¢…ë£Œ ì‹œê°„ ê³„ì‚°
    const endTime = new Date()
    endTime.setDate(endTime.getDate() + (duration_days || 7))
    
    // ê²½ë§¤ ìƒì„±
    const result = await db.prepare(`
      INSERT INTO auctions (
        artwork_id, seller_id, starting_price, current_price, 
        reserve_price, end_time, status
      )
      VALUES (?, ?, ?, ?, ?, ?, 'active')
    `).bind(
      artworkId, session.user_id, starting_price, starting_price,
      reserve_price || starting_price, endTime.toISOString()
    ).run()
    
    return c.json({ 
      success: true, 
      message: 'ê²½ë§¤ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤',
      auction_id: result.meta.last_row_id 
    })
  } catch (error: any) {
    console.error('Auction creation error:', error)
    return c.json({ success: false, message: 'ê²½ë§¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message }, 500)
  }
})

// 19. ê²½ë§¤ ì…ì°°
app.post('/api/auctions/:auctionId/bid', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  const auctionId = c.req.param('auctionId')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const { bid_amount } = await c.req.json()
    
    // ê²½ë§¤ ì •ë³´ ì¡°íšŒ
    const auction = await db.prepare(`
      SELECT a.*, aw.title as artwork_title
      FROM auctions a
      LEFT JOIN artworks aw ON a.artwork_id = aw.id
      WHERE a.id = ?
    `).bind(auctionId).first()
    
    if (!auction) {
      return c.json({ success: false, message: 'ê²½ë§¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 404)
    }
    
    if (auction.status !== 'active') {
      return c.json({ success: false, message: 'ì§„í–‰ ì¤‘ì¸ ê²½ë§¤ê°€ ì•„ë‹™ë‹ˆë‹¤' }, 400)
    }
    
    if (new Date(auction.end_time) < new Date()) {
      return c.json({ success: false, message: 'ê²½ë§¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤' }, 400)
    }
    
    if (auction.seller_id === session.user_id) {
      return c.json({ success: false, message: 'ë³¸ì¸ì˜ ê²½ë§¤ì—ëŠ” ì…ì°°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 400)
    }
    
    if (bid_amount <= auction.current_price) {
      return c.json({ success: false, message: `ì…ì°°ê°€ëŠ” í˜„ì¬ê°€(${auction.current_price} ETH)ë³´ë‹¤ ë†’ì•„ì•¼ í•©ë‹ˆë‹¤` }, 400)
    }
    
    // ì´ì „ ìµœê³  ì…ì°°ìì˜ is_winning_bidë¥¼ 0ìœ¼ë¡œ ë³€ê²½
    await db.prepare(`
      UPDATE auction_bids SET is_winning_bid = 0
      WHERE auction_id = ? AND is_winning_bid = 1
    `).bind(auctionId).run()
    
    // ìƒˆë¡œìš´ ì…ì°° ì¶”ê°€
    const bidResult = await db.prepare(`
      INSERT INTO auction_bids (auction_id, bidder_id, bid_amount, is_winning_bid)
      VALUES (?, ?, ?, 1)
    `).bind(auctionId, session.user_id, bid_amount).run()
    
    // ê²½ë§¤ ì •ë³´ ì—…ë°ì´íŠ¸
    await db.prepare(`
      UPDATE auctions 
      SET current_price = ?, 
          winner_id = ?,
          winning_bid_id = ?,
          total_bids = total_bids + 1,
          updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(bid_amount, session.user_id, bidResult.meta.last_row_id, auctionId).run()
    
    // íŒë§¤ìì—ê²Œ ì•Œë¦¼
    await db.prepare(`
      INSERT INTO notifications (user_id, type, title, message, link)
      VALUES (?, 'new_bid', 'ìƒˆë¡œìš´ ì…ì°°', ?, ?)
    `).bind(
      auction.seller_id,
      `"${auction.artwork_title}" ê²½ë§¤ì— ${bid_amount} ETH ì…ì°°ì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤`,
      `/auction/${auctionId}`
    ).run()
    
    return c.json({ 
      success: true, 
      message: 'ì…ì°°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤',
      bid_id: bidResult.meta.last_row_id,
      current_price: bid_amount
    })
  } catch (error: any) {
    console.error('Bidding error:', error)
    return c.json({ success: false, message: 'ì…ì°° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message }, 500)
  }
})

// 20. ê²½ë§¤ ì •ë³´ ì¡°íšŒ
app.get('/api/artworks/:id/auction', async (c) => {
  const db = c.env.DB
  const artworkId = c.req.param('id')
  
  try {
    const auction = await db.prepare(`
      SELECT 
        a.*,
        u.full_name as seller_name,
        u.username as seller_username,
        COUNT(ab.id) as total_bids,
        MAX(ab.bid_amount) as highest_bid
      FROM auctions a
      LEFT JOIN users u ON a.seller_id = u.id
      LEFT JOIN auction_bids ab ON a.id = ab.auction_id
      WHERE a.artwork_id = ? AND a.status = 'active'
      GROUP BY a.id
    `).bind(artworkId).first()
    
    if (!auction) {
      return c.json({ success: true, data: null })
    }
    
    // ìµœê·¼ ì…ì°° ë‚´ì—­
    const recentBids = await db.prepare(`
      SELECT 
        ab.*,
        u.username,
        u.full_name
      FROM auction_bids ab
      LEFT JOIN users u ON ab.bidder_id = u.id
      WHERE ab.auction_id = ?
      ORDER BY ab.bid_time DESC
      LIMIT 10
    `).bind(auction.id).all()
    
    return c.json({ 
      success: true, 
      data: auction,
      recent_bids: recentBids.results 
    })
  } catch (error: any) {
    console.error('Auction fetch error:', error)
    return c.json({ success: false, message: 'ê²½ë§¤ ì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 21. ê´€ë¦¬ì: ê±°ë˜ ë‚´ì—­ ì¡°íšŒ
app.get('/api/admin/transactions', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifyAdminSession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' }, 403)
    }
    
    const { status, type, limit = 50 } = c.req.query()
    
    let query = `
      SELECT 
        t.*,
        a.title as artwork_title,
        a.image_url as artwork_image,
        buyer.full_name as buyer_name,
        buyer.username as buyer_username,
        seller.full_name as seller_name,
        seller.username as seller_username
      FROM transactions t
      LEFT JOIN artworks a ON t.artwork_id = a.id
      LEFT JOIN users buyer ON t.buyer_id = buyer.id
      LEFT JOIN users seller ON t.seller_id = seller.id
      WHERE 1=1
    `
    
    const params: any[] = []
    
    if (status) {
      query += ` AND t.status = ?`
      params.push(status)
    }
    
    if (type) {
      query += ` AND t.transaction_type = ?`
      params.push(type)
    }
    
    query += ` ORDER BY t.created_at DESC LIMIT ?`
    params.push(parseInt(limit as string))
    
    const result = await db.prepare(query).bind(...params).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    console.error('Admin transactions fetch error:', error)
    return c.json({ success: false, message: 'ê±°ë˜ ë‚´ì—­ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 22. ê´€ë¦¬ì: ê²½ë§¤ ëª©ë¡ ì¡°íšŒ
app.get('/api/admin/auctions', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifyAdminSession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' }, 403)
    }
    
    const { status, limit = 50 } = c.req.query()
    
    let query = `
      SELECT 
        a.*,
        aw.title as artwork_title,
        aw.image_url as artwork_image,
        seller.full_name as seller_name,
        seller.username as seller_username,
        winner.full_name as winner_name,
        winner.username as winner_username
      FROM auctions a
      LEFT JOIN artworks aw ON a.artwork_id = aw.id
      LEFT JOIN users seller ON a.seller_id = seller.id
      LEFT JOIN users winner ON a.winner_id = winner.id
      WHERE 1=1
    `
    
    const params: any[] = []
    
    if (status) {
      query += ` AND a.status = ?`
      params.push(status)
    }
    
    query += ` ORDER BY a.created_at DESC LIMIT ?`
    params.push(parseInt(limit as string))
    
    const result = await db.prepare(query).bind(...params).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    console.error('Admin auctions fetch error:', error)
    return c.json({ success: false, message: 'ê²½ë§¤ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ============================================
// ì•„í‹°ìŠ¤íŠ¸ ë­í¬ í”„ë ˆì„ì›Œí¬ API
// ============================================

// 1. ì „ì‹œíšŒ ê²½ë ¥ ì¶”ê°€
app.post('/api/artist/exhibitions', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const { 
      exhibition_type, title, location, organizer, 
      start_date, end_date, is_famous_venue, proof_document_url 
    } = await c.req.json()
    
    // ì ìˆ˜ ê³„ì‚° (PDF ê¸°ì¤€)
    const pointsMap: any = {
      'international_biennale': 150,
      'international_solo': 150,
      'international_2person': 100,
      'international_3person': 70,
      'international_group': 50,
      'domestic_biennale': 100,
      'domestic_solo': 100,
      'domestic_2person': 70,
      'domestic_3person': 50,
      'domestic_group': 30,
      'other': 20
    }
    
    let points = pointsMap[exhibition_type] || 20
    
    // ìœ ëª… ì „ì‹œíšŒ ê°€ì¤‘ì¹˜ +10%
    if (is_famous_venue) {
      points = Math.round(points * 1.1)
    }
    
    const result = await db.prepare(`
      INSERT INTO artist_exhibitions (
        artist_id, exhibition_type, title, location, organizer, 
        start_date, end_date, is_famous_venue, proof_document_url, points, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending')
    `).bind(
      session.user_id, exhibition_type, title, location, organizer,
      start_date, end_date, is_famous_venue ? 1 : 0, proof_document_url, points
    ).run()
    
    // ë­í¬ ì¬ê³„ì‚°
    await calculateArtistRank(db, session.user_id)
    
    return c.json({ 
      success: true, 
      message: 'ì „ì‹œíšŒ ê²½ë ¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤',
      exhibition_id: result.meta.last_row_id 
    })
  } catch (error: any) {
    console.error('Exhibition add error:', error)
    return c.json({ success: false, message: 'ì „ì‹œíšŒ ê²½ë ¥ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 2. ì „ì‹œíšŒ ê²½ë ¥ ì¡°íšŒ
app.get('/api/artist/exhibitions', async (c) => {
  const db = c.env.DB
  const artistId = c.req.query('artist_id')
  
  try {
    const result = await db.prepare(`
      SELECT * FROM artist_exhibitions 
      WHERE artist_id = ? 
      ORDER BY start_date DESC
    `).bind(artistId).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    console.error('Exhibitions fetch error:', error)
    return c.json({ success: false, message: 'ì „ì‹œíšŒ ê²½ë ¥ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 3. ìˆ˜ìƒ ê²½ë ¥ ì¶”ê°€
app.post('/api/artist/awards', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const { 
      award_rank, award_name, competition_name, organizer, 
      award_date, is_international, certificate_url, proof_url 
    } = await c.req.json()
    
    // ì ìˆ˜ ê³„ì‚°
    const rankPoints = [100, 70, 50, 30] // 1ìˆœìœ„, 2ìˆœìœ„, 3ìˆœìœ„, ì…ì„ 
    let points = rankPoints[award_rank - 1] || 30
    
    // êµ­ì œ ìˆ˜ìƒ ê°€ì¤‘ì¹˜ +10%
    if (is_international) {
      points = Math.round(points * 1.1)
    }
    
    const result = await db.prepare(`
      INSERT INTO artist_awards (
        artist_id, award_rank, award_name, competition_name, organizer,
        award_date, is_international, certificate_url, proof_url, points, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending')
    `).bind(
      session.user_id, award_rank, award_name, competition_name, organizer,
      award_date, is_international ? 1 : 0, certificate_url, proof_url, points
    ).run()
    
    await calculateArtistRank(db, session.user_id)
    
    return c.json({ 
      success: true, 
      message: 'ìˆ˜ìƒ ê²½ë ¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤',
      award_id: result.meta.last_row_id 
    })
  } catch (error: any) {
    console.error('Award add error:', error)
    return c.json({ success: false, message: 'ìˆ˜ìƒ ê²½ë ¥ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 4. ìˆ˜ìƒ ê²½ë ¥ ì¡°íšŒ
app.get('/api/artist/awards', async (c) => {
  const db = c.env.DB
  const artistId = c.req.query('artist_id')
  
  try {
    const result = await db.prepare(`
      SELECT * FROM artist_awards 
      WHERE artist_id = ? 
      ORDER BY award_date DESC
    `).bind(artistId).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    console.error('Awards fetch error:', error)
    return c.json({ success: false, message: 'ìˆ˜ìƒ ê²½ë ¥ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 5. ì €ì‘ê¶Œ ë“±ë¡ ì¶”ê°€
app.post('/api/artist/copyrights', async (c) => {
  const db = c.env.DB
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    const { 
      artwork_title, registration_number, registration_agency,
      registration_date, certificate_url, country 
    } = await c.req.json()
    
    const result = await db.prepare(`
      INSERT INTO artist_copyrights (
        artist_id, artwork_title, registration_number, registration_agency,
        registration_date, certificate_url, country, points, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, 30, 'pending')
    `).bind(
      session.user_id, artwork_title, registration_number, registration_agency,
      registration_date, certificate_url, country || 'KR'
    ).run()
    
    await calculateArtistRank(db, session.user_id)
    
    return c.json({ 
      success: true, 
      message: 'ì €ì‘ê¶Œ ë“±ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤',
      copyright_id: result.meta.last_row_id 
    })
  } catch (error: any) {
    console.error('Copyright add error:', error)
    return c.json({ success: false, message: 'ì €ì‘ê¶Œ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 6. ì €ì‘ê¶Œ ì¡°íšŒ
app.get('/api/artist/copyrights', async (c) => {
  const db = c.env.DB
  const artistId = c.req.query('artist_id')
  
  try {
    const result = await db.prepare(`
      SELECT * FROM artist_copyrights 
      WHERE artist_id = ? 
      ORDER BY registration_date DESC
    `).bind(artistId).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    console.error('Copyrights fetch error:', error)
    return c.json({ success: false, message: 'ì €ì‘ê¶Œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 7. ì•„í‹°ìŠ¤íŠ¸ ë­í¬ ì¡°íšŒ
app.get('/api/artist/rank/:artistId', async (c) => {
  const db = c.env.DB
  const artistId = c.req.param('artistId')
  
  try {
    const result = await db.prepare(`
      SELECT ar.*, u.username, u.full_name, u.bio
      FROM artist_ranks ar
      LEFT JOIN users u ON ar.artist_id = u.id
      WHERE ar.artist_id = ?
    `).bind(artistId).first()
    
    if (!result) {
      return c.json({ success: false, message: 'ë­í¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 404)
    }
    
    return c.json({ success: true, data: result })
  } catch (error: any) {
    console.error('Rank fetch error:', error)
    return c.json({ success: false, message: 'ë­í¬ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 8. ë­í¬ ë¦¬ë”ë³´ë“œ (ìƒìœ„ ë­í‚¹ ì•„í‹°ìŠ¤íŠ¸)
app.get('/api/artist/leaderboard', async (c) => {
  const db = c.env.DB
  const limit = parseInt(c.req.query('limit') || '50')
  const category = c.req.query('category') // master, excellent, professional, emerging
  
  try {
    let query = `
      SELECT 
        ar.*,
        u.username, u.full_name, u.bio
      FROM artist_ranks ar
      LEFT JOIN users u ON ar.artist_id = u.id
      WHERE 1=1
    `
    
    const params: any[] = []
    
    if (category) {
      query += ` AND ar.rank_category = ?`
      params.push(category)
    }
    
    query += ` ORDER BY ar.final_score DESC LIMIT ?`
    params.push(limit)
    
    const result = await db.prepare(query).bind(...params).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    console.error('Leaderboard fetch error:', error)
    return c.json({ success: false, message: 'ë¦¬ë”ë³´ë“œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 9. ë­í¬ ì¬ê³„ì‚° (ê´€ë¦¬ì/ìë™)
app.post('/api/artist/rank/recalculate/:artistId', async (c) => {
  const db = c.env.DB
  const artistId = c.req.param('artistId')
  const token = c.req.header('Authorization')?.replace('Bearer ', '')
  
  if (!token) {
    return c.json({ success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
  }
  
  try {
    const session = await verifySession(db, token)
    if (!session) {
      return c.json({ success: false, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }
    
    // ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ìë§Œ ì¬ê³„ì‚° ê°€ëŠ¥
    if (session.user_id !== parseInt(artistId) && session.role !== 'admin') {
      return c.json({ success: false, message: 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤' }, 403)
    }
    
    await calculateArtistRank(db, parseInt(artistId))
    
    return c.json({ success: true, message: 'ë­í¬ê°€ ì¬ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤' })
  } catch (error: any) {
    console.error('Rank recalculation error:', error)
    return c.json({ success: false, message: 'ë­í¬ ì¬ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// 10. ë­í¬ íˆìŠ¤í† ë¦¬ ì¡°íšŒ
app.get('/api/artist/rank/history/:artistId', async (c) => {
  const db = c.env.DB
  const artistId = c.req.param('artistId')
  
  try {
    const result = await db.prepare(`
      SELECT * FROM artist_rank_history 
      WHERE artist_id = ? 
      ORDER BY calculated_at DESC
      LIMIT 20
    `).bind(artistId).all()
    
    return c.json({ success: true, data: result.results })
  } catch (error: any) {
    console.error('Rank history fetch error:', error)
    return c.json({ success: false, message: 'ë­í¬ íˆìŠ¤í† ë¦¬ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ============================================
// ë­í¬ ê³„ì‚° í•¨ìˆ˜
// ============================================

async function calculateArtistRank(db: any, artistId: number) {
  try {
    // 1. ì •ëŸ‰í‰ê°€ ê³„ì‚°
    
    // ì „ì‹œíšŒ ì ìˆ˜
    const exhibitions = await db.prepare(`
      SELECT COALESCE(SUM(points), 0) as total
      FROM artist_exhibitions 
      WHERE artist_id = ? AND status = 'verified'
    `).bind(artistId).first()
    const exhibitionsScore = exhibitions?.total || 0
    
    // ìˆ˜ìƒ ì ìˆ˜
    const awards = await db.prepare(`
      SELECT COALESCE(SUM(points), 0) as total
      FROM artist_awards 
      WHERE artist_id = ? AND status = 'verified'
    `).bind(artistId).first()
    const awardsScore = awards?.total || 0
    
    // ì €ì‘ê¶Œ ì ìˆ˜
    const copyrights = await db.prepare(`
      SELECT COALESCE(SUM(points), 0) as total
      FROM artist_copyrights 
      WHERE artist_id = ? AND status = 'verified'
    `).bind(artistId).first()
    const copyrightsScore = copyrights?.total || 0
    
    // ì „ì‹œê¸°íš ì ìˆ˜
    const curations = await db.prepare(`
      SELECT COALESCE(SUM(points), 0) as total
      FROM artist_curations 
      WHERE artist_id = ? AND status = 'verified'
    `).bind(artistId).first()
    const curationsScore = curations?.total || 0
    
    // ë…¼ë¬¸/ì €ì„œ ì ìˆ˜
    const publications = await db.prepare(`
      SELECT COALESCE(SUM(points), 0) as total
      FROM artist_publications 
      WHERE artist_id = ? AND status = 'verified'
    `).bind(artistId).first()
    const publicationsScore = publications?.total || 0
    
    const quantitativeTotal = exhibitionsScore + awardsScore + copyrightsScore + curationsScore + publicationsScore
    const quantitativeWeighted = quantitativeTotal * 0.4 // 40%
    
    // 2. ì •ì„±í‰ê°€ ê³„ì‚° (30%)
    // ì „ë¬¸ê°€ í‰ê°€ ì ìˆ˜ (í‰ê· )
    const qualitative = await db.prepare(`
      SELECT 
        AVG(total_score) as avg_score,
        COUNT(*) as eval_count
      FROM artist_qualitative_evaluations 
      WHERE artist_id = ? AND status = 'completed'
    `).bind(artistId).first()
    
    let qualitativeScore = qualitative?.avg_score || 0
    
    // íŒë§¤ ê°€ì¤‘ì¹˜ (íŒë§¤ íšŸìˆ˜ * 10ì )
    const sales = await db.prepare(`
      SELECT COUNT(*) as count
      FROM artwork_sales_history 
      WHERE artist_id = ?
    `).bind(artistId).first()
    const salesBonus = (sales?.count || 0) * 10
    
    qualitativeScore += salesBonus
    const qualitativeWeighted = qualitativeScore * 0.3 // 30%
    
    // 3. ì¸ê¸°ë„ í‰ê°€ ê³„ì‚° (30%)
    const user = await db.prepare(`
      SELECT youtube_views, opensea_views, platform_views 
      FROM users WHERE id = ?
    `).bind(artistId).first()
    
    const youtubeViews = user?.youtube_views || 0
    const openseaViews = user?.opensea_views || 0
    const platformViews = user?.platform_views || 0
    
    // YouTube/OpenSea ì ìˆ˜ ê³„ì‚°
    let youtubeScore = 0
    if (youtubeViews >= 50000) youtubeScore = 500
    else if (youtubeViews >= 10000) youtubeScore = 500
    else if (youtubeViews >= 1000) youtubeScore = 400
    else if (youtubeViews >= 500) youtubeScore = 300
    else if (youtubeViews >= 100) youtubeScore = 200
    else if (youtubeViews >= 1) youtubeScore = 100
    
    let openseaScore = 0
    if (openseaViews >= 50000) openseaScore = 500
    else if (openseaViews >= 10000) openseaScore = 500
    else if (openseaViews >= 1000) openseaScore = 400
    else if (openseaViews >= 500) openseaScore = 300
    else if (openseaViews >= 100) openseaScore = 200
    else if (openseaViews >= 1) openseaScore = 100
    
    // í”Œë«í¼ ì ìˆ˜ ê³„ì‚°
    let platformScore = 0
    if (platformViews >= 50000) platformScore = 500
    else if (platformViews >= 10000) platformScore = 400
    else if (platformViews >= 5000) platformScore = 300
    else if (platformViews >= 1000) platformScore = 200
    else if (platformViews >= 500) platformScore = 100
    else if (platformViews >= 1) platformScore = 50
    
    const popularityTotal = youtubeScore + openseaScore + platformScore
    const popularityWeighted = popularityTotal * 0.3 // 30%
    
    // 4. ìµœì¢… ì ìˆ˜ ê³„ì‚°
    const finalScore = quantitativeWeighted + qualitativeWeighted + popularityWeighted
    
    // 5. ë­í¬ ë“±ê¸‰ ê²°ì •
    const { tier, grade, category } = determineRank(finalScore)
    
    // 6. ê¸°ì¡´ ë­í¬ ì¡°íšŒ
    const currentRank = await db.prepare(`
      SELECT * FROM artist_ranks WHERE artist_id = ?
    `).bind(artistId).first()
    
    // 7. ë­í¬ ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒì„±
    if (currentRank) {
      // íˆìŠ¤í† ë¦¬ ê¸°ë¡
      if (currentRank.rank_tier !== tier || currentRank.rank_grade !== grade) {
        await db.prepare(`
          INSERT INTO artist_rank_history (
            artist_id, previous_rank_tier, previous_rank_grade, previous_score,
            new_rank_tier, new_rank_grade, new_score, change_reason
          ) VALUES (?, ?, ?, ?, ?, ?, ?, 'ìë™ ì¬ê³„ì‚°')
        `).bind(
          artistId, currentRank.rank_tier, currentRank.rank_grade, currentRank.final_score,
          tier, grade, finalScore
        ).run()
      }
      
      // ë­í¬ ì—…ë°ì´íŠ¸
      await db.prepare(`
        UPDATE artist_ranks SET
          quantitative_exhibitions_score = ?,
          quantitative_awards_score = ?,
          quantitative_copyrights_score = ?,
          quantitative_curations_score = ?,
          quantitative_publications_score = ?,
          quantitative_total_score = ?,
          quantitative_weighted_score = ?,
          qualitative_total_score = ?,
          qualitative_weighted_score = ?,
          popularity_youtube_views = ?,
          popularity_youtube_score = ?,
          popularity_opensea_views = ?,
          popularity_opensea_score = ?,
          popularity_platform_views = ?,
          popularity_platform_score = ?,
          popularity_total_score = ?,
          popularity_weighted_score = ?,
          final_score = ?,
          rank_tier = ?,
          rank_grade = ?,
          rank_category = ?,
          last_calculated_at = datetime('now'),
          calculation_count = calculation_count + 1
        WHERE artist_id = ?
      `).bind(
        exhibitionsScore, awardsScore, copyrightsScore, curationsScore, publicationsScore,
        quantitativeTotal, quantitativeWeighted,
        qualitativeScore, qualitativeWeighted,
        youtubeViews, youtubeScore, openseaViews, openseaScore, platformViews, platformScore,
        popularityTotal, popularityWeighted,
        finalScore, tier, grade, category,
        artistId
      ).run()
    } else {
      // ìƒˆ ë­í¬ ìƒì„±
      await db.prepare(`
        INSERT INTO artist_ranks (
          artist_id,
          quantitative_exhibitions_score, quantitative_awards_score, quantitative_copyrights_score,
          quantitative_curations_score, quantitative_publications_score,
          quantitative_total_score, quantitative_weighted_score,
          qualitative_total_score, qualitative_weighted_score,
          popularity_youtube_views, popularity_youtube_score,
          popularity_opensea_views, popularity_opensea_score,
          popularity_platform_views, popularity_platform_score,
          popularity_total_score, popularity_weighted_score,
          final_score, rank_tier, rank_grade, rank_category,
          calculation_count
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 1)
      `).bind(
        artistId,
        exhibitionsScore, awardsScore, copyrightsScore, curationsScore, publicationsScore,
        quantitativeTotal, quantitativeWeighted,
        qualitativeScore, qualitativeWeighted,
        youtubeViews, youtubeScore, openseaViews, openseaScore, platformViews, platformScore,
        popularityTotal, popularityWeighted,
        finalScore, tier, grade, category
      ).run()
    }
    
    return { success: true, finalScore, tier, grade, category }
  } catch (error: any) {
    console.error('Rank calculation error:', error)
    throw error
  }
}

// ë­í¬ ë“±ê¸‰ ê²°ì • í•¨ìˆ˜ (PDF ê¸°ì¤€)
function determineRank(score: number): { tier: string, grade: string, category: string } {
  // ìµœìš°ìˆ˜ ì‘ê°€ (SS, S)
  if (score >= 3800) return { tier: 'SS', grade: 'S', category: 'master' }
  if (score >= 3500) return { tier: 'SS', grade: 'A', category: 'master' }
  if (score >= 3200) return { tier: 'SS', grade: 'B', category: 'master' }
  if (score >= 2900) return { tier: 'S', grade: 'S', category: 'master' }
  if (score >= 2600) return { tier: 'S', grade: 'A', category: 'master' }
  if (score >= 2300) return { tier: 'S', grade: 'B', category: 'master' }
  
  // ìš°ìˆ˜ ì‘ê°€ (A, B, C)
  if (score >= 2000) return { tier: 'A', grade: 'S', category: 'excellent' }
  if (score >= 1800) return { tier: 'A', grade: 'A', category: 'excellent' }
  if (score >= 1600) return { tier: 'A', grade: 'B', category: 'excellent' }
  if (score >= 1400) return { tier: 'B', grade: 'S', category: 'excellent' }
  if (score >= 1200) return { tier: 'B', grade: 'A', category: 'excellent' }
  if (score >= 1000) return { tier: 'B', grade: 'B', category: 'excellent' }
  if (score >= 900) return { tier: 'C', grade: 'S', category: 'excellent' }
  if (score >= 800) return { tier: 'C', grade: 'A', category: 'excellent' }
  if (score >= 700) return { tier: 'C', grade: 'B', category: 'excellent' }
  
  // ì „ë¬¸ ì‘ê°€ (D, E, F)
  if (score >= 600) return { tier: 'D', grade: 'S', category: 'professional' }
  if (score >= 550) return { tier: 'D', grade: 'A', category: 'professional' }
  if (score >= 500) return { tier: 'D', grade: 'B', category: 'professional' }
  if (score >= 450) return { tier: 'E', grade: 'S', category: 'professional' }
  if (score >= 400) return { tier: 'E', grade: 'A', category: 'professional' }
  if (score >= 350) return { tier: 'E', grade: 'B', category: 'professional' }
  if (score >= 300) return { tier: 'F', grade: 'S', category: 'professional' }
  if (score >= 250) return { tier: 'F', grade: 'A', category: 'professional' }
  if (score >= 200) return { tier: 'F', grade: 'B', category: 'professional' }
  
  // ì‹ ì§„ ì‘ê°€ (G)
  if (score >= 150) return { tier: 'G', grade: 'S', category: 'emerging' }
  if (score >= 100) return { tier: 'G', grade: 'A', category: 'emerging' }
  if (score >= 50) return { tier: 'G', grade: 'B', category: 'emerging' }
  
  return { tier: 'G', grade: 'B', category: 'emerging' }
}

function formatPrice(price: number): string {
  if (price >= 100000000) return (price / 100000000).toFixed(1) + 'ì–µì›';
  else if (price >= 10000) return (price / 10000).toFixed(0) + 'ë§Œì›';
  return price.toLocaleString() + 'ì›';
}

// ============================================
// ML-Based Recommendation APIs (L3-4)
// ============================================

// ê°œì¸í™”ëœ ì¶”ì²œ ì‘í’ˆ (Hybrid Recommendation)
app.get('/api/recommendations/personalized', async (c) => {
  try {
    const token = c.req.header('Authorization')?.replace('Bearer ', '')
    if (!token) {
      return c.json({ success: false, error: 'Unauthorized' }, 401)
    }
    
    const decoded = await verifyToken(token, c.env)
    const db = c.env.DB
    const limit = parseInt(c.req.query('limit') || '20')
    
    // 1. Collaborative Filtering: ì‚¬ìš©ìì˜ ê³¼ê±° í–‰ë™ ë¶„ì„
    const userInteractions = await db.prepare(`
      SELECT artwork_id, 
             SUM(CASE WHEN interaction_type = 'view' THEN 1 ELSE 0 END) as views,
             SUM(CASE WHEN interaction_type = 'like' THEN 3 ELSE 0 END) as likes,
             SUM(CASE WHEN interaction_type = 'purchase' THEN 10 ELSE 0 END) as purchases
      FROM user_artwork_interactions
      WHERE user_id = ?
      GROUP BY artwork_id
    `).bind(decoded.userId).all()
    
    // 2. ì‚¬ìš©ìê°€ ì„ í˜¸í•˜ëŠ” ì¹´í…Œê³ ë¦¬ì™€ ì•„í‹°ìŠ¤íŠ¸ ì¶”ì¶œ
    const preferredCategories = await db.prepare(`
      SELECT a.category, COUNT(*) as count
      FROM user_artwork_interactions uai
      JOIN artworks a ON uai.artwork_id = a.id
      WHERE uai.user_id = ? AND uai.interaction_type IN ('like', 'purchase')
      GROUP BY a.category
      ORDER BY count DESC
      LIMIT 3
    `).bind(decoded.userId).all()
    
    const preferredArtists = await db.prepare(`
      SELECT a.artist_id, COUNT(*) as count
      FROM user_artwork_interactions uai
      JOIN artworks a ON uai.artwork_id = a.id
      WHERE uai.user_id = ? AND uai.interaction_type IN ('like', 'purchase')
      GROUP BY a.artist_id
      ORDER BY count DESC
      LIMIT 5
    `).bind(decoded.userId).all()
    
    // 3. Content-Based Filtering: ìœ ì‚¬í•œ ì‘í’ˆ ì°¾ê¸°
    const categoryFilter = preferredCategories.results.map((c: any) => `'${c.category}'`).join(',')
    const artistFilter = preferredArtists.results.map((a: any) => a.artist_id).join(',')
    
    const interactedArtworkIds = userInteractions.results.map((i: any) => i.artwork_id).join(',')
    
    const recommendations = await db.prepare(`
      SELECT 
        a.*,
        ar.name as artist_name,
        ar.profile_image as artist_profile_image,
        (
          -- ì¹´í…Œê³ ë¦¬ ë§¤ì¹­ ì ìˆ˜
          CASE WHEN a.category IN (\${categoryFilter || "''"}) THEN 30 ELSE 0 END +
          -- ì•„í‹°ìŠ¤íŠ¸ ë§¤ì¹­ ì ìˆ˜
          CASE WHEN a.artist_id IN (\${artistFilter || "0"}) THEN 40 ELSE 0 END +
          -- ê°€ì¹˜ ì ìˆ˜ (ì •ê·œí™”)
          (a.estimated_value / 1000000.0) * 10 +
          -- ì¸ê¸°ë„ ì ìˆ˜
          (SELECT COUNT(*) FROM user_artwork_interactions WHERE artwork_id = a.id) * 0.5 +
          -- ìµœì‹ ì„± ì ìˆ˜
          (julianday('now') - julianday(a.created_at)) * -0.1
        ) as recommendation_score
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.id NOT IN (\${interactedArtworkIds || "0"})
        AND a.status = 'active'
      ORDER BY recommendation_score DESC
      LIMIT ?
    `).bind(limit).all()
    
    return c.json({
      success: true,
      data: recommendations.results,
      meta: {
        algorithm: 'hybrid',
        preferred_categories: preferredCategories.results,
        preferred_artists: preferredArtists.results
      }
    })
  } catch (error: any) {
    console.error('Personalized recommendation error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ìœ ì‚¬ ì‘í’ˆ ì¶”ì²œ (Content-Based Filtering)
app.get('/api/recommendations/similar/:artworkId', async (c) => {
  try {
    const artworkId = c.req.param('artworkId')
    const db = c.env.DB
    const limit = parseInt(c.req.query('limit') || '10')
    
    // ê¸°ì¤€ ì‘í’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const sourceArtwork = await db.prepare(`
      SELECT * FROM artworks WHERE id = ?
    `).bind(artworkId).first()
    
    if (!sourceArtwork) {
      return c.json({ success: false, error: 'Artwork not found' }, 404)
    }
    
    // ìœ ì‚¬ ì‘í’ˆ ì°¾ê¸° (ì¹´í…Œê³ ë¦¬, ì•„í‹°ìŠ¤íŠ¸, ê°€ê²©ëŒ€, ìŠ¤íƒ€ì¼ ê¸°ë°˜)
    const similarArtworks = await db.prepare(`
      SELECT 
        a.*,
        ar.name as artist_name,
        ar.profile_image as artist_profile_image,
        (
          -- ê°™ì€ ì¹´í…Œê³ ë¦¬ (50ì )
          CASE WHEN a.category = ? THEN 50 ELSE 0 END +
          -- ê°™ì€ ì•„í‹°ìŠ¤íŠ¸ (40ì )
          CASE WHEN a.artist_id = ? THEN 40 ELSE 0 END +
          -- ìœ ì‚¬í•œ ê°€ê²©ëŒ€ (Â±30%, 10ì )
          CASE 
            WHEN ABS(a.estimated_value - ?) / CAST(? AS REAL) <= 0.3 THEN 10
            ELSE 0
          END +
          -- ì¸ê¸°ë„
          (SELECT COUNT(*) FROM user_artwork_interactions WHERE artwork_id = a.id) * 0.3
        ) as similarity_score
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.id != ?
        AND a.status = 'active'
        AND (
          a.category = ? OR
          a.artist_id = ? OR
          ABS(a.estimated_value - ?) / CAST(? AS REAL) <= 0.5
        )
      ORDER BY similarity_score DESC, a.created_at DESC
      LIMIT ?
    `).bind(
      sourceArtwork.category,
      sourceArtwork.artist_id,
      sourceArtwork.estimated_value,
      sourceArtwork.estimated_value || 1,
      artworkId,
      sourceArtwork.category,
      sourceArtwork.artist_id,
      sourceArtwork.estimated_value,
      sourceArtwork.estimated_value || 1,
      limit
    ).all()
    
    return c.json({
      success: true,
      data: similarArtworks.results,
      meta: {
        algorithm: 'content_based',
        source_artwork: {
          id: sourceArtwork.id,
          title: sourceArtwork.title,
          category: sourceArtwork.category,
          artist_id: sourceArtwork.artist_id
        }
      }
    })
  } catch (error: any) {
    console.error('Similar artworks error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ì¸ê¸° ì¶”ì²œ (Trending Algorithm)
app.get('/api/recommendations/trending', async (c) => {
  try {
    const db = c.env.DB
    const limit = parseInt(c.req.query('limit') || '20')
    const timeWindow = c.req.query('window') || '7' // days
    
    const trendingArtworks = await db.prepare(`
      SELECT 
        a.*,
        ar.name as artist_name,
        ar.profile_image as artist_profile_image,
        (
          -- ìµœê·¼ ì¡°íšŒìˆ˜ (ê°€ì¤‘ì¹˜ 3)
          (SELECT COUNT(*) FROM user_artwork_interactions 
           WHERE artwork_id = a.id 
             AND interaction_type = 'view'
             AND created_at >= datetime('now', '-' || ? || ' days')) * 3 +
          -- ìµœê·¼ ì¢‹ì•„ìš” (ê°€ì¤‘ì¹˜ 5)
          (SELECT COUNT(*) FROM user_artwork_interactions 
           WHERE artwork_id = a.id 
             AND interaction_type = 'like'
             AND created_at >= datetime('now', '-' || ? || ' days')) * 5 +
          -- ìµœê·¼ êµ¬ë§¤ (ê°€ì¤‘ì¹˜ 10)
          (SELECT COUNT(*) FROM user_artwork_interactions 
           WHERE artwork_id = a.id 
             AND interaction_type = 'purchase'
             AND created_at >= datetime('now', '-' || ? || ' days')) * 10 +
          -- ìµœê·¼ ëŒ“ê¸€ ìˆ˜ (ê°€ì¤‘ì¹˜ 2)
          (SELECT COUNT(*) FROM artwork_comments
           WHERE artwork_id = a.id
             AND created_at >= datetime('now', '-' || ? || ' days')) * 2 +
          -- ìµœê·¼ ê³µìœ  ìˆ˜ (ê°€ì¤‘ì¹˜ 4)
          (SELECT COUNT(*) FROM artwork_shares
           WHERE artwork_id = a.id
             AND created_at >= datetime('now', '-' || ? || ' days')) * 4
        ) as trending_score
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      WHERE a.status = 'active'
      HAVING trending_score > 0
      ORDER BY trending_score DESC, a.created_at DESC
      LIMIT ?
    `).bind(timeWindow, timeWindow, timeWindow, timeWindow, timeWindow, limit).all()
    
    return c.json({
      success: true,
      data: trendingArtworks.results,
      meta: {
        algorithm: 'trending',
        time_window_days: parseInt(timeWindow)
      }
    })
  } catch (error: any) {
    console.error('Trending artworks error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ì‹ ê·œ ì‘í’ˆ ì¶”ì²œ (Latest with Quality Filter)
app.get('/api/recommendations/new', async (c) => {
  try {
    const db = c.env.DB
    const limit = parseInt(c.req.query('limit') || '20')
    const minValue = parseInt(c.req.query('min_value') || '0')
    
    const newArtworks = await db.prepare(`
      SELECT 
        a.*,
        ar.name as artist_name,
        ar.profile_image as artist_profile_image,
        ark.final_score as artist_score
      FROM artworks a
      LEFT JOIN artists ar ON a.artist_id = ar.id
      LEFT JOIN artist_ranks ark ON ar.id = ark.artist_id
      WHERE a.status = 'active'
        AND a.estimated_value >= ?
        AND a.created_at >= datetime('now', '-30 days')
      ORDER BY 
        -- ì•„í‹°ìŠ¤íŠ¸ ì ìˆ˜ê°€ ë†’ì€ ì‹ ì‘ ìš°ì„ 
        COALESCE(ark.final_score, 0) DESC,
        a.created_at DESC
      LIMIT ?
    `).bind(minValue, limit).all()
    
    return c.json({
      success: true,
      data: newArtworks.results,
      meta: {
        algorithm: 'latest_quality',
        min_value: minValue
      }
    })
  } catch (error: any) {
    console.error('New artworks error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ì‚¬ìš©ì í–‰ë™ ê¸°ë¡ (Interaction Tracking)
app.post('/api/recommendations/track', async (c) => {
  try {
    const token = c.req.header('Authorization')?.replace('Bearer ', '')
    let userId = null
    
    if (token) {
      try {
        const decoded = await verifyToken(token, c.env)
        userId = decoded.userId
      } catch (e) {
        // Anonymous tracking allowed
      }
    }
    
    const { artwork_id, interaction_type, metadata } = await c.req.json()
    const db = c.env.DB
    
    // ìœ íš¨ì„± ê²€ì‚¬
    if (!artwork_id || !interaction_type) {
      return c.json({ success: false, error: 'Missing required fields' }, 400)
    }
    
    if (!['view', 'like', 'purchase', 'share'].includes(interaction_type)) {
      return c.json({ success: false, error: 'Invalid interaction type' }, 400)
    }
    
    // ì¸í„°ë™ì…˜ ê¸°ë¡
    await db.prepare(`
      INSERT INTO user_artwork_interactions 
      (user_id, artwork_id, interaction_type, metadata, created_at)
      VALUES (?, ?, ?, ?, datetime('now'))
    `).bind(userId, artwork_id, interaction_type, JSON.stringify(metadata || {})).run()
    
    return c.json({ success: true, message: 'Interaction tracked successfully' })
  } catch (error: any) {
    console.error('Track interaction error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ============================================
// ì‹ ê·œ í˜ì´ì§€ ë¼ìš°íŠ¸ (6ê°œ)
// ============================================

// 1. ì§€ì› í˜ì´ì§€
app.get('/support', (c) => {
  const content = `
    <section class="py-20">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <div class="inline-block mb-6 px-6 py-2 bg-gradient-to-r from-purple-600/20 to-cyan-600/20 backdrop-blur-sm rounded-full border border-purple-500/30">
                    <span class="text-gradient font-bold text-sm">ğŸ’¼ SUPPORT</span>
                </div>
                <h1 class="text-6xl font-black mb-6">
                    <span class="text-white">ì§€ì›</span> <span class="text-gradient">ì„¼í„°</span>
                </h1>
                <p class="text-gray-400 text-xl">GALLERYPIAê°€ ì œê³µí•˜ëŠ” ë‹¤ì–‘í•œ ì§€ì› í”„ë¡œê·¸ë¨ì„ í™•ì¸í•˜ì„¸ìš”</p>
            </div>

            <div class="grid gap-8">
                <!-- ì•„í‹°ìŠ¤íŠ¸ ì§€ì› -->
                <div class="card-nft rounded-3xl p-10">
                    <div class="flex items-center mb-6">
                        <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-palette text-white text-xl"></i>
                        </div>
                        <h2 class="text-3xl font-black text-white">ì•„í‹°ìŠ¤íŠ¸ ì§€ì› í”„ë¡œê·¸ë¨</h2>
                    </div>
                    <ul class="space-y-4 text-gray-300">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                            <div>
                                <strong class="text-white">NFT ë¯¼íŒ… ìˆ˜ìˆ˜ë£Œ ì§€ì›</strong>
                                <p class="text-sm text-gray-400 mt-1">ì‹ ì§„ ì‘ê°€ì˜ ì²« NFT ë¯¼íŒ… ìˆ˜ìˆ˜ë£Œë¥¼ ìµœëŒ€ 50% ì§€ì›í•©ë‹ˆë‹¤</p>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                            <div>
                                <strong class="text-white">ì‘í’ˆ ê°€ì¹˜ì‚°ì • ë¬´ë£Œ ì§€ì›</strong>
                                <p class="text-sm text-gray-400 mt-1">ì „ë¬¸ê°€ íŒ¨ë„ì˜ ì‘í’ˆ í‰ê°€ë¥¼ ë¬´ë£Œë¡œ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                            <div>
                                <strong class="text-white">ë§ˆì¼€íŒ… ë° í™ë³´ ì§€ì›</strong>
                                <p class="text-sm text-gray-400 mt-1">í”Œë«í¼ ë©”ì¸ ë…¸ì¶œ ë° SNS í™ë³´ë¥¼ ì§€ì›í•©ë‹ˆë‹¤</p>
                            </div>
                        </li>
                    </ul>
                </div>

                <!-- ì»¬ë ‰í„° ì§€ì› -->
                <div class="card-nft rounded-3xl p-10">
                    <div class="flex items-center mb-6">
                        <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-gem text-white text-xl"></i>
                        </div>
                        <h2 class="text-3xl font-black text-white">ì»¬ë ‰í„° ì§€ì› í”„ë¡œê·¸ë¨</h2>
                    </div>
                    <ul class="space-y-4 text-gray-300">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                            <div>
                                <strong class="text-white">íˆ¬ì ê°€ì´ë“œ ì œê³µ</strong>
                                <p class="text-sm text-gray-400 mt-1">NFT ë¯¸ìˆ í’ˆ íˆ¬ìì— ëŒ€í•œ ì „ë¬¸ì ì¸ ê°€ì´ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤</p>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                            <div>
                                <strong class="text-white">VIP í”„ë¦¬ë·° ì´ˆëŒ€</strong>
                                <p class="text-sm text-gray-400 mt-1">ì‹ ì‘ NFT ê³µê°œ ì „ VIP í”„ë¦¬ë·°ì— ì´ˆëŒ€ë©ë‹ˆë‹¤</p>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                            <div>
                                <strong class="text-white">í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬ ë„êµ¬</strong>
                                <p class="text-sm text-gray-400 mt-1">ë³´ìœ  NFTì˜ ê°€ì¹˜ ë³€ë™ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¶”ì í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                            </div>
                        </li>
                    </ul>
                </div>

                <!-- êµìœ¡ ì§€ì› -->
                <div class="card-nft rounded-3xl p-10">
                    <div class="flex items-center mb-6">
                        <div class="w-14 h-14 bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-graduation-cap text-white text-xl"></i>
                        </div>
                        <h2 class="text-3xl font-black text-white">êµìœ¡ í”„ë¡œê·¸ë¨</h2>
                    </div>
                    <ul class="space-y-4 text-gray-300">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                            <div>
                                <strong class="text-white">NFT ì•„ì¹´ë°ë¯¸</strong>
                                <p class="text-sm text-gray-400 mt-1">ë¸”ë¡ì²´ì¸ê³¼ NFT ê¸°ìˆ ì— ëŒ€í•œ ë¬´ë£Œ ì˜¨ë¼ì¸ ê°•ì¢Œ</p>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                            <div>
                                <strong class="text-white">ì „ë¬¸ê°€ ì›Œí¬ìƒµ</strong>
                                <p class="text-sm text-gray-400 mt-1">ë¯¸ìˆ í’ˆ ê°€ì¹˜ì‚°ì • ë° NFT ë§ˆì¼€íŒ… ì›Œí¬ìƒµ</p>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="mt-12 text-center">
                <a href="/contact" class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-purple-600 to-cyan-500 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-purple-500/50 transition-all">
                    <i class="fas fa-envelope mr-2"></i>
                    ì§€ì› ë¬¸ì˜í•˜ê¸°
                </a>
            </div>
        </div>
    </section>
  `;
  return c.html(getLayout(content, 'ì§€ì› ì„¼í„° - GALLERYPIA'))
})

// 2. ë„ì›€ë§ í˜ì´ì§€
app.get('/help', (c) => {
  const content = `
    <section class="py-20">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <div class="inline-block mb-6 px-6 py-2 bg-gradient-to-r from-blue-600/20 to-cyan-600/20 backdrop-blur-sm rounded-full border border-blue-500/30">
                    <span class="text-gradient font-bold text-sm">â“ HELP CENTER</span>
                </div>
                <h1 class="text-6xl font-black mb-6">
                    <span class="text-white">ë„ì›€ë§</span> <span class="text-gradient">ì„¼í„°</span>
                </h1>
                <p class="text-gray-400 text-xl">ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ê³¼ ì‚¬ìš© ê°€ì´ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
            </div>

            <div class="space-y-6">
                <!-- FAQ ì•„ì½”ë””ì–¸ ìŠ¤íƒ€ì¼ -->
                <div class="card-nft rounded-2xl overflow-hidden">
                    <details class="group">
                        <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-white hover:bg-opacity-5 transition-all">
                            <div class="flex items-center">
                                <i class="fas fa-question-circle text-purple-400 mr-3 text-xl"></i>
                                <span class="font-bold text-lg text-white">GALLERYPIAëŠ” ì–´ë–¤ ì„œë¹„ìŠ¤ì¸ê°€ìš”?</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
                        </summary>
                        <div class="px-6 pb-6 text-gray-300 leading-relaxed">
                            GALLERYPIAëŠ” ì „ë¬¸ê°€ íŒ¨ë„ì˜ ì •ì„±í‰ê°€ì™€ ë°ì´í„° ê¸°ë°˜ì˜ ì •ëŸ‰í‰ê°€ë¥¼ ê²°í•©í•œ ê°ê´€ì ì¸ ê°€ì¹˜ì‚°ì • ì‹œìŠ¤í…œì„ ê°–ì¶˜ NFT ë¯¸ìˆ í’ˆ í”Œë«í¼ì…ë‹ˆë‹¤. 
                            íˆ¬ëª…í•˜ê³  ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” NFT ê±°ë˜ í™˜ê²½ì„ ì œê³µí•©ë‹ˆë‹¤.
                        </div>
                    </details>
                </div>

                <div class="card-nft rounded-2xl overflow-hidden">
                    <details class="group">
                        <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-white hover:bg-opacity-5 transition-all">
                            <div class="flex items-center">
                                <i class="fas fa-wallet text-blue-400 mr-3 text-xl"></i>
                                <span class="font-bold text-lg text-white">ì§€ê°‘ ì—°ê²°ì€ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
                        </summary>
                        <div class="px-6 pb-6 text-gray-300 leading-relaxed">
                            ë©”íƒ€ë§ˆìŠ¤í¬(MetaMask) ì§€ê°‘ì´ í•„ìš”í•©ë‹ˆë‹¤. 
                            1) ë©”íƒ€ë§ˆìŠ¤í¬ í™•ì¥ í”„ë¡œê·¸ë¨ì„ ì„¤ì¹˜í•˜ì„¸ìš” (https://metamask.io)
                            2) ë©”ì¸ í˜ì´ì§€ì˜ "ì§€ê°‘ ì—°ê²°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
                            3) ë©”íƒ€ë§ˆìŠ¤í¬ íŒì—…ì—ì„œ ì—°ê²°ì„ ìŠ¹ì¸í•˜ì„¸ìš”
                        </div>
                    </details>
                </div>

                <div class="card-nft rounded-2xl overflow-hidden">
                    <details class="group">
                        <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-white hover:bg-opacity-5 transition-all">
                            <div class="flex items-center">
                                <i class="fas fa-paint-brush text-purple-400 mr-3 text-xl"></i>
                                <span class="font-bold text-lg text-white">NFT ë¯¼íŒ…ì€ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
                        </summary>
                        <div class="px-6 pb-6 text-gray-300 leading-relaxed">
                            1) íšŒì›ê°€ì… í›„ ì•„í‹°ìŠ¤íŠ¸ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”
                            2) "NFT ë¯¼íŒ…" ë©”ë‰´ì—ì„œ ì‘í’ˆì„ ì—…ë¡œë“œí•˜ì„¸ìš”
                            3) ì‘í’ˆ ì •ë³´ì™€ ë©”íƒ€ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”
                            4) ì „ë¬¸ê°€ í‰ê°€ë¥¼ ë°›ìœ¼ì„¸ìš” (ê°€ì¹˜ì‚°ì •)
                            5) ë¯¼íŒ… ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ NFTë¥¼ ë°œí–‰í•˜ì„¸ìš”
                        </div>
                    </details>
                </div>

                <div class="card-nft rounded-2xl overflow-hidden">
                    <details class="group">
                        <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-white hover:bg-opacity-5 transition-all">
                            <div class="flex items-center">
                                <i class="fas fa-chart-line text-green-400 mr-3 text-xl"></i>
                                <span class="font-bold text-lg text-white">ê°€ì¹˜ì‚°ì • ì‹œìŠ¤í…œì€ ì–´ë–»ê²Œ ì‘ë™í•˜ë‚˜ìš”?</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
                        </summary>
                        <div class="px-6 pb-6 text-gray-300 leading-relaxed">
                            ìš°ë¦¬ì˜ ê°€ì¹˜ì‚°ì • ì‹œìŠ¤í…œì€ 3ê°€ì§€ ìš”ì†Œë¡œ êµ¬ì„±ë©ë‹ˆë‹¤:
                            <ul class="list-disc list-inside mt-3 space-y-2">
                                <li><strong>ì •ëŸ‰ì  í‰ê°€ (40%)</strong>: ì‹œì¥ ìˆ˜ìš”ë„, í¬ì†Œì„±, ê±°ë˜ ì´ë ¥ ë¶„ì„</li>
                                <li><strong>ì •ì„±ì  í‰ê°€ (30%)</strong>: ì˜ˆìˆ ì  ì™„ì„±ë„, ë…ì°½ì„±, ì „ë¬¸ê°€ í‰ì </li>
                                <li><strong>ì¸ê¸°ë„ í‰ê°€ (30%)</strong>: ì¡°íšŒìˆ˜, ì¢‹ì•„ìš”, ì†Œì…œ ë¯¸ë””ì–´ ë°˜ì‘</li>
                            </ul>
                        </div>
                    </details>
                </div>

                <div class="card-nft rounded-2xl overflow-hidden">
                    <details class="group">
                        <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-white hover:bg-opacity-5 transition-all">
                            <div class="flex items-center">
                                <i class="fas fa-shield-alt text-amber-400 mr-3 text-xl"></i>
                                <span class="font-bold text-lg text-white">ê±°ë˜ëŠ” ì•ˆì „í•œê°€ìš”?</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
                        </summary>
                        <div class="px-6 pb-6 text-gray-300 leading-relaxed">
                            ë„¤, ëª¨ë“  ê±°ë˜ëŠ” ë¸”ë¡ì²´ì¸ ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸ë¥¼ í†µí•´ ì´ë£¨ì–´ì§€ë©°, ë³€ì¡°ê°€ ë¶ˆê°€ëŠ¥í•˜ê³  íˆ¬ëª…í•˜ê²Œ ê¸°ë¡ë©ë‹ˆë‹¤. 
                            ë˜í•œ ì „ë¬¸ê°€ í‰ê°€ë¥¼ í†µí•œ ê°€ì¹˜ì‚°ì •ìœ¼ë¡œ ê³µì •í•œ ê±°ë˜ê°€ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.
                        </div>
                    </details>
                </div>

                <div class="card-nft rounded-2xl overflow-hidden">
                    <details class="group">
                        <summary class="flex items-center justify-between p-6 cursor-pointer hover:bg-white hover:bg-opacity-5 transition-all">
                            <div class="flex items-center">
                                <i class="fas fa-trophy text-yellow-400 mr-3 text-xl"></i>
                                <span class="font-bold text-lg text-white">ì•„í‹°ìŠ¤íŠ¸ ë­í‚¹ ì‹œìŠ¤í…œì€ ë¬´ì—‡ì¸ê°€ìš”?</span>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
                        </summary>
                        <div class="px-6 pb-6 text-gray-300 leading-relaxed">
                            ì „ì‹œíšŒ, ìˆ˜ìƒ ê²½ë ¥, ì €ì‘ê¶Œ, ì‘í’ˆ í™œë™ ë“±ì„ ì¢…í•©í•˜ì—¬ ì•„í‹°ìŠ¤íŠ¸ë¥¼ ê°ê´€ì ìœ¼ë¡œ í‰ê°€í•˜ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤. 
                            SS, S, A~G ë“±ê¸‰ìœ¼ë¡œ êµ¬ë¶„ë˜ë©°, ìµœìš°ìˆ˜ ì‘ê°€ë¶€í„° ì‹ ì§„ ì‘ê°€ê¹Œì§€ 4ê°œ ì¹´í…Œê³ ë¦¬ë¡œ ë¶„ë¥˜ë©ë‹ˆë‹¤.
                        </div>
                    </details>
                </div>
            </div>

            <div class="mt-12 text-center">
                <p class="text-gray-400 mb-6">ì°¾ìœ¼ì‹œëŠ” ë‹µë³€ì´ ì—†ë‚˜ìš”?</p>
                <a href="/contact" class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-blue-600 to-cyan-500 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-blue-500/50 transition-all">
                    <i class="fas fa-envelope mr-2"></i>
                    ë¬¸ì˜í•˜ê¸°
                </a>
            </div>
        </div>
    </section>
  `;
  return c.html(getLayout(content, 'ë„ì›€ë§ ì„¼í„° - GALLERYPIA'))
})

// 3. ê°€ì¹˜ì‚°ì • ì‹œìŠ¤í…œ ìƒì„¸ í˜ì´ì§€
app.get('/valuation-system', (c) => {
  const content = `
    <section class="py-20">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <div class="inline-block mb-6 px-6 py-2 bg-gradient-to-r from-green-600/20 to-emerald-600/20 backdrop-blur-sm rounded-full border border-green-500/30">
                    <span class="text-gradient font-bold text-sm">ğŸ“Š VALUATION SYSTEM</span>
                </div>
                <h1 class="text-6xl font-black mb-6">
                    <span class="text-white">ê°€ì¹˜ì‚°ì •</span> <span class="text-gradient">ì‹œìŠ¤í…œ</span>
                </h1>
                <p class="text-gray-400 text-xl max-w-3xl mx-auto">
                    3ë‹¨ê³„ í‰ê°€ í”„ë¡œì„¸ìŠ¤ë¥¼ í†µí•œ ê°ê´€ì ì´ê³  íˆ¬ëª…í•œ NFT ë¯¸ìˆ í’ˆ ê°€ì¹˜ ì‚°ì •
                </p>
            </div>

            <!-- í‰ê°€ í”„ë¡œì„¸ìŠ¤ -->
            <div class="grid md:grid-cols-3 gap-8 mb-16">
                <div class="card-nft rounded-3xl p-8 text-center">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center mx-auto mb-6">
                        <span class="text-white text-3xl font-black">1</span>
                    </div>
                    <h3 class="text-2xl font-black text-white mb-3">ì‘í’ˆ ì œì¶œ</h3>
                    <p class="text-gray-400 text-sm leading-relaxed">
                        NFT ë¯¼íŒ… í˜ì´ì§€ì—ì„œ ì‘í’ˆ ì´ë¯¸ì§€ì™€ ìƒì„¸ ì •ë³´ë¥¼ ì—…ë¡œë“œí•©ë‹ˆë‹¤
                    </p>
                </div>

                <div class="card-nft rounded-3xl p-8 text-center">
                    <div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-6">
                        <span class="text-white text-3xl font-black">2</span>
                    </div>
                    <h3 class="text-2xl font-black text-white mb-3">ì „ë¬¸ê°€ í‰ê°€</h3>
                    <p class="text-gray-400 text-sm leading-relaxed">
                        ê²€ì¦ëœ ì „ë¬¸ê°€ íŒ¨ë„ì´ ì •ëŸ‰/ì •ì„± í‰ê°€ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤ (24-48ì‹œê°„ ì†Œìš”)
                    </p>
                </div>

                <div class="card-nft rounded-3xl p-8 text-center">
                    <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6">
                        <span class="text-white text-3xl font-black">3</span>
                    </div>
                    <h3 class="text-2xl font-black text-white mb-3">ê°€ì¹˜ í™•ì •</h3>
                    <p class="text-gray-400 text-sm leading-relaxed">
                        ì¢…í•© í‰ê°€ ì ìˆ˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìµœì¢… ê°€ì¹˜ê°€ ì‚°ì •ë©ë‹ˆë‹¤
                    </p>
                </div>
            </div>

            <!-- í‰ê°€ ê¸°ì¤€ ìƒì„¸ -->
            <div class="grid md:grid-cols-3 gap-8">
                <!-- ì •ëŸ‰ì  í‰ê°€ -->
                <div class="card-nft rounded-3xl p-8">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-3">
                            <i class="fas fa-chart-bar text-white text-lg"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-black text-white">ì •ëŸ‰ì  í‰ê°€</h3>
                            <div class="text-blue-400 text-xs font-bold">40% ë°˜ì˜</div>
                        </div>
                    </div>
                    <ul class="space-y-3 text-sm text-gray-300">
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-blue-400 mr-2 mt-1"></i>
                            <span><strong>ì‹œì¥ ìˆ˜ìš”ë„</strong>: NFT ë§ˆì¼“ íŠ¸ë Œë“œ, ê±°ë˜ëŸ‰</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-blue-400 mr-2 mt-1"></i>
                            <span><strong>í¬ì†Œì„±</strong>: ì—ë””ì…˜ ìˆ˜, ìœ ì‚¬ ì‘í’ˆ ë¹„êµ</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-blue-400 mr-2 mt-1"></i>
                            <span><strong>ê±°ë˜ ì´ë ¥</strong>: ê³¼ê±° ê±°ë˜ ë‚´ì—­, ê°€ê²© ë³€ë™</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-blue-400 mr-2 mt-1"></i>
                            <span><strong>ì‘ê°€ ê²½ë ¥</strong>: ì „ì‹œ, ìˆ˜ìƒ, ì €ì‘ê¶Œ í™œë™</span>
                        </li>
                    </ul>
                </div>

                <!-- ì •ì„±ì  í‰ê°€ -->
                <div class="card-nft rounded-3xl p-8">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-3">
                            <i class="fas fa-star text-white text-lg"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-black text-white">ì •ì„±ì  í‰ê°€</h3>
                            <div class="text-purple-400 text-xs font-bold">30% ë°˜ì˜</div>
                        </div>
                    </div>
                    <ul class="space-y-3 text-sm text-gray-300">
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-purple-400 mr-2 mt-1"></i>
                            <span><strong>ì˜ˆìˆ ì  ì™„ì„±ë„</strong>: ë””ìì¸ í’ˆì§ˆ, ë¯¸ì  ì™„ì„±ë„</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-purple-400 mr-2 mt-1"></i>
                            <span><strong>ë…ì°½ì„±</strong>: ê³ ìœ í•œ ìŠ¤íƒ€ì¼, ì°½ì˜ì„±</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-purple-400 mr-2 mt-1"></i>
                            <span><strong>ê¸°ìˆ ì  ì™„ì„±ë„</strong>: ì œì‘ ê¸°ë²•, ê¸°ìˆ ë ¥</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-purple-400 mr-2 mt-1"></i>
                            <span><strong>ì „ë¬¸ê°€ í‰ì </strong>: 5ì¸ ì´ìƒ ì „ë¬¸ê°€ ì¢…í•© í‰ê°€</span>
                        </li>
                    </ul>
                </div>

                <!-- ì¸ê¸°ë„ í‰ê°€ -->
                <div class="card-nft rounded-3xl p-8">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-500 rounded-xl flex items-center justify-center mr-3">
                            <i class="fas fa-fire text-white text-lg"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-black text-white">ì¸ê¸°ë„ í‰ê°€</h3>
                            <div class="text-green-400 text-xs font-bold">30% ë°˜ì˜</div>
                        </div>
                    </div>
                    <ul class="space-y-3 text-sm text-gray-300">
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-green-400 mr-2 mt-1"></i>
                            <span><strong>ì¡°íšŒìˆ˜</strong>: í”Œë«í¼ ë‚´ ì‘í’ˆ ì¡°íšŒìˆ˜</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-green-400 mr-2 mt-1"></i>
                            <span><strong>ì¢‹ì•„ìš”</strong>: ì‚¬ìš©ì ì°¸ì—¬ë„ ë° ë°˜ì‘</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-green-400 mr-2 mt-1"></i>
                            <span><strong>ì†Œì…œ ë¯¸ë””ì–´</strong>: SNS ê³µìœ  ë° ì–¸ê¸‰ íšŸìˆ˜</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-angle-right text-green-400 mr-2 mt-1"></i>
                            <span><strong>ì»¤ë®¤ë‹ˆí‹° ë°˜ì‘</strong>: ëŒ“ê¸€, í† ë¡  í™œë°œë„</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- ê°€ì¹˜ì‚°ì • ì¥ì  -->
            <div class="mt-16 card-nft rounded-3xl p-10">
                <h2 class="text-3xl font-black text-white mb-8 text-center">
                    ì™œ ìš°ë¦¬ì˜ <span class="text-gradient">ê°€ì¹˜ì‚°ì • ì‹œìŠ¤í…œ</span>ì„ ì‹ ë¢°í•  ìˆ˜ ìˆë‚˜ìš”?
                </h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="flex items-start">
                        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center mr-4 flex-shrink-0">
                            <i class="fas fa-shield-check text-white"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-white mb-2">ê²€ì¦ëœ ì „ë¬¸ê°€ íŒ¨ë„</h4>
                            <p class="text-gray-400 text-sm">ë¯¸ìˆ ì‚¬, íë ˆì´í„°, NFT ì „ë¬¸ê°€ë¡œ êµ¬ì„±ëœ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” í‰ê°€ë‹¨</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center mr-4 flex-shrink-0">
                            <i class="fas fa-database text-white"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-white mb-2">ë°ì´í„° ê¸°ë°˜ ë¶„ì„</h4>
                            <p class="text-gray-400 text-sm">ì‹¤ì‹œê°„ ì‹œì¥ ë°ì´í„°ì™€ AI ì•Œê³ ë¦¬ì¦˜ì„ í™œìš©í•œ ê°ê´€ì  í‰ê°€</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-500 rounded-lg flex items-center justify-center mr-4 flex-shrink-0">
                            <i class="fas fa-balance-scale text-white"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-white mb-2">íˆ¬ëª…í•œ í”„ë¡œì„¸ìŠ¤</h4>
                            <p class="text-gray-400 text-sm">ëª¨ë“  í‰ê°€ ê¸°ì¤€ê³¼ ì ìˆ˜ê°€ ê³µê°œë˜ì–´ íˆ¬ëª…ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-500 rounded-lg flex items-center justify-center mr-4 flex-shrink-0">
                            <i class="fas fa-sync text-white"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-white mb-2">ì§€ì†ì  ì—…ë°ì´íŠ¸</h4>
                            <p class="text-gray-400 text-sm">ì‹œì¥ ë³€í™”ì— ë”°ë¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°€ì¹˜ë¥¼ ì¬í‰ê°€í•©ë‹ˆë‹¤</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5ê°œ ëª¨ë“ˆ ê°€ì¹˜ì‚°ì • ì‹œìŠ¤í…œ -->
            <div class="mt-20">
                <div class="text-center mb-12">
                    <h2 class="text-4xl font-black text-white mb-4">
                        ë…¼ë¬¸ ê¸°ë°˜ <span class="text-gradient">5ê°œ ëª¨ë“ˆ</span> ê°€ì¹˜ì‚°ì •
                    </h2>
                    <p class="text-gray-400 text-lg">í•™ìˆ  ì—°êµ¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ê³¼í•™ì  í‰ê°€ í”„ë ˆì„ì›Œí¬</p>
                </div>

                <!-- 5ê°œ ëª¨ë“ˆ ìƒì„¸ -->
                <div class="space-y-6">
                    <!-- ëª¨ë“ˆ 1: ì‘ê°€ ì„±ì·¨ë„ (25%) -->
                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-16 h-16 bg-gradient-to-br from-amber-500 to-orange-500 rounded-2xl flex items-center justify-center mr-6 flex-shrink-0">
                                <span class="text-white text-2xl font-black">1</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center mb-4">
                                    <h3 class="text-2xl font-black text-white mr-4">ì‘ê°€ ì„±ì·¨ë„</h3>
                                    <span class="px-3 py-1 bg-gradient-to-r from-amber-600/30 to-orange-600/30 text-amber-300 rounded-full text-sm font-bold border border-amber-500/30">
                                        ê°€ì¤‘ì¹˜ 25%
                                    </span>
                                </div>
                                <p class="text-gray-400 mb-4">ì‘ê°€ì˜ ê²½ë ¥, ì „ë¬¸ì„±, ì˜ˆìˆ ê³„ ë‚´ ì¸ì •ë„ë¥¼ ì •ëŸ‰ì ìœ¼ë¡œ í‰ê°€í•©ë‹ˆë‹¤.</p>
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div class="bg-white/5 rounded-xl p-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-trophy text-amber-400 mr-2"></i>
                                            <h4 class="font-bold text-white text-sm">ì „ì‹œ ê²½ë ¥</h4>
                                        </div>
                                        <ul class="text-xs text-gray-400 space-y-1">
                                            <li>â€¢ êµ­ì œ ë¹„ì—”ë‚ ë ˆ ì°¸ì—¬</li>
                                            <li>â€¢ ê°œì¸ì „/ë‹¨ì²´ì „ ì´ë ¥</li>
                                            <li>â€¢ ì£¼ìš” ê°¤ëŸ¬ë¦¬ ì „ì‹œ</li>
                                        </ul>
                                    </div>
                                    <div class="bg-white/5 rounded-xl p-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-award text-amber-400 mr-2"></i>
                                            <h4 class="font-bold text-white text-sm">ìˆ˜ìƒ ê²½ë ¥</h4>
                                        </div>
                                        <ul class="text-xs text-gray-400 space-y-1">
                                            <li>â€¢ ê³µëª¨ì „ ì…ìƒ ì‹¤ì </li>
                                            <li>â€¢ ì˜ˆìˆ ìƒ ìˆ˜ìƒ ì´ë ¥</li>
                                            <li>â€¢ ë ˆì§€ë˜ì‹œ ì„ ì •</li>
                                        </ul>
                                    </div>
                                    <div class="bg-white/5 rounded-xl p-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-copyright text-amber-400 mr-2"></i>
                                            <h4 class="font-bold text-white text-sm">ì €ì‘ê¶Œ í™œë™</h4>
                                        </div>
                                        <ul class="text-xs text-gray-400 space-y-1">
                                            <li>â€¢ ì €ì‘ê¶Œ ë“±ë¡ ê±´ìˆ˜</li>
                                            <li>â€¢ ì‘í’ˆ íŒë§¤ ì´ë ¥</li>
                                            <li>â€¢ ì»¬ë ‰ì…˜ ì†Œì¥ í˜„í™©</li>
                                        </ul>
                                    </div>
                                    <div class="bg-white/5 rounded-xl p-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-book text-amber-400 mr-2"></i>
                                            <h4 class="font-bold text-white text-sm">í•™ìˆ  í™œë™</h4>
                                        </div>
                                        <ul class="text-xs text-gray-400 space-y-1">
                                            <li>â€¢ ë…¼ë¬¸ ë°œí‘œ ì‹¤ì </li>
                                            <li>â€¢ ì €ì„œ ì¶œíŒ</li>
                                            <li>â€¢ ê°•ì—° ë° êµìœ¡</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ëª¨ë“ˆ 2: ì‘í’ˆ ë‚´ìš© (30%) -->
                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center mr-6 flex-shrink-0">
                                <span class="text-white text-2xl font-black">2</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center mb-4">
                                    <h3 class="text-2xl font-black text-white mr-4">ì‘í’ˆ ë‚´ìš©</h3>
                                    <span class="px-3 py-1 bg-gradient-to-r from-purple-600/30 to-pink-600/30 text-purple-300 rounded-full text-sm font-bold border border-purple-500/30">
                                        ê°€ì¤‘ì¹˜ 30%
                                    </span>
                                </div>
                                <p class="text-gray-400 mb-4">ì‘í’ˆì˜ ì˜ˆìˆ ì„±, ë…ì°½ì„±, ê¸°ìˆ ì  ì™„ì„±ë„ë¥¼ ì¢…í•© í‰ê°€í•©ë‹ˆë‹¤.</p>
                                <div class="grid md:grid-cols-3 gap-4">
                                    <div class="bg-white/5 rounded-xl p-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-palette text-purple-400 mr-2"></i>
                                            <h4 class="font-bold text-white text-sm">ì˜ˆìˆ ì  ì™„ì„±ë„</h4>
                                        </div>
                                        <ul class="text-xs text-gray-400 space-y-1">
                                            <li>â€¢ ë¯¸ì  ì™„ì„±ë„</li>
                                            <li>â€¢ ìƒ‰ì±„ êµ¬ì„±</li>
                                            <li>â€¢ ì¡°í˜• ìš”ì†Œ</li>
                                        </ul>
                                    </div>
                                    <div class="bg-white/5 rounded-xl p-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-lightbulb text-purple-400 mr-2"></i>
                                            <h4 class="font-bold text-white text-sm">ë…ì°½ì„±</h4>
                                        </div>
                                        <ul class="text-xs text-gray-400 space-y-1">
                                            <li>â€¢ ê³ ìœ í•œ ìŠ¤íƒ€ì¼</li>
                                            <li>â€¢ ì°½ì˜ì  í‘œí˜„</li>
                                            <li>â€¢ ìœ ì¼ì„±</li>
                                        </ul>
                                    </div>
                                    <div class="bg-white/5 rounded-xl p-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-tools text-purple-400 mr-2"></i>
                                            <h4 class="font-bold text-white text-sm">ê¸°ìˆ ì  ì™„ì„±ë„</h4>
                                        </div>
                                        <ul class="text-xs text-gray-400 space-y-1">
                                            <li>â€¢ ì œì‘ ê¸°ë²•</li>
                                            <li>â€¢ ê¸°ìˆ ë ¥</li>
                                            <li>â€¢ ì™„ì„±ë„</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ëª¨ë“ˆ 3: ì¸ì¦ (15%) -->
                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-emerald-500 rounded-2xl flex items-center justify-center mr-6 flex-shrink-0">
                                <span class="text-white text-2xl font-black">3</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center mb-4">
                                    <h3 class="text-2xl font-black text-white mr-4">ì¸ì¦</h3>
                                    <span class="px-3 py-1 bg-gradient-to-r from-green-600/30 to-emerald-600/30 text-green-300 rounded-full text-sm font-bold border border-green-500/30">
                                        ê°€ì¤‘ì¹˜ 15%
                                    </span>
                                </div>
                                <p class="text-gray-400 mb-4">ì‘í’ˆì˜ ì§„ìœ„ì„±, ì†Œìœ ê¶Œ, ë¸”ë¡ì²´ì¸ ì¸ì¦ì„ ê²€ì¦í•©ë‹ˆë‹¤.</p>
                                <div class="grid md:grid-cols-3 gap-4">
                                    <div class="bg-white/5 rounded-xl p-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-certificate text-green-400 mr-2"></i>
                                            <h4 class="font-bold text-white text-sm">ì €ì‘ê¶Œ ì¸ì¦</h4>
                                        </div>
                                        <ul class="text-xs text-gray-400 space-y-1">
                                            <li>â€¢ ì €ì‘ê¶Œ ë“±ë¡ì¦</li>
                                            <li>â€¢ ì†Œìœ ê¶Œ ì¦ëª…</li>
                                            <li>â€¢ ì‘ê°€ ì„œëª…</li>
                                        </ul>
                                    </div>
                                    <div class="bg-white/5 rounded-xl p-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-cube text-green-400 mr-2"></i>
                                            <h4 class="font-bold text-white text-sm">ë¸”ë¡ì²´ì¸ ì¸ì¦</h4>
                                        </div>
                                        <ul class="text-xs text-gray-400 space-y-1">
                                            <li>â€¢ NFT ë¯¼íŒ…</li>
                                            <li>â€¢ ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸</li>
                                            <li>â€¢ ê±°ë˜ ê¸°ë¡</li>
                                        </ul>
                                    </div>
                                    <div class="bg-white/5 rounded-xl p-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-shield-alt text-green-400 mr-2"></i>
                                            <h4 class="font-bold text-white text-sm">ì§„ìœ„ì„± ê²€ì¦</h4>
                                        </div>
                                        <ul class="text-xs text-gray-400 space-y-1">
                                            <li>â€¢ ì›ë³¸ í™•ì¸</li>
                                            <li>â€¢ ë³µì œ ì—¬ë¶€</li>
                                            <li>â€¢ ë„ìš© ê²€ì‚¬</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ëª¨ë“ˆ 4: ì „ë¬¸ê°€ í‰ê°€ (20%) -->
                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center mr-6 flex-shrink-0">
                                <span class="text-white text-2xl font-black">4</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center mb-4">
                                    <h3 class="text-2xl font-black text-white mr-4">ì „ë¬¸ê°€ í‰ê°€</h3>
                                    <span class="px-3 py-1 bg-gradient-to-r from-blue-600/30 to-cyan-600/30 text-blue-300 rounded-full text-sm font-bold border border-blue-500/30">
                                        ê°€ì¤‘ì¹˜ 20%
                                    </span>
                                </div>
                                <p class="text-gray-400 mb-4">ê²€ì¦ëœ ì „ë¬¸ê°€ íŒ¨ë„ì˜ ì¢…í•© í‰ê°€ ì ìˆ˜ì…ë‹ˆë‹¤.</p>
                                <div class="grid md:grid-cols-3 gap-4">
                                    <div class="bg-white/5 rounded-xl p-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-user-graduate text-blue-400 mr-2"></i>
                                            <h4 class="font-bold text-white text-sm">ì „ë¬¸ê°€ êµ¬ì„±</h4>
                                        </div>
                                        <ul class="text-xs text-gray-400 space-y-1">
                                            <li>â€¢ ë¯¸ìˆ ì‚¬í•™ì</li>
                                            <li>â€¢ íë ˆì´í„°</li>
                                            <li>â€¢ NFT ì „ë¬¸ê°€</li>
                                        </ul>
                                    </div>
                                    <div class="bg-white/5 rounded-xl p-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-clipboard-check text-blue-400 mr-2"></i>
                                            <h4 class="font-bold text-white text-sm">í‰ê°€ í•­ëª©</h4>
                                        </div>
                                        <ul class="text-xs text-gray-400 space-y-1">
                                            <li>â€¢ ì‘í’ˆì„± í‰ê°€</li>
                                            <li>â€¢ ì‹œì¥ì„± ë¶„ì„</li>
                                            <li>â€¢ íˆ¬ìê°€ì¹˜ ê²€í† </li>
                                        </ul>
                                    </div>
                                    <div class="bg-white/5 rounded-xl p-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-chart-line text-blue-400 mr-2"></i>
                                            <h4 class="font-bold text-white text-sm">ì ìˆ˜ ì‚°ì •</h4>
                                        </div>
                                        <ul class="text-xs text-gray-400 space-y-1">
                                            <li>â€¢ 5ì¸ ì´ìƒ í‰ê°€</li>
                                            <li>â€¢ ê°€ì¤‘ í‰ê· </li>
                                            <li>â€¢ íˆ¬ëª… ê³µê°œ</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ëª¨ë“ˆ 5: ëŒ€ì¤‘ì„± (10%) -->
                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-pink-500 rounded-2xl flex items-center justify-center mr-6 flex-shrink-0">
                                <span class="text-white text-2xl font-black">5</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center mb-4">
                                    <h3 class="text-2xl font-black text-white mr-4">ëŒ€ì¤‘ì„±</h3>
                                    <span class="px-3 py-1 bg-gradient-to-r from-red-600/30 to-pink-600/30 text-red-300 rounded-full text-sm font-bold border border-red-500/30">
                                        ê°€ì¤‘ì¹˜ 10%
                                    </span>
                                </div>
                                <p class="text-gray-400 mb-4">ì‘í’ˆì˜ ëŒ€ì¤‘ì  ì¸ì§€ë„ì™€ ì‹œì¥ ë°˜ì‘ì„ ì¸¡ì •í•©ë‹ˆë‹¤.</p>
                                <div class="grid md:grid-cols-4 gap-4">
                                    <div class="bg-white/5 rounded-xl p-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-eye text-red-400 mr-2"></i>
                                            <h4 class="font-bold text-white text-sm">ì¡°íšŒìˆ˜</h4>
                                        </div>
                                        <ul class="text-xs text-gray-400 space-y-1">
                                            <li>â€¢ í”Œë«í¼ ì¡°íšŒ</li>
                                            <li>â€¢ í˜ì´ì§€ ë·°</li>
                                        </ul>
                                    </div>
                                    <div class="bg-white/5 rounded-xl p-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-heart text-red-400 mr-2"></i>
                                            <h4 class="font-bold text-white text-sm">ì¢‹ì•„ìš”</h4>
                                        </div>
                                        <ul class="text-xs text-gray-400 space-y-1">
                                            <li>â€¢ ì‚¬ìš©ì ë°˜ì‘</li>
                                            <li>â€¢ ì°¸ì—¬ë„</li>
                                        </ul>
                                    </div>
                                    <div class="bg-white/5 rounded-xl p-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-share text-red-400 mr-2"></i>
                                            <h4 class="font-bold text-white text-sm">ê³µìœ </h4>
                                        </div>
                                        <ul class="text-xs text-gray-400 space-y-1">
                                            <li>â€¢ SNS ê³µìœ </li>
                                            <li>â€¢ ì–¸ê¸‰ íšŸìˆ˜</li>
                                        </ul>
                                    </div>
                                    <div class="bg-white/5 rounded-xl p-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-comments text-red-400 mr-2"></i>
                                            <h4 class="font-bold text-white text-sm">ì»¤ë®¤ë‹ˆí‹°</h4>
                                        </div>
                                        <ul class="text-xs text-gray-400 space-y-1">
                                            <li>â€¢ ëŒ“ê¸€/í† ë¡ </li>
                                            <li>â€¢ í™œë°œë„</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ìµœì¢… ê°€ì¹˜ ì‚°ì • ê³µì‹ -->
                <div class="mt-12 card-nft rounded-3xl p-10 bg-gradient-to-br from-purple-900/20 via-pink-900/20 to-red-900/20 border border-purple-500/30">
                    <h3 class="text-3xl font-black text-white mb-6 text-center">
                        <i class="fas fa-calculator text-purple-400 mr-3"></i>
                        ìµœì¢… ê°€ì¹˜ ì‚°ì • ê³µì‹
                    </h3>
                    <div class="bg-black/50 rounded-2xl p-8 mb-6">
                        <div class="text-center font-mono">
                            <div class="text-2xl text-white mb-4 font-bold">
                                ìµœì¢… ê°€ì¹˜ ì ìˆ˜ = 
                            </div>
                            <div class="text-xl text-gray-300 space-y-2">
                                <div><span class="text-amber-400">Î±â‚ Ã— ì‘ê°€ì„±ì·¨ë„</span> <span class="text-gray-500">+</span></div>
                                <div><span class="text-purple-400">Î±â‚‚ Ã— ì‘í’ˆë‚´ìš©</span> <span class="text-gray-500">+</span></div>
                                <div><span class="text-green-400">Î±â‚ƒ Ã— ì¸ì¦</span> <span class="text-gray-500">+</span></div>
                                <div><span class="text-blue-400">Î±â‚„ Ã— ì „ë¬¸ê°€í‰ê°€</span> <span class="text-gray-500">+</span></div>
                                <div><span class="text-red-400">Î±â‚… Ã— ëŒ€ì¤‘ì„±</span></div>
                            </div>
                            <div class="mt-6 text-sm text-gray-400">
                                ì—¬ê¸°ì„œ: Î±â‚ + Î±â‚‚ + Î±â‚ƒ + Î±â‚„ + Î±â‚… = 1.0
                            </div>
                            <div class="mt-2 text-sm text-gray-500">
                                ê¸°ë³¸ê°’: <span class="text-amber-400">Î±â‚=0.25</span>, <span class="text-purple-400">Î±â‚‚=0.30</span>, <span class="text-green-400">Î±â‚ƒ=0.15</span>, <span class="text-blue-400">Î±â‚„=0.20</span>, <span class="text-red-400">Î±â‚…=0.10</span>
                            </div>
                        </div>
                    </div>
                    <p class="text-center text-gray-400 text-sm">
                        ëª¨ë“  ê°€ì¤‘ì¹˜ëŠ” ì „ë¬¸ê°€ íŒ¨ë„ì˜ ê²€í† ë¥¼ ê±°ì³ ì¡°ì •ë  ìˆ˜ ìˆìœ¼ë©°, í‰ê°€ ê³¼ì •ì€ ì™„ì „íˆ íˆ¬ëª…í•˜ê²Œ ê³µê°œë©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>

            <div class="mt-12 text-center">
                <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                    <a href="/mint" class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-green-600 to-emerald-500 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-green-500/50 transition-all">
                        <i class="fas fa-user-tie mr-2"></i>
                        ì „ë¬¸ê°€ ê°€ì¹˜ í‰ê°€
                    </a>
                    <a href="/valuation" class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-purple-600 to-cyan-600 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-purple-500/50 transition-all">
                        <i class="fas fa-calculator mr-2"></i>
                        ì…€í”„ ê°€ì¹˜ í‰ê°€
                    </a>
                </div>
            </div>
        </div>
    </section>
  `;
  return c.html(getLayout(content, 'ê°€ì¹˜ì‚°ì • ì‹œìŠ¤í…œ - GALLERYPIA'))
})

// 4. ë¬¸ì˜í•˜ê¸° í˜ì´ì§€
app.get('/contact', (c) => {
  const content = `
    <section class="py-20">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <div class="inline-block mb-6 px-6 py-2 bg-gradient-to-r from-cyan-600/20 to-blue-600/20 backdrop-blur-sm rounded-full border border-cyan-500/30">
                    <span class="text-gradient font-bold text-sm">ğŸ“§ CONTACT US</span>
                </div>
                <h1 class="text-6xl font-black mb-6">
                    <span class="text-white">ë¬¸ì˜</span> <span class="text-gradient">í•˜ê¸°</span>
                </h1>
                <p class="text-gray-400 text-xl">ê¶ê¸ˆí•˜ì‹  ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€ ì—°ë½ì£¼ì„¸ìš”</p>
            </div>

            <div class="grid md:grid-cols-2 gap-8 mb-12">
                <!-- ì´ë©”ì¼ ì—°ë½ì²˜ -->
                <div class="card-nft rounded-3xl p-8">
                    <div class="flex items-center mb-6">
                        <div class="w-14 h-14 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-envelope text-white text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-black text-white">ì´ë©”ì¼</h2>
                    </div>
                    <p class="text-gray-400 mb-4">ì¼ë°˜ ë¬¸ì˜ ë° ì œíœ´ ë¬¸ì˜</p>
                    <a href="mailto:gallerypia@gmail.com" class="text-gradient font-bold text-xl hover:opacity-80 transition-opacity">
                        gallerypia@gmail.com
                    </a>
                    <p class="text-gray-500 text-sm mt-4">í‰ì¼ 09:00 - 18:00 (ì£¼ë§/ê³µíœ´ì¼ ì œì™¸)</p>
                </div>

                <!-- ì†Œì…œ ë¯¸ë””ì–´ -->
                <div class="card-nft rounded-3xl p-8">
                    <div class="flex items-center mb-6">
                        <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-4">
                            <i class="fas fa-share-alt text-white text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-black text-white">ì†Œì…œ ë¯¸ë””ì–´</h2>
                    </div>
                    <p class="text-gray-400 mb-6">ì†Œì…œ ë¯¸ë””ì–´ë¡œë„ ì†Œí†µí•˜ì„¸ìš”</p>
                    <div class="flex space-x-4">
                        <a href="#" class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center hover:scale-110 transition-transform">
                            <i class="fab fa-twitter text-white text-lg"></i>
                        </a>
                        <a href="#" class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center hover:scale-110 transition-transform">
                            <i class="fab fa-discord text-white text-lg"></i>
                        </a>
                        <a href="#" class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-xl flex items-center justify-center hover:scale-110 transition-transform">
                            <i class="fab fa-telegram text-white text-lg"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- ë¬¸ì˜ í¼ -->
            <div class="card-nft rounded-3xl p-10">
                <h2 class="text-3xl font-black text-white mb-8 text-center">ë¹ ë¥¸ ë¬¸ì˜ ì–‘ì‹</h2>
                <form class="space-y-6" onsubmit="handleContactSubmit(event)">
                    <div>
                        <label class="block text-sm font-bold text-gray-300 mb-2">ì´ë¦„ *</label>
                        <input type="text" name="name" required 
                               class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-300 mb-2">ì´ë©”ì¼ *</label>
                        <input type="email" name="email" required 
                               class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-300 mb-2">ë¬¸ì˜ ìœ í˜•</label>
                        <select name="type" 
                                class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-xl text-white focus:outline-none focus:border-purple-500 transition-colors">
                            <option value="general">ì¼ë°˜ ë¬¸ì˜</option>
                            <option value="technical">ê¸°ìˆ  ì§€ì›</option>
                            <option value="partnership">ì œíœ´ ë¬¸ì˜</option>
                            <option value="artist">ì•„í‹°ìŠ¤íŠ¸ ë¬¸ì˜</option>
                            <option value="expert">ì „ë¬¸ê°€ ì‹ ì²­</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-300 mb-2">ì œëª© *</label>
                        <input type="text" name="subject" required 
                               class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-300 mb-2">ë¬¸ì˜ ë‚´ìš© *</label>
                        <textarea name="message" required rows="6"
                                  class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition-colors resize-none"></textarea>
                    </div>
                    <button type="submit" 
                            class="w-full px-8 py-4 bg-gradient-to-r from-cyan-600 to-blue-500 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-cyan-500/50 transition-all">
                        <i class="fas fa-paper-plane mr-2"></i>
                        ë¬¸ì˜ ë³´ë‚´ê¸°
                    </button>
                </form>
            </div>

            <div class="mt-12 text-center">
                <p class="text-gray-400 text-sm">
                    * ë¬¸ì˜í•˜ì‹  ë‚´ìš©ì€ gallerypia@gmail.comìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤<br/>
                    ì˜ì—…ì¼ ê¸°ì¤€ 1-2ì¼ ë‚´ì— ë‹µë³€ ë“œë¦¬ê² ìŠµë‹ˆë‹¤
                </p>
            </div>
        </div>
    </section>

    <script>
      function handleContactSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        
        const name = formData.get('name');
        const email = formData.get('email');
        const type = formData.get('type');
        const subject = formData.get('subject');
        const message = formData.get('message');
        
        // ì´ë©”ì¼ í´ë¼ì´ì–¸íŠ¸ë¡œ mailto ë§í¬ ìƒì„±
        const mailtoLink = \`mailto:gallerypia@gmail.com?subject=[\${type}] \${subject}&body=ì´ë¦„: \${name}%0D%0Aì´ë©”ì¼: \${email}%0D%0A%0D%0A\${message}\`;
        
        window.location.href = mailtoLink;
        
        alert('ì´ë©”ì¼ í´ë¼ì´ì–¸íŠ¸ê°€ ì—´ë¦½ë‹ˆë‹¤. ì´ë©”ì¼ì„ ì „ì†¡í•´ì£¼ì„¸ìš”.');
      }
    </script>
  `;
  return c.html(getLayout(content, 'ë¬¸ì˜í•˜ê¸° - GALLERYPIA'))
})

// 5. ê°œì¸ì •ë³´ë³´í˜¸ í˜ì´ì§€
app.get('/privacy', (c) => {
  const content = `
    <section class="py-20">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <div class="inline-block mb-6 px-6 py-2 bg-gradient-to-r from-emerald-600/20 to-green-600/20 backdrop-blur-sm rounded-full border border-emerald-500/30">
                    <span class="text-gradient font-bold text-sm">ğŸ”’ PRIVACY POLICY</span>
                </div>
                <h1 class="text-6xl font-black mb-6">
                    <span class="text-white">ê°œì¸ì •ë³´</span> <span class="text-gradient">ë³´í˜¸ì •ì±…</span>
                </h1>
                <p class="text-gray-400 text-xl">GALLERYPIA ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</p>
                <p class="text-gray-500 text-sm mt-2">ìµœì¢… ì—…ë°ì´íŠ¸: 2025ë…„ 1ì›” 1ì¼</p>
            </div>

            <div class="space-y-8">
                <div class="card-nft rounded-3xl p-8">
                    <h2 class="text-2xl font-black text-white mb-4 flex items-center">
                        <i class="fas fa-info-circle text-blue-400 mr-3"></i>
                        1. ê°œì¸ì •ë³´ ìˆ˜ì§‘ í•­ëª©
                    </h2>
                    <div class="text-gray-300 space-y-3">
                        <p><strong>í•„ìˆ˜ ìˆ˜ì§‘ í•­ëª©:</strong></p>
                        <ul class="list-disc list-inside ml-4 space-y-2">
                            <li>ì´ë©”ì¼ ì£¼ì†Œ, ì‚¬ìš©ìëª…, ë¹„ë°€ë²ˆí˜¸</li>
                            <li>ì´ë¦„, ì—°ë½ì²˜ (ì „ë¬¸ê°€/ì•„í‹°ìŠ¤íŠ¸ì˜ ê²½ìš°)</li>
                            <li>ì§€ê°‘ ì£¼ì†Œ (MetaMask ì—°ë™ ì‹œ)</li>
                        </ul>
                        <p class="mt-4"><strong>ì„ íƒ ìˆ˜ì§‘ í•­ëª©:</strong></p>
                        <ul class="list-disc list-inside ml-4 space-y-2">
                            <li>í”„ë¡œí•„ ì‚¬ì§„, ìê¸°ì†Œê°œ</li>
                            <li>ì‘í’ˆ í¬íŠ¸í´ë¦¬ì˜¤ (ì•„í‹°ìŠ¤íŠ¸)</li>
                            <li>ì „ë¬¸ ë¶„ì•¼ ë° ê²½ë ¥ (ì „ë¬¸ê°€)</li>
                        </ul>
                    </div>
                </div>

                <div class="card-nft rounded-3xl p-8">
                    <h2 class="text-2xl font-black text-white mb-4 flex items-center">
                        <i class="fas fa-shield-alt text-green-400 mr-3"></i>
                        2. ê°œì¸ì •ë³´ ì´ìš© ëª©ì 
                    </h2>
                    <div class="text-gray-300 space-y-3">
                        <ul class="list-disc list-inside space-y-2">
                            <li>íšŒì› ê°€ì… ë° ê´€ë¦¬, ë³¸ì¸ í™•ì¸</li>
                            <li>NFT ì‘í’ˆ ë“±ë¡ ë° ê±°ë˜ ì„œë¹„ìŠ¤ ì œê³µ</li>
                            <li>ì „ë¬¸ê°€ í‰ê°€ ë° ê°€ì¹˜ì‚°ì • ì„œë¹„ìŠ¤</li>
                            <li>í”Œë«í¼ ì´ìš© í†µê³„ ë° ì„œë¹„ìŠ¤ ê°œì„ </li>
                            <li>ê³µì§€ì‚¬í•­ ì „ë‹¬ ë° ê³ ê° ë¬¸ì˜ ì‘ëŒ€</li>
                        </ul>
                    </div>
                </div>

                <div class="card-nft rounded-3xl p-8">
                    <h2 class="text-2xl font-black text-white mb-4 flex items-center">
                        <i class="fas fa-clock text-purple-400 mr-3"></i>
                        3. ê°œì¸ì •ë³´ ë³´ìœ  ê¸°ê°„
                    </h2>
                    <div class="text-gray-300 space-y-3">
                        <ul class="list-disc list-inside space-y-2">
                            <li><strong>íšŒì› ì •ë³´</strong>: íšŒì› íƒˆí‡´ ì‹œê¹Œì§€</li>
                            <li><strong>ê±°ë˜ ë‚´ì—­</strong>: ê´€ë ¨ ë²•ë ¹ì— ë”°ë¼ 5ë…„ ë³´ê´€</li>
                            <li><strong>í‰ê°€ ë°ì´í„°</strong>: ì˜êµ¬ ë³´ê´€ (ë¸”ë¡ì²´ì¸ ê¸°ë¡)</li>
                            <li><strong>ë°©ë¬¸ ê¸°ë¡</strong>: 3ê°œì›”</li>
                        </ul>
                    </div>
                </div>

                <div class="card-nft rounded-3xl p-8">
                    <h2 class="text-2xl font-black text-white mb-4 flex items-center">
                        <i class="fas fa-lock text-amber-400 mr-3"></i>
                        4. ê°œì¸ì •ë³´ ë³´í˜¸ ì¡°ì¹˜
                    </h2>
                    <div class="text-gray-300 space-y-3">
                        <ul class="list-disc list-inside space-y-2">
                            <li>ë¹„ë°€ë²ˆí˜¸ëŠ” ì•”í˜¸í™”í•˜ì—¬ ì €ì¥ ë° ê´€ë¦¬</li>
                            <li>í•´í‚¹ ë“±ì— ëŒ€ë¹„í•œ ë³´ì•ˆ ì‹œìŠ¤í…œ ìš´ì˜</li>
                            <li>ê°œì¸ì •ë³´ ì·¨ê¸‰ ì§ì›ì˜ ìµœì†Œí™” ë° êµìœ¡</li>
                            <li>ë¸”ë¡ì²´ì¸ ê¸°ë°˜ ê±°ë˜ ë°ì´í„° ë³´í˜¸</li>
                            <li>ì •ê¸°ì ì¸ ë³´ì•ˆ ê°ì‚¬ ì‹¤ì‹œ</li>
                        </ul>
                    </div>
                </div>

                <div class="card-nft rounded-3xl p-8">
                    <h2 class="text-2xl font-black text-white mb-4 flex items-center">
                        <i class="fas fa-user-check text-cyan-400 mr-3"></i>
                        5. ì´ìš©ìì˜ ê¶Œë¦¬
                    </h2>
                    <div class="text-gray-300 space-y-3">
                        <p>ì´ìš©ìëŠ” ë‹¤ìŒì˜ ê¶Œë¦¬ë¥¼ í–‰ì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:</p>
                        <ul class="list-disc list-inside space-y-2">
                            <li>ê°œì¸ì •ë³´ ì—´ëŒ ìš”êµ¬</li>
                            <li>ê°œì¸ì •ë³´ ì •ì • ë° ì‚­ì œ ìš”êµ¬</li>
                            <li>ê°œì¸ì •ë³´ ì²˜ë¦¬ ì •ì§€ ìš”êµ¬</li>
                            <li>ë™ì˜ ì² íšŒ (íšŒì› íƒˆí‡´)</li>
                        </ul>
                        <p class="mt-4">ê¶Œë¦¬ í–‰ì‚¬ëŠ” <a href="/contact" class="text-gradient font-bold hover:opacity-80">ë¬¸ì˜í•˜ê¸°</a>ë¥¼ í†µí•´ ìš”ì²­í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>

                <div class="card-nft rounded-3xl p-8">
                    <h2 class="text-2xl font-black text-white mb-4 flex items-center">
                        <i class="fas fa-cookie-bite text-orange-400 mr-3"></i>
                        6. ì¿ í‚¤ ì‚¬ìš©
                    </h2>
                    <div class="text-gray-300 space-y-3">
                        <p>GALLERYPIAëŠ” ë‹¤ìŒì˜ ëª©ì ìœ¼ë¡œ ì¿ í‚¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:</p>
                        <ul class="list-disc list-inside space-y-2">
                            <li>ë¡œê·¸ì¸ ì„¸ì…˜ ìœ ì§€</li>
                            <li>ì‚¬ìš©ì ë§ì¶¤ ì½˜í…ì¸  ì œê³µ</li>
                            <li>ì ‘ì† ë¹ˆë„ ë° ë°©ë¬¸ ì‹œê°„ ë¶„ì„</li>
                        </ul>
                        <p class="mt-4">ë¸Œë¼ìš°ì € ì„¤ì •ì„ í†µí•´ ì¿ í‚¤ ì €ì¥ì„ ê±°ë¶€í•  ìˆ˜ ìˆìœ¼ë‚˜, ì¼ë¶€ ì„œë¹„ìŠ¤ ì´ìš©ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>

                <div class="card-nft rounded-3xl p-8 border-2 border-purple-500/30">
                    <h2 class="text-2xl font-black text-white mb-4 flex items-center">
                        <i class="fas fa-phone text-purple-400 mr-3"></i>
                        ê°œì¸ì •ë³´ ë³´í˜¸ ì±…ì„ì
                    </h2>
                    <div class="text-gray-300">
                        <p><strong>ë‹´ë‹¹ì</strong>: Hyunwoo Nam Professor</p>
                        <p><strong>ì´ë©”ì¼</strong>: <a href="mailto:gallerypia@gmail.com" class="text-gradient font-bold">gallerypia@gmail.com</a></p>
                        <p class="mt-4 text-sm text-gray-400">
                            ê°œì¸ì •ë³´ ë³´í˜¸ì™€ ê´€ë ¨í•˜ì—¬ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ìœ„ ì—°ë½ì²˜ë¡œ ì—°ë½ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
            </div>

            <div class="mt-12 text-center">
                <p class="text-gray-500 text-sm">
                    ë³¸ ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ì€ ë²•ë ¹ ë° ì •ì±… ë³€ê²½ì— ë”°ë¼ ë³€ê²½ë  ìˆ˜ ìˆìœ¼ë©°,<br/>
                    ë³€ê²½ ì‹œ ì›¹ì‚¬ì´íŠ¸ë¥¼ í†µí•´ ê³µì§€í•˜ê² ìŠµë‹ˆë‹¤.
                </p>
            </div>
        </div>
    </section>
  `;
  return c.html(getLayout(content, 'ê°œì¸ì •ë³´ë³´í˜¸ì •ì±… - GALLERYPIA'))
})

// 6. ì‚¬ì´íŠ¸ ì´ìš©í•˜ê¸° í˜ì´ì§€
app.get('/usage-guide', (c) => {
  const content = `
    <section class="py-20">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <div class="inline-block mb-6 px-6 py-2 bg-gradient-to-r from-pink-600/20 to-purple-600/20 backdrop-blur-sm rounded-full border border-pink-500/30">
                    <span class="text-gradient font-bold text-sm">ğŸ“– USER GUIDE</span>
                </div>
                <h1 class="text-6xl font-black mb-6">
                    <span class="text-white">ì‚¬ì´íŠ¸</span> <span class="text-gradient">ì´ìš©í•˜ê¸°</span>
                </h1>
                <p class="text-gray-400 text-xl">GALLERYPIAë¥¼ ì²˜ìŒ ì´ìš©í•˜ì‹œë‚˜ìš”? ë‹¨ê³„ë³„ ê°€ì´ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
            </div>

            <!-- ì‚¬ìš©ì ìœ í˜•ë³„ ê°€ì´ë“œ -->
            <div class="grid md:grid-cols-3 gap-6 mb-16">
                <button onclick="showGuide('buyer')" id="guide-buyer-btn" class="guide-type-btn active">
                    <i class="fas fa-shopping-cart text-3xl mb-3"></i>
                    <h3 class="font-bold text-lg">êµ¬ë§¤ì</h3>
                </button>
                <button onclick="showGuide('artist')" id="guide-artist-btn" class="guide-type-btn">
                    <i class="fas fa-palette text-3xl mb-3"></i>
                    <h3 class="font-bold text-lg">ì•„í‹°ìŠ¤íŠ¸</h3>
                </button>
                <button onclick="showGuide('expert')" id="guide-expert-btn" class="guide-type-btn">
                    <i class="fas fa-user-tie text-3xl mb-3"></i>
                    <h3 class="font-bold text-lg">ì „ë¬¸ê°€</h3>
                </button>
            </div>

            <!-- êµ¬ë§¤ì ê°€ì´ë“œ -->
            <div id="guide-buyer" class="guide-content">
                <div class="space-y-6">
                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">1</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">íšŒì›ê°€ì… ë° ì§€ê°‘ ì—°ê²°</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>â€¢ <a href="/signup" class="text-gradient font-bold hover:opacity-80">íšŒì›ê°€ì…</a> í˜ì´ì§€ì—ì„œ ê³„ì •ì„ ìƒì„±í•˜ì„¸ìš”</li>
                                    <li>â€¢ MetaMask ì§€ê°‘ì„ ì„¤ì¹˜í•˜ê³  ì—°ê²°í•˜ì„¸ìš”</li>
                                    <li>â€¢ í”„ë¡œí•„ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ê´€ì‹¬ ì¹´í…Œê³ ë¦¬ë¥¼ ì„¤ì •í•˜ì„¸ìš”</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">2</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">NFT ì‘í’ˆ íƒìƒ‰</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>â€¢ <a href="/gallery" class="text-gradient font-bold hover:opacity-80">ê°¤ëŸ¬ë¦¬</a>ì—ì„œ ë‹¤ì–‘í•œ NFT ì‘í’ˆì„ ë‘˜ëŸ¬ë³´ì„¸ìš”</li>
                                    <li>â€¢ ì¹´í…Œê³ ë¦¬, ê°€ê²©ëŒ€, ì•„í‹°ìŠ¤íŠ¸ë³„ë¡œ í•„í„°ë§í•˜ì„¸ìš”</li>
                                    <li>â€¢ ì‘í’ˆ ìƒì„¸ í˜ì´ì§€ì—ì„œ ê°€ì¹˜ì‚°ì • ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”</li>
                                    <li>â€¢ ê´€ì‹¬ ìˆëŠ” ì‘í’ˆì€ ì¢‹ì•„ìš”ë¡œ ì €ì¥í•˜ì„¸ìš”</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">3</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">NFT êµ¬ë§¤í•˜ê¸°</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>â€¢ êµ¬ë§¤í•˜ê³  ì‹¶ì€ ì‘í’ˆì˜ "êµ¬ë§¤í•˜ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</li>
                                    <li>â€¢ MetaMask ì§€ê°‘ì—ì„œ ê±°ë˜ë¥¼ ìŠ¹ì¸í•˜ì„¸ìš”</li>
                                    <li>â€¢ ë¸”ë¡ì²´ì¸ì— ê¸°ë¡ë˜ë©´ NFTê°€ ì§€ê°‘ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤</li>
                                    <li>â€¢ <a href="/mypage" class="text-gradient font-bold hover:opacity-80">ë§ˆì´í˜ì´ì§€</a>ì—ì„œ ë³´ìœ  NFTë¥¼ í™•ì¸í•˜ì„¸ìš”</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì•„í‹°ìŠ¤íŠ¸ ê°€ì´ë“œ -->
            <div id="guide-artist" class="guide-content" style="display: none;">
                <div class="space-y-6">
                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">1</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">ì•„í‹°ìŠ¤íŠ¸ ê³„ì • ìƒì„±</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>â€¢ <a href="/signup" class="text-gradient font-bold hover:opacity-80">íšŒì›ê°€ì…</a> ì‹œ "ì•„í‹°ìŠ¤íŠ¸" ì—­í• ì„ ì„ íƒí•˜ì„¸ìš”</li>
                                    <li>â€¢ í”„ë¡œí•„ì— í¬íŠ¸í´ë¦¬ì˜¤ì™€ ê²½ë ¥ì„ ìƒì„¸íˆ ì…ë ¥í•˜ì„¸ìš”</li>
                                    <li>â€¢ ì•„í‹°ìŠ¤íŠ¸ ì¸ì¦ì„ ìœ„í•´ í•„ìš”í•œ ì„œë¥˜ë¥¼ ì œì¶œí•˜ì„¸ìš”</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">2</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">ì‘í’ˆ ì—…ë¡œë“œ ë° NFT ë¯¼íŒ…</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>â€¢ <a href="/mint" class="text-gradient font-bold hover:opacity-80">NFT ë¯¼íŒ…</a> í˜ì´ì§€ë¡œ ì´ë™í•˜ì„¸ìš”</li>
                                    <li>â€¢ ì‘í’ˆ ì´ë¯¸ì§€ (PNG, JPG, GIF, ìµœëŒ€ 50MB)ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</li>
                                    <li>â€¢ ì‘í’ˆëª…, ì„¤ëª…, ì¹´í…Œê³ ë¦¬, ì—ë””ì…˜ ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”</li>
                                    <li>â€¢ ê°€ì¹˜ì‚°ì •ì„ ì‹ ì²­í•˜ê³  ì „ë¬¸ê°€ í‰ê°€ë¥¼ ê¸°ë‹¤ë¦¬ì„¸ìš”</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">3</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">ì•„í‹°ìŠ¤íŠ¸ ë­í‚¹ ê´€ë¦¬</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>â€¢ <a href="/mypage" class="text-gradient font-bold hover:opacity-80">ë§ˆì´í˜ì´ì§€</a>ì—ì„œ ê²½ë ¥ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</li>
                                    <li>â€¢ ì „ì‹œíšŒ, ìˆ˜ìƒ, ì €ì‘ê¶Œ, íë ˆì´ì…˜ ê²½ë ¥ì„ ì¶”ê°€í•˜ì„¸ìš”</li>
                                    <li>â€¢ ê²½ë ¥ ì¶”ê°€ ì‹œ ì¦ë¹™ ìë£Œë¥¼ ì²¨ë¶€í•˜ì„¸ìš”</li>
                                    <li>â€¢ <a href="/leaderboard" class="text-gradient font-bold hover:opacity-80">ë­í‚¹</a> í˜ì´ì§€ì—ì„œ ë‚˜ì˜ ìˆœìœ„ë¥¼ í™•ì¸í•˜ì„¸ìš”</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">4</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">ì‘í’ˆ íŒë§¤ ë° ìˆ˜ìµ ê´€ë¦¬</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>â€¢ ì‘í’ˆì´ íŒë§¤ë˜ë©´ ìë™ìœ¼ë¡œ ì§€ê°‘ì— ìˆ˜ìµì´ ì…ê¸ˆë©ë‹ˆë‹¤</li>
                                    <li>â€¢ 2ì°¨ íŒë§¤ ì‹œ ë¡œì—´í‹° (5-10%)ë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                                    <li>â€¢ ë§ˆì´í˜ì´ì§€ì—ì„œ íŒë§¤ ë‚´ì—­ì„ í™•ì¸í•˜ì„¸ìš”</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì „ë¬¸ê°€ ê°€ì´ë“œ -->
            <div id="guide-expert" class="guide-content" style="display: none;">
                <div class="space-y-6">
                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">1</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">ì „ë¬¸ê°€ ì‹ ì²­</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>â€¢ <a href="/expert/apply" class="text-gradient font-bold hover:opacity-80">ì „ë¬¸ê°€ ì‹ ì²­</a> í˜ì´ì§€ì—ì„œ ì§€ì›í•˜ì„¸ìš”</li>
                                    <li>â€¢ ì „ë¬¸ ë¶„ì•¼ (ë¯¸ìˆ ì‚¬, íë ˆì´í„°, NFT ì „ë¬¸ê°€ ë“±)ë¥¼ ì„ íƒí•˜ì„¸ìš”</li>
                                    <li>â€¢ ê²½ë ¥ ë° ìê²©ì¦ëª…ì„ ì œì¶œí•˜ì„¸ìš”</li>
                                    <li>â€¢ ì‹¬ì‚¬ í›„ ìŠ¹ì¸ë˜ë©´ í‰ê°€ íŒ¨ë„ì— í•©ë¥˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">2</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">ì‘í’ˆ í‰ê°€í•˜ê¸°</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>â€¢ ì „ë¬¸ê°€ ëŒ€ì‹œë³´ë“œì—ì„œ í‰ê°€ ëŒ€ê¸° ì¤‘ì¸ ì‘í’ˆì„ í™•ì¸í•˜ì„¸ìš”</li>
                                    <li>â€¢ 8ê°€ì§€ í‰ê°€ ê¸°ì¤€ (ë‚´ìš©ì„±, í‘œí˜„ì„±, ë…ì°½ì„± ë“±)ì— ë”°ë¼ ì ìˆ˜ë¥¼ ë¶€ì—¬í•˜ì„¸ìš”</li>
                                    <li>â€¢ ìƒì„¸í•œ í‰ê°€ ì½”ë©˜íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”</li>
                                    <li>â€¢ í‰ê°€ ì™„ë£Œ ì‹œ ë¦¬ì›Œë“œë¥¼ ë°›ìŠµë‹ˆë‹¤</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="card-nft rounded-3xl p-8">
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white text-xl font-black">3</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-black text-white mb-3">ì „ë¬¸ê°€ ë“±ê¸‰ ê´€ë¦¬</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li>â€¢ ì •í™•í•˜ê³  ê³µì •í•œ í‰ê°€ë¥¼ í†µí•´ ì „ë¬¸ê°€ ë“±ê¸‰ì´ ìƒìŠ¹í•©ë‹ˆë‹¤</li>
                                    <li>â€¢ ë†’ì€ ë“±ê¸‰ì˜ ì „ë¬¸ê°€ëŠ” ë” ë§ì€ í‰ê°€ ê¸°íšŒë¥¼ ë°›ìŠµë‹ˆë‹¤</li>
                                    <li>â€¢ í‰ê°€ í’ˆì§ˆì´ ë‚®ìœ¼ë©´ ë“±ê¸‰ì´ í•˜ë½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì¶”ê°€ ë„ì›€ë§ -->
            <div class="mt-16 card-nft rounded-3xl p-10">
                <h2 class="text-3xl font-black text-white mb-6 text-center">
                    <i class="fas fa-lightbulb text-yellow-400 mr-3"></i>
                    ìœ ìš©í•œ íŒ
                </h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="flex items-start">
                        <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                        <div>
                            <h4 class="font-bold text-white mb-2">MetaMask ê°€ìŠ¤ë¹„</h4>
                            <p class="text-gray-400 text-sm">ê±°ë˜ ì‹œ ê°€ìŠ¤ë¹„ê°€ ë°œìƒí•©ë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ í˜¼ì¡ë„ì— ë”°ë¼ ë³€ë™ë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                        <div>
                            <h4 class="font-bold text-white mb-2">ì‘í’ˆ ë°±ì—…</h4>
                            <p class="text-gray-400 text-sm">ì›ë³¸ ì‘í’ˆ íŒŒì¼ì€ í•­ìƒ ë³„ë„ë¡œ ë°±ì—…í•´ë‘ì„¸ìš”.</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                        <div>
                            <h4 class="font-bold text-white mb-2">ì €ì‘ê¶Œ ì£¼ì˜</h4>
                            <p class="text-gray-400 text-sm">ë³¸ì¸ì´ ì§ì ‘ ì°½ì‘í•œ ì‘í’ˆë§Œ NFTë¡œ ë¯¼íŒ…í•˜ì„¸ìš”.</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                        <div>
                            <h4 class="font-bold text-white mb-2">íˆ¬ì ì£¼ì˜</h4>
                            <p class="text-gray-400 text-sm">NFT ê°€ê²©ì€ ë³€ë™ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‹ ì¤‘í•˜ê²Œ íˆ¬ìí•˜ì„¸ìš”.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-12 text-center">
                <p class="text-gray-400 mb-6">ë” ê¶ê¸ˆí•œ ì‚¬í•­ì´ ìˆìœ¼ì‹ ê°€ìš”?</p>
                <div class="flex justify-center gap-4">
                    <a href="/help" class="px-8 py-4 bg-gradient-to-r from-purple-600 to-pink-500 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-purple-500/50 transition-all">
                        <i class="fas fa-question-circle mr-2"></i>
                        ë„ì›€ë§ ë³´ê¸°
                    </a>
                    <a href="/contact" class="px-8 py-4 bg-gradient-to-r from-cyan-600 to-blue-500 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-cyan-500/50 transition-all">
                        <i class="fas fa-envelope mr-2"></i>
                        ë¬¸ì˜í•˜ê¸°
                    </a>
                </div>
            </div>
        </div>
    </section>

    <style>
      .guide-type-btn {
        padding: 2rem;
        background: linear-gradient(145deg, #1a1a1a 0%, #0a0a0a 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 1.5rem;
        color: #9ca3af;
        transition: all 0.3s ease;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      
      .guide-type-btn:hover {
        border-color: rgba(139, 92, 246, 0.5);
        transform: translateY(-4px);
        box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);
      }
      
      .guide-type-btn.active {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(6, 182, 212, 0.2) 100%);
        border-color: rgba(139, 92, 246, 0.5);
        color: white;
      }
    </style>

    <script>
      function showGuide(type) {
        // Hide all guides
        document.querySelectorAll('.guide-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.guide-type-btn').forEach(el => el.classList.remove('active'));
        
        // Show selected guide
        document.getElementById('guide-' + type).style.display = 'block';
        document.getElementById('guide-' + type + '-btn').classList.add('active');
      }
    </script>
  `;
  return c.html(getLayout(content, 'ì‚¬ì´íŠ¸ ì´ìš©í•˜ê¸° - GALLERYPIA'))
})

// 7. NFT ì•„ì¹´ë°ë¯¸ í˜ì´ì§€ - ìƒˆë¡œìš´ ì•„ì¹´ë°ë¯¸ í˜ì´ì§€ë¡œ redirect
// Academy page route
// Note: In production (Cloudflare Pages), /academy.html will be served automatically
// For local development, temporarily redirect to home
// NFT ì•„ì¹´ë°ë¯¸ í˜ì´ì§€ (ì •ì  HTML ì„œë¹™)
app.get('/nft-academy', async (c) => {
  try {
    const html = await c.env.ASSETS.fetch('https://placeholder.com/academy.html')
    return html
  } catch (error) {
    // Fallback: ì•„ì¹´ë°ë¯¸ í˜ì´ì§€ë¥¼ ì§ì ‘ ë Œë”ë§
    return c.html(`
      <!DOCTYPE html>
      <html lang="ko">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>NFT ì•„ì¹´ë°ë¯¸ - GALLERYPIA</title>
        <script>
          // Redirect to static academy.html
          window.location.href = '/academy.html';
        </script>
      </head>
      <body>
        <p>í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </body>
      </html>
    `)
  }
})

// ============================================
// ê±°ë˜ ì‹œìŠ¤í…œ API (Trading & Marketplace)
// ============================================

// í—¬í¼ í•¨ìˆ˜: í”Œë«í¼ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
async function getPlatformSettings(db: D1Database) {
  const settings = await db.prepare(`
    SELECT setting_key, setting_value, setting_type 
    FROM platform_settings
  `).all();
  
  const config: Record<string, any> = {};
  settings.results.forEach((s: any) => {
    const key = s.setting_key;
    const value = s.setting_value;
    const type = s.setting_type;
    
    if (type === 'number') {
      config[key] = parseFloat(value);
    } else if (type === 'boolean') {
      config[key] = value === 'true';
    } else {
      config[key] = value;
    }
  });
  
  return config;
}

// 1. ì‘í’ˆ ë¦¬ìŠ¤íŒ… ìƒì„± (íŒë§¤ ë“±ë¡)
app.post('/api/marketplace/listings', async (c) => {
  const { env } = c;
  const userId = c.get('userId');
  if (!userId) {
    return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401);
  }

  try {
    const { artwork_id, listing_type, price_eth, auction_start_price_eth, auction_reserve_price_eth, auction_duration_hours } = await c.req.json();

    // ì‘í’ˆ ì†Œìœ ê¶Œ í™•ì¸
    const ownership = await env.DB.prepare(`
      SELECT user_id FROM artwork_ownership 
      WHERE artwork_id = ? AND user_id = ? AND is_current_owner = 1
    `).bind(artwork_id, userId).first();

    if (!ownership) {
      return c.json({ error: 'ì´ ì‘í’ˆì˜ ì†Œìœ ìê°€ ì•„ë‹™ë‹ˆë‹¤' }, 403);
    }

    // í”Œë«í¼ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
    const settings = await getPlatformSettings(env.DB);
    
    // ê°€ê²© ê²€ì¦
    if (listing_type === 'fixed_price' && price_eth < settings.minimum_price_eth) {
      return c.json({ error: `ìµœì†Œ ê°€ê²©ì€ ${settings.minimum_price_eth} ETHì…ë‹ˆë‹¤` }, 400);
    }

    // ë¦¬ìŠ¤íŒ… ìƒì„±
    const auctionEndTime = listing_type === 'auction' 
      ? new Date(Date.now() + (auction_duration_hours || 24) * 60 * 60 * 1000).toISOString()
      : null;

    const result = await env.DB.prepare(`
      INSERT INTO artwork_listings 
      (artwork_id, seller_id, listing_type, price_eth, auction_start_price_eth, 
       auction_reserve_price_eth, auction_end_time, status)
      VALUES (?, ?, ?, ?, ?, ?, ?, 'active')
    `).bind(
      artwork_id, userId, listing_type, 
      listing_type === 'fixed_price' ? price_eth : null,
      listing_type === 'auction' ? auction_start_price_eth : null,
      listing_type === 'auction' ? auction_reserve_price_eth : null,
      auctionEndTime
    ).run();

    // ì‘í’ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
    await env.DB.prepare(`
      UPDATE artworks 
      SET is_listed = 1, current_price_eth = ? 
      WHERE id = ?
    `).bind(price_eth || auction_start_price_eth, artwork_id).run();

    return c.json({ 
      success: true, 
      listing_id: result.meta.last_row_id,
      message: 'ì‘í’ˆì´ íŒë§¤ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤'
    });
  } catch (error: any) {
    console.error('Listing creation error:', error);
    return c.json({ error: 'ë¦¬ìŠ¤íŒ… ìƒì„± ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 2. ë¦¬ìŠ¤íŒ… ëª©ë¡ ì¡°íšŒ
app.get('/api/marketplace/listings', async (c) => {
  const { env } = c;
  const status = c.req.query('status') || 'active';
  const listing_type = c.req.query('type');
  const page = parseInt(c.req.query('page') || '1');
  const limit = parseInt(c.req.query('limit') || '20');
  const offset = (page - 1) * limit;

  try {
    let query = `
      SELECT 
        l.*,
        a.title AS artwork_title,
        a.image_url AS artwork_image,
        a.category AS artwork_category,
        u.username AS seller_username,
        u.full_name AS seller_name
      FROM artwork_listings l
      JOIN artworks a ON l.artwork_id = a.id
      JOIN users u ON l.seller_id = u.id
      WHERE l.status = ?
    `;
    
    const bindings: any[] = [status];
    
    if (listing_type) {
      query += ` AND l.listing_type = ?`;
      bindings.push(listing_type);
    }
    
    query += ` ORDER BY l.created_at DESC LIMIT ? OFFSET ?`;
    bindings.push(limit, offset);

    const listings = await env.DB.prepare(query).bind(...bindings).all();
    
    return c.json({
      listings: listings.results,
      pagination: {
        page,
        limit,
        total: listings.results.length
      }
    });
  } catch (error: any) {
    console.error('Listings fetch error:', error);
    return c.json({ error: 'ë¦¬ìŠ¤íŒ… ì¡°íšŒ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 3. ì‘í’ˆ ì§ì ‘ êµ¬ë§¤
app.post('/api/marketplace/purchase', async (c) => {
  const { env } = c;
  const userId = c.get('userId');
  if (!userId) {
    return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401);
  }

  try {
    const { listing_id } = await c.req.json();

    // ë¦¬ìŠ¤íŒ… ì •ë³´ ì¡°íšŒ
    const listing = await env.DB.prepare(`
      SELECT l.*, a.artist_id 
      FROM artwork_listings l
      JOIN artworks a ON l.artwork_id = a.id
      WHERE l.id = ? AND l.status = 'active' AND l.listing_type = 'fixed_price'
    `).bind(listing_id).first();

    if (!listing) {
      return c.json({ error: 'ìœ íš¨í•˜ì§€ ì•Šì€ ë¦¬ìŠ¤íŒ…ì…ë‹ˆë‹¤' }, 404);
    }

    if (listing.seller_id === userId) {
      return c.json({ error: 'ìì‹ ì˜ ì‘í’ˆì€ êµ¬ë§¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 400);
    }

    // í”Œë«í¼ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
    const settings = await getPlatformSettings(env.DB);
    
    const salePrice = listing.price_eth;
    const platformFee = salePrice * (settings.platform_fee_percentage / 100);
    const creatorRoyalty = salePrice * (settings.creator_royalty_percentage / 100);
    const sellerReceive = salePrice - platformFee - creatorRoyalty;

    // ê±°ë˜ ê¸°ë¡ ìƒì„±
    const txResult = await env.DB.prepare(`
      INSERT INTO nft_transactions 
      (artwork_id, listing_id, seller_id, buyer_id, sale_price_eth, 
       platform_fee_eth, creator_royalty_eth, seller_receive_eth, 
       transaction_type, status, confirmed_at)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'direct_sale', 'confirmed', CURRENT_TIMESTAMP)
    `).bind(
      listing.artwork_id, listing_id, listing.seller_id, userId,
      salePrice, platformFee, creatorRoyalty, sellerReceive
    ).run();

    const transactionId = txResult.meta.last_row_id;

    // í”Œë«í¼ ìˆ˜ìµ ê¸°ë¡
    await env.DB.prepare(`
      INSERT INTO platform_revenue 
      (transaction_id, artwork_id, revenue_type, amount_eth, revenue_date)
      VALUES (?, ?, 'platform_fee', ?, DATE('now'))
    `).bind(transactionId, listing.artwork_id, platformFee).run();

    // í¬ë¦¬ì—ì´í„° ë¡œì—´í‹° ê¸°ë¡
    await env.DB.prepare(`
      INSERT INTO creator_royalties 
      (transaction_id, artwork_id, creator_id, royalty_percentage, royalty_amount_eth, status)
      VALUES (?, ?, ?, ?, ?, 'pending')
    `).bind(
      transactionId, listing.artwork_id, listing.artist_id,
      settings.creator_royalty_percentage, creatorRoyalty
    ).run();

    // ì†Œìœ ê¶Œ ì´ì „
    await env.DB.prepare(`
      UPDATE artwork_ownership SET is_current_owner = 0 
      WHERE artwork_id = ? AND user_id = ?
    `).bind(listing.artwork_id, listing.seller_id).run();

    await env.DB.prepare(`
      INSERT INTO artwork_ownership 
      (artwork_id, user_id, acquired_at, acquisition_type, is_current_owner)
      VALUES (?, ?, CURRENT_TIMESTAMP, 'purchase', 1)
    `).bind(listing.artwork_id, userId).run();

    // ë¦¬ìŠ¤íŒ… ìƒíƒœ ì—…ë°ì´íŠ¸
    await env.DB.prepare(`
      UPDATE artwork_listings SET status = 'sold', sold_at = CURRENT_TIMESTAMP 
      WHERE id = ?
    `).bind(listing_id).run();

    return c.json({ 
      success: true, 
      transaction_id: transactionId,
      message: 'êµ¬ë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤',
      details: {
        sale_price: salePrice,
        platform_fee: platformFee,
        creator_royalty: creatorRoyalty,
        seller_receives: sellerReceive
      }
    });
  } catch (error: any) {
    console.error('Purchase error:', error);
    return c.json({ error: 'êµ¬ë§¤ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 4. ì˜¤í¼ ìƒì„±
app.post('/api/marketplace/offers', async (c) => {
  const { env } = c;
  const userId = c.get('userId');
  if (!userId) {
    return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401);
  }

  try {
    const { artwork_id, listing_id, offer_price_eth, message, expires_in_days } = await c.req.json();

    // ì‘í’ˆ ì¡´ì¬ í™•ì¸
    const artwork = await env.DB.prepare(`
      SELECT id FROM artworks WHERE id = ?
    `).bind(artwork_id).first();

    if (!artwork) {
      return c.json({ error: 'ì‘í’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 404);
    }

    // í”Œë«í¼ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
    const settings = await getPlatformSettings(env.DB);
    
    if (offer_price_eth < settings.minimum_price_eth) {
      return c.json({ error: `ìµœì†Œ ì˜¤í¼ ê°€ê²©ì€ ${settings.minimum_price_eth} ETHì…ë‹ˆë‹¤` }, 400);
    }

    const expiresAt = new Date(Date.now() + (expires_in_days || settings.offer_expiry_days) * 24 * 60 * 60 * 1000).toISOString();

    const result = await env.DB.prepare(`
      INSERT INTO artwork_offers 
      (artwork_id, listing_id, buyer_id, offer_price_eth, message, expires_at, status)
      VALUES (?, ?, ?, ?, ?, ?, 'pending')
    `).bind(artwork_id, listing_id || null, userId, offer_price_eth, message || null, expiresAt).run();

    return c.json({ 
      success: true, 
      offer_id: result.meta.last_row_id,
      expires_at: expiresAt,
      message: 'ì˜¤í¼ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤'
    });
  } catch (error: any) {
    console.error('Offer creation error:', error);
    return c.json({ error: 'ì˜¤í¼ ìƒì„± ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 5. ì˜¤í¼ ìˆ˜ë½
app.post('/api/marketplace/offers/:offerId/accept', async (c) => {
  const { env } = c;
  const userId = c.get('userId');
  if (!userId) {
    return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401);
  }

  try {
    const offerId = c.req.param('offerId');

    // ì˜¤í¼ ì •ë³´ ì¡°íšŒ
    const offer = await env.DB.prepare(`
      SELECT o.*, a.artist_id, ao.user_id AS owner_id
      FROM artwork_offers o
      JOIN artworks a ON o.artwork_id = a.id
      JOIN artwork_ownership ao ON o.artwork_id = ao.artwork_id AND ao.is_current_owner = 1
      WHERE o.id = ? AND o.status = 'pending'
    `).bind(offerId).first();

    if (!offer) {
      return c.json({ error: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì˜¤í¼ì…ë‹ˆë‹¤' }, 404);
    }

    if (offer.owner_id !== userId) {
      return c.json({ error: 'ì‘í’ˆ ì†Œìœ ìë§Œ ì˜¤í¼ë¥¼ ìˆ˜ë½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' }, 403);
    }

    // ë§Œë£Œ í™•ì¸
    if (new Date(offer.expires_at) < new Date()) {
      await env.DB.prepare(`
        UPDATE artwork_offers SET status = 'expired' WHERE id = ?
      `).bind(offerId).run();
      return c.json({ error: 'ë§Œë£Œëœ ì˜¤í¼ì…ë‹ˆë‹¤' }, 400);
    }

    // í”Œë«í¼ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
    const settings = await getPlatformSettings(env.DB);
    
    const salePrice = offer.offer_price_eth;
    const platformFee = salePrice * (settings.platform_fee_percentage / 100);
    const creatorRoyalty = salePrice * (settings.creator_royalty_percentage / 100);
    const sellerReceive = salePrice - platformFee - creatorRoyalty;

    // ê±°ë˜ ê¸°ë¡ ìƒì„±
    const txResult = await env.DB.prepare(`
      INSERT INTO nft_transactions 
      (artwork_id, seller_id, buyer_id, sale_price_eth, 
       platform_fee_eth, creator_royalty_eth, seller_receive_eth, 
       transaction_type, status, confirmed_at)
      VALUES (?, ?, ?, ?, ?, ?, ?, 'offer_accepted', 'confirmed', CURRENT_TIMESTAMP)
    `).bind(
      offer.artwork_id, userId, offer.buyer_id,
      salePrice, platformFee, creatorRoyalty, sellerReceive
    ).run();

    const transactionId = txResult.meta.last_row_id;

    // í”Œë«í¼ ìˆ˜ìµ ê¸°ë¡
    await env.DB.prepare(`
      INSERT INTO platform_revenue 
      (transaction_id, artwork_id, revenue_type, amount_eth, revenue_date)
      VALUES (?, ?, 'platform_fee', ?, DATE('now'))
    `).bind(transactionId, offer.artwork_id, platformFee).run();

    // í¬ë¦¬ì—ì´í„° ë¡œì—´í‹° ê¸°ë¡
    await env.DB.prepare(`
      INSERT INTO creator_royalties 
      (transaction_id, artwork_id, creator_id, royalty_percentage, royalty_amount_eth, status)
      VALUES (?, ?, ?, ?, ?, 'pending')
    `).bind(
      transactionId, offer.artwork_id, offer.artist_id,
      settings.creator_royalty_percentage, creatorRoyalty
    ).run();

    // ì†Œìœ ê¶Œ ì´ì „
    await env.DB.prepare(`
      UPDATE artwork_ownership SET is_current_owner = 0 
      WHERE artwork_id = ? AND user_id = ?
    `).bind(offer.artwork_id, userId).run();

    await env.DB.prepare(`
      INSERT INTO artwork_ownership 
      (artwork_id, user_id, acquired_at, acquisition_type, is_current_owner)
      VALUES (?, ?, CURRENT_TIMESTAMP, 'offer', 1)
    `).bind(offer.artwork_id, offer.buyer_id).run();

    // ì˜¤í¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    await env.DB.prepare(`
      UPDATE artwork_offers 
      SET status = 'accepted', responded_at = CURRENT_TIMESTAMP, responded_by = ?
      WHERE id = ?
    `).bind(userId, offerId).run();

    // ê´€ë ¨ ë¦¬ìŠ¤íŒ… ì¢…ë£Œ
    if (offer.listing_id) {
      await env.DB.prepare(`
        UPDATE artwork_listings SET status = 'sold', sold_at = CURRENT_TIMESTAMP 
        WHERE id = ?
      `).bind(offer.listing_id).run();
    }

    return c.json({ 
      success: true, 
      transaction_id: transactionId,
      message: 'ì˜¤í¼ê°€ ìˆ˜ë½ë˜ì—ˆìŠµë‹ˆë‹¤'
    });
  } catch (error: any) {
    console.error('Offer accept error:', error);
    return c.json({ error: 'ì˜¤í¼ ìˆ˜ë½ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 6. ê²½ë§¤ ì…ì°°
app.post('/api/marketplace/bids', async (c) => {
  const { env } = c;
  const userId = c.get('userId');
  if (!userId) {
    return c.json({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401);
  }

  try {
    const { listing_id, bid_amount_eth, max_bid_eth } = await c.req.json();

    // ë¦¬ìŠ¤íŒ… ì •ë³´ ì¡°íšŒ
    const listing = await env.DB.prepare(`
      SELECT * FROM artwork_listings 
      WHERE id = ? AND status = 'active' AND listing_type = 'auction'
    `).bind(listing_id).first();

    if (!listing) {
      return c.json({ error: 'ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ë§¤ì…ë‹ˆë‹¤' }, 404);
    }

    // ê²½ë§¤ ì¢…ë£Œ ì‹œê°„ í™•ì¸
    if (new Date(listing.auction_end_time) < new Date()) {
      await env.DB.prepare(`
        UPDATE artwork_listings SET status = 'expired' WHERE id = ?
      `).bind(listing_id).run();
      return c.json({ error: 'ì¢…ë£Œëœ ê²½ë§¤ì…ë‹ˆë‹¤' }, 400);
    }

    // í˜„ì¬ ìµœê³  ì…ì°°ê°€ ì¡°íšŒ
    const highestBid = await env.DB.prepare(`
      SELECT MAX(bid_amount_eth) as max_bid 
      FROM auction_bids_enhanced 
      WHERE listing_id = ? AND status = 'active'
    `).bind(listing_id).first();

    const currentHighest = highestBid?.max_bid || listing.auction_start_price_eth;
    
    // í”Œë«í¼ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
    const settings = await getPlatformSettings(env.DB);
    const minIncrement = currentHighest * (settings.auction_min_increment_percentage / 100);
    
    if (bid_amount_eth < currentHighest + minIncrement) {
      return c.json({ 
        error: `ì…ì°°ê°€ëŠ” ìµœì†Œ ${(currentHighest + minIncrement).toFixed(4)} ETH ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤`,
        current_highest: currentHighest,
        min_increment: minIncrement
      }, 400);
    }

    // ê¸°ì¡´ ì…ì°° outbid ì²˜ë¦¬
    await env.DB.prepare(`
      UPDATE auction_bids_enhanced 
      SET status = 'outbid', is_winning = 0 
      WHERE listing_id = ? AND status = 'active'
    `).bind(listing_id).run();

    // ìƒˆ ì…ì°° ìƒì„±
    const result = await env.DB.prepare(`
      INSERT INTO auction_bids_enhanced 
      (listing_id, artwork_id, bidder_id, bid_amount_eth, max_bid_eth, status, is_winning)
      VALUES (?, ?, ?, ?, ?, 'active', 1)
    `).bind(
      listing_id, listing.artwork_id, userId, 
      bid_amount_eth, max_bid_eth || null
    ).run();

    return c.json({ 
      success: true, 
      bid_id: result.meta.last_row_id,
      message: 'ì…ì°°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤',
      is_winning: true,
      bid_amount: bid_amount_eth
    });
  } catch (error: any) {
    console.error('Bid creation error:', error);
    return c.json({ error: 'ì…ì°° ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 7. ê±°ë˜ ë‚´ì—­ ì¡°íšŒ
app.get('/api/marketplace/transactions', async (c) => {
  const { env } = c;
  const userId = c.get('userId');
  const page = parseInt(c.req.query('page') || '1');
  const limit = parseInt(c.req.query('limit') || '20');
  const offset = (page - 1) * limit;

  try {
    let query = `
      SELECT * FROM v_recent_transactions
      WHERE 1=1
    `;
    
    const bindings: any[] = [];
    
    if (userId) {
      query += ` AND (seller_id = ? OR buyer_id = ?)`;
      bindings.push(userId, userId);
    }
    
    query += ` LIMIT ? OFFSET ?`;
    bindings.push(limit, offset);

    const transactions = await env.DB.prepare(query).bind(...bindings).all();
    
    return c.json({
      transactions: transactions.results,
      pagination: {
        page,
        limit,
        total: transactions.results.length
      }
    });
  } catch (error: any) {
    console.error('Transactions fetch error:', error);
    return c.json({ error: 'ê±°ë˜ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 8. í”Œë«í¼ ì„¤ì • ì¡°íšŒ
app.get('/api/marketplace/settings', async (c) => {
  const { env } = c;

  try {
    const settings = await getPlatformSettings(env.DB);
    return c.json({ settings });
  } catch (error: any) {
    console.error('Settings fetch error:', error);
    return c.json({ error: 'ì„¤ì • ì¡°íšŒ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 9. ë§ˆì¼“í”Œë ˆì´ìŠ¤ í†µê³„
app.get('/api/marketplace/stats', async (c) => {
  const { env } = c;

  try {
    // ì „ì²´ ê±°ë˜ëŸ‰
    const totalVolume = await env.DB.prepare(`
      SELECT 
        COUNT(*) as total_transactions,
        SUM(sale_price_eth) as total_volume,
        AVG(sale_price_eth) as avg_price
      FROM nft_transactions 
      WHERE status = 'confirmed'
    `).first();

    // í™œì„± ë¦¬ìŠ¤íŒ… ìˆ˜
    const activeListings = await env.DB.prepare(`
      SELECT COUNT(*) as count FROM artwork_listings WHERE status = 'active'
    `).first();

    // ì˜¤ëŠ˜ì˜ ê±°ë˜
    const todayTransactions = await env.DB.prepare(`
      SELECT 
        COUNT(*) as count,
        SUM(sale_price_eth) as volume
      FROM nft_transactions 
      WHERE status = 'confirmed' 
        AND DATE(created_at) = DATE('now')
    `).first();

    // í”Œë«í¼ ì´ ìˆ˜ìµ
    const platformRevenue = await env.DB.prepare(`
      SELECT SUM(amount_eth) as total_revenue 
      FROM platform_revenue
    `).first();

    return c.json({
      stats: {
        total_transactions: totalVolume?.total_transactions || 0,
        total_volume_eth: totalVolume?.total_volume || 0,
        average_price_eth: totalVolume?.avg_price || 0,
        active_listings: activeListings?.count || 0,
        today_transactions: todayTransactions?.count || 0,
        today_volume_eth: todayTransactions?.volume || 0,
        platform_total_revenue_eth: platformRevenue?.total_revenue || 0
      }
    });
  } catch (error: any) {
    console.error('Stats fetch error:', error);
    return c.json({ error: 'í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});


// ============================================
// PHASE 1 APIs: Collections, Bundles, Traits, Lazy Minting
// Version: v8.16
// ============================================

// ========== COLLECTION MANAGEMENT APIs ==========

// 1. ì»¬ë ‰ì…˜ ëª©ë¡ ì¡°íšŒ (í˜ì´ì§€ë„¤ì´ì…˜, í•„í„°ë§)
app.get('/api/collections', async (c) => {
  const { env } = c;
  const { page = '1', limit = '20', artist_id, category, is_featured, sort = 'volume' } = c.req.query();
  
  try {
    const pageNum = parseInt(page);
    const limitNum = parseInt(limit);
    const offset = (pageNum - 1) * limitNum;
    
    let query = 'SELECT * FROM v_collection_details WHERE 1=1';
    const bindings: any[] = [];
    
    if (artist_id) {
      query += ' AND artist_id = ?';
      bindings.push(parseInt(artist_id));
    }
    
    if (category) {
      query += ' AND category = ?';
      bindings.push(category);
    }
    
    if (is_featured === 'true') {
      query += ' AND is_featured = 1';
    }
    
    // ì •ë ¬
    if (sort === 'volume') {
      query += ' ORDER BY actual_total_volume DESC';
    } else if (sort === 'floor_price') {
      query += ' ORDER BY current_floor_price DESC';
    } else if (sort === 'items') {
      query += ' ORDER BY actual_items_count DESC';
    } else {
      query += ' ORDER BY created_at DESC';
    }
    
    query += ' LIMIT ? OFFSET ?';
    bindings.push(limitNum, offset);
    
    const collections = await env.DB.prepare(query).bind(...bindings).all();
    
    // ì´ ê°œìˆ˜ ì¡°íšŒ
    let countQuery = 'SELECT COUNT(*) as total FROM artwork_collections WHERE 1=1';
    const countBindings: any[] = [];
    
    if (artist_id) {
      countQuery += ' AND artist_id = ?';
      countBindings.push(parseInt(artist_id));
    }
    
    if (category) {
      countQuery += ' AND category = ?';
      countBindings.push(category);
    }
    
    if (is_featured === 'true') {
      countQuery += ' AND is_featured = 1';
    }
    
    const countResult = await env.DB.prepare(countQuery).bind(...countBindings).first();
    
    return c.json({
      success: true,
      data: collections.results || [],
      pagination: {
        page: pageNum,
        limit: limitNum,
        total: countResult?.total || 0,
        pages: Math.ceil((countResult?.total || 0) / limitNum)
      }
    });
  } catch (error: any) {
    console.error('Collections fetch error:', error);
    return c.json({ error: 'ì»¬ë ‰ì…˜ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 2. ì»¬ë ‰ì…˜ ìƒì„¸ ì¡°íšŒ
app.get('/api/collections/:slug', async (c) => {
  const { env } = c;
  const slug = c.req.param('slug');
  
  try {
    // ì»¬ë ‰ì…˜ ìƒì„¸ ì •ë³´
    const collection = await env.DB.prepare(`
      SELECT * FROM v_collection_details WHERE collection_slug = ?
    `).bind(slug).first();
    
    if (!collection) {
      return c.json({ error: 'ì»¬ë ‰ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 404);
    }
    
    // ì»¬ë ‰ì…˜ì˜ ì‘í’ˆ ëª©ë¡ (ìƒ˜í”Œ 10ê°œ)
    const artworks = await env.DB.prepare(`
      SELECT 
        a.*,
        ar.name as artist_name,
        ar.avatar as artist_avatar,
        al.price_eth as current_price_eth,
        al.status as listing_status
      FROM artworks a
      JOIN artists ar ON a.artist_id = ar.id
      LEFT JOIN artwork_listings al ON a.id = al.artwork_id
      WHERE a.collection_id = ?
      ORDER BY a.created_at DESC
      LIMIT 10
    `).bind(collection.id).all();
    
    // ì»¬ë ‰ì…˜ íŠ¸ë ˆì´íŠ¸ í†µê³„
    const traits = await env.DB.prepare(`
      SELECT * FROM v_collection_traits_stats 
      WHERE collection_id = ?
      LIMIT 50
    `).bind(collection.id).all();
    
    return c.json({
      success: true,
      data: {
        collection,
        artworks: artworks.results || [],
        traits: traits.results || []
      }
    });
  } catch (error: any) {
    console.error('Collection detail error:', error);
    return c.json({ error: 'ì»¬ë ‰ì…˜ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 3. ì»¬ë ‰ì…˜ ìƒì„± (ì‘ê°€ ì „ìš©)
app.post('/api/collections', async (c) => {
  const { env } = c;
  const { 
    collection_name, 
    description, 
    category, 
    banner_image, 
    logo_image,
    royalty_percentage = 10.0 
  } = await c.req.json();
  
  // ì¸ì¦ í™•ì¸ (ì‹¤ì œ êµ¬í˜„ ì‹œ JWT ê²€ì¦)
  const artistId = 1; // TODO: ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  
  try {
    // Slug ìƒì„± (URL-friendly)
    const slug = collection_name.toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/(^-|-$)/g, '') + '-' + Date.now();
    
    const result = await env.DB.prepare(`
      INSERT INTO artwork_collections 
        (artist_id, collection_slug, collection_name, description, category, 
         banner_image, logo_image, royalty_percentage, is_verified)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, 1)
    `).bind(artistId, slug, collection_name, description, category, 
            banner_image, logo_image, royalty_percentage).run();
    
    return c.json({
      success: true,
      data: {
        collection_id: result.meta.last_row_id,
        collection_slug: slug
      }
    });
  } catch (error: any) {
    console.error('Collection creation error:', error);
    return c.json({ error: 'ì»¬ë ‰ì…˜ ìƒì„± ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 4. íŠ¸ë Œë”© ì»¬ë ‰ì…˜ ì¡°íšŒ (ìµœê·¼ 7ì¼)
app.get('/api/collections/trending', async (c) => {
  const { env } = c;
  const { limit = '10' } = c.req.query();
  
  try {
    const collections = await env.DB.prepare(`
      SELECT * FROM v_trending_collections LIMIT ?
    `).bind(parseInt(limit)).all();
    
    return c.json({
      success: true,
      data: collections.results || []
    });
  } catch (error: any) {
    console.error('Trending collections error:', error);
    return c.json({ error: 'íŠ¸ë Œë”© ì»¬ë ‰ì…˜ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});


// ========== ARTWORK TRAITS APIs ==========

// 5. ì‘í’ˆ íŠ¸ë ˆì´íŠ¸ ì¡°íšŒ
app.get('/api/artworks/:artworkId/traits', async (c) => {
  const { env } = c;
  const artworkId = c.req.param('artworkId');
  
  try {
    const traits = await env.DB.prepare(`
      SELECT * FROM artwork_traits 
      WHERE artwork_id = ?
      ORDER BY trait_type, rarity_score DESC
    `).bind(artworkId).all();
    
    return c.json({
      success: true,
      data: traits.results || []
    });
  } catch (error: any) {
    console.error('Traits fetch error:', error);
    return c.json({ error: 'íŠ¸ë ˆì´íŠ¸ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 6. ì‘í’ˆ íŠ¸ë ˆì´íŠ¸ ì¶”ê°€/ìˆ˜ì •
app.post('/api/artworks/:artworkId/traits', async (c) => {
  const { env } = c;
  const artworkId = c.req.param('artworkId');
  const { trait_type, trait_value, display_type, max_value } = await c.req.json();
  
  try {
    // ê¸°ì¡´ íŠ¸ë ˆì´íŠ¸ í™•ì¸
    const existing = await env.DB.prepare(`
      SELECT id FROM artwork_traits 
      WHERE artwork_id = ? AND trait_type = ?
    `).bind(artworkId, trait_type).first();
    
    if (existing) {
      // ì—…ë°ì´íŠ¸
      await env.DB.prepare(`
        UPDATE artwork_traits 
        SET trait_value = ?, display_type = ?, max_value = ?
        WHERE id = ?
      `).bind(trait_value, display_type, max_value, existing.id).run();
      
      return c.json({ success: true, message: 'íŠ¸ë ˆì´íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ' });
    } else {
      // ì‹ ê·œ ì¶”ê°€
      const result = await env.DB.prepare(`
        INSERT INTO artwork_traits 
          (artwork_id, trait_type, trait_value, display_type, max_value)
        VALUES (?, ?, ?, ?, ?)
      `).bind(artworkId, trait_type, trait_value, display_type, max_value).run();
      
      return c.json({ 
        success: true, 
        data: { trait_id: result.meta.last_row_id } 
      });
    }
  } catch (error: any) {
    console.error('Trait add error:', error);
    return c.json({ error: 'íŠ¸ë ˆì´íŠ¸ ì¶”ê°€ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 7. íŠ¸ë ˆì´íŠ¸ ê¸°ë°˜ ì‘í’ˆ í•„í„°ë§
app.get('/api/artworks/filter/traits', async (c) => {
  const { env } = c;
  const { collection_id, traits, page = '1', limit = '20' } = c.req.query();
  
  try {
    // traits íŒŒë¼ë¯¸í„° í˜•ì‹: "Background:Blue,Style:Abstract"
    const traitFilters = traits ? (traits as string).split(',').map(t => {
      const [type, value] = t.split(':');
      return { type, value };
    }) : [];
    
    if (traitFilters.length === 0) {
      return c.json({ error: 'íŠ¸ë ˆì´íŠ¸ í•„í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤' }, 400);
    }
    
    // ë™ì  ì¿¼ë¦¬ ìƒì„±
    let query = `
      SELECT DISTINCT a.*
      FROM artworks a
      INNER JOIN artwork_traits t1 ON a.id = t1.artwork_id
    `;
    
    const bindings: any[] = [];
    
    // ì¶”ê°€ JOIN (íŠ¸ë ˆì´íŠ¸ ê°œìˆ˜ë§Œí¼)
    for (let i = 1; i < traitFilters.length; i++) {
      query += ` INNER JOIN artwork_traits t${i + 1} ON a.id = t${i + 1}.artwork_id`;
    }
    
    query += ' WHERE 1=1';
    
    if (collection_id) {
      query += ' AND a.collection_id = ?';
      bindings.push(parseInt(collection_id as string));
    }
    
    // ê° íŠ¸ë ˆì´íŠ¸ ì¡°ê±´ ì¶”ê°€
    traitFilters.forEach((filter, index) => {
      query += ` AND t${index + 1}.trait_type = ? AND t${index + 1}.trait_value = ?`;
      bindings.push(filter.type, filter.value);
    });
    
    const pageNum = parseInt(page as string);
    const limitNum = parseInt(limit as string);
    const offset = (pageNum - 1) * limitNum;
    
    query += ' LIMIT ? OFFSET ?';
    bindings.push(limitNum, offset);
    
    const artworks = await env.DB.prepare(query).bind(...bindings).all();
    
    return c.json({
      success: true,
      data: artworks.results || [],
      filters_applied: traitFilters
    });
  } catch (error: any) {
    console.error('Trait filter error:', error);
    return c.json({ error: 'íŠ¸ë ˆì´íŠ¸ í•„í„°ë§ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});


// ========== BUNDLE SALES APIs ==========

// 8. ë²ˆë“¤ ëª©ë¡ ì¡°íšŒ
app.get('/api/bundles', async (c) => {
  const { env } = c;
  const { status = 'active', page = '1', limit = '20' } = c.req.query();
  
  try {
    const pageNum = parseInt(page as string);
    const limitNum = parseInt(limit as string);
    const offset = (pageNum - 1) * limitNum;
    
    let query = 'SELECT * FROM v_active_bundles WHERE 1=1';
    const bindings: any[] = [];
    
    if (status !== 'all') {
      query += ' AND current_status = ?';
      bindings.push(status);
    }
    
    query += ' ORDER BY created_at DESC LIMIT ? OFFSET ?';
    bindings.push(limitNum, offset);
    
    const bundles = await env.DB.prepare(query).bind(...bindings).all();
    
    return c.json({
      success: true,
      data: bundles.results || []
    });
  } catch (error: any) {
    console.error('Bundles fetch error:', error);
    return c.json({ error: 'ë²ˆë“¤ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 9. ë²ˆë“¤ ìƒì„¸ ì¡°íšŒ
app.get('/api/bundles/:bundleId', async (c) => {
  const { env } = c;
  const bundleId = c.req.param('bundleId');
  
  try {
    // ë²ˆë“¤ ì •ë³´
    const bundle = await env.DB.prepare(`
      SELECT * FROM v_active_bundles WHERE id = ?
    `).bind(bundleId).first();
    
    if (!bundle) {
      return c.json({ error: 'ë²ˆë“¤ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 404);
    }
    
    // ë²ˆë“¤ì— í¬í•¨ëœ ì‘í’ˆ ëª©ë¡
    const items = await env.DB.prepare(`
      SELECT 
        bi.*,
        a.title, a.image_url, a.description,
        ar.name as artist_name
      FROM bundle_items bi
      JOIN artworks a ON bi.artwork_id = a.id
      JOIN artists ar ON a.artist_id = ar.id
      WHERE bi.bundle_id = ?
    `).bind(bundleId).all();
    
    return c.json({
      success: true,
      data: {
        bundle,
        items: items.results || []
      }
    });
  } catch (error: any) {
    console.error('Bundle detail error:', error);
    return c.json({ error: 'ë²ˆë“¤ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 10. ë²ˆë“¤ ìƒì„±
app.post('/api/bundles', async (c) => {
  const { env } = c;
  const { 
    bundle_name, 
    description, 
    artwork_ids,  // ë°°ì—´
    total_price_eth,
    discount_percentage = 0,
    listing_type = 'fixed_price'
  } = await c.req.json();
  
  const sellerId = 1; // TODO: ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  
  try {
    // ë²ˆë“¤ ìƒì„±
    const bundleResult = await env.DB.prepare(`
      INSERT INTO artwork_bundles 
        (seller_id, bundle_name, description, total_price_eth, 
         discount_percentage, listing_type, status)
      VALUES (?, ?, ?, ?, ?, ?, 'active')
    `).bind(sellerId, bundle_name, description, total_price_eth, 
            discount_percentage, listing_type).run();
    
    const bundleId = bundleResult.meta.last_row_id;
    
    // ë²ˆë“¤ ì•„ì´í…œ ì¶”ê°€
    for (const artworkId of artwork_ids) {
      // ì‘í’ˆì˜ ê°œë³„ ê°€ê²© ì¡°íšŒ
      const artwork = await env.DB.prepare(`
        SELECT price_eth FROM artworks WHERE id = ?
      `).bind(artworkId).first();
      
      await env.DB.prepare(`
        INSERT INTO bundle_items (bundle_id, artwork_id, individual_price_eth)
        VALUES (?, ?, ?)
      `).bind(bundleId, artworkId, artwork?.price_eth || 0).run();
    }
    
    // ì›ë˜ ê°€ê²© ê³„ì‚°
    const itemsTotal = await env.DB.prepare(`
      SELECT SUM(individual_price_eth) as total 
      FROM bundle_items WHERE bundle_id = ?
    `).bind(bundleId).first();
    
    await env.DB.prepare(`
      UPDATE artwork_bundles 
      SET original_price_eth = ?
      WHERE id = ?
    `).bind(itemsTotal?.total || 0, bundleId).run();
    
    return c.json({
      success: true,
      data: {
        bundle_id: bundleId,
        items_count: artwork_ids.length,
        discount_amount: (itemsTotal?.total || 0) - total_price_eth
      }
    });
  } catch (error: any) {
    console.error('Bundle creation error:', error);
    return c.json({ error: 'ë²ˆë“¤ ìƒì„± ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 11. ë²ˆë“¤ êµ¬ë§¤
app.post('/api/bundles/:bundleId/purchase', async (c) => {
  const { env } = c;
  const bundleId = c.req.param('bundleId');
  const buyerId = 1; // TODO: ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  
  try {
    // ë²ˆë“¤ ì •ë³´ ì¡°íšŒ
    const bundle = await env.DB.prepare(`
      SELECT * FROM artwork_bundles WHERE id = ? AND status = 'active'
    `).bind(bundleId).first();
    
    if (!bundle) {
      return c.json({ error: 'êµ¬ë§¤ ê°€ëŠ¥í•œ ë²ˆë“¤ì´ ì•„ë‹™ë‹ˆë‹¤' }, 400);
    }
    
    if (bundle.seller_id === buyerId) {
      return c.json({ error: 'ìì‹ ì˜ ë²ˆë“¤ì€ êµ¬ë§¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 400);
    }
    
    // ë²ˆë“¤ì— í¬í•¨ëœ ëª¨ë“  ì‘í’ˆì˜ ì†Œìœ ê¶Œ ì´ì „
    const items = await env.DB.prepare(`
      SELECT artwork_id FROM bundle_items WHERE bundle_id = ?
    `).bind(bundleId).all();
    
    for (const item of (items.results || [])) {
      await env.DB.prepare(`
        UPDATE artworks SET owner_id = ? WHERE id = ?
      `).bind(buyerId, item.artwork_id).run();
      
      // ê±°ë˜ ê¸°ë¡ ìƒì„±
      await env.DB.prepare(`
        INSERT INTO nft_transactions 
          (artwork_id, seller_id, buyer_id, transaction_type, amount_eth, status)
        VALUES (?, ?, ?, 'bundle_sale', ?, 'confirmed')
      `).bind(item.artwork_id, bundle.seller_id, buyerId, 
              bundle.total_price_eth / (items.results?.length || 1)).run();
    }
    
    // ë²ˆë“¤ ìƒíƒœ ì—…ë°ì´íŠ¸
    await env.DB.prepare(`
      UPDATE artwork_bundles 
      SET status = 'sold', buyer_id = ?, sold_at = datetime('now')
      WHERE id = ?
    `).bind(buyerId, bundleId).run();
    
    return c.json({
      success: true,
      message: 'ë²ˆë“¤ êµ¬ë§¤ ì™„ë£Œ',
      data: {
        items_purchased: items.results?.length || 0,
        total_paid_eth: bundle.total_price_eth
      }
    });
  } catch (error: any) {
    console.error('Bundle purchase error:', error);
    return c.json({ error: 'ë²ˆë“¤ êµ¬ë§¤ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});


// ========== LAZY MINTING APIs ==========

// 12. Lazy Minting ì‘í’ˆ ë“±ë¡
app.post('/api/artworks/lazy-mint', async (c) => {
  const { env } = c;
  const { 
    title, 
    description, 
    image_url, 
    price_eth,
    category,
    collection_id 
  } = await c.req.json();
  
  const artistId = 1; // TODO: ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  
  try {
    // ì‘í’ˆ ë“±ë¡ (ë¸”ë¡ì²´ì¸ì—ëŠ” ì•„ì§ ë¯¼íŒ… ì•ˆ í•¨)
    const result = await env.DB.prepare(`
      INSERT INTO artworks 
        (title, description, image_url, artist_id, price_eth, 
         category, collection_id, is_minted, lazy_mint, status)
      VALUES (?, ?, ?, ?, ?, ?, ?, 0, 1, 'active')
    `).bind(title, description, image_url, artistId, price_eth, 
            category, collection_id).run();
    
    const artworkId = result.meta.last_row_id;
    
    return c.json({
      success: true,
      message: 'Lazy minting ì‘í’ˆ ë“±ë¡ ì™„ë£Œ (ì²« êµ¬ë§¤ ì‹œ ìë™ ë¯¼íŒ…ë©ë‹ˆë‹¤)',
      data: {
        artwork_id: artworkId,
        lazy_mint: true,
        is_minted: false
      }
    });
  } catch (error: any) {
    console.error('Lazy mint creation error:', error);
    return c.json({ error: 'Lazy minting ë“±ë¡ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 13. Lazy Minting í ì¡°íšŒ
app.get('/api/lazy-mint/queue', async (c) => {
  const { env } = c;
  const { status = 'pending' } = c.req.query();
  
  try {
    const queue = await env.DB.prepare(`
      SELECT 
        lmq.*,
        a.title as artwork_title,
        a.image_url,
        u.name as buyer_name
      FROM lazy_mint_queue lmq
      JOIN artworks a ON lmq.artwork_id = a.id
      JOIN users u ON lmq.buyer_id = u.id
      WHERE lmq.status = ?
      ORDER BY lmq.created_at DESC
      LIMIT 50
    `).bind(status).all();
    
    return c.json({
      success: true,
      data: queue.results || []
    });
  } catch (error: any) {
    console.error('Lazy mint queue error:', error);
    return c.json({ error: 'Lazy mint í ì¡°íšŒ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 14. Lazy Minting ì‹¤í–‰ (ì²« êµ¬ë§¤ ì‹œ íŠ¸ë¦¬ê±°)
app.post('/api/lazy-mint/execute/:artworkId', async (c) => {
  const { env } = c;
  const artworkId = c.req.param('artworkId');
  const buyerId = 1; // TODO: ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  
  try {
    // ì‘í’ˆ í™•ì¸
    const artwork = await env.DB.prepare(`
      SELECT * FROM artworks WHERE id = ? AND lazy_mint = 1 AND is_minted = 0
    `).bind(artworkId).first();
    
    if (!artwork) {
      return c.json({ error: 'Lazy mint ëŒ€ìƒì´ ì•„ë‹™ë‹ˆë‹¤' }, 400);
    }
    
    // Lazy mint íì— ì¶”ê°€
    const queueResult = await env.DB.prepare(`
      INSERT INTO lazy_mint_queue 
        (artwork_id, buyer_id, status, metadata_uri)
      VALUES (?, ?, 'pending', ?)
    `).bind(artworkId, buyerId, `ipfs://metadata/${artworkId}`).run();
    
    // ì‹¤ì œ ë¯¼íŒ… í”„ë¡œì„¸ìŠ¤ëŠ” ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
    // (Cloudflare Workers Cron ë˜ëŠ” Queue ì‚¬ìš©)
    
    // ì‹œë®¬ë ˆì´ì…˜: ì¦‰ì‹œ ì™„ë£Œ ì²˜ë¦¬
    await env.DB.prepare(`
      UPDATE lazy_mint_queue 
      SET 
        status = 'completed',
        transaction_hash = ?,
        block_number = ?,
        completed_at = datetime('now')
      WHERE id = ?
    `).bind(`0x${Math.random().toString(16).substr(2, 64)}`, 
            Math.floor(Math.random() * 1000000),
            queueResult.meta.last_row_id).run();
    
    return c.json({
      success: true,
      message: 'Lazy minting ì‹¤í–‰ ì™„ë£Œ',
      data: {
        queue_id: queueResult.meta.last_row_id,
        status: 'completed'
      }
    });
  } catch (error: any) {
    console.error('Lazy mint execution error:', error);
    return c.json({ error: 'Lazy minting ì‹¤í–‰ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});


// ============================================
// PHASE 2 APIs: Sweep, Portfolio, Multi-chain, Activity
// ============================================

// ========== SWEEP PURCHASE APIs ==========

// 15. Sweep ì¥ë°”êµ¬ë‹ˆ ìƒì„±/ì¡°íšŒ
app.get('/api/sweep/cart', async (c) => {
  const { env } = c;
  const userId = 1; // TODO: ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  
  try {
    // í™œì„± ì¥ë°”êµ¬ë‹ˆ ì¡°íšŒ
    let cart = await env.DB.prepare(`
      SELECT * FROM sweep_cart 
      WHERE user_id = ? AND cart_status = 'active'
      ORDER BY created_at DESC
      LIMIT 1
    `).bind(userId).first();
    
    if (!cart) {
      // ìƒˆ ì¥ë°”êµ¬ë‹ˆ ìƒì„±
      const result = await env.DB.prepare(`
        INSERT INTO sweep_cart (user_id, expires_at)
        VALUES (?, datetime('now', '+24 hours'))
      `).bind(userId).run();
      
      cart = await env.DB.prepare(`
        SELECT * FROM sweep_cart WHERE id = ?
      `).bind(result.meta.last_row_id).first();
    }
    
    // ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ì¡°íšŒ
    const items = await env.DB.prepare(`
      SELECT 
        sci.*,
        a.title, a.image_url,
        ar.name as artist_name
      FROM sweep_cart_items sci
      JOIN artworks a ON sci.artwork_id = a.id
      JOIN artists ar ON a.artist_id = ar.id
      WHERE sci.cart_id = ?
    `).bind(cart.id).all();
    
    return c.json({
      success: true,
      data: {
        cart,
        items: items.results || []
      }
    });
  } catch (error: any) {
    console.error('Sweep cart error:', error);
    return c.json({ error: 'Sweep ì¥ë°”êµ¬ë‹ˆ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 16. Sweep ì¥ë°”êµ¬ë‹ˆì— ì‘í’ˆ ì¶”ê°€
app.post('/api/sweep/cart/add', async (c) => {
  const { env } = c;
  const { artwork_id, listing_id } = await c.req.json();
  const userId = 1; // TODO: ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  
  try {
    // í™œì„± ì¥ë°”êµ¬ë‹ˆ ì¡°íšŒ ë˜ëŠ” ìƒì„±
    let cart = await env.DB.prepare(`
      SELECT * FROM sweep_cart 
      WHERE user_id = ? AND cart_status = 'active'
      LIMIT 1
    `).bind(userId).first();
    
    if (!cart) {
      const cartResult = await env.DB.prepare(`
        INSERT INTO sweep_cart (user_id, expires_at)
        VALUES (?, datetime('now', '+24 hours'))
      `).bind(userId).run();
      
      cart = { id: cartResult.meta.last_row_id };
    }
    
    // ì‘í’ˆ ê°€ê²© ì¡°íšŒ
    const artwork = await env.DB.prepare(`
      SELECT price_eth, price_krw FROM artworks WHERE id = ?
    `).bind(artwork_id).first();
    
    if (!artwork) {
      return c.json({ error: 'ì‘í’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 404);
    }
    
    // ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€
    await env.DB.prepare(`
      INSERT OR IGNORE INTO sweep_cart_items 
        (cart_id, artwork_id, listing_id, price_eth, price_krw)
      VALUES (?, ?, ?, ?, ?)
    `).bind(cart.id, artwork_id, listing_id, artwork.price_eth, artwork.price_krw).run();
    
    return c.json({
      success: true,
      message: 'ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤'
    });
  } catch (error: any) {
    console.error('Sweep cart add error:', error);
    return c.json({ error: 'ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 17. Sweep ì¼ê´„ êµ¬ë§¤ ì‹¤í–‰
app.post('/api/sweep/cart/checkout', async (c) => {
  const { env } = c;
  const userId = 1; // TODO: ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  
  try {
    // í™œì„± ì¥ë°”êµ¬ë‹ˆ ì¡°íšŒ
    const cart = await env.DB.prepare(`
      SELECT * FROM sweep_cart 
      WHERE user_id = ? AND cart_status = 'active'
      LIMIT 1
    `).bind(userId).first();
    
    if (!cart) {
      return c.json({ error: 'ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤' }, 400);
    }
    
    // ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ì¡°íšŒ
    const items = await env.DB.prepare(`
      SELECT * FROM sweep_cart_items 
      WHERE cart_id = ? AND is_available = 1
    `).bind(cart.id).all();
    
    if (!items.results || items.results.length === 0) {
      return c.json({ error: 'êµ¬ë§¤ ê°€ëŠ¥í•œ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤' }, 400);
    }
    
    // Sweep ê±°ë˜ ê¸°ë¡ ìƒì„±
    const txResult = await env.DB.prepare(`
      INSERT INTO sweep_transactions 
        (cart_id, buyer_id, total_amount_eth, total_items_purchased, status)
      VALUES (?, ?, ?, ?, 'pending')
    `).bind(cart.id, userId, cart.total_price_eth, items.results.length).run();
    
    // ê° ì‘í’ˆì˜ ì†Œìœ ê¶Œ ì´ì „
    for (const item of items.results) {
      await env.DB.prepare(`
        UPDATE artworks SET owner_id = ? WHERE id = ?
      `).bind(userId, item.artwork_id).run();
      
      // ê°œë³„ ê±°ë˜ ê¸°ë¡
      await env.DB.prepare(`
        INSERT INTO nft_transactions 
          (artwork_id, buyer_id, transaction_type, amount_eth, status)
        VALUES (?, ?, 'sweep_purchase', ?, 'confirmed')
      `).bind(item.artwork_id, userId, item.price_eth).run();
    }
    
    // Sweep ê±°ë˜ ì™„ë£Œ ì²˜ë¦¬
    await env.DB.prepare(`
      UPDATE sweep_transactions 
      SET status = 'completed', completed_at = datetime('now')
      WHERE id = ?
    `).bind(txResult.meta.last_row_id).run();
    
    // ì¥ë°”êµ¬ë‹ˆ ì²´í¬ì•„ì›ƒ ì™„ë£Œ
    await env.DB.prepare(`
      UPDATE sweep_cart SET cart_status = 'checked_out' WHERE id = ?
    `).bind(cart.id).run();
    
    return c.json({
      success: true,
      message: 'Sweep êµ¬ë§¤ ì™„ë£Œ',
      data: {
        transaction_id: txResult.meta.last_row_id,
        items_purchased: items.results.length,
        total_paid_eth: cart.total_price_eth
      }
    });
  } catch (error: any) {
    console.error('Sweep checkout error:', error);
    return c.json({ error: 'Sweep êµ¬ë§¤ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});


// ========== PORTFOLIO TRACKER APIs ==========

// 18. í¬íŠ¸í´ë¦¬ì˜¤ í˜„í™© ì¡°íšŒ
app.get('/api/portfolio/:userId', async (c) => {
  const { env } = c;
  const userId = c.req.param('userId');
  
  try {
    // ìµœì‹  í¬íŠ¸í´ë¦¬ì˜¤ ìŠ¤ëƒ…ìƒ·
    const portfolio = await env.DB.prepare(`
      SELECT * FROM v_current_portfolio WHERE user_id = ?
    `).bind(userId).first();
    
    // ë³´ìœ  ìì‚° ëª©ë¡
    const holdings = await env.DB.prepare(`
      SELECT * FROM v_holdings_detail 
      WHERE user_id = ? AND status = 'holding'
      ORDER BY unrealized_pnl_eth DESC
    `).bind(userId).all();
    
    // íŒë§¤ ì™„ë£Œ ìì‚° (ìµœê·¼ 10ê°œ)
    const soldAssets = await env.DB.prepare(`
      SELECT * FROM v_holdings_detail 
      WHERE user_id = ? AND status = 'sold'
      ORDER BY sale_date DESC
      LIMIT 10
    `).bind(userId).all();
    
    return c.json({
      success: true,
      data: {
        portfolio: portfolio || {
          total_value_eth: 0,
          unrealized_pnl_eth: 0,
          realized_pnl_eth: 0
        },
        holdings: holdings.results || [],
        recent_sales: soldAssets.results || []
      }
    });
  } catch (error: any) {
    console.error('Portfolio fetch error:', error);
    return c.json({ error: 'í¬íŠ¸í´ë¦¬ì˜¤ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 19. í¬íŠ¸í´ë¦¬ì˜¤ ìŠ¤ëƒ…ìƒ· ìƒì„± (ì¼ì¼ ì§‘ê³„)
app.post('/api/portfolio/:userId/snapshot', async (c) => {
  const { env } = c;
  const userId = c.req.param('userId');
  
  try {
    const today = new Date().toISOString().split('T')[0];
    
    // ë³´ìœ  ìì‚° í†µê³„ ê³„ì‚°
    const holdings = await env.DB.prepare(`
      SELECT 
        COUNT(*) as total_items,
        SUM(current_value_eth) as total_value_eth,
        SUM(purchase_price_eth) as total_cost_eth,
        SUM(unrealized_pnl_eth) as unrealized_pnl_eth,
        COUNT(DISTINCT artwork_id) as unique_items,
        AVG(julianday('now') - julianday(purchase_date)) as avg_holding_days
      FROM nft_investment_tracking
      WHERE user_id = ? AND status = 'holding'
    `).bind(userId).first();
    
    // íŒë§¤ ì´ë ¥ í†µê³„
    const sales = await env.DB.prepare(`
      SELECT 
        SUM(realized_pnl_eth) as realized_pnl_eth,
        COUNT(*) as total_sales
      FROM nft_investment_tracking
      WHERE user_id = ? AND status = 'sold'
    `).bind(userId).first();
    
    // ìŠ¤ëƒ…ìƒ· ì €ì¥
    await env.DB.prepare(`
      INSERT OR REPLACE INTO user_portfolio_snapshots 
        (user_id, snapshot_date, total_value_eth, total_items, 
         total_cost_eth, unrealized_pnl_eth, realized_pnl_eth,
         unrealized_pnl_percentage, avg_holding_period_days)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      userId, today,
      holdings?.total_value_eth || 0,
      holdings?.total_items || 0,
      holdings?.total_cost_eth || 0,
      holdings?.unrealized_pnl_eth || 0,
      sales?.realized_pnl_eth || 0,
      ((holdings?.unrealized_pnl_eth || 0) / (holdings?.total_cost_eth || 1)) * 100,
      holdings?.avg_holding_days || 0
    ).run();
    
    return c.json({
      success: true,
      message: 'í¬íŠ¸í´ë¦¬ì˜¤ ìŠ¤ëƒ…ìƒ· ìƒì„± ì™„ë£Œ',
      data: {
        snapshot_date: today,
        total_value_eth: holdings?.total_value_eth || 0,
        pnl_eth: (holdings?.unrealized_pnl_eth || 0) + (sales?.realized_pnl_eth || 0)
      }
    });
  } catch (error: any) {
    console.error('Portfolio snapshot error:', error);
    return c.json({ error: 'ìŠ¤ëƒ…ìƒ· ìƒì„± ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 20. í¬íŠ¸í´ë¦¬ì˜¤ ì•Œë¦¼ ì„¤ì •
app.post('/api/portfolio/alerts', async (c) => {
  const { env } = c;
  const { alert_type, artwork_id, collection_id, threshold_percentage, threshold_eth } = await c.req.json();
  const userId = 1; // TODO: ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  
  try {
    const result = await env.DB.prepare(`
      INSERT INTO portfolio_alerts 
        (user_id, alert_type, artwork_id, collection_id, 
         threshold_percentage, threshold_eth, is_active)
      VALUES (?, ?, ?, ?, ?, ?, 1)
    `).bind(userId, alert_type, artwork_id, collection_id, 
            threshold_percentage, threshold_eth).run();
    
    return c.json({
      success: true,
      message: 'ì•Œë¦¼ ì„¤ì • ì™„ë£Œ',
      data: { alert_id: result.meta.last_row_id }
    });
  } catch (error: any) {
    console.error('Alert creation error:', error);
    return c.json({ error: 'ì•Œë¦¼ ì„¤ì • ì‹¤íŒ¨: ' + error.message }, 500);
  }
});


// ========== MULTI-CHAIN APIs ==========

// 21. ì§€ì› ë¸”ë¡ì²´ì¸ ë„¤íŠ¸ì›Œí¬ ëª©ë¡
app.get('/api/chains', async (c) => {
  const { env } = c;
  const { is_testnet = 'false' } = c.req.query();
  
  try {
    const chains = await env.DB.prepare(`
      SELECT * FROM blockchain_networks 
      WHERE is_active = 1 AND is_testnet = ?
      ORDER BY chain_id
    `).bind(is_testnet === 'true' ? 1 : 0).all();
    
    return c.json({
      success: true,
      data: chains.results || []
    });
  } catch (error: any) {
    console.error('Chains fetch error:', error);
    return c.json({ error: 'ì²´ì¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 22. ì²´ì¸ë³„ ì‘í’ˆ ëª©ë¡
app.get('/api/artworks/chain/:chainId', async (c) => {
  const { env } = c;
  const chainId = c.req.param('chainId');
  const { page = '1', limit = '20' } = c.req.query();
  
  try {
    const pageNum = parseInt(page as string);
    const limitNum = parseInt(limit as string);
    const offset = (pageNum - 1) * limitNum;
    
    const artworks = await env.DB.prepare(`
      SELECT 
        a.*,
        ar.name as artist_name,
        bn.chain_name,
        bn.native_currency_symbol
      FROM artworks a
      JOIN artists ar ON a.artist_id = ar.id
      LEFT JOIN blockchain_networks bn ON a.chain_id = bn.chain_id
      WHERE a.chain_id = ?
      ORDER BY a.created_at DESC
      LIMIT ? OFFSET ?
    `).bind(chainId, limitNum, offset).all();
    
    return c.json({
      success: true,
      data: artworks.results || []
    });
  } catch (error: any) {
    console.error('Chain artworks error:', error);
    return c.json({ error: 'ì²´ì¸ë³„ ì‘í’ˆ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});


// ========== ACTIVITY FEED APIs ==========

// 23. ì‚¬ìš©ì í™œë™ í”¼ë“œ ì¡°íšŒ
app.get('/api/activity/:userId', async (c) => {
  const { env } = c;
  const userId = c.req.param('userId');
  const { page = '1', limit = '20' } = c.req.query();
  
  try {
    const pageNum = parseInt(page as string);
    const limitNum = parseInt(limit as string);
    const offset = (pageNum - 1) * limitNum;
    
    const activities = await env.DB.prepare(`
      SELECT * FROM v_activity_feed_detail
      WHERE user_id = ?
      ORDER BY created_at DESC
      LIMIT ? OFFSET ?
    `).bind(userId, limitNum, offset).all();
    
    return c.json({
      success: true,
      data: activities.results || []
    });
  } catch (error: any) {
    console.error('Activity feed error:', error);
    return c.json({ error: 'í™œë™ í”¼ë“œ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 24. ì‚¬ìš©ì íŒ”ë¡œìš°
app.post('/api/users/:targetUserId/follow', async (c) => {
  const { env } = c;
  const targetUserId = c.req.param('targetUserId');
  const followerId = 1; // TODO: ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  
  try {
    await env.DB.prepare(`
      INSERT OR IGNORE INTO user_follows (follower_id, following_id)
      VALUES (?, ?)
    `).bind(followerId, targetUserId).run();
    
    return c.json({
      success: true,
      message: 'íŒ”ë¡œìš° ì™„ë£Œ'
    });
  } catch (error: any) {
    console.error('Follow error:', error);
    return c.json({ error: 'íŒ”ë¡œìš° ì‹¤íŒ¨: ' + error.message }, 500);
  }
});

// 25. ì»¬ë ‰ì…˜ íŒ”ë¡œìš°
app.post('/api/collections/:collectionId/follow', async (c) => {
  const { env } = c;
  const collectionId = c.req.param('collectionId');
  const userId = 1; // TODO: ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  
  try {
    await env.DB.prepare(`
      INSERT OR IGNORE INTO collection_follows 
        (user_id, collection_id, notify_on_new_items, notify_on_price_changes)
      VALUES (?, ?, 1, 1)
    `).bind(userId, collectionId).run();
    
    return c.json({
      success: true,
      message: 'ì»¬ë ‰ì…˜ íŒ”ë¡œìš° ì™„ë£Œ'
    });
  } catch (error: any) {
    console.error('Collection follow error:', error);
    return c.json({ error: 'ì»¬ë ‰ì…˜ íŒ”ë¡œìš° ì‹¤íŒ¨: ' + error.message }, 500);
  }
});


// ========== ADDITIONAL UTILITY APIs ==========

// 26. Sitemap.xml ìƒì„± (SEO)
app.get('/sitemap.xml', async (c) => {
  const { env } = c;
  
  try {
    const artworks = await env.DB.prepare(`
      SELECT id, updated_at FROM artworks 
      WHERE status = 'active'
      ORDER BY updated_at DESC
      LIMIT 1000
    `).all();
    
    const collections = await env.DB.prepare(`
      SELECT collection_slug, updated_at FROM artwork_collections
      ORDER BY updated_at DESC
      LIMIT 100
    `).all();
    
    let sitemap = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  <url>
    <loc>https://gallerypia.pages.dev/</loc>
    <changefreq>daily</changefreq>
    <priority>1.0</priority>
  </url>
  <url>
    <loc>https://gallerypia.pages.dev/gallery</loc>
    <changefreq>daily</changefreq>
    <priority>0.9</priority>
  </url>
  <url>
    <loc>https://gallerypia.pages.dev/collections</loc>
    <changefreq>daily</changefreq>
    <priority>0.9</priority>
  </url>
`;
    
    // Artworks
    for (const artwork of (artworks.results || [])) {
      sitemap += `  <url>
    <loc>https://gallerypia.pages.dev/artwork/${artwork.id}</loc>
    <lastmod>${artwork.updated_at}</lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.8</priority>
  </url>
`;
    }
    
    // Collections
    for (const collection of (collections.results || [])) {
      sitemap += `  <url>
    <loc>https://gallerypia.pages.dev/collection/${collection.collection_slug}</loc>
    <lastmod>${collection.updated_at}</lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.7</priority>
  </url>
`;
    }
    
    sitemap += `</urlset>`;
    
    return c.text(sitemap, 200, {
      'Content-Type': 'application/xml'
    });
  } catch (error: any) {
    console.error('Sitemap generation error:', error);
    return c.text('<?xml version="1.0" encoding="UTF-8"?><urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"></urlset>', 500, {
      'Content-Type': 'application/xml'
    });
  }
});

// 27. Robots.txt
app.get('/robots.txt', (c) => {
  return c.text(`User-agent: *
Allow: /

Sitemap: https://gallerypia.pages.dev/sitemap.xml
`, 200, {
    'Content-Type': 'text/plain'
  });
});

// ========================================
// 28. AI AUTHENTICITY VERIFICATION APIs
// ========================================

// Start AI verification for an artwork
app.post('/api/admin/authenticity/verify/:artworkId', async (c) => {
  const artworkId = c.req.param('artworkId')
  const db = c.env.DB
  
  try {
    const artwork = await db.prepare(`
      SELECT a.*, u.username as artist_name, u.id as artist_id
      FROM artworks a
      JOIN users u ON a.artist_id = u.id
      WHERE a.id = ?
    `).bind(artworkId).first()
    
    if (!artwork) {
      return c.json({ success: false, message: 'ì‘í’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' })
    }
    
    const verification = await db.prepare(`
      INSERT INTO authenticity_verifications (
        artwork_id, verification_type, status, verification_started_at, ai_model_version
      ) VALUES (?, ?, ?, CURRENT_TIMESTAMP, ?)
    `).bind(artworkId, 'initial', 'processing', 'v1.0').run()
    
    const verificationId = verification.meta.last_row_id
    
    // Simulated AI analysis
    const aiScore = 85.5 + Math.random() * 10
    const styleScore = 78.0 + Math.random() * 15
    
    await db.prepare(`
      UPDATE authenticity_verifications
      SET status = 'verified', ai_confidence_score = ?, style_match_score = ?,
          technical_analysis = ?, image_hash = ?, risk_level = 'low',
          blockchain_verified = 1, metadata_verified = 1, final_result = 'authentic',
          verification_completed_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(aiScore, styleScore, JSON.stringify({ brushwork: 'consistent' }), 
            'ph:' + Math.random().toString(36).substring(7), verificationId).run()
    
    return c.json({
      success: true,
      message: 'AI ì§„ìœ„ ê²€ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
      verification: { id: verificationId, status: 'verified', confidence: aiScore.toFixed(2) }
    })
  } catch (error: any) {
    return c.json({ success: false, message: 'AI ê²€ì¦ ì¤‘ ì˜¤ë¥˜: ' + error.message })
  }
})

// Get verification history
app.get('/api/authenticity/history/:artworkId', async (c) => {
  const artworkId = c.req.param('artworkId')
  const db = c.env.DB
  
  try {
    const results = await db.prepare(`
      SELECT av.*, a.title, u.username as artist_name
      FROM authenticity_verifications av
      JOIN artworks a ON av.artwork_id = a.id
      JOIN users u ON a.artist_id = u.id
      WHERE av.artwork_id = ?
      ORDER BY av.created_at DESC
    `).bind(artworkId).all()
    
    return c.json({ success: true, verifications: results.results })
  } catch (error: any) {
    return c.json({ success: false, message: error.message })
  }
})

// Get pending verifications
app.get('/api/admin/authenticity/pending', async (c) => {
  const db = c.env.DB
  try {
    const results = await db.prepare(`
      SELECT * FROM pending_verifications_view LIMIT 50
    `).all()
    return c.json({ success: true, pending: results.results })
  } catch (error: any) {
    return c.json({ success: false, message: error.message })
  }
})

// ========================================
// 29. ROYALTY AUTOMATION APIs
// ========================================

// Get pending royalty payments
app.get('/api/admin/royalty/pending', async (c) => {
  const db = c.env.DB
  try {
    const results = await db.prepare(`
      SELECT 
        rd.id,
        rd.recipient_type,
        rd.recipient_id,
        rd.amount_eth,
        rd.payment_status,
        a.title as artwork_title,
        st.sale_date,
        rd.created_at,
        ROUND((julianday('now') - julianday(rd.created_at)) * 24, 2) as hours_pending
      FROM royalty_distributions rd
      JOIN sale_transactions st ON rd.sale_transaction_id = st.id
      JOIN artworks a ON st.artwork_id = a.id
      WHERE rd.payment_status IN ('pending', 'processing')
      ORDER BY rd.created_at ASC
      LIMIT 50
    `).all()
    return c.json({ success: true, payments: results.results })
  } catch (error: any) {
    return c.json({ success: false, message: error.message })
  }
})

// Configure royalty split
app.post('/api/admin/royalty/configure/:artworkId', async (c) => {
  const artworkId = c.req.param('artworkId')
  const { artist_split, gallery_split, curator_split, platform_split, artist_id, gallery_id } = await c.req.json()
  const db = c.env.DB
  
  try {
    const total = (artist_split || 0) + (gallery_split || 0) + (curator_split || 0) + (platform_split || 0)
    if (Math.abs(total - 100) > 0.01) {
      return c.json({ success: false, message: 'ë¶„ë°° ë¹„ìœ¨ í•©ê³„ê°€ 100%ì—¬ì•¼ í•©ë‹ˆë‹¤.' })
    }
    
    await db.prepare(`UPDATE royalty_configurations SET is_active = 0 WHERE artwork_id = ?`).bind(artworkId).run()
    
    const result = await db.prepare(`
      INSERT INTO royalty_configurations (
        artwork_id, artist_split_percentage, gallery_split_percentage,
        curator_split_percentage, platform_split_percentage, artist_id, gallery_id, is_active
      ) VALUES (?, ?, ?, ?, ?, ?, ?, 1)
    `).bind(artworkId, artist_split, gallery_split || 0, curator_split || 0, platform_split, artist_id, gallery_id || null).run()
    
    return c.json({ success: true, config_id: result.meta.last_row_id })
  } catch (error: any) {
    return c.json({ success: false, message: error.message })
  }
})

// Get artist royalty dashboard
app.get('/api/royalty/artist/:artistId', async (c) => {
  const artistId = c.req.param('artistId')
  const db = c.env.DB
  
  try {
    const dashboard = await db.prepare(`
      SELECT * FROM artist_royalty_dashboard WHERE artist_id = ?
    `).bind(artistId).first()
    
    const pending = await db.prepare(`
      SELECT * FROM pending_royalty_payments
      WHERE recipient_type = 'artist' AND recipient_id = ?
    `).bind(artistId).all()
    
    return c.json({ success: true, dashboard: dashboard || {}, pending: pending.results })
  } catch (error: any) {
    return c.json({ success: false, message: error.message })
  }
})

// ========================================
// 30. MUSEUM PARTNERSHIP APIs
// ========================================

// Apply for partnership (Museum/Gallery/Art Dealer)
app.post('/api/museum/apply', async (c) => {
  const { partner_category, applicant_name, applicant_email, museum_name, museum_type, partnership_reason } = await c.req.json()
  const db = c.env.DB
  
  try {
    const result = await db.prepare(`
      INSERT INTO museum_partnership_applications (
        partner_category, applicant_name, applicant_email, museum_name, museum_type,
        museum_country, partnership_reason, application_status
      ) VALUES (?, ?, ?, ?, ?, 'KR', ?, 'submitted')
    `).bind(
      partner_category || 'museum',
      applicant_name, 
      applicant_email, 
      museum_name, 
      museum_type || 'other',
      partnership_reason
    ).run()
    
    const categoryNames = {
      museum: 'ë¯¸ìˆ ê´€',
      gallery: 'ê°¤ëŸ¬ë¦¬',
      art_dealer: 'ì•„íŠ¸ë”œëŸ¬'
    }
    const categoryName = categoryNames[partner_category as keyof typeof categoryNames] || 'íŒŒíŠ¸ë„ˆì‹­'
    
    return c.json({ 
      success: true, 
      message: `${categoryName} íŒŒíŠ¸ë„ˆì‹­ ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, 
      application_id: result.meta.last_row_id 
    })
  } catch (error: any) {
    return c.json({ success: false, message: error.message })
  }
})

// Get pending applications
app.get('/api/admin/museum/applications/pending', async (c) => {
  const db = c.env.DB
  try {
    const results = await db.prepare(`
      SELECT * FROM pending_partnership_applications ORDER BY submitted_at ASC
    `).all()
    return c.json({ success: true, applications: results.results })
  } catch (error: any) {
    return c.json({ success: false, message: error.message })
  }
})

// Approve application
app.post('/api/admin/museum/applications/:id/approve', async (c) => {
  const appId = c.req.param('id')
  const { partnership_tier, revenue_share } = await c.req.json()
  const db = c.env.DB
  
  try {
    const app = await db.prepare(`SELECT * FROM museum_partnership_applications WHERE id = ?`).bind(appId).first()
    if (!app) return c.json({ success: false, message: 'ì‹ ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' })
    
    const partner = await db.prepare(`
      INSERT INTO museum_partners (
        partner_category, museum_name, museum_type, contact_email, contact_person_name,
        country, partnership_status, partnership_tier, partnership_start_date,
        revenue_share_percentage, verified
      ) VALUES (?, ?, ?, ?, ?, 'KR', 'approved', ?, DATE('now'), ?, 1)
    `).bind(
      app.partner_category || 'museum',
      app.museum_name, 
      app.museum_type, 
      app.applicant_email, 
      app.applicant_name,
      partnership_tier || 'bronze', 
      revenue_share || 15.0
    ).run()
    
    await db.prepare(`
      UPDATE museum_partnership_applications
      SET application_status = 'approved', decision_at = CURRENT_TIMESTAMP, museum_partner_id = ?
      WHERE id = ?
    `).bind(partner.meta.last_row_id, appId).run()
    
    return c.json({ success: true, museum_partner_id: partner.meta.last_row_id })
  } catch (error: any) {
    return c.json({ success: false, message: error.message })
  }
})

// ========================================
// 31. AI Authenticity Verification Admin Page
// ========================================
app.get('/admin/authenticity', async (c) => {
  const db = c.env.DB
  
  const content = `
  <section class="py-8">
      <div class="container mx-auto px-4">
          <div class="mb-8">
              <h1 class="text-4xl font-bold text-white mb-2">
                  <i class="fas fa-robot text-purple-500 mr-3"></i>
                  AI ì‘í’ˆ ì§„ìœ„ ê²€ì¦
              </h1>
              <p class="text-gray-400">ì»´í“¨í„° ë¹„ì „ ê¸°ë°˜ ìœ„ì‘ íƒì§€ ì‹œìŠ¤í…œ</p>
          </div>
          
          <!-- í†µê³„ ì¹´ë“œ -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
              <div class="card-nft rounded-2xl p-6 border-l-4 border-green-500">
                  <h3 class="text-gray-400 text-sm mb-2">ê²€ì¦ ì™„ë£Œ</h3>
                  <p class="text-3xl font-bold text-white" id="verifiedCount">0</p>
              </div>
              <div class="card-nft rounded-2xl p-6 border-l-4 border-yellow-500">
                  <h3 class="text-gray-400 text-sm mb-2">ê²€í†  ëŒ€ê¸°</h3>
                  <p class="text-3xl font-bold text-white" id="pendingCount">0</p>
              </div>
              <div class="card-nft rounded-2xl p-6 border-l-4 border-red-500">
                  <h3 class="text-gray-400 text-sm mb-2">ì˜ì‹¬ ì‘í’ˆ</h3>
                  <p class="text-3xl font-bold text-white" id="suspiciousCount">0</p>
              </div>
              <div class="card-nft rounded-2xl p-6 border-l-4 border-purple-500">
                  <h3 class="text-gray-400 text-sm mb-2">í‰ê·  ì‹ ë¢°ë„</h3>
                  <p class="text-3xl font-bold text-white" id="avgConfidence">0%</p>
              </div>
          </div>
          
          <!-- ëŒ€ê¸° ì¤‘ì¸ ê²€ì¦ -->
          <div class="card-nft rounded-2xl p-6 mb-8">
              <h2 class="text-xl font-bold text-white mb-4">ëŒ€ê¸° ì¤‘ì¸ ê²€ì¦</h2>
              <div id="pendingList" class="space-y-4"></div>
          </div>
          
          <!-- ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ì‘í’ˆ -->
          <div class="card-nft rounded-2xl p-6">
              <h2 class="text-xl font-bold text-white mb-4">ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ì‘í’ˆ</h2>
              <div id="suspiciousList" class="space-y-4"></div>
          </div>
      </div>
  </section>
  
  <script>
      async function loadAuthenticityData() {
          try {
              const pending = await fetch('/api/admin/authenticity/pending').then(r => r.json())
              document.getElementById('pendingCount').textContent = pending.pending?.length || 0
              
              const pendingList = document.getElementById('pendingList')
              if (pending.pending && pending.pending.length > 0) {
                  pendingList.innerHTML = pending.pending.map(v => \`
                      <div class="flex items-center justify-between p-4 bg-gray-900 rounded-lg">
                          <div>
                              <h3 class="text-white font-bold">\${v.artwork_title}</h3>
                              <p class="text-sm text-gray-400">ì‘ê°€: \${v.artist_name}</p>
                          </div>
                          <button onclick="startVerification(\${v.artwork_id})" 
                                  class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg">
                              ê²€ì¦ ì‹œì‘
                          </button>
                      </div>
                  \`).join('')
              } else {
                  pendingList.innerHTML = '<p class="text-gray-500 text-center py-4">ëŒ€ê¸° ì¤‘ì¸ ê²€ì¦ì´ ì—†ìŠµë‹ˆë‹¤.</p>'
              }
          } catch (error) {
              console.error('Error loading data:', error)
          }
      }
      
      async function startVerification(artworkId) {
          try {
              const result = await fetch(\`/api/admin/authenticity/verify/\${artworkId}\`, {
                  method: 'POST'
              }).then(r => r.json())
              
              if (result.success) {
                  alert('âœ… ' + result.message + '\\nì‹ ë¢°ë„: ' + result.verification.confidence + '%')
                  loadAuthenticityData()
              } else {
                  alert('âŒ ' + result.message)
              }
          } catch (error) {
              alert('ì˜¤ë¥˜: ' + error.message)
          }
      }
      
      loadAuthenticityData()
  </script>
  `
  
  return c.html(getLayout(content, 'AI ì§„ìœ„ ê²€ì¦ - GALLERYPIA'))
})

// ========================================
// 32. Royalty Dashboard Admin Page
// ========================================
app.get('/admin/royalty', async (c) => {
  const content = `
  <section class="py-8">
      <div class="container mx-auto px-4">
          <div class="mb-8">
              <h1 class="text-4xl font-bold text-white mb-2">
                  <i class="fas fa-coins text-cyan-500 mr-3"></i>
                  ë¡œì—´í‹° ìë™í™” ê´€ë¦¬
              </h1>
              <p class="text-gray-400">2ì°¨/3ì°¨ íŒë§¤ ì¶”ì  ë° ìë™ ë¶„ë°°</p>
          </div>
          
          <!-- í†µê³„ -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
              <div class="card-nft rounded-2xl p-6">
                  <h3 class="text-gray-400 text-sm mb-2">ì´ ë¡œì—´í‹° ìˆ˜ìµ</h3>
                  <p class="text-3xl font-bold text-white">0 ETH</p>
              </div>
              <div class="card-nft rounded-2xl p-6">
                  <h3 class="text-gray-400 text-sm mb-2">ëŒ€ê¸° ì¤‘ì¸ ì§€ê¸‰</h3>
                  <p class="text-3xl font-bold text-yellow-400">0 ETH</p>
              </div>
              <div class="card-nft rounded-2xl p-6">
                  <h3 class="text-gray-400 text-sm mb-2">ì™„ë£Œëœ ì§€ê¸‰</h3>
                  <p class="text-3xl font-bold text-green-400">0 ETH</p>
              </div>
              <div class="card-nft rounded-2xl p-6">
                  <h3 class="text-gray-400 text-sm mb-2">ì´ ê±°ë˜ ê±´ìˆ˜</h3>
                  <p class="text-3xl font-bold text-white">0</p>
              </div>
          </div>
          
          <div class="card-nft rounded-2xl p-6">
              <h2 class="text-xl font-bold text-white mb-4">ëŒ€ê¸° ì¤‘ì¸ ë¡œì—´í‹° ì§€ê¸‰</h2>
              <div class="overflow-x-auto">
                  <table class="w-full">
                      <thead>
                          <tr class="border-b border-gray-700">
                              <th class="text-left py-3 text-gray-400">ì‘í’ˆ</th>
                              <th class="text-left py-3 text-gray-400">ìˆ˜ë ¹ì</th>
                              <th class="text-left py-3 text-gray-400">ê¸ˆì•¡</th>
                              <th class="text-left py-3 text-gray-400">ìƒíƒœ</th>
                          </tr>
                      </thead>
                      <tbody id="royaltyList">
                          <tr><td colspan="4" class="text-center py-8 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>
                      </tbody>
                  </table>
              </div>
          </div>
      </div>
  </section>
  `
  
  return c.html(getLayout(content, 'ë¡œì—´í‹° ê´€ë¦¬ - GALLERYPIA'))
})

// ========================================
// 33. Museum Partnership Admin Page
// ========================================
app.get('/admin/museum', async (c) => {
  const content = `
  <section class="py-8">
      <div class="container mx-auto px-4">
          <div class="mb-8">
              <h1 class="text-4xl font-bold text-white mb-2">
                  <i class="fas fa-handshake text-amber-500 mr-3"></i>
                  Partnership ê´€ë¦¬
              </h1>
              <p class="text-gray-400">ë¯¸ìˆ ê´€, ê°¤ëŸ¬ë¦¬, ì•„íŠ¸ë”œëŸ¬ íŒŒíŠ¸ë„ˆ ì‹ ì²­ ë° ìŠ¹ì¸</p>
          </div>
          
          <!-- ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ -->
          <div class="card-nft rounded-2xl p-6 mb-8">
              <h2 class="text-xl font-bold text-white mb-4">ëŒ€ê¸° ì¤‘ì¸ íŒŒíŠ¸ë„ˆì‹­ ì‹ ì²­</h2>
              <div id="applicationsList" class="space-y-4"></div>
          </div>
          
          <!-- í™œì„± íŒŒíŠ¸ë„ˆ -->
          <div class="card-nft rounded-2xl p-6">
              <h2 class="text-xl font-bold text-white mb-4">í™œì„± íŒŒíŠ¸ë„ˆ</h2>
              <div id="partnersList" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
          </div>
      </div>
  </section>
  
  <script>
      async function loadMuseumData() {
          try {
              const apps = await fetch('/api/admin/museum/applications/pending').then(r => r.json())
              const appsList = document.getElementById('applicationsList')
              
              if (apps.applications && apps.applications.length > 0) {
                  appsList.innerHTML = apps.applications.map(app => {
                      const categoryIcons = {
                          museum: 'ğŸ›ï¸',
                          gallery: 'ğŸ–¼ï¸',
                          art_dealer: 'ğŸ’¼'
                      }
                      const categoryNames = {
                          museum: 'ë¯¸ìˆ ê´€',
                          gallery: 'ê°¤ëŸ¬ë¦¬',
                          art_dealer: 'ì•„íŠ¸ë”œëŸ¬'
                      }
                      const icon = categoryIcons[app.partner_category] || 'ğŸ›ï¸'
                      const categoryName = categoryNames[app.partner_category] || 'ë¯¸ìˆ ê´€'
                      
                      return \`
                      <div class="flex items-center justify-between p-4 bg-gray-900 rounded-lg">
                          <div class="flex-1">
                              <div class="flex items-center gap-2 mb-1">
                                  <span class="text-2xl">\${icon}</span>
                                  <h3 class="text-white font-bold text-lg">\${app.museum_name}</h3>
                                  <span class="px-2 py-0.5 bg-purple-900/50 text-purple-300 text-xs rounded-full">\${categoryName}</span>
                              </div>
                              <p class="text-sm text-gray-400">ì‹ ì²­ì: \${app.applicant_name} (\${app.applicant_email})</p>
                              <p class="text-xs text-gray-500 mt-1">\${app.partnership_reason}</p>
                              <p class="text-xs text-gray-500">ëŒ€ê¸°: \${app.days_pending}ì¼</p>
                          </div>\`
                  })
                          <div class="flex gap-2">
                              <button onclick="approveApplication(\${app.id})" 
                                      class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">
                                  ìŠ¹ì¸
                              </button>
                              <button onclick="rejectApplication(\${app.id})" 
                                      class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
                                  ê±°ì ˆ
                              </button>
                          </div>
                      </div>
                  \`).join('')
              } else {
                  appsList.innerHTML = '<p class="text-gray-500 text-center py-4">ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>'
              }
          } catch (error) {
              console.error('Error:', error)
          }
      }
      
      async function approveApplication(id) {
          try {
              const tier = prompt('íŒŒíŠ¸ë„ˆì‹­ ë“±ê¸‰ì„ ì…ë ¥í•˜ì„¸ìš” (bronze/silver/gold/platinum):', 'bronze')
              const revenue = prompt('ìˆ˜ìµ ë¶„ë°°ìœ¨ì„ ì…ë ¥í•˜ì„¸ìš” (%):', '15')
              
              const result = await fetch(\`/api/admin/museum/applications/\${id}/approve\`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ 
                      partnership_tier: tier, 
                      revenue_share: parseFloat(revenue) 
                  })
              }).then(r => r.json())
              
              if (result.success) {
                  alert('âœ… íŒŒíŠ¸ë„ˆì‹­ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!')
                  loadMuseumData()
              } else {
                  alert('âŒ ' + result.message)
              }
          } catch (error) {
              alert('ì˜¤ë¥˜: ' + error.message)
          }
      }
      
      loadMuseumData()
  </script>
  `
  
  return c.html(getLayout(content, 'Partnership ê´€ë¦¬ - GALLERYPIA'))
})

// ========================================
// 34. Museum Partnership Public Apply Page
// ========================================
app.get('/museum/apply', async (c) => {
  const content = `
  <section class="py-16">
      <div class="container mx-auto px-4 max-w-3xl">
          <div class="text-center mb-12">
              <h1 class="text-5xl font-bold text-white mb-4">
                  <i class="fas fa-handshake text-amber-500 mr-3"></i>
                  Partnership Program
              </h1>
              <p class="text-xl text-gray-400">ê°¤ëŸ¬ë¦¬í”¼ì•„ì™€ í•¨ê»˜ NFT í”„ë¡œê·¸ë¨ì„ ì‹œì‘í•˜ì„¸ìš”</p>
              <div class="mt-4 flex justify-center gap-3">
                  <span class="px-3 py-1 bg-purple-900/50 text-purple-300 rounded-full text-sm">
                      <i class="fas fa-landmark mr-1"></i>ë¯¸ìˆ ê´€
                  </span>
                  <span class="px-3 py-1 bg-pink-900/50 text-pink-300 rounded-full text-sm">
                      <i class="fas fa-palette mr-1"></i>ê°¤ëŸ¬ë¦¬
                  </span>
                  <span class="px-3 py-1 bg-amber-900/50 text-amber-300 rounded-full text-sm">
                      <i class="fas fa-briefcase mr-1"></i>ì•„íŠ¸ë”œëŸ¬
                  </span>
              </div>
          </div>
          
          <div class="card-nft rounded-3xl p-8">
              <form id="partnershipForm" class="space-y-6">
                  <!-- íŒŒíŠ¸ë„ˆ ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
                  <div>
                      <label class="block text-white font-bold mb-2">íŒŒíŠ¸ë„ˆ ìœ í˜• *</label>
                      <select id="partner_category" required onchange="updateFormLabels()"
                              class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                          <option value="museum">ğŸ›ï¸ ë¯¸ìˆ ê´€ (Museum)</option>
                          <option value="gallery">ğŸ–¼ï¸ ê°¤ëŸ¬ë¦¬ (Gallery)</option>
                          <option value="art_dealer">ğŸ’¼ ì•„íŠ¸ë”œëŸ¬ (Art Dealer)</option>
                      </select>
                      <p class="text-xs text-gray-500 mt-1">ê·€í•˜ì˜ ì‚¬ì—… ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                  </div>
                  
                  <div>
                      <label class="block text-white font-bold mb-2">
                          <span id="institution_label">ê¸°ê´€ëª…</span> *
                      </label>
                      <input type="text" id="museum_name" required
                             class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none"
                             placeholder="ì˜ˆ: êµ­ë¦½í˜„ëŒ€ë¯¸ìˆ ê´€">
                  </div>
                  
                  <div>
                      <label class="block text-white font-bold mb-2">
                          <span id="type_label">ê¸°ê´€ ìœ í˜•</span> *
                      </label>
                      <select id="museum_type" required
                              class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                          <option value="national">êµ­ë¦½</option>
                          <option value="public">ê³µë¦½</option>
                          <option value="private">ì‚¬ë¦½</option>
                          <option value="university">ëŒ€í•™</option>
                          <option value="corporate">ê¸°ì—…</option>
                          <option value="other">ê¸°íƒ€</option>
                      </select>
                  </div>
                  
                  <div>
                      <label class="block text-white font-bold mb-2">ë‹´ë‹¹ì ì´ë¦„ *</label>
                      <input type="text" id="applicant_name" required
                             class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                  </div>
                  
                  <div>
                      <label class="block text-white font-bold mb-2">ì´ë©”ì¼ *</label>
                      <input type="email" id="applicant_email" required
                             class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                  </div>
                  
                  <div>
                      <label class="block text-white font-bold mb-2">íŒŒíŠ¸ë„ˆì‹­ ì‹ ì²­ ì´ìœ  *</label>
                      <textarea id="partnership_reason" required rows="4"
                                class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none"
                                placeholder="NFT í”„ë¡œê·¸ë¨ ê³„íš, ê¸°ëŒ€ íš¨ê³¼ ë“±ì„ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”"></textarea>
                  </div>
                  
                  <button type="submit" 
                          class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold rounded-xl transition">
                      <i class="fas fa-paper-plane mr-2"></i>
                      íŒŒíŠ¸ë„ˆì‹­ ì‹ ì²­í•˜ê¸°
                  </button>
              </form>
          </div>
      </div>
  </section>
  
  <script>
      // íŒŒíŠ¸ë„ˆ ìœ í˜•ì— ë”°ë¼ í¼ ë ˆì´ë¸” ë™ì  ë³€ê²½
      function updateFormLabels() {
          const category = document.getElementById('partner_category').value
          const institutionLabel = document.getElementById('institution_label')
          const typeLabel = document.getElementById('type_label')
          
          if (category === 'museum') {
              institutionLabel.textContent = 'ë¯¸ìˆ ê´€ ì´ë¦„'
              typeLabel.textContent = 'ë¯¸ìˆ ê´€ ìœ í˜•'
          } else if (category === 'gallery') {
              institutionLabel.textContent = 'ê°¤ëŸ¬ë¦¬ ì´ë¦„'
              typeLabel.textContent = 'ê°¤ëŸ¬ë¦¬ ìœ í˜•'
          } else if (category === 'art_dealer') {
              institutionLabel.textContent = 'íšŒì‚¬ëª…/ìƒí˜¸'
              typeLabel.textContent = 'ì‚¬ì—… ìœ í˜•'
          } else {
              institutionLabel.textContent = 'ê¸°ê´€ëª…'
              typeLabel.textContent = 'ê¸°ê´€ ìœ í˜•'
          }
      }
      
      document.getElementById('partnershipForm').addEventListener('submit', async (e) => {
          e.preventDefault()
          
          const data = {
              partner_category: document.getElementById('partner_category').value,
              museum_name: document.getElementById('museum_name').value,
              museum_type: document.getElementById('museum_type').value,
              applicant_name: document.getElementById('applicant_name').value,
              applicant_email: document.getElementById('applicant_email').value,
              partnership_reason: document.getElementById('partnership_reason').value
          }
          
          try {
              const result = await fetch('/api/museum/apply', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(data)
              }).then(r => r.json())
              
              if (result.success) {
                  alert('âœ… ' + result.message + '\\nì‹ ì²­ ID: ' + result.application_id)
                  document.getElementById('partnershipForm').reset()
              } else {
                  alert('âŒ ' + result.message)
              }
          } catch (error) {
              alert('ì˜¤ë¥˜: ' + error.message)
          }
      })
  </script>
  `
  
  return c.html(getLayout(content, 'Partnership ì‹ ì²­ - GALLERYPIA'))
})

// Upload Artwork Page
app.get('/upload-artwork', (c) => {
  const uploadHTML = `
    <div class="min-h-screen py-20 px-4">
        <div class="max-w-3xl mx-auto">
            <a href="/dashboard" class="inline-flex items-center text-gray-400 hover:text-white mb-8 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i> ëŒ€ì‹œë³´ë“œë¡œ
            </a>
            
            <h1 class="text-4xl font-bold mb-8">ì‘í’ˆ ì—…ë¡œë“œ</h1>
            
            <form id="uploadForm" class="space-y-8">
                <div class="bg-gray-900 rounded-xl p-8 border border-gray-800">
                    <h2 class="text-xl font-bold mb-4">ì´ë¯¸ì§€ ì—…ë¡œë“œ</h2>
                    <div id="dropzone" class="border-2 border-dashed border-gray-700 rounded-xl p-12 text-center cursor-pointer hover:border-purple-500 transition-colors">
                        <i class="fas fa-cloud-upload-alt text-6xl text-gray-600 mb-4"></i>
                        <p class="text-gray-400 mb-2">ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                        <input type="file" id="imageInput" accept="image/*" class="hidden">
                        <button type="button" onclick="document.getElementById('imageInput').click()" class="mt-4 px-6 py-3 bg-purple-500 hover:bg-purple-600 rounded-xl transition-colors">íŒŒì¼ ì„ íƒ</button>
                    </div>
                    <div id="preview" class="mt-6 hidden">
                        <img id="previewImage" class="w-full max-h-96 object-contain rounded-xl border border-gray-800">
                    </div>
                </div>
                
                <div class="bg-gray-900 rounded-xl p-8 border border-gray-800">
                    <h2 class="text-xl font-bold mb-4">ì‘í’ˆ ì •ë³´</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-400 mb-2">ì‘í’ˆ ì œëª© *</label>
                            <input type="text" id="title" required class="w-full bg-gray-800 rounded-xl px-4 py-3 border border-gray-700 focus:border-purple-500 focus:outline-none text-white">
                        </div>
                        <div>
                            <label class="block text-gray-400 mb-2">ì„¤ëª…</label>
                            <textarea id="description" rows="4" class="w-full bg-gray-800 rounded-xl px-4 py-3 border border-gray-700 focus:border-purple-500 focus:outline-none text-white"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-400 mb-2">ì¹´í…Œê³ ë¦¬ *</label>
                                <select id="category" required class="w-full bg-gray-800 rounded-xl px-4 py-3 border border-gray-700 focus:border-purple-500 focus:outline-none text-white">
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    <option value="painting">íšŒí™”</option>
                                    <option value="sculpture">ì¡°ê°</option>
                                    <option value="photography">ì‚¬ì§„</option>
                                    <option value="digital">ë””ì§€í„¸ì•„íŠ¸</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-400 mb-2">ê°€ê²© (ETH) *</label>
                                <input type="number" id="price" step="0.01" min="0" required class="w-full bg-gray-800 rounded-xl px-4 py-3 border border-gray-700 focus:border-purple-500 focus:outline-none text-white">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-4">
                    <button type="submit" id="submitBtn" class="flex-1 py-4 bg-gradient-to-r from-purple-500 to-cyan-500 rounded-xl font-bold text-lg hover:scale-105 transition-transform">
                        <i class="fas fa-check mr-2"></i>ì—…ë¡œë“œ
                    </button>
                    <a href="/dashboard" class="px-8 py-4 bg-gray-800 rounded-xl font-bold hover:bg-gray-700 flex items-center justify-center transition-colors">ì·¨ì†Œ</a>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const imageInput = document.getElementById('imageInput');
        const preview = document.getElementById('preview');
        const previewImage = document.getElementById('previewImage');
        const dropzone = document.getElementById('dropzone');
        
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤');
                    return;
                }
                if (file.size > 10 * 1024 * 1024) {
                    alert('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });
        
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('border-purple-500', 'bg-purple-900', 'bg-opacity-10');
        });
        
        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('border-purple-500', 'bg-purple-900', 'bg-opacity-10');
        });
        
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-purple-500', 'bg-purple-900', 'bg-opacity-10');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                imageInput.files = e.dataTransfer.files;
                imageInput.dispatchEvent(new Event('change'));
            }
        });
        
        dropzone.addEventListener('click', () => {
            imageInput.click();
        });
        
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const token = localStorage.getItem('auth_token');
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                window.location.href = '/login';
                return;
            }
            
            if (!imageInput.files[0]) {
                alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ì—…ë¡œë“œ ì¤‘...';
            
            const formData = new FormData();
            formData.append('image', imageInput.files[0]);
            formData.append('title', document.getElementById('title').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('category', document.getElementById('category').value);
            formData.append('current_price', document.getElementById('price').value);
            
            try {
                const response = await axios.post('/api/artworks', formData, {
                    headers: {
                        'Authorization': \`Bearer \${token}\`,
                        'Content-Type': 'multipart/form-data'
                    }
                });
                
                alert('ì‘í’ˆì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
                window.location.href = \`/artwork/\${response.data.id}\`;
            } catch (error) {
                console.error(error);
                alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (error.response?.data?.error || 'ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”'));
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
    </script>
  `
  
  return c.html(getLayout(uploadHTML, 'ì‘í’ˆ ì—…ë¡œë“œ - GALLERYPIA'))
})

// SPA Wildcard Routes - Return HTML shell for client-side routing
app.get('*', async (c) => {
  const path = new URL(c.req.url).pathname;
  
  // Skip API routes and static files
  if (path.startsWith('/api/') || path.startsWith('/static/') || path.includes('.')) {
    return c.notFound();
  }
  
  // Return main SPA HTML shell for client-side routing
  // This handles routes like /collections, /bundles, /activity, /mypage, /login, /signup
  const html = getLayout(`
    <div id="app-content"></div>
    <script src="/static/app.js"></script>
  `, 'GALLERYPIA - NFT Art Museum');
  
  return c.html(html);
});

// ============================================
// ì´ë©”ì¼ ì•Œë¦¼ API
// ============================================

import { 
  sendEmail, 
  getWelcomeEmail, 
  getPurchaseConfirmationEmail,
  getPriceChangeEmail,
  getEvaluationCompleteEmail
} from './utils/email'

// ì´ë©”ì¼ ë°œì†¡ (ë‚´ë¶€ ì‚¬ìš©ìš©)
app.post('/api/email/send', async (c) => {
  try {
    const token = c.req.header('Authorization')?.replace('Bearer ', '')
    if (!token) {
      return c.json({ error: 'Unauthorized' }, 401)
    }

    // JWT ê²€ì¦ (ê°„ë‹¨í•œ ë°©ì‹)
    const decoded = await verifyToken(token, c.env)
    if (!decoded) {
      return c.json({ error: 'Invalid token' }, 401)
    }

    const body = await c.req.json()
    const { type, data } = body

    let emailTemplate
    let recipientEmail = data.userEmail
    let recipientName = data.userName

    // í…œí”Œë¦¿ íƒ€ì…ì— ë”°ë¼ ì´ë©”ì¼ ìƒì„±
    switch (type) {
      case 'welcome':
        emailTemplate = getWelcomeEmail(recipientName)
        break

      case 'purchase':
        emailTemplate = getPurchaseConfirmationEmail(
          recipientName,
          data.artworkTitle,
          data.artistName,
          data.price,
          data.transactionId
        )
        break

      case 'price_change':
        emailTemplate = getPriceChangeEmail(
          recipientName,
          data.artworkTitle,
          data.oldPrice,
          data.newPrice,
          data.changePercent
        )
        break

      case 'evaluation':
        emailTemplate = getEvaluationCompleteEmail(
          recipientName,
          data.artworkTitle,
          data.finalScore,
          data.estimatedValue
        )
        break

      default:
        return c.json({ error: 'Invalid email type' }, 400)
    }

    // ì´ë©”ì¼ ë°œì†¡
    const result = await sendEmail(c.env.SENDGRID_API_KEY, {
      to: recipientEmail,
      toName: recipientName,
      subject: emailTemplate.subject,
      html: emailTemplate.html,
      text: emailTemplate.text
    })

    if (result.success) {
      return c.json({ success: true, message: 'Email sent successfully' })
    } else {
      return c.json({ success: false, error: result.error }, 500)
    }
  } catch (error) {
    console.error('Email send error:', error)
    return c.json({ error: 'Failed to send email' }, 500)
  }
})

// ì´ë©”ì¼ ìˆ˜ì‹  ê±°ë¶€
app.get('/api/email/unsubscribe', async (c) => {
  try {
    const userId = c.req.query('user_id')
    if (!userId) {
      return c.json({ error: 'User ID required' }, 400)
    }

    const db = c.env.DB

    // ëª¨ë“  ì´ë©”ì¼ ì•Œë¦¼ ë¹„í™œì„±í™”
    await db.prepare(`
      UPDATE notification_settings
      SET 
        notify_new_artwork = 0,
        notify_price_change = 0,
        notify_bid = 0,
        notify_evaluation = 0
      WHERE user_id = ?
    `).bind(userId).run()

    return c.json({ 
      success: true, 
      message: 'Successfully unsubscribed from all email notifications' 
    })
  } catch (error) {
    console.error('Unsubscribe error:', error)
    return c.json({ error: 'Failed to unsubscribe' }, 500)
  }
})

// ì´ë©”ì¼ ìˆ˜ì‹  ê±°ë¶€ í˜ì´ì§€
app.get('/unsubscribe', async (c) => {
  const userId = c.req.query('user_id')

  const content = `
  <section id="main-content" class="min-h-screen flex items-center justify-center py-20" tabindex="-1">
      <div class="w-full max-w-md px-4">
          <div class="card-nft rounded-3xl p-8 neon-border text-center">
              <div class="inline-block p-4 rounded-full bg-yellow-500 bg-opacity-20 mb-4">
                  <i class="fas fa-envelope-open-text text-4xl text-yellow-500"></i>
              </div>
              <h1 class="text-3xl font-bold text-white mb-2">ì´ë©”ì¼ ìˆ˜ì‹  ê±°ë¶€</h1>
              <p class="text-gray-400 mb-8">ë” ì´ìƒ ì´ë©”ì¼ ì•Œë¦¼ì„ ë°›ì§€ ì•Šìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?</p>
              
              ${userId ? `
                <button 
                  onclick="confirmUnsubscribe('${userId}')" 
                  class="w-full px-6 py-3 bg-gradient-to-r from-yellow-500 to-orange-500 text-white rounded-xl font-semibold hover:shadow-lg transition mb-4"
                >
                  ìˆ˜ì‹  ê±°ë¶€ í™•ì¸
                </button>
                
                <a href="/settings" class="block w-full px-6 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 text-white rounded-xl font-semibold hover:bg-opacity-10 transition">
                  ì•Œë¦¼ ì„¤ì •ìœ¼ë¡œ ì´ë™
                </a>
              ` : `
                <p class="text-red-400 mb-4">ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤.</p>
                <a href="/" class="block w-full px-6 py-3 bg-gradient-to-r from-purple-600 to-cyan-600 text-white rounded-xl font-semibold hover:shadow-lg transition">
                  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </a>
              `}
          </div>
      </div>
  </section>
  
  <script>
    async function confirmUnsubscribe(userId) {
      if (!confirm('ì •ë§ë¡œ ëª¨ë“  ì´ë©”ì¼ ì•Œë¦¼ ìˆ˜ì‹ ì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      try {
        const response = await fetch(\`/api/email/unsubscribe?user_id=\${userId}\`);
        const data = await response.json();
        
        if (data.success) {
          alert('ì´ë©”ì¼ ìˆ˜ì‹  ê±°ë¶€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          window.location.href = '/';
        } else {
          alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (error) {
        console.error('Unsubscribe error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
  </script>
  `

  return c.html(getLayout(content, 'ì´ë©”ì¼ ìˆ˜ì‹  ê±°ë¶€ - GALLERYPIA'))
})

// ============================================
// ì‹¤ì‹œê°„ í˜‘ì—… API (SSE + Polling ê¸°ë°˜)
// ============================================

// íë ˆì´ì…˜ ì„¸ì…˜ ìƒì„±
app.post('/api/curation/sessions', async (c) => {
  try {
    const token = c.req.header('Authorization')?.replace('Bearer ', '')
    if (!token) {
      return c.json({ error: 'Unauthorized' }, 401)
    }

    const decoded = await verifyToken(token, c.env)
    if (!decoded) {
      return c.json({ error: 'Invalid token' }, 401)
    }

    const db = c.env.DB
    const { title, description, visibility, max_artworks, voting_enabled, deadline } = await c.req.json()

    if (!title) {
      return c.json({ error: 'Title is required' }, 400)
    }

    // ì„¸ì…˜ ìƒì„±
    const result = await db.prepare(`
      INSERT INTO curation_sessions (
        title, description, creator_user_id, status, visibility,
        max_artworks, voting_enabled, deadline, created_at, updated_at
      ) VALUES (?, ?, ?, 'active', ?, ?, ?, ?, datetime('now'), datetime('now'))
    `).bind(
      title,
      description || null,
      decoded.userId,
      visibility || 'public',
      max_artworks || 20,
      voting_enabled !== false ? 1 : 0,
      deadline || null
    ).run()

    const sessionId = result.meta.last_row_id

    // ìƒì„±ìë¥¼ ì°¸ì—¬ìë¡œ ì¶”ê°€
    await db.prepare(`
      INSERT INTO curation_participants (session_id, user_id, role, joined_at)
      VALUES (?, ?, 'creator', datetime('now'))
    `).bind(sessionId, decoded.userId).run()

    // í™œë™ í”¼ë“œì— ì¶”ê°€
    await db.prepare(`
      INSERT INTO activity_feed (activity_type, user_id, metadata, created_at)
      VALUES ('curation_created', ?, ?, datetime('now'))
    `).bind(decoded.userId, JSON.stringify({ session_id: sessionId, title })).run()

    return c.json({
      success: true,
      session_id: sessionId,
      message: 'íë ˆì´ì…˜ ì„¸ì…˜ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤'
    })
  } catch (error) {
    console.error('Create curation session error:', error)
    return c.json({ error: 'Failed to create session' }, 500)
  }
})

// íë ˆì´ì…˜ ì„¸ì…˜ ëª©ë¡ ì¡°íšŒ
app.get('/api/curation/sessions', async (c) => {
  try {
    const db = c.env.DB
    const status = c.req.query('status') || 'active'
    const visibility = c.req.query('visibility')

    let query = `
      SELECT 
        cs.*,
        u.username as creator_username,
        u.full_name as creator_name,
        COUNT(DISTINCT cp.user_id) as participant_count,
        COUNT(DISTINCT ca.id) as artwork_count
      FROM curation_sessions cs
      LEFT JOIN users u ON cs.creator_user_id = u.id
      LEFT JOIN curation_participants cp ON cs.id = cp.session_id
      LEFT JOIN curation_artworks ca ON cs.id = ca.session_id
      WHERE cs.status = ?
    `

    const params: any[] = [status]

    if (visibility) {
      query += ` AND cs.visibility = ?`
      params.push(visibility)
    }

    query += `
      GROUP BY cs.id
      ORDER BY cs.created_at DESC
      LIMIT 50
    `

    const result = await db.prepare(query).bind(...params).all()

    return c.json({
      success: true,
      sessions: result.results || []
    })
  } catch (error) {
    console.error('Get curation sessions error:', error)
    return c.json({ error: 'Failed to get sessions' }, 500)
  }
})

// íë ˆì´ì…˜ ì„¸ì…˜ ìƒì„¸ ì¡°íšŒ
app.get('/api/curation/sessions/:id', async (c) => {
  try {
    const db = c.env.DB
    const sessionId = c.req.param('id')

    // ì„¸ì…˜ ì •ë³´
    const session = await db.prepare(`
      SELECT 
        cs.*,
        u.username as creator_username,
        u.full_name as creator_name,
        u.profile_image as creator_profile_image
      FROM curation_sessions cs
      LEFT JOIN users u ON cs.creator_user_id = u.id
      WHERE cs.id = ?
    `).bind(sessionId).first()

    if (!session) {
      return c.json({ error: 'Session not found' }, 404)
    }

    // ì°¸ì—¬ì ëª©ë¡
    const participants = await db.prepare(`
      SELECT 
        cp.role,
        cp.joined_at,
        u.id as user_id,
        u.username,
        u.full_name,
        u.profile_image
      FROM curation_participants cp
      LEFT JOIN users u ON cp.user_id = u.id
      WHERE cp.session_id = ?
      ORDER BY cp.joined_at ASC
    `).bind(sessionId).all()

    // ì¶”ì²œ ì‘í’ˆ ëª©ë¡
    const artworks = await db.prepare(`
      SELECT 
        ca.*,
        a.title,
        a.image_url,
        a.estimated_value,
        a.valuation_score,
        ar.name as artist_name,
        u.username as recommended_by_username,
        u.full_name as recommended_by_name
      FROM curation_artworks ca
      LEFT JOIN artworks a ON ca.artwork_id = a.id
      LEFT JOIN artists ar ON a.artist_id = ar.id
      LEFT JOIN users u ON ca.recommended_by = u.id
      WHERE ca.session_id = ?
      ORDER BY ca.vote_count DESC, ca.created_at ASC
    `).bind(sessionId).all()

    return c.json({
      success: true,
      session,
      participants: participants.results || [],
      artworks: artworks.results || []
    })
  } catch (error) {
    console.error('Get curation session detail error:', error)
    return c.json({ error: 'Failed to get session detail' }, 500)
  }
})

// íë ˆì´ì…˜ ì„¸ì…˜ ì°¸ì—¬
app.post('/api/curation/sessions/:id/join', async (c) => {
  try {
    const token = c.req.header('Authorization')?.replace('Bearer ', '')
    if (!token) {
      return c.json({ error: 'Unauthorized' }, 401)
    }

    const decoded = await verifyToken(token, c.env)
    if (!decoded) {
      return c.json({ error: 'Invalid token' }, 401)
    }

    const db = c.env.DB
    const sessionId = c.req.param('id')

    // ì„¸ì…˜ ì¡´ì¬ í™•ì¸
    const session = await db.prepare(`
      SELECT * FROM curation_sessions WHERE id = ? AND status = 'active'
    `).bind(sessionId).first()

    if (!session) {
      return c.json({ error: 'Session not found or closed' }, 404)
    }

    // ì´ë¯¸ ì°¸ì—¬ ì¤‘ì¸ì§€ í™•ì¸
    const existing = await db.prepare(`
      SELECT * FROM curation_participants WHERE session_id = ? AND user_id = ?
    `).bind(sessionId, decoded.userId).first()

    if (existing) {
      return c.json({ error: 'Already joined' }, 400)
    }

    // ì°¸ì—¬ì ì¶”ê°€
    await db.prepare(`
      INSERT INTO curation_participants (session_id, user_id, role, joined_at)
      VALUES (?, ?, 'contributor', datetime('now'))
    `).bind(sessionId, decoded.userId).run()

    // í™œë™ í”¼ë“œì— ì¶”ê°€
    await db.prepare(`
      INSERT INTO activity_feed (activity_type, user_id, metadata, created_at)
      VALUES ('curation_joined', ?, ?, datetime('now'))
    `).bind(decoded.userId, JSON.stringify({ session_id: sessionId })).run()

    return c.json({
      success: true,
      message: 'íë ˆì´ì…˜ ì„¸ì…˜ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤'
    })
  } catch (error) {
    console.error('Join curation session error:', error)
    return c.json({ error: 'Failed to join session' }, 500)
  }
})

// ì‘í’ˆ ì¶”ì²œ
app.post('/api/curation/sessions/:id/artworks', async (c) => {
  try {
    const token = c.req.header('Authorization')?.replace('Bearer ', '')
    if (!token) {
      return c.json({ error: 'Unauthorized' }, 401)
    }

    const decoded = await verifyToken(token, c.env)
    if (!decoded) {
      return c.json({ error: 'Invalid token' }, 401)
    }

    const db = c.env.DB
    const sessionId = c.req.param('id')
    const { artwork_id, reason } = await c.req.json()

    if (!artwork_id) {
      return c.json({ error: 'Artwork ID is required' }, 400)
    }

    // ì°¸ì—¬ì í™•ì¸
    const participant = await db.prepare(`
      SELECT * FROM curation_participants WHERE session_id = ? AND user_id = ?
    `).bind(sessionId, decoded.userId).first()

    if (!participant) {
      return c.json({ error: 'Not a participant' }, 403)
    }

    // ì‘í’ˆ ì¡´ì¬ í™•ì¸
    const artwork = await db.prepare(`
      SELECT * FROM artworks WHERE id = ?
    `).bind(artwork_id).first()

    if (!artwork) {
      return c.json({ error: 'Artwork not found' }, 404)
    }

    // ì´ë¯¸ ì¶”ì²œëœ ì‘í’ˆì¸ì§€ í™•ì¸
    const existing = await db.prepare(`
      SELECT * FROM curation_artworks WHERE session_id = ? AND artwork_id = ?
    `).bind(sessionId, artwork_id).first()

    if (existing) {
      return c.json({ error: 'Artwork already recommended' }, 400)
    }

    // ì‘í’ˆ ì¶”ì²œ
    const result = await db.prepare(`
      INSERT INTO curation_artworks (
        session_id, artwork_id, recommended_by, reason, created_at
      ) VALUES (?, ?, ?, ?, datetime('now'))
    `).bind(sessionId, artwork_id, decoded.userId, reason || null).run()

    // í™œë™ í”¼ë“œì— ì¶”ê°€
    await db.prepare(`
      INSERT INTO activity_feed (
        activity_type, user_id, artwork_id, metadata, created_at
      ) VALUES ('artwork_recommended', ?, ?, ?, datetime('now'))
    `).bind(decoded.userId, artwork_id, JSON.stringify({ session_id: sessionId })).run()

    return c.json({
      success: true,
      curation_artwork_id: result.meta.last_row_id,
      message: 'ì‘í’ˆì´ ì¶”ì²œë˜ì—ˆìŠµë‹ˆë‹¤'
    })
  } catch (error) {
    console.error('Recommend artwork error:', error)
    return c.json({ error: 'Failed to recommend artwork' }, 500)
  }
})

// ì‘í’ˆ íˆ¬í‘œ
app.post('/api/curation/artworks/:id/vote', async (c) => {
  try {
    const token = c.req.header('Authorization')?.replace('Bearer ', '')
    if (!token) {
      return c.json({ error: 'Unauthorized' }, 401)
    }

    const decoded = await verifyToken(token, c.env)
    if (!decoded) {
      return c.json({ error: 'Invalid token' }, 401)
    }

    const db = c.env.DB
    const curationArtworkId = c.req.param('id')
    const { vote_type } = await c.req.json()

    if (!vote_type || !['upvote', 'downvote'].includes(vote_type)) {
      return c.json({ error: 'Invalid vote type' }, 400)
    }

    // íë ˆì´ì…˜ ì‘í’ˆ í™•ì¸ ë° ì„¸ì…˜ ID ê°€ì ¸ì˜¤ê¸°
    const curationArtwork = await db.prepare(`
      SELECT ca.*, cs.voting_enabled
      FROM curation_artworks ca
      LEFT JOIN curation_sessions cs ON ca.session_id = cs.id
      WHERE ca.id = ?
    `).bind(curationArtworkId).first()

    if (!curationArtwork) {
      return c.json({ error: 'Curation artwork not found' }, 404)
    }

    if (!curationArtwork.voting_enabled) {
      return c.json({ error: 'Voting is disabled for this session' }, 403)
    }

    // ì°¸ì—¬ì í™•ì¸
    const participant = await db.prepare(`
      SELECT * FROM curation_participants WHERE session_id = ? AND user_id = ?
    `).bind(curationArtwork.session_id, decoded.userId).first()

    if (!participant) {
      return c.json({ error: 'Not a participant' }, 403)
    }

    // ê¸°ì¡´ íˆ¬í‘œ í™•ì¸
    const existingVote = await db.prepare(`
      SELECT * FROM curation_votes WHERE curation_artwork_id = ? AND user_id = ?
    `).bind(curationArtworkId, decoded.userId).first()

    if (existingVote) {
      // ê°™ì€ íƒ€ì…ì´ë©´ ì·¨ì†Œ, ë‹¤ë¥¸ íƒ€ì…ì´ë©´ ë³€ê²½
      if (existingVote.vote_type === vote_type) {
        // íˆ¬í‘œ ì·¨ì†Œ
        await db.prepare(`
          DELETE FROM curation_votes WHERE id = ?
        `).bind(existingVote.id).run()

        // íˆ¬í‘œ ìˆ˜ ê°ì†Œ
        const delta = vote_type === 'upvote' ? -1 : 1
        await db.prepare(`
          UPDATE curation_artworks SET vote_count = vote_count + ? WHERE id = ?
        `).bind(delta, curationArtworkId).run()

        return c.json({
          success: true,
          action: 'removed',
          message: 'íˆ¬í‘œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤'
        })
      } else {
        // íˆ¬í‘œ ë³€ê²½
        await db.prepare(`
          UPDATE curation_votes SET vote_type = ? WHERE id = ?
        `).bind(vote_type, existingVote.id).run()

        // íˆ¬í‘œ ìˆ˜ ë³€ê²½ (ê¸°ì¡´ ë°˜ëŒ€, ìƒˆë¡œìš´ ì ìš©)
        const delta = vote_type === 'upvote' ? 2 : -2
        await db.prepare(`
          UPDATE curation_artworks SET vote_count = vote_count + ? WHERE id = ?
        `).bind(delta, curationArtworkId).run()

        return c.json({
          success: true,
          action: 'changed',
          message: 'íˆ¬í‘œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤'
        })
      }
    } else {
      // ìƒˆ íˆ¬í‘œ ì¶”ê°€
      await db.prepare(`
        INSERT INTO curation_votes (curation_artwork_id, user_id, vote_type, created_at)
        VALUES (?, ?, ?, datetime('now'))
      `).bind(curationArtworkId, decoded.userId, vote_type).run()

      // íˆ¬í‘œ ìˆ˜ ì¦ê°€
      const delta = vote_type === 'upvote' ? 1 : -1
      await db.prepare(`
        UPDATE curation_artworks SET vote_count = vote_count + ? WHERE id = ?
      `).bind(delta, curationArtworkId).run()

      return c.json({
        success: true,
        action: 'added',
        message: 'íˆ¬í‘œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤'
      })
    }
  } catch (error) {
    console.error('Vote artwork error:', error)
    return c.json({ error: 'Failed to vote' }, 500)
  }
})

// í™œë™ í”¼ë“œ ì¡°íšŒ
app.get('/api/activity-feed', async (c) => {
  try {
    const db = c.env.DB
    const limit = parseInt(c.req.query('limit') || '20')
    const offset = parseInt(c.req.query('offset') || '0')
    const type = c.req.query('type')

    let query = `
      SELECT 
        af.*,
        u.username,
        u.full_name,
        u.profile_image,
        a.title as artwork_title,
        a.image_url as artwork_image,
        tu.username as target_username,
        tu.full_name as target_full_name
      FROM activity_feed af
      LEFT JOIN users u ON af.user_id = u.id
      LEFT JOIN artworks a ON af.artwork_id = a.id
      LEFT JOIN users tu ON af.target_user_id = tu.id
    `

    const params: any[] = []

    if (type) {
      query += ` WHERE af.activity_type = ?`
      params.push(type)
    }

    query += `
      ORDER BY af.created_at DESC
      LIMIT ? OFFSET ?
    `
    params.push(limit, offset)

    const result = await db.prepare(query).bind(...params).all()

    return c.json({
      success: true,
      activities: result.results || [],
      has_more: (result.results?.length || 0) === limit
    })
  } catch (error) {
    console.error('Get activity feed error:', error)
    return c.json({ error: 'Failed to get activity feed' }, 500)
  }
})

// íë ˆì´ì…˜ ì„¸ì…˜ ë§ˆê°
app.post('/api/curation/sessions/:id/close', async (c) => {
  try {
    const token = c.req.header('Authorization')?.replace('Bearer ', '')
    if (!token) {
      return c.json({ error: 'Unauthorized' }, 401)
    }

    const decoded = await verifyToken(token, c.env)
    if (!decoded) {
      return c.json({ error: 'Invalid token' }, 401)
    }

    const db = c.env.DB
    const sessionId = c.req.param('id')

    // ì„¸ì…˜ í™•ì¸ ë° ê¶Œí•œ ì²´í¬
    const session = await db.prepare(`
      SELECT * FROM curation_sessions WHERE id = ? AND creator_user_id = ?
    `).bind(sessionId, decoded.userId).first()

    if (!session) {
      return c.json({ error: 'Session not found or not authorized' }, 404)
    }

    // ìƒíƒœ ë³€ê²½
    await db.prepare(`
      UPDATE curation_sessions SET status = 'closed', updated_at = datetime('now')
      WHERE id = ?
    `).bind(sessionId).run()

    return c.json({
      success: true,
      message: 'íë ˆì´ì…˜ ì„¸ì…˜ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤'
    })
  } catch (error) {
    console.error('Close curation session error:', error)
    return c.json({ error: 'Failed to close session' }, 500)
  }
})

// ============================================
// ì†Œì…œ ê¸°ëŠ¥ API (íŒ”ë¡œìš°, ëŒ“ê¸€, ê³µìœ )
// ============================================

// ì‚¬ìš©ì íŒ”ë¡œìš°
app.post('/api/users/:id/follow', async (c) => {
  try {
    const token = c.req.header('Authorization')?.replace('Bearer ', '')
    if (!token) {
      return c.json({ error: 'Unauthorized' }, 401)
    }

    const decoded = await verifyToken(token, c.env)
    if (!decoded) {
      return c.json({ error: 'Invalid token' }, 401)
    }

    const db = c.env.DB
    const targetUserId = c.req.param('id')

    // ìê¸° ìì‹ ì„ íŒ”ë¡œìš°í•  ìˆ˜ ì—†ìŒ
    if (decoded.userId === parseInt(targetUserId)) {
      return c.json({ error: 'Cannot follow yourself' }, 400)
    }

    // ëŒ€ìƒ ì‚¬ìš©ì ì¡´ì¬ í™•ì¸
    const targetUser = await db.prepare(`
      SELECT id FROM users WHERE id = ?
    `).bind(targetUserId).first()

    if (!targetUser) {
      return c.json({ error: 'User not found' }, 404)
    }

    // ì´ë¯¸ íŒ”ë¡œìš° ì¤‘ì¸ì§€ í™•ì¸
    const existing = await db.prepare(`
      SELECT id FROM user_follows WHERE follower_user_id = ? AND following_user_id = ?
    `).bind(decoded.userId, targetUserId).first()

    if (existing) {
      return c.json({ error: 'Already following' }, 400)
    }

    // íŒ”ë¡œìš° ì¶”ê°€
    await db.prepare(`
      INSERT INTO user_follows (follower_user_id, following_user_id, created_at)
      VALUES (?, ?, datetime('now'))
    `).bind(decoded.userId, targetUserId).run()

    // í†µê³„ ì—…ë°ì´íŠ¸
    await db.prepare(`
      INSERT INTO user_social_stats (user_id, followers_count, updated_at)
      VALUES (?, 1, datetime('now'))
      ON CONFLICT(user_id) DO UPDATE SET
        followers_count = followers_count + 1,
        updated_at = datetime('now')
    `).bind(targetUserId).run()

    await db.prepare(`
      INSERT INTO user_social_stats (user_id, following_count, updated_at)
      VALUES (?, 1, datetime('now'))
      ON CONFLICT(user_id) DO UPDATE SET
        following_count = following_count + 1,
        updated_at = datetime('now')
    `).bind(decoded.userId).run()

    // í™œë™ í”¼ë“œ ì¶”ê°€
    await db.prepare(`
      INSERT INTO activity_feed (activity_type, user_id, target_user_id, created_at)
      VALUES ('follow', ?, ?, datetime('now'))
    `).bind(decoded.userId, targetUserId).run()

    return c.json({
      success: true,
      message: 'íŒ”ë¡œìš°í–ˆìŠµë‹ˆë‹¤'
    })
  } catch (error) {
    console.error('Follow user error:', error)
    return c.json({ error: 'Failed to follow user' }, 500)
  }
})

// ì‚¬ìš©ì ì–¸íŒ”ë¡œìš°
app.delete('/api/users/:id/follow', async (c) => {
  try {
    const token = c.req.header('Authorization')?.replace('Bearer ', '')
    if (!token) {
      return c.json({ error: 'Unauthorized' }, 401)
    }

    const decoded = await verifyToken(token, c.env)
    if (!decoded) {
      return c.json({ error: 'Invalid token' }, 401)
    }

    const db = c.env.DB
    const targetUserId = c.req.param('id')

    // íŒ”ë¡œìš° ê´€ê³„ ì‚­ì œ
    const result = await db.prepare(`
      DELETE FROM user_follows
      WHERE follower_user_id = ? AND following_user_id = ?
    `).bind(decoded.userId, targetUserId).run()

    if (result.meta.changes === 0) {
      return c.json({ error: 'Not following' }, 400)
    }

    // í†µê³„ ì—…ë°ì´íŠ¸
    await db.prepare(`
      UPDATE user_social_stats SET
        followers_count = followers_count - 1,
        updated_at = datetime('now')
      WHERE user_id = ?
    `).bind(targetUserId).run()

    await db.prepare(`
      UPDATE user_social_stats SET
        following_count = following_count - 1,
        updated_at = datetime('now')
      WHERE user_id = ?
    `).bind(decoded.userId).run()

    return c.json({
      success: true,
      message: 'ì–¸íŒ”ë¡œìš°í–ˆìŠµë‹ˆë‹¤'
    })
  } catch (error) {
    console.error('Unfollow user error:', error)
    return c.json({ error: 'Failed to unfollow user' }, 500)
  }
})

// íŒ”ë¡œì›Œ ëª©ë¡ ì¡°íšŒ
app.get('/api/users/:id/followers', async (c) => {
  try {
    const db = c.env.DB
    const userId = c.req.param('id')
    const limit = parseInt(c.req.query('limit') || '20')
    const offset = parseInt(c.req.query('offset') || '0')

    const result = await db.prepare(`
      SELECT 
        u.id,
        u.username,
        u.full_name,
        u.profile_image,
        u.bio,
        uf.created_at as followed_at
      FROM user_follows uf
      LEFT JOIN users u ON uf.follower_user_id = u.id
      WHERE uf.following_user_id = ?
      ORDER BY uf.created_at DESC
      LIMIT ? OFFSET ?
    `).bind(userId, limit, offset).all()

    return c.json({
      success: true,
      followers: result.results || [],
      has_more: (result.results?.length || 0) === limit
    })
  } catch (error) {
    console.error('Get followers error:', error)
    return c.json({ error: 'Failed to get followers' }, 500)
  }
})

// íŒ”ë¡œì‰ ëª©ë¡ ì¡°íšŒ
app.get('/api/users/:id/following', async (c) => {
  try {
    const db = c.env.DB
    const userId = c.req.param('id')
    const limit = parseInt(c.req.query('limit') || '20')
    const offset = parseInt(c.req.query('offset') || '0')

    const result = await db.prepare(`
      SELECT 
        u.id,
        u.username,
        u.full_name,
        u.profile_image,
        u.bio,
        uf.created_at as followed_at
      FROM user_follows uf
      LEFT JOIN users u ON uf.following_user_id = u.id
      WHERE uf.follower_user_id = ?
      ORDER BY uf.created_at DESC
      LIMIT ? OFFSET ?
    `).bind(userId, limit, offset).all()

    return c.json({
      success: true,
      following: result.results || [],
      has_more: (result.results?.length || 0) === limit
    })
  } catch (error) {
    console.error('Get following error:', error)
    return c.json({ error: 'Failed to get following' }, 500)
  }
})

// íŒ”ë¡œìš° ìƒíƒœ í™•ì¸
app.get('/api/users/:id/follow-status', async (c) => {
  try {
    const token = c.req.header('Authorization')?.replace('Bearer ', '')
    if (!token) {
      return c.json({ is_following: false })
    }

    const decoded = await verifyToken(token, c.env)
    if (!decoded) {
      return c.json({ is_following: false })
    }

    const db = c.env.DB
    const targetUserId = c.req.param('id')

    const follow = await db.prepare(`
      SELECT id FROM user_follows
      WHERE follower_user_id = ? AND following_user_id = ?
    `).bind(decoded.userId, targetUserId).first()

    return c.json({
      is_following: !!follow
    })
  } catch (error) {
    console.error('Check follow status error:', error)
    return c.json({ is_following: false })
  }
})

// ì‘í’ˆ ëŒ“ê¸€ ì‘ì„±
app.post('/api/artworks/:id/comments', async (c) => {
  try {
    const token = c.req.header('Authorization')?.replace('Bearer ', '')
    if (!token) {
      return c.json({ error: 'Unauthorized' }, 401)
    }

    const decoded = await verifyToken(token, c.env)
    if (!decoded) {
      return c.json({ error: 'Invalid token' }, 401)
    }

    const db = c.env.DB
    const artworkId = c.req.param('id')
    const { content, parent_comment_id } = await c.req.json()

    if (!content || content.trim().length === 0) {
      return c.json({ error: 'Content is required' }, 400)
    }

    // ì‘í’ˆ ì¡´ì¬ í™•ì¸
    const artwork = await db.prepare(`
      SELECT id FROM artworks WHERE id = ?
    `).bind(artworkId).first()

    if (!artwork) {
      return c.json({ error: 'Artwork not found' }, 404)
    }

    // ëŒ“ê¸€ ì¶”ê°€
    const result = await db.prepare(`
      INSERT INTO artwork_comments (
        artwork_id, user_id, parent_comment_id, content, created_at, updated_at
      ) VALUES (?, ?, ?, ?, datetime('now'), datetime('now'))
    `).bind(artworkId, decoded.userId, parent_comment_id || null, content.trim()).run()

    // í†µê³„ ì—…ë°ì´íŠ¸
    await db.prepare(`
      INSERT INTO user_social_stats (user_id, comments_count, updated_at)
      VALUES (?, 1, datetime('now'))
      ON CONFLICT(user_id) DO UPDATE SET
        comments_count = comments_count + 1,
        updated_at = datetime('now')
    `).bind(decoded.userId).run()

    // í™œë™ í”¼ë“œ ì¶”ê°€
    await db.prepare(`
      INSERT INTO activity_feed (activity_type, user_id, artwork_id, metadata, created_at)
      VALUES ('comment', ?, ?, ?, datetime('now'))
    `).bind(decoded.userId, artworkId, JSON.stringify({ comment_id: result.meta.last_row_id })).run()

    return c.json({
      success: true,
      comment_id: result.meta.last_row_id,
      message: 'ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤'
    })
  } catch (error) {
    console.error('Post comment error:', error)
    return c.json({ error: 'Failed to post comment' }, 500)
  }
})

// ì‘í’ˆ ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ
app.get('/api/artworks/:id/comments', async (c) => {
  try {
    const db = c.env.DB
    const artworkId = c.req.param('id')
    const limit = parseInt(c.req.query('limit') || '20')
    const offset = parseInt(c.req.query('offset') || '0')

    const result = await db.prepare(`
      SELECT 
        ac.*,
        u.username,
        u.full_name,
        u.profile_image,
        COUNT(DISTINCT cl.id) as likes_count_actual
      FROM artwork_comments ac
      LEFT JOIN users u ON ac.user_id = u.id
      LEFT JOIN comment_likes cl ON ac.id = cl.comment_id
      WHERE ac.artwork_id = ? AND ac.is_deleted = 0 AND ac.parent_comment_id IS NULL
      GROUP BY ac.id
      ORDER BY ac.created_at DESC
      LIMIT ? OFFSET ?
    `).bind(artworkId, limit, offset).all()

    // ê° ëŒ“ê¸€ì˜ ëŒ€ëŒ“ê¸€ ê°œìˆ˜ ì¡°íšŒ
    const comments = await Promise.all((result.results || []).map(async (comment: any) => {
      const repliesCount = await db.prepare(`
        SELECT COUNT(*) as count FROM artwork_comments
        WHERE parent_comment_id = ? AND is_deleted = 0
      `).bind(comment.id).first()

      return {
        ...comment,
        replies_count: repliesCount?.count || 0
      }
    }))

    return c.json({
      success: true,
      comments,
      has_more: (result.results?.length || 0) === limit
    })
  } catch (error) {
    console.error('Get comments error:', error)
    return c.json({ error: 'Failed to get comments' }, 500)
  }
})

// ëŒ“ê¸€ ëŒ€ëŒ“ê¸€ ì¡°íšŒ
app.get('/api/comments/:id/replies', async (c) => {
  try {
    const db = c.env.DB
    const commentId = c.req.param('id')

    const result = await db.prepare(`
      SELECT 
        ac.*,
        u.username,
        u.full_name,
        u.profile_image
      FROM artwork_comments ac
      LEFT JOIN users u ON ac.user_id = u.id
      WHERE ac.parent_comment_id = ? AND ac.is_deleted = 0
      ORDER BY ac.created_at ASC
    `).bind(commentId).all()

    return c.json({
      success: true,
      replies: result.results || []
    })
  } catch (error) {
    console.error('Get replies error:', error)
    return c.json({ error: 'Failed to get replies' }, 500)
  }
})

// ëŒ“ê¸€ ìˆ˜ì •
app.put('/api/comments/:id', async (c) => {
  try {
    const token = c.req.header('Authorization')?.replace('Bearer ', '')
    if (!token) {
      return c.json({ error: 'Unauthorized' }, 401)
    }

    const decoded = await verifyToken(token, c.env)
    if (!decoded) {
      return c.json({ error: 'Invalid token' }, 401)
    }

    const db = c.env.DB
    const commentId = c.req.param('id')
    const { content } = await c.req.json()

    if (!content || content.trim().length === 0) {
      return c.json({ error: 'Content is required' }, 400)
    }

    // ëŒ“ê¸€ ì†Œìœ ì í™•ì¸
    const comment = await db.prepare(`
      SELECT user_id FROM artwork_comments WHERE id = ?
    `).bind(commentId).first()

    if (!comment) {
      return c.json({ error: 'Comment not found' }, 404)
    }

    if (comment.user_id !== decoded.userId) {
      return c.json({ error: 'Not authorized' }, 403)
    }

    // ëŒ“ê¸€ ìˆ˜ì •
    await db.prepare(`
      UPDATE artwork_comments SET
        content = ?,
        is_edited = 1,
        updated_at = datetime('now')
      WHERE id = ?
    `).bind(content.trim(), commentId).run()

    return c.json({
      success: true,
      message: 'ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤'
    })
  } catch (error) {
    console.error('Update comment error:', error)
    return c.json({ error: 'Failed to update comment' }, 500)
  }
})

// ëŒ“ê¸€ ì‚­ì œ
app.delete('/api/comments/:id', async (c) => {
  try {
    const token = c.req.header('Authorization')?.replace('Bearer ', '')
    if (!token) {
      return c.json({ error: 'Unauthorized' }, 401)
    }

    const decoded = await verifyToken(token, c.env)
    if (!decoded) {
      return c.json({ error: 'Invalid token' }, 401)
    }

    const db = c.env.DB
    const commentId = c.req.param('id')

    // ëŒ“ê¸€ ì†Œìœ ì í™•ì¸
    const comment = await db.prepare(`
      SELECT user_id FROM artwork_comments WHERE id = ?
    `).bind(commentId).first()

    if (!comment) {
      return c.json({ error: 'Comment not found' }, 404)
    }

    if (comment.user_id !== decoded.userId) {
      return c.json({ error: 'Not authorized' }, 403)
    }

    // ì†Œí”„íŠ¸ ì‚­ì œ
    await db.prepare(`
      UPDATE artwork_comments SET
        is_deleted = 1,
        content = '[ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤]',
        updated_at = datetime('now')
      WHERE id = ?
    `).bind(commentId).run()

    return c.json({
      success: true,
      message: 'ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤'
    })
  } catch (error) {
    console.error('Delete comment error:', error)
    return c.json({ error: 'Failed to delete comment' }, 500)
  }
})

// ëŒ“ê¸€ ì¢‹ì•„ìš”
app.post('/api/comments/:id/like', async (c) => {
  try {
    const token = c.req.header('Authorization')?.replace('Bearer ', '')
    if (!token) {
      return c.json({ error: 'Unauthorized' }, 401)
    }

    const decoded = await verifyToken(token, c.env)
    if (!decoded) {
      return c.json({ error: 'Invalid token' }, 401)
    }

    const db = c.env.DB
    const commentId = c.req.param('id')

    // ì´ë¯¸ ì¢‹ì•„ìš” í–ˆëŠ”ì§€ í™•ì¸
    const existing = await db.prepare(`
      SELECT id FROM comment_likes WHERE comment_id = ? AND user_id = ?
    `).bind(commentId, decoded.userId).first()

    if (existing) {
      // ì¢‹ì•„ìš” ì·¨ì†Œ
      await db.prepare(`
        DELETE FROM comment_likes WHERE id = ?
      `).bind(existing.id).run()

      await db.prepare(`
        UPDATE artwork_comments SET likes_count = likes_count - 1 WHERE id = ?
      `).bind(commentId).run()

      return c.json({
        success: true,
        action: 'unliked',
        message: 'ì¢‹ì•„ìš”ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤'
      })
    } else {
      // ì¢‹ì•„ìš” ì¶”ê°€
      await db.prepare(`
        INSERT INTO comment_likes (comment_id, user_id, created_at)
        VALUES (?, ?, datetime('now'))
      `).bind(commentId, decoded.userId).run()

      await db.prepare(`
        UPDATE artwork_comments SET likes_count = likes_count + 1 WHERE id = ?
      `).bind(commentId).run()

      return c.json({
        success: true,
        action: 'liked',
        message: 'ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ìŠµë‹ˆë‹¤'
      })
    }
  } catch (error) {
    console.error('Like comment error:', error)
    return c.json({ error: 'Failed to like comment' }, 500)
  }
})

// ì‘í’ˆ ê³µìœ 
app.post('/api/artworks/:id/share', async (c) => {
  try {
    const db = c.env.DB
    const artworkId = c.req.param('id')
    const { share_type } = await c.req.json()

    if (!share_type || !['twitter', 'facebook', 'instagram', 'link', 'other'].includes(share_type)) {
      return c.json({ error: 'Invalid share type' }, 400)
    }

    // í† í°ì´ ìˆìœ¼ë©´ ì‚¬ìš©ì ID ì¶”ì¶œ
    const token = c.req.header('Authorization')?.replace('Bearer ', '')
    let userId = null
    if (token) {
      const decoded = await verifyToken(token, c.env)
      if (decoded) {
        userId = decoded.userId
      }
    }

    // ê³µìœ  ê¸°ë¡ ì¶”ê°€
    await db.prepare(`
      INSERT INTO artwork_shares (artwork_id, user_id, share_type, created_at)
      VALUES (?, ?, ?, datetime('now'))
    `).bind(artworkId, userId, share_type).run()

    return c.json({
      success: true,
      message: 'ê³µìœ ê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤'
    })
  } catch (error) {
    console.error('Share artwork error:', error)
    return c.json({ error: 'Failed to share artwork' }, 500)
  }
})

// ì‘í’ˆ ê³µìœ  í†µê³„
app.get('/api/artworks/:id/shares', async (c) => {
  try {
    const db = c.env.DB
    const artworkId = c.req.param('id')

    const result = await db.prepare(`
      SELECT 
        share_type,
        COUNT(*) as count
      FROM artwork_shares
      WHERE artwork_id = ?
      GROUP BY share_type
    `).bind(artworkId).all()

    const shares: any = {
      total: 0,
      twitter: 0,
      facebook: 0,
      instagram: 0,
      link: 0,
      other: 0
    }

    result.results?.forEach((row: any) => {
      shares[row.share_type] = row.count
      shares.total += row.count
    })

    return c.json({
      success: true,
      shares
    })
  } catch (error) {
    console.error('Get shares error:', error)
    return c.json({ error: 'Failed to get shares' }, 500)
  }
})

// ì†Œì…œ í”¼ë“œ (íŒ”ë¡œìš°í•œ ì‚¬ìš©ìì˜ í™œë™)
app.get('/api/social-feed', async (c) => {
  try {
    const token = c.req.header('Authorization')?.replace('Bearer ', '')
    if (!token) {
      return c.json({ error: 'Unauthorized' }, 401)
    }

    const decoded = await verifyToken(token, c.env)
    if (!decoded) {
      return c.json({ error: 'Invalid token' }, 401)
    }

    const db = c.env.DB
    const limit = parseInt(c.req.query('limit') || '20')
    const offset = parseInt(c.req.query('offset') || '0')

    // íŒ”ë¡œìš°í•œ ì‚¬ìš©ìë“¤ì˜ í™œë™
    const result = await db.prepare(`
      SELECT 
        af.*,
        u.username,
        u.full_name,
        u.profile_image,
        a.title as artwork_title,
        a.image_url as artwork_image
      FROM activity_feed af
      LEFT JOIN users u ON af.user_id = u.id
      LEFT JOIN artworks a ON af.artwork_id = a.id
      WHERE af.user_id IN (
        SELECT following_user_id FROM user_follows WHERE follower_user_id = ?
      )
      OR af.user_id = ?
      ORDER BY af.created_at DESC
      LIMIT ? OFFSET ?
    `).bind(decoded.userId, decoded.userId, limit, offset).all()

    return c.json({
      success: true,
      activities: result.results || [],
      has_more: (result.results?.length || 0) === limit
    })
  } catch (error) {
    console.error('Get social feed error:', error)
    return c.json({ error: 'Failed to get social feed' }, 500)
  }
})


// íë ˆì´ì…˜ í˜ì´ì§€
app.get('/curation', async (c) => {
  const content = `
  <section id="main-content" class="py-16" tabindex="-1">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <!-- Hero Header -->
          <div class="text-center mb-16">
              <div class="inline-block mb-6 px-6 py-2 bg-gradient-to-r from-purple-600/20 to-cyan-600/20 backdrop-blur-sm rounded-full border border-purple-500/30">
                  <span class="text-gradient font-bold text-sm">ğŸ¤ COLLABORATIVE CURATION</span>
              </div>
              <h1 class="text-6xl md:text-7xl font-black mb-6">
                  <span class="text-white">ê³µë™</span><br/>
                  <span class="text-gradient">íë ˆì´ì…˜</span>
              </h1>
              <p class="text-gray-300 text-xl max-w-3xl mx-auto leading-relaxed mb-8">
                  í•¨ê»˜ ë§Œë“œëŠ” íŠ¹ë³„í•œ ì»¬ë ‰ì…˜. ì—¬ëŸ¬ íë ˆì´í„°ê°€ í˜‘ì—…í•˜ì—¬ ì‘í’ˆì„ ì„ ì •í•˜ê³  íˆ¬í‘œí•©ë‹ˆë‹¤.
              </p>
              
              <button onclick="showCreateSessionModal()" class="px-8 py-4 bg-gradient-to-r from-purple-600 to-cyan-600 text-white rounded-xl font-semibold text-lg hover:shadow-2xl transition-all duration-300 hover:scale-105">
                  <i class="fas fa-plus mr-2"></i>
                  ìƒˆ íë ˆì´ì…˜ ì‹œì‘
              </button>
          </div>
          
          <!-- í™œì„± íë ˆì´ì…˜ ì„¸ì…˜ -->
          <div class="mb-16">
              <div class="flex justify-between items-center mb-8">
                  <h2 class="text-3xl font-bold text-white">í™œì„± ì„¸ì…˜</h2>
                  <div class="flex gap-2">
                      <button onclick="filterSessions('all')" class="px-4 py-2 rounded-xl bg-white/5 hover:bg-white/10 transition text-sm filter-btn active" data-filter="all">
                          ì „ì²´
                      </button>
                      <button onclick="filterSessions('public')" class="px-4 py-2 rounded-xl bg-white/5 hover:bg-white/10 transition text-sm filter-btn" data-filter="public">
                          ê³µê°œ
                      </button>
                      <button onclick="filterSessions('joined')" class="px-4 py-2 rounded-xl bg-white/5 hover:bg-white/10 transition text-sm filter-btn" data-filter="joined">
                          ì°¸ì—¬ì¤‘
                      </button>
                  </div>
              </div>
              
              <!-- ë¡œë”© -->
              <div id="sessionsLoading" class="text-center py-12">
                  <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mx-auto mb-4"></div>
                  <p class="text-gray-400">ì„¸ì…˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
              </div>
              
              <!-- ì„¸ì…˜ ëª©ë¡ -->
              <div id="sessionsList" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
              
              <!-- ë¹ˆ ìƒíƒœ -->
              <div id="sessionsEmpty" class="hidden text-center py-16">
                  <i class="fas fa-users text-6xl text-gray-600 mb-4"></i>
                  <p class="text-gray-400 text-lg">í™œì„± íë ˆì´ì…˜ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤</p>
              </div>
          </div>
          
          <!-- ìµœê·¼ í™œë™ -->
          <div>
              <h2 class="text-3xl font-bold text-white mb-8">ìµœê·¼ í™œë™</h2>
              
              <div id="activityFeed" class="space-y-4">
                  <!-- í™œë™ í”¼ë“œëŠ” JavaScriptë¡œ ë™ì  ë¡œë“œ -->
              </div>
          </div>
      </div>
  </section>
  
  <!-- íë ˆì´ì…˜ ì„¸ì…˜ ìƒì„± ëª¨ë‹¬ -->
  <div id="createSessionModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
      <div class="bg-gray-900 rounded-2xl shadow-2xl max-w-2xl w-full border border-white border-opacity-10 overflow-hidden">
          <div class="p-6 border-b border-white border-opacity-10">
              <div class="flex justify-between items-center">
                  <h2 class="text-2xl font-bold text-white">ìƒˆ íë ˆì´ì…˜ ì„¸ì…˜</h2>
                  <button onclick="closeCreateSessionModal()" class="text-gray-400 hover:text-white transition p-2">
                      <i class="fas fa-times text-xl"></i>
                  </button>
              </div>
          </div>
          
          <form id="createSessionForm" class="p-6 space-y-4">
              <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">ì„¸ì…˜ ì œëª© *</label>
                  <input type="text" name="title" required class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition" placeholder="ì˜ˆ: 2025 ì‹ ì§„ì‘ê°€ ì¶”ì²œì „">
              </div>
              
              <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">ì„¤ëª…</label>
                  <textarea name="description" rows="3" class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition" placeholder="ì´ íë ˆì´ì…˜ ì„¸ì…˜ì— ëŒ€í•´ ì„¤ëª…í•´ì£¼ì„¸ìš”..."></textarea>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">ê³µê°œ ì„¤ì •</label>
                      <select name="visibility" class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white focus:outline-none focus:border-purple-500 transition">
                          <option value="public">ê³µê°œ</option>
                          <option value="private">ë¹„ê³µê°œ</option>
                          <option value="invite_only">ì´ˆëŒ€ ì „ìš©</option>
                      </select>
                  </div>
                  
                  <div>
                      <label class="block text-sm font-medium text-gray-300 mb-2">ìµœëŒ€ ì‘í’ˆ ìˆ˜</label>
                      <input type="number" name="max_artworks" value="20" min="5" max="50" class="w-full px-4 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg text-white focus:outline-none focus:border-purple-500 transition">
                  </div>
              </div>
              
              <div class="flex items-center">
                  <input type="checkbox" name="voting_enabled" id="voting_enabled" checked class="w-4 h-4 mr-2">
                  <label for="voting_enabled" class="text-sm text-gray-300">íˆ¬í‘œ ê¸°ëŠ¥ í™œì„±í™”</label>
              </div>
              
              <div class="flex gap-3 pt-4">
                  <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-cyan-600 text-white rounded-xl font-semibold hover:shadow-lg transition">
                      <i class="fas fa-plus mr-2"></i>
                      ì„¸ì…˜ ìƒì„±
                  </button>
                  <button type="button" onclick="closeCreateSessionModal()" class="px-6 py-3 bg-white bg-opacity-5 border border-white border-opacity-10 text-white rounded-xl font-semibold hover:bg-opacity-10 transition">
                      ì·¨ì†Œ
                  </button>
              </div>
          </form>
      </div>
  </div>
  
  <script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜ ëª©ë¡ ë¡œë“œ
    document.addEventListener('DOMContentLoaded', () => {
      loadCurationSessions();
      loadActivityFeed();
    });
    
    // íë ˆì´ì…˜ ì„¸ì…˜ ëª©ë¡ ë¡œë“œ
    async function loadCurationSessions(filter = 'all') {
      const loading = document.getElementById('sessionsLoading');
      const list = document.getElementById('sessionsList');
      const empty = document.getElementById('sessionsEmpty');
      
      try {
        loading.classList.remove('hidden');
        list.classList.add('hidden');
        empty.classList.add('hidden');
        
        const response = await fetch('/api/curation/sessions?status=active');
        const data = await response.json();
        
        loading.classList.add('hidden');
        
        if (!data.sessions || data.sessions.length === 0) {
          empty.classList.remove('hidden');
          return;
        }
        
        list.classList.remove('hidden');
        list.innerHTML = data.sessions.map(session => \`
          <div class="card-nft rounded-2xl p-6 hover:shadow-2xl transition-all cursor-pointer" onclick="window.location.href='/curation/\${session.id}'">
              <div class="flex justify-between items-start mb-4">
                  <div>
                      <span class="px-3 py-1 rounded-full text-xs font-semibold bg-purple-500/20 text-purple-400 border border-purple-500/30">
                          \${session.visibility === 'public' ? 'ê³µê°œ' : session.visibility === 'private' ? 'ë¹„ê³µê°œ' : 'ì´ˆëŒ€ ì „ìš©'}
                      </span>
                  </div>
                  <div class="text-right">
                      <p class="text-xs text-gray-500">\${new Date(session.created_at).toLocaleDateString('ko-KR')}</p>
                  </div>
              </div>
              
              <h3 class="text-xl font-bold text-white mb-2 line-clamp-2">\${session.title}</h3>
              <p class="text-gray-400 text-sm mb-4 line-clamp-2">\${session.description || 'ì„¤ëª… ì—†ìŒ'}</p>
              
              <div class="flex items-center justify-between text-sm">
                  <div class="flex items-center gap-4">
                      <div class="flex items-center text-gray-400">
                          <i class="fas fa-users mr-1"></i>
                          <span>\${session.participant_count || 0}</span>
                      </div>
                      <div class="flex items-center text-gray-400">
                          <i class="fas fa-image mr-1"></i>
                          <span>\${session.artwork_count || 0}/\${session.max_artworks}</span>
                      </div>
                  </div>
                  <div class="text-purple-400 font-semibold">
                      ìì„¸íˆ ë³´ê¸° â†’
                  </div>
              </div>
          </div>
        \`).join('');
        
      } catch (error) {
        console.error('Load sessions error:', error);
        loading.classList.add('hidden');
        empty.classList.remove('hidden');
      }
    }
    
    // í™œë™ í”¼ë“œ ë¡œë“œ
    async function loadActivityFeed() {
      const feed = document.getElementById('activityFeed');
      
      try {
        const response = await fetch('/api/activity-feed?limit=10');
        const data = await response.json();
        
        if (!data.activities || data.activities.length === 0) {
          feed.innerHTML = '<p class="text-gray-400 text-center py-8">ìµœê·¼ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</p>';
          return;
        }
        
        feed.innerHTML = data.activities.map(activity => {
          const icon = {
            purchase: 'fa-shopping-cart',
            new_artwork: 'fa-palette',
            price_change: 'fa-chart-line',
            bid: 'fa-gavel',
            evaluation: 'fa-star',
            curation_created: 'fa-users',
            curation_joined: 'fa-user-plus',
            artwork_recommended: 'fa-thumbs-up'
          }[activity.activity_type] || 'fa-bell';
          
          return \`
            <div class="flex items-start gap-4 p-4 bg-white/5 rounded-xl hover:bg-white/10 transition">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-purple-600 to-cyan-500 flex items-center justify-center">
                    <i class="fas \${icon} text-white text-sm"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-white font-semibold">\${activity.full_name || activity.username}</p>
                    <p class="text-gray-400 text-sm">
                        \${getActivityMessage(activity)}
                    </p>
                    <p class="text-gray-500 text-xs mt-1">\${new Date(activity.created_at).toLocaleString('ko-KR')}</p>
                </div>
            </div>
          \`;
        }).join('');
        
      } catch (error) {
        console.error('Load activity feed error:', error);
        feed.innerHTML = '<p class="text-red-400 text-center py-8">í™œë™ í”¼ë“œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>';
      }
    }
    
    function getActivityMessage(activity) {
      const metadata = activity.metadata ? JSON.parse(activity.metadata) : {};
      
      switch (activity.activity_type) {
        case 'curation_created':
          return \`íë ˆì´ì…˜ ì„¸ì…˜ "\${metadata.title || ''}"ì„(ë¥¼) ìƒì„±í–ˆìŠµë‹ˆë‹¤\`;
        case 'curation_joined':
          return 'íë ˆì´ì…˜ ì„¸ì…˜ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤';
        case 'artwork_recommended':
          return \`ì‘í’ˆ "\${activity.artwork_title || ''}"ì„(ë¥¼) ì¶”ì²œí–ˆìŠµë‹ˆë‹¤\`;
        case 'purchase':
          return \`ì‘í’ˆ "\${activity.artwork_title || ''}"ì„(ë¥¼) êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤\`;
        case 'new_artwork':
          return \`ìƒˆ ì‘í’ˆ "\${activity.artwork_title || ''}"ì„(ë¥¼) ë“±ë¡í–ˆìŠµë‹ˆë‹¤\`;
        default:
          return 'í™œë™ ë‚´ì—­';
      }
    }
    
    // í•„í„° ë²„íŠ¼
    function filterSessions(filter) {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-purple-500/20', 'text-purple-400', 'border', 'border-purple-500/30');
      });
      
      const activeBtn = document.querySelector(\`[data-filter="\${filter}"]\`);
      if (activeBtn) {
        activeBtn.classList.add('active', 'bg-purple-500/20', 'text-purple-400', 'border', 'border-purple-500/30');
      }
      
      loadCurationSessions(filter);
    }
    
    // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
    function showCreateSessionModal() {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
        window.location.href = '/login';
        return;
      }
      
      document.getElementById('createSessionModal').classList.remove('hidden');
    }
    
    function closeCreateSessionModal() {
      document.getElementById('createSessionModal').classList.add('hidden');
      document.getElementById('createSessionForm').reset();
    }
    
    // ì„¸ì…˜ ìƒì„± í¼ ì œì¶œ
    document.getElementById('createSessionForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const token = localStorage.getItem('auth_token');
      if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
        window.location.href = '/login';
        return;
      }
      
      const formData = new FormData(e.target);
      const data = {
        title: formData.get('title'),
        description: formData.get('description'),
        visibility: formData.get('visibility'),
        max_artworks: parseInt(formData.get('max_artworks')),
        voting_enabled: formData.get('voting_enabled') === 'on'
      };
      
      try {
        showLoadingOverlay('ì„¸ì…˜ ìƒì„± ì¤‘...');
        
        const response = await fetch('/api/curation/sessions', {
          method: 'POST',
          headers: {
            'Authorization': \`Bearer \${token}\`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        hideLoadingOverlay();
        
        if (result.success) {
          showSuccessToast('íë ˆì´ì…˜ ì„¸ì…˜ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤');
          closeCreateSessionModal();
          window.location.href = \`/curation/\${result.session_id}\`;
        } else {
          showErrorToast(result.error || 'ì„¸ì…˜ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
      } catch (error) {
        hideLoadingOverlay();
        console.error('Create session error:', error);
        showErrorToast('ì„¸ì…˜ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    });
  </script>
  `

  return c.html(getLayout(content, 'ê³µë™ íë ˆì´ì…˜ - GALLERYPIA'))
})

export default app
