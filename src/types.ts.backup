// Cloudflare D1 Database Binding
export type Bindings = {
  DB: D1Database;
}

// 작가 타입
export interface Artist {
  id: number;
  name: string;
  email?: string;
  bio?: string;
  career_years: number;
  education?: string;
  exhibitions_count: number;
  awards_count: number;
  solo_exhibitions_count: number;
  group_exhibitions_count: number;
  competition_awards_count: number;
  achievement_score: number;
  latest_exhibition_year: number;
  latest_award_year: number;
  profile_image?: string;
  wallet_address?: string;
  created_at: string;
  updated_at: string;
}

// 작품 타입
export interface Artwork {
  id: number;
  artist_id: number;
  title: string;
  description?: string;
  category: string;
  technique?: string;
  size_width?: number;
  size_height?: number;
  size_depth?: number;
  creation_year?: number;
  image_url: string;
  thumbnail_url?: string;
  
  // 가치산정 정량적 요소
  base_material_cost: number; // 사용하지 않음 (논문 기준)
  labor_hours: number; // 사용하지 않음 (논문 기준)
  artist_achievement_score: number; // 작가 업적 점수
  market_demand_score: number;
  rarity_score: number;
  
  // 가치산정 정성적 요소
  artistic_quality_score: number;
  originality_score: number;
  cultural_significance_score: number;
  technical_excellence_score: number;
  
  // 최종 가치 산정
  estimated_value: number;
  min_price: number;
  current_price: number;
  
  // NFT 관련
  is_minted: boolean;
  nft_token_id?: string;
  nft_contract_address?: string;
  blockchain_network?: string;
  ipfs_hash?: string;
  
  status: 'draft' | 'pending_review' | 'approved' | 'minted' | 'sold';
  views_count: number;
  likes_count: number;
  
  created_at: string;
  updated_at: string;
}

// 작품 with 작가 정보
export interface ArtworkWithArtist extends Artwork {
  artist_name: string;
  artist_profile_image?: string;
}

// 평가 이력
export interface ValuationHistory {
  id: number;
  artwork_id: number;
  evaluator_name?: string;
  evaluator_role?: string;
  artistic_quality?: number;
  originality?: number;
  cultural_significance?: number;
  technical_excellence?: number;
  market_potential?: number;
  estimated_value?: number;
  evaluation_notes?: string;
  evaluated_at: string;
}

// 거래 이력
export interface Transaction {
  id: number;
  artwork_id: number;
  transaction_type: 'mint' | 'sale' | 'transfer' | 'bid';
  from_address?: string;
  to_address?: string;
  price?: number;
  currency: string;
  transaction_hash?: string;
  blockchain_network?: string;
  gas_fee?: number;
  status: 'pending' | 'completed' | 'failed';
  created_at: string;
}

// 컬렉션
export interface Collection {
  id: number;
  name: string;
  description?: string;
  curator_name?: string;
  cover_image?: string;
  artwork_count: number;
  created_at: string;
  updated_at: string;
}

// API 응답 타입
export interface ApiResponse<T = any> {
  success: boolean;
  data?: T;
  error?: string;
  message?: string;
}

// 작가 업적 점수 계산 함수
export function calculateArtistAchievement(artist: Partial<Artist>): number {
  const currentYear = new Date().getFullYear();
  
  // 전시 점수 계산 (개인전: 10점, 단체전: 5점)
  const soloExhibitionScore = (artist.solo_exhibitions_count || 0) * 10;
  const groupExhibitionScore = (artist.group_exhibitions_count || 0) * 5;
  
  // 권위도 가중치 (단순화: 모두 1.0으로 가정)
  const authorityWeight = 1.0;
  
  // 최신성 계수 (최근 5년 이내: 1.0, 그 이후: 0.8씩 감소)
  const latestYear = artist.latest_exhibition_year || currentYear;
  const yearsDiff = currentYear - latestYear;
  const recencyCoefficient = yearsDiff <= 5 ? 1.0 : Math.max(0.2, 1.0 - (yearsDiff - 5) * 0.1);
  
  // 수상 경력 가산점 (수상 1개당 15점)
  const awardScore = (artist.competition_awards_count || 0) * 15;
  
  // 작가 업적 점수 = Σ(전시점수 × 권위도가중치 × 최신성계수) + 수상점수
  const exhibitionScore = (soloExhibitionScore + groupExhibitionScore) * authorityWeight * recencyCoefficient;
  const totalScore = exhibitionScore + awardScore;
  
  // 0-100 범위로 정규화
  return Math.min(100, Math.round(totalScore));
}

// 가치산정 계산 함수 (논문 기준)
export function calculateArtworkValue(artwork: Partial<Artwork>, basePrice: number = 10000000): number {
  // 정량적 평가 (30%)
  // - 작가 업적 (40%)
  // - 시장 수요 (30%)
  // - 희소성 (30%)
  const quantitativeWeight = 0.3;
  const quantitativeScore = (
    (artwork.artist_achievement_score || 0) * 0.4 +
    (artwork.market_demand_score || 0) * 0.3 +
    (artwork.rarity_score || 0) * 0.3
  );
  
  // 정성적 평가 (70%)
  const qualitativeWeight = 0.7;
  const qualitativeScore = (
    (artwork.artistic_quality_score || 0) * 0.35 +
    (artwork.originality_score || 0) * 0.3 +
    (artwork.cultural_significance_score || 0) * 0.2 +
    (artwork.technical_excellence_score || 0) * 0.15
  );
  
  // 종합 점수 (0-100)
  const totalScore = quantitativeScore * quantitativeWeight + qualitativeScore * qualitativeWeight;
  
  // 최종 가치 = 기본 가격 × (1 + 종합점수/10)
  // 기본 가격은 작품의 기준가 (예: 1천만원)
  const scoreMultiplier = totalScore / 10;
  const estimatedValue = basePrice * (1 + scoreMultiplier);
  
  return Math.round(estimatedValue);
}

// ETH 환율 계산 (1 ETH = 약 4,500,000원 기준)
export function krwToEth(krw: number, ethPriceInKrw: number = 4500000): number {
  return krw / ethPriceInKrw;
}

// ETH를 원화로 변환
export function ethToKrw(eth: number, ethPriceInKrw: number = 4500000): number {
  return eth * ethPriceInKrw;
}
